<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Casting Call for MERS-CoV in Korea, 2015</title>
  <meta name="description" content="Abstract">

  <link rel="stylesheet" href="/blog/css/main.css">
  <link rel="canonical" href="http://mhoehle.github.io/blog/2016/07/19/nowCast.html">
  <link rel="alternate" type="application/rss+xml" title="Theory meets practice..." href="http://mhoehle.github.io/blog/feed.xml">
</head>

<!-- https://docs.mathjax.org/en/v2.7-latest/start.html -->
<script type="text/javascript" async
  src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML">
</script>




  <body>

    <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="/blog/">Theory meets practice...</a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>

      <div class="trigger">
        
          
          <a class="page-link" href="/blog/about/">About</a>
          
        
          
        
          
        
          
        
      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">Casting Call for MERS-CoV in Korea, 2015</h1>
    <p class="post-meta"><time datetime="2016-07-19T00:00:00+02:00" itemprop="datePublished">Jul 19, 2016</time></p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <h2 id="abstract">Abstract</h2>
<p>We perform an adjustment for observed-but-not-yet-reported cases
(aka. nowcasting) for the epidemic curve of the Middle East respiratory
syndrome coronavirus (MERS-CoV) outbreak in Korea, 2015. The analysis is
based on the publically available WHO data and aims at illustrating how
one could do real-time public health surveillance during critical
outbreaks.</p>
<p><br>
<a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-sa/4.0/88x31.png"/></a>
This work is licensed under a <a rel="license"
href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons
Attribution-ShareAlike 4.0 International License</a>. The
markdown+Rknitr source code of this blog is available under a <a
href="https://www.gnu.org/licenses/gpl-3.0.html">GNU General Public
License (GPL v3)</a> license from github.</p>
<h1 id="introduction">Introduction</h1>
<p>Short-range (0-6h) forecasts in the world of meteorology are also
called <strong>nowcasts</strong>. The term has also found its way into
real-time infectious disease monitoring where one of its uses has been
to adjust the currently available epidemic curve during an outbreak for
structural and reporting delays.</p>
<p>Whereas the original work in <span class="citation"
data-cites="hoehle_anderheiden2014">Höhle and an der Heiden
(2014)</span> was motivated by the large STEC O104:H4 outbreak in
Germany 2011, one of our secondary motivations was to develop a tool the
quantitative epidemiologist could use during similar high-profiled
outbreaks (instead of having to re-invent the wheel during times of
maximal stress). After my talk at the <a
href="https://biometricconference.org/showcases/biometrics-showcase/">IBC2016
conference</a> (<a
href="http://staff.math.su.se/hoehle/talks/IBC2016-Hoehle.pdf">slides of
the talk</a> - our received the <em>Best Paper in Biometrics by an IBS
Member in 2014</em> award), one of the questions from the audience was
how much impact the work had in terms of being useful for other
outbreaks. Besides an analysis of an Adenovirus outbreak and a recent
analysis of an O157 outbreak, I was a little short on a convincing
answer. In addition, when trying to make a quick analysis for the O157
outbreak with the currently available code in the
<code>surveillance</code> package it became obvious that the nowcasting
functionality in the package currently is a little rough and certainly
in need of a user-friendliness polishing.</p>
<p>So this little blog-note serves three purposes:</p>
<ol type="1">
<li>Illustrate how you can nowcasts with R, if you ever have to.</li>
<li>Act as literate programming document for facilitating some code
improvements of the <code>nowcast</code> function while providing a
vignette supported story.</li>
<li>Perform an analysis of the WHO open-data on the MERS-CoV outbreak in
Korea in 2015.</li>
</ol>
<p>The structure of this blog entry is as follows. We first discuss and
visualize the WHO data on the MERS-CoV outbreak. The findings from the
descriptive data analysis are then used to set up nowcasts adjusting the
observed epidemic curve during the outbreak for reporting delays between
onset of symptoms in cases and the date the case report arrived at the
WHO. Finally, we illustrate how to visualize a sequence of nowcasts
during an outbreak using an animation.</p>
<p><strong>Update 2020-04-21</strong>: Regarding the lack of convincing
use-case mentioned above. Four years after writing this blog post I can
now add: The nowcast functionality of the package is now in use by the
public health authorities in several German federal states as part of
their Covid-19 outbreak response, see for example <a
href="https://corona.stat.uni-muenchen.de/nowcast/">Bavaria</a>.</p>
<h1 id="data">Data</h1>
<p>The data basis for our analysis is the WHO data on the <a
href="http://www.who.int/csr/don/21-july-2015-mers-korea/en/">MERS-Cov
outbreak in Korea</a>, which occured during May-July 2015. Of interest
will be the delay (here measured in days) between the time point on
which a case has the onset of its MERS symptoms and the day the WHO
learns about this case. In other words we put ourself in the role of an
epidemiologist working at the WHO and who during the outbreak has to
report on how the outbreak is evolving in Korea.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="do">##Load library to read excel files</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">&quot;openxlsx&quot;</span>)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="do">##Obtain file from link found at (if it doesn&#39;t already exist)</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="do">##http://www.who.int/csr/don/21-july-2015-mers-korea/en/</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">file.exists</span>(<span class="st">&quot;../downloads/MERS-CoV-cases-rok-21Jul15.xlsx&quot;</span>)) {</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">download.file</span>(<span class="at">url=</span><span class="st">&quot;http://www.who.int/entity/csr/disease/coronavirus_infections/MERS-CoV-cases-rok-21Jul15.xlsx?ua=1&quot;</span>,<span class="at">destfile=</span><span class="st">&quot;../downloads/MERS-CoV-cases-rok-21Jul15.xlsx&quot;</span>)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="do">##Read data</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>linelist <span class="ot">&lt;-</span> <span class="fu">read.xlsx</span>(<span class="st">&quot;../downloads/MERS-CoV-cases-rok-21Jul15.xlsx&quot;</span>,<span class="at">startRow=</span><span class="dv">4</span>,<span class="at">detectDates=</span><span class="cn">TRUE</span>)</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="do">##Base R style - IMHO easier to understand than the dplyr way to do the same</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (dateCol <span class="cf">in</span> <span class="fu">c</span>(<span class="st">&quot;Date.of.notification.to.WHO&quot;</span>,<span class="st">&quot;Date.of.symptoms.onset&quot;</span>,<span class="st">&quot;Date.of.first.hospitalization&quot;</span>,<span class="st">&quot;Date.of.laboratory.confirmation&quot;</span>,<span class="st">&quot;Date.of.outcome&quot;</span>)) {</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>  linelist[,dateCol] <span class="ot">&lt;-</span> <span class="fu">as.Date</span>(linelist[,dateCol],<span class="at">format=</span><span class="st">&quot;%d/%m/%Y&quot;</span>)</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="do">##Make a delay column</span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>linelist<span class="sc">$</span>delay <span class="ot">&lt;-</span> <span class="fu">with</span>(linelist,Date.of.notification.to.WHO <span class="sc">-</span> Date.of.symptoms.onset)</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(linelist,<span class="at">n=</span><span class="dv">3</span>)</span></code></pre></div>
<pre><code>##   Case.no. Date.of.notification.to.WHO Age Sex Health.care.worker Comorbidities
## 1        1                  2015-05-20  68   M                 No          &lt;NA&gt;
## 2        2                  2015-05-22  63   F                 No          &lt;NA&gt;
## 3        3                  2015-05-22  76   M                 No          &lt;NA&gt;
##   Date.of.symptoms.onset Date.of.first.hospitalization Date.of.laboratory.confirmation
## 1             2015-05-11                    2015-05-15                      2015-05-20
## 2             2015-05-19                          &lt;NA&gt;                      2015-05-20
## 3             2015-05-20                          &lt;NA&gt;                      2015-05-20
##     Status Date.of.outcome  delay
## 1    Alive            &lt;NA&gt; 9 days
## 2    Alive            &lt;NA&gt; 3 days
## 3 Deceased      2015-06-04 2 days</code></pre>
<p>As the outbreak is already over, it is easy to visualize the epidemic
curve in retrospect. We do so for the date of symptom onset.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="do">##Show the epidemic curve as it occurs at the end of the outbreak</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="do">##using simple call to ggplot</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggplot</span>( linelist, <span class="fu">aes</span>(<span class="at">x=</span>Date.of.symptoms.onset)) <span class="sc">+</span> <span class="fu">geom_histogram</span>() <span class="sc">+</span> <span class="fu">xlab</span>(<span class="st">&quot;Date of onset of symptoms&quot;</span>) <span class="sc">+</span> <span class="fu">ylab</span>(<span class="st">&quot;Number of cases&quot;</span>)</span></code></pre></div>
<p><img
src="/blog/figure/source/2016-07-19-nowCast/EPICURVE-1.png" /></p>
<p>Furthermore, we can look at the delay distribution as it looks at the
end of the outbreak. We shall later look in more detail at this
distribution, but for now the plot gives an idea about the range of the
delay: in most cases the delay is between 1-14 days, actually 97.1% of
the observations have a lag smaller or equal to <span
class="math inline">\(D=14\)</span>. As a consequence, we shall use
<span class="math inline">\(D=14\)</span> as the maximum relevant lag to
adjust for.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>( linelist, <span class="fu">aes</span>(<span class="at">x=</span><span class="fu">as.integer</span>(delay),<span class="at">y=</span>..prop..)) <span class="sc">+</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a> <span class="fu">stat_count</span>() <span class="sc">+</span> <span class="fu">scale_y_continuous</span>(<span class="at">labels =</span> scales<span class="sc">::</span>percent) <span class="sc">+</span> <span class="fu">xlab</span>(<span class="st">&quot;Delay (days)&quot;</span>) <span class="sc">+</span> <span class="fu">ylab</span>(<span class="st">&quot;&quot;</span>)</span></code></pre></div>
<p><img
src="/blog/figure/source/2016-07-19-nowCast/unnamed-chunk-3-1.png" /></p>
<p>Instead of using <code>ggplot</code> to show the epidemic curve, this
can also be done directly from the surveillance package using the
function <code>linelist2sts</code>. This function takes a
<code>data.frame</code> representing a linelist and converts this into
an object of class <code>sts</code> (surveillance time series) used by
the package. This then allows the use of all the plotting functionality
of such objects as described in <span class="citation"
data-cites="salmon_etal2016a">Salmon, Schumacher, and Höhle
(2016)</span>. Note: For the nowcasting code of this blog entry to work,
the newest development version of the package, i.e. version 1.12.2
available from Rforge using</p>
<p>
<center>
<code>install.packages("surveillance",repos="http://r-forge.r-project.org")</code>
</center>
<p>
<p>is needed. The code then looks as follows:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="do">##Load surveillance pkg.</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">&quot;surveillance&quot;</span>)</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="do">##Range of the symptom onset date variable</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>so_range <span class="ot">&lt;-</span> <span class="fu">range</span>(linelist<span class="sc">$</span>Date.of.symptoms.onset, <span class="at">na.rm=</span><span class="cn">TRUE</span>)</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="do">##Create an sts time series from the linelist, which contains daily counts.</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>sts <span class="ot">&lt;-</span> <span class="fu">linelist2sts</span>(linelist, <span class="at">dateCol=</span><span class="st">&quot;Date.of.symptoms.onset&quot;</span>, <span class="at">aggregate.by=</span><span class="st">&quot;1 day&quot;</span>, <span class="at">dRange=</span>so_range)</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a><span class="do">##Show the resulting time series using the plot functionality for sts objects.</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(sts,<span class="at">legend.opts=</span><span class="cn">NULL</span>,</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>     <span class="at">xaxis.tickFreq=</span><span class="fu">list</span>(<span class="st">&quot;%d&quot;</span><span class="ot">=</span>atChange,<span class="st">&quot;%m&quot;</span><span class="ot">=</span>atChange),</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>     <span class="at">xaxis.labelFreq=</span><span class="fu">list</span>(<span class="st">&quot;%d&quot;</span><span class="ot">=</span>at2ndChange),<span class="at">xaxis.labelFormat=</span><span class="st">&quot;%d-%b&quot;</span>,</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlab=</span><span class="st">&quot;Time (days)&quot;</span>,<span class="at">lty=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>),<span class="at">lwd=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">2</span>),</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>     <span class="at">ylab=</span><span class="st">&quot;No. symptom onsets&quot;</span>)</span></code></pre></div>
<p><img
src="/blog/figure/source/2016-07-19-nowCast/EPICURVE-SURVEILLANCE-1.png" /></p>
<h2 id="nowcasting">Nowcasting</h2>
<p>We now move on to the nowcasts.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="do">##State which date to nowcast</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>now <span class="ot">&lt;-</span> <span class="fu">as.Date</span>(<span class="st">&quot;2015-06-12&quot;</span>)</span></code></pre></div>
<p>Say (in a mathematical sense) we move back time to 2015-06-12. In the
notation of <span class="citation"
data-cites="hoehle_anderheiden2014">Höhle and an der Heiden
(2014)</span> this means <span
class="math inline">\(T=2015-06-12\)</span>. We want to illustrate what
the WHO could see at this point and, on the basis on the available
reports at time <span class="math inline">\(T\)</span>, estimate the
delay distribution and adjust the observed cases accordingly. We shall
here only use the right-truncation delay adjusted procedure operating on
the generalized Dirichlet distribution. Since the nowcasts for the time
points very close to now are very volatile (i.e. have very large
credibility regions), it’s opportune to not display these casts as they
can be very hard to communicate. Also note that the selected date for
<code>now</code> is selected such that enough cases are available to
give a sufficiently reliable estimate for the delay distribution.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="do">##Nowcasts are displayed up to time (now - safePredictLag)</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>safePredictLag <span class="ot">&lt;-</span> <span class="dv">3</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>nowcastDates <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="at">from =</span> so_range[<span class="dv">1</span>], <span class="at">to =</span> now <span class="sc">-</span> safePredictLag, <span class="at">by =</span> <span class="dv">1</span>)</span></code></pre></div>
<p>We now perform right-truncation adjusted Bayesian nowcasting using
the generalized Dirichlet distribution. An important choice is here the
prior for the expected number of cases per day, i.e. <span
class="math inline">\(\lambda_t\)</span> in the notation of <span
class="citation" data-cites="hoehle_anderheiden2014">Höhle and an der
Heiden (2014)</span>. In the conjugate case this is specified by
assuming an iid. Gamma-distribution for <span
class="math inline">\(\lambda_t\)</span>, which is specified through
prior mean and prior variance of the Gamma distribution. We here select
here an empirical Bayes inspired approach and estimate these parameters
from the currently available data. However, note: These data are by
definition of the problem incomplete. As a dirty fix we therefore just
inflate the prior variance by a factor - as future work this needs to be
improved upon by following a proper marginal likelihood approach.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>nc.control <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">N.tInf.prior =</span> <span class="fu">structure</span>(<span class="st">&quot;poisgamma&quot;</span>,</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>                           <span class="at">mean.lambda =</span> <span class="fu">mean</span>(<span class="fu">observed</span>(sts)),</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>                           <span class="at">var.lambda =</span> <span class="dv">5</span><span class="sc">*</span><span class="fu">var</span>(<span class="fu">observed</span>(sts))</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>                           ),</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>  <span class="do">##compute predictive distribution as wel, which is needed for some of the</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>  <span class="do">##animations.</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">predPMF =</span> <span class="cn">TRUE</span>,</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">dRange =</span> so_range)</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a><span class="do">## Now run the nowcast (NA dates are removed from the dataset).</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>nc <span class="ot">&lt;-</span> <span class="fu">nowcast</span>(<span class="at">now =</span> now, <span class="at">when =</span> nowcastDates, <span class="at">data =</span> linelist,</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>              <span class="at">dEventCol =</span> <span class="st">&quot;Date.of.symptoms.onset&quot;</span>,</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>              <span class="at">dReportCol =</span> <span class="st">&quot;Date.of.notification.to.WHO&quot;</span>,</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>              <span class="at">method =</span> <span class="st">&quot;bayes.trunc&quot;</span>, <span class="co">#use the conjugate generalized dirichlet</span></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>              <span class="at">aggregate.by =</span> <span class="st">&quot;1 day&quot;</span>,</span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>              <span class="at">D =</span> <span class="dv">14</span>, <span class="co">#adjust cases up to 2 weeks back.</span></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>              <span class="at">control =</span> nc.control)</span></code></pre></div>
<pre><code>## Removed 13 records due to NA dates.</code></pre>
<p>The resulting object is of class <code>stsNC</code>, which is just a
class inheriting from the <code>sts</code> class. Hence, all the usual
plotting functions apply to it. In addition, a plot of an
<code>stsNC</code> object as shown below, contains the median of the
pointwise predictive distribution (thick blue line) as well as
equi-tailed 95% credibility regions (dashed orange lines).</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(nc, <span class="at">legend.opts=</span><span class="cn">NULL</span>,</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>     <span class="at">xaxis.tickFreq=</span><span class="fu">list</span>(<span class="st">&quot;%d&quot;</span><span class="ot">=</span>atChange,<span class="st">&quot;%m&quot;</span><span class="ot">=</span>atChange),</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>     <span class="at">xaxis.labelFreq=</span><span class="fu">list</span>(<span class="st">&quot;%d&quot;</span><span class="ot">=</span>at2ndChange),<span class="at">xaxis.labelFormat=</span><span class="st">&quot;%d-%b&quot;</span>,</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlab=</span><span class="st">&quot;Time (days)&quot;</span>,<span class="at">lty=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>),<span class="at">lwd=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">2</span>),</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>     <span class="at">ylab=</span><span class="st">&quot;No. symptom onsets&quot;</span>,<span class="at">ylim=</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="fu">max</span>(<span class="fu">observed</span>(nc),<span class="fu">upperbound</span>(nc),<span class="fu">predint</span>(nc),<span class="at">na.rm=</span><span class="cn">TRUE</span>)))</span></code></pre></div>
<p><img
src="/blog/figure/source/2016-07-19-nowCast/NOWCASTPLOT-1.png" /></p>
<p>Finally, we can for <code>stsNC</code> objects show a simple
non-parametric estimate of the delay distribution as a function of time
using a window-smoothed approach with window width <span
class="math inline">\(2w+1\)</span>, see <span class="citation"
data-cites="hoehle_anderheiden2014">Höhle and an der Heiden
(2014)</span> for details.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(nc, <span class="at">type=</span><span class="st">&quot;delay&quot;</span>, <span class="at">dates=</span><span class="fu">seq</span>(so_range[<span class="dv">1</span>],now,<span class="at">by=</span><span class="st">&quot;1 day&quot;</span>),<span class="at">w=</span><span class="dv">1</span>)</span></code></pre></div>
<p><img
src="/blog/figure/source/2016-07-19-nowCast/NOWCASTDELAY-1.png" /></p>
<p>The figure shows for each time point <span
class="math inline">\(t\)</span> the median as well as the 10% and 90%
quantile of the empirical distribution of delays within the window of
<span class="math inline">\(t-w,\ldots,t+w\)</span>. Note: This simple
estimate ignores the right- truncation, hence, within the period of
<code>(now-D):now</code> there will be a bias of these estimates towards
shorter delays. This biased period is illustrated in the figure by the
light-gray shaded area. Furthermore, the median of the model based
estimate for the delay distribution is shown for the period of
<code>(now-m:now)</code>. From the figure one has the suspicion that the
delay decreased a bit over time, but the decrease totally at the end
could also be due to right-truncation. However, assuming a
<strong>time-invariant delay distribution</strong> for the entire
outbreak would probably give unsatisfactory results. Hence, we shall for
each time point use only a moving window consisting of all observations
occuring within the period <code>(now-m):now</code>. We select <span
class="math inline">\(m=14\)</span> for estimating the delay
distribution.</p>
<p>This means that only the <span class="math inline">\(m+1\)</span>=15
most recent days of the reporting triangle are considered at each
instance of “now” when estimating the delay distribution, i.e. there
will be 15 observations on number of reports with a delay of 0 days,
there will be 14 observationson on number of reports with a delay of 1
day, …, there will be 1 observation on number of reports with a delay 14
days. Based on the right-truncation adjusted estimation procedure these
observations then lead to an estimate of the PMF of the delay. Due to
the sliding window this estimate will be more uncertain (especially for
the long delays), but if the delay reduces over time, this is more
appropriately reflected, because old cases do not contribute to the
delay estimation anymore.</p>
<h2 id="showing-a-sequence-of-nowcasts">Showing a sequence of
nowcasts</h2>
<p>Once a couple of nowcasts have been performed it can also be helpful
to visualize the sequence of nowcasts using an animation. This is easily
done by first generating a list of nowcast results followed by a call to
<code>surveillance::animate_nowcasts</code>.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="do">##Nowcast all time points (except for the first three weeks). This might take a while.</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>nowcasts <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>animRange <span class="ot">&lt;-</span> <span class="fu">seq</span>(so_range[<span class="dv">1</span>]<span class="sc">+</span><span class="dv">21</span>,so_range[<span class="dv">2</span>],<span class="at">by=</span><span class="st">&quot;1 day&quot;</span>)</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="do">##Do nowcasts for the rage of dates</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_len</span>(<span class="fu">length</span>(animRange))) {</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>  today <span class="ot">&lt;-</span> animRange[i]</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="fu">as.character</span>(today))</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>  new_nowcastDates <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="at">from =</span> so_range[<span class="dv">1</span>], <span class="at">to =</span> today <span class="sc">-</span> safePredictLag, <span class="at">by =</span> <span class="dv">1</span>)</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>  nowcasts[[<span class="fu">as.character</span>(today)]] <span class="ot">&lt;-</span> <span class="fu">nowcast</span>(</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">now =</span> today, <span class="at">when =</span> new_nowcastDates, <span class="at">data =</span> linelist,</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">dEventCol =</span> <span class="st">&quot;Date.of.symptoms.onset&quot;</span>,</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">dReportCol =</span> <span class="st">&quot;Date.of.notification.to.WHO&quot;</span>,</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">method =</span> <span class="st">&quot;bayes.trunc&quot;</span>,</span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">aggregate.by =</span> <span class="st">&quot;1 day&quot;</span>,</span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">D =</span> <span class="dv">14</span>,</span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">m =</span> <span class="dv">14</span>, <span class="do">##moving window of 14+1 days for estimation</span></span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">control =</span> nc.control)</span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>We will use the <code>animation</code> package to wrap the call to
<code>animate_nowcasts</code> in order to generate an animated GIF.
Better control over the obtained animation can be obtained using the
<code>animation::saveHTML</code> function. If one wants to include the
animation into a Power-Point presentation, I recommend the use of Flash
animations (<code>animation::saveSWF</code>). Note that the animation
package requires <a
href="http://www.imagemagick.org/script/index.php">ImageMagick</a> to be
installed on your system.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>animation<span class="sc">::</span><span class="fu">saveGIF</span>( {</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">par</span>(<span class="at">mar=</span><span class="fu">c</span>(<span class="fl">5.5</span>, <span class="dv">4</span>, <span class="dv">2</span>, <span class="dv">2</span>) <span class="sc">+</span> <span class="fl">0.1</span>) ; <span class="do">##add extra space at the bottom and remove at top</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">animate_nowcasts</span>(<span class="at">nowcasts =</span> nowcasts,</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>                   <span class="at">linelist_truth =</span> linelist,</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>                   <span class="at">method =</span> <span class="st">&quot;bayes.trunc&quot;</span>, <span class="co">#nowcast method to use (has to be in the casts)</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>                   <span class="at">control =</span> <span class="fu">list</span>(<span class="at">sys.sleep=</span><span class="dv">0</span>,<span class="at">dRange=</span>nc.control<span class="sc">$</span>dRange,<span class="at">anim.dRange=</span><span class="fu">range</span>(animRange),<span class="at">ylim=</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">40</span>))) },</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">movie.name=</span><span class="st">&quot;animate-nowcasts.gif&quot;</span>, <span class="at">ani.width=</span><span class="dv">800</span>, <span class="at">ani.height=</span><span class="dv">500</span>)</span></code></pre></div>
<p><img
src="/blog/figure/source/2016-07-19-nowCast/animate-nowcasts.gif" /></p>
<p>As a final comparison we can also obtain an animation of how the
delay distribution changes with time. From the animation we notice that
the delay appears to steadily decrease, which is a typical behavior for
high-profiled outbreaks. However, this also questions the assumption of
a <strong>time-invariant delay distribution</strong>. Instead, one could
use a window-limited estimation approach or one could try to model the
delay distribution using a discrete time survival model as done in <span
class="citation" data-cites="hoehle_anderheiden2014">Höhle and an der
Heiden (2014)</span>. The animation below uses the above mentioned
sliding-window approach, which is noticed by the estimate of <span
class="math inline">\(q_{0.5}^{\text{bayes.trunc(T)}}\)</span> changing
for each <span class="math inline">\(T\)</span>.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>animation<span class="sc">::</span><span class="fu">saveGIF</span>(</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_len</span>(<span class="fu">length</span>(nowcasts))) {</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot</span>(nowcasts[[i]], <span class="at">w=</span><span class="dv">3</span>, <span class="at">type=</span><span class="st">&quot;delay&quot;</span>)</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>  },</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">movie.name=</span><span class="st">&quot;animate-delays.gif&quot;</span>, <span class="at">ani.width=</span><span class="dv">800</span>, <span class="at">ani.height=</span><span class="dv">500</span>)</span></code></pre></div>
<p><img
src="/blog/figure/source/2016-07-19-nowCast/animate-delays.gif" /></p>
<h1 id="discussion">Discussion</h1>
<p>The adjustment of occurred-but-not-yet-reported-events applies to
many other application areas besides <strong>real-time public health
monitoring</strong>. For example, direct links to claims reserve
modelling in actuarial sciences exist, but many other areas of
application, where delays play a role, appear of interest. For the
methodological details of the nowcasting procedures see <span
class="citation" data-cites="hoehle_anderheiden2014">Höhle and an der
Heiden (2014)</span>, which is available as open access document. The
present blog entry focused on getting methods operational using R - the
R code of this blog post is available from <a
href="https://raw.githubusercontent.com/hoehleatsu/hoehleatsu.github.io/master/_source/2016-07-19-nowCast.Rmd">github</a>.</p>
<h1 id="acknowledgements">Acknowledgements</h1>
<p>Work on the surveillance package was supported by the Swedish
Research Council (2015_05182_VR).</p>
<h1 class="unnumbered" id="references">References</h1>
<div id="refs" class="references csl-bib-body hanging-indent"
role="list">
<div id="ref-hoehle_anderheiden2014" class="csl-entry" role="listitem">
Höhle, M., and M. an der Heiden. 2014. <span>“Bayesian Nowcasting During
the <span>STEC O104:H4</span> Outbreak in <span>Germany</span>,
2011.”</span> <em>Biometrics</em> 70 (4): 993–1002. <a
href="https://doi.org/10.1111/biom.12194">https://doi.org/10.1111/biom.12194</a>.
</div>
<div id="ref-salmon_etal2016a" class="csl-entry" role="listitem">
Salmon, M., D. Schumacher, and M. Höhle. 2016. <span>“Monitoring Count
Time Series in <span>R</span>: Aberration Detection in Public Health
Surveillance.”</span> <em>Journal of Statistical Software</em> 70 (10).
<a
href="https://doi.org/10.18637/jss.v070.i10">https://doi.org/10.18637/jss.v070.i10</a>.
</div>
</div>

  </div>

</article>

	

<!-- Add Disqus comments. -->
<div id="disqus_thread"></div>
<script>
    /**
     *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
     *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
     **/
    /**
    var disqus_config = function () {
        this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
        this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };
    **/
    var disqus_config = function () {
      this.page.url = "http://mhoehle.github.io/blog/2016/07/19/nowCast.html";
      this.page.identifier = "/2016/07/19/nowCast";
    };
    (function() {  // DON'T EDIT BELOW THIS LINE
        var d = document, s = d.createElement('script');

        s.src = '//hoehle.disqus.com/embed.js';

        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>



      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <h2 class="footer-heading">Theory meets practice...</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li>Theory meets practice...</li>
          <li><a href="https://math-inf.uni-greifswald.de/en/michael-hoehle/">Michael Höhle</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/mhoehle"><span class="icon icon--github"><svg viewBox="0 0 16 16"><path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/></svg>
</span><span class="username">mhoehle</span></a>

          </li>
          

          
          <li>
            <a href="https://twitter.com/m_hoehle"><span class="icon icon--twitter"><svg viewBox="0 0 16 16"><path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/></svg>
</span><span class="username">m_hoehle</span></a>

          </li>
          
        </ul>
      </div>

      <div class="footer-col footer-col-3">
        <p>A blog about statistics in theory and practice. Not always serious, not always flawless, but definitely a statistically flavoured bean.
</p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
