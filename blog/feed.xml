<?xml version="1.0" encoding="UTF-8"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>Theory meets practice...</title>
    <description>A blog about statistics in theory and practice. Not always serious, not always flawless, but definitely a statistically flavoured bean.
</description>
    <link>https://mhoehle.github.io/blog/</link>
    <atom:link href="https://mhoehle.github.io/blog/feed.xml" rel="self" type="application/rss+xml"/>
    <pubDate>Mon, 24 Feb 2025 09:27:51 +0100</pubDate>
    <lastBuildDate>Mon, 24 Feb 2025 09:27:51 +0100</lastBuildDate>
    <generator>Jekyll v4.4.1</generator>
    
      <item>
        <title>Risky Risk Results</title>
        <description>&lt;h2 id=&quot;abstract&quot;&gt;Abstract:&lt;/h2&gt;
&lt;p&gt;We determine the probabilities of winning battles in the dice-based
board game &lt;strong&gt;Risk&lt;/strong&gt; by counting and using Markov chains.
The results show that if the battle is executed with 5 or more armies,
the attacker has a slight advantage when both the attacker and defender
start with the same number of armies.&lt;/p&gt;
&lt;center&gt;
&lt;img src=&quot;/blog/figure/source/2025-02-21-risk/Risk-dice-example.jpg&quot; /&gt;
&lt;br&gt; Image source: &lt;a
href=&quot;https://en.wikipedia.org/wiki/Image:Risk-dice-example.jpg&quot;&gt;Wikipedia&lt;/a&gt;
&lt;/center&gt;
&lt;p&gt;&lt;br&gt;
&lt;a rel=&quot;license&quot; href=&quot;http://creativecommons.org/licenses/by-sa/4.0/&quot;&gt;&lt;img alt=&quot;Creative Commons License&quot; style=&quot;border-width:0&quot; src=&quot;https://i.creativecommons.org/l/by-sa/4.0/88x31.png&quot;/&gt;&lt;/a&gt;
This work is licensed under a &lt;a rel=&quot;license&quot;
href=&quot;http://creativecommons.org/licenses/by-sa/4.0/&quot;&gt;Creative Commons
Attribution-ShareAlike 4.0 International License&lt;/a&gt;. The &lt;a
href=&quot;https://raw.githubusercontent.com/mhoehle/mhoehle.github.io/master/_source/2025-02-21-risk.Rmd&quot;&gt;R-markdown
source code of this blog&lt;/a&gt; is available under a &lt;a
href=&quot;https://www.gnu.org/licenses/gpl-3.0.html&quot;&gt;GNU General Public
License (GPL v3)&lt;/a&gt; license from GitHub.&lt;/p&gt;
&lt;h2 id=&quot;introduction&quot;&gt;Introduction&lt;/h2&gt;
&lt;p&gt;While watching yet another &lt;a
href=&quot;https://www.youtube.com/watch?v=RdooKXXcWWc&quot;&gt;episode of
Numberphile&lt;/a&gt;, I was puzzled by a statement from &lt;a
href=&quot;https://www.simonyi.ox.ac.uk/&quot;&gt;Marcus du Sautoy&lt;/a&gt; about how
people initially got the analysis of probabilities in the &lt;a
href=&quot;https://en.wikipedia.org/wiki/Risk_(game)&quot;&gt;game of Risk&lt;/a&gt; wrong.
Digging a little deeper, &lt;span class=&quot;citation&quot;
data-cites=&quot;dusautoy2023&quot;&gt;du Sautoy (2023)&lt;/span&gt; on pp. 306-307 refers
to erroneous probability calculations made by &lt;span class=&quot;citation&quot;
data-cites=&quot;tan1997&quot;&gt;Tan (1997)&lt;/span&gt;, which were subsequently
corrected by &lt;span class=&quot;citation&quot; data-cites=&quot;osborne2003&quot;&gt;Osborne
(2003)&lt;/span&gt; using counting techniques. What surprised me was that
&lt;span class=&quot;citation&quot; data-cites=&quot;tan1997&quot;&gt;Tan (1997)&lt;/span&gt; could have
easily spotted the error with a simple Monte Carlo simulation (see
Appendix 1). This story about risky risk results for Risk has become a
motivating example in my &lt;em&gt;Probability 101&lt;/em&gt; class on why Monte
Carlo simulations are important.&lt;/p&gt;
&lt;p&gt;In what follows, I shall focus on computing the necessary
probabilities by counting. Several literature sources, including the
aforementioned &lt;span class=&quot;citation&quot; data-cites=&quot;tan1997&quot;&gt;Tan
(1997)&lt;/span&gt;, &lt;span class=&quot;citation&quot; data-cites=&quot;osborne2003&quot;&gt;Osborne
(2003)&lt;/span&gt;, as well as &lt;span class=&quot;citation&quot;
data-cites=&quot;pierce_wooster2015&quot;&gt;Pierce and Wooster (2015)&lt;/span&gt; and
&lt;span class=&quot;citation&quot; data-cites=&quot;hendel_etal2015&quot;&gt;Hendel et al.
(2015)&lt;/span&gt;, calculate the probabilities. However, I was not able to
find any publicly available programming code to verify their claims.
Hence, the goal of this post is to provide literate programming style
documented open-source R code to compute these probabilities.&lt;/p&gt;
&lt;h2 id=&quot;mathematical-description-of-a-single-battle&quot;&gt;Mathematical
Description of a Single Battle&lt;/h2&gt;
&lt;p&gt;In the &lt;a href=&quot;https://en.wikipedia.org/wiki/Risk_(game)&quot;&gt;Game of
Risk&lt;/a&gt; a single battle between &lt;span class=&quot;math inline&quot;&gt;\(a\)&lt;/span&gt;
attacking armies and &lt;span class=&quot;math inline&quot;&gt;\(d\)&lt;/span&gt; defending
armies is carried out as follows: Both the attacker and the defender
roll one six-sided die for each of their armies inolved in the battle.
The highest die of the attacker is then compared to the highest die of
the defender. If the attacker’s die is higher, then the defender loses
one army, otherwise the attacker loses one army. If both the attacker
and the defender use more than one army, the next-highest dice are
compared, and the process is repeated. The game imposes the restrictions
&lt;span class=&quot;math inline&quot;&gt;\(a \in {1,2,3}\)&lt;/span&gt; and &lt;span
class=&quot;math inline&quot;&gt;\(d \in {1,2}\)&lt;/span&gt; for a single battle.&lt;/p&gt;
&lt;p&gt;Denote by &lt;span class=&quot;math inline&quot;&gt;\(Y_{1}, \ldots, Y_{a}\)&lt;/span&gt;
independent random variables representing the outcomes of the &lt;span
class=&quot;math inline&quot;&gt;\(a\)&lt;/span&gt; dice rolled by the attacker. Similarly,
denote by &lt;span class=&quot;math inline&quot;&gt;\(Z_{1}, \ldots, Z_{d}\)&lt;/span&gt;
independent random variables representing the outcomes of the defender’s
&lt;span class=&quot;math inline&quot;&gt;\(d\)&lt;/span&gt; dice. Each of these &lt;span
class=&quot;math inline&quot;&gt;\(a+d\)&lt;/span&gt; random variables follows a discrete
uniform distribution, i.e. &lt;span
class=&quot;math inline&quot;&gt;\(U(\{1,\ldots,6\})\)&lt;/span&gt;. Furthermore, let &lt;span
class=&quot;math inline&quot;&gt;\(Y_{(1)}\geq \cdots \geq Y_{(a)}\)&lt;/span&gt; and &lt;span
class=&quot;math inline&quot;&gt;\(Z_{(1)}\geq \cdots \geq Z_{(d)}\)&lt;/span&gt; denote
the ordered outcomes of the attacker’s and defender’s dice,
respectively.&lt;/p&gt;
&lt;p&gt;The result of the first comparison is that the defender loses an
army, if &lt;span class=&quot;math inline&quot;&gt;\(Y_{(1)}&amp;gt;Z_{(1)}\)&lt;/span&gt;;
otherwise, the attacker loses an army. If a second comparison is to be
made – that is, if &lt;span class=&quot;math inline&quot;&gt;\(\min(a,d)=2\)&lt;/span&gt; –
then the defender loses an army if &lt;span
class=&quot;math inline&quot;&gt;\(Y_{(2)}&amp;gt;Z_{(2)}\)&lt;/span&gt;; otherwise the
attacker loses an army. Hence, a random variable describing the number
of armies the defender loses in an &lt;span
class=&quot;math inline&quot;&gt;\(a\)&lt;/span&gt; vs. &lt;span
class=&quot;math inline&quot;&gt;\(d\)&lt;/span&gt; battle is &lt;span class=&quot;math display&quot;&gt;\[
D = \sum_{i=1}^{\min(a,d)} I(Y_{(i)}&amp;gt;Z_{(i)}),
\]&lt;/span&gt; where &lt;span class=&quot;math inline&quot;&gt;\(I(\cdot)\)&lt;/span&gt; is an
indicator function that equals 1 if its argument is true and 0
otherwise. The variable &lt;span class=&quot;math inline&quot;&gt;\(D\)&lt;/span&gt; has
support on the integer values &lt;span
class=&quot;math inline&quot;&gt;\(0,\ldots,\min(a,d)\)&lt;/span&gt;. Similarly, the number
of armies the attacker loses is &lt;span class=&quot;math inline&quot;&gt;\(A =
\min(a,d) - D\)&lt;/span&gt;. Example: In the splash picture of the abstract,
the attacker rolled 4,3,3 (red dice) and the defender 3,2 (white dice).
Since &lt;span class=&quot;math inline&quot;&gt;\(4&amp;gt;3\)&lt;/span&gt; and &lt;span
class=&quot;math inline&quot;&gt;\(3&amp;gt;2\)&lt;/span&gt;, the defender loses two armies in
this specific battle.&lt;/p&gt;
&lt;p&gt;Denote by &lt;span class=&quot;math inline&quot;&gt;\(p_{adk}\)&lt;/span&gt; the
probability that a single battle between &lt;span
class=&quot;math inline&quot;&gt;\(a\)&lt;/span&gt; attacking armies and &lt;span
class=&quot;math inline&quot;&gt;\(d\)&lt;/span&gt; defending armies results in the
defender losing &lt;span class=&quot;math inline&quot;&gt;\(k\)&lt;/span&gt; armies, &lt;span
class=&quot;math inline&quot;&gt;\(k=0,\ldots,\min(a,d)\)&lt;/span&gt;. This probability
can be computed by dividing the number of favourable outcomes by the
total number of possible outcomes:&lt;/p&gt;
&lt;p&gt;&lt;span class=&quot;math display&quot;&gt;\[\begin{align}  
p_{adk} = \frac{1}{6^{a+d}}\sum_{y_1=0}^6 \cdots \sum_{y_a=0}^6
\sum_{z_1=0}^6 \cdots \sum_{z_d=0}^6
I\left(\left\{\sum_{j=1}^{\min(a,d)} I(y_{(j)}&amp;gt;z_{(j)})\right\} =
k\right)
\end{align}\]&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;Although this formula may look involved, the &lt;span
class=&quot;math inline&quot;&gt;\(6^{a+d}\)&lt;/span&gt; is just the number of possible
outcomes when throwing &lt;span class=&quot;math inline&quot;&gt;\(a+d\)&lt;/span&gt; dice and
the summation over the indicator function is just a way to count all
favourable configurations in the Cartesian product sample space &lt;span
class=&quot;math inline&quot;&gt;\(\{1,\ldots,6\}^{a+d}\)&lt;/span&gt;. Since the maximum
values for &lt;span class=&quot;math inline&quot;&gt;\(a\)&lt;/span&gt; and &lt;span
class=&quot;math inline&quot;&gt;\(d\)&lt;/span&gt; in Risk are 3 and 2, respectively, the
dimension of the product space will be no larger than &lt;span
class=&quot;math inline&quot;&gt;\(6^5=`6^5`\)&lt;/span&gt;, which is tractable.&lt;/p&gt;
&lt;h2 id=&quot;computation&quot;&gt;Computation&lt;/h2&gt;
&lt;p&gt;We start the R code by defining that we look at outcomes of the dice
D6, i.e. the sample space of one dice is &lt;span
class=&quot;math inline&quot;&gt;\(\Omega = \{1,\ldots,6\}\)&lt;/span&gt;.&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb1&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb1-1&quot;&gt;&lt;a href=&quot;#cb1-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;# Sample space for one dice throw&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-2&quot;&gt;&lt;a href=&quot;#cb1-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;Omega &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;6&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;We then write a function, which uses the &lt;code&gt;expand_grid()&lt;/code&gt;
function repeatedly in order to generate the Cartesian product &lt;span
class=&quot;math inline&quot;&gt;\(\Omega^\text{nDice}\)&lt;/span&gt; for &lt;span
class=&quot;math inline&quot;&gt;\(\text{nDice}\in\mathbb{N}\)&lt;/span&gt; dice.
Furthermore, we add a column containing the probability for each element
in this sample space, i.e. the probability is &lt;span
class=&quot;math inline&quot;&gt;\(1/|\Omega|^{\text{nDice}}=1/6^{\text{nDice}}\)&lt;/span&gt;,
since the dice are assumed to be fair.&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb2&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb2-1&quot;&gt;&lt;a href=&quot;#cb2-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;# Do expand_grid on the \Omega set sequentially a given number of nDice times. &lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb2-2&quot;&gt;&lt;a href=&quot;#cb2-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;# At the end we have nDice columns.&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb2-3&quot;&gt;&lt;a href=&quot;#cb2-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;#&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb2-4&quot;&gt;&lt;a href=&quot;#cb2-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;# @param nDice (integer) We compute \Omega_{dice}^{nDice}&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb2-5&quot;&gt;&lt;a href=&quot;#cb2-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;# @param Omega (vector of integers) The faces on the dice.&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb2-6&quot;&gt;&lt;a href=&quot;#cb2-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;#&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb2-7&quot;&gt;&lt;a href=&quot;#cb2-7&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;# @return Tibble with nDice columns containing all |\Omega_{dice}|^{nDice} possible outcomes and a column stating the probability of each element in this sample space, i.e. 1/|\Omega_{dice}^{nDice}|.&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb2-8&quot;&gt;&lt;a href=&quot;#cb2-8&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb2-9&quot;&gt;&lt;a href=&quot;#cb2-9&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;sample_space &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;cf&quot;&gt;function&lt;/span&gt;(nDice, &lt;span class=&quot;at&quot;&gt;Omega=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;6&lt;/span&gt;) {&lt;/span&gt;
&lt;span id=&quot;cb2-10&quot;&gt;&lt;a href=&quot;#cb2-10&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt; &lt;span class=&quot;fu&quot;&gt;expand_grid&lt;/span&gt;(&lt;span class=&quot;sc&quot;&gt;!!!&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;replicate&lt;/span&gt;(nDice, Omega, &lt;span class=&quot;at&quot;&gt;simplify =&lt;/span&gt; &lt;span class=&quot;cn&quot;&gt;FALSE&lt;/span&gt;)) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;/span&gt;
&lt;span id=&quot;cb2-11&quot;&gt;&lt;a href=&quot;#cb2-11&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;fu&quot;&gt;setNames&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;str_c&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;quot;D&amp;quot;&lt;/span&gt;, &lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;dt&quot;&gt;L&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;:&lt;/span&gt;nDice)) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;/span&gt;
&lt;span id=&quot;cb2-12&quot;&gt;&lt;a href=&quot;#cb2-12&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;fu&quot;&gt;mutate&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;prob =&lt;/span&gt; &lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;/&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;length&lt;/span&gt;(Omega)&lt;span class=&quot;sc&quot;&gt;^&lt;/span&gt;nDice))&lt;/span&gt;
&lt;span id=&quot;cb2-13&quot;&gt;&lt;a href=&quot;#cb2-13&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Instead of calculating a matrix containing all possible outcomes of
the &lt;span class=&quot;math inline&quot;&gt;\(a+d\)&lt;/span&gt; dice, as in the sum-formula
above, and then handling the sorting, we divide the problem into two
tasks:&lt;/p&gt;
&lt;ol type=&quot;1&quot;&gt;
&lt;li&gt;Calculate all possible outcomes and their probabilities when sorting
the outcome of the attacker’s &lt;span class=&quot;math inline&quot;&gt;\(a\)&lt;/span&gt;
dices&lt;/li&gt;
&lt;li&gt;Calculate all possible outcomes and their probabilities when sorting
the outcome of the attacker’s &lt;span class=&quot;math inline&quot;&gt;\(d\)&lt;/span&gt;
dices&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;Since the dice throws of the attacker and defender are independent,
we can then compute the required joint distribution by multiplying the
two marginal distributions found in 1. and 2.&lt;/p&gt;
&lt;p&gt;As a consequence we write a function that returns all possible
outcomes of &lt;span class=&quot;math inline&quot;&gt;\(Y_{(1)} \leq \ldots \leq
Y_{(\text{nCompare})}\)&lt;/span&gt; obtained after ordering the outcome of
dice, i.e. &lt;span class=&quot;math inline&quot;&gt;\(Y_{(1)} \leq \ldots \leq
Y_{(\text{nDice})}\)&lt;/span&gt; with &lt;span
class=&quot;math inline&quot;&gt;\(\text{nCompare} \leq \text{nDice}\)&lt;/span&gt;. To be
compatible with the game of risk &lt;span
class=&quot;math inline&quot;&gt;\(\text{nCompare}\in\{1,2\}\)&lt;/span&gt;. We compute the
associated probabilities by adding up the underlying entries of the
Cartesian sample space.&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb3&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb3-1&quot;&gt;&lt;a href=&quot;#cb3-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;combos_sorted &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;cf&quot;&gt;function&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;nDice=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;3&lt;/span&gt;, &lt;span class=&quot;at&quot;&gt;nCompare=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;min&lt;/span&gt;(&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;,nDice), &lt;span class=&quot;at&quot;&gt;base_name =&lt;/span&gt; &lt;span class=&quot;st&quot;&gt;&amp;quot;y&amp;quot;&lt;/span&gt;) {&lt;/span&gt;
&lt;span id=&quot;cb3-2&quot;&gt;&lt;a href=&quot;#cb3-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;co&quot;&gt;# Generate all outcomes and make a label&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb3-3&quot;&gt;&lt;a href=&quot;#cb3-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;co&quot;&gt;# which identifies which of the sorted bins the outcome belongs to&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb3-4&quot;&gt;&lt;a href=&quot;#cb3-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  combos &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;sample_space&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;nDice=&lt;/span&gt;nDice) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb3-5&quot;&gt;&lt;a href=&quot;#cb3-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;fu&quot;&gt;rowwise&lt;/span&gt;() &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;/span&gt;
&lt;span id=&quot;cb3-6&quot;&gt;&lt;a href=&quot;#cb3-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;fu&quot;&gt;mutate&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;combo_sorted =&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;str_c&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;sort&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;c_across&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;all_of&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;paste0&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;quot;D&amp;quot;&lt;/span&gt;, &lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;:&lt;/span&gt;nDice))), &lt;span class=&quot;at&quot;&gt;decreasing=&lt;/span&gt;&lt;span class=&quot;cn&quot;&gt;TRUE&lt;/span&gt;), &lt;span class=&quot;at&quot;&gt;collapse=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;&amp;quot;&lt;/span&gt;),&lt;/span&gt;
&lt;span id=&quot;cb3-7&quot;&gt;&lt;a href=&quot;#cb3-7&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;           &lt;span class=&quot;at&quot;&gt;combo_label =&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;str_sub&lt;/span&gt;(combo_sorted, &lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;, nCompare)) &lt;/span&gt;
&lt;span id=&quot;cb3-8&quot;&gt;&lt;a href=&quot;#cb3-8&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;/span&gt;
&lt;span id=&quot;cb3-9&quot;&gt;&lt;a href=&quot;#cb3-9&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;co&quot;&gt;# Count accoring&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb3-10&quot;&gt;&lt;a href=&quot;#cb3-10&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  combos_summed &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; combos &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;group_by&lt;/span&gt;(combo_label) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb3-11&quot;&gt;&lt;a href=&quot;#cb3-11&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;fu&quot;&gt;summarise&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;n=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;n&lt;/span&gt;(), &lt;span class=&quot;at&quot;&gt;prob=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;sum&lt;/span&gt;(prob)) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;/span&gt;
&lt;span id=&quot;cb3-12&quot;&gt;&lt;a href=&quot;#cb3-12&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;fu&quot;&gt;arrange&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;desc&lt;/span&gt;(combo_label)) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;/span&gt;
&lt;span id=&quot;cb3-13&quot;&gt;&lt;a href=&quot;#cb3-13&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;co&quot;&gt;# We use the notation by Osborn (2009) and denote the columns y^{(1)} \geq y^{(2)} \geq y^{(3)}&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb3-14&quot;&gt;&lt;a href=&quot;#cb3-14&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;fu&quot;&gt;separate_wider_position&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;cols =&lt;/span&gt; combo_label, &lt;span class=&quot;at&quot;&gt;widths =&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;set_names&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;rep&lt;/span&gt;(&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;, nCompare), &lt;span class=&quot;at&quot;&gt;nm=&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;str_c&lt;/span&gt;(base_name, &lt;span class=&quot;st&quot;&gt;&amp;quot;_{(&amp;quot;&lt;/span&gt;, &lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;:&lt;/span&gt;nCompare,&lt;span class=&quot;st&quot;&gt;&amp;quot;)}&amp;quot;&lt;/span&gt;)))&lt;/span&gt;
&lt;span id=&quot;cb3-15&quot;&gt;&lt;a href=&quot;#cb3-15&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb3-16&quot;&gt;&lt;a href=&quot;#cb3-16&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;co&quot;&gt;# Done&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb3-17&quot;&gt;&lt;a href=&quot;#cb3-17&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;return&lt;/span&gt;(combos_summed)&lt;/span&gt;
&lt;span id=&quot;cb3-18&quot;&gt;&lt;a href=&quot;#cb3-18&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;As an example:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb4&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb4-1&quot;&gt;&lt;a href=&quot;#cb4-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;combos_sorted&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;nDice=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;3&lt;/span&gt;, &lt;span class=&quot;at&quot;&gt;nCompare=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;## # A tibble: 21 × 4
##   `y_{(1)}` `y_{(2)}`     n   prob
##   &amp;lt;chr&amp;gt;     &amp;lt;chr&amp;gt;     &amp;lt;int&amp;gt;  &amp;lt;dbl&amp;gt;
## 1 6         6            16 0.0741
## 2 6         5            27 0.125 
## 3 6         4            21 0.0972
## 4 6         3            15 0.0694
## 5 6         2             9 0.0417
## # ℹ 16 more rows&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;This can then be combined to obtain the joint distribution of the
sorted dice to be compared.&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb6&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb6-1&quot;&gt;&lt;a href=&quot;#cb6-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;joint_combos_sorted &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;cf&quot;&gt;function&lt;/span&gt;(a, d) {&lt;/span&gt;
&lt;span id=&quot;cb6-2&quot;&gt;&lt;a href=&quot;#cb6-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;co&quot;&gt;# Sort the throws of the attacker and defender&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb6-3&quot;&gt;&lt;a href=&quot;#cb6-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  Y &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;combos_sorted&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;nDice=&lt;/span&gt;a, &lt;span class=&quot;at&quot;&gt;base_name=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;y&amp;quot;&lt;/span&gt;)&lt;/span&gt;
&lt;span id=&quot;cb6-4&quot;&gt;&lt;a href=&quot;#cb6-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  Z &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;combos_sorted&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;nDice=&lt;/span&gt;d, &lt;span class=&quot;at&quot;&gt;base_name=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;z&amp;quot;&lt;/span&gt;) &lt;/span&gt;
&lt;span id=&quot;cb6-5&quot;&gt;&lt;a href=&quot;#cb6-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;/span&gt;
&lt;span id=&quot;cb6-6&quot;&gt;&lt;a href=&quot;#cb6-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;co&quot;&gt;# Make a tibble with all combinations of the a vs. d armies fight&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb6-7&quot;&gt;&lt;a href=&quot;#cb6-7&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  joint &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; Y &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;cross_join&lt;/span&gt;(Z) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb6-8&quot;&gt;&lt;a href=&quot;#cb6-8&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;fu&quot;&gt;mutate&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;prob =&lt;/span&gt; prob.x &lt;span class=&quot;sc&quot;&gt;*&lt;/span&gt; prob.y,&lt;/span&gt;
&lt;span id=&quot;cb6-9&quot;&gt;&lt;a href=&quot;#cb6-9&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;           &lt;span class=&quot;at&quot;&gt;n =&lt;/span&gt; n.x &lt;span class=&quot;sc&quot;&gt;*&lt;/span&gt; n.y) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;/span&gt;
&lt;span id=&quot;cb6-10&quot;&gt;&lt;a href=&quot;#cb6-10&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;fu&quot;&gt;select&lt;/span&gt;(&lt;span class=&quot;sc&quot;&gt;-&lt;/span&gt;n.x, &lt;span class=&quot;sc&quot;&gt;-&lt;/span&gt;n.y, &lt;span class=&quot;sc&quot;&gt;-&lt;/span&gt;prob.x, &lt;span class=&quot;sc&quot;&gt;-&lt;/span&gt;prob.y)&lt;/span&gt;
&lt;span id=&quot;cb6-11&quot;&gt;&lt;a href=&quot;#cb6-11&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;/span&gt;
&lt;span id=&quot;cb6-12&quot;&gt;&lt;a href=&quot;#cb6-12&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;co&quot;&gt;#Done&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb6-13&quot;&gt;&lt;a href=&quot;#cb6-13&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;return&lt;/span&gt;(joint)&lt;/span&gt;
&lt;span id=&quot;cb6-14&quot;&gt;&lt;a href=&quot;#cb6-14&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Which for a single &lt;span class=&quot;math inline&quot;&gt;\(a=3\)&lt;/span&gt; vs. &lt;span
class=&quot;math inline&quot;&gt;\(d=2\)&lt;/span&gt; battle would look like:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb7&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb7-1&quot;&gt;&lt;a href=&quot;#cb7-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;head&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;joint_combos_sorted&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;a=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;3&lt;/span&gt;, &lt;span class=&quot;at&quot;&gt;d=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;), &lt;span class=&quot;at&quot;&gt;n=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;3&lt;/span&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;## # A tibble: 3 × 6
##   `y_{(1)}` `y_{(2)}` `z_{(1)}` `z_{(2)}`    prob     n
##   &amp;lt;chr&amp;gt;     &amp;lt;chr&amp;gt;     &amp;lt;chr&amp;gt;     &amp;lt;chr&amp;gt;       &amp;lt;dbl&amp;gt; &amp;lt;int&amp;gt;
## 1 6         6         6         6         0.00206    16
## 2 6         6         6         5         0.00412    32
## 3 6         6         6         4         0.00412    32&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;We can now compute &lt;span class=&quot;math inline&quot;&gt;\(p_{adk}\)&lt;/span&gt; by
comparing &lt;span class=&quot;math inline&quot;&gt;\(Y_{(i)}&amp;gt;Z_{(i)}\)&lt;/span&gt; for
all relevant &lt;span class=&quot;math inline&quot;&gt;\(i=1,\ldots,\min(a,d)\)&lt;/span&gt;
and summing all outcomes where the defender loses &lt;span
class=&quot;math inline&quot;&gt;\(k\)&lt;/span&gt; armies:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb9&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb9-1&quot;&gt;&lt;a href=&quot;#cb9-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;########################################################################&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb9-2&quot;&gt;&lt;a href=&quot;#cb9-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;# Distribution over the number of armies that defender is losing,&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb9-3&quot;&gt;&lt;a href=&quot;#cb9-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;# when attacker is using A armies and defender is using D armies.&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb9-4&quot;&gt;&lt;a href=&quot;#cb9-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;# &lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb9-5&quot;&gt;&lt;a href=&quot;#cb9-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;# @param A Number of armies (=dice) the attacker sends into the battle&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb9-6&quot;&gt;&lt;a href=&quot;#cb9-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;# @param D Number of armies (=dice) the defender sends into the fight&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb9-7&quot;&gt;&lt;a href=&quot;#cb9-7&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;#&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb9-8&quot;&gt;&lt;a href=&quot;#cb9-8&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;# @return A tibble containing all possible outcomes of the battle in terms&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb9-9&quot;&gt;&lt;a href=&quot;#cb9-9&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;#         of losses for attacker and defender.&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb9-10&quot;&gt;&lt;a href=&quot;#cb9-10&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;########################################################################&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb9-11&quot;&gt;&lt;a href=&quot;#cb9-11&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;p_lose_ad &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;cf&quot;&gt;function&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;a=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;3&lt;/span&gt;, &lt;span class=&quot;at&quot;&gt;d=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;) {&lt;/span&gt;
&lt;span id=&quot;cb9-12&quot;&gt;&lt;a href=&quot;#cb9-12&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;co&quot;&gt;# All joint combinations of attacker and defender&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb9-13&quot;&gt;&lt;a href=&quot;#cb9-13&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  joint &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;joint_combos_sorted&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;a=&lt;/span&gt;a, &lt;span class=&quot;at&quot;&gt;d=&lt;/span&gt;d)&lt;/span&gt;
&lt;span id=&quot;cb9-14&quot;&gt;&lt;a href=&quot;#cb9-14&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;/span&gt;
&lt;span id=&quot;cb9-15&quot;&gt;&lt;a href=&quot;#cb9-15&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;co&quot;&gt;# Number of dice to compare&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb9-16&quot;&gt;&lt;a href=&quot;#cb9-16&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  nCompare &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;pmin&lt;/span&gt;(a, d)&lt;/span&gt;
&lt;span id=&quot;cb9-17&quot;&gt;&lt;a href=&quot;#cb9-17&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;/span&gt;
&lt;span id=&quot;cb9-18&quot;&gt;&lt;a href=&quot;#cb9-18&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;co&quot;&gt;# I find this loop version easier to understand&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb9-19&quot;&gt;&lt;a href=&quot;#cb9-19&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;co&quot;&gt;# than a corresponding tidyverse version&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb9-20&quot;&gt;&lt;a href=&quot;#cb9-20&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;cf&quot;&gt;for&lt;/span&gt; (k &lt;span class=&quot;cf&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;seq_len&lt;/span&gt;(nCompare)) {&lt;/span&gt;
&lt;span id=&quot;cb9-21&quot;&gt;&lt;a href=&quot;#cb9-21&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    joint[, &lt;span class=&quot;fu&quot;&gt;str_c&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;quot;lose_D_pos&amp;quot;&lt;/span&gt;, k)] &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; (joint[,&lt;span class=&quot;fu&quot;&gt;str_c&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;quot;y_{(&amp;quot;&lt;/span&gt;,k,&lt;span class=&quot;st&quot;&gt;&amp;quot;)}&amp;quot;&lt;/span&gt;)] &lt;span class=&quot;sc&quot;&gt;&amp;gt;&lt;/span&gt; joint[,&lt;span class=&quot;fu&quot;&gt;str_c&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;quot;z_{(&amp;quot;&lt;/span&gt;,k,&lt;span class=&quot;st&quot;&gt;&amp;quot;)}&amp;quot;&lt;/span&gt;)])&lt;/span&gt;
&lt;span id=&quot;cb9-22&quot;&gt;&lt;a href=&quot;#cb9-22&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  }&lt;/span&gt;
&lt;span id=&quot;cb9-23&quot;&gt;&lt;a href=&quot;#cb9-23&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;/span&gt;
&lt;span id=&quot;cb9-24&quot;&gt;&lt;a href=&quot;#cb9-24&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;co&quot;&gt;# Total sum of armies lost by defender and attacker, respectively&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb9-25&quot;&gt;&lt;a href=&quot;#cb9-25&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  joint &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; joint &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;/span&gt;
&lt;span id=&quot;cb9-26&quot;&gt;&lt;a href=&quot;#cb9-26&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;fu&quot;&gt;mutate&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;lose_D =&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;rowSums&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;select&lt;/span&gt;(., &lt;span class=&quot;fu&quot;&gt;matches&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;quot;^lose_D_pos[0-9]+&amp;quot;&lt;/span&gt;))),&lt;/span&gt;
&lt;span id=&quot;cb9-27&quot;&gt;&lt;a href=&quot;#cb9-27&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;           &lt;span class=&quot;at&quot;&gt;lose_A =&lt;/span&gt; nCompare &lt;span class=&quot;sc&quot;&gt;-&lt;/span&gt; lose_D)  &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;/span&gt;
&lt;span id=&quot;cb9-28&quot;&gt;&lt;a href=&quot;#cb9-28&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;fu&quot;&gt;select&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;starts_with&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;quot;y&amp;quot;&lt;/span&gt;), &lt;span class=&quot;fu&quot;&gt;starts_with&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;quot;z&amp;quot;&lt;/span&gt;), prob, lose_A, lose_D) &lt;/span&gt;
&lt;span id=&quot;cb9-29&quot;&gt;&lt;a href=&quot;#cb9-29&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;/span&gt;
&lt;span id=&quot;cb9-30&quot;&gt;&lt;a href=&quot;#cb9-30&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;co&quot;&gt;# Add up probabilities for all combos yielding a specific&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb9-31&quot;&gt;&lt;a href=&quot;#cb9-31&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;co&quot;&gt;# lose_A, lose_D combo&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb9-32&quot;&gt;&lt;a href=&quot;#cb9-32&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  res &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; joint &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;group_by&lt;/span&gt;(lose_A, lose_D) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;/span&gt;
&lt;span id=&quot;cb9-33&quot;&gt;&lt;a href=&quot;#cb9-33&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;fu&quot;&gt;summarise&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;prob =&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;sum&lt;/span&gt;(prob), &lt;span class=&quot;at&quot;&gt;.groups=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;drop&amp;quot;&lt;/span&gt;) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;/span&gt;
&lt;span id=&quot;cb9-34&quot;&gt;&lt;a href=&quot;#cb9-34&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;fu&quot;&gt;arrange&lt;/span&gt;(lose_D)&lt;/span&gt;
&lt;span id=&quot;cb9-35&quot;&gt;&lt;a href=&quot;#cb9-35&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb9-36&quot;&gt;&lt;a href=&quot;#cb9-36&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;co&quot;&gt;# Done&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb9-37&quot;&gt;&lt;a href=&quot;#cb9-37&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;return&lt;/span&gt;(res)&lt;/span&gt;
&lt;span id=&quot;cb9-38&quot;&gt;&lt;a href=&quot;#cb9-38&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;To test the function, we compute &lt;span
class=&quot;math inline&quot;&gt;\((p_{320},p_{321},p_{322})\)&lt;/span&gt;, which &lt;span
class=&quot;citation&quot; data-cites=&quot;osborne2003&quot;&gt;Osborne (2003)&lt;/span&gt; found to
be &lt;span class=&quot;math inline&quot;&gt;\((2275, 2611,
2890)/7776=(0.293,0.336,0.372)\)&lt;/span&gt;:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb10&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb10-1&quot;&gt;&lt;a href=&quot;#cb10-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;# 3 vs. 2 battle&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb10-2&quot;&gt;&lt;a href=&quot;#cb10-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;p_lose_ad&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;a=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;3&lt;/span&gt;, &lt;span class=&quot;at&quot;&gt;d=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;## # A tibble: 3 × 3
##   lose_A lose_D  prob
##    &amp;lt;dbl&amp;gt;  &amp;lt;dbl&amp;gt; &amp;lt;dbl&amp;gt;
## 1      2      0 0.293
## 2      1      1 0.336
## 3      0      2 0.372&lt;/code&gt;&lt;/pre&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb12&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb12-1&quot;&gt;&lt;a href=&quot;#cb12-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;# Check that p_lose_ad is correct for p_{32k}, k=0,1,2&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb12-2&quot;&gt;&lt;a href=&quot;#cb12-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;all.equal&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;p_lose_ad&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;a=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;3&lt;/span&gt;, &lt;span class=&quot;at&quot;&gt;d=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;pull&lt;/span&gt;(prob), &lt;span class=&quot;fu&quot;&gt;c&lt;/span&gt;(&lt;span class=&quot;dv&quot;&gt;2275&lt;/span&gt;, &lt;span class=&quot;dv&quot;&gt;2611&lt;/span&gt;, &lt;span class=&quot;dv&quot;&gt;2890&lt;/span&gt;)&lt;span class=&quot;sc&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;7776&lt;/span&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;## [1] TRUE&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;An alternative verification is to use the &lt;a
href=&quot;https://topps.diku.dk/torbenm/troll.msp&quot;&gt;Troll dice roller and
probability calculator&lt;/a&gt; by &lt;a
href=&quot;http://hjemmesider.diku.dk/~torbenm/&quot;&gt;Torben Æ. Mogensen&lt;/a&gt; using
the following syntax:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;a:=3d6;b:=2d6;
count {(max a)&amp;gt;(max b),(min largest 2 a)&amp;gt;(min b)}&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Troll computes the probability distribution as:&lt;/p&gt;
&lt;center&gt;
&lt;img src=&quot;/blog/figure/source/2025-02-21-risk/troll_riskroll.png&quot; /&gt;
&lt;br&gt; Figure 1: Results for the 3 vs. 2 risk roll in Troll.
&lt;/center&gt;
&lt;p&gt;
&lt;p&gt;Note that for the &lt;span class=&quot;math inline&quot;&gt;\(p_{32k},
k=0,1,2\)&lt;/span&gt; setup, &lt;span class=&quot;citation&quot; data-cites=&quot;tan1997&quot;&gt;Tan
(1997)&lt;/span&gt; instead obtained &lt;span class=&quot;math inline&quot;&gt;\((0.237,
0.504, 0.259)\)&lt;/span&gt;, which differs substantially from the correct
result. See Appendix 2 for a discussion of his calculations.&lt;/p&gt;
&lt;p&gt;The complete table of probabilities for all possible single battle
attacker vs. defender configurations can now be computed as follows:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb15&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb15-1&quot;&gt;&lt;a href=&quot;#cb15-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;state_change &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;expand_grid&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;a=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;3&lt;/span&gt;, &lt;span class=&quot;at&quot;&gt;d=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;rowwise&lt;/span&gt;() &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;/span&gt;
&lt;span id=&quot;cb15-2&quot;&gt;&lt;a href=&quot;#cb15-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;mutate&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;prob =&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;list&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;p_lose_ad&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;a=&lt;/span&gt;a, &lt;span class=&quot;at&quot;&gt;d=&lt;/span&gt;d))) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;/span&gt;
&lt;span id=&quot;cb15-3&quot;&gt;&lt;a href=&quot;#cb15-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;unnest&lt;/span&gt;(prob)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;## Warning: `...` must be empty in `format.tbl()`
## Caused by error in `format_tbl()`:
## ! `...` must be empty.
## ✖ Problematic argument:
## • row.names = FALSE&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## # A tibble: 14 × 4
##        a     d     k  prob
##    &amp;lt;int&amp;gt; &amp;lt;int&amp;gt; &amp;lt;dbl&amp;gt; &amp;lt;dbl&amp;gt;
##  1     1     1     0 0.583
##  2     1     1     1 0.417
##  3     1     2     0 0.745
##  4     1     2     1 0.255
##  5     2     1     0 0.421
##  6     2     1     1 0.579
##  7     2     2     0 0.448
##  8     2     2     1 0.324
##  9     2     2     2 0.228
## 10     3     1     0 0.340
## 11     3     1     1 0.660
## 12     3     2     0 0.293
## 13     3     2     1 0.336
## 14     3     2     2 0.372&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Voila! The values align with those in Table 2 of &lt;span
class=&quot;citation&quot; data-cites=&quot;osborne2003&quot;&gt;Osborne (2003)&lt;/span&gt;.&lt;/p&gt;
&lt;h2 id=&quot;repeated-battles-using-markov-chains&quot;&gt;Repeated Battles using
Markov Chains&lt;/h2&gt;
&lt;p&gt;Once the probabilities for army losses of a single battle have been
computed, the natural follow-up question is: what happens if the
attacker decides to continue the attack? Assume that the attacker
continues to battle with as many armies as possible until either the
attacker has no armies left to attack with or the defender is destroyed,
i.e. has no armies left. What is the probability of an attacker with
&lt;span class=&quot;math inline&quot;&gt;\(A\geq 1\)&lt;/span&gt; armies winning such a
repeated attack against a defender with &lt;span
class=&quot;math inline&quot;&gt;\(D\geq 1\)&lt;/span&gt; armies?&lt;/p&gt;
&lt;p&gt;As stated in &lt;span class=&quot;citation&quot; data-cites=&quot;osborne2003&quot;&gt;Osborne
(2003)&lt;/span&gt;, this is elegantly solved using Markov chains. Denote by
&lt;span class=&quot;math inline&quot;&gt;\((A,D)\)&lt;/span&gt; the current state of the
chain with &lt;span class=&quot;math inline&quot;&gt;\(A\)&lt;/span&gt; attacking armies and
&lt;span class=&quot;math inline&quot;&gt;\(D\)&lt;/span&gt; defending armies. Assuming that
both attacker and defender use as many dice possible, i.e. &lt;span
class=&quot;math inline&quot;&gt;\(a=\min(3,A)\)&lt;/span&gt; and &lt;span
class=&quot;math inline&quot;&gt;\(d=\min(2,D)\)&lt;/span&gt;, the next battle would be a 3
vs. 2 battle if &lt;span class=&quot;math inline&quot;&gt;\(A\geq 3\)&lt;/span&gt; and &lt;span
class=&quot;math inline&quot;&gt;\(D\geq 2\)&lt;/span&gt;. Hence, the attacker can lose
&lt;span class=&quot;math inline&quot;&gt;\(0,1,2\)&lt;/span&gt; armies, while the defender
can lose &lt;span class=&quot;math inline&quot;&gt;\(0,1,2\)&lt;/span&gt; armies. No matter
the outcome, 2 armies will be lost in the battle. Therefore, the new
state is: &lt;span class=&quot;math display&quot;&gt;\[
(A,D) \longrightarrow \left\{
\begin{array}{cl}
(A-2, D) &amp;amp; \text{with probability } \pi_{320} \\
(A-1, D-1) &amp;amp; \text{with probability } \pi_{321} \\
(A, D-2) &amp;amp; \text{with probability } \pi_{322}
\end{array}
\right.
\]&lt;/span&gt; If &lt;span class=&quot;math inline&quot;&gt;\(A\)&lt;/span&gt; and/or &lt;span
class=&quot;math inline&quot;&gt;\(D\)&lt;/span&gt; are smaller than 3 and 2 the transition
and its probability changes accordingly. Note that once either &lt;span
class=&quot;math inline&quot;&gt;\(A\)&lt;/span&gt; or &lt;span
class=&quot;math inline&quot;&gt;\(D\)&lt;/span&gt; is zero, the state is absorbing,
meaning it is no longer possible to continue the battle, and the state
will remain the same. If after updating &lt;span
class=&quot;math inline&quot;&gt;\(A=0\)&lt;/span&gt;, the attacker has lost the fight&lt;a
href=&quot;#fn1&quot; class=&quot;footnote-ref&quot; id=&quot;fnref1&quot;
role=&quot;doc-noteref&quot;&gt;&lt;sup&gt;1&lt;/sup&gt;&lt;/a&gt;. However, if &lt;span
class=&quot;math inline&quot;&gt;\(D = 0\)&lt;/span&gt;, the defender loses, and the
attacker conquers the country.&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb18&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb18-1&quot;&gt;&lt;a href=&quot;#cb18-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;# Armies at the start of the battle&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb18-2&quot;&gt;&lt;a href=&quot;#cb18-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;A &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;dv&quot;&gt;10&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb18-3&quot;&gt;&lt;a href=&quot;#cb18-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;D &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;dv&quot;&gt;10&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb18-4&quot;&gt;&lt;a href=&quot;#cb18-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;size_state_space &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; (A&lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;)&lt;span class=&quot;sc&quot;&gt;*&lt;/span&gt;(D&lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Suppose we start with &lt;span class=&quot;math inline&quot;&gt;\(A=10\)&lt;/span&gt;
attacking armies and &lt;span class=&quot;math inline&quot;&gt;\(D=10\)&lt;/span&gt; defending
armies. The corresponding state space of the Markov chain is &lt;span
class=&quot;math inline&quot;&gt;\(\{(A, D), A\in\{0,\ldots,10\}, D\in
\{0,\ldots,10\}\}\)&lt;/span&gt;. Mapping this to a vector means creating a
vector of length &lt;span class=&quot;math inline&quot;&gt;\(11 \times 11=121\)&lt;/span&gt;.
Hence, the transition matrix &lt;span class=&quot;math inline&quot;&gt;\(P\)&lt;/span&gt; will
be &lt;span class=&quot;math inline&quot;&gt;\((121\times121)\)&lt;/span&gt; matrix. We
implement this in the function &lt;code&gt;transition_matrix(A, D)&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;The vector representing the situation with &lt;span
class=&quot;math inline&quot;&gt;\(10\)&lt;/span&gt; attacking armies and 10 defending
armies would be &lt;span class=&quot;math inline&quot;&gt;\(\mathbf{x}_0=(0,\ldots,0,
1)^\top\)&lt;/span&gt;. The development in probabilities over the state space
after a single battle can then be represented as &lt;span
class=&quot;math inline&quot;&gt;\(\mathbf{x}_1 =
\mathbf{x}_0^\top\mathbf{P}\)&lt;/span&gt;. Starting in state &lt;span
class=&quot;math inline&quot;&gt;\((10,10)\)&lt;/span&gt; we can thus go to either &lt;span
class=&quot;math inline&quot;&gt;\((8,10)\)&lt;/span&gt;, &lt;span
class=&quot;math inline&quot;&gt;\((9,9)\)&lt;/span&gt; or &lt;span
class=&quot;math inline&quot;&gt;\((10,8)\)&lt;/span&gt; and we recognize &lt;span
class=&quot;math inline&quot;&gt;\(p_{320}\)&lt;/span&gt;, &lt;span
class=&quot;math inline&quot;&gt;\(p_{321}\)&lt;/span&gt; and &lt;span
class=&quot;math inline&quot;&gt;\(p_{322}\)&lt;/span&gt; as the transition
probabilities.&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb19&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb19-1&quot;&gt;&lt;a href=&quot;#cb19-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;x0 &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; states&lt;span class=&quot;sc&quot;&gt;$&lt;/span&gt;state &lt;span class=&quot;sc&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;sprintf&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;quot;%2d-%2d&amp;quot;&lt;/span&gt;,A,D) &lt;span class=&quot;co&quot;&gt;# &amp;quot;10-10&amp;quot;&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb19-2&quot;&gt;&lt;a href=&quot;#cb19-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;x1 &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;t&lt;/span&gt;(x0) &lt;span class=&quot;sc&quot;&gt;%*%&lt;/span&gt; P&lt;/span&gt;
&lt;span id=&quot;cb19-3&quot;&gt;&lt;a href=&quot;#cb19-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;x1[,x1&lt;span class=&quot;sc&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;0&lt;/span&gt;]&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;##     08-10     09-09     10-08 
## 0.2925669 0.3357767 0.3716564&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Subsequent battles are implemented as &lt;span
class=&quot;math inline&quot;&gt;\(\mathbf{x}_{i+1} = \mathbf{x}_{i}^\top
\mathbf{P}\)&lt;/span&gt;. For each single battle, the total number of armies
will decrease by at least 1 army (and most likely 2). Starting with
&lt;span class=&quot;math inline&quot;&gt;\(A+D\)&lt;/span&gt; armies means that after &lt;span
class=&quot;math inline&quot;&gt;\(A+D\)&lt;/span&gt; battles we are guaranteed to have
reached an absorbing state&lt;a href=&quot;#fn2&quot; class=&quot;footnote-ref&quot;
id=&quot;fnref2&quot; role=&quot;doc-noteref&quot;&gt;&lt;sup&gt;2&lt;/sup&gt;&lt;/a&gt;. Considering &lt;span
class=&quot;math display&quot;&gt;\[
\mathbf{x}_{A+D} = \mathbf{x}_{0}^\top \mathbf{P}^{A+D} =
\mathbf{x}_{0}^\top \underbrace{\mathbf{P} \cdots
\mathbf{P}}_{\text{$A+D$ times}}
\]&lt;/span&gt; we compute&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb21&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb21-1&quot;&gt;&lt;a href=&quot;#cb21-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;x_AD &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;t&lt;/span&gt;(x0) &lt;span class=&quot;sc&quot;&gt;%*%&lt;/span&gt; (P &lt;span class=&quot;sc&quot;&gt;%^%&lt;/span&gt; (A&lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt;D))&lt;/span&gt;
&lt;span id=&quot;cb21-2&quot;&gt;&lt;a href=&quot;#cb21-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;round&lt;/span&gt;(x_AD[,x_AD&lt;span class=&quot;sc&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;0&lt;/span&gt;], &lt;span class=&quot;at&quot;&gt;digits=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;3&lt;/span&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;## 00-01 00-02 00-03 00-04 00-05 00-06 00-07 00-08 00-09 00-10 01-00 02-00 03-00 04-00 05-00 06-00 07-00 08-00 09-00 10-00 
## 0.042 0.081 0.072 0.070 0.056 0.047 0.031 0.021 0.009 0.003 0.030 0.059 0.092 0.096 0.087 0.077 0.059 0.039 0.021 0.007&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Summing up all probabilities where the defender has zero armies gives
us the probability that the attacker wins the battle, i.e.&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb23&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb23-1&quot;&gt;&lt;a href=&quot;#cb23-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;sum&lt;/span&gt;(x_AD[,&lt;span class=&quot;fu&quot;&gt;str_detect&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;colnames&lt;/span&gt;(x_AD), &lt;span class=&quot;st&quot;&gt;&amp;quot;-00&amp;quot;&lt;/span&gt;)])&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;## [1] 0.5675929&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;This probability matches the value 0.568 reported in Table 3 of &lt;span
class=&quot;citation&quot; data-cites=&quot;osborne2003&quot;&gt;Osborne (2003)&lt;/span&gt;. By
calculating &lt;span class=&quot;math inline&quot;&gt;\(\mathbf{P}^{A+D}\)&lt;/span&gt; once,
we can change the initial state vector &lt;span
class=&quot;math inline&quot;&gt;\(\mathbf{x}_0\)&lt;/span&gt; to compute the probability
of the attacker winning for each of the &lt;span class=&quot;math inline&quot;&gt;\(A
\times D\)&lt;/span&gt; possible initial values. The values match those in
Table 3 of &lt;span class=&quot;citation&quot; data-cites=&quot;osborne2003&quot;&gt;Osborne
(2003)&lt;/span&gt;.&lt;/p&gt;
&lt;table class=&quot;table table-striped&quot; style=&quot;margin-left: auto; margin-right: auto;&quot;&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th style=&quot;empty-cells: hide;border-bottom:hidden;&quot; colspan=&quot;1&quot;&gt;
&lt;/th&gt;
&lt;th style=&quot;border-bottom:hidden;padding-bottom:0; padding-left:3px;padding-right:3px;text-align: center; &quot; colspan=&quot;10&quot;&gt;
&lt;div style=&quot;border-bottom: 1px solid #ddd; padding-bottom: 5px; &quot;&gt;
D
&lt;/div&gt;
&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;th style=&quot;text-align:center;&quot;&gt;
A
&lt;/th&gt;
&lt;th style=&quot;text-align:center;&quot;&gt;
1
&lt;/th&gt;
&lt;th style=&quot;text-align:center;&quot;&gt;
2
&lt;/th&gt;
&lt;th style=&quot;text-align:center;&quot;&gt;
3
&lt;/th&gt;
&lt;th style=&quot;text-align:center;&quot;&gt;
4
&lt;/th&gt;
&lt;th style=&quot;text-align:center;&quot;&gt;
5
&lt;/th&gt;
&lt;th style=&quot;text-align:center;&quot;&gt;
6
&lt;/th&gt;
&lt;th style=&quot;text-align:center;&quot;&gt;
7
&lt;/th&gt;
&lt;th style=&quot;text-align:center;&quot;&gt;
8
&lt;/th&gt;
&lt;th style=&quot;text-align:center;&quot;&gt;
9
&lt;/th&gt;
&lt;th style=&quot;text-align:center;&quot;&gt;
10
&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:center;width: 1cm; border-right:1px solid;&quot;&gt;
1
&lt;/td&gt;
&lt;td style=&quot;text-align:center;width: 3cm; &quot;&gt;
&lt;span
style=&quot;     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;&quot;&gt;0.417&lt;/span&gt;
&lt;/td&gt;
&lt;td style=&quot;text-align:center;width: 3cm; &quot;&gt;
&lt;span
style=&quot;     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;&quot;&gt;0.106&lt;/span&gt;
&lt;/td&gt;
&lt;td style=&quot;text-align:center;width: 3cm; &quot;&gt;
&lt;span
style=&quot;     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;&quot;&gt;0.027&lt;/span&gt;
&lt;/td&gt;
&lt;td style=&quot;text-align:center;width: 3cm; &quot;&gt;
&lt;span
style=&quot;     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;&quot;&gt;0.007&lt;/span&gt;
&lt;/td&gt;
&lt;td style=&quot;text-align:center;width: 3cm; &quot;&gt;
&lt;span
style=&quot;     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;&quot;&gt;0.002&lt;/span&gt;
&lt;/td&gt;
&lt;td style=&quot;text-align:center;width: 3cm; &quot;&gt;
&lt;span
style=&quot;     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;&quot;&gt;0.000&lt;/span&gt;
&lt;/td&gt;
&lt;td style=&quot;text-align:center;width: 3cm; &quot;&gt;
&lt;span
style=&quot;     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;&quot;&gt;0.000&lt;/span&gt;
&lt;/td&gt;
&lt;td style=&quot;text-align:center;width: 3cm; &quot;&gt;
&lt;span
style=&quot;     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;&quot;&gt;0.000&lt;/span&gt;
&lt;/td&gt;
&lt;td style=&quot;text-align:center;width: 3cm; &quot;&gt;
&lt;span
style=&quot;     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;&quot;&gt;0.000&lt;/span&gt;
&lt;/td&gt;
&lt;td style=&quot;text-align:center;width: 3cm; &quot;&gt;
&lt;span
style=&quot;     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;&quot;&gt;0.000&lt;/span&gt;
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:center;width: 1cm; border-right:1px solid;&quot;&gt;
2
&lt;/td&gt;
&lt;td style=&quot;text-align:center;width: 3cm; &quot;&gt;
&lt;span
style=&quot;     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: lightgreen !important;&quot;&gt;0.754&lt;/span&gt;
&lt;/td&gt;
&lt;td style=&quot;text-align:center;width: 3cm; &quot;&gt;
&lt;span
style=&quot;     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;&quot;&gt;0.363&lt;/span&gt;
&lt;/td&gt;
&lt;td style=&quot;text-align:center;width: 3cm; &quot;&gt;
&lt;span
style=&quot;     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;&quot;&gt;0.206&lt;/span&gt;
&lt;/td&gt;
&lt;td style=&quot;text-align:center;width: 3cm; &quot;&gt;
&lt;span
style=&quot;     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;&quot;&gt;0.091&lt;/span&gt;
&lt;/td&gt;
&lt;td style=&quot;text-align:center;width: 3cm; &quot;&gt;
&lt;span
style=&quot;     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;&quot;&gt;0.049&lt;/span&gt;
&lt;/td&gt;
&lt;td style=&quot;text-align:center;width: 3cm; &quot;&gt;
&lt;span
style=&quot;     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;&quot;&gt;0.021&lt;/span&gt;
&lt;/td&gt;
&lt;td style=&quot;text-align:center;width: 3cm; &quot;&gt;
&lt;span
style=&quot;     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;&quot;&gt;0.011&lt;/span&gt;
&lt;/td&gt;
&lt;td style=&quot;text-align:center;width: 3cm; &quot;&gt;
&lt;span
style=&quot;     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;&quot;&gt;0.005&lt;/span&gt;
&lt;/td&gt;
&lt;td style=&quot;text-align:center;width: 3cm; &quot;&gt;
&lt;span
style=&quot;     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;&quot;&gt;0.003&lt;/span&gt;
&lt;/td&gt;
&lt;td style=&quot;text-align:center;width: 3cm; &quot;&gt;
&lt;span
style=&quot;     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;&quot;&gt;0.001&lt;/span&gt;
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:center;width: 1cm; border-right:1px solid;&quot;&gt;
3
&lt;/td&gt;
&lt;td style=&quot;text-align:center;width: 3cm; &quot;&gt;
&lt;span
style=&quot;     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: lightgreen !important;&quot;&gt;0.916&lt;/span&gt;
&lt;/td&gt;
&lt;td style=&quot;text-align:center;width: 3cm; &quot;&gt;
&lt;span
style=&quot;     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: lightgreen !important;&quot;&gt;0.656&lt;/span&gt;
&lt;/td&gt;
&lt;td style=&quot;text-align:center;width: 3cm; &quot;&gt;
&lt;span
style=&quot;     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;&quot;&gt;0.470&lt;/span&gt;
&lt;/td&gt;
&lt;td style=&quot;text-align:center;width: 3cm; &quot;&gt;
&lt;span
style=&quot;     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;&quot;&gt;0.315&lt;/span&gt;
&lt;/td&gt;
&lt;td style=&quot;text-align:center;width: 3cm; &quot;&gt;
&lt;span
style=&quot;     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;&quot;&gt;0.206&lt;/span&gt;
&lt;/td&gt;
&lt;td style=&quot;text-align:center;width: 3cm; &quot;&gt;
&lt;span
style=&quot;     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;&quot;&gt;0.134&lt;/span&gt;
&lt;/td&gt;
&lt;td style=&quot;text-align:center;width: 3cm; &quot;&gt;
&lt;span
style=&quot;     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;&quot;&gt;0.084&lt;/span&gt;
&lt;/td&gt;
&lt;td style=&quot;text-align:center;width: 3cm; &quot;&gt;
&lt;span
style=&quot;     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;&quot;&gt;0.054&lt;/span&gt;
&lt;/td&gt;
&lt;td style=&quot;text-align:center;width: 3cm; &quot;&gt;
&lt;span
style=&quot;     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;&quot;&gt;0.033&lt;/span&gt;
&lt;/td&gt;
&lt;td style=&quot;text-align:center;width: 3cm; &quot;&gt;
&lt;span
style=&quot;     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;&quot;&gt;0.021&lt;/span&gt;
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:center;width: 1cm; border-right:1px solid;&quot;&gt;
4
&lt;/td&gt;
&lt;td style=&quot;text-align:center;width: 3cm; &quot;&gt;
&lt;span
style=&quot;     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: lightgreen !important;&quot;&gt;0.972&lt;/span&gt;
&lt;/td&gt;
&lt;td style=&quot;text-align:center;width: 3cm; &quot;&gt;
&lt;span
style=&quot;     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: lightgreen !important;&quot;&gt;0.785&lt;/span&gt;
&lt;/td&gt;
&lt;td style=&quot;text-align:center;width: 3cm; &quot;&gt;
&lt;span
style=&quot;     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: lightgreen !important;&quot;&gt;0.642&lt;/span&gt;
&lt;/td&gt;
&lt;td style=&quot;text-align:center;width: 3cm; &quot;&gt;
&lt;span
style=&quot;     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;&quot;&gt;0.477&lt;/span&gt;
&lt;/td&gt;
&lt;td style=&quot;text-align:center;width: 3cm; &quot;&gt;
&lt;span
style=&quot;     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;&quot;&gt;0.359&lt;/span&gt;
&lt;/td&gt;
&lt;td style=&quot;text-align:center;width: 3cm; &quot;&gt;
&lt;span
style=&quot;     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;&quot;&gt;0.253&lt;/span&gt;
&lt;/td&gt;
&lt;td style=&quot;text-align:center;width: 3cm; &quot;&gt;
&lt;span
style=&quot;     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;&quot;&gt;0.181&lt;/span&gt;
&lt;/td&gt;
&lt;td style=&quot;text-align:center;width: 3cm; &quot;&gt;
&lt;span
style=&quot;     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;&quot;&gt;0.123&lt;/span&gt;
&lt;/td&gt;
&lt;td style=&quot;text-align:center;width: 3cm; &quot;&gt;
&lt;span
style=&quot;     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;&quot;&gt;0.086&lt;/span&gt;
&lt;/td&gt;
&lt;td style=&quot;text-align:center;width: 3cm; &quot;&gt;
&lt;span
style=&quot;     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;&quot;&gt;0.057&lt;/span&gt;
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:center;width: 1cm; border-right:1px solid;&quot;&gt;
5
&lt;/td&gt;
&lt;td style=&quot;text-align:center;width: 3cm; &quot;&gt;
&lt;span
style=&quot;     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: lightgreen !important;&quot;&gt;0.990&lt;/span&gt;
&lt;/td&gt;
&lt;td style=&quot;text-align:center;width: 3cm; &quot;&gt;
&lt;span
style=&quot;     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: lightgreen !important;&quot;&gt;0.890&lt;/span&gt;
&lt;/td&gt;
&lt;td style=&quot;text-align:center;width: 3cm; &quot;&gt;
&lt;span
style=&quot;     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: lightgreen !important;&quot;&gt;0.769&lt;/span&gt;
&lt;/td&gt;
&lt;td style=&quot;text-align:center;width: 3cm; &quot;&gt;
&lt;span
style=&quot;     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: lightgreen !important;&quot;&gt;0.638&lt;/span&gt;
&lt;/td&gt;
&lt;td style=&quot;text-align:center;width: 3cm; &quot;&gt;
&lt;span
style=&quot;     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: lightgreen !important;&quot;&gt;0.506&lt;/span&gt;
&lt;/td&gt;
&lt;td style=&quot;text-align:center;width: 3cm; &quot;&gt;
&lt;span
style=&quot;     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;&quot;&gt;0.397&lt;/span&gt;
&lt;/td&gt;
&lt;td style=&quot;text-align:center;width: 3cm; &quot;&gt;
&lt;span
style=&quot;     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;&quot;&gt;0.297&lt;/span&gt;
&lt;/td&gt;
&lt;td style=&quot;text-align:center;width: 3cm; &quot;&gt;
&lt;span
style=&quot;     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;&quot;&gt;0.224&lt;/span&gt;
&lt;/td&gt;
&lt;td style=&quot;text-align:center;width: 3cm; &quot;&gt;
&lt;span
style=&quot;     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;&quot;&gt;0.162&lt;/span&gt;
&lt;/td&gt;
&lt;td style=&quot;text-align:center;width: 3cm; &quot;&gt;
&lt;span
style=&quot;     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;&quot;&gt;0.118&lt;/span&gt;
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:center;width: 1cm; border-right:1px solid;&quot;&gt;
6
&lt;/td&gt;
&lt;td style=&quot;text-align:center;width: 3cm; &quot;&gt;
&lt;span
style=&quot;     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: lightgreen !important;&quot;&gt;0.997&lt;/span&gt;
&lt;/td&gt;
&lt;td style=&quot;text-align:center;width: 3cm; &quot;&gt;
&lt;span
style=&quot;     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: lightgreen !important;&quot;&gt;0.934&lt;/span&gt;
&lt;/td&gt;
&lt;td style=&quot;text-align:center;width: 3cm; &quot;&gt;
&lt;span
style=&quot;     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: lightgreen !important;&quot;&gt;0.857&lt;/span&gt;
&lt;/td&gt;
&lt;td style=&quot;text-align:center;width: 3cm; &quot;&gt;
&lt;span
style=&quot;     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: lightgreen !important;&quot;&gt;0.745&lt;/span&gt;
&lt;/td&gt;
&lt;td style=&quot;text-align:center;width: 3cm; &quot;&gt;
&lt;span
style=&quot;     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: lightgreen !important;&quot;&gt;0.638&lt;/span&gt;
&lt;/td&gt;
&lt;td style=&quot;text-align:center;width: 3cm; &quot;&gt;
&lt;span
style=&quot;     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: lightgreen !important;&quot;&gt;0.521&lt;/span&gt;
&lt;/td&gt;
&lt;td style=&quot;text-align:center;width: 3cm; &quot;&gt;
&lt;span
style=&quot;     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;&quot;&gt;0.423&lt;/span&gt;
&lt;/td&gt;
&lt;td style=&quot;text-align:center;width: 3cm; &quot;&gt;
&lt;span
style=&quot;     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;&quot;&gt;0.329&lt;/span&gt;
&lt;/td&gt;
&lt;td style=&quot;text-align:center;width: 3cm; &quot;&gt;
&lt;span
style=&quot;     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;&quot;&gt;0.258&lt;/span&gt;
&lt;/td&gt;
&lt;td style=&quot;text-align:center;width: 3cm; &quot;&gt;
&lt;span
style=&quot;     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;&quot;&gt;0.193&lt;/span&gt;
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:center;width: 1cm; border-right:1px solid;&quot;&gt;
7
&lt;/td&gt;
&lt;td style=&quot;text-align:center;width: 3cm; &quot;&gt;
&lt;span
style=&quot;     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: lightgreen !important;&quot;&gt;0.999&lt;/span&gt;
&lt;/td&gt;
&lt;td style=&quot;text-align:center;width: 3cm; &quot;&gt;
&lt;span
style=&quot;     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: lightgreen !important;&quot;&gt;0.967&lt;/span&gt;
&lt;/td&gt;
&lt;td style=&quot;text-align:center;width: 3cm; &quot;&gt;
&lt;span
style=&quot;     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: lightgreen !important;&quot;&gt;0.910&lt;/span&gt;
&lt;/td&gt;
&lt;td style=&quot;text-align:center;width: 3cm; &quot;&gt;
&lt;span
style=&quot;     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: lightgreen !important;&quot;&gt;0.834&lt;/span&gt;
&lt;/td&gt;
&lt;td style=&quot;text-align:center;width: 3cm; &quot;&gt;
&lt;span
style=&quot;     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: lightgreen !important;&quot;&gt;0.736&lt;/span&gt;
&lt;/td&gt;
&lt;td style=&quot;text-align:center;width: 3cm; &quot;&gt;
&lt;span
style=&quot;     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: lightgreen !important;&quot;&gt;0.640&lt;/span&gt;
&lt;/td&gt;
&lt;td style=&quot;text-align:center;width: 3cm; &quot;&gt;
&lt;span
style=&quot;     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: lightgreen !important;&quot;&gt;0.536&lt;/span&gt;
&lt;/td&gt;
&lt;td style=&quot;text-align:center;width: 3cm; &quot;&gt;
&lt;span
style=&quot;     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;&quot;&gt;0.446&lt;/span&gt;
&lt;/td&gt;
&lt;td style=&quot;text-align:center;width: 3cm; &quot;&gt;
&lt;span
style=&quot;     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;&quot;&gt;0.357&lt;/span&gt;
&lt;/td&gt;
&lt;td style=&quot;text-align:center;width: 3cm; &quot;&gt;
&lt;span
style=&quot;     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;&quot;&gt;0.287&lt;/span&gt;
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:center;width: 1cm; border-right:1px solid;&quot;&gt;
8
&lt;/td&gt;
&lt;td style=&quot;text-align:center;width: 3cm; &quot;&gt;
&lt;span
style=&quot;     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: lightgreen !important;&quot;&gt;1.000&lt;/span&gt;
&lt;/td&gt;
&lt;td style=&quot;text-align:center;width: 3cm; &quot;&gt;
&lt;span
style=&quot;     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: lightgreen !important;&quot;&gt;0.980&lt;/span&gt;
&lt;/td&gt;
&lt;td style=&quot;text-align:center;width: 3cm; &quot;&gt;
&lt;span
style=&quot;     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: lightgreen !important;&quot;&gt;0.947&lt;/span&gt;
&lt;/td&gt;
&lt;td style=&quot;text-align:center;width: 3cm; &quot;&gt;
&lt;span
style=&quot;     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: lightgreen !important;&quot;&gt;0.888&lt;/span&gt;
&lt;/td&gt;
&lt;td style=&quot;text-align:center;width: 3cm; &quot;&gt;
&lt;span
style=&quot;     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: lightgreen !important;&quot;&gt;0.818&lt;/span&gt;
&lt;/td&gt;
&lt;td style=&quot;text-align:center;width: 3cm; &quot;&gt;
&lt;span
style=&quot;     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: lightgreen !important;&quot;&gt;0.730&lt;/span&gt;
&lt;/td&gt;
&lt;td style=&quot;text-align:center;width: 3cm; &quot;&gt;
&lt;span
style=&quot;     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: lightgreen !important;&quot;&gt;0.643&lt;/span&gt;
&lt;/td&gt;
&lt;td style=&quot;text-align:center;width: 3cm; &quot;&gt;
&lt;span
style=&quot;     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: lightgreen !important;&quot;&gt;0.547&lt;/span&gt;
&lt;/td&gt;
&lt;td style=&quot;text-align:center;width: 3cm; &quot;&gt;
&lt;span
style=&quot;     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;&quot;&gt;0.464&lt;/span&gt;
&lt;/td&gt;
&lt;td style=&quot;text-align:center;width: 3cm; &quot;&gt;
&lt;span
style=&quot;     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;&quot;&gt;0.380&lt;/span&gt;
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:center;width: 1cm; border-right:1px solid;&quot;&gt;
9
&lt;/td&gt;
&lt;td style=&quot;text-align:center;width: 3cm; &quot;&gt;
&lt;span
style=&quot;     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: lightgreen !important;&quot;&gt;1.000&lt;/span&gt;
&lt;/td&gt;
&lt;td style=&quot;text-align:center;width: 3cm; &quot;&gt;
&lt;span
style=&quot;     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: lightgreen !important;&quot;&gt;0.990&lt;/span&gt;
&lt;/td&gt;
&lt;td style=&quot;text-align:center;width: 3cm; &quot;&gt;
&lt;span
style=&quot;     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: lightgreen !important;&quot;&gt;0.967&lt;/span&gt;
&lt;/td&gt;
&lt;td style=&quot;text-align:center;width: 3cm; &quot;&gt;
&lt;span
style=&quot;     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: lightgreen !important;&quot;&gt;0.930&lt;/span&gt;
&lt;/td&gt;
&lt;td style=&quot;text-align:center;width: 3cm; &quot;&gt;
&lt;span
style=&quot;     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: lightgreen !important;&quot;&gt;0.873&lt;/span&gt;
&lt;/td&gt;
&lt;td style=&quot;text-align:center;width: 3cm; &quot;&gt;
&lt;span
style=&quot;     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: lightgreen !important;&quot;&gt;0.808&lt;/span&gt;
&lt;/td&gt;
&lt;td style=&quot;text-align:center;width: 3cm; &quot;&gt;
&lt;span
style=&quot;     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: lightgreen !important;&quot;&gt;0.726&lt;/span&gt;
&lt;/td&gt;
&lt;td style=&quot;text-align:center;width: 3cm; &quot;&gt;
&lt;span
style=&quot;     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: lightgreen !important;&quot;&gt;0.646&lt;/span&gt;
&lt;/td&gt;
&lt;td style=&quot;text-align:center;width: 3cm; &quot;&gt;
&lt;span
style=&quot;     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: lightgreen !important;&quot;&gt;0.558&lt;/span&gt;
&lt;/td&gt;
&lt;td style=&quot;text-align:center;width: 3cm; &quot;&gt;
&lt;span
style=&quot;     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;&quot;&gt;0.480&lt;/span&gt;
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:center;width: 1cm; border-right:1px solid;&quot;&gt;
10
&lt;/td&gt;
&lt;td style=&quot;text-align:center;width: 3cm; &quot;&gt;
&lt;span
style=&quot;     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: lightgreen !important;&quot;&gt;1.000&lt;/span&gt;
&lt;/td&gt;
&lt;td style=&quot;text-align:center;width: 3cm; &quot;&gt;
&lt;span
style=&quot;     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: lightgreen !important;&quot;&gt;0.994&lt;/span&gt;
&lt;/td&gt;
&lt;td style=&quot;text-align:center;width: 3cm; &quot;&gt;
&lt;span
style=&quot;     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: lightgreen !important;&quot;&gt;0.981&lt;/span&gt;
&lt;/td&gt;
&lt;td style=&quot;text-align:center;width: 3cm; &quot;&gt;
&lt;span
style=&quot;     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: lightgreen !important;&quot;&gt;0.954&lt;/span&gt;
&lt;/td&gt;
&lt;td style=&quot;text-align:center;width: 3cm; &quot;&gt;
&lt;span
style=&quot;     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: lightgreen !important;&quot;&gt;0.916&lt;/span&gt;
&lt;/td&gt;
&lt;td style=&quot;text-align:center;width: 3cm; &quot;&gt;
&lt;span
style=&quot;     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: lightgreen !important;&quot;&gt;0.861&lt;/span&gt;
&lt;/td&gt;
&lt;td style=&quot;text-align:center;width: 3cm; &quot;&gt;
&lt;span
style=&quot;     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: lightgreen !important;&quot;&gt;0.800&lt;/span&gt;
&lt;/td&gt;
&lt;td style=&quot;text-align:center;width: 3cm; &quot;&gt;
&lt;span
style=&quot;     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: lightgreen !important;&quot;&gt;0.724&lt;/span&gt;
&lt;/td&gt;
&lt;td style=&quot;text-align:center;width: 3cm; &quot;&gt;
&lt;span
style=&quot;     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: lightgreen !important;&quot;&gt;0.650&lt;/span&gt;
&lt;/td&gt;
&lt;td style=&quot;text-align:center;width: 3cm; &quot;&gt;
&lt;span
style=&quot;     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: lightgreen !important;&quot;&gt;0.568&lt;/span&gt;
&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;
&lt;p&gt;All cells with a probability greater than 0.5 are colored green in
the table. We observe that from 5 and beyond the attacker has a slight
advantage when &lt;span class=&quot;math inline&quot;&gt;\(A=D\)&lt;/span&gt;.&lt;/p&gt;
&lt;p&gt;Below, the situation for &lt;span class=&quot;math inline&quot;&gt;\(A,D\)&lt;/span&gt; up
to 50 is illustrated a little differently: for any given value of &lt;span
class=&quot;math inline&quot;&gt;\(D\)&lt;/span&gt;, the image shows in green all values of
&lt;span class=&quot;math inline&quot;&gt;\(A\)&lt;/span&gt;, where the probability for the
attacker to win is above 50%.&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/blog/figure/source/2025-02-21-risk/BIGTABLE_PLOT-1.png&quot; style=&quot;display: block; margin: auto;&quot; /&gt;&lt;/p&gt;
&lt;p&gt;Looking at the smallest &lt;span class=&quot;math inline&quot;&gt;\(A\)&lt;/span&gt; with a
win probability of more than 50% for a given &lt;span
class=&quot;math inline&quot;&gt;\(D\)&lt;/span&gt;, we see that this line is below the
&lt;span class=&quot;math inline&quot;&gt;\(A=D\)&lt;/span&gt; line. This shows that the
attacker has a slight advantage. Furthermore, the smallest such &lt;span
class=&quot;math inline&quot;&gt;\(A\)&lt;/span&gt; can be found approximately as &lt;span
class=&quot;math inline&quot;&gt;\(A_{\min} \approx 1.2204 + 0.8525\cdot
D\)&lt;/span&gt;.&lt;/p&gt;
&lt;h2 id=&quot;discussion&quot;&gt;Discussion&lt;/h2&gt;
&lt;p&gt;Counting is a powerful technique in combinatorics and dice-based
probabilities. The counting can be implemented on a computer by
representing the full sample space using tables or arrays. The risk of
making mistakes when counting in such structures is often lower than in
more involved probability calculations, e.g. order statistics or
conditional distributions. However, in many combinatorical problems the
state space quickly exceeds manageable sizes. Monte Carlo simulation
offers a quick alternative for verifying probability calculations, and
is effective even in untractably large state spaces.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;TLDR&lt;/strong&gt;: For situations where &lt;span
class=&quot;math inline&quot;&gt;\(A \geq 5\)&lt;/span&gt;, attack if &lt;span
class=&quot;math inline&quot;&gt;\(A \geq 1.2204 + 0.8525\cdot D\)&lt;/span&gt;.&lt;/p&gt;
&lt;h2 id=&quot;appendix-1-monte-carlo-simulation&quot;&gt;Appendix 1: Monte Carlo
Simulation&lt;/h2&gt;
&lt;p&gt;Just for completeness: Below is a simulation function for determining
the &lt;span class=&quot;math inline&quot;&gt;\(p_{adk}\)&lt;/span&gt; probabilities by Monte
Carlo simulation. It requires little thinking, is fast and accurate
enough to spot the errors in the &lt;span class=&quot;citation&quot;
data-cites=&quot;tan1997&quot;&gt;Tan (1997)&lt;/span&gt; paper:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb25&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb25-1&quot;&gt;&lt;a href=&quot;#cb25-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;# Simulate a single a vs. d army battle&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb25-2&quot;&gt;&lt;a href=&quot;#cb25-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;single_battle &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;cf&quot;&gt;function&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;a =&lt;/span&gt; &lt;span class=&quot;dv&quot;&gt;3&lt;/span&gt;, &lt;span class=&quot;at&quot;&gt;d =&lt;/span&gt; &lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;) {&lt;/span&gt;
&lt;span id=&quot;cb25-3&quot;&gt;&lt;a href=&quot;#cb25-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;co&quot;&gt;# Sort the dice&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb25-4&quot;&gt;&lt;a href=&quot;#cb25-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  y_sorted &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;sort&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;sample&lt;/span&gt;(Omega, &lt;span class=&quot;at&quot;&gt;size =&lt;/span&gt; a, &lt;span class=&quot;at&quot;&gt;replace =&lt;/span&gt; &lt;span class=&quot;cn&quot;&gt;TRUE&lt;/span&gt;), &lt;span class=&quot;at&quot;&gt;dec =&lt;/span&gt; &lt;span class=&quot;cn&quot;&gt;TRUE&lt;/span&gt;)&lt;/span&gt;
&lt;span id=&quot;cb25-5&quot;&gt;&lt;a href=&quot;#cb25-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  z_sorted &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;sort&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;sample&lt;/span&gt;(Omega, &lt;span class=&quot;at&quot;&gt;size =&lt;/span&gt; d, &lt;span class=&quot;at&quot;&gt;replace =&lt;/span&gt; &lt;span class=&quot;cn&quot;&gt;TRUE&lt;/span&gt;), &lt;span class=&quot;at&quot;&gt;dec =&lt;/span&gt; &lt;span class=&quot;cn&quot;&gt;TRUE&lt;/span&gt;)&lt;/span&gt;
&lt;span id=&quot;cb25-6&quot;&gt;&lt;a href=&quot;#cb25-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb25-7&quot;&gt;&lt;a href=&quot;#cb25-7&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;co&quot;&gt;# Number of comparisons&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb25-8&quot;&gt;&lt;a href=&quot;#cb25-8&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  nCompares &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;min&lt;/span&gt;(a, d)&lt;/span&gt;
&lt;span id=&quot;cb25-9&quot;&gt;&lt;a href=&quot;#cb25-9&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb25-10&quot;&gt;&lt;a href=&quot;#cb25-10&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;co&quot;&gt;# For each position to compare, see if defender looses an army.&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb25-11&quot;&gt;&lt;a href=&quot;#cb25-11&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  lose_D &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; (y_sorted[&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;:&lt;/span&gt;nCompares] &lt;span class=&quot;sc&quot;&gt;&amp;gt;&lt;/span&gt; z_sorted[&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;:&lt;/span&gt;nCompares])&lt;/span&gt;
&lt;span id=&quot;cb25-12&quot;&gt;&lt;a href=&quot;#cb25-12&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb25-13&quot;&gt;&lt;a href=&quot;#cb25-13&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;return&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;sum&lt;/span&gt;(lose_D))&lt;/span&gt;
&lt;span id=&quot;cb25-14&quot;&gt;&lt;a href=&quot;#cb25-14&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;}&lt;/span&gt;
&lt;span id=&quot;cb25-15&quot;&gt;&lt;a href=&quot;#cb25-15&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb25-16&quot;&gt;&lt;a href=&quot;#cb25-16&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;# Calc p_{32k}, k=0,1,2&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb25-17&quot;&gt;&lt;a href=&quot;#cb25-17&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;prop.table&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;table&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;replicate&lt;/span&gt;(&lt;span class=&quot;fl&quot;&gt;1e5&lt;/span&gt;, &lt;span class=&quot;fu&quot;&gt;single_battle&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;a=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;3&lt;/span&gt;, &lt;span class=&quot;at&quot;&gt;d=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;))))&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;## 
##       0       1       2 
## 0.29136 0.33852 0.37012&lt;/code&gt;&lt;/pre&gt;
&lt;h2 id=&quot;appendix-2&quot;&gt;Appendix 2&lt;/h2&gt;
&lt;p&gt;&lt;span class=&quot;citation&quot; data-cites=&quot;tan1997&quot;&gt;Tan (1997)&lt;/span&gt;
calculated for example &lt;span class=&quot;math display&quot;&gt;\[\begin{align*}
\pi_{322}
&amp;amp;= P(Y_{(1)}&amp;gt;Z_{(1)} \cap Y_{(2)}&amp;gt;Z_{(2)}) \\
&amp;amp;= P(Y_{(1)}&amp;gt;Z_{(1)}) P(Y_{(2)}&amp;gt;Z_{(2)}) \\
&amp;amp;= \cdots,
\end{align*}\]&lt;/span&gt; but the 2nd step is wrong, because it assumes
independence of the events &lt;span
class=&quot;math inline&quot;&gt;\(Y_{(1)}&amp;gt;Z_{(1)}\)&lt;/span&gt; and &lt;span
class=&quot;math inline&quot;&gt;\(Y_{(2)}&amp;gt;Z_{(2)}\)&lt;/span&gt;. This is not the case,
as seen from the following R output:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb27&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb27-1&quot;&gt;&lt;a href=&quot;#cb27-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;# Joint distribution of the two events&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb27-2&quot;&gt;&lt;a href=&quot;#cb27-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;f_Y12Z12 &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;joint_combos_sorted&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;a=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;3&lt;/span&gt;, &lt;span class=&quot;at&quot;&gt;d=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;/span&gt;
&lt;span id=&quot;cb27-3&quot;&gt;&lt;a href=&quot;#cb27-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;mutate&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;at&quot;&gt;y_{(1)}&amp;gt;z_{(1)}&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;ot&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;at&quot;&gt;y_{(1)}&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;st&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;at&quot;&gt;z_{(1)}&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;`&lt;/span&gt;,&lt;/span&gt;
&lt;span id=&quot;cb27-4&quot;&gt;&lt;a href=&quot;#cb27-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;         &lt;span class=&quot;st&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;at&quot;&gt;y_{(2)}&amp;gt;z_{(2)}&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;ot&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;at&quot;&gt;y_{(2)}&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;st&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;at&quot;&gt;z_{(2)}&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;`&lt;/span&gt;) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;/span&gt;
&lt;span id=&quot;cb27-5&quot;&gt;&lt;a href=&quot;#cb27-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;group_by&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;at&quot;&gt;y_{(1)}&amp;gt;z_{(1)}&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;`&lt;/span&gt;,&lt;span class=&quot;st&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;at&quot;&gt;y_{(2)}&amp;gt;z_{(2)}&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;`&lt;/span&gt;) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;/span&gt;
&lt;span id=&quot;cb27-6&quot;&gt;&lt;a href=&quot;#cb27-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;summarise&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;prob=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;sum&lt;/span&gt;(prob), &lt;span class=&quot;at&quot;&gt;.groups =&lt;/span&gt; &lt;span class=&quot;st&quot;&gt;&amp;quot;keep&amp;quot;&lt;/span&gt;)&lt;/span&gt;
&lt;span id=&quot;cb27-7&quot;&gt;&lt;a href=&quot;#cb27-7&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb27-8&quot;&gt;&lt;a href=&quot;#cb27-8&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;# Marginal distribution of each event&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb27-9&quot;&gt;&lt;a href=&quot;#cb27-9&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;f_Y1Z1 &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; f_Y12Z12 &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;group_by&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;at&quot;&gt;y_{(1)}&amp;gt;z_{(1)}&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;`&lt;/span&gt;) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;summarise&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;prob=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;sum&lt;/span&gt;(prob))&lt;/span&gt;
&lt;span id=&quot;cb27-10&quot;&gt;&lt;a href=&quot;#cb27-10&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;f_Y2Z2 &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; f_Y12Z12 &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;group_by&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;at&quot;&gt;y_{(2)}&amp;gt;z_{(2)}&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;`&lt;/span&gt;) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;summarise&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;prob=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;sum&lt;/span&gt;(prob))&lt;/span&gt;
&lt;span id=&quot;cb27-11&quot;&gt;&lt;a href=&quot;#cb27-11&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb27-12&quot;&gt;&lt;a href=&quot;#cb27-12&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;# Joint prob when **assuming independence**&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb27-13&quot;&gt;&lt;a href=&quot;#cb27-13&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;f_Y12Z12_indep &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;cross_join&lt;/span&gt;(f_Y1Z1, f_Y2Z2) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;/span&gt;
&lt;span id=&quot;cb27-14&quot;&gt;&lt;a href=&quot;#cb27-14&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;mutate&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;prob_indep =&lt;/span&gt; prob.x &lt;span class=&quot;sc&quot;&gt;*&lt;/span&gt; prob.y) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;/span&gt;
&lt;span id=&quot;cb27-15&quot;&gt;&lt;a href=&quot;#cb27-15&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;select&lt;/span&gt;(&lt;span class=&quot;sc&quot;&gt;-&lt;/span&gt;prob.x,&lt;span class=&quot;sc&quot;&gt;-&lt;/span&gt;prob.y)&lt;/span&gt;
&lt;span id=&quot;cb27-16&quot;&gt;&lt;a href=&quot;#cb27-16&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb27-17&quot;&gt;&lt;a href=&quot;#cb27-17&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;# Compare to the true joint distribution: this is definitely not the same!&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb27-18&quot;&gt;&lt;a href=&quot;#cb27-18&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;inner_join&lt;/span&gt;(f_Y12Z12, f_Y12Z12_indep, &lt;span class=&quot;at&quot;&gt;by=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;c&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;quot;y_{(1)}&amp;gt;z_{(1)}&amp;quot;&lt;/span&gt;, &lt;span class=&quot;st&quot;&gt;&amp;quot;y_{(2)}&amp;gt;z_{(2)}&amp;quot;&lt;/span&gt;))&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;## # A tibble: 4 × 4
## # Groups:   y_{(1)}&amp;gt;z_{(1)}, y_{(2)}&amp;gt;z_{(2)} [4]
##   `y_{(1)}&amp;gt;z_{(1)}` `y_{(2)}&amp;gt;z_{(2)}`   prob prob_indep
##   &amp;lt;lgl&amp;gt;             &amp;lt;lgl&amp;gt;              &amp;lt;dbl&amp;gt;      &amp;lt;dbl&amp;gt;
## 1 FALSE             FALSE             0.293       0.207
## 2 FALSE             TRUE              0.236       0.321
## 3 TRUE              FALSE             0.0999      0.185
## 4 TRUE              TRUE              0.372       0.286&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;From the above output we notice that the correct joint distribution&lt;a
href=&quot;#fn3&quot; class=&quot;footnote-ref&quot; id=&quot;fnref3&quot;
role=&quot;doc-noteref&quot;&gt;&lt;sup&gt;3&lt;/sup&gt;&lt;/a&gt; of the two events cannot be computed
by simply multiplying the marginals. Hence, the two events are not
independent.&lt;/p&gt;
&lt;p&gt;The reason is that using order statistics induces dependencies. For
example &lt;span class=&quot;math inline&quot;&gt;\(P(Z_{(1)}=z_1, Z_{(2)}=z_2) \neq
P(Z_{(1)}=z_1) P(Z_{(2)}=z_2)\)&lt;/span&gt;. Although the dice &lt;span
class=&quot;math inline&quot;&gt;\(Z_1\)&lt;/span&gt; and &lt;span
class=&quot;math inline&quot;&gt;\(Z_2\)&lt;/span&gt; are independent, the corresponding
variables of the order statistics are dependent: knowing something about
the higher of the two dice gives you information about the lower of the
two. For example if you know that &lt;span
class=&quot;math inline&quot;&gt;\(Z_{(1)}=1\)&lt;/span&gt;, then you know for sure that
&lt;span class=&quot;math inline&quot;&gt;\(Z_{(2)}=1\)&lt;/span&gt;. This dependence extends
to comparisons with the attacker’s dice.&lt;/p&gt;
&lt;h2 class=&quot;unnumbered&quot; id=&quot;literature&quot;&gt;Literature&lt;/h2&gt;
&lt;div id=&quot;refs&quot; class=&quot;references csl-bib-body hanging-indent&quot;
data-entry-spacing=&quot;0&quot; role=&quot;list&quot;&gt;
&lt;div id=&quot;ref-dusautoy2023&quot; class=&quot;csl-entry&quot; role=&quot;listitem&quot;&gt;
du Sautoy, M. 2023. &lt;em&gt;Around the World in 80 Games&lt;/em&gt;. 4th Estate.
&lt;a
href=&quot;https://www.simonyi.ox.ac.uk/books/around-the-world-in-80-games/&quot;&gt;https://www.simonyi.ox.ac.uk/books/around-the-world-in-80-games/&lt;/a&gt;.
&lt;/div&gt;
&lt;div id=&quot;ref-hendel_etal2015&quot; class=&quot;csl-entry&quot; role=&quot;listitem&quot;&gt;
Hendel, S., C. Hoffman, C. Manack, and A. Wagaman. 2015. &lt;span&gt;“Taking
the Risk Out of RISK: Conquer Odds in the Board Game RISK.”&lt;/span&gt; &lt;a
href=&quot;https://arxiv.org/abs/1512.04333&quot;&gt;https://arxiv.org/abs/1512.04333&lt;/a&gt;.
&lt;/div&gt;
&lt;div id=&quot;ref-osborne2003&quot; class=&quot;csl-entry&quot; role=&quot;listitem&quot;&gt;
Osborne, Jason A. 2003. &lt;span&gt;“Markov Chains for the RISK Board Game
Revisited.”&lt;/span&gt; &lt;em&gt;Mathematics Magazine&lt;/em&gt; 76 (2): 129–35. &lt;a
href=&quot;http://www.jstor.org/stable/3219306&quot;&gt;http://www.jstor.org/stable/3219306&lt;/a&gt;.
&lt;/div&gt;
&lt;div id=&quot;ref-pierce_wooster2015&quot; class=&quot;csl-entry&quot; role=&quot;listitem&quot;&gt;
Pierce, P., and R. Wooster. 2015. &lt;span&gt;“Conquer the World with Markov
Chains.”&lt;/span&gt; &lt;em&gt;Math Horizons&lt;/em&gt; 22 (4): pp. 18–21. &lt;a
href=&quot;https://www.jstor.org/stable/10.4169/mathhorizons.22.4.18&quot;&gt;https://www.jstor.org/stable/10.4169/mathhorizons.22.4.18&lt;/a&gt;.
&lt;/div&gt;
&lt;div id=&quot;ref-tan1997&quot; class=&quot;csl-entry&quot; role=&quot;listitem&quot;&gt;
Tan, Bariş. 1997. &lt;span&gt;“Markov Chains and the RISK Board Game.”&lt;/span&gt;
&lt;em&gt;Mathematics Magazine&lt;/em&gt; 70 (5): 349–57. &lt;a
href=&quot;http://www.jstor.org/stable/2691171&quot;&gt;http://www.jstor.org/stable/2691171&lt;/a&gt;.
&lt;/div&gt;
&lt;/div&gt;
&lt;section id=&quot;footnotes&quot; class=&quot;footnotes footnotes-end-of-document&quot;
role=&quot;doc-endnotes&quot;&gt;
&lt;hr /&gt;
&lt;ol&gt;
&lt;li id=&quot;fn1&quot;&gt;&lt;p&gt;Since the rules of Risk only allow attacking with one
army less than hosted in the country the attack originates from, the
attacker would still have one army left once &lt;span
class=&quot;math inline&quot;&gt;\(A=0\)&lt;/span&gt;. Thus, the country is not yet lost
but could be vulnerable to subsequent attacks in future rounds.&lt;a
href=&quot;#fnref1&quot; class=&quot;footnote-back&quot; role=&quot;doc-backlink&quot;&gt;↩︎&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;
&lt;li id=&quot;fn2&quot;&gt;&lt;p&gt;Note: With this argument we take a more direct route
than &lt;span class=&quot;citation&quot; data-cites=&quot;osborne2003&quot;&gt;Osborne
(2003)&lt;/span&gt;, who also arranges the transition matrix notationally into
absorbing and transient states and looks at the steady state
distribution.&lt;a href=&quot;#fnref2&quot; class=&quot;footnote-back&quot;
role=&quot;doc-backlink&quot;&gt;↩︎&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;
&lt;li id=&quot;fn3&quot;&gt;&lt;p&gt;Obtained by counting using the involved
sum-sum-indicator formula from above.&lt;a href=&quot;#fnref3&quot;
class=&quot;footnote-back&quot; role=&quot;doc-backlink&quot;&gt;↩︎&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;/section&gt;
</description>
        <pubDate>Fri, 21 Feb 2025 00:00:00 +0100</pubDate>
        <link>https://mhoehle.github.io/blog/2025/02/21/risk.html</link>
        <guid isPermaLink="true">https://mhoehle.github.io/blog/2025/02/21/risk.html</guid>
        
        <category>rstats</category>
        
        <category>probability</category>
        
        <category>game theory</category>
        
        
      </item>
    
      <item>
        <title>Guess My Name with Decision Trees</title>
        <description>&lt;h2 id=&quot;abstract&quot;&gt;Abstract:&lt;/h2&gt;
&lt;p&gt;We use classification trees to determine the optimal sequence of
questions to ask in the game “Guess my name” (Mini Logix series from
Djeco). Aim of the game is to identify wich person, out of 16 possible,
the opponent is. Clasification trees and optimal sequential decision
making in this case have strong similarities with cross-entropy of the
class distribution working as a common metric for quantifying
information gain.&lt;/p&gt;
&lt;center&gt;
&lt;img src=&quot;/blog/figure/source/2024-02-12-decisiontree/splash.png&quot; /&gt;
&lt;/center&gt;
&lt;p&gt;&lt;br&gt;
&lt;a rel=&quot;license&quot; href=&quot;http://creativecommons.org/licenses/by-sa/4.0/&quot;&gt;&lt;img alt=&quot;Creative Commons License&quot; style=&quot;border-width:0&quot; src=&quot;https://i.creativecommons.org/l/by-sa/4.0/88x31.png&quot;/&gt;&lt;/a&gt;
This work is licensed under a &lt;a rel=&quot;license&quot;
href=&quot;http://creativecommons.org/licenses/by-sa/4.0/&quot;&gt;Creative Commons
Attribution-ShareAlike 4.0 International License&lt;/a&gt;. The &lt;a
href=&quot;https://raw.githubusercontent.com/mhoehle/hoehleatsu.github.io/master/_source/2024-02-12-decisiontree.Rmd&quot;&gt;R-markdown
source code&lt;/a&gt; of this blog is available under a &lt;a
href=&quot;https://www.gnu.org/licenses/gpl-3.0.html&quot;&gt;GNU General Public
License (GPL v3)&lt;/a&gt; license from GitHub.&lt;/p&gt;
&lt;h2 id=&quot;introduction&quot;&gt;Introduction&lt;/h2&gt;
&lt;p&gt;As a mathmatician you do not play logic games for fun, you play to
win. So when playing “Guess my name” (Mini Logix series from Djeco),
where the task is to ask your opponent a series of questions in order to
identify which of 16 picture characters they are, you want to devise an
optimal sequence of questions in order to determine your opponent’s
choice. Given a catalogue of possible questions, we use classification
trees to find the optimal sequence of questions to ask.&lt;/p&gt;
&lt;p&gt;The game goes as follows: Each player gets a card with pictures of 16
persons. Each player selects a person of the 16 she wants to be and
writes the name of this person on their card.&lt;/p&gt;
&lt;p&gt;
&lt;center&gt;
&lt;img
src=&quot;/blog/figure/source/2024-02-12-decisiontree/karte-lowres.jpg&quot; /&gt;
&lt;br&gt; Figure 1: Exemplary game card of the “Guess my name” game, Mini
Logix series, Djeco, during gameplay.
&lt;/center&gt;
&lt;p&gt;
&lt;p&gt;The players then take turns to ask the opponent &lt;i&gt;one&lt;/i&gt; question
about their person, for example you could ask &lt;i&gt;Does your person have
glasses?&lt;/i&gt; or &lt;i&gt;Is your person wearing a chef’s hat?&lt;/i&gt;“. Based on
the answer (possible answers are: yes or no) you sequentially rule out
more and more persons on the card until you are ready to guess who the
other person is. The first player to correctly identify the opponent’s
person wins. Note that only questions about the picture of the person
are allowed. In what follows, we shall assume that a third answer
cateogry”unclear” is also possible, because some questions like &lt;i&gt;does
your person have blonde hair&lt;/i&gt; can not be answered when the hair is
not visible on the picture (see for example the picture of Clovis).&lt;/p&gt;
&lt;p&gt;The aim is now to devise a series of questions whick as quickly as
possible can narrow our set of candidate persons down to 1 person. When
only yes or no answers are possible, in the optimal case, each question
reduces the set of possible persons by a factor 2. Hence, &lt;span
class=&quot;math inline&quot;&gt;\(2^x = 16 \Leftrightarrow x = \log_{2}(16) =
4\)&lt;/span&gt; (well chosen) questions are needed to reduce the set of
candidates from 16 to 1. However, it might not be possible to find a
sequence of such optimal questions, because (given the previous set of
questions) the next question might not split the remaining pool of
candidates in two sets of equal cardinality. As a more hands-on approach
we formulate the task as follows: given a set of questions, where we for
each of the 16 persons know the answer to, which questions and in what
sequence should we ask them in order to correctly identity the
opponent’s person.&lt;/p&gt;
&lt;h2 id=&quot;methods&quot;&gt;Methods&lt;/h2&gt;
&lt;h3 id=&quot;question-catalogue&quot;&gt;Question Catalogue&lt;/h3&gt;
To begin with we develop a set of questions and encode the answer of
each of the 16 persons to the question as yes, no or unclear Below we
show an exemplary question catalogue consisting of 12 together with the
answers for 8 out of the 16 persons (full data for all 16 &lt;a
href=&quot;../../../figure/source/2024-02-12-decisiontree/whatismyname.xlsx&quot;&gt;here&lt;/a&gt;).
One can compare the answers with the picture of the above shown game
card.
&lt;p&gt;
&lt;p&gt;
&lt;hr&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th style=&quot;text-align:left;&quot;&gt;
Question: Does the person
&lt;/th&gt;
&lt;th style=&quot;text-align:center;&quot;&gt;
Gonzague
&lt;/th&gt;
&lt;th style=&quot;text-align:center;&quot;&gt;
Clovis
&lt;/th&gt;
&lt;th style=&quot;text-align:center;&quot;&gt;
Mounir
&lt;/th&gt;
&lt;th style=&quot;text-align:center;&quot;&gt;
Dan
&lt;/th&gt;
&lt;th style=&quot;text-align:center;&quot;&gt;
Barnabé
&lt;/th&gt;
&lt;th style=&quot;text-align:center;&quot;&gt;
Casimir
&lt;/th&gt;
&lt;th style=&quot;text-align:center;&quot;&gt;
Philippe
&lt;/th&gt;
&lt;th style=&quot;text-align:center;&quot;&gt;
Max
&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:left;&quot;&gt;
have a headgear?
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
no
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
yes
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
yes
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
yes
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
no
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
yes
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
yes
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
yes
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:left;&quot;&gt;
have glasses somewhere?
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
yes
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
no
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
no
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
no
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
yes
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
no
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
no
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
no
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:left;&quot;&gt;
have a brush behind the ear?
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
no
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
no
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
no
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
no
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
no
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
no
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
no
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
no
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:left;&quot;&gt;
have blonde hair?
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
yes
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
unclear
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
no
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
no
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
no
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
no
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
yes
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
no
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:left;&quot;&gt;
wear a top with no or short sleeves?
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
no
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
no
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
no
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
no
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
no
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
yes
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
yes
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
no
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:left;&quot;&gt;
have visible eyebrows?
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
yes
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
no
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
yes
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
no
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
yes
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
yes
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
no
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
yes
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:left;&quot;&gt;
picture have something red in it?
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
yes
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
no
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
yes
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
no
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
yes
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
no
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
yes
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
no
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:left;&quot;&gt;
have a top hat on?
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
no
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
no
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
no
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
no
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
no
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
no
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
no
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
no
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:left;&quot;&gt;
picture have something green in it?
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
yes
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
no
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
no
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
no
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
no
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
no
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
no
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
no
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:left;&quot;&gt;
have blue eyes?
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
yes
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
no
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
no
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
no
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
no
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
no
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
yes
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
no
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:left;&quot;&gt;
have a chef’s hat on?
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
no
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
no
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
no
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
yes
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
no
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
no
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
no
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
no
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:left;&quot;&gt;
have a V-collar?
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
no
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
yes
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
no
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
no
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
yes
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
yes
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
no
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
no
&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;hr&gt;
&lt;p&gt;
&lt;p&gt;
&lt;h3 id=&quot;decision-trees-as-classification-trees&quot;&gt;Decision Trees as
Classification Trees&lt;/h3&gt;
&lt;p&gt;We use classification trees to represent the sequence of questions to
ask. Our goal is to correctly identify the person at the end of the
sequence, hence, each leave node should assign the correct person with
100% probability. This is somewhat opposite to traditional
classification trees, which inspired by Occam’s razor are kept small and
thus accept a certain misclassification rate on the training data in
order to generalize well to out-of-sample data.&lt;/p&gt;
&lt;p&gt;We address this tweak by working with saturated trees (i.e. no
pruning). Furthermore, we need to shape the questions s.t. they space of
answers allows for a correct partitioning of all 16 persons. For ease of
exposition we assume that each of the 16 persons is equally likely to be
chosen by your opponent, i.e. the prior probability for each person is
1/16. The appendix “Technical Details” contains information about how
the tree is grown. In R, classification trees can be fitted using the
function &lt;code&gt;rpart::rpart()&lt;/code&gt;. We configure the function such
that a saturated tree is grown, if this possible from the question
catalogue. Since training and test data in our case are identical we
want a tree which fits as good as possible on the training data.&lt;/p&gt;
&lt;h2 id=&quot;results&quot;&gt;Results&lt;/h2&gt;
&lt;p&gt;We transpose the question catalogue in order to bring the data into a
shape with columns being the features and one row per person.&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb1&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb1-1&quot;&gt;&lt;a href=&quot;#cb1-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;# Tranpose data to a tibble allowing a fit&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-2&quot;&gt;&lt;a href=&quot;#cb1-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;persons &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; questions &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;/span&gt;
&lt;span id=&quot;cb1-3&quot;&gt;&lt;a href=&quot;#cb1-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;pivot_longer&lt;/span&gt;(&lt;span class=&quot;sc&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;at&quot;&gt;Question: Does the person&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;`&lt;/span&gt;, &lt;span class=&quot;at&quot;&gt;names_to=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;Person&amp;quot;&lt;/span&gt;) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;/span&gt;
&lt;span id=&quot;cb1-4&quot;&gt;&lt;a href=&quot;#cb1-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;pivot_wider&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;id_cols =&lt;/span&gt; Person, &lt;span class=&quot;at&quot;&gt;names_from=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;at&quot;&gt;Question: Does the person&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;`&lt;/span&gt;,&lt;/span&gt;
&lt;span id=&quot;cb1-5&quot;&gt;&lt;a href=&quot;#cb1-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;                                &lt;span class=&quot;at&quot;&gt;values_from=&lt;/span&gt;value) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;/span&gt;
&lt;span id=&quot;cb1-6&quot;&gt;&lt;a href=&quot;#cb1-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;mutate&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;across&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;everything&lt;/span&gt;(), factor))&lt;/span&gt;
&lt;span id=&quot;cb1-7&quot;&gt;&lt;a href=&quot;#cb1-7&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;head&lt;/span&gt;(persons)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;## # A tibble: 6 × 13
##   Person   `have a headgear?` `have glasses somewhere?` have a brush behind the ea…¹ `have blonde hair?` wear a top with no o…² have visible eyebrow…³
##   &amp;lt;fct&amp;gt;    &amp;lt;fct&amp;gt;              &amp;lt;fct&amp;gt;                     &amp;lt;fct&amp;gt;                        &amp;lt;fct&amp;gt;               &amp;lt;fct&amp;gt;                  &amp;lt;fct&amp;gt;                 
## 1 Gonzague no                 yes                       no                           yes                 no                     yes                   
## 2 Clovis   yes                no                        no                           unclear             no                     no                    
## 3 Mounir   yes                no                        no                           no                  no                     yes                   
## 4 Dan      yes                no                        no                           no                  no                     no                    
## 5 Barnabé  no                 yes                       no                           no                  no                     yes                   
## 6 Casimir  yes                no                        no                           no                  yes                    yes                   
## # ℹ abbreviated names: ¹​`have a brush behind the ear?`, ²​`wear a top with no or short sleeves?`, ³​`have visible eyebrows?`
## # ℹ 6 more variables: `picture have something red in it?` &amp;lt;fct&amp;gt;, `have a top hat on?` &amp;lt;fct&amp;gt;, `picture have something green in it?` &amp;lt;fct&amp;gt;,
## #   `have blue eyes?` &amp;lt;fct&amp;gt;, `have a chef&amp;#39;s hat on?` &amp;lt;fct&amp;gt;, `have a V-collar?` &amp;lt;fct&amp;gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;This format of the data can then be used with
&lt;code&gt;rpart::rpart()&lt;/code&gt;.&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb3&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb3-1&quot;&gt;&lt;a href=&quot;#cb3-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;# Fit tree using rpart&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb3-2&quot;&gt;&lt;a href=&quot;#cb3-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;# Make sure we get a saturated tree&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb3-3&quot;&gt;&lt;a href=&quot;#cb3-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;tree &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;rpart&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;formula =&lt;/span&gt; Person &lt;span class=&quot;sc&quot;&gt;~&lt;/span&gt; ., &lt;span class=&quot;at&quot;&gt;data =&lt;/span&gt; persons, &lt;/span&gt;
&lt;span id=&quot;cb3-4&quot;&gt;&lt;a href=&quot;#cb3-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;              &lt;span class=&quot;at&quot;&gt;method=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;class&amp;quot;&lt;/span&gt;,&lt;/span&gt;
&lt;span id=&quot;cb3-5&quot;&gt;&lt;a href=&quot;#cb3-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;              &lt;span class=&quot;at&quot;&gt;parms=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;list&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;split=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;information&amp;quot;&lt;/span&gt;),&lt;/span&gt;
&lt;span id=&quot;cb3-6&quot;&gt;&lt;a href=&quot;#cb3-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;              &lt;span class=&quot;at&quot;&gt;control=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;rpart.control&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;minbucket=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;0&lt;/span&gt;, &lt;span class=&quot;at&quot;&gt;xval=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;0&lt;/span&gt;, &lt;span class=&quot;at&quot;&gt;cp =&lt;/span&gt; &lt;span class=&quot;sc&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;))&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;The resulting decision tree is illustrated below. We start at the
root node branching left or right depending on whether the answer to the
question: Does the person have have blonde hair? is “no”. If this is the
case we go left, otherwise (i.e. if the answer is “yes” or “unclear”) we
go right. At a leaf node we classify observations to the class indicated
by the round blue node around the name of the person.&lt;/p&gt;
&lt;div class=&quot;figure&quot; style=&quot;text-align: center&quot;&gt;
&lt;img src=&quot;/blog/figure/source/2024-02-12-decisiontree/RPART_SATURATED_TREE_PLOT-1.png&quot; alt=&quot;Figure 2: Decision tree to correctly identify your opponent with 4 questions.&quot;  /&gt;
&lt;p class=&quot;caption&quot;&gt;
Figure 2: Decision tree to correctly identify your opponent with 4
questions.
&lt;/p&gt;
&lt;/div&gt;
&lt;p&gt;We note that the misclassification rate at each terminal leaf is 0,
i.e. if we follow the decision tree we are able to identify the correct
person. Furthermore, the depth of the tree is only 4. Hence, even though
there are 12 questions, the decision trees shows that we can use them in
a clever sequence so that - no matter how the answer is - we correctly
identify the person after 4 questions. Only 9 out of the 12 questions
are used anywhere in the tree.&lt;/p&gt;
&lt;h2 id=&quot;discussion&quot;&gt;Discussion&lt;/h2&gt;
&lt;p&gt;Finding optimal sequences of question for identification has
application beyond winning logic games. One example is fault tree
diagnosis in reliability assessment, where entropy also plays a central
role in the finding minimal cut set &lt;span class=&quot;citation&quot;
data-cites=&quot;Xiaozhong1991&quot;&gt;(Xiaozhong 1991)&lt;/span&gt;. Troubleshooting
complex technical devices, such as printers, in addition to a dianosis
stage can also model the consequence of any repair actions &lt;span
class=&quot;citation&quot; data-cites=&quot;langseth_jensen2003&quot;&gt;(Langseth and Jensen
2003)&lt;/span&gt;.&lt;/p&gt;
&lt;h2 id=&quot;references&quot;&gt;References&lt;/h2&gt;
&lt;div id=&quot;refs&quot; class=&quot;references csl-bib-body hanging-indent&quot;
data-entry-spacing=&quot;0&quot; role=&quot;list&quot;&gt;
&lt;div id=&quot;ref-hastie_etal2017&quot; class=&quot;csl-entry&quot; role=&quot;listitem&quot;&gt;
Hastie, T., R. Tibshirani, and J. Friedman. 2017. &lt;em&gt;The Elements of
Statistical Learning&lt;/em&gt;. 2nd ed. Springer.
&lt;/div&gt;
&lt;div id=&quot;ref-langseth_jensen2003&quot; class=&quot;csl-entry&quot; role=&quot;listitem&quot;&gt;
Langseth, H., and F. V. Jensen. 2003. &lt;span&gt;“Decision Theoretic
Troubleshooting of Coherent Systems.”&lt;/span&gt; &lt;em&gt;Reliability Engineering
&amp;amp; System Safety&lt;/em&gt; 80 (1): 49–62. &lt;a
href=&quot;https://doi.org/10.1016/S0951-8320(02)00202-8&quot;&gt;https://doi.org/10.1016/S0951-8320(02)00202-8&lt;/a&gt;.
&lt;/div&gt;
&lt;div id=&quot;ref-Xiaozhong1991&quot; class=&quot;csl-entry&quot; role=&quot;listitem&quot;&gt;
Xiaozhong, W. 1991. &lt;span&gt;“Fault Tree Diagnosis Based on
&lt;span&gt;S&lt;/span&gt;hannon Entropy.”&lt;/span&gt; &lt;em&gt;Reliability Engineering &amp;amp;
System Safety&lt;/em&gt; 34 (2): 143–67. &lt;a
href=&quot;https://doi.org/10.1016/0951-8320(91)90086-M&quot;&gt;https://doi.org/10.1016/0951-8320(91)90086-M&lt;/a&gt;.
&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;
&lt;h2 id=&quot;appendix-technical-details&quot;&gt;Appendix: Technical Details&lt;/h2&gt;
&lt;p&gt;This section discusses the algorithmic details of how classification
trees are grown. For readers without interest in such technical detail
this section can safely be skipped. More details can be found in for
example &lt;span class=&quot;citation&quot; data-cites=&quot;hastie_etal2017&quot;&gt;Hastie,
Tibshirani, and Friedman (2017)&lt;/span&gt;, Sect 9.2.3.&lt;/p&gt;
&lt;p&gt;The number of possible splits for a categorical node with &lt;span
class=&quot;math inline&quot;&gt;\(M\)&lt;/span&gt; unordered categories is &lt;span
class=&quot;math inline&quot;&gt;\(2^{M-1}-1\)&lt;/span&gt;, i.e. for &lt;span
class=&quot;math inline&quot;&gt;\(M=2\)&lt;/span&gt; features there is only one possible
split, whereas &lt;span class=&quot;math inline&quot;&gt;\(K=3\)&lt;/span&gt; features have 3
possible splits. In our case, questions with &lt;span
class=&quot;math inline&quot;&gt;\(M=2\)&lt;/span&gt; have answers &lt;i&gt;yes&lt;/i&gt; and &lt;i&gt;no&lt;/i&gt;
and thus the split is ({yes}, {no}). When &lt;span
class=&quot;math inline&quot;&gt;\(M=3\)&lt;/span&gt; we have answers &lt;i&gt;yes&lt;/i&gt;, &lt;i&gt;no&lt;/i&gt;
and &lt;i&gt;unclear&lt;/i&gt; and consequently the splits are: ({yes}, {no,
unclear}), ({yes, unclear}, {no}), and ({yes,no},{unclear}). Note that
most questions in the question catalogue have &lt;span
class=&quot;math inline&quot;&gt;\(K=2\)&lt;/span&gt; answers:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb4&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb4-1&quot;&gt;&lt;a href=&quot;#cb4-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;persons &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;summarise&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;across&lt;/span&gt;(&lt;span class=&quot;sc&quot;&gt;-&lt;/span&gt;Person, n_distinct))  &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;/span&gt;
&lt;span id=&quot;cb4-2&quot;&gt;&lt;a href=&quot;#cb4-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;pivot_longer&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;cols=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;everything&lt;/span&gt;(), &lt;span class=&quot;at&quot;&gt;values_to =&lt;/span&gt; &lt;span class=&quot;st&quot;&gt;&amp;quot;M&amp;quot;&lt;/span&gt;) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;/span&gt;
&lt;span id=&quot;cb4-3&quot;&gt;&lt;a href=&quot;#cb4-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;group_by&lt;/span&gt;(M) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;/span&gt;
&lt;span id=&quot;cb4-4&quot;&gt;&lt;a href=&quot;#cb4-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;summarise&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;no_questions=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;n&lt;/span&gt;())&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;## # A tibble: 2 × 2
##       M no_questions
##   &amp;lt;int&amp;gt;        &amp;lt;int&amp;gt;
## 1     2           11
## 2     3            1&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Let the learning set be &lt;span class=&quot;math inline&quot;&gt;\(\mathcal{L}=\{
(\boldsymbol{x}_i, y_i), i=1,\ldots,n\}\)&lt;/span&gt;, where &lt;span
class=&quot;math inline&quot;&gt;\(\boldsymbol{x}_i=(x_{i1},\ldots,x_{ir})^\top\)&lt;/span&gt;
denotes the answers to the &lt;span class=&quot;math inline&quot;&gt;\(r=12\)&lt;/span&gt;
questions for each of the &lt;span class=&quot;math inline&quot;&gt;\(n=16\)&lt;/span&gt;
persons on a game card. For a node &lt;span
class=&quot;math inline&quot;&gt;\(m\)&lt;/span&gt; in tree &lt;span
class=&quot;math inline&quot;&gt;\(T\)&lt;/span&gt; we use an impurity measure &lt;span
class=&quot;math inline&quot;&gt;\(Q_m(T)\)&lt;/span&gt; to decide which split to use. Let
&lt;span class=&quot;math inline&quot;&gt;\(R_m\)&lt;/span&gt; denote the set of all
observations in the training data, whose feature vector &lt;span
class=&quot;math inline&quot;&gt;\(\boldsymbol{x}_i\)&lt;/span&gt; fulfills all Boolean
conditions posed by following the tree until node &lt;span
class=&quot;math inline&quot;&gt;\(m\)&lt;/span&gt;. In what follows we shall write &lt;span
class=&quot;math inline&quot;&gt;\(\boldsymbol{x}_i\in R_m\)&lt;/span&gt; if an observation
&lt;span class=&quot;math inline&quot;&gt;\((\boldsymbol{x}_i, y_i)\)&lt;/span&gt; from the
learning data is in &lt;span class=&quot;math inline&quot;&gt;\(R_m\)&lt;/span&gt;.
Furthermore, let &lt;span class=&quot;math inline&quot;&gt;\(n_m=|R_m|\)&lt;/span&gt; denote
the corresponding number of observations in &lt;span
class=&quot;math inline&quot;&gt;\(R_m\)&lt;/span&gt; and let &lt;span class=&quot;math display&quot;&gt;\[
\widehat{p}_{mk}=\frac{1}{n_m} \sum_{\boldsymbol{x}_i\in R_m} I(y_i=k) =
\frac{n_{mk}}{n_m}, \quad k=1,\ldots,K
\]&lt;/span&gt; be the proportion of category &lt;span
class=&quot;math inline&quot;&gt;\(k\)&lt;/span&gt; observations at node &lt;span
class=&quot;math inline&quot;&gt;\(m\)&lt;/span&gt;. The &lt;b&gt;cross-entropy impurity
measure&lt;/b&gt; is defined as&lt;/p&gt;
&lt;span class=&quot;math display&quot;&gt;\[
Q_m(T) = - \sum_{k=1}^K \widehat{p}_{mk} \cdot \log(\widehat{p}_{mk}),
\]&lt;/span&gt; where we use the convention that &lt;span
class=&quot;math inline&quot;&gt;\(0\cdot \log(0)=0\)&lt;/span&gt; if some of the
probabilities &lt;span class=&quot;math inline&quot;&gt;\(\widehat{p}_{mk}\)&lt;/span&gt; are
zero. As an example we show a plot of the cross-entropy function for
&lt;span class=&quot;math inline&quot;&gt;\(K=2\)&lt;/span&gt; for varying values of &lt;span
class=&quot;math inline&quot;&gt;\(p_{m1}=p\)&lt;/span&gt; and &lt;span
class=&quot;math inline&quot;&gt;\(p_{m2}=1-p\)&lt;/span&gt;:
&lt;p&gt;
&lt;img src=&quot;/blog/figure/source/2024-02-12-decisiontree/PLOT_ENTROPY-1.png&quot; style=&quot;display: block; margin: auto;&quot; /&gt;
&lt;p&gt;
&lt;p&gt;The largest value for the impurity &lt;span
class=&quot;math inline&quot;&gt;\(Q_m(T)\)&lt;/span&gt; is obtained when all &lt;span
class=&quot;math inline&quot;&gt;\(K\)&lt;/span&gt; categories are equally likely,
i.e. when &lt;span class=&quot;math inline&quot;&gt;\(p_{mk}=1/K\)&lt;/span&gt;, &lt;span
class=&quot;math inline&quot;&gt;\(k=1,\ldots,K\)&lt;/span&gt;. Furthermore, the smallest
value &lt;span class=&quot;math inline&quot;&gt;\(Q_m(T)=0\)&lt;/span&gt; is obtained when one
category, say &lt;span class=&quot;math inline&quot;&gt;\(k\)&lt;/span&gt;, has &lt;span
class=&quot;math inline&quot;&gt;\(p_{mk}=1\)&lt;/span&gt; and consequently &lt;span
class=&quot;math inline&quot;&gt;\(p_{mk&amp;#39;}=0\)&lt;/span&gt; for all &lt;span
class=&quot;math inline&quot;&gt;\(k&amp;#39; \neq k\)&lt;/span&gt;.&lt;/p&gt;
&lt;p&gt;For a node &lt;span class=&quot;math inline&quot;&gt;\(m\)&lt;/span&gt; and unordered
categorical feature &lt;span class=&quot;math inline&quot;&gt;\(x_j\)&lt;/span&gt;, &lt;span
class=&quot;math inline&quot;&gt;\(j=1,\ldots,r\)&lt;/span&gt; we can now investigate the
set of possible splits &lt;span class=&quot;math inline&quot;&gt;\(S_j\)&lt;/span&gt; of &lt;span
class=&quot;math inline&quot;&gt;\(x_j\)&lt;/span&gt; by looking at the gain in impurity
for each split &lt;span class=&quot;math inline&quot;&gt;\(s\in S_j\)&lt;/span&gt;. A split
&lt;span class=&quot;math inline&quot;&gt;\(s=(s_L, s_R)\)&lt;/span&gt; of &lt;span
class=&quot;math inline&quot;&gt;\(x_j\)&lt;/span&gt; is characterised by a partition of
the labels of &lt;span class=&quot;math inline&quot;&gt;\(x_j\)&lt;/span&gt; in two disjoint
sets, &lt;span class=&quot;math inline&quot;&gt;\(s_L\)&lt;/span&gt; and &lt;span
class=&quot;math inline&quot;&gt;\(s_R\)&lt;/span&gt;. For example, if &lt;span
class=&quot;math inline&quot;&gt;\(x_j\)&lt;/span&gt; has &lt;span
class=&quot;math inline&quot;&gt;\(M=3\)&lt;/span&gt; levels (yes, no, unclear) one
possible split could be &lt;span
class=&quot;math inline&quot;&gt;\(s_L=\{\text{yes\}}\)&lt;/span&gt; and &lt;span
class=&quot;math inline&quot;&gt;\(s_R=\{\text{no,unclear}\}\)&lt;/span&gt;.&lt;/p&gt;
&lt;p&gt;If we split &lt;span class=&quot;math inline&quot;&gt;\(m\)&lt;/span&gt; according to the
rule &lt;span class=&quot;math inline&quot;&gt;\(s\in S_j\)&lt;/span&gt; we obtain two
sub-nodes &lt;span class=&quot;math inline&quot;&gt;\(m_L\)&lt;/span&gt; and &lt;span
class=&quot;math inline&quot;&gt;\(m_R\)&lt;/span&gt;, where &lt;span
class=&quot;math inline&quot;&gt;\(R_{m_L} = \{ \boldsymbol{x}_i \in R_m : x_{ij} \in
s_L\}\)&lt;/span&gt; and &lt;span class=&quot;math inline&quot;&gt;\(R_{m_R} = \{
\boldsymbol{x}_i \in R_m : x_{ij} \in s_R\}\)&lt;/span&gt;. The impurity of
&lt;span class=&quot;math inline&quot;&gt;\(m\)&lt;/span&gt; in a tree &lt;span
class=&quot;math inline&quot;&gt;\(T_s\)&lt;/span&gt; implementing the split &lt;span
class=&quot;math inline&quot;&gt;\(s\)&lt;/span&gt;, and thus having additional subnodes
&lt;span class=&quot;math inline&quot;&gt;\(m_L\)&lt;/span&gt; and &lt;span
class=&quot;math inline&quot;&gt;\(m_R\)&lt;/span&gt;, is then calculated as &lt;span
class=&quot;math display&quot;&gt;\[
Q_m(T_s) = \frac{n_{m_L}}{n_m} Q_{m_L}(T_s) + \frac{n_{m_R}}{n_m}
Q_{m_R}(T_s).
\]&lt;/span&gt; Note that the probabilities to be used in the computation of
the subnodes’ cross-entropy are, e.g., &lt;span
class=&quot;math inline&quot;&gt;\(\widehat{p}_{m_L k} = n_{m_L k}/n_{m_L}\)&lt;/span&gt;.
We select the split, which minimizes the impurity. If we also let the
feature &lt;span class=&quot;math inline&quot;&gt;\(j\)&lt;/span&gt; vary we thus select &lt;span
class=&quot;math display&quot;&gt;\[
(j,s)=\DeclareMathOperator*{\argmin}{arg\,min}
\argmin_{j\in\{1,\ldots,r\},\&amp;gt; s\in S_j} Q_m(T_s).
\]&lt;/span&gt; As a simple example for our data: assume that the current tree
consists of just a root node &lt;span class=&quot;math inline&quot;&gt;\(m\)&lt;/span&gt;,
i.e. &lt;span class=&quot;math inline&quot;&gt;\(R_m\)&lt;/span&gt; consists of all &lt;span
class=&quot;math inline&quot;&gt;\(n=16\)&lt;/span&gt; observations.&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb6&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb6-1&quot;&gt;&lt;a href=&quot;#cb6-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;# Compute impurity of root&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb6-2&quot;&gt;&lt;a href=&quot;#cb6-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;(Q_root &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;cross_entropy&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;rep&lt;/span&gt;(&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;16&lt;/span&gt;, &lt;span class=&quot;dv&quot;&gt;16&lt;/span&gt;)))&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;## [1] 2.772589&lt;/code&gt;&lt;/pre&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb8&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb8-1&quot;&gt;&lt;a href=&quot;#cb8-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;# Determine if split on feature j&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb8-2&quot;&gt;&lt;a href=&quot;#cb8-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;best_split &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;cf&quot;&gt;function&lt;/span&gt; (j, Rm) {&lt;/span&gt;
&lt;span id=&quot;cb8-3&quot;&gt;&lt;a href=&quot;#cb8-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;co&quot;&gt;# We know |S|=2^{M-1}-1 and define the split by the set consisting of&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb8-4&quot;&gt;&lt;a href=&quot;#cb8-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;co&quot;&gt;# just ONE level (if |S|=1 we know yes/no and would not need the other level.&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb8-5&quot;&gt;&lt;a href=&quot;#cb8-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;co&quot;&gt;# We can just pick one of them&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb8-6&quot;&gt;&lt;a href=&quot;#cb8-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  S &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;levels&lt;/span&gt;(persons[,j][[&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;]])&lt;/span&gt;
&lt;span id=&quot;cb8-7&quot;&gt;&lt;a href=&quot;#cb8-7&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;cf&quot;&gt;if&lt;/span&gt; (&lt;span class=&quot;fu&quot;&gt;length&lt;/span&gt;(S) &lt;span class=&quot;sc&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;) S &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; S[&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;]&lt;/span&gt;
&lt;span id=&quot;cb8-8&quot;&gt;&lt;a href=&quot;#cb8-8&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;cf&quot;&gt;if&lt;/span&gt; (&lt;span class=&quot;fu&quot;&gt;length&lt;/span&gt;(S) &lt;span class=&quot;sc&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;dv&quot;&gt;3&lt;/span&gt;) &lt;span class=&quot;fu&quot;&gt;stop&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;quot;M&amp;gt;3 currently not supported.&amp;quot;&lt;/span&gt;)&lt;/span&gt;
&lt;span id=&quot;cb8-9&quot;&gt;&lt;a href=&quot;#cb8-9&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  S&lt;/span&gt;
&lt;span id=&quot;cb8-10&quot;&gt;&lt;a href=&quot;#cb8-10&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;co&quot;&gt;# Try out all splits&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb8-11&quot;&gt;&lt;a href=&quot;#cb8-11&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  Q_s &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;sapply&lt;/span&gt;(S, &lt;span class=&quot;cf&quot;&gt;function&lt;/span&gt;(s) {&lt;/span&gt;
&lt;span id=&quot;cb8-12&quot;&gt;&lt;a href=&quot;#cb8-12&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    R_mL &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; Rm[Rm[,j][[&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;]] &lt;span class=&quot;sc&quot;&gt;==&lt;/span&gt; s,]&lt;/span&gt;
&lt;span id=&quot;cb8-13&quot;&gt;&lt;a href=&quot;#cb8-13&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    R_mR &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; Rm[Rm[,j][[&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;]] &lt;span class=&quot;sc&quot;&gt;!=&lt;/span&gt; s,]&lt;/span&gt;
&lt;span id=&quot;cb8-14&quot;&gt;&lt;a href=&quot;#cb8-14&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    n_m &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;nrow&lt;/span&gt;(Rm)&lt;/span&gt;
&lt;span id=&quot;cb8-15&quot;&gt;&lt;a href=&quot;#cb8-15&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    n_mL &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;table&lt;/span&gt;(R_mL&lt;span class=&quot;sc&quot;&gt;$&lt;/span&gt;Person)&lt;/span&gt;
&lt;span id=&quot;cb8-16&quot;&gt;&lt;a href=&quot;#cb8-16&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    n_mR &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;table&lt;/span&gt;(R_mR&lt;span class=&quot;sc&quot;&gt;$&lt;/span&gt;Person)&lt;/span&gt;
&lt;span id=&quot;cb8-17&quot;&gt;&lt;a href=&quot;#cb8-17&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    p_mL &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; n_mL &lt;span class=&quot;sc&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;sum&lt;/span&gt;(n_mL)&lt;/span&gt;
&lt;span id=&quot;cb8-18&quot;&gt;&lt;a href=&quot;#cb8-18&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    p_mR &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; n_mR &lt;span class=&quot;sc&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;sum&lt;/span&gt;(n_mR)&lt;/span&gt;
&lt;span id=&quot;cb8-19&quot;&gt;&lt;a href=&quot;#cb8-19&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    Q_s &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;sum&lt;/span&gt;(n_mL)&lt;span class=&quot;sc&quot;&gt;/&lt;/span&gt;n_m &lt;span class=&quot;sc&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;cross_entropy&lt;/span&gt;(p_mL) &lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;sum&lt;/span&gt;(n_mR)&lt;span class=&quot;sc&quot;&gt;/&lt;/span&gt;n_m &lt;span class=&quot;sc&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;cross_entropy&lt;/span&gt;(p_mR)&lt;/span&gt;
&lt;span id=&quot;cb8-20&quot;&gt;&lt;a href=&quot;#cb8-20&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;fu&quot;&gt;return&lt;/span&gt;(Q_s)&lt;/span&gt;
&lt;span id=&quot;cb8-21&quot;&gt;&lt;a href=&quot;#cb8-21&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  }) &lt;/span&gt;
&lt;span id=&quot;cb8-22&quot;&gt;&lt;a href=&quot;#cb8-22&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;tibble&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;name =&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;names&lt;/span&gt;(Rm)[j], &lt;span class=&quot;at&quot;&gt;split=&lt;/span&gt;S[&lt;span class=&quot;fu&quot;&gt;which.min&lt;/span&gt;(Q_s)], &lt;span class=&quot;at&quot;&gt;Q=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;min&lt;/span&gt;(Q_s))&lt;/span&gt;
&lt;span id=&quot;cb8-23&quot;&gt;&lt;a href=&quot;#cb8-23&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;}&lt;/span&gt;
&lt;span id=&quot;cb8-24&quot;&gt;&lt;a href=&quot;#cb8-24&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb8-25&quot;&gt;&lt;a href=&quot;#cb8-25&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;# Columns of the data frame where the questions are located&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb8-26&quot;&gt;&lt;a href=&quot;#cb8-26&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;question_col_idx &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;seq_len&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;ncol&lt;/span&gt;(persons))[&lt;span class=&quot;sc&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;]&lt;/span&gt;
&lt;span id=&quot;cb8-27&quot;&gt;&lt;a href=&quot;#cb8-27&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;e &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;map_df&lt;/span&gt;(question_col_idx, best_split, &lt;span class=&quot;at&quot;&gt;Rm=&lt;/span&gt;persons) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;arrange&lt;/span&gt;(Q)&lt;/span&gt;
&lt;span id=&quot;cb8-28&quot;&gt;&lt;a href=&quot;#cb8-28&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;head&lt;/span&gt;(e)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;## # A tibble: 6 × 3
##   name                                 split     Q
##   &amp;lt;chr&amp;gt;                                &amp;lt;chr&amp;gt; &amp;lt;dbl&amp;gt;
## 1 have blonde hair?                    no     2.08
## 2 picture have something red in it?    yes    2.09
## 3 have a headgear?                     yes    2.15
## 4 wear a top with no or short sleeves? yes    2.15
## 5 have visible eyebrows?               yes    2.15
## 6 have blue eyes?                      yes    2.15&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;If we are to build the tree only with one additional node we would
thus use the &lt;i&gt;Does the person have blonde hair?&lt;/i&gt; question and would
put the &lt;i&gt;no&lt;/i&gt; answers in one branch the &lt;i&gt;yes&lt;/i&gt; and
&lt;i&gt;unclear&lt;/i&gt; answers on the other branch.&lt;/p&gt;
&lt;p&gt;The same computations can be done with the
&lt;code&gt;rpart::rpart()&lt;/code&gt; function. We set the control parameters s.t.
the tree can consist only of one split (&lt;code&gt;maxdepth=1&lt;/code&gt;).
Furthermore, we lower the minimum number of observations one split can
produce in one branch from the default value of 20. Otherwise, with only
16 observations no split would be attempted.&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb10&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb10-1&quot;&gt;&lt;a href=&quot;#cb10-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;tree_onesplit &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;rpart&lt;/span&gt;(Person &lt;span class=&quot;sc&quot;&gt;~&lt;/span&gt; ., &lt;span class=&quot;at&quot;&gt;data =&lt;/span&gt; persons, &lt;span class=&quot;at&quot;&gt;method=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;class&amp;quot;&lt;/span&gt;,&lt;/span&gt;
&lt;span id=&quot;cb10-2&quot;&gt;&lt;a href=&quot;#cb10-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;               &lt;span class=&quot;at&quot;&gt;parms=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;list&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;split=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;information&amp;quot;&lt;/span&gt;),&lt;/span&gt;
&lt;span id=&quot;cb10-3&quot;&gt;&lt;a href=&quot;#cb10-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;               &lt;span class=&quot;at&quot;&gt;control=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;rpart.control&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;minsplit=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;,  &lt;span class=&quot;at&quot;&gt;maxdepth=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;))&lt;/span&gt;
&lt;span id=&quot;cb10-4&quot;&gt;&lt;a href=&quot;#cb10-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;rpart.plot&lt;/span&gt;(tree_onesplit, &lt;span class=&quot;at&quot;&gt;under=&lt;/span&gt;&lt;span class=&quot;cn&quot;&gt;TRUE&lt;/span&gt;, &lt;span class=&quot;at&quot;&gt;extra=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;3&lt;/span&gt;, &lt;span class=&quot;at&quot;&gt;box.palette=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;Blues&amp;quot;&lt;/span&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;img src=&quot;/blog/figure/source/2024-02-12-decisiontree/RPART_ONESPLIT-1.png&quot; style=&quot;display: block; margin: auto;&quot; /&gt;&lt;/p&gt;
&lt;p&gt;The graph of the decision tree in each node contains the most likely
class. The number below the most likely class specifies the
misclassification rate from this choice. As all classes are initially
equally likely, choosing “Barnabé” at the root node (i.e. if it is not
possible to ask further question) is just the first alphabetical choice
- selecting any of the 15 other persons would have resulted in the same
misclassification error. Similarly, choosing “Barnabé” among those with
no blonde hair (somewhat confusingly this corresponds to the branch
labelled “yes” of the logical condition: &lt;i&gt;Does the person have blonde
hair = no&lt;/i&gt;) is again just for alphabetical reasons. Equally probable
classifications would have been Mounir, Dan, Barnabé, Casimir, Max, Bob,
Mathis and Mikis. This is also reflected by the misclassification rate
in that leaf node, which is 7/8.&lt;/p&gt;
&lt;p&gt;Assume now that we picked the blonde hair question and are ready to
add an additional sub-node to each of the two branches: Which question
should we choose in each case?&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb11&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb11-1&quot;&gt;&lt;a href=&quot;#cb11-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;R_L &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; persons &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;filter&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;at&quot;&gt;have blonde hair?&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;`&lt;/span&gt; &lt;span class=&quot;sc&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;st&quot;&gt;&amp;quot;no&amp;quot;&lt;/span&gt;)&lt;/span&gt;
&lt;span id=&quot;cb11-2&quot;&gt;&lt;a href=&quot;#cb11-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;map_df&lt;/span&gt;(question_col_idx, best_split, &lt;span class=&quot;at&quot;&gt;Rm=&lt;/span&gt;R_L) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;slice_min&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;order_by=&lt;/span&gt;Q)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;## # A tibble: 1 × 3
##   name                              split     Q
##   &amp;lt;chr&amp;gt;                             &amp;lt;chr&amp;gt; &amp;lt;dbl&amp;gt;
## 1 picture have something red in it? yes    1.39&lt;/code&gt;&lt;/pre&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb13&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb13-1&quot;&gt;&lt;a href=&quot;#cb13-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;R_R &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; persons &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;filter&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;at&quot;&gt;have blonde hair?&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;`&lt;/span&gt; &lt;span class=&quot;sc&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;st&quot;&gt;&amp;quot;no&amp;quot;&lt;/span&gt;)&lt;/span&gt;
&lt;span id=&quot;cb13-2&quot;&gt;&lt;a href=&quot;#cb13-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt; &lt;span class=&quot;fu&quot;&gt;map_df&lt;/span&gt;(question_col_idx, best_split, &lt;span class=&quot;at&quot;&gt;Rm=&lt;/span&gt;R_R) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;slice_min&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;order_by=&lt;/span&gt;Q)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;## # A tibble: 1 × 3
##   name                                split     Q
##   &amp;lt;chr&amp;gt;                               &amp;lt;chr&amp;gt; &amp;lt;dbl&amp;gt;
## 1 picture have something green in it? yes    1.39&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;In other words, for the branch where
&lt;code&gt;have blonde hair? == &quot;no&quot;&lt;/code&gt; we ask, whether the person’s
picture has something red in it, whereas we for those with blonde or
unclear hair color ask, if there is something green in the person’s
picture. Again, we can reproduce this directly using
&lt;code&gt;rpart::rpart()&lt;/code&gt;.&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb15&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb15-1&quot;&gt;&lt;a href=&quot;#cb15-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;tree_twosplit &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;rpart&lt;/span&gt;(Person &lt;span class=&quot;sc&quot;&gt;~&lt;/span&gt; ., &lt;span class=&quot;at&quot;&gt;data =&lt;/span&gt; persons, &lt;span class=&quot;at&quot;&gt;method=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;class&amp;quot;&lt;/span&gt;,&lt;/span&gt;
&lt;span id=&quot;cb15-2&quot;&gt;&lt;a href=&quot;#cb15-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;               &lt;span class=&quot;at&quot;&gt;parms=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;list&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;split=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;information&amp;quot;&lt;/span&gt;),&lt;/span&gt;
&lt;span id=&quot;cb15-3&quot;&gt;&lt;a href=&quot;#cb15-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;               &lt;span class=&quot;at&quot;&gt;control=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;rpart.control&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;minsplit=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;, &lt;span class=&quot;at&quot;&gt;maxdepth=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;))&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;img src=&quot;/blog/figure/source/2024-02-12-decisiontree/RPART_TWOSPLIT_PLOT-1.png&quot; style=&quot;display: block; margin: auto;&quot; /&gt;&lt;/p&gt;
&lt;p&gt;As before, the selected person at each node is again a purely
alphabetical choice, e.g. at the leftmost leaf node (Bob) equally
probable choices would have been Dan, Casimir, Max and Bob. The above
classification tree is of course still not perfect with
misclassification rates of 3/4 at each leaf node. In the main section of
the blog post we compute a more elaborate decision tree with a depth of
4 having zero misclassification rate at each leaf node.&lt;/p&gt;
</description>
        <pubDate>Mon, 12 Feb 2024 00:00:00 +0100</pubDate>
        <link>https://mhoehle.github.io/blog/2024/02/12/decisiontree.html</link>
        <guid isPermaLink="true">https://mhoehle.github.io/blog/2024/02/12/decisiontree.html</guid>
        
        <category>rstats</category>
        
        <category>python</category>
        
        <category>reinforcement learning</category>
        
        <category>game theory</category>
        
        
      </item>
    
      <item>
        <title>Dynamic Programming for Super Six</title>
        <description>&lt;h2 id=&quot;abstract&quot;&gt;Abstract:&lt;/h2&gt;
&lt;p&gt;We use dynamic programming to find the optimal strategy for playing
Super Six when there are 2 players. To test the cross-language
capabilities of Rmarkdown we solve the task by embedding our Python
implementation of the value iteration algorithm using the reticulate
R-package.&lt;/p&gt;
&lt;center&gt;
&lt;img
src=&quot;/blog/figure/source/2023-03-20-dynprog/optim_strategy-1.png&quot; /&gt;
&lt;/center&gt;
&lt;p&gt;&lt;br&gt;
&lt;a rel=&quot;license&quot; href=&quot;http://creativecommons.org/licenses/by-sa/4.0/&quot;&gt;&lt;img alt=&quot;Creative Commons License&quot; style=&quot;border-width:0&quot; src=&quot;https://i.creativecommons.org/l/by-sa/4.0/88x31.png&quot;/&gt;&lt;/a&gt;
This work is licensed under a &lt;a rel=&quot;license&quot;
href=&quot;http://creativecommons.org/licenses/by-sa/4.0/&quot;&gt;Creative Commons
Attribution-ShareAlike 4.0 International License&lt;/a&gt;. The &lt;a
href=&quot;https://raw.githubusercontent.com/mhoehle/hoehleatsu.github.io/master/_source/2023-03-20-dynprog.Rmd&quot;&gt;R-markdown
source code&lt;/a&gt; of this blog is available under a &lt;a
href=&quot;https://www.gnu.org/licenses/gpl-3.0.html&quot;&gt;GNU General Public
License (GPL v3)&lt;/a&gt; license from GitHub.&lt;/p&gt;
&lt;h2 id=&quot;introduction&quot;&gt;Introduction&lt;/h2&gt;
&lt;p&gt;The present post finds the optimal game strategy for playing the dice
game of Super Six with two players by using dynamic programming to solve
the corresponding Markov Decision Process (MDP). We use the
&lt;code&gt;reticulate&lt;/code&gt; R package to run our Python implementation of
the value iteration algorithm within the Rmarkdown document.&lt;/p&gt;
&lt;p&gt;For more details about Super Six, see the previous Blog post &lt;a
href=&quot;https://mhoehle.github.io/blog/2023/03/13/super6.html&quot;&gt;&lt;em&gt;How to
Win a Game (or More) of Super Six&lt;/em&gt;&lt;/a&gt;. Appendix 1 of the post
discussed optimal strategies. The present post is a natural successor of
this post, because it shows the details of calculating optimal
strategies for two player games by value iteration &lt;span
class=&quot;citation&quot; data-cites=&quot;russell_norvig2020&quot;&gt;Sutton and Barto
(2020)&lt;/span&gt;. This provides a clearer way to get to the strategy than,
e.g., &lt;span class=&quot;citation&quot; data-cites=&quot;jehn2021&quot;&gt;Jehn (2021)&lt;/span&gt; or
the C++ program by &lt;a
href=&quot;https://github.com/mhoehle/mhoehle.github.io/blob/main/blog/figure/source/2023-03-13-super6/hultberg2.cpp&quot;&gt;Nuno
Hulthberg&lt;/a&gt;.&lt;/p&gt;
&lt;h2 id=&quot;notation&quot;&gt;Notation&lt;/h2&gt;
&lt;p&gt;In mathematical notation the current state &lt;span
class=&quot;math inline&quot;&gt;\(s\)&lt;/span&gt; corresponds to the &lt;span
class=&quot;math inline&quot;&gt;\(i/j/k\)&lt;/span&gt; situation, with &lt;span
class=&quot;math inline&quot;&gt;\(0\leq i\leq 5\)&lt;/span&gt;, &lt;span
class=&quot;math inline&quot;&gt;\(j\geq 0\)&lt;/span&gt; and &lt;span
class=&quot;math inline&quot;&gt;\(k\geq 0\)&lt;/span&gt;.&lt;/p&gt;
&lt;p&gt;In order to distinguish between the first turn of a player in a round
(where the dice has to be thrown) and the subsequent turns, where the
player can decide whether to throw the dice or stop, we add a fourth
component &lt;span class=&quot;math inline&quot;&gt;\(l\in \{0,1\}\)&lt;/span&gt; to the
state, which is a binary indicator whether the move is a forced moved
(1) or not (0). The action space for a state &lt;span
class=&quot;math inline&quot;&gt;\(i/j/k/l\)&lt;/span&gt; with &lt;span
class=&quot;math inline&quot;&gt;\(l=1\)&lt;/span&gt; is &lt;span
class=&quot;math inline&quot;&gt;\(\mathcal{A}(s) = \{\texttt{throw}\}\)&lt;/span&gt;,
whereas for &lt;span class=&quot;math inline&quot;&gt;\(l=0\)&lt;/span&gt; it is &lt;span
class=&quot;math inline&quot;&gt;\(\mathcal{A}(s) =
\{\texttt{throw},\texttt{stop}\}\)&lt;/span&gt;.&lt;/p&gt;
&lt;p&gt;If &lt;span class=&quot;math inline&quot;&gt;\(j=0\)&lt;/span&gt; while &lt;span
class=&quot;math inline&quot;&gt;\(k&amp;gt;0\)&lt;/span&gt; then Player 1 won. If &lt;span
class=&quot;math inline&quot;&gt;\(k=0\)&lt;/span&gt; while &lt;span
class=&quot;math inline&quot;&gt;\(i&amp;gt;0\)&lt;/span&gt; then Player 2 won. In order to
handle this &lt;em&gt;episodic task&lt;/em&gt; &lt;span class=&quot;citation&quot;
data-cites=&quot;sutton_burto2020&quot;&gt;(Sutton and Barto 2020)&lt;/span&gt; we
introduce an terminal state, which provides no additional future
reward.&lt;/p&gt;
&lt;h3 id=&quot;state-transition&quot;&gt;State Transition&lt;/h3&gt;
&lt;p&gt;The state transition probabilities of the Markov decision process are
given as follows. For each throw of the dice from an &lt;span
class=&quot;math inline&quot;&gt;\(i/j/k/l\)&lt;/span&gt; state there are three cases to
consider when throwing the dice:&lt;/p&gt;
&lt;ol type=&quot;1&quot;&gt;
&lt;li&gt;you roll a six (probability &lt;span
class=&quot;math inline&quot;&gt;\(\frac{1}{6}\)&lt;/span&gt;) and move to the &lt;span
class=&quot;math inline&quot;&gt;\(i/(j-1)/k/0\)&lt;/span&gt; state&lt;/li&gt;
&lt;li&gt;(if &lt;span class=&quot;math inline&quot;&gt;\(0\leq i&amp;lt; 5\)&lt;/span&gt;) you hit a
free spot (probability &lt;span
class=&quot;math inline&quot;&gt;\(\frac{5-i}{6}\)&lt;/span&gt;) and move to the &lt;span
class=&quot;math inline&quot;&gt;\((i+1)/j/k/0\)&lt;/span&gt; state&lt;/li&gt;
&lt;li&gt;(if &lt;span class=&quot;math inline&quot;&gt;\(0&amp;lt;i\leq 5\)&lt;/span&gt;) you hit an
already occupied spot (probability &lt;span
class=&quot;math inline&quot;&gt;\(\frac{i}{6}\)&lt;/span&gt;) and it is your opponents
turn to play from an &lt;span
class=&quot;math inline&quot;&gt;\((i-1)/k/(j+1)/1\)&lt;/span&gt; position&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;If you decide to stop throwing (only possible if &lt;span
class=&quot;math inline&quot;&gt;\(l=0\)&lt;/span&gt;) then it is the opponent’s turn to
play from an &lt;span class=&quot;math inline&quot;&gt;\(i/k/j/1\)&lt;/span&gt; position.&lt;/p&gt;
&lt;p&gt;As part of the calculations one needs to know what happens if Player
1 looses their turn (i.e. either by hitting an occupied spot or by
voluntarily deciding to stop) This depends on the strategy played by
Player 2. For simplicity we will assume that Player 2 plays the same
optimal strategy as Player 1. This also means that rewards in this
situation are just minus the rewards obtained from the corresponding
position.&lt;/p&gt;
&lt;h3 id=&quot;reward&quot;&gt;Reward&lt;/h3&gt;
&lt;p&gt;Eventually, the game will finish. Let &lt;span
class=&quot;math inline&quot;&gt;\(R(s,a,s&amp;#39;)\)&lt;/span&gt; be the reward function,
where action &lt;span class=&quot;math inline&quot;&gt;\(a\)&lt;/span&gt; moves the decision
maker from state &lt;span class=&quot;math inline&quot;&gt;\(s\)&lt;/span&gt; to &lt;span
class=&quot;math inline&quot;&gt;\(s&amp;#39;\)&lt;/span&gt;. In our problem, the reward will
only depend on &lt;span class=&quot;math inline&quot;&gt;\(s&amp;#39;\)&lt;/span&gt;. We have
&lt;span class=&quot;math display&quot;&gt;\[
R(s&amp;#39;=(i,j,k,l)) = \left\{
\begin{array}{cl}
1 &amp;amp; \text{if $j=0$ and $k&amp;gt;0$} \\
-1 &amp;amp; \text{if $k=0$ and $j&amp;gt;0$} \\
0 &amp;amp; \text{otherwise}
\end{array}
\right.
\]&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;Side note: Since linear transformations of the reward function leave
the optimal strategy unchanged &lt;span class=&quot;citation&quot;
data-cites=&quot;russell_norvig2020&quot;&gt;(Sect. 17.1.3, Russell and Norvig
2020)&lt;/span&gt;, it is equally possible to work with rewards &lt;span
class=&quot;math inline&quot;&gt;\(R^*(s&amp;#39;=(i,j,k,l)) =
\frac{1}{2}R(s&amp;#39;=(i,j,k,l)) + \frac{1}{2}\)&lt;/span&gt;. This would imply
values 1 for winning and 0 for loosing and translates directly the
expected reward computations into computing expected probabilities for
winning, which is what &lt;span class=&quot;citation&quot; data-cites=&quot;jehn2021&quot;&gt;Jehn
(2021)&lt;/span&gt; computed.&lt;/p&gt;
&lt;h3 id=&quot;bellman-equations&quot;&gt;Bellman equations&lt;/h3&gt;
&lt;p&gt;The expected utility obtained from following stragy &lt;span
class=&quot;math inline&quot;&gt;\(\pi\)&lt;/span&gt; is defined as &lt;span
class=&quot;math display&quot;&gt;\[
U^{\pi}(s) = E\left[ \sum_{t=0}^\infty R(S_t, \pi(S_t), S_{t+1})\right]
\]&lt;/span&gt; The terminal state with future reward 0 ensures that &lt;span
class=&quot;math inline&quot;&gt;\(U^\pi(s)&amp;lt;\infty\)&lt;/span&gt;. No discounting of the
rewards is thus used in our approach. Our aim is now to find a strategy
&lt;span class=&quot;math inline&quot;&gt;\(\pi^*(s)\)&lt;/span&gt;, which optimizes this
expected utility, i.e. &lt;span class=&quot;math display&quot;&gt;\[
\pi_s^* = \operatorname{argmax}_{\pi} U^{\pi}(s)
\]&lt;/span&gt; For state &lt;span class=&quot;math inline&quot;&gt;\(s\)&lt;/span&gt; we thus
choose the action that maximizes the reward for the next step plus the
expected utility of the subsequent states: &lt;span class=&quot;math display&quot;&gt;\[
\pi^*(s) = \operatorname{argmax}_{a\in \mathcal{A}(s)}
\sum_{s&amp;#39;}P(s&amp;#39;| s,a) \left[ R(s,a,s&amp;#39;) +  \max_{a&amp;#39;}
U(s&amp;#39;) \right]
\]&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;This expressions for a state &lt;span class=&quot;math inline&quot;&gt;\(s\)&lt;/span&gt;
is also called the &lt;strong&gt;Bellman equation&lt;/strong&gt;:&lt;/p&gt;
&lt;p&gt;&lt;span class=&quot;math display&quot;&gt;\[\begin{align*}
U(s)
&amp;amp;=\max_{a\in \mathcal{A}(s)} \sum_{s&amp;#39;}P(s&amp;#39;| s,a) \left[
R(s,a,s&amp;#39;) + U(s&amp;#39;)
\right]
\end{align*}\]&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;Hence, for a state &lt;span class=&quot;math inline&quot;&gt;\(i/j/k/0\)&lt;/span&gt; the
action “continue” leads to to the following expansion of the sum term in
the above equation:&lt;/p&gt;
&lt;p&gt;&lt;span class=&quot;math display&quot;&gt;\[
\begin{align*}
&amp;amp; \underbrace{\frac{1}{6} [R(i/j-1/k/0) +
U(i/j-1/k/0)]}_{\text{stick into hole}} \\
&amp;amp;+ \underbrace{\frac{5-i}{6} [R(i+1/j-1/k/0)
+  U(i+1/j-1/k/0)]}_{\text{put stick into lid}}\\
&amp;amp;- \underbrace{\frac{i}{6} [R(i-1/k/j+1/1)
+  U(i-1/k/j+1/1)]}_{\text{take stick from lid}}
\end{align*}
\]&lt;/span&gt; and the action to stop has value &lt;span
class=&quot;math inline&quot;&gt;\(R(i-1/k/j+1/1) +  U(i-1/k/j+1/1)\)&lt;/span&gt;.&lt;/p&gt;
&lt;h2 id=&quot;value-iteration&quot;&gt;Value Iteration&lt;/h2&gt;
&lt;p&gt;We use &lt;strong&gt;value iteration&lt;/strong&gt; &lt;span class=&quot;citation&quot;
data-cites=&quot;russell_norvig2020&quot;&gt;(Sect. 17.2.1, Russell and Norvig
2020)&lt;/span&gt;, &lt;span class=&quot;citation&quot; data-cites=&quot;sutton_burto2020&quot;&gt;(Sect
4.4, Sutton and Barto 2020)&lt;/span&gt; to solve the MDP. Let &lt;span
class=&quot;math inline&quot;&gt;\(U(s)\)&lt;/span&gt; and &lt;span
class=&quot;math inline&quot;&gt;\(U&amp;#39;\)&lt;/span&gt; be collections, which contain the
value function for each &lt;span class=&quot;math inline&quot;&gt;\(s\)&lt;/span&gt; in the
state space. We initialize &lt;span
class=&quot;math inline&quot;&gt;\(U(s)=U&amp;#39;(s)=0\)&lt;/span&gt; for all states and
proceed by the following algorithm:&lt;/p&gt;
&lt;hr /&gt;
&lt;p&gt;&lt;strong&gt;Algorithm 1&lt;/strong&gt;: Value iteration&lt;/p&gt;
&lt;hr /&gt;
&lt;p&gt;&lt;strong&gt;repeat&lt;/strong&gt;&lt;/p&gt;
&lt;ol type=&quot;1&quot;&gt;
&lt;li&gt;&lt;span class=&quot;math inline&quot;&gt;\(U \gets U&amp;#39;; \delta \gets
0\)&lt;/span&gt;&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;For all&lt;/strong&gt; states &lt;span
class=&quot;math inline&quot;&gt;\(s\)&lt;/span&gt; &lt;strong&gt;do&lt;/strong&gt;
&lt;ol type=&quot;a&quot;&gt;
&lt;li&gt;&lt;span class=&quot;math inline&quot;&gt;\(U&amp;#39;(s) \gets \max_{a\in
\mathcal{A}(s)} \sum_{s&amp;#39;}P(s&amp;#39;| s,a) \left[ R(s,a,s&amp;#39;) +
U(s&amp;#39;) \right]\)&lt;/span&gt;&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;if&lt;/strong&gt; &lt;span class=&quot;math inline&quot;&gt;\(|U(s&amp;#39;)-U(s)|
&amp;gt; \delta\)&lt;/span&gt; &lt;strong&gt;then&lt;/strong&gt; &lt;span
class=&quot;math inline&quot;&gt;\(\delta \gets |U(s&amp;#39;)-U(s)|\)&lt;/span&gt;&lt;/li&gt;
&lt;/ol&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;&lt;strong&gt;until&lt;/strong&gt; &lt;span class=&quot;math inline&quot;&gt;\(\delta \leq
\epsilon\)&lt;/span&gt;;&lt;/p&gt;
&lt;hr /&gt;
&lt;p&gt;
&lt;p&gt;The optimal action for state &lt;span class=&quot;math inline&quot;&gt;\(s\)&lt;/span&gt;
is thus the action maximing the sum term in Step 2a, i.e. &lt;span
class=&quot;math inline&quot;&gt;\(\pi(s) = \operatorname{argmax}_{a\in
\mathcal{A}(s)} \sum_{s&amp;#39;}P(s&amp;#39;| s,a) \left[ R(s,a,s&amp;#39;)
+  \max_{a&amp;#39;} U(s&amp;#39;) \right]\)&lt;/span&gt;. Either one computes this at
the end of the algorithm or one adds this book-keeping step as part of
step 2a in the value iteration algorithm. Technically, &lt;span
class=&quot;math inline&quot;&gt;\(\pi\approx \pi^*\)&lt;/span&gt;, i.e. we only obtain an
estimate of the optimal strategy, because of the iterative nature of the
algorithm. However, one can show that with sufficient iterations we
converge towards &lt;span class=&quot;math inline&quot;&gt;\(\pi^*\)&lt;/span&gt;.&lt;/p&gt;
&lt;h2 id=&quot;results&quot;&gt;Results&lt;/h2&gt;
&lt;p&gt;Applying the value iteration Python code for &lt;span
class=&quot;math inline&quot;&gt;\(n=7\)&lt;/span&gt; (see code in the Appendix) gives the
optimal strategy. Furthermore, we also obtain the probabilities to win
from each state. We show the result for all states with at least 3
sticks in the lid. With less than 3 sticks the decision is always to
continue throwing.&lt;/p&gt;
&lt;p&gt;In the output, the column &lt;code&gt;strategy&lt;/code&gt; shows whether to
continue throwing the dice (&lt;code&gt;TRUE&lt;/code&gt;) or not
(&lt;code&gt;FALSE&lt;/code&gt;); the column &lt;code&gt;value&lt;/code&gt; shows the expected
value &lt;span class=&quot;math inline&quot;&gt;\(U(s)\)&lt;/span&gt; and &lt;code&gt;prob&lt;/code&gt;
shows the expected probability to win the game given that the opponent
also follows the same optimal strategy. Note that for states with &lt;span
class=&quot;math inline&quot;&gt;\(l=1\)&lt;/span&gt;, no choice is possible, i.e. one has
to continue no matter what. For these states the strategy column is
always &lt;code&gt;TRUE&lt;/code&gt;.&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;##    i j k l       value strategy      prob
## 1  5 1 1 1 -0.09741652     TRUE 0.4512917
## 2  5 1 1 0  0.09741652    FALSE 0.5487083
## 3  4 2 1 1 -0.36297663     TRUE 0.3185117
## 4  4 2 1 0 -0.31689982    FALSE 0.3415501
## 5  4 1 2 1  0.31689982     TRUE 0.6584499
## 6  4 1 2 0  0.36297663    FALSE 0.6814883
## 7  4 1 1 1  0.04845936     TRUE 0.5242297
## 8  4 1 1 0  0.04845936     TRUE 0.5242297
## 9  3 3 1 1 -0.52748432     TRUE 0.2362578
## 10 3 3 1 0 -0.52748432     TRUE 0.2362578
## 11 3 2 2 1  0.02465027     TRUE 0.5123251
## 12 3 2 2 0  0.02465027     TRUE 0.5123251
## 13 3 2 1 1 -0.27737920     TRUE 0.3613104
## 14 3 2 1 0 -0.27737920     TRUE 0.3613104
## 15 3 1 3 1  0.58093392     TRUE 0.7904670
## 16 3 1 3 0  0.58093392     TRUE 0.7904670
## 17 3 1 2 1  0.42731097     TRUE 0.7136555
## 18 3 1 2 0  0.42731097     TRUE 0.7136555
## 19 3 1 1 1  0.22509739     TRUE 0.6125487
## 20 3 1 1 0  0.22509739     TRUE 0.6125487&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;One can, e.g., compare the results with the numbers in Fig. 4 of
&lt;span class=&quot;citation&quot; data-cites=&quot;jehn2021&quot;&gt;Jehn (2021)&lt;/span&gt;. The
optimal strategy for a two player game is thus to continue as long as
only three pits are filled. If four slots are filled, one would only
continue, if the situation is 4/1/1. If 5 pits are filled, one should
always stop (if possible). The figure below illustrates the strategy for
all &lt;span class=&quot;math inline&quot;&gt;\(l=0\)&lt;/span&gt; states graphically: the
y-axis gives &lt;span class=&quot;math inline&quot;&gt;\(i\)&lt;/span&gt;, whereas the label
of each box is &lt;span class=&quot;math inline&quot;&gt;\(j/k\)&lt;/span&gt; followed by the
expected probability (with just 2 decimals) to win from this state:&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/blog/figure/source/2023-03-20-dynprog/optim_strategy-1.png&quot; style=&quot;display: block; margin: auto;&quot; /&gt;&lt;/p&gt;
&lt;h3 id=&quot;probability-to-win-as-start-player&quot;&gt;Probability to Win as
Start-Player&lt;/h3&gt;
&lt;p&gt;One surprising finding from the simulations in &lt;a
href=&quot;https://mhoehle.github.io/blog/2023/03/13/super6.html&quot;&gt;How to Win
a Game (or More) of Super Six&lt;/a&gt; was that the start player had a big
winning advantage. We use the above algorithm to analytically calculate
the probability that the starting players wins the game in a situation
where each player initially has 4 sticks.&lt;/p&gt;
&lt;p&gt;To compute the winning probability we need to keep in mind that in
round 1 we have the additional restriction that only one throw of the
dice is allowed for each player. As a consequence, we need to treat the
outcome of round 1 separately. There are four possible states that
Player 1 starts from in round 2:&lt;/p&gt;
&lt;ol type=&quot;1&quot;&gt;
&lt;li&gt;Both players throw a 6 (&lt;span
class=&quot;math inline&quot;&gt;\(p=\frac{1}{36}\)&lt;/span&gt;) in round 1; round 2
continues from state &lt;span class=&quot;math inline&quot;&gt;\(0/3/3/1\)&lt;/span&gt;&lt;/li&gt;
&lt;li&gt;One of the players (but not both!) throws a six (&lt;span
class=&quot;math inline&quot;&gt;\(p=\frac{10}{36}\)&lt;/span&gt;), round 2 continues from
state &lt;span class=&quot;math inline&quot;&gt;\(1/3/3/1\)&lt;/span&gt;&lt;/li&gt;
&lt;li&gt;Both sticks from round 1 end up in the lid (&lt;span
class=&quot;math inline&quot;&gt;\(p=\frac{5}{6}\frac{4}{6}=\frac{20}{36}\)&lt;/span&gt;);
round 2 continues from state &lt;span
class=&quot;math inline&quot;&gt;\(2/3/3/1\)&lt;/span&gt;&lt;/li&gt;
&lt;li&gt;Player 1 throws anything but a 6 and Player 2 throws the same (&lt;span
class=&quot;math inline&quot;&gt;\(p=\frac{5}{6}\frac{1}{6}=\frac{5}{36}\)&lt;/span&gt;);
round 2 continues from state &lt;span
class=&quot;math inline&quot;&gt;\(0/3/5/1\)&lt;/span&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;We can thus calculate the probability to win as start player in a
4-stick game (assuming both players follow the optimal winning strategy)
as&lt;/p&gt;
&lt;p&gt;&lt;span class=&quot;math display&quot;&gt;\[
\frac{1}{36} p_{\text{win}}^{\pi^*}(0/3/3/1) + \frac{10}{36}
p_{\text{win}}^{\pi^*}(1/3/3/1) + \frac{20}{36}
p_{\text{win}}^{\pi^*}(2/3/3/1) + \frac{5}{36}
p_{\text{win}}^{\pi^*}(0/3/5/1).
\]&lt;/span&gt; We compute this in R with reticulate calls to the Python
function calculating the winning probability for a given state:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb2&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb2-1&quot;&gt;&lt;a href=&quot;#cb2-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;# States and their probabilities after round 1&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb2-2&quot;&gt;&lt;a href=&quot;#cb2-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;round2 &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;tibble&lt;/span&gt;(&lt;/span&gt;
&lt;span id=&quot;cb2-3&quot;&gt;&lt;a href=&quot;#cb2-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;at&quot;&gt;state =&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;list&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;c&lt;/span&gt;(&lt;span class=&quot;dv&quot;&gt;0&lt;/span&gt;,&lt;span class=&quot;dv&quot;&gt;3&lt;/span&gt;,&lt;span class=&quot;dv&quot;&gt;3&lt;/span&gt;,&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;), &lt;span class=&quot;fu&quot;&gt;c&lt;/span&gt;(&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;,&lt;span class=&quot;dv&quot;&gt;3&lt;/span&gt;,&lt;span class=&quot;dv&quot;&gt;3&lt;/span&gt;,&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;), &lt;span class=&quot;fu&quot;&gt;c&lt;/span&gt;(&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;,&lt;span class=&quot;dv&quot;&gt;3&lt;/span&gt;,&lt;span class=&quot;dv&quot;&gt;3&lt;/span&gt;,&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;), &lt;span class=&quot;fu&quot;&gt;c&lt;/span&gt;(&lt;span class=&quot;dv&quot;&gt;0&lt;/span&gt;,&lt;span class=&quot;dv&quot;&gt;3&lt;/span&gt;,&lt;span class=&quot;dv&quot;&gt;5&lt;/span&gt;,&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;)),&lt;/span&gt;
&lt;span id=&quot;cb2-4&quot;&gt;&lt;a href=&quot;#cb2-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;at&quot;&gt;prob =&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;c&lt;/span&gt;(&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;, &lt;span class=&quot;dv&quot;&gt;10&lt;/span&gt;, &lt;span class=&quot;dv&quot;&gt;20&lt;/span&gt;, &lt;span class=&quot;dv&quot;&gt;5&lt;/span&gt;) &lt;span class=&quot;sc&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;dv&quot;&gt;36&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb2-5&quot;&gt;&lt;a href=&quot;#cb2-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;)&lt;/span&gt;
&lt;span id=&quot;cb2-6&quot;&gt;&lt;a href=&quot;#cb2-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb2-7&quot;&gt;&lt;a href=&quot;#cb2-7&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;# Compute the probability to win from round 2 on for a given state&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb2-8&quot;&gt;&lt;a href=&quot;#cb2-8&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;p_win &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;cf&quot;&gt;function&lt;/span&gt;(s) {&lt;/span&gt;
&lt;span id=&quot;cb2-9&quot;&gt;&lt;a href=&quot;#cb2-9&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  py&lt;span class=&quot;sc&quot;&gt;$&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;optimal_strategy&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;as.integer&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;sum&lt;/span&gt;(s))) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;/span&gt;
&lt;span id=&quot;cb2-10&quot;&gt;&lt;a href=&quot;#cb2-10&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;             &lt;span class=&quot;fu&quot;&gt;filter&lt;/span&gt;( i &lt;span class=&quot;sc&quot;&gt;==&lt;/span&gt; s[&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;] &lt;span class=&quot;sc&quot;&gt;&amp;amp;&lt;/span&gt;  j &lt;span class=&quot;sc&quot;&gt;==&lt;/span&gt; s[&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;] &lt;span class=&quot;sc&quot;&gt;&amp;amp;&lt;/span&gt;  &lt;/span&gt;
&lt;span id=&quot;cb2-11&quot;&gt;&lt;a href=&quot;#cb2-11&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;                     k &lt;span class=&quot;sc&quot;&gt;==&lt;/span&gt; s[&lt;span class=&quot;dv&quot;&gt;3&lt;/span&gt;] &lt;span class=&quot;sc&quot;&gt;&amp;amp;&lt;/span&gt;  l &lt;span class=&quot;sc&quot;&gt;==&lt;/span&gt; s[&lt;span class=&quot;dv&quot;&gt;4&lt;/span&gt;]) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;/span&gt;
&lt;span id=&quot;cb2-12&quot;&gt;&lt;a href=&quot;#cb2-12&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;             &lt;span class=&quot;fu&quot;&gt;pull&lt;/span&gt;(prob)&lt;/span&gt;
&lt;span id=&quot;cb2-13&quot;&gt;&lt;a href=&quot;#cb2-13&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;} &lt;/span&gt;
&lt;span id=&quot;cb2-14&quot;&gt;&lt;a href=&quot;#cb2-14&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb2-15&quot;&gt;&lt;a href=&quot;#cb2-15&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;# Compute winning probabilities for each state and do the weighted&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb2-16&quot;&gt;&lt;a href=&quot;#cb2-16&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;# sum to get the overall probability to win as start player&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb2-17&quot;&gt;&lt;a href=&quot;#cb2-17&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;(res &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; round2 &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;/span&gt;
&lt;span id=&quot;cb2-18&quot;&gt;&lt;a href=&quot;#cb2-18&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;rowwise&lt;/span&gt;() &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;/span&gt;
&lt;span id=&quot;cb2-19&quot;&gt;&lt;a href=&quot;#cb2-19&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;mutate&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;p_win =&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;p_win&lt;/span&gt;(state)) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;/span&gt;
&lt;span id=&quot;cb2-20&quot;&gt;&lt;a href=&quot;#cb2-20&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;ungroup&lt;/span&gt;() &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;/span&gt;
&lt;span id=&quot;cb2-21&quot;&gt;&lt;a href=&quot;#cb2-21&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;co&quot;&gt;#unnest_wider(col=state, names_sep=&amp;quot;.&amp;quot;) %&amp;gt;% &lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb2-22&quot;&gt;&lt;a href=&quot;#cb2-22&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;summarise&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;p_win =&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;sum&lt;/span&gt;(prob&lt;span class=&quot;sc&quot;&gt;*&lt;/span&gt;p_win)))&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;## # A tibble: 1 × 1
##   p_win
##   &amp;lt;dbl&amp;gt;
## 1 0.602&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;This corroborates the previous finding that the start player has a
60% probability to win the game when both players play the optimal
strategy.&lt;/p&gt;
&lt;h2 id=&quot;discussion&quot;&gt;Discussion&lt;/h2&gt;
&lt;p&gt;Dynamic programming is an important foundation for reinforcement
learning. We can use it to find optimal strategies in fully observable
stochastic environments. For environments with reasonable sized state
spaces and with a known stochastic model for the transitions between
states, dynamic programming is a direct method to get exact solutions.
No complex approximate solutions, as e.g. discussed in Part 2 of &lt;span
class=&quot;citation&quot; data-cites=&quot;sutton_burto2020&quot;&gt;Sutton and Barto
(2020)&lt;/span&gt;, are needed.&lt;/p&gt;
&lt;h2 id=&quot;appendix-python-code&quot;&gt;Appendix: Python code&lt;/h2&gt;
&lt;p&gt;The Python code for value iteration can be found as &lt;a
href=&quot;/blog/figure/source/2023-03-20-dynprog/value_iteration.py&quot;&gt;&lt;code&gt;value_iteration.py&lt;/code&gt;&lt;/a&gt;.&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb4&quot;&gt;&lt;pre
class=&quot;sourceCode python&quot;&gt;&lt;code class=&quot;sourceCode python&quot;&gt;&lt;span id=&quot;cb4-1&quot;&gt;&lt;a href=&quot;#cb4-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;# Python implementation of value iteration to find the optimal strategy in Super Six  &lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-2&quot;&gt;&lt;a href=&quot;#cb4-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;#&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-3&quot;&gt;&lt;a href=&quot;#cb4-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;# Author: Michael Höhle&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-4&quot;&gt;&lt;a href=&quot;#cb4-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;# Date:   2023-03-16&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-5&quot;&gt;&lt;a href=&quot;#cb4-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;#&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-6&quot;&gt;&lt;a href=&quot;#cb4-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;# Semi-manual translation of the R code in value_iteration.R to python with the &lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-7&quot;&gt;&lt;a href=&quot;#cb4-7&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;# help of OpenAI&amp;#39;s text-davinci-003 API playground feature https://platform.openai.com/playground/p/default-text-to-command?model=text-davinci-003.&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-8&quot;&gt;&lt;a href=&quot;#cb4-8&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-9&quot;&gt;&lt;a href=&quot;#cb4-9&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;im&quot;&gt;import&lt;/span&gt; numpy &lt;span class=&quot;im&quot;&gt;as&lt;/span&gt; np&lt;/span&gt;
&lt;span id=&quot;cb4-10&quot;&gt;&lt;a href=&quot;#cb4-10&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;im&quot;&gt;import&lt;/span&gt; pandas &lt;span class=&quot;im&quot;&gt;as&lt;/span&gt; pd&lt;/span&gt;
&lt;span id=&quot;cb4-11&quot;&gt;&lt;a href=&quot;#cb4-11&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-12&quot;&gt;&lt;a href=&quot;#cb4-12&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kw&quot;&gt;def&lt;/span&gt; make_situations(n):&lt;/span&gt;
&lt;span id=&quot;cb4-13&quot;&gt;&lt;a href=&quot;#cb4-13&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;co&quot;&gt;&amp;quot;&amp;quot;&amp;quot;Returns all situations in a game with n sticks left&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-14&quot;&gt;&lt;a href=&quot;#cb4-14&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-15&quot;&gt;&lt;a href=&quot;#cb4-15&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;    Parameters&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-16&quot;&gt;&lt;a href=&quot;#cb4-16&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;    ----------&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-17&quot;&gt;&lt;a href=&quot;#cb4-17&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;    n : int&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-18&quot;&gt;&lt;a href=&quot;#cb4-18&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;        The number of sticks left in the game&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-19&quot;&gt;&lt;a href=&quot;#cb4-19&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;    &lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-20&quot;&gt;&lt;a href=&quot;#cb4-20&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;    Returns&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-21&quot;&gt;&lt;a href=&quot;#cb4-21&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;    -------&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-22&quot;&gt;&lt;a href=&quot;#cb4-22&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;    list&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-23&quot;&gt;&lt;a href=&quot;#cb4-23&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;        a list of with entries [i,j,k] &lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-24&quot;&gt;&lt;a href=&quot;#cb4-24&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;    &amp;quot;&amp;quot;&amp;quot;&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-25&quot;&gt;&lt;a href=&quot;#cb4-25&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    res &lt;span class=&quot;op&quot;&gt;=&lt;/span&gt; []&lt;/span&gt;
&lt;span id=&quot;cb4-26&quot;&gt;&lt;a href=&quot;#cb4-26&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;co&quot;&gt;# Number of sticks in the lid&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-27&quot;&gt;&lt;a href=&quot;#cb4-27&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;cf&quot;&gt;for&lt;/span&gt; i &lt;span class=&quot;kw&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;bu&quot;&gt;range&lt;/span&gt;(&lt;span class=&quot;bu&quot;&gt;min&lt;/span&gt;(n,&lt;span class=&quot;dv&quot;&gt;5&lt;/span&gt;),&lt;span class=&quot;op&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;,&lt;span class=&quot;op&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;):&lt;/span&gt;
&lt;span id=&quot;cb4-28&quot;&gt;&lt;a href=&quot;#cb4-28&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;        &lt;span class=&quot;co&quot;&gt;# Number of sticks of player 1&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-29&quot;&gt;&lt;a href=&quot;#cb4-29&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;        &lt;span class=&quot;cf&quot;&gt;for&lt;/span&gt; j &lt;span class=&quot;kw&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;bu&quot;&gt;range&lt;/span&gt;(n,&lt;span class=&quot;dv&quot;&gt;0&lt;/span&gt;,&lt;span class=&quot;op&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;):&lt;/span&gt;
&lt;span id=&quot;cb4-30&quot;&gt;&lt;a href=&quot;#cb4-30&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;            &lt;span class=&quot;co&quot;&gt;# Number of sticks of player 2&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-31&quot;&gt;&lt;a href=&quot;#cb4-31&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;            k &lt;span class=&quot;op&quot;&gt;=&lt;/span&gt; n &lt;span class=&quot;op&quot;&gt;-&lt;/span&gt; i &lt;span class=&quot;op&quot;&gt;-&lt;/span&gt; j&lt;/span&gt;
&lt;span id=&quot;cb4-32&quot;&gt;&lt;a href=&quot;#cb4-32&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;            &lt;span class=&quot;co&quot;&gt;# Only add valid states&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-33&quot;&gt;&lt;a href=&quot;#cb4-33&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;            &lt;span class=&quot;cf&quot;&gt;if&lt;/span&gt; (i&lt;span class=&quot;op&quot;&gt;&amp;gt;=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;0&lt;/span&gt;  &lt;span class=&quot;kw&quot;&gt;and&lt;/span&gt; &lt;span class=&quot;kw&quot;&gt;not&lt;/span&gt; (j&lt;span class=&quot;op&quot;&gt;&amp;lt;=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;kw&quot;&gt;or&lt;/span&gt; k&lt;span class=&quot;op&quot;&gt;&amp;lt;=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;0&lt;/span&gt;)):&lt;/span&gt;
&lt;span id=&quot;cb4-34&quot;&gt;&lt;a href=&quot;#cb4-34&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;                &lt;span class=&quot;co&quot;&gt;# Append the state as an array [i,j,k]&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-35&quot;&gt;&lt;a href=&quot;#cb4-35&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;                res.append([i,j,k])&lt;/span&gt;
&lt;span id=&quot;cb4-36&quot;&gt;&lt;a href=&quot;#cb4-36&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;cf&quot;&gt;return&lt;/span&gt;(res)&lt;/span&gt;
&lt;span id=&quot;cb4-37&quot;&gt;&lt;a href=&quot;#cb4-37&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-38&quot;&gt;&lt;a href=&quot;#cb4-38&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-39&quot;&gt;&lt;a href=&quot;#cb4-39&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kw&quot;&gt;def&lt;/span&gt; make_states(n):&lt;/span&gt;
&lt;span id=&quot;cb4-40&quot;&gt;&lt;a href=&quot;#cb4-40&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;co&quot;&gt;&amp;quot;&amp;quot;&amp;quot;All states when there are n sticks in the game left&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-41&quot;&gt;&lt;a href=&quot;#cb4-41&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-42&quot;&gt;&lt;a href=&quot;#cb4-42&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;    We distinguish between states with a choice if to throw the dice and those without&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-43&quot;&gt;&lt;a href=&quot;#cb4-43&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-44&quot;&gt;&lt;a href=&quot;#cb4-44&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;    Parameters&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-45&quot;&gt;&lt;a href=&quot;#cb4-45&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;    ----------&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-46&quot;&gt;&lt;a href=&quot;#cb4-46&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;    n : int&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-47&quot;&gt;&lt;a href=&quot;#cb4-47&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;        The number of sticks left in the game&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-48&quot;&gt;&lt;a href=&quot;#cb4-48&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;    &lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-49&quot;&gt;&lt;a href=&quot;#cb4-49&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;    Returns&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-50&quot;&gt;&lt;a href=&quot;#cb4-50&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;    -------&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-51&quot;&gt;&lt;a href=&quot;#cb4-51&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;    list&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-52&quot;&gt;&lt;a href=&quot;#cb4-52&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;        a list of with entries [i,j,k] &lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-53&quot;&gt;&lt;a href=&quot;#cb4-53&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;    &amp;quot;&amp;quot;&amp;quot;&lt;/span&gt;   &lt;/span&gt;
&lt;span id=&quot;cb4-54&quot;&gt;&lt;a href=&quot;#cb4-54&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    states &lt;span class=&quot;op&quot;&gt;=&lt;/span&gt; []&lt;/span&gt;
&lt;span id=&quot;cb4-55&quot;&gt;&lt;a href=&quot;#cb4-55&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;cf&quot;&gt;for&lt;/span&gt; i &lt;span class=&quot;kw&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;bu&quot;&gt;range&lt;/span&gt;(&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;,n&lt;span class=&quot;op&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;):&lt;/span&gt;
&lt;span id=&quot;cb4-56&quot;&gt;&lt;a href=&quot;#cb4-56&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;        s &lt;span class=&quot;op&quot;&gt;=&lt;/span&gt; make_situations(i)&lt;/span&gt;
&lt;span id=&quot;cb4-57&quot;&gt;&lt;a href=&quot;#cb4-57&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;        &lt;span class=&quot;co&quot;&gt;# Make list comprehension which adds a fourth component indicating if the move is forced (0=no, 1=yes)&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-58&quot;&gt;&lt;a href=&quot;#cb4-58&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;        &lt;span class=&quot;cf&quot;&gt;for&lt;/span&gt; j &lt;span class=&quot;kw&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;bu&quot;&gt;range&lt;/span&gt;(&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;):&lt;/span&gt;
&lt;span id=&quot;cb4-59&quot;&gt;&lt;a href=&quot;#cb4-59&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;            states.extend([x &lt;span class=&quot;op&quot;&gt;+&lt;/span&gt; [j] &lt;span class=&quot;cf&quot;&gt;for&lt;/span&gt; x &lt;span class=&quot;kw&quot;&gt;in&lt;/span&gt; s])&lt;/span&gt;
&lt;span id=&quot;cb4-60&quot;&gt;&lt;a href=&quot;#cb4-60&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;co&quot;&gt;# Sort the list&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-61&quot;&gt;&lt;a href=&quot;#cb4-61&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    states.sort(reverse&lt;span class=&quot;op&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;va&quot;&gt;True&lt;/span&gt;)&lt;/span&gt;
&lt;span id=&quot;cb4-62&quot;&gt;&lt;a href=&quot;#cb4-62&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;cf&quot;&gt;return&lt;/span&gt;(states)&lt;/span&gt;
&lt;span id=&quot;cb4-63&quot;&gt;&lt;a href=&quot;#cb4-63&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-64&quot;&gt;&lt;a href=&quot;#cb4-64&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kw&quot;&gt;def&lt;/span&gt; swap(state, forced_move &lt;span class=&quot;op&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;va&quot;&gt;None&lt;/span&gt;):&lt;/span&gt;
&lt;span id=&quot;cb4-65&quot;&gt;&lt;a href=&quot;#cb4-65&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;co&quot;&gt;&amp;quot;&amp;quot;&amp;quot;&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-66&quot;&gt;&lt;a href=&quot;#cb4-66&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;    Swap the number of sticks of player 1 and 2&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-67&quot;&gt;&lt;a href=&quot;#cb4-67&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-68&quot;&gt;&lt;a href=&quot;#cb4-68&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;    Parameters&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-69&quot;&gt;&lt;a href=&quot;#cb4-69&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;    ----------&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-70&quot;&gt;&lt;a href=&quot;#cb4-70&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;    state : vector of length 4&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-71&quot;&gt;&lt;a href=&quot;#cb4-71&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;        The state of the game as a vector with 4 components&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-72&quot;&gt;&lt;a href=&quot;#cb4-72&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-73&quot;&gt;&lt;a href=&quot;#cb4-73&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;    forced_move : bool&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-74&quot;&gt;&lt;a href=&quot;#cb4-74&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;        If the move is forced (i.e. the player has to swap the sticks)&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-75&quot;&gt;&lt;a href=&quot;#cb4-75&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-76&quot;&gt;&lt;a href=&quot;#cb4-76&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;    Returns&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-77&quot;&gt;&lt;a href=&quot;#cb4-77&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;    -------&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-78&quot;&gt;&lt;a href=&quot;#cb4-78&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;        The new state as a vector of length 4&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-79&quot;&gt;&lt;a href=&quot;#cb4-79&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;    &amp;quot;&amp;quot;&amp;quot;&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-80&quot;&gt;&lt;a href=&quot;#cb4-80&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    res &lt;span class=&quot;op&quot;&gt;=&lt;/span&gt; [state[&lt;span class=&quot;dv&quot;&gt;0&lt;/span&gt;], state[&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;], state[&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;], state[&lt;span class=&quot;dv&quot;&gt;3&lt;/span&gt;]]&lt;/span&gt;
&lt;span id=&quot;cb4-81&quot;&gt;&lt;a href=&quot;#cb4-81&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;cf&quot;&gt;if&lt;/span&gt; (forced_move &lt;span class=&quot;op&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;va&quot;&gt;None&lt;/span&gt;):&lt;/span&gt;
&lt;span id=&quot;cb4-82&quot;&gt;&lt;a href=&quot;#cb4-82&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;        res[&lt;span class=&quot;dv&quot;&gt;3&lt;/span&gt;] &lt;span class=&quot;op&quot;&gt;=&lt;/span&gt; forced_move&lt;/span&gt;
&lt;span id=&quot;cb4-83&quot;&gt;&lt;a href=&quot;#cb4-83&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;cf&quot;&gt;return&lt;/span&gt;(res)&lt;/span&gt;
&lt;span id=&quot;cb4-84&quot;&gt;&lt;a href=&quot;#cb4-84&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-85&quot;&gt;&lt;a href=&quot;#cb4-85&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kw&quot;&gt;def&lt;/span&gt; add_state(state, Delta, forced_move &lt;span class=&quot;op&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;va&quot;&gt;None&lt;/span&gt;):&lt;/span&gt;
&lt;span id=&quot;cb4-86&quot;&gt;&lt;a href=&quot;#cb4-86&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    res &lt;span class=&quot;op&quot;&gt;=&lt;/span&gt; [&lt;span class=&quot;bu&quot;&gt;sum&lt;/span&gt;(x) &lt;span class=&quot;cf&quot;&gt;for&lt;/span&gt; x &lt;span class=&quot;kw&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;bu&quot;&gt;zip&lt;/span&gt;(state, Delta)]&lt;/span&gt;
&lt;span id=&quot;cb4-87&quot;&gt;&lt;a href=&quot;#cb4-87&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;cf&quot;&gt;if&lt;/span&gt; (forced_move &lt;span class=&quot;op&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;va&quot;&gt;None&lt;/span&gt;):&lt;/span&gt;
&lt;span id=&quot;cb4-88&quot;&gt;&lt;a href=&quot;#cb4-88&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;        res[&lt;span class=&quot;dv&quot;&gt;3&lt;/span&gt;] &lt;span class=&quot;op&quot;&gt;=&lt;/span&gt; forced_move&lt;/span&gt;
&lt;span id=&quot;cb4-89&quot;&gt;&lt;a href=&quot;#cb4-89&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;cf&quot;&gt;return&lt;/span&gt;(res)&lt;/span&gt;
&lt;span id=&quot;cb4-90&quot;&gt;&lt;a href=&quot;#cb4-90&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-91&quot;&gt;&lt;a href=&quot;#cb4-91&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-92&quot;&gt;&lt;a href=&quot;#cb4-92&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kw&quot;&gt;def&lt;/span&gt; R(state):&lt;/span&gt;
&lt;span id=&quot;cb4-93&quot;&gt;&lt;a href=&quot;#cb4-93&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;co&quot;&gt;&amp;quot;&amp;quot;&amp;quot;The immediate reward function&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-94&quot;&gt;&lt;a href=&quot;#cb4-94&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;    &lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-95&quot;&gt;&lt;a href=&quot;#cb4-95&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;    Parameters&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-96&quot;&gt;&lt;a href=&quot;#cb4-96&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;    ----------&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-97&quot;&gt;&lt;a href=&quot;#cb4-97&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;    state : list&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-98&quot;&gt;&lt;a href=&quot;#cb4-98&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;        The state of the game as a vector with 4 components&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-99&quot;&gt;&lt;a href=&quot;#cb4-99&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;        &lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-100&quot;&gt;&lt;a href=&quot;#cb4-100&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;    Returns&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-101&quot;&gt;&lt;a href=&quot;#cb4-101&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;    -------&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-102&quot;&gt;&lt;a href=&quot;#cb4-102&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;    double The reward R(state), i.e. 1 if player 1 wins, -1 if player 2 wins, 0 otherwise&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-103&quot;&gt;&lt;a href=&quot;#cb4-103&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;        &lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-104&quot;&gt;&lt;a href=&quot;#cb4-104&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;    &amp;quot;&amp;quot;&amp;quot;&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-105&quot;&gt;&lt;a href=&quot;#cb4-105&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;co&quot;&gt;# A terminal state (player 1 = 0)&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-106&quot;&gt;&lt;a href=&quot;#cb4-106&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;cf&quot;&gt;if&lt;/span&gt; state[&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;] &lt;span class=&quot;op&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;dv&quot;&gt;0&lt;/span&gt;:&lt;/span&gt;
&lt;span id=&quot;cb4-107&quot;&gt;&lt;a href=&quot;#cb4-107&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;        &lt;span class=&quot;cf&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-108&quot;&gt;&lt;a href=&quot;#cb4-108&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;co&quot;&gt;# A terminal state (player 2 = 0)&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-109&quot;&gt;&lt;a href=&quot;#cb4-109&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;cf&quot;&gt;if&lt;/span&gt; state[&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;] &lt;span class=&quot;op&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;dv&quot;&gt;0&lt;/span&gt;:&lt;/span&gt;
&lt;span id=&quot;cb4-110&quot;&gt;&lt;a href=&quot;#cb4-110&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;        &lt;span class=&quot;cf&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;op&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-111&quot;&gt;&lt;a href=&quot;#cb4-111&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;co&quot;&gt;# Other state (nothing)&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-112&quot;&gt;&lt;a href=&quot;#cb4-112&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;cf&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;dv&quot;&gt;0&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-113&quot;&gt;&lt;a href=&quot;#cb4-113&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-114&quot;&gt;&lt;a href=&quot;#cb4-114&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kw&quot;&gt;def&lt;/span&gt; optimal_strategy(n, debug&lt;span class=&quot;op&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;va&quot;&gt;False&lt;/span&gt;):&lt;/span&gt;
&lt;span id=&quot;cb4-115&quot;&gt;&lt;a href=&quot;#cb4-115&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;co&quot;&gt;&amp;quot;&amp;quot;&amp;quot;&amp;quot;Find the optimal strategy for a game with n sticks left&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-116&quot;&gt;&lt;a href=&quot;#cb4-116&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;    &amp;quot;&amp;quot;&amp;quot;&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-117&quot;&gt;&lt;a href=&quot;#cb4-117&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-118&quot;&gt;&lt;a href=&quot;#cb4-118&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;co&quot;&gt;# Define local variables for the function&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-119&quot;&gt;&lt;a href=&quot;#cb4-119&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    states &lt;span class=&quot;op&quot;&gt;=&lt;/span&gt; make_states(n)&lt;/span&gt;
&lt;span id=&quot;cb4-120&quot;&gt;&lt;a href=&quot;#cb4-120&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    n_states &lt;span class=&quot;op&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;bu&quot;&gt;len&lt;/span&gt;(states)&lt;/span&gt;
&lt;span id=&quot;cb4-121&quot;&gt;&lt;a href=&quot;#cb4-121&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;co&quot;&gt;## Storage of the value function&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-122&quot;&gt;&lt;a href=&quot;#cb4-122&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    U_vec &lt;span class=&quot;op&quot;&gt;=&lt;/span&gt; np.zeros(n_states)&lt;/span&gt;
&lt;span id=&quot;cb4-123&quot;&gt;&lt;a href=&quot;#cb4-123&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    U_vec_prime &lt;span class=&quot;op&quot;&gt;=&lt;/span&gt; np.zeros(n_states)&lt;/span&gt;
&lt;span id=&quot;cb4-124&quot;&gt;&lt;a href=&quot;#cb4-124&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;co&quot;&gt;## Storage of the policy/strategy&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-125&quot;&gt;&lt;a href=&quot;#cb4-125&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    pi &lt;span class=&quot;op&quot;&gt;=&lt;/span&gt; np.full(n_states, np.nan)&lt;/span&gt;
&lt;span id=&quot;cb4-126&quot;&gt;&lt;a href=&quot;#cb4-126&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-127&quot;&gt;&lt;a href=&quot;#cb4-127&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;co&quot;&gt;# Future reward function.&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-128&quot;&gt;&lt;a href=&quot;#cb4-128&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;co&quot;&gt;# Note terminating states (i=0 or j=0) have zero future reward.&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-129&quot;&gt;&lt;a href=&quot;#cb4-129&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;co&quot;&gt;# The function uses a local variable states and the value function uvec. Might want to add this to the arguments&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-130&quot;&gt;&lt;a href=&quot;#cb4-130&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;kw&quot;&gt;def&lt;/span&gt; U(state):&lt;/span&gt;
&lt;span id=&quot;cb4-131&quot;&gt;&lt;a href=&quot;#cb4-131&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;        &lt;span class=&quot;co&quot;&gt;# Terminal state (no future returns)&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-132&quot;&gt;&lt;a href=&quot;#cb4-132&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;        &lt;span class=&quot;cf&quot;&gt;if&lt;/span&gt; (state[&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;] &lt;span class=&quot;op&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;dv&quot;&gt;0&lt;/span&gt;):&lt;/span&gt;
&lt;span id=&quot;cb4-133&quot;&gt;&lt;a href=&quot;#cb4-133&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;            &lt;span class=&quot;cf&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;dv&quot;&gt;0&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-134&quot;&gt;&lt;a href=&quot;#cb4-134&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;        &lt;span class=&quot;cf&quot;&gt;if&lt;/span&gt; (state[&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;] &lt;span class=&quot;op&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;dv&quot;&gt;0&lt;/span&gt;):&lt;/span&gt;
&lt;span id=&quot;cb4-135&quot;&gt;&lt;a href=&quot;#cb4-135&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;            &lt;span class=&quot;cf&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;dv&quot;&gt;0&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-136&quot;&gt;&lt;a href=&quot;#cb4-136&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;        &lt;span class=&quot;co&quot;&gt;# Find index of the element matching in states vector&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-137&quot;&gt;&lt;a href=&quot;#cb4-137&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;        idx &lt;span class=&quot;op&quot;&gt;=&lt;/span&gt; states.index(state)&lt;/span&gt;
&lt;span id=&quot;cb4-138&quot;&gt;&lt;a href=&quot;#cb4-138&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;        &lt;span class=&quot;co&quot;&gt;# Return value function of the state&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-139&quot;&gt;&lt;a href=&quot;#cb4-139&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;        &lt;span class=&quot;cf&quot;&gt;return&lt;/span&gt; U_vec[idx]&lt;/span&gt;
&lt;span id=&quot;cb4-140&quot;&gt;&lt;a href=&quot;#cb4-140&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-141&quot;&gt;&lt;a href=&quot;#cb4-141&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;co&quot;&gt;## Loop controls&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-142&quot;&gt;&lt;a href=&quot;#cb4-142&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    stop &lt;span class=&quot;op&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;va&quot;&gt;False&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-143&quot;&gt;&lt;a href=&quot;#cb4-143&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    epsilon &lt;span class=&quot;op&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;fl&quot;&gt;1e-10&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-144&quot;&gt;&lt;a href=&quot;#cb4-144&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;bu&quot;&gt;iter&lt;/span&gt; &lt;span class=&quot;op&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;dv&quot;&gt;0&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-145&quot;&gt;&lt;a href=&quot;#cb4-145&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-146&quot;&gt;&lt;a href=&quot;#cb4-146&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;co&quot;&gt;# Value iteration &lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-147&quot;&gt;&lt;a href=&quot;#cb4-147&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;cf&quot;&gt;while&lt;/span&gt; (stop &lt;span class=&quot;op&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;va&quot;&gt;False&lt;/span&gt;):&lt;/span&gt;
&lt;span id=&quot;cb4-148&quot;&gt;&lt;a href=&quot;#cb4-148&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;        &lt;span class=&quot;bu&quot;&gt;iter&lt;/span&gt; &lt;span class=&quot;op&quot;&gt;+=&lt;/span&gt; &lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-149&quot;&gt;&lt;a href=&quot;#cb4-149&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;        Delta &lt;span class=&quot;op&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;dv&quot;&gt;0&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-150&quot;&gt;&lt;a href=&quot;#cb4-150&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;        &lt;span class=&quot;cf&quot;&gt;for&lt;/span&gt; idx &lt;span class=&quot;kw&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;bu&quot;&gt;range&lt;/span&gt;(n_states):&lt;/span&gt;
&lt;span id=&quot;cb4-151&quot;&gt;&lt;a href=&quot;#cb4-151&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;            &lt;span class=&quot;co&quot;&gt;# Translate to integer configuration&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-152&quot;&gt;&lt;a href=&quot;#cb4-152&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;            state &lt;span class=&quot;op&quot;&gt;=&lt;/span&gt; states[idx]&lt;/span&gt;
&lt;span id=&quot;cb4-153&quot;&gt;&lt;a href=&quot;#cb4-153&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-154&quot;&gt;&lt;a href=&quot;#cb4-154&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;            &lt;span class=&quot;co&quot;&gt;# The 4 possible moves&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-155&quot;&gt;&lt;a href=&quot;#cb4-155&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-156&quot;&gt;&lt;a href=&quot;#cb4-156&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;            &lt;span class=&quot;co&quot;&gt;# Do vector addition of the variable state and [0, -1, 0, 0]&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-157&quot;&gt;&lt;a href=&quot;#cb4-157&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;            state_six &lt;span class=&quot;op&quot;&gt;=&lt;/span&gt; add_state(state,  [&lt;span class=&quot;dv&quot;&gt;0&lt;/span&gt;, &lt;span class=&quot;op&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;, &lt;span class=&quot;dv&quot;&gt;0&lt;/span&gt;, &lt;span class=&quot;dv&quot;&gt;0&lt;/span&gt;], forced_move&lt;span class=&quot;op&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;va&quot;&gt;False&lt;/span&gt;)&lt;/span&gt;
&lt;span id=&quot;cb4-158&quot;&gt;&lt;a href=&quot;#cb4-158&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;            state_free &lt;span class=&quot;op&quot;&gt;=&lt;/span&gt; add_state(state, [&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;, &lt;span class=&quot;op&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;, &lt;span class=&quot;dv&quot;&gt;0&lt;/span&gt;, &lt;span class=&quot;dv&quot;&gt;0&lt;/span&gt;], forced_move&lt;span class=&quot;op&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;va&quot;&gt;False&lt;/span&gt;)       &lt;/span&gt;
&lt;span id=&quot;cb4-159&quot;&gt;&lt;a href=&quot;#cb4-159&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;            state_occupied &lt;span class=&quot;op&quot;&gt;=&lt;/span&gt; swap(add_state(state, [&lt;span class=&quot;op&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;, &lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;, &lt;span class=&quot;dv&quot;&gt;0&lt;/span&gt;, &lt;span class=&quot;dv&quot;&gt;0&lt;/span&gt;], forced_move&lt;span class=&quot;op&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;va&quot;&gt;True&lt;/span&gt;))&lt;/span&gt;
&lt;span id=&quot;cb4-160&quot;&gt;&lt;a href=&quot;#cb4-160&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;            state_swap     &lt;span class=&quot;op&quot;&gt;=&lt;/span&gt; swap(state, forced_move&lt;span class=&quot;op&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;va&quot;&gt;True&lt;/span&gt;)                 &lt;/span&gt;
&lt;span id=&quot;cb4-161&quot;&gt;&lt;a href=&quot;#cb4-161&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;        &lt;/span&gt;
&lt;span id=&quot;cb4-162&quot;&gt;&lt;a href=&quot;#cb4-162&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;            &lt;span class=&quot;co&quot;&gt;# Number of sticks in the lid&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-163&quot;&gt;&lt;a href=&quot;#cb4-163&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;            i &lt;span class=&quot;op&quot;&gt;=&lt;/span&gt; state[&lt;span class=&quot;dv&quot;&gt;0&lt;/span&gt;]&lt;/span&gt;
&lt;span id=&quot;cb4-164&quot;&gt;&lt;a href=&quot;#cb4-164&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-165&quot;&gt;&lt;a href=&quot;#cb4-165&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;            &lt;span class=&quot;co&quot;&gt;#Q(s, continue)&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-166&quot;&gt;&lt;a href=&quot;#cb4-166&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;            qs_continue &lt;span class=&quot;op&quot;&gt;=&lt;/span&gt; (&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;op&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;6&lt;/span&gt;  &lt;span class=&quot;op&quot;&gt;*&lt;/span&gt; (R(state_six)  &lt;span class=&quot;op&quot;&gt;+&lt;/span&gt;  U(state_six))) &lt;span class=&quot;op&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;op&quot;&gt;\&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-167&quot;&gt;&lt;a href=&quot;#cb4-167&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;                        ((&lt;span class=&quot;dv&quot;&gt;5&lt;/span&gt;&lt;span class=&quot;op&quot;&gt;-&lt;/span&gt;i)&lt;span class=&quot;op&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;6&lt;/span&gt; &lt;span class=&quot;op&quot;&gt;*&lt;/span&gt; (R(state_free) &lt;span class=&quot;op&quot;&gt;+&lt;/span&gt;  U(state_free)) &lt;span class=&quot;cf&quot;&gt;if&lt;/span&gt; i&lt;span class=&quot;op&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;5&lt;/span&gt; &lt;span class=&quot;cf&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;dv&quot;&gt;0&lt;/span&gt;) &lt;span class=&quot;op&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;op&quot;&gt;\&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-168&quot;&gt;&lt;a href=&quot;#cb4-168&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;                        (i&lt;span class=&quot;op&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;6&lt;/span&gt;     &lt;span class=&quot;op&quot;&gt;*&lt;/span&gt; (R(state_occupied) &lt;span class=&quot;op&quot;&gt;-&lt;/span&gt; U(state_occupied)) &lt;span class=&quot;cf&quot;&gt;if&lt;/span&gt; i&lt;span class=&quot;op&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;cf&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;dv&quot;&gt;0&lt;/span&gt;)&lt;/span&gt;
&lt;span id=&quot;cb4-169&quot;&gt;&lt;a href=&quot;#cb4-169&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-170&quot;&gt;&lt;a href=&quot;#cb4-170&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;            &lt;span class=&quot;co&quot;&gt;#Q(s, stop)&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-171&quot;&gt;&lt;a href=&quot;#cb4-171&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;            qs_stop &lt;span class=&quot;op&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;op&quot;&gt;-&lt;/span&gt;(R(state_swap) &lt;span class=&quot;op&quot;&gt;+&lt;/span&gt; U(state_swap))&lt;/span&gt;
&lt;span id=&quot;cb4-172&quot;&gt;&lt;a href=&quot;#cb4-172&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-173&quot;&gt;&lt;a href=&quot;#cb4-173&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;            &lt;span class=&quot;co&quot;&gt;# Updated value &amp;amp; strategy if there is a choice.&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-174&quot;&gt;&lt;a href=&quot;#cb4-174&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;            &lt;span class=&quot;cf&quot;&gt;if&lt;/span&gt; (state[&lt;span class=&quot;dv&quot;&gt;3&lt;/span&gt;]&lt;span class=&quot;op&quot;&gt;==&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;0&lt;/span&gt;):&lt;/span&gt;
&lt;span id=&quot;cb4-175&quot;&gt;&lt;a href=&quot;#cb4-175&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;                U_vec_prime[idx] &lt;span class=&quot;op&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;bu&quot;&gt;max&lt;/span&gt;(qs_continue, qs_stop)&lt;/span&gt;
&lt;span id=&quot;cb4-176&quot;&gt;&lt;a href=&quot;#cb4-176&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;                pi[idx] &lt;span class=&quot;op&quot;&gt;=&lt;/span&gt; qs_continue &lt;span class=&quot;op&quot;&gt;&amp;gt;&lt;/span&gt; qs_stop&lt;/span&gt;
&lt;span id=&quot;cb4-177&quot;&gt;&lt;a href=&quot;#cb4-177&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;            &lt;span class=&quot;cf&quot;&gt;else&lt;/span&gt;: &lt;span class=&quot;co&quot;&gt;#no choice&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-178&quot;&gt;&lt;a href=&quot;#cb4-178&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;                U_vec_prime[idx] &lt;span class=&quot;op&quot;&gt;=&lt;/span&gt; qs_continue&lt;/span&gt;
&lt;span id=&quot;cb4-179&quot;&gt;&lt;a href=&quot;#cb4-179&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;                pi[idx] &lt;span class=&quot;op&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-180&quot;&gt;&lt;a href=&quot;#cb4-180&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-181&quot;&gt;&lt;a href=&quot;#cb4-181&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;            &lt;span class=&quot;co&quot;&gt;# Discrepancy  &lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-182&quot;&gt;&lt;a href=&quot;#cb4-182&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;            Delta &lt;span class=&quot;op&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;bu&quot;&gt;max&lt;/span&gt;(Delta, &lt;span class=&quot;bu&quot;&gt;abs&lt;/span&gt;(U_vec[idx] &lt;span class=&quot;op&quot;&gt;-&lt;/span&gt; U_vec_prime[idx]))&lt;/span&gt;
&lt;span id=&quot;cb4-183&quot;&gt;&lt;a href=&quot;#cb4-183&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-184&quot;&gt;&lt;a href=&quot;#cb4-184&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;        &lt;span class=&quot;co&quot;&gt;# Update the value function by copying the new values&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-185&quot;&gt;&lt;a href=&quot;#cb4-185&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;        &lt;span class=&quot;co&quot;&gt;# Note: In NumPy, using &amp;quot;=&amp;quot; would only make a reference to the new vector&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-186&quot;&gt;&lt;a href=&quot;#cb4-186&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;        &lt;span class=&quot;co&quot;&gt;# See https://www.geeksforgeeks.org/array-copying-in-python/&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-187&quot;&gt;&lt;a href=&quot;#cb4-187&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;        U_vec &lt;span class=&quot;op&quot;&gt;=&lt;/span&gt; U_vec_prime.copy()&lt;/span&gt;
&lt;span id=&quot;cb4-188&quot;&gt;&lt;a href=&quot;#cb4-188&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-189&quot;&gt;&lt;a href=&quot;#cb4-189&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;        &lt;span class=&quot;co&quot;&gt;# Continue the value iteration?  &lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-190&quot;&gt;&lt;a href=&quot;#cb4-190&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;        &lt;span class=&quot;cf&quot;&gt;if&lt;/span&gt; (debug):&lt;/span&gt;
&lt;span id=&quot;cb4-191&quot;&gt;&lt;a href=&quot;#cb4-191&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;            &lt;span class=&quot;bu&quot;&gt;print&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;quot;iter = &amp;quot;&lt;/span&gt;, &lt;span class=&quot;bu&quot;&gt;iter&lt;/span&gt;, &lt;span class=&quot;st&quot;&gt;&amp;quot;, Delta =&amp;quot;&lt;/span&gt;, Delta)  &lt;/span&gt;
&lt;span id=&quot;cb4-192&quot;&gt;&lt;a href=&quot;#cb4-192&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;        stop &lt;span class=&quot;op&quot;&gt;=&lt;/span&gt; (Delta &lt;span class=&quot;op&quot;&gt;&amp;lt;=&lt;/span&gt; epsilon)&lt;/span&gt;
&lt;span id=&quot;cb4-193&quot;&gt;&lt;a href=&quot;#cb4-193&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-194&quot;&gt;&lt;a href=&quot;#cb4-194&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;co&quot;&gt;# Make a tibble containing the strategy  &lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-195&quot;&gt;&lt;a href=&quot;#cb4-195&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    strategy &lt;span class=&quot;op&quot;&gt;=&lt;/span&gt; pd.DataFrame({&lt;span class=&quot;st&quot;&gt;&amp;#39;state&amp;#39;&lt;/span&gt;: states, &lt;span class=&quot;st&quot;&gt;&amp;#39;value&amp;#39;&lt;/span&gt;: U_vec, &lt;span class=&quot;st&quot;&gt;&amp;#39;strategy&amp;#39;&lt;/span&gt;: pi, &lt;span class=&quot;st&quot;&gt;&amp;#39;prob&amp;#39;&lt;/span&gt;: &lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;op&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;op&quot;&gt;*&lt;/span&gt;U_vec&lt;span class=&quot;op&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;op&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;})  &lt;/span&gt;
&lt;span id=&quot;cb4-196&quot;&gt;&lt;a href=&quot;#cb4-196&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;co&quot;&gt;# Split state column into 4 separate columns&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-197&quot;&gt;&lt;a href=&quot;#cb4-197&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    strategy[[&lt;span class=&quot;st&quot;&gt;&amp;#39;i&amp;#39;&lt;/span&gt;,&lt;span class=&quot;st&quot;&gt;&amp;#39;j&amp;#39;&lt;/span&gt;,&lt;span class=&quot;st&quot;&gt;&amp;#39;k&amp;#39;&lt;/span&gt;,&lt;span class=&quot;st&quot;&gt;&amp;#39;l&amp;#39;&lt;/span&gt;]] &lt;span class=&quot;op&quot;&gt;=&lt;/span&gt; pd.DataFrame(strategy.state.tolist(), index&lt;span class=&quot;op&quot;&gt;=&lt;/span&gt; strategy.index) &lt;/span&gt;
&lt;span id=&quot;cb4-198&quot;&gt;&lt;a href=&quot;#cb4-198&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;co&quot;&gt;# Drop the state column&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-199&quot;&gt;&lt;a href=&quot;#cb4-199&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    strategy &lt;span class=&quot;op&quot;&gt;=&lt;/span&gt; strategy.drop(columns&lt;span class=&quot;op&quot;&gt;=&lt;/span&gt;[&lt;span class=&quot;st&quot;&gt;&amp;#39;state&amp;#39;&lt;/span&gt;])&lt;/span&gt;
&lt;span id=&quot;cb4-200&quot;&gt;&lt;a href=&quot;#cb4-200&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;co&quot;&gt;# Convert strategy to boolean&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-201&quot;&gt;&lt;a href=&quot;#cb4-201&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    strategy[&lt;span class=&quot;st&quot;&gt;&amp;#39;strategy&amp;#39;&lt;/span&gt;] &lt;span class=&quot;op&quot;&gt;=&lt;/span&gt; strategy[&lt;span class=&quot;st&quot;&gt;&amp;#39;strategy&amp;#39;&lt;/span&gt;].astype(&lt;span class=&quot;bu&quot;&gt;bool&lt;/span&gt;)&lt;/span&gt;
&lt;span id=&quot;cb4-202&quot;&gt;&lt;a href=&quot;#cb4-202&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;co&quot;&gt;# Change the order such that the i,j,k,forced_move columns are shown first&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-203&quot;&gt;&lt;a href=&quot;#cb4-203&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    cols &lt;span class=&quot;op&quot;&gt;=&lt;/span&gt; strategy.columns.tolist()&lt;/span&gt;
&lt;span id=&quot;cb4-204&quot;&gt;&lt;a href=&quot;#cb4-204&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    cols &lt;span class=&quot;op&quot;&gt;=&lt;/span&gt; cols[&lt;span class=&quot;op&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;4&lt;/span&gt;:] &lt;span class=&quot;op&quot;&gt;+&lt;/span&gt; cols[:&lt;span class=&quot;op&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;4&lt;/span&gt;]&lt;/span&gt;
&lt;span id=&quot;cb4-205&quot;&gt;&lt;a href=&quot;#cb4-205&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    strategy &lt;span class=&quot;op&quot;&gt;=&lt;/span&gt; strategy[cols]&lt;/span&gt;
&lt;span id=&quot;cb4-206&quot;&gt;&lt;a href=&quot;#cb4-206&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-207&quot;&gt;&lt;a href=&quot;#cb4-207&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;cf&quot;&gt;return&lt;/span&gt;(strategy)&lt;/span&gt;
&lt;span id=&quot;cb4-208&quot;&gt;&lt;a href=&quot;#cb4-208&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-209&quot;&gt;&lt;a href=&quot;#cb4-209&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-210&quot;&gt;&lt;a href=&quot;#cb4-210&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;#Test function&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-211&quot;&gt;&lt;a href=&quot;#cb4-211&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;#make_situations(6)&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-212&quot;&gt;&lt;a href=&quot;#cb4-212&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-213&quot;&gt;&lt;a href=&quot;#cb4-213&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;# Find optimal strategy for game with 6 sticks left&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-214&quot;&gt;&lt;a href=&quot;#cb4-214&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;s_best &lt;span class=&quot;op&quot;&gt;=&lt;/span&gt; optimal_strategy(&lt;span class=&quot;dv&quot;&gt;7&lt;/span&gt;)&lt;/span&gt;
&lt;span id=&quot;cb4-215&quot;&gt;&lt;a href=&quot;#cb4-215&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;# Print full strategy without row number, https://stackoverflow.com/questions/52396477/printing-a-pandas-dataframe-without-row-number-index&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-216&quot;&gt;&lt;a href=&quot;#cb4-216&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;# pd.set_option(&amp;#39;display.max_rows&amp;#39;, None)&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-217&quot;&gt;&lt;a href=&quot;#cb4-217&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;# print(s_best.to_string(index=False))&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h2 class=&quot;unnumbered&quot; id=&quot;references&quot;&gt;References&lt;/h2&gt;
&lt;div id=&quot;refs&quot; class=&quot;references csl-bib-body hanging-indent&quot;
data-entry-spacing=&quot;0&quot; role=&quot;list&quot;&gt;
&lt;div id=&quot;ref-jehn2021&quot; class=&quot;csl-entry&quot; role=&quot;listitem&quot;&gt;
Jehn, Rüdiger. 2021. &lt;span&gt;“Optimum Strategies for the Game Super
Six.”&lt;/span&gt; arXiv. &lt;a
href=&quot;https://doi.org/10.48550/ARXIV.2109.10700&quot;&gt;https://doi.org/10.48550/ARXIV.2109.10700&lt;/a&gt;.
&lt;/div&gt;
&lt;div id=&quot;ref-russell_norvig2020&quot; class=&quot;csl-entry&quot; role=&quot;listitem&quot;&gt;
Russell, S. J., and P. Norvig. 2020. &lt;em&gt;Artificial Intelligence: A
Modern Approach&lt;/em&gt;. Pearson Series in Artificial Intelligence.
Pearson.
&lt;/div&gt;
&lt;div id=&quot;ref-sutton_burto2020&quot; class=&quot;csl-entry&quot; role=&quot;listitem&quot;&gt;
Sutton, Richard S., and Andrew G. Barto. 2020. &lt;em&gt;Reinforcement
Learning - an Introduction&lt;/em&gt;. 2nd ed. The MIT Press.
&lt;/div&gt;
&lt;/div&gt;
</description>
        <pubDate>Mon, 20 Mar 2023 00:00:00 +0100</pubDate>
        <link>https://mhoehle.github.io/blog/2023/03/20/dynprog.html</link>
        <guid isPermaLink="true">https://mhoehle.github.io/blog/2023/03/20/dynprog.html</guid>
        
        <category>rstats</category>
        
        <category>python</category>
        
        <category>dynamic programming</category>
        
        <category>reinforcement learning</category>
        
        <category>game theory</category>
        
        
      </item>
    
      <item>
        <title>How to Win a Game (or More) of Super Six</title>
        <description>&lt;h2 id=&quot;abstract&quot;&gt;Abstract:&lt;/h2&gt;
&lt;p&gt;We use simulation to analyse the family dicing game “Super Six”. In
particular we show that the person starting the game has a very high
chance of winning the game. Furthermore, a robust strategy to play
during the game is to keep throwing the dice regardless of the number of
free pits. In a mixed strategy landscape with more than two players this
seems to do better than a strategy extrapolated from the analytically
derived optimal strategy for the two player case.&lt;/p&gt;
&lt;center&gt;
&lt;img
src=&quot;/blog/figure/source/2023-03-13-super6/plot_favor_factor-1.png&quot; /&gt;
&lt;/center&gt;
&lt;p&gt;&lt;br&gt;
&lt;a rel=&quot;license&quot; href=&quot;http://creativecommons.org/licenses/by-sa/4.0/&quot;&gt;&lt;img alt=&quot;Creative Commons License&quot; style=&quot;border-width:0&quot; src=&quot;https://i.creativecommons.org/l/by-sa/4.0/88x31.png&quot;/&gt;&lt;/a&gt;
This work is licensed under a &lt;a rel=&quot;license&quot;
href=&quot;http://creativecommons.org/licenses/by-sa/4.0/&quot;&gt;Creative Commons
Attribution-ShareAlike 4.0 International License&lt;/a&gt;. The &lt;a
href=&quot;https://raw.githubusercontent.com/hoehleatsu/hoehleatsu.github.io/master/_source/2023-03-13-super6.Rmd&quot;&gt;R-markdown
source code&lt;/a&gt; of this blog is available under a &lt;a
href=&quot;https://www.gnu.org/licenses/gpl-3.0.html&quot;&gt;GNU General Public
License (GPL v3)&lt;/a&gt; license from GitHub.&lt;/p&gt;
&lt;h2 id=&quot;introduction&quot;&gt;Introduction&lt;/h2&gt;
&lt;p&gt;&lt;a
href=&quot;https://de-m-wikipedia-org.translate.goog/wiki/Super_Six_(Spiel)?_x_tr_sl=auto&amp;amp;_x_tr_tl=en&amp;amp;_x_tr_hl=de&amp;amp;_x_tr_pto=wapp&quot;&gt;&lt;strong&gt;Super
Six&lt;/strong&gt;&lt;/a&gt; is a dice game which can be played at all ages. It
consists of a container where the lid has 5 pits (labelled 1-5) and one
hole (labelled 6). Furthermore, each player gets a predetermined number
of sticks and a dice (see Fig.1). If a stick is put into pit 6 (the
hole) it falls into container and stays there.&lt;/p&gt;
&lt;center&gt;
&lt;figure&gt;
&lt;img src=&quot;/blog/figure/source/2023-03-13-super6/super6.jpg&quot;
alt=&quot;Figure 1: A snapshot of a Super 6 game with 2 players, who both initially started with 4 sticks.&quot; /&gt;
&lt;figcaption aria-hidden=&quot;true&quot;&gt;Figure 1: A snapshot of a Super 6 game
with 2 players, who both initially started with 4 sticks.&lt;/figcaption&gt;
&lt;/figure&gt;
&lt;/center&gt;
&lt;p&gt;The rules of the games are as follows: The sticks are distributed
among the players so that each player has exactly the same number of
sticks (say: 4). Each player throws the dice in turn going round in
clockwise direction. If a player throws a number and the corresponding
pit is empty, then he/she can insert one of his/her sticks into it. If
the pit is already occupied, however, then he/she must take the stick
and and add it to his/her own pile of sticks. The number 6 is a “lucky
throw”. With a 6, one can always place a stick into the hole labelled
No. 6 and it stays there. &lt;strong&gt;Note:&lt;/strong&gt; &lt;em&gt;During the first
round, each player is only allowed to throw the dice once. From the
second round on, each player can throw the dice as often as desired,
provided that one always managed to hit an empty pit. As soon as one
throws the number of an occupied pit, one must take the stick that is
located there and it is then the next players turn. Each player most
throw the dice at least once per round, but after the first throw he/she
can decide to stop throwing at any time in that round (that is also
before hitting an occupied pit). Once a player has no sticks left, the
game is over and he/she is the winner.&lt;/em&gt; This &lt;a
href=&quot;https://www.youtube.com/watch?v=yrYybddqRQs&quot;&gt;YouTube&lt;/a&gt; video by
&lt;a href=&quot;https://www.researchgate.net/profile/Ruediger-Jehn&quot;&gt;Rüdiger
Jehn&lt;/a&gt; shows a exemplary game play of Super Six.&lt;/p&gt;
&lt;p&gt;Empirical experience from playing a lot of Super 6 with the kids
raises the question if the game is really fair: Does the player starting
the game have a winning advantage? Furthermore, interest is in the
optimal strategy to play: Should one always continue to throw the dice
until one hits an occupied pit or should one stop playing once there are
only &lt;span class=&quot;math inline&quot;&gt;\(x\)&lt;/span&gt; out of the 5 pits free (with
&lt;span class=&quot;math inline&quot;&gt;\(x\)&lt;/span&gt; being either 1 or 2)? In what
follows we shall use simulation to get an approximate answer to these
questions in a realistic environment with different players following
different strategies. For a two player situation analytic results exist
&lt;span class=&quot;citation&quot; data-cites=&quot;jehn2021&quot;&gt;(Jehn 2021)&lt;/span&gt;.&lt;/p&gt;
&lt;h2 id=&quot;simulating-super-6&quot;&gt;Simulating Super 6&lt;/h2&gt;
&lt;p&gt;The file &lt;a
href=&quot;https://raw.githubusercontent.com/hoehleatsu/hoehleatsu.github.io/master/figure/source/2023-03-13-super6/super6.R&quot;&gt;&lt;code&gt;super6.R&lt;/code&gt;&lt;/a&gt;
contains a function &lt;code&gt;simulate_super6&lt;/code&gt; with arguments
&lt;code&gt;players_strategy&lt;/code&gt; and &lt;code&gt;sticks&lt;/code&gt; to simulate a game
of Super 6 for &lt;span
class=&quot;math inline&quot;&gt;\(n\)&lt;/span&gt;=&lt;code&gt;length(players_strategy)&lt;/code&gt;
players each initially having &lt;code&gt;sticks&lt;/code&gt; number of sticks. The
named list &lt;code&gt;players_strategy&lt;/code&gt; contains each player’s strategy
as a &lt;code&gt;tibble&lt;/code&gt;, mapping the number of free pits
(i.e. 0,1,2,3,4,5) to a probability to continue throwing the dice. If
this probability is either 0 or 1 then we have a deterministic strategy.
As an example the &lt;code&gt;always&lt;/code&gt; strategy describes a behaviour
where one keeps throwing the dice independent of the number of free
pits:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb1&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb1-1&quot;&gt;&lt;a href=&quot;#cb1-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;(always &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;tibble&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;filled_holes=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;5&lt;/span&gt;,   &lt;span class=&quot;at&quot;&gt;continue_prob=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;))&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;## # A tibble: 6 × 2
##   filled_holes continue_prob
##          &amp;lt;int&amp;gt;         &amp;lt;dbl&amp;gt;
## 1            0             1
## 2            1             1
## 3            2             1
## 4            3             1
## 5            4             1
## 6            5             1&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;As an example: To simulate a single game of Super 6 with three
players, A, B and C, each playing the “always” strategy with initially 4
sticks we call&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb3&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb3-1&quot;&gt;&lt;a href=&quot;#cb3-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;h &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;simulate_super6&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;list&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;A=&lt;/span&gt;always, &lt;span class=&quot;at&quot;&gt;B=&lt;/span&gt;always, &lt;span class=&quot;at&quot;&gt;C=&lt;/span&gt;always), &lt;span class=&quot;at&quot;&gt;sticks=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;4&lt;/span&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;The resulting trajectory of state and actions of the game are
returned by the function:&lt;/p&gt;
&lt;p&gt;
&lt;table class=&quot;table table-striped&quot; style=&quot;font-size: 14px; margin-left: auto; margin-right: auto;&quot;&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th style=&quot;border-bottom:hidden;padding-bottom:0; padding-left:3px;padding-right:3px;text-align: center; &quot; colspan=&quot;4&quot;&gt;
&lt;div style=&quot;border-bottom: 1px solid #ddd; padding-bottom: 5px; &quot;&gt;
Gameplay
&lt;/div&gt;
&lt;/th&gt;
&lt;th style=&quot;border-bottom:hidden;padding-bottom:0; padding-left:3px;padding-right:3px;text-align: center; &quot; colspan=&quot;6&quot;&gt;
&lt;div style=&quot;border-bottom: 1px solid #ddd; padding-bottom: 5px; &quot;&gt;
Pit Status
&lt;/div&gt;
&lt;/th&gt;
&lt;th style=&quot;border-bottom:hidden;padding-bottom:0; padding-left:3px;padding-right:3px;text-align: center; &quot; colspan=&quot;3&quot;&gt;
&lt;div style=&quot;border-bottom: 1px solid #ddd; padding-bottom: 5px; &quot;&gt;
Player Status
&lt;/div&gt;
&lt;/th&gt;
&lt;th style=&quot;border-bottom:hidden;padding-bottom:0; padding-left:3px;padding-right:3px;text-align: center; &quot; colspan=&quot;1&quot;&gt;
&lt;div style=&quot;border-bottom: 1px solid #ddd; padding-bottom: 5px; &quot;&gt;
Game Status
&lt;/div&gt;
&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;th style=&quot;text-align:center;&quot;&gt;
round
&lt;/th&gt;
&lt;th style=&quot;text-align:center;&quot;&gt;
player
&lt;/th&gt;
&lt;th style=&quot;text-align:center;&quot;&gt;
turn
&lt;/th&gt;
&lt;th style=&quot;text-align:center;&quot;&gt;
dice
&lt;/th&gt;
&lt;th style=&quot;text-align:center;&quot;&gt;
hole.1
&lt;/th&gt;
&lt;th style=&quot;text-align:center;&quot;&gt;
hole.2
&lt;/th&gt;
&lt;th style=&quot;text-align:center;&quot;&gt;
hole.3
&lt;/th&gt;
&lt;th style=&quot;text-align:center;&quot;&gt;
hole.4
&lt;/th&gt;
&lt;th style=&quot;text-align:center;&quot;&gt;
hole.5
&lt;/th&gt;
&lt;th style=&quot;text-align:center;&quot;&gt;
hole.6
&lt;/th&gt;
&lt;th style=&quot;text-align:center;&quot;&gt;
sticks.A
&lt;/th&gt;
&lt;th style=&quot;text-align:center;&quot;&gt;
sticks.B
&lt;/th&gt;
&lt;th style=&quot;text-align:center;&quot;&gt;
sticks.C
&lt;/th&gt;
&lt;th style=&quot;text-align:center;&quot;&gt;
decision
&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
1
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
C
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
1
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
6
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
0
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
0
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
0
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
0
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
0
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
1
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
4
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
4
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
3
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
stop turn
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
1
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
A
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
1
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
3
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
0
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
0
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
1
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
0
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
0
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
1
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
3
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
4
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
3
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
stop turn
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
1
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
B
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
1
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
2
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
0
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
1
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
1
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
0
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
0
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
1
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
3
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
3
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
3
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
stop turn
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
2
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
C
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
1
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
2
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
0
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
0
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
1
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
0
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
0
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
1
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
3
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
3
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
4
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
lost turn
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
2
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
A
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
1
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
6
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
0
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
0
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
1
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
0
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
0
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
2
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
2
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
3
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
4
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
continue turn
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
2
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
A
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
2
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
3
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
0
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
0
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
0
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
0
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
0
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
2
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
3
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
3
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
4
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
lost turn
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
2
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
B
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
1
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
5
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
0
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
0
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
0
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
0
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
1
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
2
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
3
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
2
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
4
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
continue turn
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
2
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
B
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
2
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
4
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
0
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
0
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
0
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
1
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
1
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
2
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
3
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
1
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
4
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
continue turn
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
2
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
B
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
3
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
6
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
0
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
0
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
0
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
1
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
1
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
3
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
3
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
0
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
4
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
game over
&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;
&lt;p&gt;Note that in the above game the player to start is randomly selected.
The players then each take turns in the pre-determined order. The order
of the rows in the table corresponds to the sequence of actions in the
game. The column &lt;code&gt;turn&lt;/code&gt; is a counter indicating how many
times the player has thrown the dice during his/her round. The columns
&lt;code&gt;hole.1&lt;/code&gt;-&lt;code&gt;hole.5&lt;/code&gt; are binary indicators whether
the respective pit is currently filled with a stick (FALSE=0, TRUE=1).
Finally, a column counts for each player the current number of remaining
sticks (initially equal to 4). The last column, &lt;code&gt;decision&lt;/code&gt;
contains information about the player’s action and its consequences.
Here, “stop turn” is a forced decision in round 1, because each player
can only throw the dice once in round 1. Furthermore, “lost turn”
indicates the situation that the pit indicated by the dice throw was
already occupied and “continue turn” means that the player based on
his/her strategy decided to throw again. Finally, “game over” means that
one player reduced their number of sticks to zero and the game thus
ends. The winner of the shown game shown is B.&lt;/p&gt;
&lt;h2 id=&quot;analysis&quot;&gt;Analysis&lt;/h2&gt;
&lt;p&gt;We can use the above simulation function to analyse different
strategies for games with 4 initial sticks. Consider the four additional
strategies:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb4&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb4-1&quot;&gt;&lt;a href=&quot;#cb4-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;go50 &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;tibble&lt;/span&gt;( &lt;span class=&quot;at&quot;&gt;filled_holes=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;5&lt;/span&gt;,   &lt;span class=&quot;at&quot;&gt;continue_prob=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;*&lt;/span&gt;(filled_holes&lt;span class=&quot;sc&quot;&gt;&amp;lt;=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;3&lt;/span&gt;))&lt;/span&gt;
&lt;span id=&quot;cb4-2&quot;&gt;&lt;a href=&quot;#cb4-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;go67 &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;tibble&lt;/span&gt;( &lt;span class=&quot;at&quot;&gt;filled_holes=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;5&lt;/span&gt;,   &lt;span class=&quot;at&quot;&gt;continue_prob=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;*&lt;/span&gt;(filled_holes&lt;span class=&quot;sc&quot;&gt;&amp;lt;=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;4&lt;/span&gt;))&lt;/span&gt;
&lt;span id=&quot;cb4-3&quot;&gt;&lt;a href=&quot;#cb4-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;random &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;tibble&lt;/span&gt;( &lt;span class=&quot;at&quot;&gt;filled_holes=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;5&lt;/span&gt;, &lt;span class=&quot;at&quot;&gt;continue_prob=&lt;/span&gt;&lt;span class=&quot;fl&quot;&gt;0.5&lt;/span&gt;)&lt;/span&gt;
&lt;span id=&quot;cb4-4&quot;&gt;&lt;a href=&quot;#cb4-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;random2 &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;tibble&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;filled_holes=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;5&lt;/span&gt;, &lt;span class=&quot;at&quot;&gt;continue_prob=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;c&lt;/span&gt;(&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;,&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;,&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;,&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;,&lt;span class=&quot;fl&quot;&gt;0.5&lt;/span&gt;,&lt;span class=&quot;fl&quot;&gt;0.25&lt;/span&gt;))&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Let’s assume that Agneta is playing the &lt;code&gt;always&lt;/code&gt; strategy
and that Bertil, Cecilia, Dagmar and Emil each are playing one of the
four other strategies.&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb5&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb5-1&quot;&gt;&lt;a href=&quot;#cb5-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;player_list &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;list&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;Agneta=&lt;/span&gt; always,&lt;/span&gt;
&lt;span id=&quot;cb5-2&quot;&gt;&lt;a href=&quot;#cb5-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;                    &lt;span class=&quot;at&quot;&gt;Birger=&lt;/span&gt; go50,&lt;/span&gt;
&lt;span id=&quot;cb5-3&quot;&gt;&lt;a href=&quot;#cb5-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;                    &lt;span class=&quot;at&quot;&gt;Carin=&lt;/span&gt;  go67,&lt;/span&gt;
&lt;span id=&quot;cb5-4&quot;&gt;&lt;a href=&quot;#cb5-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;                    &lt;span class=&quot;at&quot;&gt;Dagmar=&lt;/span&gt; random,&lt;/span&gt;
&lt;span id=&quot;cb5-5&quot;&gt;&lt;a href=&quot;#cb5-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;                    &lt;span class=&quot;at&quot;&gt;Emil=&lt;/span&gt;   random2)&lt;/span&gt;
&lt;span id=&quot;cb5-6&quot;&gt;&lt;a href=&quot;#cb5-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;player_names &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;names&lt;/span&gt;(player_list)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;We now consider all possible matches of these players. This can be
games ranging from just 2 of the players to all 5 of them.&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb6&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb6-1&quot;&gt;&lt;a href=&quot;#cb6-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;n_players &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;dt&quot;&gt;L&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;length&lt;/span&gt;(player_names)&lt;/span&gt;
&lt;span id=&quot;cb6-2&quot;&gt;&lt;a href=&quot;#cb6-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;matches &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;map&lt;/span&gt;(n_players, &lt;span class=&quot;cf&quot;&gt;function&lt;/span&gt;(m) {&lt;/span&gt;
&lt;span id=&quot;cb6-3&quot;&gt;&lt;a href=&quot;#cb6-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  utils&lt;span class=&quot;sc&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;combn&lt;/span&gt;(player_names, &lt;span class=&quot;at&quot;&gt;m=&lt;/span&gt;m, &lt;span class=&quot;at&quot;&gt;simplify=&lt;/span&gt;&lt;span class=&quot;cn&quot;&gt;FALSE&lt;/span&gt;)&lt;/span&gt;
&lt;span id=&quot;cb6-4&quot;&gt;&lt;a href=&quot;#cb6-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;}) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;setNames&lt;/span&gt;(n_players)&lt;/span&gt;
&lt;span id=&quot;cb6-5&quot;&gt;&lt;a href=&quot;#cb6-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;n_combos &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;map&lt;/span&gt;(matches, length)&lt;/span&gt;
&lt;span id=&quot;cb6-6&quot;&gt;&lt;a href=&quot;#cb6-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;n_combos &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;unlist&lt;/span&gt;()&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;##  2  3  4  5 
## 10 10  5  1&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;To ensure that the we consider an equal amount of games for every
number of players, we simulate &lt;code&gt;n_games&lt;/code&gt; games for each
number of players (2-5). The games to play are then distributed equal
among the different pairings with that number of players. For this
reason, &lt;code&gt;n_games&lt;/code&gt; has to be divisible by 5 and 10.&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb8&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb8-1&quot;&gt;&lt;a href=&quot;#cb8-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;n_games &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;dv&quot;&gt;10000&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb8-2&quot;&gt;&lt;a href=&quot;#cb8-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb8-3&quot;&gt;&lt;a href=&quot;#cb8-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;# Parallelize analysis using the future-verse&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb8-4&quot;&gt;&lt;a href=&quot;#cb8-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;plan&lt;/span&gt;(multisession, &lt;span class=&quot;at&quot;&gt;workers =&lt;/span&gt; &lt;span class=&quot;dv&quot;&gt;4&lt;/span&gt;)&lt;/span&gt;
&lt;span id=&quot;cb8-5&quot;&gt;&lt;a href=&quot;#cb8-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb8-6&quot;&gt;&lt;a href=&quot;#cb8-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;# Play the games&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb8-7&quot;&gt;&lt;a href=&quot;#cb8-7&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;all_games &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;future_map2&lt;/span&gt;(matches, n_combos,  &lt;span class=&quot;cf&quot;&gt;function&lt;/span&gt;(names, combos) {&lt;/span&gt;
&lt;span id=&quot;cb8-8&quot;&gt;&lt;a href=&quot;#cb8-8&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;map&lt;/span&gt;(names, &lt;span class=&quot;sc&quot;&gt;~&lt;/span&gt; {&lt;/span&gt;
&lt;span id=&quot;cb8-9&quot;&gt;&lt;a href=&quot;#cb8-9&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    the_players_strategy &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; player_list[.x]&lt;/span&gt;
&lt;span id=&quot;cb8-10&quot;&gt;&lt;a href=&quot;#cb8-10&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;co&quot;&gt;# Divide the n_games equal among the possible combinations&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb8-11&quot;&gt;&lt;a href=&quot;#cb8-11&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    n_games_each_combo &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; n_games &lt;span class=&quot;sc&quot;&gt;/&lt;/span&gt; combos&lt;/span&gt;
&lt;span id=&quot;cb8-12&quot;&gt;&lt;a href=&quot;#cb8-12&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;fu&quot;&gt;map&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;seq_len&lt;/span&gt;(n_games_each_combo), &lt;span class=&quot;sc&quot;&gt;~&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb8-13&quot;&gt;&lt;a href=&quot;#cb8-13&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;          &lt;span class=&quot;fu&quot;&gt;simulate_super6&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;players_strategy=&lt;/span&gt;the_players_strategy, &lt;span class=&quot;at&quot;&gt;sticks=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;4&lt;/span&gt;)&lt;/span&gt;
&lt;span id=&quot;cb8-14&quot;&gt;&lt;a href=&quot;#cb8-14&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    )&lt;/span&gt;
&lt;span id=&quot;cb8-15&quot;&gt;&lt;a href=&quot;#cb8-15&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  }) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;setNames&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;map&lt;/span&gt;(names, &lt;span class=&quot;sc&quot;&gt;~&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;str_c&lt;/span&gt;(.x, &lt;span class=&quot;at&quot;&gt;collapse=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;-&amp;quot;&lt;/span&gt;)))&lt;/span&gt;
&lt;span id=&quot;cb8-16&quot;&gt;&lt;a href=&quot;#cb8-16&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;}, &lt;span class=&quot;at&quot;&gt;.options=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;furrr_options&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;seed=&lt;/span&gt;&lt;span class=&quot;cn&quot;&gt;TRUE&lt;/span&gt;))&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;This provides a nested list structure, where the top-most level
contains the number of players of the game, the 2nd level contains the
name of the participating players and the 3rd level the recordings of
every game played of the respective player combination (organised as a
tibble). The recordings/history of each game is organised as a data
frame with columns closely related to the above game description. As an
example, a total of&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb9&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb9-1&quot;&gt;&lt;a href=&quot;#cb9-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;all_games[[&lt;span class=&quot;st&quot;&gt;&amp;quot;3&amp;quot;&lt;/span&gt;]][[&lt;span class=&quot;st&quot;&gt;&amp;quot;Agneta-Birger-Carin&amp;quot;&lt;/span&gt;]] &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;length&lt;/span&gt;()&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;## [1] 1000&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;games (=10000/10) are played between the players Agneta, Birger and
Carin.&lt;/p&gt;
&lt;p&gt;We now use this nested list structure of simulated games to answer
our questions of interest. The traversing of the list is done by purrr.
As an example we determine the total number of games as follows:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb11&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb11-1&quot;&gt;&lt;a href=&quot;#cb11-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;(n_total_games &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;map&lt;/span&gt;(all_games, &lt;span class=&quot;sc&quot;&gt;~&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;map&lt;/span&gt;(.x, length)) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;unlist&lt;/span&gt;() &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;sum&lt;/span&gt;())&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;## [1] 40000&lt;/code&gt;&lt;/pre&gt;
&lt;h3 id=&quot;beginner-is-winner&quot;&gt;Beginner is Winner?&lt;/h3&gt;
&lt;p&gt;We now investigate the probability to win the starting player. Let
&lt;code&gt;h&lt;/code&gt; denote the tibble describing the history of a game (such
as shown above). We will write a function, which given the history of a
game returns the player name who won the game.&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb13&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb13-1&quot;&gt;&lt;a href=&quot;#cb13-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;winner &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;cf&quot;&gt;function&lt;/span&gt;(h) {&lt;/span&gt;
&lt;span id=&quot;cb13-2&quot;&gt;&lt;a href=&quot;#cb13-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  h &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;slice_tail&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;n=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;pull&lt;/span&gt;(player)&lt;/span&gt;
&lt;span id=&quot;cb13-3&quot;&gt;&lt;a href=&quot;#cb13-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;}&lt;/span&gt;
&lt;span id=&quot;cb13-4&quot;&gt;&lt;a href=&quot;#cb13-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb13-5&quot;&gt;&lt;a href=&quot;#cb13-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;## Test the function on the above shown trajectory&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb13-6&quot;&gt;&lt;a href=&quot;#cb13-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;winner&lt;/span&gt;(h)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;## [1] &amp;quot;B&amp;quot;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;We can use the function to determine the probability that the player
starting the game also becomes the winner of the game. To take into
account a possible dependence on the number of players we shall stratify
our analysis by the number of players in the game.&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb15&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb15-1&quot;&gt;&lt;a href=&quot;#cb15-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;games_summary &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;map2_df&lt;/span&gt;(all_games, n_players, &lt;span class=&quot;cf&quot;&gt;function&lt;/span&gt;(games, players) {&lt;/span&gt;
&lt;span id=&quot;cb15-2&quot;&gt;&lt;a href=&quot;#cb15-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;map_df&lt;/span&gt;(games, &lt;span class=&quot;sc&quot;&gt;~&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;map_df&lt;/span&gt;(.x, &lt;span class=&quot;sc&quot;&gt;~&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;tibble&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;n_players=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;as.numeric&lt;/span&gt;(players), &lt;/span&gt;
&lt;span id=&quot;cb15-3&quot;&gt;&lt;a href=&quot;#cb15-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;                        &lt;span class=&quot;at&quot;&gt;beginner=&lt;/span&gt;.x &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;slice_head&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;n=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;pull&lt;/span&gt;(player),&lt;/span&gt;
&lt;span id=&quot;cb15-4&quot;&gt;&lt;a href=&quot;#cb15-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;                          &lt;span class=&quot;at&quot;&gt;winner=&lt;/span&gt;.x &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;slice_tail&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;n=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;pull&lt;/span&gt;(player))))&lt;/span&gt;
&lt;span id=&quot;cb15-5&quot;&gt;&lt;a href=&quot;#cb15-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;})&lt;/span&gt;
&lt;span id=&quot;cb15-6&quot;&gt;&lt;a href=&quot;#cb15-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb15-7&quot;&gt;&lt;a href=&quot;#cb15-7&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;tab &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; games_summary &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;group_by&lt;/span&gt;(n_players) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb15-8&quot;&gt;&lt;a href=&quot;#cb15-8&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;summarise&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;p_initial_winner=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;mean&lt;/span&gt;(beginner&lt;span class=&quot;sc&quot;&gt;==&lt;/span&gt;winner)) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb15-9&quot;&gt;&lt;a href=&quot;#cb15-9&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;mutate&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;p_random =&lt;/span&gt; &lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;/&lt;/span&gt;n_players,&lt;/span&gt;
&lt;span id=&quot;cb15-10&quot;&gt;&lt;a href=&quot;#cb15-10&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;         &lt;span class=&quot;at&quot;&gt;favor_factor =&lt;/span&gt; p_initial_winner &lt;span class=&quot;sc&quot;&gt;/&lt;/span&gt; p_random) &lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th style=&quot;text-align:center;&quot;&gt;
n_players
&lt;/th&gt;
&lt;th style=&quot;text-align:center;&quot;&gt;
p_initial_winner
&lt;/th&gt;
&lt;th style=&quot;text-align:center;&quot;&gt;
p_random
&lt;/th&gt;
&lt;th style=&quot;text-align:center;&quot;&gt;
favor_factor
&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
2
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
0.6009
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
0.5000000
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
1.2018
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
3
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
0.4438
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
0.3333333
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
1.3314
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
4
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
0.3527
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
0.2500000
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
1.4108
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
5
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
0.2970
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
0.2000000
&lt;/td&gt;
&lt;td style=&quot;text-align:center;&quot;&gt;
1.4850
&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;&lt;img src=&quot;/blog/figure/source/2023-03-13-super6/plot_favor_factor-1.png&quot; style=&quot;display: block; margin: auto;&quot; /&gt;&lt;/p&gt;
&lt;p&gt;The empirical probability that the initial player wins is always
higher than the probability &lt;span class=&quot;math inline&quot;&gt;\(1/n\)&lt;/span&gt;
that one of the &lt;span class=&quot;math inline&quot;&gt;\(n\)&lt;/span&gt; players in the
game wins at random. The larger the number of players the bigger the
relative advantage of beginning seems. Note that our analysis averages
over the all strategies so it also contains start players using an
otherwise sub-optimal playing strategy. This might bias the analysis
slightly, but a small sensitivity analysis letting all 5 players play
the &lt;code&gt;always&lt;/code&gt; strategy, showed that results did not change
substantially.&lt;/p&gt;
&lt;h3 id=&quot;best-strategy&quot;&gt;Best strategy&lt;/h3&gt;
&lt;p&gt;We can now compute for each player (i.e. strategy) the number of wins
out of the 40000 games:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb16&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb16-1&quot;&gt;&lt;a href=&quot;#cb16-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;(league_table &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;map&lt;/span&gt;(all_games, &lt;span class=&quot;sc&quot;&gt;~&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;map&lt;/span&gt;(.x, &lt;span class=&quot;sc&quot;&gt;~&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;map&lt;/span&gt;(.x, winner))) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;/span&gt;
&lt;span id=&quot;cb16-2&quot;&gt;&lt;a href=&quot;#cb16-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;unlist&lt;/span&gt;() &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;/span&gt;
&lt;span id=&quot;cb16-3&quot;&gt;&lt;a href=&quot;#cb16-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;as_tibble&lt;/span&gt;() &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb16-4&quot;&gt;&lt;a href=&quot;#cb16-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;rename&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;player =&lt;/span&gt; value) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb16-5&quot;&gt;&lt;a href=&quot;#cb16-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;group_by&lt;/span&gt;(player) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb16-6&quot;&gt;&lt;a href=&quot;#cb16-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;summarise&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;wins=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;n&lt;/span&gt;()) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb16-7&quot;&gt;&lt;a href=&quot;#cb16-7&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;arrange&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;desc&lt;/span&gt;(wins)))&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;## # A tibble: 5 × 2
##   player  wins
##   &amp;lt;chr&amp;gt;  &amp;lt;int&amp;gt;
## 1 Birger  8800
## 2 Carin   8593
## 3 Emil    8520
## 4 Agneta  8419
## 5 Dagmar  5668&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;This shows that the &lt;code&gt;always&lt;/code&gt; strategy appears to do best
among those strategies investigated. It is no surprise that the worst
strategy is the purely random strategy &lt;code&gt;random&lt;/code&gt;.&lt;/p&gt;
&lt;h2 id=&quot;discussion&quot;&gt;Discussion&lt;/h2&gt;
&lt;p&gt;We analysed aspects of how to win a game (or more) of Super Six.
Important factors for winning in a multi-player mixed strategy landscape
are&lt;/p&gt;
&lt;ol type=&quot;1&quot;&gt;
&lt;li&gt;To start the game&lt;/li&gt;
&lt;li&gt;To keep throwing the dice&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;A little surprising is that the best strategy (among those
investigated) is to keep throwing the dice regardless of the number of
free pits. The optimal strategy may in part depend on how the other
players play, but our conclusions appear sufficiently robust, because
the simulation study investigated a mixed strategy player field with two
to five players. A limitation of our analysis is that we only considered
games where each player initially holds 4 sticks.&lt;/p&gt;
&lt;p&gt;It is worth pointing out that the best strategy we found is not
optimal. As an example, &lt;span class=&quot;citation&quot;
data-cites=&quot;jehn2021&quot;&gt;Jehn (2021)&lt;/span&gt; analytically finds the optimal
strategy for the &lt;span class=&quot;math inline&quot;&gt;\(n=2\)&lt;/span&gt; player
situation. It depends on the number of sticks left in the game and the
number of sticks each player has. In most cases the strategy stops if
more than 3 pits are occupied – see Appendix 1 for details. This
dependence on the other player’s hand is likely to carry forward to the
&lt;span class=&quot;math inline&quot;&gt;\(n&amp;gt;2\)&lt;/span&gt; player situation. However,
analytic results for &lt;span class=&quot;math inline&quot;&gt;\(n&amp;gt;2\)&lt;/span&gt; will be
extremely difficult to obtain, but it makes intuitive sense to be more
aggressive when there are more players, because there are more
contestants for the win.&lt;/p&gt;
&lt;p&gt;Did the game developers realize that the start player has such a high
probability of winning the game? It seems advisable to accompany game
development by simulations and mathematical calculations at the design
stage. In practice, one should randomize the start player to enhance
fairness.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Final note&lt;/strong&gt;: This will be the last post of &lt;em&gt;Theory
Meets Practice&lt;/em&gt; Blog in its current form. As of Jan 2023 I am
working as full professor in Statistics and Data Science at the &lt;a
href=&quot;https://math-inf.uni-greifswald.de/en/michael-hoehle/&quot;&gt;University
of Greifswald&lt;/a&gt;, Germany. For both technical and time reasons a new
setup is thus needed.&lt;/p&gt;
&lt;h2 id=&quot;appendix-1&quot;&gt;Appendix 1&lt;/h2&gt;
&lt;p&gt;The work of &lt;span class=&quot;citation&quot; data-cites=&quot;jehn2021&quot;&gt;Jehn
(2021)&lt;/span&gt; shows the derivation of the optimal strategies encoded in
&lt;a href=&quot;https://oeis.org/A345383&quot;&gt;A345383&lt;/a&gt; for a game with 2 players
and a situation where &lt;span class=&quot;math inline&quot;&gt;\(i\)&lt;/span&gt; pits
occupied, the first player (our player of interest) has &lt;span
class=&quot;math inline&quot;&gt;\(j\)&lt;/span&gt; sticks in hand and the second player
has &lt;span class=&quot;math inline&quot;&gt;\(k\)&lt;/span&gt; sticks. This state is denoted
as &lt;span class=&quot;math inline&quot;&gt;\(i/j/k\)&lt;/span&gt;. For example &lt;span
class=&quot;math inline&quot;&gt;\(2/1/1\)&lt;/span&gt; denotes the situation where there
are 2 pits occupied in the lid and each player has one stick.&lt;/p&gt;
&lt;p&gt;A small helper function gives all states where a continue vs. stop
choice needs to be made. It is assumed that if there are no sticks in
the lid, we always continue:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb18&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb18-1&quot;&gt;&lt;a href=&quot;#cb18-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;#&amp;#39; Find all situations where a continue vs. stop choice is to be made&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb18-2&quot;&gt;&lt;a href=&quot;#cb18-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;#&amp;#39; for player 1.&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb18-3&quot;&gt;&lt;a href=&quot;#cb18-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;#&amp;#39; &lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb18-4&quot;&gt;&lt;a href=&quot;#cb18-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;#&amp;#39; See Jehn (2021), https://arxiv.org/pdf/2109.10700.pdf, for details.&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb18-5&quot;&gt;&lt;a href=&quot;#cb18-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;#&amp;#39; &lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb18-6&quot;&gt;&lt;a href=&quot;#cb18-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;#&amp;#39; @param n Total number of sticks currently (i+j+k)&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb18-7&quot;&gt;&lt;a href=&quot;#cb18-7&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;#&amp;#39; @return A vector of strings describing the situations in i/j/k notation&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb18-8&quot;&gt;&lt;a href=&quot;#cb18-8&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;#&amp;#39; where i is the number of occupied pits in the lid, j is the number of&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb18-9&quot;&gt;&lt;a href=&quot;#cb18-9&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;#&amp;#39; sticks player 1 has and k is the number of sticks player 2 has. Note&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb18-10&quot;&gt;&lt;a href=&quot;#cb18-10&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;#&amp;#39; i+j+k = n&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb18-11&quot;&gt;&lt;a href=&quot;#cb18-11&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;#&amp;#39; &lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb18-12&quot;&gt;&lt;a href=&quot;#cb18-12&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;situations &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;cf&quot;&gt;function&lt;/span&gt;(n) {&lt;/span&gt;
&lt;span id=&quot;cb18-13&quot;&gt;&lt;a href=&quot;#cb18-13&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  res &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;cn&quot;&gt;NULL&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb18-14&quot;&gt;&lt;a href=&quot;#cb18-14&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;co&quot;&gt;# Sticks in the Lid&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb18-15&quot;&gt;&lt;a href=&quot;#cb18-15&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;cf&quot;&gt;for&lt;/span&gt; (i &lt;span class=&quot;cf&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;min&lt;/span&gt;(n,&lt;span class=&quot;dv&quot;&gt;5&lt;/span&gt;)&lt;span class=&quot;sc&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;) {&lt;/span&gt;
&lt;span id=&quot;cb18-16&quot;&gt;&lt;a href=&quot;#cb18-16&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;co&quot;&gt;# Sticks Player 1&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb18-17&quot;&gt;&lt;a href=&quot;#cb18-17&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;cf&quot;&gt;for&lt;/span&gt; (j &lt;span class=&quot;cf&quot;&gt;in&lt;/span&gt; n&lt;span class=&quot;sc&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;) {&lt;/span&gt;
&lt;span id=&quot;cb18-18&quot;&gt;&lt;a href=&quot;#cb18-18&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;      &lt;span class=&quot;co&quot;&gt;# Sticks Player 2&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb18-19&quot;&gt;&lt;a href=&quot;#cb18-19&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;      k &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; n &lt;span class=&quot;sc&quot;&gt;-&lt;/span&gt; i &lt;span class=&quot;sc&quot;&gt;-&lt;/span&gt; j&lt;/span&gt;
&lt;span id=&quot;cb18-20&quot;&gt;&lt;a href=&quot;#cb18-20&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;      &lt;span class=&quot;co&quot;&gt;# Don&amp;#39;t consider impossible situations or situations without a choice&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb18-21&quot;&gt;&lt;a href=&quot;#cb18-21&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;      &lt;span class=&quot;cf&quot;&gt;if&lt;/span&gt; (k&lt;span class=&quot;sc&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;0&lt;/span&gt;  &lt;span class=&quot;sc&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;sc&quot;&gt;!&lt;/span&gt;(i&lt;span class=&quot;sc&quot;&gt;==&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;sc&quot;&gt;&amp;amp;&lt;/span&gt; j&lt;span class=&quot;sc&quot;&gt;==&lt;/span&gt;k)) {&lt;/span&gt;
&lt;span id=&quot;cb18-22&quot;&gt;&lt;a href=&quot;#cb18-22&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;        res &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;append&lt;/span&gt;(res, &lt;span class=&quot;fu&quot;&gt;str_c&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;c&lt;/span&gt;(i,j,k), &lt;span class=&quot;at&quot;&gt;collapse=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;/&amp;quot;&lt;/span&gt;))&lt;/span&gt;
&lt;span id=&quot;cb18-23&quot;&gt;&lt;a href=&quot;#cb18-23&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;      }&lt;/span&gt;
&lt;span id=&quot;cb18-24&quot;&gt;&lt;a href=&quot;#cb18-24&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    }&lt;/span&gt;
&lt;span id=&quot;cb18-25&quot;&gt;&lt;a href=&quot;#cb18-25&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  }&lt;/span&gt;
&lt;span id=&quot;cb18-26&quot;&gt;&lt;a href=&quot;#cb18-26&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;return&lt;/span&gt;(res)&lt;/span&gt;
&lt;span id=&quot;cb18-27&quot;&gt;&lt;a href=&quot;#cb18-27&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;}&lt;/span&gt;
&lt;span id=&quot;cb18-28&quot;&gt;&lt;a href=&quot;#cb18-28&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb18-29&quot;&gt;&lt;a href=&quot;#cb18-29&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;# All situations when there are 7 sticks left in the game&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb18-30&quot;&gt;&lt;a href=&quot;#cb18-30&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;situations&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;n=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;7&lt;/span&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;##  [1] &amp;quot;5/1/1&amp;quot; &amp;quot;4/2/1&amp;quot; &amp;quot;4/1/2&amp;quot; &amp;quot;3/3/1&amp;quot; &amp;quot;3/2/2&amp;quot; &amp;quot;3/1/3&amp;quot; &amp;quot;2/4/1&amp;quot; &amp;quot;2/3/2&amp;quot; &amp;quot;2/2/3&amp;quot; &amp;quot;2/1/4&amp;quot; &amp;quot;1/5/1&amp;quot; &amp;quot;1/4/2&amp;quot; &amp;quot;1/3/3&amp;quot; &amp;quot;1/2/4&amp;quot; &amp;quot;1/1/5&amp;quot;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;The optimal strategy is encoded in binary and converted to base 10 in
the sequence &lt;a href=&quot;https://oeis.org/A345383&quot;&gt;A345383&lt;/a&gt;. We write a
small R extractor to display the optimal strategy in more readable
form:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb20&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb20-1&quot;&gt;&lt;a href=&quot;#cb20-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;## Handle the large integers using the GMP library&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb20-2&quot;&gt;&lt;a href=&quot;#cb20-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;suppressPackageStartupMessages&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;library&lt;/span&gt;(gmp))&lt;/span&gt;
&lt;span id=&quot;cb20-3&quot;&gt;&lt;a href=&quot;#cb20-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb20-4&quot;&gt;&lt;a href=&quot;#cb20-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;#&amp;#39; Encodes [A345383](https://oeis.org/A345383)&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb20-5&quot;&gt;&lt;a href=&quot;#cb20-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;#&amp;#39; &lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb20-6&quot;&gt;&lt;a href=&quot;#cb20-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;#&amp;#39; @param n Number of sticks&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb20-7&quot;&gt;&lt;a href=&quot;#cb20-7&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;#&amp;#39; @returns a(n) from A345383&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb20-8&quot;&gt;&lt;a href=&quot;#cb20-8&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;#&amp;#39; &lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb20-9&quot;&gt;&lt;a href=&quot;#cb20-9&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;a &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;cf&quot;&gt;function&lt;/span&gt;(n) {&lt;/span&gt;
&lt;span id=&quot;cb20-10&quot;&gt;&lt;a href=&quot;#cb20-10&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  a &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;as.bigz&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;c&lt;/span&gt;(&lt;span class=&quot;dv&quot;&gt;0&lt;/span&gt;, &lt;span class=&quot;dv&quot;&gt;0&lt;/span&gt;, &lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;, &lt;span class=&quot;dv&quot;&gt;7&lt;/span&gt;, &lt;span class=&quot;dv&quot;&gt;63&lt;/span&gt;, &lt;span class=&quot;dv&quot;&gt;1023&lt;/span&gt;, &lt;span class=&quot;dv&quot;&gt;32760&lt;/span&gt;, &lt;span class=&quot;dv&quot;&gt;1048544&lt;/span&gt;, &lt;span class=&quot;dv&quot;&gt;33554304&lt;/span&gt;, &lt;span class=&quot;dv&quot;&gt;1073741312&lt;/span&gt;, &lt;span class=&quot;dv&quot;&gt;34359736320&lt;/span&gt;, &lt;span class=&quot;dv&quot;&gt;1099511619584&lt;/span&gt;, &lt;span class=&quot;dv&quot;&gt;35184370221056&lt;/span&gt;, &lt;span class=&quot;dv&quot;&gt;1125899873681408&lt;/span&gt;, &lt;span class=&quot;dv&quot;&gt;36028796752101376&lt;/span&gt;))&lt;/span&gt;
&lt;span id=&quot;cb20-11&quot;&gt;&lt;a href=&quot;#cb20-11&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;cf&quot;&gt;if&lt;/span&gt; (n&lt;span class=&quot;sc&quot;&gt;&amp;gt;=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;sc&quot;&gt;&amp;amp;&lt;/span&gt; n&lt;span class=&quot;sc&quot;&gt;&amp;lt;=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;15&lt;/span&gt;) &lt;span class=&quot;fu&quot;&gt;return&lt;/span&gt;(a[n]) &lt;span class=&quot;cf&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;return&lt;/span&gt;(&lt;span class=&quot;cn&quot;&gt;NA&lt;/span&gt;)&lt;/span&gt;
&lt;span id=&quot;cb20-12&quot;&gt;&lt;a href=&quot;#cb20-12&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;}&lt;/span&gt;
&lt;span id=&quot;cb20-13&quot;&gt;&lt;a href=&quot;#cb20-13&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb20-14&quot;&gt;&lt;a href=&quot;#cb20-14&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;#&amp;#39; Convert a strategy encoded as a 0/1 string to a vector of Booleans&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb20-15&quot;&gt;&lt;a href=&quot;#cb20-15&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;#&amp;#39; @param s The strategy as a string of 0 and 1&amp;#39;s&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb20-16&quot;&gt;&lt;a href=&quot;#cb20-16&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;#&amp;#39; @return As a vector&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb20-17&quot;&gt;&lt;a href=&quot;#cb20-17&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;#&amp;#39; @examples&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb20-18&quot;&gt;&lt;a href=&quot;#cb20-18&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;#&amp;#39; int_strategy_to_vec(&amp;quot;0011&amp;quot;)&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb20-19&quot;&gt;&lt;a href=&quot;#cb20-19&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;int_strategy_to_vec &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;cf&quot;&gt;function&lt;/span&gt;(s) {&lt;/span&gt;
&lt;span id=&quot;cb20-20&quot;&gt;&lt;a href=&quot;#cb20-20&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;str_split_1&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;as.character&lt;/span&gt;(s, &lt;span class=&quot;at&quot;&gt;b=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;), &lt;span class=&quot;at&quot;&gt;pattern=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;&amp;quot;&lt;/span&gt;) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;as.integer&lt;/span&gt;()&lt;/span&gt;
&lt;span id=&quot;cb20-21&quot;&gt;&lt;a href=&quot;#cb20-21&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;}&lt;/span&gt;
&lt;span id=&quot;cb20-22&quot;&gt;&lt;a href=&quot;#cb20-22&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;/span&gt;
&lt;span id=&quot;cb20-23&quot;&gt;&lt;a href=&quot;#cb20-23&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;#&amp;#39; Show the optimal stragegy for all situations with n sticks&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb20-24&quot;&gt;&lt;a href=&quot;#cb20-24&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;optimal_strategy &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;cf&quot;&gt;function&lt;/span&gt;(n) {&lt;/span&gt;
&lt;span id=&quot;cb20-25&quot;&gt;&lt;a href=&quot;#cb20-25&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;co&quot;&gt;# Make a tibble representing the optimal strategy&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb20-26&quot;&gt;&lt;a href=&quot;#cb20-26&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;tibble&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;situation=&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;situations&lt;/span&gt;(n),&lt;/span&gt;
&lt;span id=&quot;cb20-27&quot;&gt;&lt;a href=&quot;#cb20-27&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;         &lt;span class=&quot;at&quot;&gt;continue =&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;rev&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;int_strategy_to_vec&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;a&lt;/span&gt;(n))))&lt;/span&gt;
&lt;span id=&quot;cb20-28&quot;&gt;&lt;a href=&quot;#cb20-28&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;}&lt;/span&gt;
&lt;span id=&quot;cb20-29&quot;&gt;&lt;a href=&quot;#cb20-29&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb20-30&quot;&gt;&lt;a href=&quot;#cb20-30&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;optimal_strategy&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;n=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;7&lt;/span&gt;) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;print&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;n=&lt;/span&gt;&lt;span class=&quot;cn&quot;&gt;Inf&lt;/span&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;## # A tibble: 15 × 2
##    situation continue
##    &amp;lt;chr&amp;gt;        &amp;lt;int&amp;gt;
##  1 5/1/1            0
##  2 4/2/1            0
##  3 4/1/2            0
##  4 3/3/1            1
##  5 3/2/2            1
##  6 3/1/3            1
##  7 2/4/1            1
##  8 2/3/2            1
##  9 2/2/3            1
## 10 2/1/4            1
## 11 1/5/1            1
## 12 1/4/2            1
## 13 1/3/3            1
## 14 1/2/4            1
## 15 1/1/5            1&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;We observe that for situations with 7 sticks we continue to play as
long as only 1-3 pits are filled. If 4 or 5 pits are filled, we don’t
continue. However, in other settings with different number of sticks
left, the optimal strategy can be different. As an example, if there 6
sticks left, the optimal strategy is&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;## # A tibble: 10 × 2
##    situation continue
##    &amp;lt;chr&amp;gt;        &amp;lt;int&amp;gt;
##  1 4/1/1            1
##  2 3/2/1            1
##  3 3/1/2            1
##  4 2/3/1            1
##  5 2/2/2            1
##  6 2/1/3            1
##  7 1/4/1            1
##  8 1/3/2            1
##  9 1/2/3            1
## 10 1/1/4            1&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;which -opposite to the 7 sticks left situation- continues in the 4
pits filled situation, if each player has only one stick left
(4/1/1).&lt;/p&gt;
&lt;p&gt;Finally, we implement a function, which implements Jehn’s optimal
strategy in a way, which can be used by the simulation function
&lt;code&gt;simulate_super6()&lt;/code&gt;:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb23&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb23-1&quot;&gt;&lt;a href=&quot;#cb23-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;#&amp;#39; Jehn&amp;#39;s optimal strategy for two players&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb23-2&quot;&gt;&lt;a href=&quot;#cb23-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;#&amp;#39;&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb23-3&quot;&gt;&lt;a href=&quot;#cb23-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;#&amp;#39; @param player_idx Index of the player in the state_players variable (see simulate_super6 function)&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb23-4&quot;&gt;&lt;a href=&quot;#cb23-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;#&amp;#39; @param filled_holes Number of pits filled&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb23-5&quot;&gt;&lt;a href=&quot;#cb23-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;#&amp;#39; @param state_players Vector of length equal to the number of players containing the number of sticks each player has left&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb23-6&quot;&gt;&lt;a href=&quot;#cb23-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;#&amp;#39; @return A numeric corresponding to the probability to continue&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb23-7&quot;&gt;&lt;a href=&quot;#cb23-7&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;#&amp;#39; &lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb23-8&quot;&gt;&lt;a href=&quot;#cb23-8&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;jehn &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;cf&quot;&gt;function&lt;/span&gt;(player_idx, filled_holes, state_players) {&lt;/span&gt;
&lt;span id=&quot;cb23-9&quot;&gt;&lt;a href=&quot;#cb23-9&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;co&quot;&gt;# Some summaries&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb23-10&quot;&gt;&lt;a href=&quot;#cb23-10&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  sticks_left &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; filled_holes &lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;sum&lt;/span&gt;(state_players)&lt;/span&gt;
&lt;span id=&quot;cb23-11&quot;&gt;&lt;a href=&quot;#cb23-11&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  my_sticks &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; state_players[player_idx]&lt;/span&gt;
&lt;span id=&quot;cb23-12&quot;&gt;&lt;a href=&quot;#cb23-12&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  other_sticks &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; state_players[&lt;span class=&quot;sc&quot;&gt;-&lt;/span&gt;player_idx]&lt;/span&gt;
&lt;span id=&quot;cb23-13&quot;&gt;&lt;a href=&quot;#cb23-13&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;/span&gt;
&lt;span id=&quot;cb23-14&quot;&gt;&lt;a href=&quot;#cb23-14&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;co&quot;&gt;#Strategy for basic cases&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb23-15&quot;&gt;&lt;a href=&quot;#cb23-15&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;cf&quot;&gt;if&lt;/span&gt; (filled_holes &lt;span class=&quot;sc&quot;&gt;&amp;lt;=&lt;/span&gt; &lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;) &lt;span class=&quot;fu&quot;&gt;return&lt;/span&gt;(&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;)&lt;/span&gt;
&lt;span id=&quot;cb23-16&quot;&gt;&lt;a href=&quot;#cb23-16&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;cf&quot;&gt;if&lt;/span&gt; (filled_holes &lt;span class=&quot;sc&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;dv&quot;&gt;5&lt;/span&gt;) &lt;span class=&quot;fu&quot;&gt;return&lt;/span&gt;(&lt;span class=&quot;dv&quot;&gt;0&lt;/span&gt;)&lt;/span&gt;
&lt;span id=&quot;cb23-17&quot;&gt;&lt;a href=&quot;#cb23-17&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;co&quot;&gt;#Complicated part of the strategy&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb23-18&quot;&gt;&lt;a href=&quot;#cb23-18&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  s_best &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;optimal_strategy&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;n=&lt;/span&gt;sticks_left)&lt;/span&gt;
&lt;span id=&quot;cb23-19&quot;&gt;&lt;a href=&quot;#cb23-19&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  state &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;str_c&lt;/span&gt;(filled_holes, my_sticks, other_sticks, &lt;span class=&quot;at&quot;&gt;sep=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;/&amp;quot;&lt;/span&gt;)&lt;/span&gt;
&lt;span id=&quot;cb23-20&quot;&gt;&lt;a href=&quot;#cb23-20&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  action &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; s_best &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;filter&lt;/span&gt;(situation &lt;span class=&quot;sc&quot;&gt;==&lt;/span&gt; state) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;/span&gt;
&lt;span id=&quot;cb23-21&quot;&gt;&lt;a href=&quot;#cb23-21&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;fu&quot;&gt;pull&lt;/span&gt;(continue)&lt;/span&gt;
&lt;span id=&quot;cb23-22&quot;&gt;&lt;a href=&quot;#cb23-22&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb23-23&quot;&gt;&lt;a href=&quot;#cb23-23&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;co&quot;&gt;# Check if output fails (this should not happen).  &lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb23-24&quot;&gt;&lt;a href=&quot;#cb23-24&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;cf&quot;&gt;if&lt;/span&gt; (&lt;span class=&quot;fu&quot;&gt;length&lt;/span&gt;(action) &lt;span class=&quot;sc&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;dv&quot;&gt;0&lt;/span&gt;) { &lt;span class=&quot;fu&quot;&gt;browser&lt;/span&gt;()}&lt;/span&gt;
&lt;span id=&quot;cb23-25&quot;&gt;&lt;a href=&quot;#cb23-25&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;cf&quot;&gt;if&lt;/span&gt; (&lt;span class=&quot;sc&quot;&gt;!&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;is.numeric&lt;/span&gt;(action)) { &lt;span class=&quot;fu&quot;&gt;browser&lt;/span&gt;()}&lt;/span&gt;
&lt;span id=&quot;cb23-26&quot;&gt;&lt;a href=&quot;#cb23-26&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;/span&gt;
&lt;span id=&quot;cb23-27&quot;&gt;&lt;a href=&quot;#cb23-27&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;co&quot;&gt;# Done&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb23-28&quot;&gt;&lt;a href=&quot;#cb23-28&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;return&lt;/span&gt;(action)&lt;/span&gt;
&lt;span id=&quot;cb23-29&quot;&gt;&lt;a href=&quot;#cb23-29&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;} &lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;This allows us to test, if there is a winning advantage, despite both
players playing the optimal strategy (see &lt;a
href=&quot;https://raw.githubusercontent.com/hoehleatsu/hoehleatsu.github.io/master/_source/2023-03-13-super6.Rmd&quot;&gt;source
code&lt;/a&gt; for details).&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;## # A tibble: 1 × 1
##   p_win_beginner
##            &amp;lt;dbl&amp;gt;
## 1          0.596&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;The answer is thus: Yes! In 60% of the games the starting player
wins. Thus, the winning advantage of the beginner in the &lt;span
class=&quot;math inline&quot;&gt;\(n=2\)&lt;/span&gt; scenario remains even when both
players use the &lt;code&gt;jehn&lt;/code&gt; optimal winning strategy.&lt;/p&gt;
&lt;h2 class=&quot;unnumbered&quot; id=&quot;literature&quot;&gt;Literature&lt;/h2&gt;
&lt;div id=&quot;refs&quot; class=&quot;references csl-bib-body hanging-indent&quot;
data-entry-spacing=&quot;0&quot; role=&quot;list&quot;&gt;
&lt;div id=&quot;ref-jehn2021&quot; class=&quot;csl-entry&quot; role=&quot;listitem&quot;&gt;
Jehn, Rüdiger. 2021. &lt;span&gt;“Optimum Strategies for the Game Super
Six.”&lt;/span&gt; arXiv. &lt;a
href=&quot;https://doi.org/10.48550/ARXIV.2109.10700&quot;&gt;https://doi.org/10.48550/ARXIV.2109.10700&lt;/a&gt;.
&lt;/div&gt;
&lt;/div&gt;
</description>
        <pubDate>Mon, 13 Mar 2023 00:00:00 +0100</pubDate>
        <link>https://mhoehle.github.io/blog/2023/03/13/super6.html</link>
        <guid isPermaLink="true">https://mhoehle.github.io/blog/2023/03/13/super6.html</guid>
        
        <category>rstats</category>
        
        <category>stats</category>
        
        <category>simulation</category>
        
        <category>game theory</category>
        
        
      </item>
    
      <item>
        <title>Tupper&apos;s Self Referential Formula in R</title>
        <description>&lt;p&gt;&lt;!-- bibliography: /Users/hoehle/Literature/Bibtex/jabref.bib --&gt;&lt;/p&gt;
&lt;h2 id=&quot;abstract&quot;&gt;Abstract:&lt;/h2&gt;
&lt;p&gt;We implement Tupper’s self-referencing formula in R. This has been
done before by others, but the joy was to be able to learn how to do it
yourself using the tidyverse.&lt;/p&gt;
&lt;center&gt;
&lt;img src=&quot;/blog/figure/source/2022-10-17-tupper/plot_tupper-1.png&quot; /&gt;
&lt;/center&gt;
&lt;p&gt;&lt;br&gt;
&lt;a rel=&quot;license&quot; href=&quot;http://creativecommons.org/licenses/by-sa/4.0/&quot;&gt;&lt;img alt=&quot;Creative Commons License&quot; style=&quot;border-width:0&quot; src=&quot;https://i.creativecommons.org/l/by-sa/4.0/88x31.png&quot;/&gt;&lt;/a&gt;
This work is licensed under a &lt;a rel=&quot;license&quot;
href=&quot;http://creativecommons.org/licenses/by-sa/4.0/&quot;&gt;Creative Commons
Attribution-ShareAlike 4.0 International License&lt;/a&gt;. The &lt;a
href=&quot;https://raw.githubusercontent.com/hoehleatsu/hoehleatsu.github.io/master/_source/2022-10-17-tupper.Rmd&quot;&gt;R-markdown
source code&lt;/a&gt; of this blog is available under a &lt;a
href=&quot;https://www.gnu.org/licenses/gpl-3.0.html&quot;&gt;GNU General Public
License (GPL v3)&lt;/a&gt; license from GitHub.&lt;/p&gt;
&lt;h2 id=&quot;introduction&quot;&gt;Introduction&lt;/h2&gt;
&lt;p&gt;&lt;a
href=&quot;https://en.wikipedia.org/wiki/Tupper%27s_self-referential_formula%20#&quot;&gt;Tupper’s
self-referencial formula&lt;/a&gt; &lt;span class=&quot;citation&quot;
data-cites=&quot;tupper2001&quot;&gt;(Tupper 2001)&lt;/span&gt; is an equation which maps a
2D &lt;span class=&quot;math inline&quot;&gt;\((x,y)\)&lt;/span&gt; coordinate to an &lt;span
class=&quot;math inline&quot;&gt;\(\{\text{FALSE},\text{TRUE}\}\)&lt;/span&gt; value. If
&lt;span class=&quot;math inline&quot;&gt;\((x,y)\)&lt;/span&gt; represent pixel locations,
the output over a grid of values can thought of as a black &amp;amp; white
image where the true/false values are mapped to &lt;span
class=&quot;math inline&quot;&gt;\(\{0,1\}\)&lt;/span&gt; in the usual way. Tupper’s
formula is &lt;span class=&quot;math inline&quot;&gt;\(f(x,y) =\)&lt;/span&gt; &lt;span
class=&quot;math display&quot;&gt;\[
\frac{1}{2} &amp;lt; \left\lfloor \operatorname{mod}\left(
\left\lfloor\frac{y}{17}\right\rfloor\cdot 2^{-17\lfloor x \rfloor -
\operatorname{mod}(\lfloor y \rfloor, 17)}, 2\right)\right\rfloor.
\]&lt;/span&gt; We note that if one evaluates the function for all integers
&lt;span class=&quot;math inline&quot;&gt;\((x,y)\)&lt;/span&gt; for &lt;span
class=&quot;math inline&quot;&gt;\(0 \leq x \leq 105\)&lt;/span&gt; and &lt;span
class=&quot;math inline&quot;&gt;\(k\leq y\leq k+16\)&lt;/span&gt;, where &lt;span
class=&quot;math inline&quot;&gt;\(k\)&lt;/span&gt; is a fixed constant, then one gets a
binary image with 106x17 pixels. The entire magic of Tupper’s formula is
that it’s just unpacking an encoding of that 106x17 grid by representing
it as a 1802 long binary number which is then converted from base-2 into
base-10. For some (not so obvious) reason this number is then multiplied
by 17 to yield the final value of &lt;span class=&quot;math inline&quot;&gt;\(k\)&lt;/span&gt;
(in base-10)&lt;a href=&quot;#fn1&quot; class=&quot;footnote-ref&quot; id=&quot;fnref1&quot;
role=&quot;doc-noteref&quot;&gt;&lt;sup&gt;1&lt;/sup&gt;&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;We also note that since the right-hand side of Tupper’s equation will
always be 0 or 1, the comparison with &lt;span
class=&quot;math inline&quot;&gt;\(\frac{1}{2}\)&lt;/span&gt; appears superfluous and seems
to be just a way to get a Boolean instead of a 0/1. Furthermore, since
we will be using only integer values for &lt;span
class=&quot;math inline&quot;&gt;\(x\)&lt;/span&gt; and &lt;span
class=&quot;math inline&quot;&gt;\(y\)&lt;/span&gt;, the floor operators around &lt;span
class=&quot;math inline&quot;&gt;\(x\)&lt;/span&gt; and &lt;span
class=&quot;math inline&quot;&gt;\(y\)&lt;/span&gt; are not really needed either.&lt;/p&gt;
&lt;h3 id=&quot;more-background&quot;&gt;More Background&lt;/h3&gt;
&lt;p&gt;Initially, I learned about the formula from a twitter post:&lt;/p&gt;
&lt;blockquote class=&quot;twitter-tweet&quot;&gt;
&lt;p lang=&quot;en&quot; dir=&quot;ltr&quot;&gt;
Tupper&apos;s self-referential formula is a formula that visually represents
itself when graphed at a specific location in the (x, y) plane.
&lt;a href=&quot;https://t.co/wAUVahJ9Dq&quot;&gt;pic.twitter.com/wAUVahJ9Dq&lt;/a&gt;
&lt;/p&gt;
— Fermat&apos;s Library (&lt;span class=&quot;citation&quot;
data-cites=&quot;fermatslibrary&quot;&gt;(&lt;strong&gt;fermatslibrary?&lt;/strong&gt;)&lt;/span&gt;)
&lt;a href=&quot;https://twitter.com/fermatslibrary/status/960154478224793600?ref_src=twsrc%5Etfw&quot;&gt;February
4, 2018&lt;/a&gt;
&lt;/blockquote&gt;
&lt;script async src=&quot;https://platform.twitter.com/widgets.js&quot; charset=&quot;utf-8&quot;&gt;&lt;/script&gt;
&lt;p&gt;A nice Numberphile video has also been dedicated to the formula.
&lt;iframe width=&quot;560&quot; height=&quot;315&quot; src=&quot;https://www.youtube.com/embed/_s5RFgd59ao&quot; title=&quot;YouTube video player&quot; frameborder=&quot;0&quot; allow=&quot;accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture&quot; allowfullscreen&gt;&lt;/iframe&gt;&lt;/p&gt;
&lt;h2 id=&quot;r-implementation&quot;&gt;R Implementation&lt;/h2&gt;
&lt;p&gt;One challenge of implementing Tupper’s formula in R is that &lt;span
class=&quot;math inline&quot;&gt;\(k\)&lt;/span&gt; will be a very large integer (~500
digits). Hence, one needs a special purpose library to handle these
large numbers. StaTEAstics in their 2013 &lt;a
href=&quot;https://www.r-bloggers.com/2013/03/tuppers-self-referential-formula/&quot;&gt;R
blog post on Tupper’s formula&lt;/a&gt; use the GNU Multiple Precision
Arithmetic Library for this purpose and is interfaced in the &lt;a
href=&quot;https://cran.r-project.org/web/packages/gmp/index.html&quot;&gt;&lt;code&gt;gmp&lt;/code&gt;
R package&lt;/a&gt;. We follow their implementation:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb1&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb1-1&quot;&gt;&lt;a href=&quot;#cb1-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##  GNU Multiple Precision Arithmetic Library) for handling the long integers&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-2&quot;&gt;&lt;a href=&quot;#cb1-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;library&lt;/span&gt;(gmp)&lt;/span&gt;
&lt;span id=&quot;cb1-3&quot;&gt;&lt;a href=&quot;#cb1-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-4&quot;&gt;&lt;a href=&quot;#cb1-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;## Define the constant k&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-5&quot;&gt;&lt;a href=&quot;#cb1-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;k &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;as.bigz&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;quot;960939379918958884971672962127852754715004339660129306651505519271702802395266424689642842174350718121267153782770623355993237280874144307891325963941337723487857735749823926629715517173716995165232890538221612403238855866184013235585136048828693337902491454229288667081096184496091705183454067827731551705405381627380967602565625016981482083418783163849115590225610003652351370343874461848378737238198224849863465033159410054974700593138339226497249461751545728366702369745461014655997933798537483143786841806593422227898388722980000748404719&amp;quot;&lt;/span&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Thus an R function implementing Tupper’s formula is:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb2&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb2-1&quot;&gt;&lt;a href=&quot;#cb2-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;tupper &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;cf&quot;&gt;function&lt;/span&gt;(x, y, k) {&lt;/span&gt;
&lt;span id=&quot;cb2-2&quot;&gt;&lt;a href=&quot;#cb2-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  z1 &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;as.bigz&lt;/span&gt;(y &lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt; k)&lt;/span&gt;
&lt;span id=&quot;cb2-3&quot;&gt;&lt;a href=&quot;#cb2-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  z2 &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;as.bigq&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;floor&lt;/span&gt;(z1&lt;span class=&quot;sc&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;17&lt;/span&gt;))&lt;/span&gt;
&lt;span id=&quot;cb2-4&quot;&gt;&lt;a href=&quot;#cb2-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  z3 &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;^&lt;/span&gt;(&lt;span class=&quot;sc&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;17&lt;/span&gt; &lt;span class=&quot;sc&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;floor&lt;/span&gt;(x) &lt;span class=&quot;sc&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;as.bigz&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;floor&lt;/span&gt;(z1) &lt;span class=&quot;sc&quot;&gt;%%&lt;/span&gt; &lt;span class=&quot;dv&quot;&gt;17&lt;/span&gt;))&lt;/span&gt;
&lt;span id=&quot;cb2-5&quot;&gt;&lt;a href=&quot;#cb2-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;return&lt;/span&gt;(&lt;span class=&quot;fl&quot;&gt;0.5&lt;/span&gt; &lt;span class=&quot;sc&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;floor&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;as.bigz&lt;/span&gt;(z2 &lt;span class=&quot;sc&quot;&gt;*&lt;/span&gt; z3) &lt;span class=&quot;sc&quot;&gt;%%&lt;/span&gt; &lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;))&lt;/span&gt;
&lt;span id=&quot;cb2-6&quot;&gt;&lt;a href=&quot;#cb2-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Here we have used &lt;span class=&quot;math inline&quot;&gt;\(k\)&lt;/span&gt; explicitly
in order to have &lt;span class=&quot;math inline&quot;&gt;\(y\)&lt;/span&gt; run from 0 to
16, which is easier for the subsequent plotting. Applying the R function
to an appropriate grid of values (and reversing the index directions to
account for the horizontal plotting direction):&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb3&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb3-1&quot;&gt;&lt;a href=&quot;#cb3-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;im &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;expand_grid&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;x=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;105&lt;/span&gt;&lt;span class=&quot;dt&quot;&gt;L&lt;/span&gt;, &lt;span class=&quot;at&quot;&gt;y=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;16&lt;/span&gt;&lt;span class=&quot;dt&quot;&gt;L&lt;/span&gt;) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;/span&gt;
&lt;span id=&quot;cb3-2&quot;&gt;&lt;a href=&quot;#cb3-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;rowwise&lt;/span&gt;() &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;/span&gt;
&lt;span id=&quot;cb3-3&quot;&gt;&lt;a href=&quot;#cb3-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;mutate&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;z=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;tupper&lt;/span&gt;(&lt;span class=&quot;dv&quot;&gt;105&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;-&lt;/span&gt;x, &lt;span class=&quot;dv&quot;&gt;16&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;-&lt;/span&gt;y, &lt;span class=&quot;at&quot;&gt;k=&lt;/span&gt;k))&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;The result can then easily plotted:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb4&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb4-1&quot;&gt;&lt;a href=&quot;#cb4-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;plot_tupper &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;cf&quot;&gt;function&lt;/span&gt;(im, &lt;span class=&quot;at&quot;&gt;palette=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;c&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;quot;darkblue&amp;quot;&lt;/span&gt;, &lt;span class=&quot;st&quot;&gt;&amp;quot;lightgray&amp;quot;&lt;/span&gt;)) {&lt;/span&gt;
&lt;span id=&quot;cb4-2&quot;&gt;&lt;a href=&quot;#cb4-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;ggplot&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;data=&lt;/span&gt;im, &lt;span class=&quot;fu&quot;&gt;aes&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;x=&lt;/span&gt;x,&lt;span class=&quot;at&quot;&gt;y=&lt;/span&gt;y,&lt;span class=&quot;at&quot;&gt;fill=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;as.factor&lt;/span&gt;(z))) &lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;geom_tile&lt;/span&gt;() &lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-3&quot;&gt;&lt;a href=&quot;#cb4-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;fu&quot;&gt;scale_fill_manual&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;values=&lt;/span&gt;palette) &lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-4&quot;&gt;&lt;a href=&quot;#cb4-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;fu&quot;&gt;theme_void&lt;/span&gt;() &lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-5&quot;&gt;&lt;a href=&quot;#cb4-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;fu&quot;&gt;theme&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;legend.position=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;none&amp;quot;&lt;/span&gt;) &lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-6&quot;&gt;&lt;a href=&quot;#cb4-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;fu&quot;&gt;coord_equal&lt;/span&gt;()&lt;/span&gt;
&lt;span id=&quot;cb4-7&quot;&gt;&lt;a href=&quot;#cb4-7&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;}&lt;/span&gt;
&lt;span id=&quot;cb4-8&quot;&gt;&lt;a href=&quot;#cb4-8&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;plot_tupper&lt;/span&gt;(im)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;img src=&quot;/blog/figure/source/2022-10-17-tupper/plot_tupper-1.png&quot; style=&quot;display: block; margin: auto;&quot; /&gt;&lt;/p&gt;
&lt;h2 id=&quot;behind-the-scenes&quot;&gt;Behind the Scenes&lt;/h2&gt;
&lt;p&gt;To check the underlying binary representation we convert &lt;span
class=&quot;math inline&quot;&gt;\(k/17\)&lt;/span&gt; to base-2 notation. However, the
multiplication by 17 (10001 in base-2) not only ensures that taking
&lt;span class=&quot;math inline&quot;&gt;\(k\)&lt;/span&gt; modulo the height of the image
starts at zero, but it is also helpful to keep possible trailing zeroes
in the encoding of the image. Since we know the image size has to be
&lt;span class=&quot;math inline&quot;&gt;\(17\times 106=1802\)&lt;/span&gt; we simply fill
the trailing zeroes, if the base-2 converted result of &lt;span
class=&quot;math inline&quot;&gt;\(k/17\)&lt;/span&gt; does not have a length of 1802.&lt;/p&gt;
&lt;p&gt;Convert to base-2 number of length 1802 and visualize the number:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb5&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb5-1&quot;&gt;&lt;a href=&quot;#cb5-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;char &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;as.character&lt;/span&gt;(k&lt;span class=&quot;sc&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;17&lt;/span&gt;, &lt;span class=&quot;at&quot;&gt;b=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;)&lt;/span&gt;
&lt;span id=&quot;cb5-2&quot;&gt;&lt;a href=&quot;#cb5-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;## Add trailing zeroes, which are missing coz the first two pixel are 0.&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb5-3&quot;&gt;&lt;a href=&quot;#cb5-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;char &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;str_c&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;str_c&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;rep&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;quot;0&amp;quot;&lt;/span&gt;,&lt;span class=&quot;dv&quot;&gt;17&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;106&lt;/span&gt; &lt;span class=&quot;sc&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;str_length&lt;/span&gt;(char)), &lt;span class=&quot;at&quot;&gt;collapse=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;&amp;quot;&lt;/span&gt;), char)&lt;/span&gt;
&lt;span id=&quot;cb5-4&quot;&gt;&lt;a href=&quot;#cb5-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;cat&lt;/span&gt;(char)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;00110010101000100001010101011111000010010010100000000000000000000000000000001000000000000000101000000000000010001000000000000000000000001111111111111111110000000000000000100000111100000000000000001000000000000011100000000000000000100000000000001110000000000000000000000000000000011000000000000001001000000000000010010000000000000011000000000000000000000000000000001100000000000000100100000000000001001000000000000011111100000000000000000000000000011111110000000111000000011100110000000000000110000000000000000011111111111111110100000000000000001011111010000000000000000101011000001100101001000001000111010001100010000000000000000111111111111111100000000000000000000000011001000000000000101001000000000001001010000000000010001000100000000000000001000000000000000000000000000000011111000000000000000000000000000001100100000000000000111000000000000000000000000001111111100000000010000000000000000100101000000000000000100000000000010010100000000000100000000000000001111111100000000000000000000000000000001000000000000000010000000000000000000000000000000111000000000000000010000000000000011100000000000000001000000000000001100000000000000000000000000000000111000000000000001010000000000000011100000000000000000000000000000001110000000000000010100000000000000111110000000000000000000000000000111100000000000110000110000000000000000000000000011111111000000000100000000000000001010110000000000000010000000000000100011000000000001000000000000000011111111000000000000000000000000001000000000000000001100000000000000000000000000000000001111100000000000000000000000000000110010000000000000011100000000000000000000000000110000110001000000011110000001100000000000000000000000000000000001100100000000000010100100000000000100101000001100001000100001100111000000011100100001111111000001000000000000000011111111111111111&lt;/code&gt;&lt;/pre&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb7&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb7-1&quot;&gt;&lt;a href=&quot;#cb7-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;str_length&lt;/span&gt;(char)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;[1] 1802&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Shown splitted into chunks of 17 and for better plotting replacing 0
with ” ” and 1 with “█”&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb9&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb9-1&quot;&gt;&lt;a href=&quot;#cb9-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;char_split &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;stri_sub&lt;/span&gt;(char, &lt;span class=&quot;fu&quot;&gt;seq&lt;/span&gt;(&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;, stringi&lt;span class=&quot;sc&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;stri_length&lt;/span&gt;(char),&lt;span class=&quot;at&quot;&gt;by=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;17&lt;/span&gt;), &lt;span class=&quot;at&quot;&gt;length=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;17&lt;/span&gt;)&lt;/span&gt;
&lt;span id=&quot;cb9-2&quot;&gt;&lt;a href=&quot;#cb9-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;plot_string &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;str_c&lt;/span&gt;(char_split, &lt;span class=&quot;at&quot;&gt;collapse=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;\n&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;&lt;/span&gt;) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;/span&gt;
&lt;span id=&quot;cb9-3&quot;&gt;&lt;a href=&quot;#cb9-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;str_replace_all&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;quot;0&amp;quot;&lt;/span&gt;, &lt;span class=&quot;st&quot;&gt;&amp;quot; &amp;quot;&lt;/span&gt;) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;/span&gt;
&lt;span id=&quot;cb9-4&quot;&gt;&lt;a href=&quot;#cb9-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;str_replace_all&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;quot;1&amp;quot;&lt;/span&gt;, &lt;span class=&quot;st&quot;&gt;&amp;quot;█&amp;quot;&lt;/span&gt;) &lt;/span&gt;
&lt;span id=&quot;cb9-5&quot;&gt;&lt;a href=&quot;#cb9-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;cat&lt;/span&gt;(plot_string)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;  ██  █ █ █   █  
  █ █ █ █ █████  
  █  █  █ █      
                 
        █        
       █ █       
      █   █      
                 
█████████████████
█                
█     ████       
         █       
      ███        
         █       
      ███        
                 
       ██        
      █  █       
      █  █       
       ██        
                 
       ██        
      █  █       
      █  █       
      ██████     
                 
     ███████     
  ███       ███  
██             ██
                 
████████████████ 
█                
█ █████ █        
        █ █ ██   
  ██  █ █  █     
█   ███ █   ██   
█                
████████████████ 
                 
      ██  █      
      █ █  █     
      █  █ █     
      █   █   █  
              █  
                 
            █████
                 
            ██  █
              ███
                 
         ████████
         █       
         █  █ █  
             █   
         █  █ █  
         █       
         ████████
                 
              █  
              █  
                 
            ███  
              █  
            ███  
              █  
            ██   
                 
            ███  
            █ █  
            ███  
                 
            ███  
            █ █  
            █████
                 
           ████  
         ██    ██
                 
         ████████
         █       
         █ █ ██  
            █    
         █   ██  
         █       
         ████████
                 
         █       
          ██     
                 
            █████
                 
            ██  █
              ███
                 
         ██    ██
   █       ████  
    ██           
                 
      ██  █      
      █ █  █     
      █  █ █     
██    █   █    ██
  ███       ███  
█    ███████     
█                
█████████████████&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;or somewhat better visible as a plot:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb11&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb11-1&quot;&gt;&lt;a href=&quot;#cb11-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;## Convert to image data.frame&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb11-2&quot;&gt;&lt;a href=&quot;#cb11-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;im2 &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;expand_grid&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;x=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;105&lt;/span&gt;, &lt;span class=&quot;at&quot;&gt;y=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;16&lt;/span&gt;)&lt;/span&gt;
&lt;span id=&quot;cb11-3&quot;&gt;&lt;a href=&quot;#cb11-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;im2 &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; im2 &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;mutate&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;idx =&lt;/span&gt; y &lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt; (x&lt;span class=&quot;sc&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;17&lt;/span&gt;) &lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;rowwise&lt;/span&gt;() &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;/span&gt;
&lt;span id=&quot;cb11-4&quot;&gt;&lt;a href=&quot;#cb11-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;mutate&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;value_str =&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;str_sub&lt;/span&gt;(char, &lt;span class=&quot;at&quot;&gt;start=&lt;/span&gt;idx, &lt;span class=&quot;at&quot;&gt;end=&lt;/span&gt;idx),&lt;/span&gt;
&lt;span id=&quot;cb11-5&quot;&gt;&lt;a href=&quot;#cb11-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;         &lt;span class=&quot;at&quot;&gt;value =&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;as.numeric&lt;/span&gt;(value_str)) &lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;img src=&quot;/blog/figure/source/2022-10-17-tupper/show_pixels-1.png&quot; style=&quot;display: block; margin: auto;&quot; /&gt;
We find the above binary number by starting in the (0,0) cell and
reading upwards in the &lt;span class=&quot;math inline&quot;&gt;\(x=0\)&lt;/span&gt;
column.&lt;/p&gt;
&lt;h2 id=&quot;discussion&quot;&gt;Discussion&lt;/h2&gt;
&lt;p&gt;Given the entire “magic” of Tupper’s formula is in &lt;span
class=&quot;math inline&quot;&gt;\(k\)&lt;/span&gt;, this &lt;a
href=&quot;https://keelyhill.github.io/tuppers-formula&quot;&gt;site&lt;/a&gt; allows you
to upload a raw 106x17 image and get the corresponding &lt;span
class=&quot;math inline&quot;&gt;\(k\)&lt;/span&gt; for use in the formula. With &lt;a
href=&quot;https://www.gimp.org/&quot;&gt;Gimp&lt;/a&gt;’s PBM export functionality it’s
thus easy to make your own plotting, e.g. with &lt;span
class=&quot;math inline&quot;&gt;\(k\)&lt;/span&gt; equal to&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;186884211780601757089521467754254266534847988959618908270134320886923032590936706609566110951773945064529540811157829398942842590351995031478543240582993263095682288889081666401727057238884719133521833705371096422637085577259001963761107220646739852199923964701689237214047197937015515747842387117086366819859986916183575585602891273928856883765838042528273754853751383296206633974324557163987001300322007312244691824532706662875082651525203923748809153375012301876787226286483554151163460581654755346590825663755194466304&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;we get
&lt;img src=&quot;/blog/figure/source/2022-10-17-tupper/discussion_plot-1.png&quot; style=&quot;display: block; margin: auto;&quot; /&gt;
Happy self-referential plotting!&lt;/p&gt;
&lt;h2 class=&quot;unnumbered&quot; id=&quot;literature&quot;&gt;Literature&lt;/h2&gt;
&lt;div id=&quot;refs&quot; class=&quot;references csl-bib-body hanging-indent&quot;
data-entry-spacing=&quot;0&quot; role=&quot;list&quot;&gt;
&lt;div id=&quot;ref-tupper2001&quot; class=&quot;csl-entry&quot; role=&quot;listitem&quot;&gt;
Tupper, Jeff. 2001. &lt;span&gt;“Reliable Two-Dimensional Graphing Methods for
Mathematical Formulae with Two Free Variables.”&lt;/span&gt; In
&lt;em&gt;Proceedings of the 28th Annual Conference on Computer Graphics and
Interactive Techniques&lt;/em&gt;, 77–86. SIGGRAPH ’01. New York, NY, USA:
Association for Computing Machinery. &lt;a
href=&quot;https://doi.org/10.1145/383259.383267&quot;&gt;https://doi.org/10.1145/383259.383267&lt;/a&gt;.
&lt;/div&gt;
&lt;/div&gt;
&lt;section id=&quot;footnotes&quot; class=&quot;footnotes footnotes-end-of-document&quot;
role=&quot;doc-endnotes&quot;&gt;
&lt;hr /&gt;
&lt;ol&gt;
&lt;li id=&quot;fn1&quot;&gt;&lt;p&gt;For details about why the multiplication with the height
is done, see Arvind Narayanan’s post &lt;a
href=&quot;https://web.archive.org/web/20150424181239/http://arvindn.livejournal.com/132943.html&quot;&gt;Tupper’s
Self-Referential Formula Debunked&lt;/a&gt;.&lt;a href=&quot;#fnref1&quot;
class=&quot;footnote-back&quot; role=&quot;doc-backlink&quot;&gt;↩︎&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;/section&gt;
</description>
        <pubDate>Mon, 17 Oct 2022 00:00:00 +0200</pubDate>
        <link>https://mhoehle.github.io/blog/2022/10/17/tupper.html</link>
        <guid isPermaLink="true">https://mhoehle.github.io/blog/2022/10/17/tupper.html</guid>
        
        <category>rstats</category>
        
        <category>stats</category>
        
        <category>obesity</category>
        
        <category>nonparametrics</category>
        
        
      </item>
    
      <item>
        <title>Anthropometric Birthday Cards</title>
        <description>&lt;p&gt;&lt;!-- bibliography: /Users/hoehle/Literature/Bibtex/jabref.bib --&gt;&lt;/p&gt;
&lt;h2 id=&quot;abstract&quot;&gt;Abstract:&lt;/h2&gt;
&lt;p&gt;We visualize children reference populations for height, weight and
body mass index by plotting percentiles of the population as a function
of age. Besides the epidemiological interest in these anthropometric
curves, they have dual-use potential for reproducible birthday
cards.&lt;/p&gt;
&lt;center&gt;
&lt;img src=&quot;/blog/figure/source/2022-06-11-refpop/make_bmi_plot-1.png&quot; /&gt;
&lt;/center&gt;
&lt;p&gt;&lt;br&gt;
&lt;a rel=&quot;license&quot; href=&quot;http://creativecommons.org/licenses/by-sa/4.0/&quot;&gt;&lt;img alt=&quot;Creative Commons License&quot; style=&quot;border-width:0&quot; src=&quot;https://i.creativecommons.org/l/by-sa/4.0/88x31.png&quot;/&gt;&lt;/a&gt;
This work is licensed under a &lt;a rel=&quot;license&quot;
href=&quot;http://creativecommons.org/licenses/by-sa/4.0/&quot;&gt;Creative Commons
Attribution-ShareAlike 4.0 International License&lt;/a&gt;. The &lt;a
href=&quot;https://raw.githubusercontent.com/hoehleatsu/hoehleatsu.github.io/master/_source/2022-06-11-refpop.Rmd&quot;&gt;R-markdown
source code&lt;/a&gt; of this blog is available under a &lt;a
href=&quot;https://www.gnu.org/licenses/gpl-3.0.html&quot;&gt;GNU General Public
License (GPL v3)&lt;/a&gt; license from GitHub.&lt;/p&gt;
&lt;h2 id=&quot;introduction&quot;&gt;Introduction&lt;/h2&gt;
&lt;p&gt;Percentiles of a reference population at a given age are often used
to assess under- and overweight of children. As an example, the WHO
defines obesity for children under 5 years of age when the &lt;a
href=&quot;https://cdn.who.int/media/docs/default-source/child-growth/child-growth-standards/indicators/weight-for-length-height/cht-wfl-girls-z-0-2.pdf?sfvrsn=a683172c_11&quot;&gt;weight-for-height&lt;/a&gt;
of a child is greater than 3 standard deviations above &lt;a
href=&quot;https://www.who.int/news-room/fact-sheets/detail/obesity-and-overweight&quot;&gt;WHO
Child Growth Standards median for that age&lt;/a&gt; (see also the WHO R
package &lt;a
href=&quot;https://cran.r-project.org/web/packages/anthro/index.html&quot;&gt;anthro&lt;/a&gt;).&lt;/p&gt;
&lt;p&gt;In order to estimate these percentiles, data from a sample of the
reference population is often fitted using flexible regression models
such as GAMLSS &lt;span class=&quot;citation&quot;
data-cites=&quot;rigby_stasinopoulos2005&quot;&gt;(Rigby and Stasinopoulos
2005)&lt;/span&gt; or quantile regression &lt;span class=&quot;citation&quot;
data-cites=&quot;koenker2005&quot;&gt;(Koenker 2005)&lt;/span&gt;. This allows for a
flexible modelling of the percentiles as smooth functions of age &lt;span
class=&quot;citation&quot; data-cites=&quot;fenske_etal2013&quot;&gt;(Fenske et al.
2013)&lt;/span&gt;. The reference curves used in Germany are based on the
Box-Cox Cole and Green distribution &lt;span class=&quot;citation&quot;
data-cites=&quot;KromeyerHauschild_etal2001&quot;&gt;(Kromeyer-Hauschild et al.
2001)&lt;/span&gt; (aka. the LMS method). The &lt;a
href=&quot;https://cran.r-project.org/web/packages/childsds/index.html&quot;&gt;childsds&lt;/a&gt;
R package contains an implementation of these curves as
&lt;code&gt;data(kro.ref)&lt;/code&gt;. Furthermore, the package contains similar
reference curves for several other countries as well as the WHO
reference.&lt;/p&gt;
&lt;p&gt;In what follows, we will re-purpose the package as work-horse for
generating individualized birthday cards for children.&lt;/p&gt;
&lt;h2 id=&quot;results&quot;&gt;Results&lt;/h2&gt;
&lt;p&gt;Quantiles of the reference population are obtained with the
&lt;code&gt;childsds::make_percentile_tab&lt;/code&gt; function. As an example,
let’s get the 5th, 50th and 95th percentile of the height distribution
for the population of girls in Germany aged 0 and 4 years,
respectively.&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb1&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb1-1&quot;&gt;&lt;a href=&quot;#cb1-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;library&lt;/span&gt;(childsds)&lt;/span&gt;
&lt;span id=&quot;cb1-2&quot;&gt;&lt;a href=&quot;#cb1-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;data&lt;/span&gt;(kro.ref)&lt;/span&gt;
&lt;span id=&quot;cb1-3&quot;&gt;&lt;a href=&quot;#cb1-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;childsds&lt;span class=&quot;sc&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;make_percentile_tab&lt;/span&gt;(&lt;/span&gt;
&lt;span id=&quot;cb1-4&quot;&gt;&lt;a href=&quot;#cb1-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;at&quot;&gt;ref =&lt;/span&gt; kro.ref, &lt;span class=&quot;at&quot;&gt;item =&lt;/span&gt; &lt;span class=&quot;st&quot;&gt;&amp;quot;height&amp;quot;&lt;/span&gt;, &lt;span class=&quot;at&quot;&gt;age=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;c&lt;/span&gt;(&lt;span class=&quot;dv&quot;&gt;0&lt;/span&gt;,&lt;span class=&quot;dv&quot;&gt;4&lt;/span&gt;),&lt;/span&gt;
&lt;span id=&quot;cb1-5&quot;&gt;&lt;a href=&quot;#cb1-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;at&quot;&gt;perc=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;c&lt;/span&gt;(&lt;span class=&quot;dv&quot;&gt;5&lt;/span&gt;,&lt;span class=&quot;dv&quot;&gt;50&lt;/span&gt;,&lt;span class=&quot;dv&quot;&gt;95&lt;/span&gt;), &lt;span class=&quot;at&quot;&gt;include.pars=&lt;/span&gt; &lt;span class=&quot;cn&quot;&gt;FALSE&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-6&quot;&gt;&lt;a href=&quot;#cb1-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;filter&lt;/span&gt;(sex &lt;span class=&quot;sc&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;st&quot;&gt;&amp;quot;female&amp;quot;&lt;/span&gt;) &lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;##      sex age perc_05_0 perc_50_0 perc_95_0
## 1 female   0  47.39498   51.1112  54.82742
## 2 female   4  96.33650  103.6051 110.87370&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;The main result of this short blog post is a &lt;a
href=&quot;https://github.com/hoehleatsu/hoehleatsu.github.io/blob/master/figure/source/2022-06-11-refpop/birth_stats.Rmd&quot;&gt;Rmd
file&lt;/a&gt;, which contains a visualization of an imaginary child’s growth
trajectory: Albert B. Cook born on 2018-06-11. The data of Albert are
stored in a &lt;a
href=&quot;/blog/figure/source/2022-06-11-refpop/kid_measurements.csv&quot;&gt;CSV
file&lt;/a&gt;. We show the trajectories for height, weight and BMI and
compare to 5 quantiles of the German reference population, i.e. the
2.5%, 5%, 50%, 95% and 97.5% quantile. The resulting visualization looks
as follows:&lt;/p&gt;
&lt;hr&gt;
&lt;!--
---
title: &quot;Birth statistics&quot;
author: &quot;&quot;
date: &apos;2024-02-13&apos;
output:
  html_document: default
  pdf_document: default
editor_options:
 chunk_output_type: console
---
--&gt;
&lt;!-- 
Remove above comment to make this into an Rmd file. This was commented in order
     for Jekyll not to accidently process the page when creating the blog
--&gt;
&lt;h1 id=&quot;albert-b.-cook&quot;&gt;Albert B. Cook&lt;/h1&gt;
&lt;p&gt;Let’s look at how Albert relates to the population of children in
Germany&lt;a href=&quot;#fn1&quot; class=&quot;footnote-ref&quot; id=&quot;fnref1&quot;
role=&quot;doc-noteref&quot;&gt;&lt;sup&gt;1&lt;/sup&gt;&lt;/a&gt; as implemented in the &lt;a
href=&quot;https://cran.r-project.org/web/packages/childsds/index.html&quot;&gt;childsds&lt;/a&gt;
R package&lt;a href=&quot;#fn2&quot; class=&quot;footnote-ref&quot; id=&quot;fnref2&quot;
role=&quot;doc-noteref&quot;&gt;&lt;sup&gt;2&lt;/sup&gt;&lt;/a&gt;.&lt;/p&gt;
&lt;h2 id=&quot;height&quot;&gt;Height&lt;/h2&gt;
&lt;p&gt;Albert’s height of 108 cm at age 4.0 years corresponds to the 81.4%
quantile among boys in Germany of that age.&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/blog/figure/source/2022-06-11-refpop/make_height_plot-1.png&quot; style=&quot;display: block; margin: auto;&quot; /&gt;&lt;/p&gt;
&lt;h2 id=&quot;weight&quot;&gt;Weight&lt;/h2&gt;
&lt;p&gt;Albert’s weight of 19,100 g at age 4.0 years corresponds to the 82.6%
quantile among boys in Germany of that age.&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/blog/figure/source/2022-06-11-refpop/make_weight_plot-1.png&quot; style=&quot;display: block; margin: auto;&quot; /&gt;&lt;/p&gt;
&lt;h2 id=&quot;bmi&quot;&gt;BMI&lt;/h2&gt;
&lt;p&gt;Albert’s BMI of 16.4 kg/m² at age 4.0 years corresponds to the 73.3%
quantile among boys in Germany of that age.&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/blog/figure/source/2022-06-11-refpop/make_bmi_plot-1.png&quot; style=&quot;display: block; margin: auto;&quot; /&gt;&lt;/p&gt;
&lt;p&gt;The Rmd file can be obtained from GitHub and serves as a template for
creating &lt;a
href=&quot;/blog/figure/source/2022-06-11-refpop/birth_stats.html&quot;&gt;html based
congratulation cards&lt;/a&gt; in response to news of newborn (which usually
are annotated with birth height and birth weight) or to track the growth
of your own kids.&lt;/p&gt;
&lt;h2 id=&quot;discussion&quot;&gt;Discussion&lt;/h2&gt;
&lt;p&gt;Percentile curves for longitudinal trajectories in populations can
also be used in very different contexts than anthropometry. As an
example consider the development of your &lt;a
href=&quot;https://staff.math.su.se/hoehle/blog/2019/05/06/wcamining.html&quot;&gt;solve
time for the 3x3x3 Rubik’s cube as a function of time since first WCA
competition&lt;/a&gt;.&lt;/p&gt;
&lt;h2 class=&quot;unnumbered&quot; id=&quot;literature&quot;&gt;Literature&lt;/h2&gt;
&lt;div id=&quot;refs&quot; class=&quot;references csl-bib-body hanging-indent&quot;
data-entry-spacing=&quot;0&quot; role=&quot;list&quot;&gt;
&lt;div id=&quot;ref-fenske_etal2013&quot; class=&quot;csl-entry&quot; role=&quot;listitem&quot;&gt;
Fenske, N., L. Fahrmeir, P. Rzehak, and M. Höhle. 2013. &lt;span&gt;“Boosting
Structured Additive Quantile Regression for Longitudinal Childhood
Obesity Data.”&lt;/span&gt; &lt;em&gt;Int J Biostat&lt;/em&gt; 9 (1): 1–18. &lt;a
href=&quot;https://www.degruyter.com/document/doi/10.1515/ijb-2012-0035/html&quot;&gt;https://www.degruyter.com/document/doi/10.1515/ijb-2012-0035/html&lt;/a&gt;.
&lt;/div&gt;
&lt;div id=&quot;ref-koenker2005&quot; class=&quot;csl-entry&quot; role=&quot;listitem&quot;&gt;
Koenker, Roger. 2005. &lt;em&gt;Quantile Regression&lt;/em&gt;. Cambridge University
Press.
&lt;/div&gt;
&lt;div id=&quot;ref-KromeyerHauschild_etal2001&quot; class=&quot;csl-entry&quot;
role=&quot;listitem&quot;&gt;
Kromeyer-Hauschild, K., M. Wabitsch, D. Kunze, F. Geller, H. C. Geiß, V.
Hesse, A. von Hippel, et al. 2001. &lt;span&gt;“Perzentile f&lt;span&gt;ü&lt;/span&gt;r
Den Body-Mass-Index f&lt;span&gt;ü&lt;/span&gt;r Das Kindes- Und Jugendalter Unter
Heranziehung Verschiedener Deutscher Stichproben.”&lt;/span&gt;
&lt;em&gt;Monatsschrift Kinderheilkunde&lt;/em&gt; 149 (8): 807–18.
&lt;/div&gt;
&lt;div id=&quot;ref-rigby_stasinopoulos2005&quot; class=&quot;csl-entry&quot; role=&quot;listitem&quot;&gt;
Rigby, R. A., and D. M. Stasinopoulos. 2005. &lt;span&gt;“Generalized Additive
Models for Location, Scale and Shape (with Discussion).”&lt;/span&gt;
&lt;em&gt;Applied Statistics&lt;/em&gt; 54: 1–38.
&lt;/div&gt;
&lt;/div&gt;
&lt;section id=&quot;footnotes&quot; class=&quot;footnotes footnotes-end-of-document&quot;
role=&quot;doc-endnotes&quot;&gt;
&lt;hr /&gt;
&lt;ol&gt;
&lt;li id=&quot;fn1&quot;&gt;&lt;p&gt;According to Kromeyer-Hauschild, K., Wabitsch, M.,
Kunze, D. et al. Perzentile für den Body-mass-Index für das Kindes- und
Jugendalter unter Heranziehung verschiedener deutscher Stichproben.
&lt;em&gt;Monatsschr Kinderheilkd&lt;/em&gt; 149, 807–818 (2001).
https://doi.org/10.1007/s001120170107&lt;a href=&quot;#fnref1&quot;
class=&quot;footnote-back&quot; role=&quot;doc-backlink&quot;&gt;↩︎&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;
&lt;li id=&quot;fn2&quot;&gt;Vogel M (2022). &lt;em&gt;childsds: Data and Methods Around
Reference Values in Pediatrics&lt;/em&gt;. R package version 0.8.0, &lt;a
href=&quot;https://CRAN.R-project.org/package=childsds&quot;
class=&quot;uri&quot;&gt;https://CRAN.R-project.org/package=childsds&lt;/a&gt;.
&lt;hr&gt;
&lt;a href=&quot;#fnref2&quot; class=&quot;footnote-back&quot; role=&quot;doc-backlink&quot;&gt;↩︎&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;/section&gt;
</description>
        <pubDate>Sat, 11 Jun 2022 00:00:00 +0200</pubDate>
        <link>https://mhoehle.github.io/blog/2022/06/11/refpop.html</link>
        <guid isPermaLink="true">https://mhoehle.github.io/blog/2022/06/11/refpop.html</guid>
        
        <category>rstats</category>
        
        <category>stats</category>
        
        <category>obesity</category>
        
        <category>nonparametrics</category>
        
        
      </item>
    
      <item>
        <title>An R Package for Social Roulette </title>
        <description>&lt;h2 id=&quot;abstract&quot;&gt;Abstract:&lt;/h2&gt;
&lt;p&gt;We introduce the R package socialroulette, which is a lightweight
package for handling the recurrent problem of assigning individuals into
groups of a fixed size. In order to minimize reunions, we provide an
algorithm to solve the task as an instance of the maximally diverse
grouping problem.&lt;/p&gt;
&lt;center&gt;
&lt;img src=&quot;/blog/figure/source/2021-05-12-socroulette/roulette-1003120_640.jpg&quot; width=&quot;350&quot;&gt;
&lt;/center&gt;
&lt;p&gt;&lt;br&gt;
&lt;a rel=&quot;license&quot; href=&quot;http://creativecommons.org/licenses/by-sa/4.0/&quot;&gt;&lt;img alt=&quot;Creative Commons License&quot; style=&quot;border-width:0&quot; src=&quot;https://i.creativecommons.org/l/by-sa/4.0/88x31.png&quot;/&gt;&lt;/a&gt;
This work is licensed under a &lt;a rel=&quot;license&quot;
href=&quot;http://creativecommons.org/licenses/by-sa/4.0/&quot;&gt;Creative Commons
Attribution-ShareAlike 4.0 International License&lt;/a&gt;. The &lt;a
href=&quot;https://raw.githubusercontent.com/mhoehle/mhoehle.github.io/master/_source/2021-05-12-socroulette.Rmd&quot;&gt;R-markdown
source code&lt;/a&gt; of this blog is available under a &lt;a
href=&quot;https://www.gnu.org/licenses/gpl-3.0.html&quot;&gt;GNU General Public
License (GPL v3)&lt;/a&gt; license from GitHub.&lt;/p&gt;
&lt;h2 id=&quot;introduction&quot;&gt;Introduction&lt;/h2&gt;
&lt;p&gt;Groupings are relevant when breakout rooms, mystery lunch partitions
or student peer review groups are made. My last blog post &lt;a
href=&quot;https://mhoehle.github.io/blog/2021/04/04/socialsamp.html&quot;&gt;Long
time, no see: Virtual Lunch Roulette&lt;/a&gt; considered the probability of
being assigned into the same group as someone, you already were in the
same group with the last time (aka. a re-union) when using simple random
sampling to assign the groups. This probability proved to be
surprisingly high.&lt;/p&gt;
&lt;p&gt;In this post we develop the subject further by introducing the R
package &lt;a
href=&quot;https://mhoehle.github.io/socialroulette/&quot;&gt;&lt;code&gt;socialroulette&lt;/code&gt;&lt;/a&gt;,
which aims at being helpful in making better group assignments based on
solutions of the &lt;a
href=&quot;http://grafo.etsii.urjc.es/optsicom/mdgp/&quot;&gt;&lt;strong&gt;maximally
diverse grouping problem&lt;/strong&gt;&lt;/a&gt; (MDGP) known from operations
research.&lt;/p&gt;
&lt;h3 id=&quot;the-problem&quot;&gt;The Problem&lt;/h3&gt;
&lt;p&gt;The aim is to partition &lt;span class=&quot;math inline&quot;&gt;\(n\)&lt;/span&gt;
participants into groups of size at least &lt;span
class=&quot;math inline&quot;&gt;\(m\)&lt;/span&gt;. We shall denote the resulting
groupings a &lt;a
href=&quot;https://en.wikipedia.org/wiki/Partition_of_a_set&quot;&gt;&lt;strong&gt;partition&lt;/strong&gt;&lt;/a&gt;
of the set of &lt;span class=&quot;math inline&quot;&gt;\(n\)&lt;/span&gt; participants. If
&lt;span class=&quot;math inline&quot;&gt;\(m\)&lt;/span&gt; is not a divisor of &lt;span
class=&quot;math inline&quot;&gt;\(n\)&lt;/span&gt; then some of the groups have to contain
more than &lt;span class=&quot;math inline&quot;&gt;\(m\)&lt;/span&gt; participants. As an
example consider the case that 5 individuals are to be divided into
groups of size at least 2. We shall adopt the convention, that group
size shall be as close to &lt;span class=&quot;math inline&quot;&gt;\(m\)&lt;/span&gt; as
possible and the group sizes should be as equal as possible. In the
specific toy example this means that we will need 2 groups, one with 3
participants and one with 2 participants.&lt;/p&gt;
&lt;p&gt;When assigning such groups repeatedly, e.g. one a weekly basis, an
additional criterion can be to form the groups, such that as few
participants as possible are assigned into groups with individuals they
were already in the same group with previously. This can, e.g., be done
by rejection sampling. However, as situations can occur where such
re-unions are unavoidable, it can instead be natural to formulate a
metric to maximize, which quantifies penalities due to such re-unions.
As an example: If one has to decide between assigning two individuals to
the same group who met 7 days or 14 days ago, it might be preferable to
choose the pair which met 14 days ago. Such optimization is known as
solving the &lt;a
href=&quot;http://grafo.etsii.urjc.es/optsicom/mdgp/&quot;&gt;&lt;strong&gt;maximally
diverse grouping problem&lt;/strong&gt;&lt;/a&gt; (see appendix).&lt;/p&gt;
&lt;h2 id=&quot;the-r-package-socialroulette&quot;&gt;The R package socialroulette&lt;/h2&gt;
&lt;p&gt;We illustrate the package by considering a use-case, where a class of
students repeatably for every lecture have be assigned into breakout
rooms. First, we install and load the &lt;a
href=&quot;https://mhoehle.github.io/socialroulette/&quot;&gt;&lt;code&gt;socialroulette&lt;/code&gt;&lt;/a&gt;
package available from &lt;a
href=&quot;https://github.com/mhoehle/socialroulette/&quot;&gt;GitHub&lt;/a&gt;.&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb1&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb1-1&quot;&gt;&lt;a href=&quot;#cb1-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;# Install package&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-2&quot;&gt;&lt;a href=&quot;#cb1-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;devtools&lt;span class=&quot;sc&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;install_github&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;quot;mhoehle/socialroulette&amp;quot;&lt;/span&gt;)&lt;/span&gt;
&lt;span id=&quot;cb1-3&quot;&gt;&lt;a href=&quot;#cb1-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;library&lt;/span&gt;(socialroulette)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Note: A binary package version is available from my &lt;a
href=&quot;https://mhoehle.r-universe.dev&quot;&gt;r-universe&lt;/a&gt;, which is a
pipeline automatically compiling the package through GitHub actions.&lt;/p&gt;
&lt;p&gt;Say the class consists of 100 students, which for a weekly virtual
lab exercise class need to be divided into groups of at least 4. Since
for various reasons not all students show up for each class, the
sampling frame of individuals to be partitioned each week changes
accordingly. Still, we would like to make the partitioning of the
current week s.t. students get as many new acquaintances as
possible.&lt;/p&gt;
&lt;p&gt;We first create a history of the previous 4 weeks’ groupings as well
as the frame of participants for the current lecture.&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb2&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb2-1&quot;&gt;&lt;a href=&quot;#cb2-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;# Class of 100 students with 4 previous lectures&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb2-2&quot;&gt;&lt;a href=&quot;#cb2-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;students &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; tibble&lt;span class=&quot;sc&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;tibble&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;id=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;sprintf&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;quot;id%.3d@student.su.se&amp;quot;&lt;/span&gt;, &lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;100&lt;/span&gt;))&lt;/span&gt;
&lt;span id=&quot;cb2-3&quot;&gt;&lt;a href=&quot;#cb2-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;partition_dates &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;seq&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;as.Date&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;quot;2021-03-31&amp;quot;&lt;/span&gt;), &lt;span class=&quot;at&quot;&gt;length.out=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;4&lt;/span&gt;, &lt;span class=&quot;at&quot;&gt;by=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;1 week&amp;quot;&lt;/span&gt;)&lt;/span&gt;
&lt;span id=&quot;cb2-4&quot;&gt;&lt;a href=&quot;#cb2-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb2-5&quot;&gt;&lt;a href=&quot;#cb2-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;# Simulate changing participation each week for the last 4 weeks (70% attendance)&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb2-6&quot;&gt;&lt;a href=&quot;#cb2-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;frames &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;map_df&lt;/span&gt;( partition_dates, &lt;span class=&quot;sc&quot;&gt;~&lt;/span&gt; &lt;/span&gt;
&lt;span id=&quot;cb2-7&quot;&gt;&lt;a href=&quot;#cb2-7&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;            students &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;slice_sample&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;n =&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;rbinom&lt;/span&gt;(&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;,&lt;span class=&quot;fu&quot;&gt;nrow&lt;/span&gt;(.), &lt;span class=&quot;at&quot;&gt;prob=&lt;/span&gt;&lt;span class=&quot;fl&quot;&gt;0.7&lt;/span&gt;)) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb2-8&quot;&gt;&lt;a href=&quot;#cb2-8&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;                         &lt;span class=&quot;fu&quot;&gt;mutate&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;date=&lt;/span&gt;.x))&lt;/span&gt;
&lt;span id=&quot;cb2-9&quot;&gt;&lt;a href=&quot;#cb2-9&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb2-10&quot;&gt;&lt;a href=&quot;#cb2-10&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;# Generate some past partitions using simple random sampling&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb2-11&quot;&gt;&lt;a href=&quot;#cb2-11&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;past_partitions &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; frames &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;/span&gt;
&lt;span id=&quot;cb2-12&quot;&gt;&lt;a href=&quot;#cb2-12&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;fu&quot;&gt;group_split&lt;/span&gt;(date) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb2-13&quot;&gt;&lt;a href=&quot;#cb2-13&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;fu&quot;&gt;map&lt;/span&gt;(&lt;span class=&quot;sc&quot;&gt;~&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;rsocialroulette&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;current_frame=&lt;/span&gt;.x, &lt;span class=&quot;at&quot;&gt;m=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;4&lt;/span&gt;, &lt;span class=&quot;at&quot;&gt;algorithm=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;srs&amp;quot;&lt;/span&gt;)) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb2-14&quot;&gt;&lt;a href=&quot;#cb2-14&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;fu&quot;&gt;setNames&lt;/span&gt;(partition_dates)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;## Partitioning 72 individuals into groups of at least 4 (no past partitions).
## Created 18 groups of sizes 4 4 4 4 4 4 4 4 4 4 4 4 4 4 4 4 4 4.
## Partitioning 74 individuals into groups of at least 4 (no past partitions).
## Created 18 groups of sizes 5 5 4 4 4 4 4 4 4 4 4 4 4 4 4 4 4 4.
## Partitioning 71 individuals into groups of at least 4 (no past partitions).
## Created 17 groups of sizes 5 5 5 4 4 4 4 4 4 4 4 4 4 4 4 4 4.
## Partitioning 69 individuals into groups of at least 4 (no past partitions).
## Created 17 groups of sizes 5 4 4 4 4 4 4 4 4 4 4 4 4 4 4 4 4.&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;We pretend that each of the above previous partitions has been saved
as a .csv file. For example like:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb4&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb4-1&quot;&gt;&lt;a href=&quot;#cb4-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;# Simulate the storage of each partition as a .csv file to disk&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-2&quot;&gt;&lt;a href=&quot;#cb4-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;# with 3 columns: date, id1 and id2, i.e. all pairs&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-3&quot;&gt;&lt;a href=&quot;#cb4-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;temp_dir &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;tempdir&lt;/span&gt;() &lt;span class=&quot;co&quot;&gt;#adjust path to your setting if needed&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-4&quot;&gt;&lt;a href=&quot;#cb4-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;socialroulette&lt;span class=&quot;sc&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;partitions_to_pairs&lt;/span&gt;( past_partitions ) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;/span&gt;
&lt;span id=&quot;cb4-5&quot;&gt;&lt;a href=&quot;#cb4-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;group_split&lt;/span&gt;(date) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-6&quot;&gt;&lt;a href=&quot;#cb4-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;walk&lt;/span&gt;(&lt;span class=&quot;sc&quot;&gt;~&lt;/span&gt;  &lt;span class=&quot;fu&quot;&gt;write_csv&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;x=&lt;/span&gt;.x, &lt;span class=&quot;at&quot;&gt;file=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;file.path&lt;/span&gt;(temp_dir, stringr&lt;span class=&quot;sc&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;str_c&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;quot;socialroulette-&amp;quot;&lt;/span&gt;, .&lt;span class=&quot;sc&quot;&gt;$&lt;/span&gt;date[&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;], &lt;span class=&quot;st&quot;&gt;&amp;quot;.csv&amp;quot;&lt;/span&gt;))))&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;We thus read the partitions from disk and convert from the stored
pair-format (i.e. a &lt;code&gt;data.frame&lt;/code&gt; listing each pair being in
the same group as &lt;code&gt;id1&lt;/code&gt;, &lt;code&gt;id2&lt;/code&gt; together with the
corresponding &lt;code&gt;date&lt;/code&gt; of the partition) back to the
list-format (i.e. a list of character vectors, where each vector denotes
a group and the vector contains the ids of all members of that group).
This can be done as follows:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb5&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb5-1&quot;&gt;&lt;a href=&quot;#cb5-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;# Read again from file&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb5-2&quot;&gt;&lt;a href=&quot;#cb5-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;pairs &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;map_df&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;list.files&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;path=&lt;/span&gt;temp_dir, &lt;span class=&quot;at&quot;&gt;pattern=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;socialroulette.*&amp;quot;&lt;/span&gt;, &lt;span class=&quot;at&quot;&gt;full.names=&lt;/span&gt;&lt;span class=&quot;cn&quot;&gt;TRUE&lt;/span&gt;), &lt;span class=&quot;sc&quot;&gt;~&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;read_csv&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;file=&lt;/span&gt;.x))&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;As a next step we sample the students who are in the next class to
group.&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb6&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb6-1&quot;&gt;&lt;a href=&quot;#cb6-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;current_frame &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt;  students &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;/span&gt;
&lt;span id=&quot;cb6-2&quot;&gt;&lt;a href=&quot;#cb6-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;slice_sample&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;n =&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;rbinom&lt;/span&gt;(&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;,&lt;span class=&quot;fu&quot;&gt;nrow&lt;/span&gt;(.), &lt;span class=&quot;at&quot;&gt;prob=&lt;/span&gt;&lt;span class=&quot;fl&quot;&gt;0.7&lt;/span&gt;)) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb6-3&quot;&gt;&lt;a href=&quot;#cb6-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;mutate&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;date=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;max&lt;/span&gt;(partition_dates) &lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;diff&lt;/span&gt;(partition_dates) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;mean&lt;/span&gt;())&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Our goal is now to partition the 79 students in
&lt;code&gt;current_frame&lt;/code&gt;. For each of the &lt;span
class=&quot;math inline&quot;&gt;\({79  \choose 2 }= 3081\)&lt;/span&gt; possible pairs of
students in that class, we determine how long ago it has been, since
they were in the same group the last time. This can be done using the
internal package function &lt;code&gt;partitions_to_distance&lt;/code&gt;:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb7&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb7-1&quot;&gt;&lt;a href=&quot;#cb7-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;dist &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; socialroulette&lt;span class=&quot;sc&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;partitions_to_distance&lt;/span&gt;(current_frame, past_partitions)&lt;/span&gt;
&lt;span id=&quot;cb7-2&quot;&gt;&lt;a href=&quot;#cb7-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;dist &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;head&lt;/span&gt;()&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;## # A tibble: 6 × 4
##   id1                 id2                 date        dist
##   &amp;lt;chr&amp;gt;               &amp;lt;chr&amp;gt;               &amp;lt;date&amp;gt;     &amp;lt;dbl&amp;gt;
## 1 id076@student.su.se id095@student.su.se 2021-04-28    35
## 2 id076@student.su.se id088@student.su.se 2021-04-28    35
## 3 id076@student.su.se id085@student.su.se 2021-04-28    35
## 4 id076@student.su.se id081@student.su.se 2021-04-28    35
## 5 id076@student.su.se id078@student.su.se 2021-04-28    35
## 6 id076@student.su.se id092@student.su.se 2021-04-28    35&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;img src=&quot;/blog/figure/source/2021-05-12-socroulette/unnamed-chunk-11-1.png&quot; style=&quot;display: block; margin: auto;&quot; /&gt;&lt;/p&gt;
&lt;p&gt;Since the past partitions contain the last 4 weeks, students who have
not been in a group so far are assigned a value of one time difference
more than the last possible meeting opportunity. In the specific example
this corresponds to &lt;span class=&quot;math inline&quot;&gt;\(7\cdot (4 + 1) =
35\)&lt;/span&gt; days. It thus seems natural to choose the groups, s.t. they
do not contain pairs, which have already met in the past. However, for
given size of the population, group sizes and meeting histories, this
might not be possible to achieve altogether, so a more flexible
criterion is to maximize the sum of distance since the last meet over
all pairs in the same group.&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb9&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb9-1&quot;&gt;&lt;a href=&quot;#cb9-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;# Make the partition using a mdgp solver&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb9-2&quot;&gt;&lt;a href=&quot;#cb9-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;partition &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt;  &lt;span class=&quot;fu&quot;&gt;rsocialroulette&lt;/span&gt;(current_frame, past_partitions, &lt;span class=&quot;at&quot;&gt;m=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;4&lt;/span&gt;, &lt;span class=&quot;at&quot;&gt;algorithm=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;mdgp&amp;quot;&lt;/span&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;The partition can be visualized using the &lt;code&gt;igraph&lt;/code&gt;
package:&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/blog/figure/source/2021-05-12-socroulette/unnamed-chunk-14-1.png&quot; style=&quot;display: block; margin: auto;&quot; /&gt;&lt;/p&gt;
&lt;p&gt;Of course the partition can also be stored to file as before, in
order to include it in the set of past partitions when doing the
partitioning next week:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb10&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb10-1&quot;&gt;&lt;a href=&quot;#cb10-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;list&lt;/span&gt;(partition) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;/span&gt;
&lt;span id=&quot;cb10-2&quot;&gt;&lt;a href=&quot;#cb10-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;setNames&lt;/span&gt;(current_frame &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;slice&lt;/span&gt;(&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;pull&lt;/span&gt;(date)) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb10-3&quot;&gt;&lt;a href=&quot;#cb10-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  socialroulette&lt;span class=&quot;sc&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;partitions_to_pairs&lt;/span&gt;() &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;/span&gt;
&lt;span id=&quot;cb10-4&quot;&gt;&lt;a href=&quot;#cb10-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;write_csv&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;file=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;file.path&lt;/span&gt;(temp_dir, stringr&lt;span class=&quot;sc&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;str_c&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;quot;socialroulette-&amp;quot;&lt;/span&gt;, .&lt;span class=&quot;sc&quot;&gt;$&lt;/span&gt;date[&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;],&lt;span class=&quot;st&quot;&gt;&amp;quot;.csv&amp;quot;&lt;/span&gt;)))&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;or can be stored in a Zoom compatible breakout room specification
format:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb11&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb11-1&quot;&gt;&lt;a href=&quot;#cb11-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;partition &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;/span&gt;
&lt;span id=&quot;cb11-2&quot;&gt;&lt;a href=&quot;#cb11-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  socialroulette&lt;span class=&quot;sc&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;partition_to_frame&lt;/span&gt;() &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;/span&gt;
&lt;span id=&quot;cb11-3&quot;&gt;&lt;a href=&quot;#cb11-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;rename&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;email=&lt;/span&gt;id) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;/span&gt;
&lt;span id=&quot;cb11-4&quot;&gt;&lt;a href=&quot;#cb11-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;mutate&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;room =&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;sprintf&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;quot;room%.03d&amp;quot;&lt;/span&gt;,group)) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;/span&gt;
&lt;span id=&quot;cb11-5&quot;&gt;&lt;a href=&quot;#cb11-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;select&lt;/span&gt;(room, email) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;/span&gt;
&lt;span id=&quot;cb11-6&quot;&gt;&lt;a href=&quot;#cb11-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;write_csv&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;file=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;file.path&lt;/span&gt;(temp_dir, stringr&lt;span class=&quot;sc&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;str_c&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;quot;zoom-breakoutrooms.csv&amp;quot;&lt;/span&gt;)))&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h2 id=&quot;discussion&quot;&gt;Discussion&lt;/h2&gt;
&lt;p&gt;We provide functionality to create better groupings than obtained by
simple random sampling. However, as mathematically convincing the MDGP
solution might be, reunions can have their charm.&lt;/p&gt;
&lt;h3 id=&quot;acknowledgements&quot;&gt;Acknowledgements&lt;/h3&gt;
&lt;p&gt;We thank Xiangjing Lai and &lt;a
href=&quot;http://www.info.univ-angers.fr/pub/hao/&quot;&gt;Jin-Kao Hao&lt;/a&gt; for
contributing their C++ source code of the MDGP solver in &lt;span
class=&quot;citation&quot; data-cites=&quot;lai_hao2016&quot;&gt;Lai and Hao (2016)&lt;/span&gt;
under a GPL-3 license for the &lt;a
href=&quot;https://mhoehle.github.io/socialroulette/&quot;&gt;&lt;code&gt;socialroulette&lt;/code&gt;&lt;/a&gt;
package.&lt;/p&gt;
&lt;h2 id=&quot;appendix-maximally-diverse-grouping-problem&quot;&gt;Appendix: Maximally
diverse grouping problem&lt;/h2&gt;
&lt;p&gt;In this appendix we provide a few more mathematically details about
the maximally diverse grouping problem, which is about partitioning
&lt;span class=&quot;math inline&quot;&gt;\(n\)&lt;/span&gt; individuals into groups of size
at least &lt;span class=&quot;math inline&quot;&gt;\(m\)&lt;/span&gt; while maximizing a sum
of utility values computed by summing the utility &lt;span
class=&quot;math inline&quot;&gt;\(u(i,j)\)&lt;/span&gt; over all individuals &lt;span
class=&quot;math inline&quot;&gt;\(i\)&lt;/span&gt;, &lt;span class=&quot;math inline&quot;&gt;\(j\)&lt;/span&gt;
partitioned into the same group.&lt;/p&gt;
&lt;p&gt;More formally, let &lt;span class=&quot;math inline&quot;&gt;\(d_{ij}\)&lt;/span&gt; denote
the number of time units (typically days) ago, that individual &lt;span
class=&quot;math inline&quot;&gt;\(i\)&lt;/span&gt; and &lt;span
class=&quot;math inline&quot;&gt;\(j\)&lt;/span&gt; were in the same group. Note: This
distance is derived by looking at the previous partitions. It is a
matter of definition what this value should be, if &lt;span
class=&quot;math inline&quot;&gt;\(i\)&lt;/span&gt; and &lt;span
class=&quot;math inline&quot;&gt;\(j\)&lt;/span&gt; have not previously been in the same
group. Let &lt;span class=&quot;math inline&quot;&gt;\(G=n\&amp;gt; \text{div}\&amp;gt;
m\)&lt;/span&gt; denote the resulting number of groups where &lt;span
class=&quot;math inline&quot;&gt;\(\text{div}\)&lt;/span&gt; denotes integer division. For
a given partition let &lt;span class=&quot;math inline&quot;&gt;\(x_{ig}\)&lt;/span&gt; be an
indicator variable, which is 1, if &lt;span
class=&quot;math inline&quot;&gt;\(i\)&lt;/span&gt; is assigned into group &lt;span
class=&quot;math inline&quot;&gt;\(g\)&lt;/span&gt; and zero otherwise.&lt;/p&gt;
&lt;p&gt;A solver of the maximally diverse grouping problem now tries to
maximize &lt;span class=&quot;math display&quot;&gt;\[
\sum_{g=1}^G \sum_{i=1}^n \sum_{j=i+1}^n d_{ij} x_{ig} x_{jg},
\]&lt;/span&gt; subject to the conditions &lt;span class=&quot;math display&quot;&gt;\[
\begin{align*}
&amp;amp;\sum_{g=1}^{G} x_{ig} = 1,&amp;amp;&amp;amp;  i=1,\ldots,n, \\
&amp;amp;\sum_{i=1}^n x_{ig} = n_g,&amp;amp;&amp;amp; g=1,\ldots,G, \\
&amp;amp;x_{ig} \in \{0,1\}, &amp;amp;&amp;amp; i=1,\ldots,n;\quad g=1,\ldots,G, \\
\end{align*}
\]&lt;/span&gt; where &lt;span class=&quot;math inline&quot;&gt;\(n_g\)&lt;/span&gt; is the size of
group &lt;span class=&quot;math inline&quot;&gt;\(g\)&lt;/span&gt;, i.e. &lt;span
class=&quot;math inline&quot;&gt;\(\sum_{g=1}^G n_g = n\)&lt;/span&gt;. We shall adopt the
convention that group sizes are determined by assigning the labels &lt;span
class=&quot;math inline&quot;&gt;\(1,\ldots,G\)&lt;/span&gt; to the participants by
starting from the first to the last, e.g., as &lt;span
class=&quot;math inline&quot;&gt;\(((\text{index} - 1) \&amp;gt; \text{mod}\&amp;gt; m) +
1\)&lt;/span&gt; and then count how often each label occurs. This means, e.g.,
that for &lt;span class=&quot;math inline&quot;&gt;\(n=7\)&lt;/span&gt; and &lt;span
class=&quot;math inline&quot;&gt;\(m=4\)&lt;/span&gt; we get &lt;span
class=&quot;math inline&quot;&gt;\(n_g=7\&amp;gt; \text{div}\&amp;gt; 4=1\)&lt;/span&gt; group with
7 members.&lt;/p&gt;
&lt;p&gt;The &lt;code&gt;socialroulette&lt;/code&gt; package uses as backend a C++
implementation of MDGP solver of &lt;span class=&quot;citation&quot;
data-cites=&quot;lai_hao2016&quot;&gt;Lai and Hao (2016)&lt;/span&gt;.&lt;/p&gt;
&lt;h2 class=&quot;unnumbered&quot; id=&quot;literature&quot;&gt;Literature&lt;/h2&gt;
&lt;div id=&quot;refs&quot; class=&quot;references csl-bib-body hanging-indent&quot;
data-entry-spacing=&quot;0&quot; role=&quot;list&quot;&gt;
&lt;div id=&quot;ref-lai_hao2016&quot; class=&quot;csl-entry&quot; role=&quot;listitem&quot;&gt;
Lai, Xiangjing, and Jin-Kao Hao. 2016. &lt;span&gt;“Iterated Maxima Search for
the Maximally Diverse Grouping Problem.”&lt;/span&gt; &lt;em&gt;European Journal of
Operational Research&lt;/em&gt; 254 (3): 780–800. https://doi.org/&lt;a
href=&quot;https://doi.org/10.1016/j.ejor.2016.05.018&quot;&gt;https://doi.org/10.1016/j.ejor.2016.05.018&lt;/a&gt;.
&lt;/div&gt;
&lt;/div&gt;
</description>
        <pubDate>Wed, 12 May 2021 00:00:00 +0200</pubDate>
        <link>https://mhoehle.github.io/blog/2021/05/12/socroulette.html</link>
        <guid isPermaLink="true">https://mhoehle.github.io/blog/2021/05/12/socroulette.html</guid>
        
        <category>rstats</category>
        
        <category>combinatorics</category>
        
        <category>R</category>
        
        
      </item>
    
      <item>
        <title>Long time, no see: Virtual Lunch Roulette</title>
        <description>&lt;h2 id=&quot;abstract&quot;&gt;Abstract:&lt;/h2&gt;
&lt;p&gt;When distributing individuals into groups every week for a virtual
social mixer, e.g. using Zoom breakout rooms, it’s boring to end up in a
group with someone, who you already met last week. We compute the
probility for this to happen and state a simple rejection sampling
proposal for how to increase social diversity in such groupings.&lt;/p&gt;
&lt;center&gt;
&lt;img src=&quot;/blog/figure/source/2021-04-04-socialsamp/plot_p_meetagain-1.png&quot; width=&quot;550&quot;&gt;
&lt;/center&gt;
&lt;p&gt;&lt;br&gt;
&lt;a rel=&quot;license&quot; href=&quot;http://creativecommons.org/licenses/by-sa/4.0/&quot;&gt;&lt;img alt=&quot;Creative Commons License&quot; style=&quot;border-width:0&quot; src=&quot;https://i.creativecommons.org/l/by-sa/4.0/88x31.png&quot;/&gt;&lt;/a&gt;
This work is licensed under a &lt;a rel=&quot;license&quot;
href=&quot;http://creativecommons.org/licenses/by-sa/4.0/&quot;&gt;Creative Commons
Attribution-ShareAlike 4.0 International License&lt;/a&gt;. The &lt;a
href=&quot;https://raw.githubusercontent.com/hoehleatsu/hoehleatsu.github.io/master/_source/2021-04-04-socialsamp.Rmd&quot;&gt;R-markdown
source code&lt;/a&gt; of this blog is available under a &lt;a
href=&quot;https://www.gnu.org/licenses/gpl-3.0.html&quot;&gt;GNU General Public
License (GPL v3)&lt;/a&gt; license from GitHub.&lt;/p&gt;
&lt;h2 id=&quot;introduction&quot;&gt;Introduction&lt;/h2&gt;
&lt;p&gt;As a pandemic replacement for the cross-division-chance-encounter in
the coffee kitchen, it has become common to use a virtual social mixer
format, where the &lt;span class=&quot;math inline&quot;&gt;\(n\)&lt;/span&gt; participants
are randomly divided into groups of at least &lt;span
class=&quot;math inline&quot;&gt;\(m\)&lt;/span&gt; people, e.g., for a video meeting or
Zoom breakout rooms. Software exists to institutionalize such &lt;a
href=&quot;https://de.wikipedia.org/wiki/Random_Lunch&quot;&gt;Random Lunches&lt;/a&gt;
for, e.g., &lt;a href=&quot;https://lunchroulette.co/&quot;&gt;Slack&lt;/a&gt;. In this post
we shall be interested in the properties of such group assignment
algorithms.&lt;/p&gt;
&lt;p&gt;A practical experience is that all too often, the algorithm assigns
me to a group where at least one of the participants was already in my
group the last time. Before accusing the programmers of writing a poor
grouping algorithm: can we determine mathematically what the probability
for such a “reunion” is? How can we modify the algorithm to avoid
this?&lt;/p&gt;
&lt;h4 id=&quot;survey-of-the-field&quot;&gt;Survey of the field&lt;/h4&gt;
&lt;p&gt;Arranging a fixed set of &lt;span class=&quot;math inline&quot;&gt;\(n=k\times
m\)&lt;/span&gt; individuals into &lt;span class=&quot;math inline&quot;&gt;\(k\)&lt;/span&gt;
groups of size &lt;span class=&quot;math inline&quot;&gt;\(m\)&lt;/span&gt; in subsequent
rounds ensuring that no overlap occurs between the groups for as many
rounds as possible is also known as the &lt;a
href=&quot;http://www.mathpuzzle.com/MAA/54-Golf%20Tournaments/mathgames_08_14_07.html&quot;&gt;social
golfer problem&lt;/a&gt; or round robin scheduling in combinatorics - and can
be solved using &lt;a href=&quot;https://www.metalevel.at/mst.pdf&quot;&gt;constraint
programming&lt;/a&gt;. Compared to the social golfer problem, we have the
additional challenge that the group of people between rounds may be
subject to change. Furthermore, &lt;span class=&quot;math inline&quot;&gt;\(m\)&lt;/span&gt;
might not be a divisor of &lt;span class=&quot;math inline&quot;&gt;\(n\)&lt;/span&gt;. Hence,
somewhat closer to our problem is the so called &lt;a
href=&quot;http://grafo.etsii.urjc.es/index.php/category/maximally-diverse-grouping/&quot;&gt;maximally
diverse grouping problem&lt;/a&gt;, where the grouping is to be done such that
the requirements on group size are met and a diversity score over the
elements in each group is maximized. For our setup, the score could,
e.g., be time since the last meet between individuals. Integer
programming can be used to solve the NP-complete problem.&lt;/p&gt;
&lt;p&gt;However, in our application we will either ignore the diversity score
altogether (i.e. set it to 1 always) or use a 0/1 diversity score (met
last time or not). Furthermore, we are interested in random assignment
algorithms selecting uniformly among the valid configurations. As a
consequence, we choose a more probabilistic approach and instead use a
custom group assignment algorithm as described in the next section.&lt;/p&gt;
&lt;h3 id=&quot;the-grouping&quot;&gt;The Grouping&lt;/h3&gt;
&lt;p&gt;We want to split the &lt;span class=&quot;math inline&quot;&gt;\(n\)&lt;/span&gt;
individuals into groups of preferably &lt;span
class=&quot;math inline&quot;&gt;\(m\)&lt;/span&gt; members. However, if &lt;span
class=&quot;math inline&quot;&gt;\(m\)&lt;/span&gt; is not a divisor of &lt;span
class=&quot;math inline&quot;&gt;\(n\)&lt;/span&gt; then after making &lt;span
class=&quot;math inline&quot;&gt;\(\lfloor n/m \rfloor\)&lt;/span&gt; groups of &lt;span
class=&quot;math inline&quot;&gt;\(m\)&lt;/span&gt; members we would have &lt;span
class=&quot;math inline&quot;&gt;\(l = n - \lfloor n/m \rfloor\)&lt;/span&gt; individuals
left. Instead of assigning these to a single leftover group, which would
be of size less than &lt;span class=&quot;math inline&quot;&gt;\(m\)&lt;/span&gt;
(particularly critical is size 1), we assign the remaining individuals
to the &lt;span class=&quot;math inline&quot;&gt;\(l\)&lt;/span&gt; groups in round robin
fashion. This ensures that each group has size at least &lt;span
class=&quot;math inline&quot;&gt;\(m\)&lt;/span&gt;. Note: Depending on &lt;span
class=&quot;math inline&quot;&gt;\(n\)&lt;/span&gt; and &lt;span
class=&quot;math inline&quot;&gt;\(m\)&lt;/span&gt; the resulting sizes might be larger
&lt;span class=&quot;math inline&quot;&gt;\(m+1\)&lt;/span&gt;, but the difference in the
resulting group size will never be larger than 1&lt;a href=&quot;#fn1&quot;
class=&quot;footnote-ref&quot; id=&quot;fnref1&quot; role=&quot;doc-noteref&quot;&gt;&lt;sup&gt;1&lt;/sup&gt;&lt;/a&gt;.
Let &lt;code&gt;people&lt;/code&gt; be a tibble with a column &lt;code&gt;id&lt;/code&gt;
denoting a primary identifier key - this could, e.g., be the people’s
email address. An R function to perform a random assignment of the &lt;span
class=&quot;math inline&quot;&gt;\(n\)&lt;/span&gt;=&lt;code&gt;nrow(people)&lt;/code&gt; individuals
into groups of at least &lt;span class=&quot;math inline&quot;&gt;\(m\)&lt;/span&gt; could
look like:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb1&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb1-1&quot;&gt;&lt;a href=&quot;#cb1-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;#&amp;#39; Sample people into groups (original algorithm)&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-2&quot;&gt;&lt;a href=&quot;#cb1-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;#&amp;#39;&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-3&quot;&gt;&lt;a href=&quot;#cb1-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;#&amp;#39; @param people tibble containing name and email of available ppl&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-4&quot;&gt;&lt;a href=&quot;#cb1-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;#&amp;#39; @param m requested group size. If m not a divisor of nrow(people) then put leftovers in existing groups&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-5&quot;&gt;&lt;a href=&quot;#cb1-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;#&amp;#39;&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-6&quot;&gt;&lt;a href=&quot;#cb1-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;#&amp;#39; @return A list of vectors where each vector containing the ids (row number in ppl) of those belonging to the same group&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-7&quot;&gt;&lt;a href=&quot;#cb1-7&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;#&amp;#39;&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-8&quot;&gt;&lt;a href=&quot;#cb1-8&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;sample_groups &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;cf&quot;&gt;function&lt;/span&gt;(people, m) {&lt;/span&gt;
&lt;span id=&quot;cb1-9&quot;&gt;&lt;a href=&quot;#cb1-9&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;co&quot;&gt;# Number of groups needed&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-10&quot;&gt;&lt;a href=&quot;#cb1-10&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  n_g &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;nrow&lt;/span&gt;(people) &lt;span class=&quot;sc&quot;&gt;%/%&lt;/span&gt; m&lt;/span&gt;
&lt;span id=&quot;cb1-11&quot;&gt;&lt;a href=&quot;#cb1-11&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;co&quot;&gt;# Group membership indicator&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-12&quot;&gt;&lt;a href=&quot;#cb1-12&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  g &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;rep&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;seq_len&lt;/span&gt;(n_g), &lt;span class=&quot;at&quot;&gt;length.out=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;nrow&lt;/span&gt;(people))&lt;/span&gt;
&lt;span id=&quot;cb1-13&quot;&gt;&lt;a href=&quot;#cb1-13&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;co&quot;&gt;# Permutation order&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-14&quot;&gt;&lt;a href=&quot;#cb1-14&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  perm &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;sample&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;seq_len&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;nrow&lt;/span&gt;(people)))&lt;/span&gt;
&lt;span id=&quot;cb1-15&quot;&gt;&lt;a href=&quot;#cb1-15&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;/span&gt;
&lt;span id=&quot;cb1-16&quot;&gt;&lt;a href=&quot;#cb1-16&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;co&quot;&gt;# Make a list of ids in each group&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-17&quot;&gt;&lt;a href=&quot;#cb1-17&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  groups &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;map&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;seq_len&lt;/span&gt;(n_g), &lt;span class=&quot;cf&quot;&gt;function&lt;/span&gt;(i) {&lt;/span&gt;
&lt;span id=&quot;cb1-18&quot;&gt;&lt;a href=&quot;#cb1-18&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    idx &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; perm[&lt;span class=&quot;fu&quot;&gt;which&lt;/span&gt;(g &lt;span class=&quot;sc&quot;&gt;==&lt;/span&gt; i)]&lt;/span&gt;
&lt;span id=&quot;cb1-19&quot;&gt;&lt;a href=&quot;#cb1-19&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    people &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;slice&lt;/span&gt;(idx) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;pull&lt;/span&gt;(id)&lt;/span&gt;
&lt;span id=&quot;cb1-20&quot;&gt;&lt;a href=&quot;#cb1-20&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  })&lt;/span&gt;
&lt;span id=&quot;cb1-21&quot;&gt;&lt;a href=&quot;#cb1-21&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;/span&gt;
&lt;span id=&quot;cb1-22&quot;&gt;&lt;a href=&quot;#cb1-22&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;return&lt;/span&gt;(groups)&lt;/span&gt;
&lt;span id=&quot;cb1-23&quot;&gt;&lt;a href=&quot;#cb1-23&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Example: Let &lt;code&gt;people&lt;/code&gt; denote the population of 47
individuals to be assigned into groups of at least &lt;span
class=&quot;math inline&quot;&gt;\(m=4\)&lt;/span&gt; according to the above
description.&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb2&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb2-1&quot;&gt;&lt;a href=&quot;#cb2-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;n &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;dv&quot;&gt;47&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb2-2&quot;&gt;&lt;a href=&quot;#cb2-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;people &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;tibble&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;id =&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;str_c&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;quot;id&amp;quot;&lt;/span&gt;, &lt;span class=&quot;fu&quot;&gt;sprintf&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;quot;%0.2d&amp;quot;&lt;/span&gt;,&lt;span class=&quot;fu&quot;&gt;seq_len&lt;/span&gt;(n)))) &lt;/span&gt;
&lt;span id=&quot;cb2-3&quot;&gt;&lt;a href=&quot;#cb2-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;m &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;dv&quot;&gt;4&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb2-4&quot;&gt;&lt;a href=&quot;#cb2-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;groups &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;sample_groups&lt;/span&gt;(people, &lt;span class=&quot;at&quot;&gt;m=&lt;/span&gt;m)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;This leads to 11 groups with between 4 and 5 members. We can
visualize the group allocation as a graph, where each group will
correspond to a fully connected sub-graph, but with no connections
between the sub-graphs.&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/blog/figure/source/2021-04-04-socialsamp/unnamed-chunk-4-1.png&quot; style=&quot;display: block; margin: auto;&quot; /&gt;&lt;/p&gt;
&lt;h3 id=&quot;mathematical-formulation&quot;&gt;Mathematical Formulation&lt;/h3&gt;
&lt;p&gt;The mathematical question is now: Given you were in the group with
&lt;span class=&quot;math inline&quot;&gt;\(l\)&lt;/span&gt; other persons the last time, what
is the probability that after assigning &lt;span
class=&quot;math inline&quot;&gt;\(n\)&lt;/span&gt; individuals into groups of preferred
size &lt;span class=&quot;math inline&quot;&gt;\(m\geq 2\)&lt;/span&gt;, that you will be in
the same group with at least one of them again this time&lt;a href=&quot;#fn2&quot;
class=&quot;footnote-ref&quot; id=&quot;fnref2&quot; role=&quot;doc-noteref&quot;&gt;&lt;sup&gt;2&lt;/sup&gt;&lt;/a&gt;.
Let &lt;span class=&quot;math inline&quot;&gt;\(m \leq k\)&lt;/span&gt; be the size of your
group in the current assignment. Combinatorical considerations tell us
the probability to meet at least one of the &lt;span
class=&quot;math inline&quot;&gt;\(l\)&lt;/span&gt; persons again is:&lt;/p&gt;
&lt;p&gt;&lt;span class=&quot;math display&quot;&gt;\[
p(k, l, n) = 1 - \frac{1\cdot\prod_{i=2}^{k}
(n-(l+i-1))}{1\cdot\prod_{i=2}^{k} (n-i+1)}.
\]&lt;/span&gt; In order to determine the overall probability for a reunion
after assignment, we need to determine the PMF &lt;span
class=&quot;math inline&quot;&gt;\(f_{n,m}\)&lt;/span&gt; of the group size, i.e. what is
the probability that the algorithm dividing &lt;span
class=&quot;math inline&quot;&gt;\(n\)&lt;/span&gt; individuals into groups of size at
least &lt;span class=&quot;math inline&quot;&gt;\(m\)&lt;/span&gt; will assign me to a group
of size &lt;span class=&quot;math inline&quot;&gt;\(k, k\geq m\)&lt;/span&gt;. The probability
of interest is then: &lt;span class=&quot;math display&quot;&gt;\[
p(n,m,l) = \sum_{k=1}^\infty p(k,l,n) f_{n,m}(k)
\]&lt;/span&gt; Note: Even though we write the summation to be from 1 to &lt;span
class=&quot;math inline&quot;&gt;\(\infty\)&lt;/span&gt;, the PMF will only have support on
at most two integers.&lt;/p&gt;
&lt;p&gt;The calculations in R and verified by 1000 Monte Carlo
simulations:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb3&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb3-1&quot;&gt;&lt;a href=&quot;#cb3-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;# Group membership indicator for the n individuals&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb3-2&quot;&gt;&lt;a href=&quot;#cb3-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;g &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;rep&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;seq_len&lt;/span&gt;(n &lt;span class=&quot;sc&quot;&gt;%/%&lt;/span&gt; m), &lt;span class=&quot;at&quot;&gt;length.out=&lt;/span&gt;n)&lt;/span&gt;
&lt;span id=&quot;cb3-3&quot;&gt;&lt;a href=&quot;#cb3-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb3-4&quot;&gt;&lt;a href=&quot;#cb3-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;# Which previous group sizes to consider. Note:&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb3-5&quot;&gt;&lt;a href=&quot;#cb3-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;# can be way beyond m, even if m was selected&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb3-6&quot;&gt;&lt;a href=&quot;#cb3-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;p_groupsize &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;prop.table&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;table&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;table&lt;/span&gt;(g)))&lt;/span&gt;
&lt;span id=&quot;cb3-7&quot;&gt;&lt;a href=&quot;#cb3-7&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb3-8&quot;&gt;&lt;a href=&quot;#cb3-8&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;p_kln &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;sapply&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;as.numeric&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;names&lt;/span&gt;(p_groupsize)), prob_reunion, &lt;span class=&quot;at&quot;&gt;l=&lt;/span&gt;l, &lt;span class=&quot;at&quot;&gt;n=&lt;/span&gt;n)&lt;/span&gt;
&lt;span id=&quot;cb3-9&quot;&gt;&lt;a href=&quot;#cb3-9&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;c&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;p_analytical =&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;sum&lt;/span&gt;(p_kln &lt;span class=&quot;sc&quot;&gt;*&lt;/span&gt; p_groupsize), &lt;span class=&quot;at&quot;&gt;p_mc =&lt;/span&gt; p_reunion_mc) &lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;## p_analytical         p_mc 
##    0.2024913    0.2010000&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;We can illustrate this reunion probability as a function of &lt;span
class=&quot;math inline&quot;&gt;\(k\)&lt;/span&gt; and &lt;span
class=&quot;math inline&quot;&gt;\(n\)&lt;/span&gt;.&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/blog/figure/source/2021-04-04-socialsamp/plot_p_reunion-1.png&quot; style=&quot;display: block; margin: auto;&quot; /&gt;&lt;/p&gt;
&lt;p&gt;As a next step we need to marginalise out the previous group size
&lt;span class=&quot;math inline&quot;&gt;\(l+1\)&lt;/span&gt;. For simplicity, we will assume
that exactly the same participants participate in each round. Hence, we
can use the same group size PMF as before when summing out &lt;span
class=&quot;math inline&quot;&gt;\(l\)&lt;/span&gt;: &lt;span class=&quot;math display&quot;&gt;\[
p(n,m) = \sum_{l=1}^\infty \sum_{k=1}^\infty p(k,l,n) f_{n,m}(k)
f_{n,m}(l+1)
\]&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;The result thus denotes the probability that you in two consecutive
assigments of &lt;span class=&quot;math inline&quot;&gt;\(n\)&lt;/span&gt; individuals into
groups of at least &lt;span class=&quot;math inline&quot;&gt;\(m\)&lt;/span&gt; individuals
will be in the same group with someone twice. We will denote this the
&lt;em&gt;reunion probability&lt;/em&gt;. The graph below shows this probability as
a function of &lt;span class=&quot;math inline&quot;&gt;\(n\)&lt;/span&gt; and &lt;span
class=&quot;math inline&quot;&gt;\(m\)&lt;/span&gt; and is also available in a &lt;a
href=&quot;/blog/figure/source/2021-04-04-socialsamp/p_meetagain_log.png&quot;&gt;log-x
axis version&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/blog/figure/source/2021-04-04-socialsamp/plot_p_meetagain-1.png&quot; style=&quot;display: block; margin: auto;&quot; /&gt;&lt;/p&gt;
&lt;p&gt;Why are the curves not decreasing monotonically?&lt;a href=&quot;#fn3&quot;
class=&quot;footnote-ref&quot; id=&quot;fnref3&quot; role=&quot;doc-noteref&quot;&gt;&lt;sup&gt;3&lt;/sup&gt;&lt;/a&gt;
This is due to the minimum size &lt;span class=&quot;math inline&quot;&gt;\(m\)&lt;/span&gt;
restriction on the group size. If &lt;span
class=&quot;math inline&quot;&gt;\(m=6\)&lt;/span&gt; and you have &lt;span
class=&quot;math inline&quot;&gt;\(n=12\)&lt;/span&gt; people then there are two groups.
But if &lt;span class=&quot;math inline&quot;&gt;\(n=17\)&lt;/span&gt; while &lt;span
class=&quot;math inline&quot;&gt;\(m\)&lt;/span&gt; is still 6, then we will still only
have two groups as one would need 18 people for 3 groups. However, there
are now 8 and 9 people in the two groups instead of 6 and 6 so the
probability of reunion increases. Altogether, the probability increases
from 12 and 17 until it decreases again at &lt;span
class=&quot;math inline&quot;&gt;\(n=18\)&lt;/span&gt;. Consequently, for &lt;span
class=&quot;math inline&quot;&gt;\(m=2\)&lt;/span&gt; the peaks would be at the even &lt;span
class=&quot;math inline&quot;&gt;\(n\)&lt;/span&gt; and the troughs would be the odd &lt;span
class=&quot;math inline&quot;&gt;\(n\)&lt;/span&gt;.&lt;/p&gt;
&lt;p&gt;Given our &lt;span class=&quot;math inline&quot;&gt;\(n=47\)&lt;/span&gt; and &lt;span
class=&quot;math inline&quot;&gt;\(m=4\)&lt;/span&gt; we also note the high probability of
22% for a reunion, which confirms our empirical experience. Thus there
seems to be a need to impose some additional constraints on the grouping
in order to optimize social diversity. For a translation of &lt;span
class=&quot;math inline&quot;&gt;\(m\)&lt;/span&gt; into the number of breakout rooms used
in Zoom, see Appendix A.&lt;/p&gt;
&lt;h3 id=&quot;grouping-with-avoidance&quot;&gt;Grouping with avoidance&lt;/h3&gt;
&lt;p&gt;Let &lt;code&gt;pairs&lt;/code&gt; be a tibble with columns &lt;code&gt;id1&lt;/code&gt; and
&lt;code&gt;id2&lt;/code&gt; denoting all pairs of individuals who were placed in
the same group the last time. We now want to enhance our group
allocation algorithm to only assign people into groups, if they were not
in the same group the last time. We do this by a simple rejection
sampling algorithm, where we draw a configuration with
&lt;code&gt;sample_groups&lt;/code&gt;, check if it has overlaps with the last
allocation, and if so, draw again. This method is not very efficient and
might take a while. Even worse: it might not finish at all, if no
configuration satisfying the constraint exist. An example is, if 9
individuals are to be divided into groups of at least 4 two times
without any reunions. The corresponding code of such a
&lt;code&gt;sample_groups_avoid&lt;/code&gt; function is available in the &lt;a
href=&quot;https://raw.githubusercontent.com/hoehleatsu/hoehleatsu.github.io/master/_source/2021-04-04-socialsamp.Rmd&quot;&gt;R
code&lt;/a&gt; from GitHub. This can then be used to generate the desired
grouping without reunions:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb5&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb5-1&quot;&gt;&lt;a href=&quot;#cb5-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;# Sampling in round1 and round2&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb5-2&quot;&gt;&lt;a href=&quot;#cb5-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;groups_r1 &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;sample_groups&lt;/span&gt;(people, &lt;span class=&quot;at&quot;&gt;m=&lt;/span&gt;m)&lt;/span&gt;
&lt;span id=&quot;cb5-3&quot;&gt;&lt;a href=&quot;#cb5-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;groups_r2 &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;sample_groups_avoid&lt;/span&gt;(people, &lt;span class=&quot;at&quot;&gt;m=&lt;/span&gt;m, &lt;span class=&quot;at&quot;&gt;avoid_pairs =&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;make_pairs&lt;/span&gt;(groups_r1))&lt;/span&gt;
&lt;span id=&quot;cb5-4&quot;&gt;&lt;a href=&quot;#cb5-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb5-5&quot;&gt;&lt;a href=&quot;#cb5-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;# Check if there are any re-unions. Note: There should be none.&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb5-6&quot;&gt;&lt;a href=&quot;#cb5-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;inner_join&lt;/span&gt;( &lt;span class=&quot;fu&quot;&gt;make_pairs&lt;/span&gt;(groups_r1) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;select&lt;/span&gt;(hash), &lt;span class=&quot;fu&quot;&gt;make_pairs&lt;/span&gt;(groups_r2) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;select&lt;/span&gt;(hash), &lt;span class=&quot;at&quot;&gt;by=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;hash&amp;quot;&lt;/span&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;## # A tibble: 0 x 1
## # … with 1 variable: hash &amp;lt;chr&amp;gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;In other words: No reunions, just as we wanted.&lt;/p&gt;
&lt;h2 id=&quot;discussion&quot;&gt;Discussion&lt;/h2&gt;
&lt;p&gt;We considered random groupings used, e.g., in lunch roulette or when
distributing students into breakout rooms. Depending on the number of
people to group and the anticipated group size the probability for a
reunion with somebody from last weeks grouping is surprisingly high.
Hence, we use rejection sampling to propose a configuration, where no
reunion occurs. The resulting grouping can easily be exported to a CSV
file for import when making &lt;a
href=&quot;https://support.zoom.us/hc/en-us/articles/360032752671-Pre-assigning-Participants-to-Breakout-Rooms&quot;&gt;pre-assigned
Zoom breakout rooms&lt;/a&gt; (example in the &lt;a
href=&quot;https://raw.githubusercontent.com/hoehleatsu/hoehleatsu.github.io/master/_source/2021-04-04-socialsamp.Rmd&quot;&gt;R
code&lt;/a&gt; on GitHub). Even better allocations might be possible as part
of solving the maximally diverse grouping problem. For further
combinatorics posts, see also my work on the &lt;a
href=&quot;https://staff.math.su.se/hoehle/blog/2017/02/13/bday.html&quot;&gt;birthday
problem with unequal probabilities&lt;/a&gt;.&lt;/p&gt;
&lt;h4 id=&quot;acknowledgments&quot;&gt;Acknowledgments&lt;/h4&gt;
&lt;p&gt;Thanks to Dirk, Titus and Filip for the challenge.&lt;/p&gt;
&lt;h2 id=&quot;appendix-a&quot;&gt;Appendix A&lt;/h2&gt;
&lt;p&gt;Since the Zoom grouping does not work by specifying the number of
individuals in each group, but instead the number of groups, we show an
equivalent representation of the reunion probability graph as a function
of the number of groups, i.e. &lt;span class=&quot;math inline&quot;&gt;\(\lfloor
n/m\rfloor\)&lt;/span&gt;. Since we did the math in &lt;span
class=&quot;math inline&quot;&gt;\(m\)&lt;/span&gt;, not every breakout room size is found.
This also means that the shown graph is only an approximation, because
the Zoom allocation algorithm is likely to work slightly different to
our proposed &lt;code&gt;sample_groups&lt;/code&gt; algorithm.&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/blog/figure/source/2021-04-04-socialsamp/plot_p_breakout_rooms-1.png&quot; style=&quot;display: block; margin: auto;&quot; /&gt;&lt;/p&gt;
&lt;h2 id=&quot;appendix-b&quot;&gt;Appendix B&lt;/h2&gt;
&lt;p&gt;As a consequence from the calculation and functions from this post we
can now answer the following question from our &lt;a
href=&quot;https://www.math.su.se/english/research/research-groups/research-group-in-mathematical-statistics-1.330441&quot;&gt;SU
Mathematical Statistics&lt;/a&gt; Zoom Christmas Party announcement:&lt;/p&gt;
&lt;div class=&quot;framedbox&quot;&gt;
&lt;em&gt;At 15:00 We will use the breakout room Zoom function that randomly
divides the participants into smaller groups (5 persons). At 15:15 and
15:30 we will randomize to form new groups. The natural question that
arises is: what is the probability that you and some other colleague
spend the entire 45 minutes together?&lt;/em&gt;
&lt;/div&gt;
&lt;p&gt;
&lt;p&gt;Through simulations (details in the &lt;a
href=&quot;https://raw.githubusercontent.com/hoehleatsu/hoehleatsu.github.io/master/_source/2021-04-04-socialsamp.Rmd&quot;&gt;code&lt;/a&gt;)
built on top of the &lt;code&gt;sample_groups&lt;/code&gt; function we determine
that the requested probability when &lt;span
class=&quot;math inline&quot;&gt;\(n=30\)&lt;/span&gt; participate in the X-mas party is
7.6%.&lt;/p&gt;
&lt;h2 id=&quot;literature&quot;&gt;Literature&lt;/h2&gt;
&lt;section id=&quot;footnotes&quot; class=&quot;footnotes footnotes-end-of-document&quot;
role=&quot;doc-endnotes&quot;&gt;
&lt;hr /&gt;
&lt;ol&gt;
&lt;li id=&quot;fn1&quot;&gt;&lt;p&gt;As an example consider the case &lt;span
class=&quot;math inline&quot;&gt;\(n=7\)&lt;/span&gt; and &lt;span
class=&quot;math inline&quot;&gt;\(m=4\)&lt;/span&gt;, where we according to our
specification would form 1 group with 7 members.&lt;a href=&quot;#fnref1&quot;
class=&quot;footnote-back&quot; role=&quot;doc-backlink&quot;&gt;↩︎&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;
&lt;li id=&quot;fn2&quot;&gt;&lt;p&gt;We will assume that the &lt;span
class=&quot;math inline&quot;&gt;\(l\)&lt;/span&gt; individuals you met last week all
participate again this week.&lt;a href=&quot;#fnref2&quot; class=&quot;footnote-back&quot;
role=&quot;doc-backlink&quot;&gt;↩︎&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;
&lt;li id=&quot;fn3&quot;&gt;&lt;p&gt;Thanks to &lt;a
href=&quot;https://www.reddit.com/r/math/comments/mjy7nx/probability_to_meet_someone_again_when_assigning/gtd33xi?utm_source=share&amp;amp;utm_medium=web2x&amp;amp;context=3&quot;&gt;u/antichain&lt;/a&gt;
for the question and to &lt;a
href=&quot;https://www.reddit.com/r/math/comments/mjy7nx/probability_to_meet_someone_again_when_assigning/gtd4c8t?utm_source=share&amp;amp;utm_medium=web2x&amp;amp;context=3&quot;&gt;u/assiraN&lt;/a&gt;
for the nice answer with examples, which I’ve integrated into the
post.&lt;a href=&quot;#fnref3&quot; class=&quot;footnote-back&quot;
role=&quot;doc-backlink&quot;&gt;↩︎&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;/section&gt;
</description>
        <pubDate>Sun, 04 Apr 2021 00:00:00 +0200</pubDate>
        <link>https://mhoehle.github.io/blog/2021/04/04/socialsamp.html</link>
        <guid isPermaLink="true">https://mhoehle.github.io/blog/2021/04/04/socialsamp.html</guid>
        
        <category>rstats</category>
        
        <category>combinatorics</category>
        
        <category>R</category>
        
        
      </item>
    
      <item>
        <title>Age-Structure Adjusted All-Cause Mortality</title>
        <description>&lt;!-- bibliography: ~/Literature/Bibtex/jabref.bib --&gt;
&lt;h2 id=&quot;abstract&quot;&gt;Abstract:&lt;/h2&gt;
&lt;p&gt;This page is an updated version of the 2020-12-28 blog post &lt;a
href=&quot;https://staff.math.su.se/hoehle/blog/2020/12/28/mort.html&quot;&gt;Age
Stratified All-Cause and COVID-19 Associated Mortality&lt;/a&gt;. The post
considers the age stratified all-cause and COVID-19 associated mortality
in Germany during 2020 based on numbers provided by the Federal
Statistical Office and the Robert Koch Institute. Important extensions
compared to the original post are:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;an improved population adjusted expected mortality calculation&lt;/li&gt;
&lt;li&gt;an update of the analysis containing the 2020 numbers as of
2021-03-13&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Note: The present analyses were previously kept in a separate updated
R-Markdown file, which was updated until 2021-01-29. The present text is
a conversion of this document into a blog post including a treamtnet of
week 53, but does not contain any updated interpretations compared to
the 2021-01-29 version.&lt;/p&gt;
&lt;center&gt;
&lt;img src=&quot;/blog/figure/source/2021-03-01-mortadj/sterbefaelle_incidence.png&quot; width=&quot;550&quot;&gt;
&lt;/center&gt;
&lt;p&gt;&lt;br&gt;
&lt;a rel=&quot;license&quot; href=&quot;http://creativecommons.org/licenses/by-sa/4.0/&quot;&gt;&lt;img alt=&quot;Creative Commons License&quot; style=&quot;border-width:0&quot; src=&quot;https://i.creativecommons.org/l/by-sa/4.0/88x31.png&quot;/&gt;&lt;/a&gt;
This work is licensed under a &lt;a rel=&quot;license&quot;
href=&quot;http://creativecommons.org/licenses/by-sa/4.0/&quot;&gt;Creative Commons
Attribution-ShareAlike 4.0 International License&lt;/a&gt;. The &lt;a
href=&quot;https://raw.githubusercontent.com/hoehleatsu/hoehleatsu.github.io/master/_source/2021-03-01-mortadj.Rmd&quot;&gt;R-markdown
source code&lt;/a&gt; of this blog is available under a &lt;a
href=&quot;https://www.gnu.org/licenses/gpl-3.0.html&quot;&gt;GNU General Public
License (GPL v3)&lt;/a&gt; license from GitHub.&lt;/p&gt;
&lt;h2 id=&quot;introduction&quot;&gt;Introduction&lt;/h2&gt;
&lt;p&gt;All-cause mortality is one of indicators used to measure the impact
of the COVID-19 pandemic, because this indicator is less biased by the
testing strategy needed to identify cases to have died while having a
recent COVID-19 diagnosis. Several ressources (&lt;a
href=&quot;https://ourworldindata.org/covid-excess-mortality&quot;&gt;OurWorldInData&lt;/a&gt;,
&lt;a
href=&quot;https://www.ft.com/content/a2901ce8-5eb7-4633-b89c-cbdf5b386938&quot;&gt;Financial
Times&lt;/a&gt;, &lt;span class=&quot;citation&quot; data-cites=&quot;aburto_etal2021&quot;&gt;Aburto et
al. (2021)&lt;/span&gt;) have used this indicator to compare the COVID-19
response between countries. Since both death and COVID-19 have a strong
age component, it appears crucial to take an age-stratified view on both
all-cause mortality as well as deaths associated with COVID-19. The &lt;a
href=&quot;https://raw.githubusercontent.com/hoehleatsu/hoehleatsu.github.io/master/_source/2021-03-01-mortadj.Rmd&quot;&gt;R-markdown
source code&lt;/a&gt; of this blog is available from GitHub.&lt;/p&gt;
&lt;h2 id=&quot;age-stratified-mortality&quot;&gt;Age Stratified Mortality&lt;/h2&gt;
&lt;p&gt;Real-time mortality monitoring is not common in Germany, as can be
seen from the coverage of the &lt;a
href=&quot;https://www.euromomo.eu/&quot;&gt;EuroMoMo monitoring&lt;/a&gt; for Germany,
where only the two federal states Hesse and Berlin participate. However,
as part of the COVID-19 response, the Federal Statistical Office
(Destatis) now provides weekly updated &lt;a
href=&quot;https://www.destatis.de/DE/Themen/Querschnitt/Corona/Gesellschaft/kontextinformationen-gesellschaft.html#Sterbe&quot;&gt;preliminary
mortality statistics of all-cause mortality in 2020&lt;/a&gt;. The methodology
behind the numbers as well as age-stratified additional analyses are
described in an accompanying &lt;a
href=&quot;https://www.destatis.de/DE/Methoden/WISTA-Wirtschaft-und-Statistik/2020/04/sonderauswertung-sterbefallzahlen-042020.pdf?__blob=publicationFile&quot;&gt;publication&lt;/a&gt;
&lt;span class=&quot;citation&quot; data-cites=&quot;zurnieden_etal2020&quot;&gt;(zur Nieden,
Sommer, and Lüken 2020)&lt;/span&gt;. The age-stratified analyses are
unfortunately not continuously updated, however, up-to-date data are
made publicly &lt;a
href=&quot;https://www.destatis.de/DE/Themen/Gesellschaft-Umwelt/Bevoelkerung/Sterbefaelle-Lebenserwartung/Tabellen/sonderauswertung-sterbefaelle.html?nn=209016&quot;&gt;available&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;The age-stratified reported COVID-19 associated deaths (by week of
death) are obtained from an &lt;a
href=&quot;https://www.rki.de/DE/Content/InfAZ/N/Neuartiges_Coronavirus/Projekte_RKI/COVID-19_Todesfaelle.html&quot;&gt;export
of the RKI&lt;/a&gt;. In order to compensate for reporting delays of deaths,
the Destatis analysis only goes until 4 weeks before the time point of
analysis, but in this post we shall only be interested in the 2020
results. As additional data source we use the &lt;a
href=&quot;https://www.rki.de/DE/Content/InfAZ/N/Neuartiges_Coronavirus/Projekte_RKI/COVID-19_Todesfaelle.html&quot;&gt;age-stratified
weekly time series by time of death&lt;/a&gt; reported by RKI.&lt;/p&gt;
&lt;h2 id=&quot;preliminary-destatis-mortality-data&quot;&gt;Preliminary Destatis
Mortality Data&lt;/h2&gt;
&lt;p&gt;Available all-cause deaths (by week of death) are available from &lt;a
href=&quot;https://www.destatis.de/EN/Home/_node.html&quot;&gt;Destatis&lt;/a&gt; until
2021-W07. Hwoever, we will only use the data until the end of 2020 in
this post. Note that Destatis stresses the &lt;a
href=&quot;https://twitter.com/FlorianBurg2/status/1343903541849681922?s=20&quot;&gt;preliminary
character of the data&lt;/a&gt; - the numbers might change as further deaths
arrive, however, as of 2021-03-13 changes are expected to be small.
Stratified by age the times series for 2020 compared to the years
2016-2019 looks as follows - please beware of the different y-axes for
the age-groups in the plot:&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/blog/figure/source/2021-03-01-mortadj/AGEMORT-1.png&quot; style=&quot;display: block; margin: auto;&quot; /&gt;&lt;/p&gt;
&lt;p&gt;Note: Because the years 2016-2019 do not contain a week 53, we obtain
a hypothetical week 53 value for year &lt;span class=&quot;math inline&quot;&gt;\(Y,
Y=2016,\ldots, 2019\)&lt;/span&gt;, for comparison in the plot by averaging
the observed counts in &lt;span class=&quot;math inline&quot;&gt;\(Y\)&lt;/span&gt;-W52 and
&lt;span class=&quot;math inline&quot;&gt;\((Y+1)\)&lt;/span&gt;-W01.&lt;/p&gt;
&lt;p&gt;Since the age-groups contain different population sizes and - as
pointed out by &lt;span class=&quot;citation&quot; data-cites=&quot;ragnitz2021&quot;&gt;Ragnitz
(2021)&lt;/span&gt; - population sizes of the age-groups changed relevantly
2016-2019, a better comparison between age-groups instead of absolute
numbers is by &lt;a href=&quot;sterbefaelle_incidence.png&quot;&gt;incidence rate&lt;/a&gt;
(i.e. deaths per 100,000 population in the age group). For this, the
yearly Destatis &lt;a
href=&quot;https://www-genesis.destatis.de/genesis//online?operation=table&amp;amp;code=12411-0012&amp;amp;bypass=true&amp;amp;levelindex=0&amp;amp;levelid=1610148266727#abreadcrumb&quot;&gt;age-specific
population data&lt;/a&gt; available for the cut-off-date Dec 31st for
2015-2019 are linearly interpolated for the weeks. An estimate of the
2020 population is obtained from the 2020 value of the &lt;a
href=&quot;https://www.destatis.de/DE/Themen/Gesellschaft-Umwelt/Bevoelkerung/Bevoelkerungsvorausberechnung/Publikationen/Downloads-Vorausberechnung/bevoelkerung-bundeslaender-2060-5124205199024.html&quot;&gt;destatis
population projection&lt;/a&gt; (Variant G2-L2-W2).&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/blog/figure/source/2021-03-01-mortadj/POPDYNAMICS-1.png&quot; style=&quot;display: block; margin: auto;&quot; /&gt;&lt;/p&gt;
&lt;p&gt;We notice the strong increase in size of the [80,90) year old age
group (increase by 26%) and the noticable decline in the groups of
[40,50) (-12%) and [70,80) (-9%) in just 5 years. Although not large in
absolute size compared to the other age groups, the [90,Inf) group
increased by 18%. These changes, and in particular those in the higher
age groups, will be relevant for the analysis of excess mortality.&lt;/p&gt;
&lt;p&gt;Once we have the weekly age-specific population estimates available
we can compute the incidence per week and age-group. Below the weekly
mortality incidence rate (per 100 000 population) is shown for 2020
compared to the minimum, mean and maximum of the corresponding week for
the years 2016-2019.&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/blog/figure/source/2021-03-01-mortadj/AGEMORTINC-1.png&quot; style=&quot;display: block; margin: auto;&quot; /&gt;&lt;/p&gt;
&lt;p&gt;Compared to the graphic with the absolute number of deaths, one
notices that the population adjustment leads to a smaller excess in the
[80-90) group (because the population in this group became larger). On
the other hand, the Nov-Dec 2020 curve in the [70-80) group now is
clearer in excess of the expected. For further insights see also &lt;span
class=&quot;citation&quot; data-cites=&quot;kauermann_etal2021&quot;&gt;Kauermann et al.
(2021)&lt;/span&gt; and &lt;span class=&quot;citation&quot;
data-cites=&quot;ragnitz2021&quot;&gt;Ragnitz (2021)&lt;/span&gt;.&lt;/p&gt;
&lt;p&gt;To underline the age-gradient of all-cause mortality: 56% of the
deaths 2016-2019 occured in the age group of 80+ years (90% in the age
group of 60+). It becomes clear that the 2020 mortality in the 80+ age
groups was rather low during the first 10-12 weeks and then had a spike
in connection with the first COVID-19 wave (March-April). Subsequently,
a summer peak (possibly associated with heat) is followed by an
increasing and ongoing upward trend in December. One challenge for a
statistical analysis of these numbers is to figure out how much of the
upward trend is “catch-up mortality” due to the lower mortality in the
beginning of the year and how much is excess related to COVID-19.
However, both &lt;span class=&quot;citation&quot;
data-cites=&quot;kauermann_etal2021&quot;&gt;Kauermann et al. (2021)&lt;/span&gt; and &lt;span
class=&quot;citation&quot; data-cites=&quot;ragnitz2021&quot;&gt;Ragnitz (2021)&lt;/span&gt; show
that the excess can be well explained by COVID-19 associated deaths.&lt;/p&gt;
&lt;p&gt;An initial analysis of this question consists of summing the
all-cause mortalities from W1 until W53 for 2020 (observed) and compare
this to the summation of the weekly mean of 2016-2019 for the
corresponding time period (expected). Since both 2021-W01 and 2020-W53
contains days outside the year 2020 we weight these two weeks in the
summation according to the number of days in 2020 (i.e. 5/7 and 4/7). As
a consequence, our number of deaths deviates slightly against a more
exact calculation based on daily deaths (which however does not have
age-strata publically available). Note: This calculation method ignores
the population changes in the years 2016-2020. Furthermore:&lt;/p&gt;
&lt;table class=&quot; lightable-classic&quot; style=&quot;font-family: &amp;quot;Arial Narrow&amp;quot;, &amp;quot;Source Sans Pro&amp;quot;, sans-serif; margin-left: auto; margin-right: auto;border-bottom: 0;&quot;&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th style=&quot;text-align:left;&quot;&gt;
Age group
&lt;/th&gt;
&lt;th style=&quot;text-align:right;&quot;&gt;
observed_2020
&lt;/th&gt;
&lt;th style=&quot;text-align:right;&quot;&gt;
expected_20162019
&lt;/th&gt;
&lt;th style=&quot;text-align:right;&quot;&gt;
Percent change
&lt;/th&gt;
&lt;th style=&quot;text-align:right;&quot;&gt;
min_20162019
&lt;/th&gt;
&lt;th style=&quot;text-align:right;&quot;&gt;
max_20162019
&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:left;&quot;&gt;
[00,30)
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
7285
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
7781
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
-6%
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
7508
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
8116
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:left;&quot;&gt;
[30,40)
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
6811
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
6445
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
6%
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
6371
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
6512
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:left;&quot;&gt;
[40,50)
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
15658
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
16917
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
-7%
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
15505
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
18557
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:left;&quot;&gt;
[50,60)
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
57485
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
58060
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
-1%
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
56823
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
58943
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:left;&quot;&gt;
[60,70)
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
118313
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
111742
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
6%
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
107755
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
114922
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:left;&quot;&gt;
[70,80)
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
201411
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
211212
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
-5%
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
202435
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
216055
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:left;&quot;&gt;
[80,90)
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
378011
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
340670
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
11%
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
325392
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
349797
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:left;&quot;&gt;
[90,Inf)
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
199646
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
178355
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
12%
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
165384
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
185617
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr grouplength=&quot;1&quot;&gt;
&lt;td colspan=&quot;6&quot; style=&quot;border-bottom: 0;&quot;&gt;
&lt;strong&gt;Total&lt;/strong&gt;
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:left;padding-left: 2em;color: black !important;background-color: lightgray !important;&quot; indentlevel=&quot;1&quot;&gt;
&lt;/td&gt;
&lt;td style=&quot;text-align:right;color: black !important;background-color: lightgray !important;&quot;&gt;
984621
&lt;/td&gt;
&lt;td style=&quot;text-align:right;color: black !important;background-color: lightgray !important;&quot;&gt;
931182
&lt;/td&gt;
&lt;td style=&quot;text-align:right;color: black !important;background-color: lightgray !important;&quot;&gt;
6%
&lt;/td&gt;
&lt;td style=&quot;text-align:right;color: black !important;background-color: lightgray !important;&quot;&gt;
906309
&lt;/td&gt;
&lt;td style=&quot;text-align:right;color: black !important;background-color: lightgray !important;&quot;&gt;
984621
&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;tfoot&gt;
&lt;tr&gt;
&lt;td style=&quot;padding: 0; &quot; colspan=&quot;100%&quot;&gt;
&lt;sup&gt;a&lt;/sup&gt; Min and max for row ‘Total’ is obtained by first summing
each of the years 2016-2019 and then take the min and max.
&lt;/td&gt;
&lt;/tr&gt;
&lt;/tfoot&gt;
&lt;/table&gt;
&lt;p&gt;
&lt;p&gt;Note: The exact mortality count for 2020 by Destatis using daily data
is 985145, hence, the weighted weekly summation does produce a small
discrepancy from this value. The total proportion of 2020-W1 to 2020-W53
mortalities in the 80+ age group is currently 59%, i.e. a slightly
higher proportion than in the previous years.&lt;/p&gt;
&lt;p&gt;A population age-structure adjusted estimate can be obtained using an
indirect standardization approach &lt;span class=&quot;citation&quot;
data-cites=&quot;keiding_clayton2014&quot;&gt;(Keiding and Clayton 2014)&lt;/span&gt;: For
each age group we compute the weekly incidence rates 2016-2019, then for
each week we take the min, mean and max of the 2016-2020 incidences. If
we for a given age-group and week want an expected number of deaths
based on the 2016-2019 data, we would multiply the 2016-2019 mean
incidence on the corresponding 2020 population in order to get the
expected number of deaths in the corresponding age-group and week of
2020. Because the estimated incidence rates for 2016-2019 are based on
slightly different population sizes, one could acknowledge this in the
mean-calculation by instead computing an inverse variance weighted mean
(or use logistic regression). However, numerical differences are
neglible so we proceed with the equal weighting of the mean. The
computations lead to the following table for the age-population adjusted
2020 mortality:&lt;/p&gt;
&lt;table class=&quot; lightable-classic&quot; style=&quot;font-family: &amp;quot;Arial Narrow&amp;quot;, &amp;quot;Source Sans Pro&amp;quot;, sans-serif; margin-left: auto; margin-right: auto;&quot;&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th style=&quot;text-align:left;&quot;&gt;
Age group
&lt;/th&gt;
&lt;th style=&quot;text-align:right;&quot;&gt;
observed_2020
&lt;/th&gt;
&lt;th style=&quot;text-align:right;&quot;&gt;
expected_20162019
&lt;/th&gt;
&lt;th style=&quot;text-align:right;&quot;&gt;
Percent change
&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:left;&quot;&gt;
[00,30)
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
7285
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
7770
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
-6%
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:left;&quot;&gt;
[30,40)
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
6811
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
6732
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
1%
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:left;&quot;&gt;
[40,50)
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
15658
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
15990
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
-2%
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:left;&quot;&gt;
[50,60)
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
57485
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
58709
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
-2%
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:left;&quot;&gt;
[60,70)
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
118313
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
118596
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
0%
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:left;&quot;&gt;
[70,80)
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
201411
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
202851
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
-1%
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:left;&quot;&gt;
[80,90)
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
378011
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
387314
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
-2%
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:left;&quot;&gt;
[90,Inf)
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
199646
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
194453
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
3%
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr grouplength=&quot;1&quot;&gt;
&lt;td colspan=&quot;4&quot; style=&quot;border-bottom: 0;&quot;&gt;
&lt;strong&gt;Total&lt;/strong&gt;
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:left;padding-left: 2em;color: black !important;background-color: lightgray !important;&quot; indentlevel=&quot;1&quot;&gt;
&lt;/td&gt;
&lt;td style=&quot;text-align:right;color: black !important;background-color: lightgray !important;&quot;&gt;
984621
&lt;/td&gt;
&lt;td style=&quot;text-align:right;color: black !important;background-color: lightgray !important;&quot;&gt;
992416
&lt;/td&gt;
&lt;td style=&quot;text-align:right;color: black !important;background-color: lightgray !important;&quot;&gt;
-1%
&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;What looked like a small excess in the raw calculations becomes a
small negative excess after population adjustment by the proposed
method. This shows the importance of computing the expected number of
cases in a population adjustment way, which was the point of &lt;span
class=&quot;citation&quot; data-cites=&quot;ragnitz2021&quot;&gt;Ragnitz (2021)&lt;/span&gt;.&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/blog/figure/source/2021-03-01-mortadj/weekly_smr-1.png&quot; style=&quot;display: block; margin: auto;&quot; /&gt;&lt;/p&gt;
&lt;p&gt;Altogether, the mild mortality in the older age groups during the
first weeks (e.g. due to a mild influenza season) so far balances the
continuing excess in the higher age-groups since Mar-Apr, which
coincides with the start of the COVID-19 pandemic. If one is interested
in COVID-19 associated deaths an alternative might be to focus on the
period since Mar 2020, but then one would ignore the low influenza
season in the beginning of the year, which is IMO relevant for all-cause
mortality excess analysis. For comparison, excess mortality computations
for influenza are in the northern hemisphere often done not by calendar
year but by season, i.e. for the period from July in Year &lt;span
class=&quot;math inline&quot;&gt;\(X\)&lt;/span&gt; to June in Year &lt;span
class=&quot;math inline&quot;&gt;\(X+1\)&lt;/span&gt; &lt;span class=&quot;citation&quot;
data-cites=&quot;nielsen_etal2011&quot;&gt;(Nielsen et al. 2011)&lt;/span&gt;. In this case
one would associate the first COVID-19 peak to the analysis of the
season 2019/2020 and the ongoing 2nd wave to an analysis of the ongoing
season 2020/2021. The present analysis, however, focused on the calendar
year 2020 following the Destatis presentation of the data.&lt;/p&gt;
&lt;p&gt;When interpreting the above results it is important to realize that
the 2020 population numbers are currently projections. In a recent &lt;a
href=&quot;https://www.destatis.de/DE/Presse/Pressemitteilungen/2021/01/PD21_016_12411.html&quot;&gt;press
release&lt;/a&gt; Destatis announced that the population in 2020 might not
have increases as projected, because of a smaller migration surplus,
higher mortality and lower birth numbers. As a consequence, Destatis now
estimates that the 2020 population consisted of 83.20 mio (no population
increase compared to 2019) individuals whereas in the G2-L2-W2
projection variant the projection was 83.38 mio (population increase by
0.3% compared to 2019). Final figures, including more detailed
age-stratified data, will be available mid 2021 and it will be
interesting to see how these impact the excess mortality
calculations.&lt;/p&gt;
&lt;p&gt;Furthermore, it is important to realize that the current observed
2020 mortality numbers contain the consequences of all type of effects
from the pandemic management, which includes changes in the population
behavior due to interventions. Disentangling the complex effects of
all-cause mortality and the COVID-19 pandemic is a delicate matter,
which takes experts in several disciplines (demographers, statisticians,
epidemiologists) to solve. However, should you based on the above
numbers happen to think that COVID-19 is not a serious problem, it is
insightful to think about the &lt;a
href=&quot;https://en.wikipedia.org/wiki/Prevention_paradox&quot;&gt;prevention
paradox&lt;/a&gt; and take a look at the &lt;a
href=&quot;https://www.ft.com/content/a2901ce8-5eb7-4633-b89c-cbdf5b386938&quot;&gt;all-cause
mortality statistics&lt;/a&gt; from other countries and consider a more
regional analysis as done in the next section.&lt;/p&gt;
&lt;h3 id=&quot;analysis-for-the-16-federal-states&quot;&gt;Analysis for the 16 Federal
States&lt;/h3&gt;
&lt;p&gt;The preliminary all-cause mortality data are also available for each
of the 16 federal states, however, with a coarser age discretization. We
show for each of the two age-groups the weekly population adjusted
mortality relative to the same week in 2016-2019. Note that since the
age-groups are also coarser, i.e. the data contains only the two groups
[00,65) and [65,Inf), the effect of the changing populations on the
estimates is less pronounced.&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/blog/figure/source/2021-03-01-mortadj/MORTBLREL-1.png&quot; style=&quot;display: block; margin: auto;&quot; /&gt;&lt;/p&gt;
The plot can also be compared to the recently introduced &lt;a
href=&quot;https://service.destatis.de/DE/bevoelkerung/sterbefallzahlen_bundeslaender.html&quot;&gt;Destatis
visualization of absolute case numbers on state level&lt;/a&gt;. We note the
strong regional differences in the plot. As an example, the highest
mortality in the 65+ age-group occurs in 2020-W52 in the federal state
of Sachsen, where the poulation adjusted mortality is 122% above the
mean of 2016-2019. Note that for Sachsen, even the &amp;lt;65 age-group has
a visible excess. The 3 federal states with the highest excess mortality
week in the 65+ age-group are:
&lt;table class=&quot; lightable-classic&quot; style=&quot;font-family: &amp;quot;Arial Narrow&amp;quot;, &amp;quot;Source Sans Pro&amp;quot;, sans-serif; margin-left: auto; margin-right: auto;&quot;&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th style=&quot;text-align:left;&quot;&gt;
Federal state
&lt;/th&gt;
&lt;th style=&quot;text-align:left;&quot;&gt;
Week
&lt;/th&gt;
&lt;th style=&quot;text-align:right;&quot;&gt;
Excess mortality
&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:left;&quot;&gt;
Sachsen
&lt;/td&gt;
&lt;td style=&quot;text-align:left;&quot;&gt;
2020-W52
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
122%
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:left;&quot;&gt;
Brandenburg
&lt;/td&gt;
&lt;td style=&quot;text-align:left;&quot;&gt;
2020-W53
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
72%
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:left;&quot;&gt;
Thüringen
&lt;/td&gt;
&lt;td style=&quot;text-align:left;&quot;&gt;
2020-W52
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
68%
&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;!-- Furthermore, for the [00,65) series for Berlin it looks like not all all cases up to week W53 are available. This underlines the preliminary character of the Destatis data. --&gt;
&lt;h3 id=&quot;all-cause-mortality-and-covid-19-associated-deaths&quot;&gt;All-Cause
Mortality and COVID-19 Associated Deaths&lt;/h3&gt;
&lt;p&gt;To see, how much of the all-cause mortality is directly contributed
by deaths in association with COVID-19, we match the age-stratified
all-cause mortality data with the age-stratified COVID-19 deaths
reported by the RKI. As of 2020-01-14 the RKI provides &lt;a
href=&quot;https://www.rki.de/DE/Content/InfAZ/N/Neuartiges_Coronavirus/Projekte_RKI/COVID-19_Todesfaelle.html&quot;&gt;weekly
time series of date of death in age groups of 10 years&lt;/a&gt;. Hence, the
previous rough extrapolation from day of report used in the original
blog post is not needed anymore.&lt;/p&gt;
&lt;p&gt;We note that a large part of the increase in mortality can be
explained by COVID-19, i.e. after subtracting the COVID-19 associated
deaths the remainder of the mortality seems comparable with previous
years. This is good news, because deviations would be early signs of
possible secondary adverse health effects due to the COVID-19 pandemic,
i.e. patients trying to avoid the hospital, or care for emergencies
which cannot be given due to lack of ressources.&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/blog/figure/source/2021-03-01-mortadj/AGEMORTWCOVID-1.png&quot; style=&quot;display: block; margin: auto;&quot; /&gt;&lt;/p&gt;
&lt;p&gt;We note that the COVID-19 associated deaths in the most recent weeks
in the [80,90) age groups make up approximately &lt;a
href=&quot;deaths_covid19_proportion.png&quot;&gt;25% of all deaths reported in the
week&lt;/a&gt;.&lt;/p&gt;
&lt;h2 id=&quot;discussion&quot;&gt;Discussion&lt;/h2&gt;
&lt;p&gt;Considering all-cause mortality and COVID-19 associated mortality as
a measure for the impact of an pandemic is a rather simplistic view of
the pandemic. COVID-19 infections can be very mild, but complicated
progressions can occur without leading to death (see, e.g., &lt;a
href=&quot;https://en.wikipedia.org/wiki/Long_COVID&quot;&gt;long COVID&lt;/a&gt;). Looking
at mortality also ignores the complex interplay between age-groups,
where it can be beneficial to reduce infections in a
not-so-affected-by-the-disease age-group in order to protect the
higher-risk groups. The motivation of this post was primarily to put
COVID-19 associated mortality in relation to all-cause mortality in
order to get a better understanding of the daily number of COVID-19
deaths. An age-stratified view is necessary for this. Furthermore, as
pointed out by &lt;span class=&quot;citation&quot; data-cites=&quot;ragnitz2021&quot;&gt;Ragnitz
(2021)&lt;/span&gt;, excess mortality calculations should take the changing
population structure into account.&lt;/p&gt;
&lt;p&gt;For a more modelling based analysis of the German COVID-19 associated
mortality data based on reported infections see also the work by &lt;span
class=&quot;citation&quot; data-cites=&quot;linden_etal2020&quot;&gt;Linden et al.
(2020)&lt;/span&gt; (&lt;a
href=&quot;https://twitter.com/matthiaslinden/status/1344088091020165125?s=20&quot;&gt;updated
analysis&lt;/a&gt;). More information on real-time mortality monitoring can be
obtained from the &lt;a
href=&quot;https://www.euromomo.eu/how-it-works/methods/&quot;&gt;EuroMoMo
methodology&lt;/a&gt; page or &lt;span class=&quot;citation&quot;
data-cites=&quot;hoehle_mazick2010&quot;&gt;Höhle and Mazick (2010)&lt;/span&gt;. Comments
and feedback to the analysis in this blog post are much appretiated.&lt;/p&gt;
&lt;h2 class=&quot;unnumbered&quot; id=&quot;literature&quot;&gt;Literature&lt;/h2&gt;
&lt;div id=&quot;refs&quot; class=&quot;references csl-bib-body hanging-indent&quot;
data-entry-spacing=&quot;0&quot; role=&quot;list&quot;&gt;
&lt;div id=&quot;ref-aburto_etal2021&quot; class=&quot;csl-entry&quot; role=&quot;listitem&quot;&gt;
Aburto, José Manuel, Jonas Schöley, Luyin Zhang, Ilya Kashnitsky,
Charles Rahal, Trifon I. Missov, Melinda C. Mills, Jennifer B. Dowd, and
Ridhi Kashyap. 2021. &lt;span&gt;“Recent Gains in Life Expectancy Reversed by
the COVID-19 Pandemic.”&lt;/span&gt; &lt;em&gt;medRxiv&lt;/em&gt;. &lt;a
href=&quot;https://doi.org/10.1101/2021.03.02.21252772&quot;&gt;https://doi.org/10.1101/2021.03.02.21252772&lt;/a&gt;.
&lt;/div&gt;
&lt;div id=&quot;ref-hoehle_mazick2010&quot; class=&quot;csl-entry&quot; role=&quot;listitem&quot;&gt;
Höhle, M., and A. Mazick. 2010. &lt;span&gt;“Aberration Detection in
&lt;span&gt;R&lt;/span&gt; Illustrated by &lt;span&gt;D&lt;/span&gt;anish Mortality
Monitoring.”&lt;/span&gt; In &lt;em&gt;Biosurveillance: A Health Protection
Priority&lt;/em&gt;, edited by T. Kass-Hout and X. Zhang, 215–38. CRC Press.
&lt;a
href=&quot;https://staff.math.su.se/hoehle/pubs/hoehle_mazick2009-preprint.pdf&quot;&gt;https://staff.math.su.se/hoehle/pubs/hoehle_mazick2009-preprint.pdf&lt;/a&gt;.
&lt;/div&gt;
&lt;div id=&quot;ref-kauermann_etal2021&quot; class=&quot;csl-entry&quot; role=&quot;listitem&quot;&gt;
Kauermann, G., M. Schneble, G. De Nicola, and U. Berger. 2021.
&lt;span&gt;“Übersterblichkeit in Deutschland - Große Unterschiede Zwischen
Den Bundesländern- in Sachsen Sehr Starke Übersterblichkeit Mit Und Ohne
Corona-Todesfälle.”&lt;/span&gt; Department of Statistics, University of
Munich. &lt;a
href=&quot;https://www.covid19.statistik.uni-muenchen.de/pdfs/codag_bericht_6.pdf&quot;&gt;https://www.covid19.statistik.uni-muenchen.de/pdfs/codag_bericht_6.pdf&lt;/a&gt;.
&lt;/div&gt;
&lt;div id=&quot;ref-keiding_clayton2014&quot; class=&quot;csl-entry&quot; role=&quot;listitem&quot;&gt;
Keiding, N., and D. Clayton. 2014. &lt;span&gt;“Standardization and Control
for Confounding in Observational Studies: A Historical
Perspective.”&lt;/span&gt; &lt;em&gt;Statistical Science&lt;/em&gt; 29 (4): 529–58. &lt;a
href=&quot;http://www.jstor.org/stable/43288498&quot;&gt;http://www.jstor.org/stable/43288498&lt;/a&gt;.
&lt;/div&gt;
&lt;div id=&quot;ref-linden_etal2020&quot; class=&quot;csl-entry&quot; role=&quot;listitem&quot;&gt;
Linden, M., J Dehning, SB Mohr, J Mohring, M Meyer-Hermann, I Pigeot, A
Schöbel, and V Priesemann. 2020. &lt;span&gt;“Case Numbers Beyond Contact
Tracing Capacity Are Endangering the Containment of COVID-19.”&lt;/span&gt;
&lt;em&gt;Dtsch Arztebl Int&lt;/em&gt; 117: 790–91. &lt;a
href=&quot;https://doi.org/10.3238/arztebl.2020.0790&quot;&gt;https://doi.org/10.3238/arztebl.2020.0790&lt;/a&gt;.
&lt;/div&gt;
&lt;div id=&quot;ref-nielsen_etal2011&quot; class=&quot;csl-entry&quot; role=&quot;listitem&quot;&gt;
Nielsen, J., A. Mazick, S. Glismann, and K. Mølbak. 2011. &lt;span&gt;“Excess
Mortality Related to Seasonal Influenza and Extreme Temperatures in
Denmark, 1994-2010.”&lt;/span&gt; &lt;em&gt;BMC Infectious Diseases&lt;/em&gt; 11 (1):
350.
&lt;/div&gt;
&lt;div id=&quot;ref-ragnitz2021&quot; class=&quot;csl-entry&quot; role=&quot;listitem&quot;&gt;
Ragnitz, J. 2021. &lt;span&gt;“Hat Die Corona-Pandemie Zu Einer
Übersterblichkeit in Deutschland Geführt? - Aktualisierung
15.1.2020.”&lt;/span&gt; ifo Institute. &lt;a
href=&quot;https://www.ifo.de/publikationen/2021/monographie-autorenschaft/corona-pandemie-uebersterblichkeit-aktualisierung&quot;&gt;https://www.ifo.de/publikationen/2021/monographie-autorenschaft/corona-pandemie-uebersterblichkeit-aktualisierung&lt;/a&gt;.
&lt;/div&gt;
&lt;div id=&quot;ref-zurnieden_etal2020&quot; class=&quot;csl-entry&quot; role=&quot;listitem&quot;&gt;
zur Nieden, F., B. Sommer, and S. Lüken. 2020. &lt;span&gt;“Sonderauswertung
Der Sterbefallzahlen 2020.”&lt;/span&gt; &lt;em&gt;WISTA – Wirtschaft Und Statistik
– Amtliche Statistik in Zeiten von Corona&lt;/em&gt;, no. 4 (August): 38–50.
&lt;a
href=&quot;https://www.destatis.de/DE/Methoden/WISTA-Wirtschaft-und-Statistik/2020/04/sonderauswertung-sterbefallzahlen-042020.pdf?__blob=publicationFile&quot;&gt;https://www.destatis.de/DE/Methoden/WISTA-Wirtschaft-und-Statistik/2020/04/sonderauswertung-sterbefallzahlen-042020.pdf?__blob=publicationFile&lt;/a&gt;.
&lt;/div&gt;
&lt;/div&gt;
</description>
        <pubDate>Mon, 01 Mar 2021 00:00:00 +0100</pubDate>
        <link>https://mhoehle.github.io/blog/2021/03/01/mortadj.html</link>
        <guid isPermaLink="true">https://mhoehle.github.io/blog/2021/03/01/mortadj.html</guid>
        
        <category>rstats</category>
        
        <category>dataviz</category>
        
        <category>R</category>
        
        <category>COVID-19</category>
        
        <category>SARS-CoV-2</category>
        
        <category>demography</category>
        
        
      </item>
    
      <item>
        <title>Age Stratified All-Cause and COVID-19 Associated Mortality</title>
        <description>&lt;h2 id=&quot;abstract&quot;&gt;Abstract:&lt;/h2&gt;
&lt;p&gt;We consider the age stratified all-cause and COVID-19 associated
mortality in Germany during 2020 based on numbers provided by the
Federal Statistical Office and the Robert Koch Institute.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Update 2021-03-01&lt;/strong&gt;: An up-to-date and methodologocial
improved version of the post, including population adjusted excess
mortality calculations for 2020 based on the most recent Destatis and
RKI data is available &lt;a
href=&quot;https://staff.math.su.se/hoehle/blog/2021/03/01/mortadj.html&quot;&gt;here&lt;/a&gt;.&lt;/p&gt;
&lt;center&gt;
&lt;img src=&quot;/blog/figure/source/2020-12-28-mort/AGEMORTWCOVID-1.png&quot; width=&quot;550&quot;&gt;
&lt;/center&gt;
&lt;p&gt;&lt;br&gt;
&lt;a rel=&quot;license&quot; href=&quot;http://creativecommons.org/licenses/by-sa/4.0/&quot;&gt;&lt;img alt=&quot;Creative Commons License&quot; style=&quot;border-width:0&quot; src=&quot;https://i.creativecommons.org/l/by-sa/4.0/88x31.png&quot;/&gt;&lt;/a&gt;
This work is licensed under a &lt;a rel=&quot;license&quot;
href=&quot;http://creativecommons.org/licenses/by-sa/4.0/&quot;&gt;Creative Commons
Attribution-ShareAlike 4.0 International License&lt;/a&gt;. The
markdown+Rknitr source code of this blog is available under a &lt;a
href=&quot;https://www.gnu.org/licenses/gpl-3.0.html&quot;&gt;GNU General Public
License (GPL v3)&lt;/a&gt; license from github.&lt;/p&gt;
&lt;h2 id=&quot;introduction&quot;&gt;Introduction&lt;/h2&gt;
&lt;p&gt;All-cause mortality is one of indicators used to measure the impact
of the COVID-19 pandemic, because this indicator is less biased by the
testing strategy needed to identify cases to have died while having a
recent COVID-19 diagnosis. Since both death and COVID-19 have a strong
age component, it appears crucial to take an age-stratified view on both
all-cause mortality as well as deaths associated with COVID-19. This
will also help to put age-related COVID-19 mortality in a bigger
picture.&lt;/p&gt;
&lt;h2 id=&quot;age-stratified-mortality&quot;&gt;Age Stratified Mortality&lt;/h2&gt;
&lt;p&gt;Real-time mortality monitoring is not common in Germany, as can be
seen from the coverage of the &lt;a
href=&quot;https://www.euromomo.eu/&quot;&gt;EuroMoMo monitoring&lt;/a&gt; for Germany,
where only the two federal states Hesse and Berlin participate. However,
as part of the COVID-19 response, the Federal Statistical Office
(Destatis) now provides weekly updated &lt;a
href=&quot;https://www.destatis.de/DE/Themen/Querschnitt/Corona/Gesellschaft/kontextinformationen-gesellschaft.html#Sterbe&quot;&gt;preliminary
mortality statistics of all-cause mortality in 2020&lt;/a&gt;. The methodology
behind the numbers as well as age-stratified additional analyses are
described in an accompanying &lt;a
href=&quot;https://www.destatis.de/DE/Methoden/WISTA-Wirtschaft-und-Statistik/2020/04/sonderauswertung-sterbefallzahlen-042020.pdf?__blob=publicationFile&quot;&gt;publication&lt;/a&gt;
&lt;span class=&quot;citation&quot; data-cites=&quot;zurnieden_etal2020&quot;&gt;(zur Nieden,
Sommer, and Lüken 2020)&lt;/span&gt;. The age-stratified analyses are
unfortunately not continuously updated, however, up-to-date data are
made publicly &lt;a
href=&quot;https://www.destatis.de/DE/Themen/Gesellschaft-Umwelt/Bevoelkerung/Sterbefaelle-Lebenserwartung/Tabellen/sonderauswertung-sterbefaelle.html?nn=209016&quot;&gt;available&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;
&lt;center&gt;
&lt;img src=&quot;/blog/figure/source/2020-12-28-mort/destatis.png&quot; width=&quot;550&quot;&gt;
&lt;/center&gt;
&lt;p&gt;The reported COVID-19 associated deaths (by week of death) are
obtained from an &lt;a
href=&quot;https://www.rki.de/DE/Content/InfAZ/N/Neuartiges_Coronavirus/Projekte_RKI/COVID-19_Todesfaelle.html&quot;&gt;export
of the RKI&lt;/a&gt;. However, the COVID-19 deaths are not available in
age-stratified form. Furthermore, in order to compensate for reporting
delays of deaths, the Destatis analysis only goes until 4 weeks before
the time point of analysis, i.e. the 2020-12-18 version shown in the
above image only reaches ISO week 47 (spanning the time period
2020-11-16 - 2020-11-22).&lt;/p&gt;
&lt;p&gt;The aim of the present blog post is to provide an &lt;strong&gt;up-to-date
age-stratified view including COVID-19 associated deaths&lt;/strong&gt;. As
additional data source we use the age-stratified cumulative number of
deaths reported every Tuesday in the RKI &lt;a
href=&quot;https://www.rki.de/DE/Content/InfAZ/N/Neuartiges_Coronavirus/Situationsberichte/Dez_2020/2020-12-22-en.pdf?__blob=publicationFile&quot;&gt;situational
report&lt;/a&gt; (p.7).&lt;/p&gt;
&lt;h2 id=&quot;data-io&quot;&gt;Data I/O&lt;/h2&gt;
&lt;p&gt;This section consists of data wrangling the above mentioned data
sources. One challenge is for example to align the age classes used in
the different sources. See the R code on &lt;a
href=&quot;https://raw.githubusercontent.com/hoehleatsu/hoehleatsu.github.io/master/_source/2020-12-28-mort.Rmd&quot;&gt;GitHub&lt;/a&gt;
for the gory details.&lt;/p&gt;
&lt;h2 id=&quot;up-to-date-age-stratified-all-cause-mortality&quot;&gt;Up-to-date
age-stratified all-cause mortality&lt;/h2&gt;
&lt;p&gt;Available all-cause deaths (by week of death) are available until
2020-W47. Note that Destatis stresses the &lt;a
href=&quot;https://twitter.com/FlorianBurg2/status/1343903541849681922?s=20&quot;&gt;preliminary
character of the data&lt;/a&gt; - the numbers might change as further deaths
arrive. Stratified by age the times series for 2020 compared to the
years 2016-2019 looks as follows - please beware of the different y-axes
for the age-groups in the plot:&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/blog/figure/source/2020-12-28-mort/AGEMORT-1.png&quot; style=&quot;display: block; margin: auto;&quot; /&gt;&lt;/p&gt;
&lt;p&gt;Since the age-groups also contain different population sizes, a
better comparison between age-groups instead of absolute numbers is by
&lt;a
href=&quot;/blog/figure/source/2020-12-28-mort/sterbefaelle_incidence.png&quot;&gt;incidence
rate&lt;/a&gt; (i.e. deaths per 100,000 population in the age group). To
underline the age-gradient of mortality: 56% of the deaths 2016-2019
occured in the age group of 80+ years (90% in the age group of 60+). It
becomes clear that 2020 mortality in the 80+ age groups was rather low
during the first 10-12 weeks and then had a spike in connection with the
first COVID-19 wave (March-April). Subsequently, a summer peak (possibly
associated with heat) is followed by an increasing and ongoing upward
trend. One challenge for a statistical analysis of these numbers is to
figure out how much of the upwards trend is “catch-up mortality” due to
the lower mortality in the beginning of the year and how much is excess
related to COVID-19.&lt;/p&gt;
&lt;p&gt;An initial analysis of this question consists of summing the
all-cause mortalities from W1 until W47 for 2020 (observed) and compare
this to the summation of the weekly mean of 2016-2019 for the
corresponding time period (expected)&lt;a href=&quot;#fn1&quot; class=&quot;footnote-ref&quot;
id=&quot;fnref1&quot; role=&quot;doc-noteref&quot;&gt;&lt;sup&gt;1&lt;/sup&gt;&lt;/a&gt;. When we do this by
age-group we obtain:&lt;/p&gt;
&lt;table class=&quot; lightable-classic&quot; style=&quot;font-family: &amp;quot;Arial Narrow&amp;quot;, &amp;quot;Source Sans Pro&amp;quot;, sans-serif; margin-left: auto; margin-right: auto;border-bottom: 0;&quot;&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th style=&quot;text-align:left;&quot;&gt;
Age group
&lt;/th&gt;
&lt;th style=&quot;text-align:right;&quot;&gt;
observed
&lt;/th&gt;
&lt;th style=&quot;text-align:right;&quot;&gt;
expected_20162019
&lt;/th&gt;
&lt;th style=&quot;text-align:right;&quot;&gt;
Percent change
&lt;/th&gt;
&lt;th style=&quot;text-align:right;&quot;&gt;
min_20162019
&lt;/th&gt;
&lt;th style=&quot;text-align:right;&quot;&gt;
max_20162019
&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:left;&quot;&gt;
[00,30)
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
6533
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
7057
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
-7%
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
6802
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
7346
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:left;&quot;&gt;
[30,40)
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
6053
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
5829
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
4%
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
5755
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
5869
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:left;&quot;&gt;
[40,50)
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
13976
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
15348
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
-9%
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
14093
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
16766
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:left;&quot;&gt;
[50,60)
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
51060
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
52527
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
-3%
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
51445
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
53455
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:left;&quot;&gt;
[60,70)
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
104426
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
100734
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
4%
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
96860
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
104023
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:left;&quot;&gt;
[70,80)
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
176047
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
190420
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
-8%
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
182443
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
193917
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:left;&quot;&gt;
[80,90)
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
325530
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
306112
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
6%
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
290587
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
315843
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:left;&quot;&gt;
[90,Inf)
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
171684
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
160108
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
7%
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
147177
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
167511
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr grouplength=&quot;1&quot;&gt;
&lt;td colspan=&quot;6&quot; style=&quot;border-bottom: 0;&quot;&gt;
&lt;strong&gt;Total&lt;/strong&gt;
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:left; padding-left:  2em;&quot; indentlevel=&quot;1&quot;&gt;
Total
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
855309
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
838136
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
2%
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
811365
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
860975
&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;tfoot&gt;
&lt;tr&gt;
&lt;td style=&quot;padding: 0; &quot; colspan=&quot;100%&quot;&gt;
&lt;sup&gt;a&lt;/sup&gt; Min and max for row ‘Total’ is obtained by first summing
each of the years 2016-2019 and then take the min and max.
&lt;/td&gt;
&lt;/tr&gt;
&lt;/tfoot&gt;
&lt;/table&gt;
&lt;p&gt;
&lt;p&gt;So in these numbers the mild mortality in the older age groups during
the first weeks balances some, but not all, of the excess in these
age-groups since Mar-Apr. The total proportion of 2020-W1 to 2020-W47
mortalities in the 80+ age group is currently 58%. However, it is also
important to realize that the current observed 2020 numbers contain the
consequences of all type of effects from the pandemic management, which
includes changes in the population behavior due to interventions.
Disentangling the complex effects of all-cause mortality and the
COVID-19 pandemic is a delicate matter, which takes experts in several
disciplines (demographers, statisticians, epidemiologists) to solve.
However, should you based on the above numbers happen to think that
COVID-19 is not a serious problem, it is insightful to think about the
&lt;a href=&quot;https://en.wikipedia.org/wiki/Prevention_paradox&quot;&gt;prevention
paradox&lt;/a&gt; and take a look at the &lt;a
href=&quot;https://www.ft.com/content/a2901ce8-5eb7-4633-b89c-cbdf5b386938&quot;&gt;all-cause
mortality statistics&lt;/a&gt; from other countries.&lt;/p&gt;
&lt;h3 id=&quot;all-cause-mortality-and-covid-19-associated-deaths&quot;&gt;All-Cause
Mortality and COVID-19 Associated Deaths&lt;/h3&gt;
&lt;p&gt;To see, how much of the all-cause mortality is directly contributed
by deaths in association with COVID-19, we match the age-stratified
all-cause mortality data with the age-stratified COVID-19 deaths
reported by the RKI since Sep 2020 (2020-W35). One complication of this
matching is that the RKI deaths are reported by the week that the
information about the death reached the RKI and not the week of death.
In order to match it with the Destatis all-cause mortality time series,
we extrapolate week of death from the week of report by the simple
assumption that the death occurred 2 weeks before the report&lt;a
href=&quot;#fn2&quot; class=&quot;footnote-ref&quot; id=&quot;fnref2&quot;
role=&quot;doc-noteref&quot;&gt;&lt;sup&gt;2&lt;/sup&gt;&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Furthermore, to avoid a downward bias in the observed numbers by
observed-but-not-yet-reported deaths, the previously shown Destatis
analyses of all-cause mortality does not include the most recent weeks,
where COVID-19 associated mortality increased substantially in Germany:
the analysis is only done until 2020-W47, even though the date of
analysis was 2020-12-18. At this time the RKI in their situational
report of 2020-12-22 already reported a total of 26964 COVID-19
associated deaths - only 15686 have their time of death up to 2020-W47.
We thus expect the reported excess mortality to increase within the
coming weeks. As a simple extrapolation, we assume that all COVID-19
associated mortality in the subsequent weeks above the level in
2020-W47, is directly summable to the 2020 all-cause mortality&lt;a
href=&quot;#fn3&quot; class=&quot;footnote-ref&quot; id=&quot;fnref3&quot;
role=&quot;doc-noteref&quot;&gt;&lt;sup&gt;3&lt;/sup&gt;&lt;/a&gt;. With this simple extrapolation, the
excess mortality computations can be extended until 2020-W50 and leads
to the following predictions:&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/blog/figure/source/2020-12-28-mort/AGEMORTWCOVID-1.png&quot; style=&quot;display: block; margin: auto;&quot; /&gt;&lt;/p&gt;
&lt;p&gt;We note that the COVID-19 associated deaths in the most recent weeks
in the 80+ age groups make up more than &lt;a
href=&quot;/blog/figure/source/2020-12-28-mort/deaths_covid19_proportion.png&quot;&gt;30%
of all deaths reported on average over the years 2016-2019&lt;/a&gt;. This
would mean an excess of mortality for the period of 2020-W01 to 2020-W50
of 5%, which is likely to increase even further as the remaining weeks
of 2020 are added&lt;a href=&quot;#fn4&quot; class=&quot;footnote-ref&quot; id=&quot;fnref4&quot;
role=&quot;doc-noteref&quot;&gt;&lt;sup&gt;4&lt;/sup&gt;&lt;/a&gt;.&lt;/p&gt;
&lt;h2 id=&quot;discussion&quot;&gt;Discussion&lt;/h2&gt;
&lt;p&gt;Considering all-cause mortality and COVID-19 associated mortality as
a measure for the impact of an pandemic is a rather simplistic view of
the pandemic. COVID-19 infections can be very mild, but complicated
progressions can occur without leading to death (see, e.g., &lt;a
href=&quot;https://en.wikipedia.org/wiki/Long_COVID&quot;&gt;long COVID&lt;/a&gt;). Looking
at mortality also ignores the complex interplay between age-groups,
where it can be beneficial to reduce infections in a
not-so-affected-by-the-disease age-group in order to protect the
higher-risk groups. The motivation of this post was primarily to put
COVID-19 associated mortality in relation to all-cause mortality in
order to get a better understanding of the daily number of COVID-19
deaths. An age-stratified view is necessary for this.&lt;/p&gt;
&lt;p&gt;We showed that the Destatis reported excess-mortality are expected to
increase in the coming weeks. The extrapolations used in the present
analysis are simplistic and could be improved by a &lt;a
href=&quot;https://staff.math.su.se/hoehle/blog/2016/07/19/nowCast.html&quot;&gt;nowcasting
approach&lt;/a&gt;, which extrapolates not-yet-reported deaths from knowledge
about the reporting delay &lt;span class=&quot;citation&quot;
data-cites=&quot;schneble_etal2020&quot;&gt;(Schneble et al. 2020)&lt;/span&gt;. For a more
modelling based analysis of the German COVID-19 associated mortality
data see also the work by &lt;span class=&quot;citation&quot;
data-cites=&quot;linden_etal2020&quot;&gt;Linden et al. (2020)&lt;/span&gt; (&lt;a
href=&quot;https://twitter.com/matthiaslinden/status/1338984728209338369?s=20&quot;&gt;updated
analysis&lt;/a&gt;). More information on real-time mortality monitoring can be
obtained from the &lt;a
href=&quot;https://www.euromomo.eu/how-it-works/methods/&quot;&gt;EuroMoMo
methodology&lt;/a&gt; page or &lt;span class=&quot;citation&quot;
data-cites=&quot;hoehle_mazick2010&quot;&gt;Höhle and Mazick (2010)&lt;/span&gt;. Comments
and feedback to the analysis in this blog post are much appretiated.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Update 2020-03-01&lt;/strong&gt;: An up-to-date version of this
post, including an analysis of the most recent Destatis and RKI data is
available &lt;a
href=&quot;https://staff.math.su.se/hoehle/blog/2021/03/01/mortadj.html&quot;&gt;here&lt;/a&gt;.&lt;/p&gt;
&lt;h2 class=&quot;unnumbered&quot; id=&quot;literature&quot;&gt;Literature&lt;/h2&gt;
&lt;div id=&quot;refs&quot; class=&quot;references csl-bib-body hanging-indent&quot;
data-entry-spacing=&quot;0&quot; role=&quot;list&quot;&gt;
&lt;div id=&quot;ref-hoehle_mazick2010&quot; class=&quot;csl-entry&quot; role=&quot;listitem&quot;&gt;
Höhle, M., and A. Mazick. 2010. &lt;span&gt;“Aberration Detection in
&lt;span&gt;R&lt;/span&gt; Illustrated by &lt;span&gt;D&lt;/span&gt;anish Mortality
Monitoring.”&lt;/span&gt; In &lt;em&gt;Biosurveillance: A Health Protection
Priority&lt;/em&gt;, edited by T. Kass-Hout and X. Zhang, 215–38. CRC Press.
&lt;a
href=&quot;https://staff.math.su.se/hoehle/pubs/hoehle_mazick2009-preprint.pdf&quot;&gt;https://staff.math.su.se/hoehle/pubs/hoehle_mazick2009-preprint.pdf&lt;/a&gt;.
&lt;/div&gt;
&lt;div id=&quot;ref-linden_etal2020&quot; class=&quot;csl-entry&quot; role=&quot;listitem&quot;&gt;
Linden, M., J Dehning, SB Mohr, J Mohring, M Meyer-Hermann, I Pigeot, A
Schöbel, and V Priesemann. 2020. &lt;span&gt;“Case Numbers Beyond Contact
Tracing Capacity Are Endangering the Containment of COVID-19.”&lt;/span&gt;
&lt;em&gt;Dtsch Arztebl Int&lt;/em&gt; 117: 790–91. &lt;a
href=&quot;https://doi.org/10.3238/arztebl.2020.0790&quot;&gt;https://doi.org/10.3238/arztebl.2020.0790&lt;/a&gt;.
&lt;/div&gt;
&lt;div id=&quot;ref-schneble_etal2020&quot; class=&quot;csl-entry&quot; role=&quot;listitem&quot;&gt;
Schneble, M., G. De Nicola G, G. Kauermann, and U. Berger. 2020.
&lt;span&gt;“Nowcasting Fatal COVID-19 Infections on a Regional Level in
Germany.”&lt;/span&gt; &lt;em&gt;Biometrical Journal&lt;/em&gt;. &lt;a
href=&quot;https://doi.org/10.1002/bimj.202000143&quot;&gt;https://doi.org/10.1002/bimj.202000143&lt;/a&gt;.
&lt;/div&gt;
&lt;div id=&quot;ref-zurnieden_etal2020&quot; class=&quot;csl-entry&quot; role=&quot;listitem&quot;&gt;
zur Nieden, F., B. Sommer, and S. Lüken. 2020. &lt;span&gt;“Sonderauswertung
Der Sterbefallzahlen 2020.”&lt;/span&gt; &lt;em&gt;WISTA – Wirtschaft Und Statistik
– Amtliche Statistik in Zeiten von Corona&lt;/em&gt;, no. 4 (August): 38–50.
&lt;a
href=&quot;https://www.destatis.de/DE/Methoden/WISTA-Wirtschaft-und-Statistik/2020/04/sonderauswertung-sterbefallzahlen-042020.pdf?__blob=publicationFile&quot;&gt;https://www.destatis.de/DE/Methoden/WISTA-Wirtschaft-und-Statistik/2020/04/sonderauswertung-sterbefallzahlen-042020.pdf?__blob=publicationFile&lt;/a&gt;.
&lt;/div&gt;
&lt;/div&gt;
&lt;section id=&quot;footnotes&quot; class=&quot;footnotes footnotes-end-of-document&quot;
role=&quot;doc-endnotes&quot;&gt;
&lt;hr /&gt;
&lt;ol&gt;
&lt;li id=&quot;fn1&quot;&gt;&lt;p&gt;More involved ways to compute excess-mortality are
imaginable.&lt;a href=&quot;#fnref1&quot; class=&quot;footnote-back&quot;
role=&quot;doc-backlink&quot;&gt;↩︎&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;
&lt;li id=&quot;fn2&quot;&gt;&lt;p&gt;Using two weeks provided the best fit to the
unstratified number of observed cases by week of death. More advanced
transformation schemes than simply subtracting two week are
imaginable.&lt;a href=&quot;#fnref2&quot; class=&quot;footnote-back&quot;
role=&quot;doc-backlink&quot;&gt;↩︎&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;
&lt;li id=&quot;fn3&quot;&gt;&lt;p&gt;Note: This is really a guesstimate and might produce a
slight excess, because some of the individuals who would have died in
this week in a COVID-free year, by chance now happen to die this week
with COVID-19. However, part of inferential statistics is to make
predictions (which can be wrong) in timely fashion. If you want the
&lt;em&gt;true numbers&lt;/em&gt;, you will have to wait to end of Jan 2021 or even
to mid-2021 (when the official mortality statistics is released). This
is not helpful for situational awareness during a pandemic.&lt;a
href=&quot;#fnref3&quot; class=&quot;footnote-back&quot; role=&quot;doc-backlink&quot;&gt;↩︎&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;
&lt;li id=&quot;fn4&quot;&gt;&lt;p&gt;Note that 2020 has an ISO week 53 spanning 2020-12-28 to
2021-01-03, whereas none of years 2016-2019 had an ISO week 53. It will
be interesting to see how this week will be handled by Destatis for the
excess mortality calculations.&lt;a href=&quot;#fnref4&quot; class=&quot;footnote-back&quot;
role=&quot;doc-backlink&quot;&gt;↩︎&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;/section&gt;
</description>
        <pubDate>Mon, 28 Dec 2020 00:00:00 +0100</pubDate>
        <link>https://mhoehle.github.io/blog/2020/12/28/mort.html</link>
        <guid isPermaLink="true">https://mhoehle.github.io/blog/2020/12/28/mort.html</guid>
        
        <category>rstats</category>
        
        <category>dataviz</category>
        
        <category>R</category>
        
        <category>COVID-19</category>
        
        <category>SARS-CoV-2</category>
        
        <category>demography</category>
        
        
      </item>
    
      <item>
        <title>The Mathematics and Statistics of Infectious Disease Outbreaks</title>
        <description>&lt;h2 id=&quot;abstract&quot;&gt;Abstract:&lt;/h2&gt;
&lt;p&gt;Slides, R code and video lectures of our 2020 &lt;em&gt;The Mathematics and
Statistics of Infectious Disease Outbreaks&lt;/em&gt; summer course at
Stockholm University are made available to a wider audience.&lt;/p&gt;
&lt;p&gt;
&lt;center&gt;
&lt;img src=&quot;/blog/figure/source/2020-11-20-infepi/youtube.png&quot; width=&quot;550&quot;&gt;
&lt;/center&gt;
&lt;p&gt;&lt;br&gt;
&lt;a rel=&quot;license&quot; href=&quot;http://creativecommons.org/licenses/by-sa/4.0/&quot;&gt;&lt;img alt=&quot;Creative Commons License&quot; style=&quot;border-width:0&quot; src=&quot;https://i.creativecommons.org/l/by-sa/4.0/88x31.png&quot;/&gt;&lt;/a&gt;
This work is licensed under a &lt;a rel=&quot;license&quot;
href=&quot;http://creativecommons.org/licenses/by-sa/4.0/&quot;&gt;Creative Commons
Attribution-ShareAlike 4.0 International License&lt;/a&gt;. The
markdown+Rknitr source code of this blog is available under a &lt;a
href=&quot;https://www.gnu.org/licenses/gpl-3.0.html&quot;&gt;GNU General Public
License (GPL v3)&lt;/a&gt; license from github.&lt;/p&gt;
&lt;h2 id=&quot;introduction&quot;&gt;Introduction&lt;/h2&gt;
&lt;p&gt;During the 2020 summer &lt;a
href=&quot;https://staff.math.su.se/tom.britton/&quot;&gt;Tom Britton&lt;/a&gt; and I gave
a course on &lt;em&gt;The Mathematics and Statistics of Infectious Disease
Outbreaks&lt;/em&gt; at the &lt;a href=&quot;https://www.math.su.se&quot;&gt;Department of
Mathematics, Stockholm University, Sweden&lt;/a&gt;. Pre-requisites for the
course were undergraduate knowledge of mathematics (e.g. differential
equations, optimization) and statistics (e.g. random variables,
distributions, maximum likelihood inference) as well as some programming
skills in a language with a data science component (python, R, Julia,
matlab, …).&lt;/p&gt;
Now the course is done, we have decided to share all our course
material, consisting of slides, R code and video lectures. The main page
for navigating the material is on GitHub:
&lt;p&gt;
&lt;center&gt;
&lt;a
href=&quot;https://github.com/hoehleatsu/mt3002-summer2020&quot;&gt;https://github.com/hoehleatsu/mt3002-summer2020&lt;/a&gt;
&lt;/center&gt;
&lt;p&gt;
&lt;p&gt;which, e.g., links to the &lt;a
href=&quot;https://www.youtube.com/playlist?list=PLl_ncesshp_C-URStf-LwhYCbFGE70_jq&quot;&gt;Youtube
playlist&lt;/a&gt; containing the videos.&lt;/p&gt;
&lt;h2 id=&quot;course-content&quot;&gt;Course content&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;Introduction to the Course [&lt;a
href=&quot;https://video.su.se/media/Introduction+to+the+Course+%28Tom+Britton%29/0_scrd1q6o/356471&quot;&gt;Tom
Britton&lt;/a&gt; | &lt;a href=&quot;https://video.su.se/media/t/0_rqwxd9zg&quot;&gt;Michael
Höhle&lt;/a&gt;]&lt;/li&gt;
&lt;li&gt;L01: Mathematical Modelling [&lt;a
href=&quot;https://video.su.se/media/L01+-+Mathematical+Modelling+%281+2%29/0_g9pf4rnh/356471&quot;&gt;Part
1&lt;/a&gt; | &lt;a
href=&quot;https://video.su.se/media/L01+-+Mathematical+Modelling+%282+2%29/0_qdurs7hj&quot;&gt;Part
2&lt;/a&gt;]&lt;/li&gt;
&lt;li&gt;L02: Simulation and Fitting of Epidemic Models [&lt;a
href=&quot;https://video.su.se/media/L02+-+Simulation+and+Fitting+of+Epidemic+Models+%281+3%29/0_j0v2lslj&quot;&gt;Part
1&lt;/a&gt; | &lt;a
href=&quot;https://video.su.se/media/L02+-+Simulation+and+Fitting+of+Epidemic+Models+%282+3%29/0_p4629rt7&quot;&gt;Part
2&lt;/a&gt; | &lt;a
href=&quot;https://video.su.se/media/L02+-+Simulation+and+Fitting+of+Epidemic+Models+%283+3%29/0_3yjyzq0q&quot;&gt;Part
3&lt;/a&gt;]&lt;/li&gt;
&lt;li&gt;L03: Timing and observations + Endemic models [&lt;a
href=&quot;https://video.su.se/media/L03+-+Timing+and+observations+%2B+Endemic+models+%281+2%29/0_10homfzz&quot;&gt;Part
1&lt;/a&gt; | &lt;a
href=&quot;https://video.su.se/media/L03+-+Timing+and+observations+%2B+Endemic+models+%282+2%29/0_1p5i3vsj/356471&quot;&gt;Part
2&lt;/a&gt;]&lt;/li&gt;
&lt;li&gt;L04: Estimating Reproduction Numbers [&lt;a
href=&quot;https://video.su.se/media/L04+-+Estimation+reproduction+numbers+%281+2%29/0_w12jeszk&quot;&gt;Part
1&lt;/a&gt; | &lt;a
href=&quot;https://video.su.se/media/L04+-+Estimating+Reproduction+Numbers+%282+2%29/0_bopogny5&quot;&gt;Part
2&lt;/a&gt;]&lt;/li&gt;
&lt;li&gt;L05: Effective Reproduction Number [&lt;a
href=&quot;https://video.su.se/media/L05+-+Effective+Reproduction+Number+%281+2%29/0_u3b1j7rk&quot;&gt;Part
1&lt;/a&gt; | &lt;a
href=&quot;https://video.su.se/media/L05+-+Effective+Reproduction+Number+%282+2%29/0_38cwcho8&quot;&gt;Part
2&lt;/a&gt;]&lt;/li&gt;
&lt;li&gt;L06: Latencies and Delays [&lt;a
href=&quot;https://video.su.se/media/+L06+-+Latencies+and+Delays+%281+2%29/0_vrzkcn4s&quot;&gt;Part
1&lt;/a&gt; | &lt;a
href=&quot;https://video.su.se/media/L06+-+Latencies+and+Delays+%282+2%29/0_0xu0jgzy&quot;&gt;Part
2&lt;/a&gt;]&lt;/li&gt;
&lt;li&gt;L07: Vaccination, other Preventive Measures and Uncertainties [&lt;a
href=&quot;https://video.su.se/media/L07+-+Vaccination%2C+other+preventive+measures+and+uncertainties+%281+2%29/0_9oson513/356471&quot;&gt;Part
1&lt;/a&gt; | &lt;a
href=&quot;https://video.su.se/media/L07+-+Vaccination%2C+other+preventive+measures+and+uncertainties+%282+2%29/0_7rrq3ug7/356471&quot;&gt;Part
2&lt;/a&gt;]&lt;/li&gt;
&lt;li&gt;L08: Modeling using Networks and other Heterogeneities [&lt;a
href=&quot;https://video.su.se/media/L08+-+Modeling+using+networks+and+other+heterogeneities+%281+2%29/0_y4jqv270/356471&quot;&gt;Part
1&lt;/a&gt; | &lt;a
href=&quot;https://video.su.se/media/L08+-+Modeling+using+networks+and+other+heterogeneities+%282+2%29/0_0mweom9s/356471&quot;&gt;Part
2&lt;/a&gt;]&lt;/li&gt;
&lt;li&gt;L09: Univariate Outbreak Detection [&lt;a
href=&quot;https://video.su.se/media/L09+-+Univariate+outbreak+detection+%281+2%29/0_imgomlwy/356471&quot;&gt;Part
1&lt;/a&gt; | &lt;a
href=&quot;https://video.su.se/media/L09+-+Univariate+outbreak+detection+%282+2%29/0_ifu44eas/356471&quot;&gt;Part
2&lt;/a&gt;]&lt;/li&gt;
&lt;li&gt;L10: Multivariate Outbreak Detection [&lt;a
href=&quot;https://video.su.se/media/L10+-+Multivariate+outbreak+detection+%281+2%29/0_uithqyum&quot;&gt;Part
1&lt;/a&gt; | &lt;a
href=&quot;https://video.su.se/media/L10+-+Multivariate+outbreak+detection+%282+2%29/0_mmol88iy&quot;&gt;Part
2&lt;/a&gt;]&lt;/li&gt;
&lt;li&gt;L11: COVID-19 (I): Reproduction Number and Herd Immunity [&lt;a
href=&quot;https://video.su.se/media/L11+-+COVID-19+%281+2%29/0_dk0ztmz6/356471&quot;&gt;Part
1&lt;/a&gt; | &lt;a
href=&quot;https://video.su.se/media/L11+-+COVID-19+%282+2%29/0_j1xks7xm&quot;&gt;Part
2&lt;/a&gt;]&lt;/li&gt;
&lt;li&gt;L12: COVID-19 (II): Digital Contact Tracing [&lt;a
href=&quot;https://video.su.se/media/L12+-+Digital+Contact+Tracing+%281+2%29/0_9chh75x5&quot;&gt;Part
1&lt;/a&gt; | &lt;a
href=&quot;https://video.su.se/media/L12+-+Digital+Contact+Tracing+%282+2%29/0_pbdfeaov&quot;&gt;Part
2&lt;/a&gt;]&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;discussion&quot;&gt;Discussion&lt;/h2&gt;
&lt;p&gt;We hope the material can be of value for those interested in the
field, e.g., new Ph.D. students in epidemic modelling, infectious
disease epidemiologists with a like for the quantitative side of
matters, and for those who just want to improve their armchair
epidemiology skills.&lt;/p&gt;
</description>
        <pubDate>Fri, 20 Nov 2020 00:00:00 +0100</pubDate>
        <link>https://mhoehle.github.io/blog/2020/11/20/infepi.html</link>
        <guid isPermaLink="true">https://mhoehle.github.io/blog/2020/11/20/infepi.html</guid>
        
        <category>rstats</category>
        
        <category>COVID-19</category>
        
        <category>SARS-CoV-2</category>
        
        <category>mathematical modelling</category>
        
        
      </item>
    
      <item>
        <title>Risk Scoring in Digital Contact Tracing Apps</title>
        <description>&lt;h2 id=&quot;abstract&quot;&gt;Abstract:&lt;/h2&gt;
We attempt a mathematical description of the risk scoring algorithm used
in the Google and Apple exposure notification framework (v1). This
algorithm is used in many digital contact tracing apps for COVID-19,
e.g., in Germany or Switzerland.
&lt;p&gt;
&lt;center&gt;
&lt;img src=&quot;/blog/figure/source/2020-09-17-gaen_riskscoring/classifier3.png&quot; width=&quot;550&quot;&gt;
&lt;/center&gt;
&lt;p&gt;&lt;br&gt;
&lt;a rel=&quot;license&quot; href=&quot;http://creativecommons.org/licenses/by-sa/4.0/&quot;&gt;&lt;img alt=&quot;Creative Commons License&quot; style=&quot;border-width:0&quot; src=&quot;https://i.creativecommons.org/l/by-sa/4.0/88x31.png&quot;/&gt;&lt;/a&gt;
This work is licensed under a &lt;a rel=&quot;license&quot;
href=&quot;http://creativecommons.org/licenses/by-sa/4.0/&quot;&gt;Creative Commons
Attribution-ShareAlike 4.0 International License&lt;/a&gt;. The
markdown+Rknitr source code of this blog is available under a &lt;a
href=&quot;https://www.gnu.org/licenses/gpl-3.0.html&quot;&gt;GNU General Public
License (GPL v3)&lt;/a&gt; license from github.&lt;/p&gt;
&lt;h2 id=&quot;motivation&quot;&gt;Motivation&lt;/h2&gt;
&lt;p&gt;My phone runs a digital COVID-19 contact tracing app based on the
Apple and Google exposure notification (GAEN) framework [&lt;a
href=&quot;https://developer.apple.com/exposure-notification/&quot;&gt;Apple&lt;/a&gt;| &lt;a
href=&quot;https://www.google.com/covid19/exposurenotifications/&quot;&gt;Google&lt;/a&gt;|
&lt;a
href=&quot;https://en.wikipedia.org/wiki/Exposure_Notification&quot;&gt;Wikipedia&lt;/a&gt;].
Since my future health might depend on it, I am interested in the risk
classification algorithm of the framework: when does it warn me about a
possible exposure risk? Since algorithmic transparency is a key
component in gaining acceptance for digital contact tracing apps, this
blog post tries to give a mathematical description of the risk scoring
algorithm in the GAEN framework - as far as I have been able to
understand it. The description is accompanied by a small case study
implemented in R.&lt;/p&gt;
&lt;p&gt;The GAEN is used by country specific COVID-19 Apps in &lt;a
href=&quot;https://github.com/PersonalDataIO/CoronaRiskScoring&quot;&gt;several
countries&lt;/a&gt;, e.g., Switzerland, Latvia, Denmark, Italy, Poland. In
this post special focus is on the German &lt;a
href=&quot;https://www.coronawarn.app/en/&quot;&gt;Corona-Warn-App&lt;/a&gt; (CWA), which
comes with a special commitment to transparency:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;The Corona-Warn-App is an app that helps trace infection chains of
SARS-CoV-2 (which can cause COVID-19) in Germany. The app is based on
technologies with a decentralized approach and notifies users if they
have been exposed to SARS-CoV-2. Transparency is key to both protect the
app’s end-users and to encourage adoption.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;This means that all code and documentation of the CWA is available
under an open-source license through &lt;a
href=&quot;https://github.com/corona-warn-app&quot;&gt;GitHub&lt;/a&gt;. A good overview of
the technical foundation of the app is provided &lt;a
href=&quot;https://github.com/corona-warn-app/cwa-documentation/blob/master/solution_architecture.md&quot;&gt;here&lt;/a&gt;.
However, important parts of the CWA risk scoring are taken from the GAEN
framework, which is less transparent&lt;a href=&quot;#fn1&quot; class=&quot;footnote-ref&quot;
id=&quot;fnref1&quot; role=&quot;doc-noteref&quot;&gt;&lt;sup&gt;1&lt;/sup&gt;&lt;/a&gt;. In particular I was
interested in the &lt;a
href=&quot;https://developer.apple.com/documentation/exposurenotification/enexposureconfiguration/calculating_the_exposure_risk_value_in_exposurenotification_version_1&quot;&gt;API
v1&lt;/a&gt; form of the risk scoring, because this forms the basis of the CWA
and also provides epidemiological flexibility through the use of the
transmission risk level parameter.&lt;/p&gt;
&lt;h2 id=&quot;the-risk-scoring&quot;&gt;The Risk Scoring&lt;/h2&gt;
&lt;p&gt;A phone using the GAEN framework scans the immediate surroundings in
regular time intervals&lt;a href=&quot;#fn2&quot; class=&quot;footnote-ref&quot; id=&quot;fnref2&quot;
role=&quot;doc-noteref&quot;&gt;&lt;sup&gt;2&lt;/sup&gt;&lt;/a&gt; using the &lt;a
href=&quot;https://en.wikipedia.org/wiki/Bluetooth_Low_Energy&quot;&gt;BLE&lt;/a&gt;
protocol. Doing so, the phone collects anonymous identifier keys of the
devices running BLE near you. If a GAEN user is tested positive, they
can voluntarily decide to upload their anonymous identifier keys to a
server. With regular intervals the app on your phone downloads these
keys and investigates whether there is a match between the keys you
encountered and those available on the server. If there is a match, an
algorithm decides based on attributes of the contact, e.g. duration,
distance and infectiousness of the potential infector, whether the user
should be displayed a warning about an increased risk for infection. It
is this classification algorithm I am interested in.&lt;/p&gt;
&lt;p&gt;Introducing mathematical notation, let &lt;span
class=&quot;math inline&quot;&gt;\(E\)&lt;/span&gt; be the set of encounters recorded by
your phone during the last 14 days. We assume each entry &lt;span
class=&quot;math inline&quot;&gt;\(e\in E\)&lt;/span&gt; consists of attributes&lt;a
href=&quot;#fn3&quot; class=&quot;footnote-ref&quot; id=&quot;fnref3&quot;
role=&quot;doc-noteref&quot;&gt;&lt;sup&gt;3&lt;/sup&gt;&lt;/a&gt; containing the identifier key - also
known as &lt;em&gt;temporary exposure key&lt;/em&gt; (TEK) - of the phone you met,
i.e. &lt;span class=&quot;math inline&quot;&gt;\(\text{key}(e)\)&lt;/span&gt;, the calendar
day the contact happened, &lt;span
class=&quot;math inline&quot;&gt;\(\text{date}(e)\)&lt;/span&gt;, the duration of the
contact, &lt;span class=&quot;math inline&quot;&gt;\(\text{duration}(e)\)&lt;/span&gt;, and
the average attenuation of the signal during the contact, &lt;span
class=&quot;math inline&quot;&gt;\(\text{antennuation}(e)\)&lt;/span&gt;. The later serves
as proxy for the distance between the two phones.&lt;/p&gt;
&lt;p&gt;Furthermore, the server contains the set of uploaded keys by CWA
users, who tested positive for COVID-19 and who gave consent to upload
their keys. Uploaded keys of test positives are also called
&lt;em&gt;diagnosis keys&lt;/em&gt; - technically they are just TEKs. For simplicity
we shall assume in this document that phones are using one key per
calendar day and that an upload of keys consists of the keys used on the
day of upload and the previous 13 days&lt;a href=&quot;#fn4&quot;
class=&quot;footnote-ref&quot; id=&quot;fnref4&quot; role=&quot;doc-noteref&quot;&gt;&lt;sup&gt;4&lt;/sup&gt;&lt;/a&gt;.
Let &lt;span class=&quot;math inline&quot;&gt;\(S\)&lt;/span&gt; denote the set of uploaded
keys on the server and for &lt;span class=&quot;math inline&quot;&gt;\(s\in S\)&lt;/span&gt;
let &lt;span class=&quot;math inline&quot;&gt;\(\text{key}(s)\)&lt;/span&gt; denote the
diagnosis key, &lt;span class=&quot;math inline&quot;&gt;\(\text{day_valid}(s)\)&lt;/span&gt;
the calendar day the key was in use and &lt;span
class=&quot;math inline&quot;&gt;\(\text{TRL}(s)\)&lt;/span&gt; the transmission risk. The
later is a numerical value for how infectious the potential infector was
on &lt;span class=&quot;math inline&quot;&gt;\(\text{day_valid}(s)\)&lt;/span&gt;. For
simplicity, in what follows, we shall consider only the so called
&lt;strong&gt;level&lt;/strong&gt; of the duration, attenuation and transmission
risk, which in the GAEN framework is a discretized version of the
continuous quantity represented by an integer between 0-8.&lt;/p&gt;
&lt;p&gt;We shall denote by &lt;span class=&quot;math inline&quot;&gt;\(I\)&lt;/span&gt; the subset
of &lt;span class=&quot;math inline&quot;&gt;\(E\)&lt;/span&gt;, which consists of keys known
to have been positively tested for COVID-19, that is, the key was
uploaded to the server. For simplicity we shall extend the elements of
&lt;span class=&quot;math inline&quot;&gt;\(E\)&lt;/span&gt; with additional information
provided by the server about the key, i.e. we let &lt;span
class=&quot;math display&quot;&gt;\[
I = \{ (e, s) : e \in E , s \in S , \text{key}(s) = \text{key}(e) \}.
\]&lt;/span&gt;&lt;/p&gt;
&lt;h2 id=&quot;case-study-with-aisha-anton-and-betty&quot;&gt;Case Study with Aisha,
Anton and Betty&lt;/h2&gt;
&lt;p&gt;We shall illustrate the above using an example inspired by the &lt;a
href=&quot;https://github.com/corona-warn-app/cwa-documentation/blob/master/cwa-risk-assessment.md&quot;&gt;CWA
documentation&lt;/a&gt;. In the example the CWA user Betty travels with Anton
and Aisha together by bus to and from work on the 9th and the 16th of
the month. Each trip lasts 10 minutes. Anton sat one meter away from
Betty, while Aisha sat two meters away. Both Anton and Aisha become test
positive on the 20th and decide to upload their keys to the server on
the 20th and 21st, respectively. We perform Betty’s risk calculation on
the 20th and 21st, respectively. To make the example clearer, the
original trip length of 10 minutes is changed to 11 minutes.&lt;/p&gt;
&lt;h3 id=&quot;gaen-configuration&quot;&gt;GAEN Configuration&lt;/h3&gt;
&lt;p&gt;Configuration of the risk scoring parameters as done for the CWA:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb1&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb1-1&quot;&gt;&lt;a href=&quot;#cb1-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;## Transmission risk level provided at key upload - see https://github.com/corona-warn-app/cwa-app-android/blob/fe9128fdb28384640d0a248b7ff46701d6a04f0e/Corona-Warn-App/src/main/java/de/rki/coronawarnapp/util/ProtoFormatConverterExtensions.kt#L12 for the google App&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-2&quot;&gt;&lt;a href=&quot;#cb1-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;trl &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;structure&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;c&lt;/span&gt;(&lt;span class=&quot;dv&quot;&gt;5&lt;/span&gt;, &lt;span class=&quot;dv&quot;&gt;6&lt;/span&gt;, &lt;span class=&quot;dv&quot;&gt;8&lt;/span&gt;, &lt;span class=&quot;dv&quot;&gt;8&lt;/span&gt;, &lt;span class=&quot;dv&quot;&gt;8&lt;/span&gt;, &lt;span class=&quot;dv&quot;&gt;5&lt;/span&gt;, &lt;span class=&quot;dv&quot;&gt;3&lt;/span&gt;, &lt;span class=&quot;fu&quot;&gt;rep&lt;/span&gt;(&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;, &lt;span class=&quot;dv&quot;&gt;7&lt;/span&gt;)), &lt;span class=&quot;at&quot;&gt;names=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;13&lt;/span&gt;)&lt;/span&gt;
&lt;span id=&quot;cb1-3&quot;&gt;&lt;a href=&quot;#cb1-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-4&quot;&gt;&lt;a href=&quot;#cb1-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;# Breaks in dB for the attenuation - see https://github.com/google/exposure-notifications-internals/blob/e953a09dd3c20c04dfa29e362eef461890dac25c/exposurenotification/src/main/java/com/google/samples/exposurenotification/features/ContactTracingFeature.java#L515 &lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-5&quot;&gt;&lt;a href=&quot;#cb1-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;attenuation_breaks &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;c&lt;/span&gt;(&lt;span class=&quot;dv&quot;&gt;0&lt;/span&gt;, &lt;span class=&quot;dv&quot;&gt;10&lt;/span&gt;, &lt;span class=&quot;dv&quot;&gt;15&lt;/span&gt;, &lt;span class=&quot;dv&quot;&gt;27&lt;/span&gt;, &lt;span class=&quot;dv&quot;&gt;33&lt;/span&gt;, &lt;span class=&quot;dv&quot;&gt;51&lt;/span&gt;, &lt;span class=&quot;dv&quot;&gt;63&lt;/span&gt;, &lt;span class=&quot;dv&quot;&gt;73&lt;/span&gt;, &lt;span class=&quot;cn&quot;&gt;Inf&lt;/span&gt;)&lt;/span&gt;
&lt;span id=&quot;cb1-6&quot;&gt;&lt;a href=&quot;#cb1-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;attenuation_include_lowest &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;cn&quot;&gt;TRUE&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-7&quot;&gt;&lt;a href=&quot;#cb1-7&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;# Level for each attenuation bucket, see https://github.com/corona-warn-app/cwa-server/blob/master/services/distribution/src/main/resources/master-config/exposure-config.yaml&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-8&quot;&gt;&lt;a href=&quot;#cb1-8&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;attenuation_lvl    &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;tibble&lt;/span&gt;( &lt;span class=&quot;at&quot;&gt;bucket =&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;c&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;quot;[0,10]&amp;quot;&lt;/span&gt;, &lt;span class=&quot;st&quot;&gt;&amp;quot;(10,15]&amp;quot;&lt;/span&gt;, &lt;span class=&quot;st&quot;&gt;&amp;quot;(15,27]&amp;quot;&lt;/span&gt;,&lt;span class=&quot;st&quot;&gt;&amp;quot;(27,33]&amp;quot;&lt;/span&gt;,  &lt;span class=&quot;st&quot;&gt;&amp;quot;(33,51]&amp;quot;&lt;/span&gt;,  &lt;span class=&quot;st&quot;&gt;&amp;quot;(51,63]&amp;quot;&lt;/span&gt;,  &lt;span class=&quot;st&quot;&gt;&amp;quot;(63,73]&amp;quot;&lt;/span&gt;, &lt;span class=&quot;st&quot;&gt;&amp;quot;(73,Inf]&amp;quot;&lt;/span&gt;), &lt;span class=&quot;at&quot;&gt;lvl=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;c&lt;/span&gt;(&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;, &lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;, &lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;,  &lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;,  &lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;,  &lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;,  &lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;,  &lt;span class=&quot;dv&quot;&gt;0&lt;/span&gt;))&lt;/span&gt;
&lt;span id=&quot;cb1-9&quot;&gt;&lt;a href=&quot;#cb1-9&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-10&quot;&gt;&lt;a href=&quot;#cb1-10&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;# Bucket limits in https://github.com/google/exposure-notifications-internals/blob/e953a09dd3c20c04dfa29e362eef461890dac25c/exposurenotification/src/main/java/com/google/samples/exposurenotification/features/ContactTracingFeature.java#L502 (note that the buckets are closed to the right)&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-11&quot;&gt;&lt;a href=&quot;#cb1-11&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;duration_breaks &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;c&lt;/span&gt;(&lt;span class=&quot;sc&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;cn&quot;&gt;Inf&lt;/span&gt;, &lt;span class=&quot;dv&quot;&gt;0&lt;/span&gt;, &lt;span class=&quot;dv&quot;&gt;5&lt;/span&gt;, &lt;span class=&quot;dv&quot;&gt;10&lt;/span&gt;, &lt;span class=&quot;dv&quot;&gt;15&lt;/span&gt;, &lt;span class=&quot;dv&quot;&gt;20&lt;/span&gt;, &lt;span class=&quot;dv&quot;&gt;25&lt;/span&gt;, &lt;span class=&quot;dv&quot;&gt;30&lt;/span&gt;, &lt;span class=&quot;cn&quot;&gt;Inf&lt;/span&gt;)&lt;/span&gt;
&lt;span id=&quot;cb1-12&quot;&gt;&lt;a href=&quot;#cb1-12&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;duration_include_lowest &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;cn&quot;&gt;FALSE&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-13&quot;&gt;&lt;a href=&quot;#cb1-13&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;# Levels - see https://github.com/corona-warn-app/cwa-server/blob/f3d66840ef59e2ced10fb9b42f08a8938e76075a/services/distribution/src/main/resources/master-config/exposure-config.yaml#L50&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-14&quot;&gt;&lt;a href=&quot;#cb1-14&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;duration_lvl    &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;tibble&lt;/span&gt;( &lt;span class=&quot;at&quot;&gt;bucket =&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;c&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;quot;(-Inf,0]&amp;quot;&lt;/span&gt;, &lt;span class=&quot;st&quot;&gt;&amp;quot;(0,5]&amp;quot;&lt;/span&gt;, &lt;span class=&quot;st&quot;&gt;&amp;quot;(5,10]&amp;quot;&lt;/span&gt; , &lt;span class=&quot;st&quot;&gt;&amp;quot;(10,15]&amp;quot;&lt;/span&gt;,  &lt;span class=&quot;st&quot;&gt;&amp;quot;(15,20]&amp;quot;&lt;/span&gt;, &lt;span class=&quot;st&quot;&gt;&amp;quot;(20,25]&amp;quot;&lt;/span&gt;, &lt;span class=&quot;st&quot;&gt;&amp;quot;(25,30]&amp;quot;&lt;/span&gt;, &lt;span class=&quot;st&quot;&gt;&amp;quot;(30, Inf]&amp;quot;&lt;/span&gt;), &lt;span class=&quot;at&quot;&gt;lvl=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;c&lt;/span&gt;(&lt;span class=&quot;dv&quot;&gt;0&lt;/span&gt;, &lt;span class=&quot;dv&quot;&gt;0&lt;/span&gt;, &lt;span class=&quot;dv&quot;&gt;0&lt;/span&gt;,  &lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;,  &lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;,  &lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;,  &lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;,  &lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;))&lt;/span&gt;
&lt;span id=&quot;cb1-15&quot;&gt;&lt;a href=&quot;#cb1-15&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-16&quot;&gt;&lt;a href=&quot;#cb1-16&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;# Days parameters - see https://github.com/corona-warn-app/cwa-server/blob/f3d66840ef59e2ced10fb9b42f08a8938e76075a/services/distribution/src/main/resources/master-config/exposure-config.yaml#L40&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-17&quot;&gt;&lt;a href=&quot;#cb1-17&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;days_lvl &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;dv&quot;&gt;5&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-18&quot;&gt;&lt;a href=&quot;#cb1-18&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-19&quot;&gt;&lt;a href=&quot;#cb1-19&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;# Time_attenuation_buckets (to be used later)&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-20&quot;&gt;&lt;a href=&quot;#cb1-20&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;time_attenuation_bucket_breaks &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;c&lt;/span&gt;(&lt;span class=&quot;dv&quot;&gt;0&lt;/span&gt;, &lt;span class=&quot;dv&quot;&gt;55&lt;/span&gt;, &lt;span class=&quot;dv&quot;&gt;63&lt;/span&gt;, &lt;span class=&quot;cn&quot;&gt;Inf&lt;/span&gt;)&lt;/span&gt;
&lt;span id=&quot;cb1-21&quot;&gt;&lt;a href=&quot;#cb1-21&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;time_attenuation_buckets &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;levels&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;cut&lt;/span&gt;(&lt;span class=&quot;dv&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;100&lt;/span&gt;, &lt;span class=&quot;at&quot;&gt;breaks=&lt;/span&gt;time_attenuation_bucket_breaks, &lt;span class=&quot;at&quot;&gt;include.lowest=&lt;/span&gt;&lt;span class=&quot;cn&quot;&gt;TRUE&lt;/span&gt;, &lt;span class=&quot;at&quot;&gt;right=&lt;/span&gt;&lt;span class=&quot;cn&quot;&gt;FALSE&lt;/span&gt;))&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;The &lt;span class=&quot;math inline&quot;&gt;\(\text{days}(e)\)&lt;/span&gt; parameter of
an &lt;span class=&quot;math inline&quot;&gt;\(e\in E\)&lt;/span&gt; exposure reflects the
possibility to provide additional risk relevant information about the
CWA user at the day of the contact. However, the CWA currently keeps it
at a fixed value of &lt;a
href=&quot;https://github.com/corona-warn-app/cwa-server/blob/f3d66840ef59e2ced10fb9b42f08a8938e76075a/services/distribution/src/main/resources/master-config/exposure-config.yaml#L40&quot;&gt;5&lt;/a&gt;
and, hence, it plays little role in the risk calculations.&lt;/p&gt;
&lt;h4 id=&quot;part-1-uploaded-keys-on-the-server&quot;&gt;Part 1: Uploaded keys on the
server&lt;/h4&gt;
&lt;p&gt;Anton had his CWA running since 2020-09-13, while Aisha has been
running her app since 2020-09-01. For each of the two we build a tibble
containing the uploaded keys at the day of transmission, i.e. on the
20th and 21st, respectively&lt;a href=&quot;#fn5&quot; class=&quot;footnote-ref&quot;
id=&quot;fnref5&quot; role=&quot;doc-noteref&quot;&gt;&lt;sup&gt;5&lt;/sup&gt;&lt;/a&gt;. Furthermore, we
construct two tibbles mimicking the state of the diagnosis key server on
2020-09-20 and 2020-09-21, respectively.&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb2&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb2-1&quot;&gt;&lt;a href=&quot;#cb2-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;# Upload of Anton on the 2020-09-20 where his app has been running for 8 days&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb2-2&quot;&gt;&lt;a href=&quot;#cb2-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;anton_ndays &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;min&lt;/span&gt;(&lt;span class=&quot;dv&quot;&gt;14&lt;/span&gt;, &lt;span class=&quot;fu&quot;&gt;as.numeric&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;as.Date&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;quot;2020-09-20&amp;quot;&lt;/span&gt;) &lt;span class=&quot;sc&quot;&gt;-&lt;/span&gt; cwa_start_anton &lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;))&lt;/span&gt;
&lt;span id=&quot;cb2-3&quot;&gt;&lt;a href=&quot;#cb2-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;anton &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;tibble&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;key=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;rkey&lt;/span&gt;(anton_ndays),&lt;span class=&quot;at&quot;&gt;valid=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;seq&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;as.Date&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;quot;2020-09-20&amp;quot;&lt;/span&gt;),&lt;span class=&quot;at&quot;&gt;length.out=&lt;/span&gt;anton_ndays,&lt;span class=&quot;at&quot;&gt;by=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;-1 day&amp;quot;&lt;/span&gt;), &lt;span class=&quot;at&quot;&gt;trl=&lt;/span&gt;trl[&lt;span class=&quot;fu&quot;&gt;seq_len&lt;/span&gt;(anton_ndays)])&lt;/span&gt;
&lt;span id=&quot;cb2-4&quot;&gt;&lt;a href=&quot;#cb2-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb2-5&quot;&gt;&lt;a href=&quot;#cb2-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;# Upload of Aisha on the 2020-09-21 where her app has been running for 14 days&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb2-6&quot;&gt;&lt;a href=&quot;#cb2-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;aisha_ndays &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;min&lt;/span&gt;(&lt;span class=&quot;dv&quot;&gt;14&lt;/span&gt;, &lt;span class=&quot;fu&quot;&gt;as.numeric&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;as.Date&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;quot;2020-09-20&amp;quot;&lt;/span&gt;) &lt;span class=&quot;sc&quot;&gt;-&lt;/span&gt; cwa_start_aisha &lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;))&lt;/span&gt;
&lt;span id=&quot;cb2-7&quot;&gt;&lt;a href=&quot;#cb2-7&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;aisha &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;tibble&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;key=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;rkey&lt;/span&gt;(aisha_ndays),&lt;span class=&quot;at&quot;&gt;valid=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;seq&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;as.Date&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;quot;2020-09-21&amp;quot;&lt;/span&gt;),&lt;span class=&quot;at&quot;&gt;length.out=&lt;/span&gt;aisha_ndays,&lt;span class=&quot;at&quot;&gt;by=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;-1 day&amp;quot;&lt;/span&gt;), &lt;span class=&quot;at&quot;&gt;trl=&lt;/span&gt;trl[&lt;span class=&quot;fu&quot;&gt;seq_len&lt;/span&gt;(aisha_ndays)])&lt;/span&gt;
&lt;span id=&quot;cb2-8&quot;&gt;&lt;a href=&quot;#cb2-8&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb2-9&quot;&gt;&lt;a href=&quot;#cb2-9&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;#  Upload to server consists of keys for the last 13 days (note: day zero caveat is ignored). Hence dk&amp;lt;date&amp;gt; consists of all keys who were active during the last  13 days within &amp;lt;date&amp;gt;&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb2-10&quot;&gt;&lt;a href=&quot;#cb2-10&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;dk20200920 &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; anton &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;filter&lt;/span&gt;(valid &lt;span class=&quot;sc&quot;&gt;&amp;gt;=&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;as.Date&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;quot;2020-09-20&amp;quot;&lt;/span&gt;) &lt;span class=&quot;sc&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;dv&quot;&gt;13&lt;/span&gt;)&lt;/span&gt;
&lt;span id=&quot;cb2-11&quot;&gt;&lt;a href=&quot;#cb2-11&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;dk20200921 &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;rbind&lt;/span&gt;(anton, aisha) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;filter&lt;/span&gt;(valid &lt;span class=&quot;sc&quot;&gt;&amp;gt;=&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;as.Date&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;quot;2020-09-21&amp;quot;&lt;/span&gt;) &lt;span class=&quot;sc&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;dv&quot;&gt;13&lt;/span&gt;)&lt;/span&gt;
&lt;span id=&quot;cb2-12&quot;&gt;&lt;a href=&quot;#cb2-12&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb2-13&quot;&gt;&lt;a href=&quot;#cb2-13&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;# Show diagnosis keys of 2020-09-20 (these are Anton&amp;#39;s keys)&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb2-14&quot;&gt;&lt;a href=&quot;#cb2-14&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;dk20200920&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;## # A tibble: 8 x 3
##   key    valid        trl
##   &amp;lt;chr&amp;gt;  &amp;lt;date&amp;gt;     &amp;lt;dbl&amp;gt;
## 1 2a0a87 2020-09-20     5
## 2 051447 2020-09-19     6
## 3 f810f4 2020-09-18     8
## 4 17a0d6 2020-09-17     8
## 5 3d12e3 2020-09-16     8
## 6 aaf590 2020-09-15     5
## 7 22b909 2020-09-14     3
## 8 1be004 2020-09-13     1&lt;/code&gt;&lt;/pre&gt;
&lt;h4 id=&quot;part-2-bettys-exposure-history&quot;&gt;Part 2: Betty’s exposure
history&lt;/h4&gt;
&lt;p&gt;Betty’s sighting history would look as follows:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;## # A tibble: 6 x 7
##   key    date       attenuation duration attenuation_lvl duration_lvl days_lvl
##   &amp;lt;chr&amp;gt;  &amp;lt;date&amp;gt;           &amp;lt;dbl&amp;gt;    &amp;lt;dbl&amp;gt;           &amp;lt;dbl&amp;gt;        &amp;lt;dbl&amp;gt;    &amp;lt;dbl&amp;gt;
## 1 3d12e3 2020-09-16          40       11               2            1        5
## 2 3d12e3 2020-09-16          40       11               2            1        5
## 3 835292 2020-09-16          60       11               2            1        5
## 4 835292 2020-09-16          60       11               2            1        5
## 5 3d8508 2020-09-09          60       11               2            1        5
## 6 3d8508 2020-09-09          60       11               2            1        5&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Hence, Betty’s set of exposures with test positives provided by the
server on the 20th is:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb5&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb5-1&quot;&gt;&lt;a href=&quot;#cb5-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;i_set &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;inner_join&lt;/span&gt;(eh_betty, dk20200920, &lt;span class=&quot;at&quot;&gt;by=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;key&amp;quot;&lt;/span&gt;) &lt;/span&gt;
&lt;span id=&quot;cb5-2&quot;&gt;&lt;a href=&quot;#cb5-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;i_set&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;## # A tibble: 2 x 9
##   key    date       attenuation duration attenuation_lvl duration_lvl days_lvl valid        trl
##   &amp;lt;chr&amp;gt;  &amp;lt;date&amp;gt;           &amp;lt;dbl&amp;gt;    &amp;lt;dbl&amp;gt;           &amp;lt;dbl&amp;gt;        &amp;lt;dbl&amp;gt;    &amp;lt;dbl&amp;gt; &amp;lt;date&amp;gt;     &amp;lt;dbl&amp;gt;
## 1 3d12e3 2020-09-16          40       11               2            1        5 2020-09-16     8
## 2 3d12e3 2020-09-16          40       11               2            1        5 2020-09-16     8&lt;/code&gt;&lt;/pre&gt;
&lt;h2 id=&quot;risk-scoring&quot;&gt;Risk scoring&lt;/h2&gt;
&lt;p&gt;The description of the risk scoring in the CWA app is centered around
&lt;a
href=&quot;https://github.com/corona-warn-app/cwa-documentation/blob/master/solution_architecture.md&quot;&gt;Fig.
12 and 13&lt;/a&gt; of the solution architecture documentation. An
illustrative example of how this computation looks can be found &lt;a
href=&quot;https://github.com/corona-warn-app/cwa-documentation/blob/master/cwa-risk-assessment.md&quot;&gt;here&lt;/a&gt;.
For further details the source code for the risk scoring in the CWA can
be consulted [&lt;a
href=&quot;https://github.com/corona-warn-app/cwa-app-android/blob/5240f1baf92b9d3082d38570c4e11a4f72edde6b/Corona-Warn-App/src/main/java/de/rki/coronawarnapp/risk/DefaultRiskLevelCalculation.kt&quot;&gt;Android
version&lt;/a&gt;| &lt;a href=&quot;&quot;&gt;iOS&lt;/a&gt;]. However, for the Android version,
which is the one I checked most, it is &lt;a
href=&quot;https://github.com/google/exposure-notifications-internals/issues/17#issuecomment-692981452&quot;&gt;not
100% transparent&lt;/a&gt; (to me) how the important &lt;a
href=&quot;https://developers.google.com/android/exposure-notifications/exposure-notifications-api#modes&quot;&gt;&lt;code&gt;exposureSummary&lt;/code&gt;&lt;/a&gt;
object is generated by the API. Nevertheless, the computation of the
GAEN risk scoring algorithm consists of two steps: a per-exposure risk
score calculation followed by an aggregation over all exposures. The
best approximation I could find is &lt;a
href=&quot;https://github.com/google/exposure-notifications-internals/blob/413b561f59cd4a63b571cac83821959e6e022ce8/exposurenotification/src/main/java/com/google/samples/exposurenotification/matching/KeyExposureEvaluator.java&quot;&gt;&lt;code&gt;KeyExposureEvaluator.java&lt;/code&gt;&lt;/a&gt;,
which might be from a later release than v1, though.&lt;/p&gt;
&lt;h2 id=&quot;risk-score&quot;&gt;Risk Score&lt;/h2&gt;
&lt;p&gt;We compute the total risk for each exposure with a test positive,
i.e. for each element &lt;span class=&quot;math inline&quot;&gt;\(i\in I\)&lt;/span&gt;, by:
&lt;span class=&quot;math display&quot;&gt;\[
\text{TR}(i) = \text{duration}(i)\times
\text{attenuation}(i) \times
\text{TRL}(i) \times
\text{days}(i)
\]&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;Exposure risks with a total risk below the &lt;a
href=&quot;https://github.com/corona-warn-app/cwa-server/blob/f3d66840ef59e2ced10fb9b42f08a8938e76075a/services/distribution/src/main/resources/master-config/app-config.yaml#L13&quot;&gt;minimum
risk score&lt;/a&gt; of 11 are put to zero:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb7&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb7-1&quot;&gt;&lt;a href=&quot;#cb7-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;# Minimum risk score - see https://github.com/corona-warn-app/cwa-server/blob/f3d66840ef59e2ced10fb9b42f08a8938e76075a/services/distribution/src/main/resources/master-config/app-config.yaml#L13&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb7-2&quot;&gt;&lt;a href=&quot;#cb7-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;minimum_risk_score &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;dv&quot;&gt;11&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb8&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb8-1&quot;&gt;&lt;a href=&quot;#cb8-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;# Compute risk score and filter out those below the minimum&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb8-2&quot;&gt;&lt;a href=&quot;#cb8-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;risk &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; i_set &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb8-3&quot;&gt;&lt;a href=&quot;#cb8-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;mutate&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;risk_score =&lt;/span&gt; attenuation_lvl &lt;span class=&quot;sc&quot;&gt;*&lt;/span&gt; duration_lvl &lt;span class=&quot;sc&quot;&gt;*&lt;/span&gt; trl &lt;span class=&quot;sc&quot;&gt;*&lt;/span&gt; days_lvl) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;/span&gt;
&lt;span id=&quot;cb8-4&quot;&gt;&lt;a href=&quot;#cb8-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;filter&lt;/span&gt;(risk_score &lt;span class=&quot;sc&quot;&gt;&amp;gt;=&lt;/span&gt; minimum_risk_score)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb9&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb9-1&quot;&gt;&lt;a href=&quot;#cb9-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;risk&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;## # A tibble: 2 x 10
##   key    date       attenuation duration attenuation_lvl duration_lvl days_lvl valid        trl risk_score
##   &amp;lt;chr&amp;gt;  &amp;lt;date&amp;gt;           &amp;lt;dbl&amp;gt;    &amp;lt;dbl&amp;gt;           &amp;lt;dbl&amp;gt;        &amp;lt;dbl&amp;gt;    &amp;lt;dbl&amp;gt; &amp;lt;date&amp;gt;     &amp;lt;dbl&amp;gt;      &amp;lt;dbl&amp;gt;
## 1 3d12e3 2020-09-16          40       11               2            1        5 2020-09-16     8         80
## 2 3d12e3 2020-09-16          40       11               2            1        5 2020-09-16     8         80&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;From this we can compute the the so called &lt;strong&gt;Normalized Total
Risk Score&lt;/strong&gt; defined as &lt;span class=&quot;math display&quot;&gt;\[
\text{Normalized Total Risk Score} := \frac{\max_{i\in I}
\text{TR}(i)}{50}.
\]&lt;/span&gt; I’m guessing, but the value of 50 appears to be a “baseline”
for the transmission risk given by the risk test positives have on the
day they upload their keys ( first element of &lt;code&gt;trl&lt;/code&gt; is 5 and,
hence, &lt;span class=&quot;math inline&quot;&gt;\(1 \times 2 \times 5 \times 5 =
50\)&lt;/span&gt;).&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb11&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb11-1&quot;&gt;&lt;a href=&quot;#cb11-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;# Derive the normalized total risk score&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb11-2&quot;&gt;&lt;a href=&quot;#cb11-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;maxTR &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;max&lt;/span&gt;(risk&lt;span class=&quot;sc&quot;&gt;$&lt;/span&gt;risk_score)&lt;/span&gt;
&lt;span id=&quot;cb11-3&quot;&gt;&lt;a href=&quot;#cb11-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;ntrs &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; maxTR &lt;span class=&quot;sc&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;dv&quot;&gt;50&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb12&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb12-1&quot;&gt;&lt;a href=&quot;#cb12-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;c&lt;/span&gt;(maxTR, ntrs)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;## [1] 80.0  1.6&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;In order to reflect that the accumulation of several exposures with a
test positive increases your risk, a weighted summation of time spent in
three 3 attenuation buckets (distance: far, intermediate and close) is
computed.&lt;/p&gt;
&lt;p&gt;For each class &lt;span class=&quot;math inline&quot;&gt;\(j=1,2,3\)&lt;/span&gt; (signal
strength is low, mid and high) a weighted time in the class is computed
&lt;span class=&quot;math display&quot;&gt;\[
\begin{align}
wt_j = \max\left(30, \sum_{i\in  I^*} \mathcal{I}\left(l_j  \leq
\text{attenuation}(i) &amp;lt; u_j \right) \times \text{duration}(i) \times
w_{j}\right)
\end{align}
\]&lt;/span&gt; where &lt;span class=&quot;math inline&quot;&gt;\(\mathcal{I}(A)\)&lt;/span&gt;
denotes the indicator function which is 1 if the condition &lt;span
class=&quot;math inline&quot;&gt;\(A\)&lt;/span&gt; is fulfilled and zero otherwise.
Furthermore, &lt;span class=&quot;math inline&quot;&gt;\(I^* = \{ i \in I :
\text{TR}(i)&amp;gt;0\}\)&lt;/span&gt;, &lt;span class=&quot;math inline&quot;&gt;\(w_1=0,
w_2=0.5\)&lt;/span&gt; and &lt;span class=&quot;math inline&quot;&gt;\(w_3=1\)&lt;/span&gt; and the
limits &lt;span class=&quot;math inline&quot;&gt;\((l_j, u_j)\)&lt;/span&gt; of the three
classes are &lt;a
href=&quot;https://github.com/corona-warn-app/cwa-server/blob/f3d66840ef59e2ced10fb9b42f08a8938e76075a/services/distribution/src/main/resources/master-config/attenuation-duration.yaml#L13&quot;&gt;chosen&lt;/a&gt;
as &lt;span class=&quot;math inline&quot;&gt;\([63, \infty)\)&lt;/span&gt;, &lt;span
class=&quot;math inline&quot;&gt;\([55,63)\)&lt;/span&gt; and &lt;span
class=&quot;math inline&quot;&gt;\([0,55)\)&lt;/span&gt; dB. Note that for reasons beyond
my knowledge, the time in each class is capped at 30 minutes. The total
time is then calculated as as &lt;span class=&quot;math display&quot;&gt;\[
\text{Total time} = \sum_{j=1}^4 wt_j,
\]&lt;/span&gt; where &lt;span class=&quot;math inline&quot;&gt;\(wt_4\geq 0\)&lt;/span&gt; is
denoted a bucket offset value, which is currently set to 0 in the CWA.
Hence, the largest possible total time is &lt;span
class=&quot;math inline&quot;&gt;\(0\times 30 + 0.5\times 30 + 1\times 30 + 0 =
45\)&lt;/span&gt; minutes.&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb14&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb14-1&quot;&gt;&lt;a href=&quot;#cb14-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;# Accumulate time in the 3 attenuation buckets&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb14-2&quot;&gt;&lt;a href=&quot;#cb14-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;ta_buckets &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; risk &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;/span&gt;
&lt;span id=&quot;cb14-3&quot;&gt;&lt;a href=&quot;#cb14-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;mutate&lt;/span&gt;( &lt;span class=&quot;at&quot;&gt;time_attenuation_bucket =&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;cut&lt;/span&gt;(attenuation, &lt;span class=&quot;at&quot;&gt;breaks=&lt;/span&gt;time_attenuation_bucket_breaks, &lt;span class=&quot;at&quot;&gt;include.lowest=&lt;/span&gt;&lt;span class=&quot;cn&quot;&gt;TRUE&lt;/span&gt;, &lt;span class=&quot;at&quot;&gt;right=&lt;/span&gt;&lt;span class=&quot;cn&quot;&gt;FALSE&lt;/span&gt;)) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;/span&gt;
&lt;span id=&quot;cb14-4&quot;&gt;&lt;a href=&quot;#cb14-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;group_by&lt;/span&gt;(time_attenuation_bucket) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt;  &lt;/span&gt;
&lt;span id=&quot;cb14-5&quot;&gt;&lt;a href=&quot;#cb14-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;summarise&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;time =&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;sum&lt;/span&gt;(duration)) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;/span&gt;
&lt;span id=&quot;cb14-6&quot;&gt;&lt;a href=&quot;#cb14-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;co&quot;&gt;# Cap at 30 minutes&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb14-7&quot;&gt;&lt;a href=&quot;#cb14-7&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;mutate&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;time =&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;pmin&lt;/span&gt;(&lt;span class=&quot;dv&quot;&gt;30&lt;/span&gt;, time, &lt;span class=&quot;at&quot;&gt;na.rm=&lt;/span&gt;&lt;span class=&quot;cn&quot;&gt;TRUE&lt;/span&gt;))&lt;/span&gt;
&lt;span id=&quot;cb14-8&quot;&gt;&lt;a href=&quot;#cb14-8&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb14-9&quot;&gt;&lt;a href=&quot;#cb14-9&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;# Define the weights - https://github.com/corona-warn-app/cwa-server/blob/f3d66840ef59e2ced10fb9b42f08a8938e76075a/services/distribution/src/main/resources/master-config/attenuation-duration.yaml#L15&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb14-10&quot;&gt;&lt;a href=&quot;#cb14-10&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;weights &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;tibble&lt;/span&gt;( &lt;span class=&quot;at&quot;&gt;time_attenuation_bucket=&lt;/span&gt;time_attenuation_buckets, &lt;span class=&quot;at&quot;&gt;weight=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;c&lt;/span&gt;(&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;, &lt;span class=&quot;fl&quot;&gt;0.5&lt;/span&gt;, &lt;span class=&quot;dv&quot;&gt;0&lt;/span&gt;))&lt;/span&gt;
&lt;span id=&quot;cb14-11&quot;&gt;&lt;a href=&quot;#cb14-11&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;ta_buckets_w &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;right_join&lt;/span&gt;( ta_buckets, weights, &lt;span class=&quot;at&quot;&gt;by=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;time_attenuation_bucket&amp;quot;&lt;/span&gt;)&lt;/span&gt;
&lt;span id=&quot;cb14-12&quot;&gt;&lt;a href=&quot;#cb14-12&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb14-13&quot;&gt;&lt;a href=&quot;#cb14-13&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;# Do the weighted summation and add the bucket offset&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb14-14&quot;&gt;&lt;a href=&quot;#cb14-14&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;exposure_score &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; ta_buckets_w &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;summarise&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;total =&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;sum&lt;/span&gt;(time&lt;span class=&quot;sc&quot;&gt;*&lt;/span&gt;weight, &lt;span class=&quot;at&quot;&gt;na.rm=&lt;/span&gt;&lt;span class=&quot;cn&quot;&gt;TRUE&lt;/span&gt;) &lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt;  &lt;span class=&quot;dv&quot;&gt;0&lt;/span&gt;) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;as.numeric&lt;/span&gt;()&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;The combined risk score is now given as &lt;span class=&quot;math display&quot;&gt;\[
\text{Combined Risk Score} = \text{Exposure Score } \times
\text{Normalized Total Risk Score}
\]&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;A warning is given by the app, if the combined risk is above a
threshold value of &lt;a
href=&quot;https://github.com/corona-warn-app/cwa-server/blob/f3d66840ef59e2ced10fb9b42f08a8938e76075a/services/distribution/src/main/resources/master-config/risk-score-classification.yaml#L24&quot;&gt;15&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;In code:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb15&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb15-1&quot;&gt;&lt;a href=&quot;#cb15-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;# Compute combined risk score and classify&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb15-2&quot;&gt;&lt;a href=&quot;#cb15-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;(combined_risk_score &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; exposure_score &lt;span class=&quot;sc&quot;&gt;*&lt;/span&gt; ntrs)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;## [1] 35.2&lt;/code&gt;&lt;/pre&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb17&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb17-1&quot;&gt;&lt;a href=&quot;#cb17-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;(alarm &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; combined_risk_score &lt;span class=&quot;sc&quot;&gt;&amp;gt;=&lt;/span&gt; &lt;span class=&quot;dv&quot;&gt;15&lt;/span&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;## [1] TRUE&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Hence, Betty receives an alarm on the 20th.&lt;/p&gt;
&lt;h4 id=&quot;the-classifier-in-a-nutshell&quot;&gt;The classifier in a nutshell&lt;/h4&gt;
&lt;p&gt;To summarise, the resulting binary risk classifier of the CWA can be
expressed mathematically by the single formula&lt;/p&gt;
&lt;p&gt;&lt;span class=&quot;math display&quot;&gt;\[
\begin{align*}
\mathcal{I}\left\{\left[\sum_{j=1}^ 3 \max\left(30, \sum_{i\in  I^*}
\mathcal{I}\left( \text{attenuation}(i) \in [l_j,u_j) \right) \times
\text{duration}(i) \times w_{j}\right)\right] \times \\
\quad\quad\quad\quad\quad \max_{i\in I} \{\text{duration}(i)\times
\text{attenuation}(i) \times
\text{TRL}(i) \times
\text{days}(i)\} \geq 15\cdot 50 \right\}.
\end{align*}
\]&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;The formula can also be assembled into one classifier function, which
we will use to repeat the risk classification based on the available
server information on 2020-09-21:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb19&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb19-1&quot;&gt;&lt;a href=&quot;#cb19-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;cwa_classifier &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;cf&quot;&gt;function&lt;/span&gt;(i_set) {&lt;/span&gt;
&lt;span id=&quot;cb19-2&quot;&gt;&lt;a href=&quot;#cb19-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;co&quot;&gt;# Compute risk score and filter out those below the minimum&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb19-3&quot;&gt;&lt;a href=&quot;#cb19-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  risk &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; i_set &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb19-4&quot;&gt;&lt;a href=&quot;#cb19-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;fu&quot;&gt;mutate&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;risk_score =&lt;/span&gt; attenuation_lvl &lt;span class=&quot;sc&quot;&gt;*&lt;/span&gt; duration_lvl &lt;span class=&quot;sc&quot;&gt;*&lt;/span&gt; trl &lt;span class=&quot;sc&quot;&gt;*&lt;/span&gt; days_lvl) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;/span&gt;
&lt;span id=&quot;cb19-5&quot;&gt;&lt;a href=&quot;#cb19-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;fu&quot;&gt;filter&lt;/span&gt;(risk_score &lt;span class=&quot;sc&quot;&gt;&amp;gt;=&lt;/span&gt; minimum_risk_score)&lt;/span&gt;
&lt;span id=&quot;cb19-6&quot;&gt;&lt;a href=&quot;#cb19-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;/span&gt;
&lt;span id=&quot;cb19-7&quot;&gt;&lt;a href=&quot;#cb19-7&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;co&quot;&gt;# Derive the normalized total risk score&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb19-8&quot;&gt;&lt;a href=&quot;#cb19-8&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  maxTR &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;max&lt;/span&gt;(risk&lt;span class=&quot;sc&quot;&gt;$&lt;/span&gt;risk_score)&lt;/span&gt;
&lt;span id=&quot;cb19-9&quot;&gt;&lt;a href=&quot;#cb19-9&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  ntrs &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; maxTR &lt;span class=&quot;sc&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;dv&quot;&gt;50&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb19-10&quot;&gt;&lt;a href=&quot;#cb19-10&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;/span&gt;
&lt;span id=&quot;cb19-11&quot;&gt;&lt;a href=&quot;#cb19-11&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;co&quot;&gt;# Accumulate time in the 3 attenuation buckets&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb19-12&quot;&gt;&lt;a href=&quot;#cb19-12&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  ta_buckets &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; risk &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;/span&gt;
&lt;span id=&quot;cb19-13&quot;&gt;&lt;a href=&quot;#cb19-13&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;fu&quot;&gt;mutate&lt;/span&gt;( &lt;span class=&quot;at&quot;&gt;time_attenuation_bucket =&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;cut&lt;/span&gt;(attenuation, &lt;span class=&quot;at&quot;&gt;breaks=&lt;/span&gt;time_attenuation_bucket_breaks, &lt;span class=&quot;at&quot;&gt;include.lowest=&lt;/span&gt;&lt;span class=&quot;cn&quot;&gt;TRUE&lt;/span&gt;, &lt;span class=&quot;at&quot;&gt;right=&lt;/span&gt;&lt;span class=&quot;cn&quot;&gt;FALSE&lt;/span&gt;)) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;/span&gt;
&lt;span id=&quot;cb19-14&quot;&gt;&lt;a href=&quot;#cb19-14&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;fu&quot;&gt;group_by&lt;/span&gt;(time_attenuation_bucket) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt;  &lt;/span&gt;
&lt;span id=&quot;cb19-15&quot;&gt;&lt;a href=&quot;#cb19-15&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;fu&quot;&gt;summarise&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;time =&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;sum&lt;/span&gt;(duration)) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;/span&gt;
&lt;span id=&quot;cb19-16&quot;&gt;&lt;a href=&quot;#cb19-16&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;co&quot;&gt;# Cap at 30 minutes&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb19-17&quot;&gt;&lt;a href=&quot;#cb19-17&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;fu&quot;&gt;mutate&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;time =&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;pmin&lt;/span&gt;(&lt;span class=&quot;dv&quot;&gt;30&lt;/span&gt;, time, &lt;span class=&quot;at&quot;&gt;na.rm=&lt;/span&gt;&lt;span class=&quot;cn&quot;&gt;TRUE&lt;/span&gt;))&lt;/span&gt;
&lt;span id=&quot;cb19-18&quot;&gt;&lt;a href=&quot;#cb19-18&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;/span&gt;
&lt;span id=&quot;cb19-19&quot;&gt;&lt;a href=&quot;#cb19-19&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;co&quot;&gt;# Define the weights - https://github.com/corona-warn-app/cwa-server/blob/f3d66840ef59e2ced10fb9b42f08a8938e76075a/services/distribution/src/main/resources/master-config/attenuation-duration.yaml#L15&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb19-20&quot;&gt;&lt;a href=&quot;#cb19-20&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  weights &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;tibble&lt;/span&gt;( &lt;span class=&quot;at&quot;&gt;time_attenuation_bucket=&lt;/span&gt;time_attenuation_buckets, &lt;span class=&quot;at&quot;&gt;weight=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;c&lt;/span&gt;(&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;, &lt;span class=&quot;fl&quot;&gt;0.5&lt;/span&gt;, &lt;span class=&quot;dv&quot;&gt;0&lt;/span&gt;))&lt;/span&gt;
&lt;span id=&quot;cb19-21&quot;&gt;&lt;a href=&quot;#cb19-21&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  ta_buckets_w &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;right_join&lt;/span&gt;( ta_buckets, weights, &lt;span class=&quot;at&quot;&gt;by=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;time_attenuation_bucket&amp;quot;&lt;/span&gt;)&lt;/span&gt;
&lt;span id=&quot;cb19-22&quot;&gt;&lt;a href=&quot;#cb19-22&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;/span&gt;
&lt;span id=&quot;cb19-23&quot;&gt;&lt;a href=&quot;#cb19-23&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;co&quot;&gt;# Do the weighted summation and add the bucket offset&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb19-24&quot;&gt;&lt;a href=&quot;#cb19-24&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  exposure_score &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; ta_buckets_w &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;summarise&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;total =&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;sum&lt;/span&gt;(time&lt;span class=&quot;sc&quot;&gt;*&lt;/span&gt;weight, &lt;span class=&quot;at&quot;&gt;na.rm=&lt;/span&gt;&lt;span class=&quot;cn&quot;&gt;TRUE&lt;/span&gt;) &lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt;  &lt;span class=&quot;dv&quot;&gt;0&lt;/span&gt;) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;as.numeric&lt;/span&gt;()&lt;/span&gt;
&lt;span id=&quot;cb19-25&quot;&gt;&lt;a href=&quot;#cb19-25&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;/span&gt;
&lt;span id=&quot;cb19-26&quot;&gt;&lt;a href=&quot;#cb19-26&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;co&quot;&gt;# Compute combined risk score and classify&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb19-27&quot;&gt;&lt;a href=&quot;#cb19-27&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  (combined_risk_score &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; exposure_score &lt;span class=&quot;sc&quot;&gt;*&lt;/span&gt; ntrs)&lt;/span&gt;
&lt;span id=&quot;cb19-28&quot;&gt;&lt;a href=&quot;#cb19-28&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  (alarm &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; combined_risk_score &lt;span class=&quot;sc&quot;&gt;&amp;gt;=&lt;/span&gt; &lt;span class=&quot;dv&quot;&gt;15&lt;/span&gt;)&lt;/span&gt;
&lt;span id=&quot;cb19-29&quot;&gt;&lt;a href=&quot;#cb19-29&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;/span&gt;
&lt;span id=&quot;cb19-30&quot;&gt;&lt;a href=&quot;#cb19-30&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;co&quot;&gt;# Return individals elements of the risk classification&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb19-31&quot;&gt;&lt;a href=&quot;#cb19-31&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;return&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;list&lt;/span&gt;( &lt;span class=&quot;at&quot;&gt;risk=&lt;/span&gt;risk, &lt;span class=&quot;at&quot;&gt;ta_buckets_w=&lt;/span&gt;ta_buckets_w,  &lt;span class=&quot;at&quot;&gt;exposure_score=&lt;/span&gt;exposure_score, &lt;span class=&quot;at&quot;&gt;ntrs=&lt;/span&gt;ntrs, &lt;span class=&quot;at&quot;&gt;combined_risk_score=&lt;/span&gt;combined_risk_score, &lt;span class=&quot;at&quot;&gt;alarm=&lt;/span&gt;alarm))&lt;/span&gt;
&lt;span id=&quot;cb19-32&quot;&gt;&lt;a href=&quot;#cb19-32&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Note that the server information on 2020-09-21 is slightly different
from 2020-09-20, because now also Aisha’s keys are available:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb20&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb20-1&quot;&gt;&lt;a href=&quot;#cb20-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;i_set &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;left_join&lt;/span&gt;(eh_betty, dk20200921, &lt;span class=&quot;at&quot;&gt;by=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;key&amp;quot;&lt;/span&gt;)&lt;/span&gt;
&lt;span id=&quot;cb20-2&quot;&gt;&lt;a href=&quot;#cb20-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;cwa_classifier&lt;/span&gt;(i_set)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;## $risk
## # A tibble: 4 x 10
##   key    date       attenuation duration attenuation_lvl duration_lvl days_lvl valid        trl risk_score
##   &amp;lt;chr&amp;gt;  &amp;lt;date&amp;gt;           &amp;lt;dbl&amp;gt;    &amp;lt;dbl&amp;gt;           &amp;lt;dbl&amp;gt;        &amp;lt;dbl&amp;gt;    &amp;lt;dbl&amp;gt; &amp;lt;date&amp;gt;     &amp;lt;dbl&amp;gt;      &amp;lt;dbl&amp;gt;
## 1 3d12e3 2020-09-16          40       11               2            1        5 2020-09-16     8         80
## 2 3d12e3 2020-09-16          40       11               2            1        5 2020-09-16     8         80
## 3 835292 2020-09-16          60       11               2            1        5 2020-09-16     5         50
## 4 835292 2020-09-16          60       11               2            1        5 2020-09-16     5         50
## 
## $ta_buckets_w
## # A tibble: 3 x 3
##   time_attenuation_bucket  time weight
##   &amp;lt;chr&amp;gt;                   &amp;lt;dbl&amp;gt;  &amp;lt;dbl&amp;gt;
## 1 [0,55)                     22    1  
## 2 [55,63)                    22    0.5
## 3 [63,Inf]                   NA    0  
## 
## $exposure_score
## [1] 33
## 
## $ntrs
## [1] 1.6
## 
## $combined_risk_score
## [1] 52.8
## 
## $alarm
## [1] TRUE&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;In other words and not so surprising: we also get an alarm, if Betty
runs the risk scoring on the 21st. However, the combined risk score is
now also higher due to the multiple exposures.&lt;/p&gt;
&lt;h2 id=&quot;discussion&quot;&gt;Discussion&lt;/h2&gt;
&lt;p&gt;Despite an honest effort to try to understand the code and the
documentation, there are still specific details, which I’m unsure about.
One reason is that only parts of the code of the GAEN framework v1 are
public - this should be improved. Another reason is that I lack the
technical skills to really build and execute the CWA from source on my
phone or to evaluate he GAEN snippets. This would allow me to test
different scenarios and gain insight based on a reverse engineering
approach. A mathematical and high-level implementation documentation as
the one attempted in this post is not easy to understand either, but
math is a universal language with enough abstraction to not get lost in
the nitty-gritty details of source code. If the source code is public,
however, a ground truth can always be established - it may just take
time… This post mixes the two approaches by supplementing the math with
an illustrative example using R code - the source of this is available
from &lt;a
href=&quot;https://raw.githubusercontent.com/hoehleatsu/hoehleatsu.github.io/master/_source/2020-09-17-gaen_riskscoring.Rmd&quot;&gt;GitHub&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;More details on the use of mathematics in digital contact tracing can
be found in my lecture given as part of the 2020 summer course on “The
Mathematics and Statistics of Infectious Disease Outbreaks” at Stockholm
University [&lt;a
href=&quot;https://github.com/hoehleatsu/mt3002-summer2020/blob/master/Lectures/Lecture12/lecture12.pdf&quot;&gt;slides&lt;/a&gt;
| &lt;a href=&quot;https://youtu.be/KdY62_KmJEE&quot;&gt;video part 1&lt;/a&gt; | &lt;a
href=&quot;https://youtu.be/DvS6-S3S6vc&quot;&gt;video part 2&lt;/a&gt;].&lt;/p&gt;
&lt;center&gt;
&lt;iframe width=&quot;560&quot; height=&quot;315&quot; src=&quot;https://www.youtube.com/embed/KdY62_KmJEE&quot; frameborder=&quot;0&quot; allow=&quot;accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture&quot; allowfullscreen&gt;
&lt;/iframe&gt;
&lt;/center&gt;
&lt;h2 id=&quot;literature&quot;&gt;Literature&lt;/h2&gt;
&lt;section id=&quot;footnotes&quot; class=&quot;footnotes footnotes-end-of-document&quot;
role=&quot;doc-endnotes&quot;&gt;
&lt;hr /&gt;
&lt;ol&gt;
&lt;li id=&quot;fn1&quot;&gt;&lt;p&gt;Code snippets have recently been published [&lt;a
href=&quot;https://github.com/google/exposure-notifications-internals&quot;&gt;google&lt;/a&gt;
| &lt;a href=&quot;https://developer.apple.com/exposure-notification/&quot;&gt;apple&lt;/a&gt;
| &lt;a
href=&quot;https://github.com/rettichschnidi/ExposureNotification&quot;&gt;inofficial
GitHub of the apple code&lt;/a&gt;]. Unfortunately, most of the published code
appears to cover later releases of the GAEN. Furthermore, as far as I
can tell, both the Google and the Apple snippets don’t cover the full
code used for the risk scoring in v1. Hence, some of my above
explanations deduced from the code may fail to truly capture the state
and functioning of the v1 risk scoring.&lt;a href=&quot;#fnref1&quot;
class=&quot;footnote-back&quot; role=&quot;doc-backlink&quot;&gt;↩︎&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;
&lt;li id=&quot;fn2&quot;&gt;&lt;p&gt;Approximately every 5 minutes.&lt;a href=&quot;#fnref2&quot;
class=&quot;footnote-back&quot; role=&quot;doc-backlink&quot;&gt;↩︎&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;
&lt;li id=&quot;fn3&quot;&gt;&lt;p&gt;This description is a simplification. In reality the &lt;a
href=&quot;https://en.wikipedia.org/wiki/Bluetooth_Low_Energy&quot;&gt;BLE&lt;/a&gt;
protocol consists of a series of scans where it is recorded which keys
can be found. These series sightings of a key are then aggregated to
exposures periods by the GAEN, which have a beginning and an end.&lt;a
href=&quot;#fnref3&quot; class=&quot;footnote-back&quot; role=&quot;doc-backlink&quot;&gt;↩︎&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;
&lt;li id=&quot;fn4&quot;&gt;&lt;p&gt;In practice the TEKs change frequently each day to
preserve anonymity, but it’s possible to deduce all corresponding TEK
from one uploaded diagnosis key.&lt;a href=&quot;#fnref4&quot; class=&quot;footnote-back&quot;
role=&quot;doc-backlink&quot;&gt;↩︎&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;
&lt;li id=&quot;fn5&quot;&gt;&lt;p&gt;For this post we ignore the fact that the key active on
the day of upload is not uploaded until tomorrow, but see also this &lt;a
href=&quot;https://github.com/corona-warn-app/cwa-server/issues/723#issuecomment-684814760&quot;&gt;issue&lt;/a&gt;.&lt;a
href=&quot;#fnref5&quot; class=&quot;footnote-back&quot; role=&quot;doc-backlink&quot;&gt;↩︎&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;/section&gt;
</description>
        <pubDate>Thu, 17 Sep 2020 00:00:00 +0200</pubDate>
        <link>https://mhoehle.github.io/blog/2020/09/17/gaen_riskscoring.html</link>
        <guid isPermaLink="true">https://mhoehle.github.io/blog/2020/09/17/gaen_riskscoring.html</guid>
        
        <category>rstats</category>
        
        <category>COVID-19</category>
        
        <category>SARS-CoV-2</category>
        
        <category>digital epidemiology</category>
        
        <category>contact tracing</category>
        
        
      </item>
    
      <item>
        <title>Superspreading and the Gini Coefficient</title>
        <description>&lt;h2 id=&quot;abstract&quot;&gt;Abstract:&lt;/h2&gt;
&lt;p&gt;We look at superspreading in infectious disease transmission from a
statistical point of view. We characterise heterogeneity in the
offspring distribution by the Gini coefficient instead of the usual
dispersion parameter of the negative binomial distribution. This allows
us to consider more flexible offspring distributions.&lt;/p&gt;
&lt;center&gt;
&lt;img src=&quot;/blog/figure/source/2020-05-31-superspreader/PLOTMODIFIEDLORENZ-1.png&quot; width=&quot;550&quot;&gt;
&lt;/center&gt;
&lt;p&gt;&lt;br&gt;
&lt;a rel=&quot;license&quot; href=&quot;http://creativecommons.org/licenses/by-sa/4.0/&quot;&gt;&lt;img alt=&quot;Creative Commons License&quot; style=&quot;border-width:0&quot; src=&quot;https://i.creativecommons.org/l/by-sa/4.0/88x31.png&quot;/&gt;&lt;/a&gt;
This work is licensed under a &lt;a rel=&quot;license&quot;
href=&quot;http://creativecommons.org/licenses/by-sa/4.0/&quot;&gt;Creative Commons
Attribution-ShareAlike 4.0 International License&lt;/a&gt;. The
markdown+Rknitr source code of this blog is available under a &lt;a
href=&quot;https://www.gnu.org/licenses/gpl-3.0.html&quot;&gt;GNU General Public
License (GPL v3)&lt;/a&gt; license from github.&lt;/p&gt;
&lt;h2 id=&quot;motivation&quot;&gt;Motivation&lt;/h2&gt;
&lt;p&gt;The recent Science report on &lt;a
href=&quot;https://www.sciencemag.org/news/2020/05/why-do-some-covid-19-patients-infect-many-others-whereas-most-don-t-spread-virus-all&quot;&gt;Superspreading
during the COVID-19 pandemic&lt;/a&gt; by Kai Kupferschmidt has made the
dispersion parameter &lt;span class=&quot;math inline&quot;&gt;\(k\)&lt;/span&gt; of the
negative binomial distribution a hot quantity&lt;a href=&quot;#fn1&quot;
class=&quot;footnote-ref&quot; id=&quot;fnref1&quot; role=&quot;doc-noteref&quot;&gt;&lt;sup&gt;1&lt;/sup&gt;&lt;/a&gt; in
the discussions of how to determine effective interventions. This short
blog post aims at understanding the math behind statements such as
“Probably about 10% of cases lead to 80% of the spread” and replicate
them with computations in &lt;a href=&quot;https://www.r-project.org&quot;&gt;R&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Warning&lt;/strong&gt;: This post reflects more my own learning
process of what is superspreading than trying to make any statements of
importance.&lt;/p&gt;
&lt;h2 id=&quot;superspreading&quot;&gt;Superspreading&lt;/h2&gt;
&lt;p&gt;&lt;span class=&quot;citation&quot; data-cites=&quot;lloydsmith_etal2005&quot;&gt;Lloyd-Smith
et al. (2005)&lt;/span&gt; show that the 2002-2004 SARS-CoV-1 epidemic was
driven by a small number of events where one case directly infected a
large number of secondary cases - a so called superspreading event. This
means that for SARS-CoV-1 the distribution of how many secondary cases
each primary case generates is heavy tailed. More specifically, the &lt;a
href=&quot;https://staff.math.su.se/hoehle/blog/2020/04/15/effectiveR0.html&quot;&gt;effective
reproduction number&lt;/a&gt; describes the mean number of secondary cases a
primary case generates during the outbreak, i.e. it is the mean of the
offspring distribution. In order to address dispersion around this mean,
&lt;span class=&quot;citation&quot; data-cites=&quot;lloydsmith_etal2005&quot;&gt;Lloyd-Smith et
al. (2005)&lt;/span&gt; use the &lt;a
href=&quot;https://en.wikipedia.org/wiki/Negative_binomial_distribution&quot;&gt;negative
binomial distribution&lt;/a&gt; with mean &lt;span
class=&quot;math inline&quot;&gt;\(R(t)\)&lt;/span&gt; and over-dispersion parameter &lt;span
class=&quot;math inline&quot;&gt;\(k\)&lt;/span&gt; as a probability model for the
offspring distribution. The number of offspring that case &lt;span
class=&quot;math inline&quot;&gt;\(i\)&lt;/span&gt;, which got infected at time &lt;span
class=&quot;math inline&quot;&gt;\(t_i\)&lt;/span&gt;, causes is given by &lt;span
class=&quot;math display&quot;&gt;\[
Y_{i} \sim \operatorname{NegBin}(R(t_i), k),
\]&lt;/span&gt; s.t. &lt;span class=&quot;math inline&quot;&gt;\(\operatorname{E}(Y_{i}) =
R(t_i)\)&lt;/span&gt; and &lt;span
class=&quot;math inline&quot;&gt;\(\operatorname{Var}(Y_{i}) = R(t_i) (1 +
\frac{1}{k} R(t_i))\)&lt;/span&gt;. This parametrisation makes it easy to see
that the negative binomial model has an additional factor &lt;span
class=&quot;math inline&quot;&gt;\(1 + \frac{1}{k} R(t_i)\)&lt;/span&gt; for the variance,
which allows it to have excess variance (aka. over-dispersion) compared
to the Poisson distribution, which has &lt;span
class=&quot;math inline&quot;&gt;\(\operatorname{Var}(Y_{i}) = R(t_i)\)&lt;/span&gt;. If
&lt;span class=&quot;math inline&quot;&gt;\(k\rightarrow \infty\)&lt;/span&gt; we get the
Poisson distribution and the closer &lt;span
class=&quot;math inline&quot;&gt;\(k\)&lt;/span&gt; is to zero the larger the variance,
i.e. the heterogeneity, in the distribution is. Note the deliberate use
of the effective reproduction number &lt;span
class=&quot;math inline&quot;&gt;\(R(t_i)\)&lt;/span&gt; instead of the basic reproduction
number &lt;span class=&quot;math inline&quot;&gt;\(R_0\)&lt;/span&gt; (as done in &lt;span
class=&quot;citation&quot; data-cites=&quot;lloydsmith_etal2005&quot;&gt;Lloyd-Smith et al.
(2005)&lt;/span&gt;) in the model. This is to highlight, that one is likely to
observe clusters in the context of interventions and depletion of
susceptibles.&lt;/p&gt;
&lt;p&gt;That the dispersion parameter &lt;span class=&quot;math inline&quot;&gt;\(k\)&lt;/span&gt;
is making epidemiological fame is a little surprising, because it is a
parameter in a specific parametric model. A parametric model, which
might be inadequate for the observed data. A secondary objective of this
post is thus to focus more on describing the heterogeneity of the
offspring distribution using classical statistical concepts such as the
&lt;a href=&quot;https://en.wikipedia.org/wiki/Gini_coefficient&quot;&gt;&lt;strong&gt;Gini
coefficient&lt;/strong&gt;&lt;/a&gt;.&lt;/p&gt;
&lt;h2
id=&quot;negative-binomial-distributed-number-of-secondary-cases&quot;&gt;Negative
binomial distributed number of secondary cases&lt;/h2&gt;
&lt;p&gt;Let’s assume &lt;span class=&quot;math inline&quot;&gt;\(k=0.45\)&lt;/span&gt; as done in
&lt;span class=&quot;citation&quot; data-cites=&quot;adam_etal2020&quot;&gt;Adam et al.
(2020)&lt;/span&gt;. This is a slightly higher estimate than the &lt;span
class=&quot;math inline&quot;&gt;\(k=0.1\)&lt;/span&gt; estimate by &lt;span class=&quot;citation&quot;
data-cites=&quot;endo_etal2020&quot;&gt;Endo et al. (2020)&lt;/span&gt;&lt;a href=&quot;#fn2&quot;
class=&quot;footnote-ref&quot; id=&quot;fnref2&quot; role=&quot;doc-noteref&quot;&gt;&lt;sup&gt;2&lt;/sup&gt;&lt;/a&gt;
quoted in the Science article. We want to derive statements like “the x%
most active spreaders infected y% of all cases” as a function of &lt;span
class=&quot;math inline&quot;&gt;\(k\)&lt;/span&gt;. The PMF of the offspring distribution
with mean 2.5 and dispersion 0.45 looks as follows:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb1&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb1-1&quot;&gt;&lt;a href=&quot;#cb1-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;Rt &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fl&quot;&gt;2.5&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-2&quot;&gt;&lt;a href=&quot;#cb1-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;k  &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fl&quot;&gt;0.45&lt;/span&gt; &lt;/span&gt;
&lt;span id=&quot;cb1-3&quot;&gt;&lt;a href=&quot;#cb1-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-4&quot;&gt;&lt;a href=&quot;#cb1-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;# Evaluate on a larger enough grid, so E(Y_t) is determined accurate enough&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-5&quot;&gt;&lt;a href=&quot;#cb1-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;# We also include -1 in the grid to get a point (0,0) needed for the Lorenz curve&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-6&quot;&gt;&lt;a href=&quot;#cb1-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;df &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;data.frame&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;x=&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;250&lt;/span&gt;) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;mutate&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;pmf=&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;dnbinom&lt;/span&gt;(x, &lt;span class=&quot;at&quot;&gt;mu=&lt;/span&gt;Rt, &lt;span class=&quot;at&quot;&gt;size=&lt;/span&gt;k))&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;img src=&quot;/blog/figure/source/2020-05-31-superspreader/PMFNEGBIN-1.png&quot; style=&quot;display: block; margin: auto;&quot; /&gt;&lt;/p&gt;
&lt;p&gt;So we observe that 43% of the cases never manage to infect a
secondary case, whereas some cases manage to generate more than 10 new
cases. The mean of the distribution is checked empirically to equal the
specified &lt;span class=&quot;math inline&quot;&gt;\(R(t)\)&lt;/span&gt; of 2.5:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb2&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb2-1&quot;&gt;&lt;a href=&quot;#cb2-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;sum&lt;/span&gt;(df&lt;span class=&quot;sc&quot;&gt;$&lt;/span&gt;x &lt;span class=&quot;sc&quot;&gt;*&lt;/span&gt; df&lt;span class=&quot;sc&quot;&gt;$&lt;/span&gt;pmf)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;## [1] 2.5&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;span class=&quot;citation&quot; data-cites=&quot;lloydsmith_etal2005&quot;&gt;Lloyd-Smith
et al. (2005)&lt;/span&gt; define a &lt;strong&gt;superspreader&lt;/strong&gt; to be a
primary case, which generates more secondary cases than the 99th
quantile of the Poisson distribution with mean &lt;span
class=&quot;math inline&quot;&gt;\(R(t)\)&lt;/span&gt;. We use this to compute the
proportion of superspreaders in our distribution:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb4&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb4-1&quot;&gt;&lt;a href=&quot;#cb4-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;(superspreader_threshold &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;qpois&lt;/span&gt;(&lt;span class=&quot;fl&quot;&gt;0.99&lt;/span&gt;, &lt;span class=&quot;at&quot;&gt;lambda=&lt;/span&gt;Rt))&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;## [1] 7&lt;/code&gt;&lt;/pre&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb6&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb6-1&quot;&gt;&lt;a href=&quot;#cb6-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;(p_superspreader &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;pnbinom&lt;/span&gt;(superspreader_threshold, &lt;span class=&quot;at&quot;&gt;mu=&lt;/span&gt;Rt, &lt;span class=&quot;at&quot;&gt;size=&lt;/span&gt;k, &lt;span class=&quot;at&quot;&gt;lower.tail=&lt;/span&gt;&lt;span class=&quot;cn&quot;&gt;FALSE&lt;/span&gt;))&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;## [1] 0.09539277&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;So 10% of the cases will generate more than 7 new cases. To get to
statements such as “10% generate 80% of the cases” we also need to know
how many cases those 10% generate out of the 2.5 average.&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb8&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb8-1&quot;&gt;&lt;a href=&quot;#cb8-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;# Compute proportion of the overall expected number of new cases&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb8-2&quot;&gt;&lt;a href=&quot;#cb8-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;df &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; df &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;mutate&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;cdf =&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;pnbinom&lt;/span&gt;(x, &lt;span class=&quot;at&quot;&gt;mu=&lt;/span&gt;Rt, &lt;span class=&quot;at&quot;&gt;size=&lt;/span&gt;k), &lt;/span&gt;
&lt;span id=&quot;cb8-3&quot;&gt;&lt;a href=&quot;#cb8-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;                    &lt;span class=&quot;at&quot;&gt;expected_cases=&lt;/span&gt;x&lt;span class=&quot;sc&quot;&gt;*&lt;/span&gt;pmf, &lt;/span&gt;
&lt;span id=&quot;cb8-4&quot;&gt;&lt;a href=&quot;#cb8-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;                    &lt;span class=&quot;at&quot;&gt;prop_of_Rt=&lt;/span&gt;expected_cases&lt;span class=&quot;sc&quot;&gt;/&lt;/span&gt;Rt,&lt;/span&gt;
&lt;span id=&quot;cb8-5&quot;&gt;&lt;a href=&quot;#cb8-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;                    &lt;span class=&quot;at&quot;&gt;cum_prop_of_Rt =&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;cumsum&lt;/span&gt;(prop_of_Rt))&lt;/span&gt;
&lt;span id=&quot;cb8-6&quot;&gt;&lt;a href=&quot;#cb8-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb8-7&quot;&gt;&lt;a href=&quot;#cb8-7&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;# Summarise&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb8-8&quot;&gt;&lt;a href=&quot;#cb8-8&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;info &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; df &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;filter&lt;/span&gt;(x &lt;span class=&quot;sc&quot;&gt;&amp;gt;&lt;/span&gt; superspreader_threshold) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;/span&gt;
&lt;span id=&quot;cb8-9&quot;&gt;&lt;a href=&quot;#cb8-9&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;summarise&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;expected_cases =&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;sum&lt;/span&gt;(expected_cases), &lt;span class=&quot;at&quot;&gt;prop_of_Rt =&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;sum&lt;/span&gt;(prop_of_Rt))&lt;/span&gt;
&lt;span id=&quot;cb8-10&quot;&gt;&lt;a href=&quot;#cb8-10&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;info&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;##   expected_cases prop_of_Rt
## 1       1.192786  0.4771144&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;In other words, the superspreaders generate (on average) 1.19 of the
2.5 new cases of a generation, i.e. 48%.&lt;/p&gt;
&lt;p&gt;These statements can also be made without formulating a superspreader
threshold by graphing the cumulative share of primary cases against the
cumulative share of secondary cases these primary cases generate. This
is exactly what the &lt;a
href=&quot;https://en.wikipedia.org/wiki/Lorenz_curve&quot;&gt;Lorenz curve&lt;/a&gt; is
doing. However, for outbreak analysis it appears clearer to graph the
cumulative distribution in decreasing order of the number of offspring
generated, i.e. following &lt;span class=&quot;citation&quot;
data-cites=&quot;lloydsmith_etal2005&quot;&gt;Lloyd-Smith et al. (2005)&lt;/span&gt; we
plot the cumulative share as &lt;span class=&quot;math inline&quot;&gt;\(P(Y\geq
y)\)&lt;/span&gt; instead of &lt;span class=&quot;math inline&quot;&gt;\(P(Y \leq y)\)&lt;/span&gt;.
This is a variation of the Lorenz curve, but allows statements such as
“the %x cases with highest number of offspring generate %y of the
secondary cases”.&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb10&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb10-1&quot;&gt;&lt;a href=&quot;#cb10-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;# Add information for plotting the modified Lorenz curve&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb10-2&quot;&gt;&lt;a href=&quot;#cb10-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;df &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; df &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;/span&gt;
&lt;span id=&quot;cb10-3&quot;&gt;&lt;a href=&quot;#cb10-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;mutate&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;cdf_decreasing =&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;pnbinom&lt;/span&gt;(x&lt;span class=&quot;dv&quot;&gt;-1&lt;/span&gt;, &lt;span class=&quot;at&quot;&gt;mu=&lt;/span&gt;Rt, &lt;span class=&quot;at&quot;&gt;size=&lt;/span&gt;k, &lt;span class=&quot;at&quot;&gt;lower.tail=&lt;/span&gt;&lt;span class=&quot;cn&quot;&gt;FALSE&lt;/span&gt;)) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb10-4&quot;&gt;&lt;a href=&quot;#cb10-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;arrange&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;desc&lt;/span&gt;(x)) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt;  &lt;/span&gt;
&lt;span id=&quot;cb10-5&quot;&gt;&lt;a href=&quot;#cb10-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;mutate&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;cum_prop_of_Rt_decreasing =&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;cumsum&lt;/span&gt;(prop_of_Rt))&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb11&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb11-1&quot;&gt;&lt;a href=&quot;#cb11-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;# Plot the modified Lorenz curve as in Fig 1b of Lloyd-Smith et al. (2005)&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb11-2&quot;&gt;&lt;a href=&quot;#cb11-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;ggplot&lt;/span&gt;(df, &lt;span class=&quot;fu&quot;&gt;aes&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;x=&lt;/span&gt;cdf_decreasing, &lt;span class=&quot;at&quot;&gt;y=&lt;/span&gt;cum_prop_of_Rt_decreasing)) &lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;geom_line&lt;/span&gt;() &lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt; &lt;/span&gt;
&lt;span id=&quot;cb11-3&quot;&gt;&lt;a href=&quot;#cb11-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;coord_cartesian&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;xlim=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;c&lt;/span&gt;(&lt;span class=&quot;dv&quot;&gt;0&lt;/span&gt;,&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;)) &lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt; &lt;/span&gt;
&lt;span id=&quot;cb11-4&quot;&gt;&lt;a href=&quot;#cb11-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;xlab&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;quot;Proportion of the infectious cases (cases with most secondary cases first)&amp;quot;&lt;/span&gt;) &lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt; &lt;/span&gt;
&lt;span id=&quot;cb11-5&quot;&gt;&lt;a href=&quot;#cb11-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;ylab&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;quot;Proportion of the secondary cases&amp;quot;&lt;/span&gt;) &lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb11-6&quot;&gt;&lt;a href=&quot;#cb11-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;scale_x_continuous&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;labels=&lt;/span&gt;scales&lt;span class=&quot;sc&quot;&gt;::&lt;/span&gt;percent, &lt;span class=&quot;at&quot;&gt;breaks=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;seq&lt;/span&gt;(&lt;span class=&quot;dv&quot;&gt;0&lt;/span&gt;,&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;,&lt;span class=&quot;at&quot;&gt;length=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;6&lt;/span&gt;)) &lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb11-7&quot;&gt;&lt;a href=&quot;#cb11-7&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;scale_y_continuous&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;labels=&lt;/span&gt;scales&lt;span class=&quot;sc&quot;&gt;::&lt;/span&gt;percent, &lt;span class=&quot;at&quot;&gt;breaks=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;seq&lt;/span&gt;(&lt;span class=&quot;dv&quot;&gt;0&lt;/span&gt;,&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;,&lt;span class=&quot;at&quot;&gt;length=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;6&lt;/span&gt;)) &lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb11-8&quot;&gt;&lt;a href=&quot;#cb11-8&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;geom_line&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;data=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;data.frame&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;x=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;seq&lt;/span&gt;(&lt;span class=&quot;dv&quot;&gt;0&lt;/span&gt;,&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;,&lt;span class=&quot;at&quot;&gt;length=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;100&lt;/span&gt;)) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;mutate&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;y=&lt;/span&gt;x), &lt;span class=&quot;fu&quot;&gt;aes&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;x=&lt;/span&gt;x, &lt;span class=&quot;at&quot;&gt;y=&lt;/span&gt;y), &lt;span class=&quot;at&quot;&gt;lty=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;, &lt;span class=&quot;at&quot;&gt;col=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;gray&amp;quot;&lt;/span&gt;) &lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;ggtitle&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;str_c&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;quot;Scenario: R(t) = &amp;quot;&lt;/span&gt;, Rt, &lt;span class=&quot;st&quot;&gt;&amp;quot;, k = &amp;quot;&lt;/span&gt;, k))&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;img src=&quot;/blog/figure/source/2020-05-31-superspreader/PLOTMODIFIEDLORENZ-1.png&quot; style=&quot;display: block; margin: auto;&quot; /&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Update 2020-06-01&lt;/strong&gt;: &lt;a
href=&quot;https://twitter.com/cortinah&quot;&gt;Hernando Cortina&lt;/a&gt; made me aware
that plotting the Lorenz curve for decreasing values is easily done
using the &lt;a
href=&quot;https://cran.r-project.org/web/packages/gglorenz/index.html&quot;&gt;&lt;code&gt;gglorenz&lt;/code&gt;&lt;/a&gt;
package. However, it requires a sample. So a quick way to do all the
above for the negative binomial without thinking about CDFs, proportions
of &lt;span class=&quot;math inline&quot;&gt;\(R(t)\)&lt;/span&gt; etc. is to just generate a
sample of arbitrary size from the PMF and then plot the decreasing
Lorenz curve.&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb12&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb12-1&quot;&gt;&lt;a href=&quot;#cb12-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;# Sample an articial population so we can use the empirical lorenz curve&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb12-2&quot;&gt;&lt;a href=&quot;#cb12-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;outbreak &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;data.frame&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;secondary_cases=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;rnbinom&lt;/span&gt;(&lt;span class=&quot;dv&quot;&gt;10000&lt;/span&gt;, &lt;span class=&quot;at&quot;&gt;mu=&lt;/span&gt;Rt, &lt;span class=&quot;at&quot;&gt;size=&lt;/span&gt;k))&lt;/span&gt;
&lt;span id=&quot;cb12-3&quot;&gt;&lt;a href=&quot;#cb12-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb12-4&quot;&gt;&lt;a href=&quot;#cb12-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;ggplot&lt;/span&gt;(outbreak, &lt;span class=&quot;fu&quot;&gt;aes&lt;/span&gt;(secondary_cases)) &lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt; gglorenz&lt;span class=&quot;sc&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;stat_lorenz&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;desc=&lt;/span&gt;&lt;span class=&quot;cn&quot;&gt;TRUE&lt;/span&gt;) &lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb12-5&quot;&gt;&lt;a href=&quot;#cb12-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;xlab&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;quot;Proportion of the infectious cases (cases with most secondary cases first)&amp;quot;&lt;/span&gt;) &lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb12-6&quot;&gt;&lt;a href=&quot;#cb12-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;ylab&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;quot;Proportion of the secondary cases&amp;quot;&lt;/span&gt;) &lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb12-7&quot;&gt;&lt;a href=&quot;#cb12-7&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;scale_x_continuous&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;labels=&lt;/span&gt;scales&lt;span class=&quot;sc&quot;&gt;::&lt;/span&gt;percent, &lt;span class=&quot;at&quot;&gt;breaks=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;seq&lt;/span&gt;(&lt;span class=&quot;dv&quot;&gt;0&lt;/span&gt;,&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;,&lt;span class=&quot;at&quot;&gt;length=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;6&lt;/span&gt;)) &lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb12-8&quot;&gt;&lt;a href=&quot;#cb12-8&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;scale_y_continuous&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;labels=&lt;/span&gt;scales&lt;span class=&quot;sc&quot;&gt;::&lt;/span&gt;percent, &lt;span class=&quot;at&quot;&gt;breaks=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;seq&lt;/span&gt;(&lt;span class=&quot;dv&quot;&gt;0&lt;/span&gt;,&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;,&lt;span class=&quot;at&quot;&gt;length=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;6&lt;/span&gt;)) &lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb12-9&quot;&gt;&lt;a href=&quot;#cb12-9&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;geom_line&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;data=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;data.frame&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;x=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;seq&lt;/span&gt;(&lt;span class=&quot;dv&quot;&gt;0&lt;/span&gt;,&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;,&lt;span class=&quot;at&quot;&gt;length=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;100&lt;/span&gt;)) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;mutate&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;y=&lt;/span&gt;x), &lt;span class=&quot;fu&quot;&gt;aes&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;x=&lt;/span&gt;x, &lt;span class=&quot;at&quot;&gt;y=&lt;/span&gt;y), &lt;span class=&quot;at&quot;&gt;lty=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;, &lt;span class=&quot;at&quot;&gt;col=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;gray&amp;quot;&lt;/span&gt;) &lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;ggtitle&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;str_c&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;quot;Scenario: R(t) = &amp;quot;&lt;/span&gt;, Rt, &lt;span class=&quot;st&quot;&gt;&amp;quot;, k = &amp;quot;&lt;/span&gt;, k))&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;img src=&quot;/blog/figure/source/2020-05-31-superspreader/GGLORENZ-1.png&quot; style=&quot;display: block; margin: auto;&quot; /&gt;&lt;/p&gt;
&lt;h3 id=&quot;gini-coefficient&quot;&gt;Gini Coefficient&lt;/h3&gt;
&lt;p&gt;Using the standard formulas to compute the &lt;a
href=&quot;https://en.wikipedia.org/wiki/Gini_coefficient#Discrete_probability_distribution&quot;&gt;Gini
coefficient&lt;/a&gt; for a discrete distribution with support on the
non-negative integers, i.e.  &lt;span class=&quot;math display&quot;&gt;\[
G = \frac{1}{2\mu} \sum_{y=0}^\infty \sum_{z=0}^\infty f(y) f(z) |y-z|,
\]&lt;/span&gt; where &lt;span class=&quot;math inline&quot;&gt;\(f(y)\)&lt;/span&gt;, &lt;span
class=&quot;math inline&quot;&gt;\(y=0,1,\ldots\)&lt;/span&gt; denotes the PMF of the
distribution and &lt;span class=&quot;math inline&quot;&gt;\(\mu=\sum_{y=0}^\infty y
f(y)\)&lt;/span&gt; is the mean of the distribution. In our case &lt;span
class=&quot;math inline&quot;&gt;\(\mu=R(t)\)&lt;/span&gt;. From this we get&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb13&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb13-1&quot;&gt;&lt;a href=&quot;#cb13-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;# Gini index for a discrete probability distribution&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb13-2&quot;&gt;&lt;a href=&quot;#cb13-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;gini_coeff &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;cf&quot;&gt;function&lt;/span&gt;(df) {&lt;/span&gt;
&lt;span id=&quot;cb13-3&quot;&gt;&lt;a href=&quot;#cb13-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  mu &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;sum&lt;/span&gt;(df&lt;span class=&quot;sc&quot;&gt;$&lt;/span&gt;x &lt;span class=&quot;sc&quot;&gt;*&lt;/span&gt; df&lt;span class=&quot;sc&quot;&gt;$&lt;/span&gt;pmf)&lt;/span&gt;
&lt;span id=&quot;cb13-4&quot;&gt;&lt;a href=&quot;#cb13-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  sum &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;dv&quot;&gt;0&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb13-5&quot;&gt;&lt;a href=&quot;#cb13-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;cf&quot;&gt;for&lt;/span&gt; (i &lt;span class=&quot;cf&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;nrow&lt;/span&gt;(df)) {&lt;/span&gt;
&lt;span id=&quot;cb13-6&quot;&gt;&lt;a href=&quot;#cb13-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;cf&quot;&gt;for&lt;/span&gt; (j &lt;span class=&quot;cf&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;nrow&lt;/span&gt;(df)) {&lt;/span&gt;
&lt;span id=&quot;cb13-7&quot;&gt;&lt;a href=&quot;#cb13-7&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;      sum &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; sum &lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt; df&lt;span class=&quot;sc&quot;&gt;$&lt;/span&gt;pmf[i] &lt;span class=&quot;sc&quot;&gt;*&lt;/span&gt; df&lt;span class=&quot;sc&quot;&gt;$&lt;/span&gt;pmf[j] &lt;span class=&quot;sc&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;abs&lt;/span&gt;(df&lt;span class=&quot;sc&quot;&gt;$&lt;/span&gt;x[i] &lt;span class=&quot;sc&quot;&gt;-&lt;/span&gt; df&lt;span class=&quot;sc&quot;&gt;$&lt;/span&gt;x[j])&lt;/span&gt;
&lt;span id=&quot;cb13-8&quot;&gt;&lt;a href=&quot;#cb13-8&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    }&lt;/span&gt;
&lt;span id=&quot;cb13-9&quot;&gt;&lt;a href=&quot;#cb13-9&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  }&lt;/span&gt;
&lt;span id=&quot;cb13-10&quot;&gt;&lt;a href=&quot;#cb13-10&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;return&lt;/span&gt;(sum&lt;span class=&quot;sc&quot;&gt;/&lt;/span&gt;(&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;*&lt;/span&gt;mu))&lt;/span&gt;
&lt;span id=&quot;cb13-11&quot;&gt;&lt;a href=&quot;#cb13-11&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;}&lt;/span&gt;
&lt;span id=&quot;cb13-12&quot;&gt;&lt;a href=&quot;#cb13-12&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb13-13&quot;&gt;&lt;a href=&quot;#cb13-13&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;gini_coeff&lt;/span&gt;(df)  &lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;## [1] 0.704049&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;A plot of the relationship between the dispersion parameter and the
Gini index, given a fixed value of &lt;span
class=&quot;math inline&quot;&gt;\(R(t)=2.5\)&lt;/span&gt;, looks as follows
&lt;img src=&quot;/blog/figure/source/2020-05-31-superspreader/PLOTGINIKRELATIONSHIP-1.png&quot; style=&quot;display: block; margin: auto;&quot; /&gt;&lt;/p&gt;
&lt;p&gt;We see that the Gini index converges from above to the Gini index of
the Poisson distribution with mean &lt;span
class=&quot;math inline&quot;&gt;\(R(t)\)&lt;/span&gt;. In our case this limit is&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb15&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb15-1&quot;&gt;&lt;a href=&quot;#cb15-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;gini_coeff&lt;/span&gt;( &lt;span class=&quot;fu&quot;&gt;data.frame&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;x=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;250&lt;/span&gt;) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;mutate&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;pmf =&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;dpois&lt;/span&gt;(x, &lt;span class=&quot;at&quot;&gt;lambda=&lt;/span&gt;Rt)))&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;## [1] 0.3475131&lt;/code&gt;&lt;/pre&gt;
&lt;h3 id=&quot;red-marble-toy-example&quot;&gt;Red Marble Toy Example&lt;/h3&gt;
&lt;p&gt;For the &lt;a href=&quot;https://youtu.be/fOHB6PtcoMU?t=1259&quot;&gt;toy example
offspring distribution&lt;/a&gt; used by &lt;a
href=&quot;https://twitter.com/c_drosten&quot;&gt;Christian Drosten&lt;/a&gt; in his
Coronavirus Update podcast on COVID-19 superspreading (episode 44, in
German). The described hypothetical scenario is translated to an
offspring distribution, where a primary case either generates 1 (with
probability 9/10) or 10 (with probability 1/10) secondary cases:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb17&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb17-1&quot;&gt;&lt;a href=&quot;#cb17-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;# Offspring distribution&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb17-2&quot;&gt;&lt;a href=&quot;#cb17-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;df_toyoffspring &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;data.frame&lt;/span&gt;( &lt;span class=&quot;at&quot;&gt;x=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;c&lt;/span&gt;(&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;,&lt;span class=&quot;dv&quot;&gt;10&lt;/span&gt;), &lt;span class=&quot;at&quot;&gt;pmf=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;c&lt;/span&gt;(&lt;span class=&quot;dv&quot;&gt;9&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;10&lt;/span&gt;, &lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;10&lt;/span&gt;))&lt;/span&gt;
&lt;span id=&quot;cb17-3&quot;&gt;&lt;a href=&quot;#cb17-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb17-4&quot;&gt;&lt;a href=&quot;#cb17-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;# Hypothetical outbreak with 10000 cases from this offspring distribution&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb17-5&quot;&gt;&lt;a href=&quot;#cb17-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;y_obs &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;sample&lt;/span&gt;(df_toyoffspring&lt;span class=&quot;sc&quot;&gt;$&lt;/span&gt;x, &lt;span class=&quot;at&quot;&gt;size=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;10000&lt;/span&gt;, &lt;span class=&quot;at&quot;&gt;replace=&lt;/span&gt;&lt;span class=&quot;cn&quot;&gt;TRUE&lt;/span&gt;, &lt;span class=&quot;at&quot;&gt;prob=&lt;/span&gt;df_toyoffspring&lt;span class=&quot;sc&quot;&gt;$&lt;/span&gt;pmf)&lt;/span&gt;
&lt;span id=&quot;cb17-6&quot;&gt;&lt;a href=&quot;#cb17-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb17-7&quot;&gt;&lt;a href=&quot;#cb17-7&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;# Fit the negative binomial distribution to the observed offspring distribution&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb17-8&quot;&gt;&lt;a href=&quot;#cb17-8&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;# Note It would be better to fit the PMF directly instead of to the hypothetical&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb17-9&quot;&gt;&lt;a href=&quot;#cb17-9&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;# outbreak data&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb17-10&quot;&gt;&lt;a href=&quot;#cb17-10&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;(fit &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; MASS&lt;span class=&quot;sc&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;fitdistr&lt;/span&gt;(y_obs, &lt;span class=&quot;st&quot;&gt;&amp;quot;negative binomial&amp;quot;&lt;/span&gt;))&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;##       size          mu    
##   1.73380924   1.87481616 
##  (0.03857807) (0.01975387)&lt;/code&gt;&lt;/pre&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb19&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb19-1&quot;&gt;&lt;a href=&quot;#cb19-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;# Note: different parametrisation of the k parameter&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb19-2&quot;&gt;&lt;a href=&quot;#cb19-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;(k.hat &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;/&lt;/span&gt;fit&lt;span class=&quot;sc&quot;&gt;$&lt;/span&gt;estimate[&lt;span class=&quot;st&quot;&gt;&amp;quot;size&amp;quot;&lt;/span&gt;])&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;##      size 
## 0.5767647&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;In other words, when fitting a negative binomial distribution to
these data (probably not a good idea) we get a dispersion parameter of
0.58.
&lt;img src=&quot;/blog/figure/source/2020-05-31-superspreader/PLOTNEGBINTOYPMF-1.png&quot; style=&quot;display: block; margin: auto;&quot; /&gt;
The Gini coefficient of this fitted negative distribution is 0.68. If we
instead compute the Gini coefficient for the distribution directly we
get&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb21&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb21-1&quot;&gt;&lt;a href=&quot;#cb21-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;gini_coeff&lt;/span&gt;(df_toyoffspring) &lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;## [1] 0.4263158&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Altogether, it can be discussed how much gain there is in using more
flexible distributions to model the COVID-19 offspring distribution. The
distribution is likely to center around 0-5, but with some mass above
10+. Too many additional parameters probably do not make sense. However,
one consequnce of assuming negative binomial distributed offspring
distribution is that we accept Poisson-offspring as the minimum lvl of
heterogeneity. This might be theoretically justified, but the Gini index
would allow for a unified reporting of heterogeneity independent of
assumptions about the parametric shape of the offspring distribution. In
the toy example case, a negative binomial distribution was certainly not
an adequate distribution, but of course this is just a toy example.&lt;/p&gt;
&lt;h3 id=&quot;simulation&quot;&gt;Simulation&lt;/h3&gt;
&lt;p&gt;We can use the &lt;code&gt;R0::sim.epid&lt;/code&gt; function to simulate 1000
trajectories of an outbreak with negative binomial offspring
distribution (c.f. &lt;a
href=&quot;https://staff.math.su.se/hoehle/blog/2020/04/15/effectiveR0.html&quot;&gt;effective
reproduction number&lt;/a&gt; post) having mean 2.5 and dispersion parameter
0.45. For ease of exposition we use a constant generation time of 1 day,
start with 1 infectious case at generation time 0, and then simulate the
epidemic for 10 additional generations.&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb23&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb23-1&quot;&gt;&lt;a href=&quot;#cb23-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;# Fixed generation time GT, for simplicity time scale is equal to GT, i.e. GT=1&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb23-2&quot;&gt;&lt;a href=&quot;#cb23-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;gt &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; R0&lt;span class=&quot;sc&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;generation.time&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;type=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;empirical&amp;quot;&lt;/span&gt;, &lt;span class=&quot;at&quot;&gt;val=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;c&lt;/span&gt;(&lt;span class=&quot;dv&quot;&gt;0&lt;/span&gt;,&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;))&lt;/span&gt;
&lt;span id=&quot;cb23-3&quot;&gt;&lt;a href=&quot;#cb23-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb23-4&quot;&gt;&lt;a href=&quot;#cb23-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;# Simulate 10 epidemics, &lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb23-5&quot;&gt;&lt;a href=&quot;#cb23-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;raw_sims &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; R0&lt;span class=&quot;sc&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;sim.epid&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;epid.nb=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;1000&lt;/span&gt;, &lt;span class=&quot;at&quot;&gt;GT=&lt;/span&gt;gt, &lt;span class=&quot;at&quot;&gt;R0=&lt;/span&gt;Rt, &lt;span class=&quot;at&quot;&gt;epid.length=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;10&lt;/span&gt;, &lt;span class=&quot;at&quot;&gt;peak.value=&lt;/span&gt;&lt;span class=&quot;fl&quot;&gt;1e5&lt;/span&gt;, &lt;span class=&quot;at&quot;&gt;family=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;negbin&amp;quot;&lt;/span&gt;, &lt;span class=&quot;at&quot;&gt;negbin.size=&lt;/span&gt;k)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;img src=&quot;/blog/figure/source/2020-05-31-superspreader/PLOTSIMS-1.png&quot; style=&quot;display: block; margin: auto;&quot; /&gt;
Note that the plot uses a log-10 logarithmic y-axis. Furthermore, we see
that 44% of the simulations become extinct in generation 1, because the
initial case does not manage to generate any new cases. This matches the
&lt;span class=&quot;math inline&quot;&gt;\(P(Y_i=0)\)&lt;/span&gt; probability under the
corresponding negative binomial distribution. Furthermore, 59% of the
simulations have a final size of 10 or less cases.&lt;/p&gt;
&lt;h2 id=&quot;discussion&quot;&gt;Discussion&lt;/h2&gt;
&lt;p&gt;The effect of superspreaders underlines the stochastic nature of the
dynamics of an person-to-person transmitted disease in a population. The
dispersion parameter &lt;span class=&quot;math inline&quot;&gt;\(k\)&lt;/span&gt; is
conditional on the assumption of a given parametric model for the
offspring distribution (negative binomial). The Gini index is an
alternative characterisation to measure heterogeneity. However, in both
cases the parameters are to be interpreted together with the expectation
of the distribution. Estimation of the dispersion parameter is
orthogonal to the mean in the negative binomial and its straightforward
to also get confidence intervals for it. This is less straightforward
for the Gini index.&lt;/p&gt;
&lt;p&gt;A heavy tailed offspring distribution can make the disease easier to
control by targeting intervention measures to restrict superspreading
&lt;span class=&quot;citation&quot; data-cites=&quot;lloydsmith_etal2005&quot;&gt;(Lloyd-Smith et
al. 2005)&lt;/span&gt;. The hope is that such interventions are “cheaper” than
interventions which target the entire population of infectious contacts.
However, the success of such a targeted strategy also depends on how
large the contribution of superspreaders really is. Hence, some effort
is needed to quantify the effect of superspreaders. Furthermore, the
above treatment also underlines that heterogeneity can be a helpful
feature to exploit when trying to control a disease. Another aspect of
such heterogeneity, namely its influence on the threshold of herd
immunity, has recently been invested by my colleagues at Stockholm
University &lt;span class=&quot;citation&quot;
data-cites=&quot;britton_etal2020&quot;&gt;(Britton, Ball, and Trapman
2020)&lt;/span&gt;.&lt;/p&gt;
&lt;h2 class=&quot;unnumbered&quot; id=&quot;literature&quot;&gt;Literature&lt;/h2&gt;
&lt;div id=&quot;refs&quot; class=&quot;references csl-bib-body hanging-indent&quot;
data-entry-spacing=&quot;0&quot; role=&quot;list&quot;&gt;
&lt;div id=&quot;ref-adam_etal2020&quot; class=&quot;csl-entry&quot; role=&quot;listitem&quot;&gt;
Adam, DC, P Wu, J Wong, E Lau, T Tsang, S Cauchemez, G Leung, and B
Cowling. 2020. &lt;span&gt;“Clustering and Superspreading Potential of Severe
Acute Respiratory Syndrome Coronavirus 2 (SARS-CoV-2) Infections in Hong
Kong.”&lt;/span&gt; Research Square. &lt;a
href=&quot;https://doi.org/10.21203/rs.3.rs-29548/v1&quot;&gt;https://doi.org/10.21203/rs.3.rs-29548/v1&lt;/a&gt;.
&lt;/div&gt;
&lt;div id=&quot;ref-britton_etal2020&quot; class=&quot;csl-entry&quot; role=&quot;listitem&quot;&gt;
Britton, T, F Ball, and P Trapman. 2020. &lt;span&gt;“The Disease-Induced Herd
Immunity Level for Covid-19 Is Substantially Lower Than the Classical
Herd Immunity Level.”&lt;/span&gt; &lt;a
href=&quot;https://arxiv.org/abs/2005.03085&quot;&gt;https://arxiv.org/abs/2005.03085&lt;/a&gt;.
&lt;/div&gt;
&lt;div id=&quot;ref-endo_etal2020&quot; class=&quot;csl-entry&quot; role=&quot;listitem&quot;&gt;
Endo, A, Centre for the Mathematical Modelling of Infectious Diseases
COVID-19 Working Group, S Abbott, AJ Kucharski, and S Funk. 2020.
&lt;span&gt;“Estimating the Overdispersion in COVID-19 Transmission Using
Outbreak Sizes Outside China [Version 1; Peer Review: 1 Approved, 1
Approved with Reservations].”&lt;/span&gt; Wellcome Open Res. &lt;a
href=&quot;https://doi.org/10.12688/wellcomeopenres.15842.1&quot;&gt;https://doi.org/10.12688/wellcomeopenres.15842.1&lt;/a&gt;.
&lt;/div&gt;
&lt;div id=&quot;ref-lloydsmith_etal2005&quot; class=&quot;csl-entry&quot; role=&quot;listitem&quot;&gt;
Lloyd-Smith, J. O., S. J. Schreiber, P. E. Kopp, and W. M. Getz. 2005.
&lt;span&gt;“Superspreading and the Effect of Individual Variation on Disease
Emergence.”&lt;/span&gt; &lt;em&gt;Nature&lt;/em&gt; 438 (7066): 355–59. &lt;a
href=&quot;https://doi.org/10.1038/nature04153&quot;&gt;https://doi.org/10.1038/nature04153&lt;/a&gt;.
&lt;/div&gt;
&lt;/div&gt;
&lt;section id=&quot;footnotes&quot; class=&quot;footnotes footnotes-end-of-document&quot;
role=&quot;doc-endnotes&quot;&gt;
&lt;hr /&gt;
&lt;ol&gt;
&lt;li id=&quot;fn1&quot;&gt;&lt;p&gt;To be added to the list of characterising quantities
such as doubling time, reproduction number, generation time, serial
interval, …&lt;a href=&quot;#fnref1&quot; class=&quot;footnote-back&quot;
role=&quot;doc-backlink&quot;&gt;↩︎&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;
&lt;li id=&quot;fn2&quot;&gt;&lt;p&gt;&lt;span class=&quot;citation&quot;
data-cites=&quot;lloydsmith_etal2005&quot;&gt;Lloyd-Smith et al. (2005)&lt;/span&gt;
estimated &lt;span class=&quot;math inline&quot;&gt;\(k=0.16\)&lt;/span&gt; for SARS-CoV-1.&lt;a
href=&quot;#fnref2&quot; class=&quot;footnote-back&quot; role=&quot;doc-backlink&quot;&gt;↩︎&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;/section&gt;
</description>
        <pubDate>Sun, 31 May 2020 00:00:00 +0200</pubDate>
        <link>https://mhoehle.github.io/blog/2020/05/31/superspreader.html</link>
        <guid isPermaLink="true">https://mhoehle.github.io/blog/2020/05/31/superspreader.html</guid>
        
        <category>rstats</category>
        
        <category>dataviz</category>
        
        <category>R</category>
        
        <category>COVID-19</category>
        
        <category>SARS-CoV-2</category>
        
        <category>epidemic models</category>
        
        
      </item>
    
      <item>
        <title>Effective reproduction number estimation</title>
        <description>&lt;h2 id=&quot;abstract&quot;&gt;Abstract:&lt;/h2&gt;
&lt;p&gt;We discuss the estimation with R of the time-varying effective
reproduction number during an infectious disease outbreak such as the
COVID-19 outbreak. Using a single simulated outbreak we compare the
performance of three different estimation methods.&lt;/p&gt;
&lt;center&gt;
&lt;img src=&quot;/blog/figure/source/2020-04-15-effectiveR0/EFFECTIVERPLOT-1.png&quot; width=&quot;550&quot;&gt;
&lt;/center&gt;
&lt;p&gt;&lt;br&gt;
&lt;a rel=&quot;license&quot; href=&quot;http://creativecommons.org/licenses/by-sa/4.0/&quot;&gt;&lt;img alt=&quot;Creative Commons License&quot; style=&quot;border-width:0&quot; src=&quot;https://i.creativecommons.org/l/by-sa/4.0/88x31.png&quot;/&gt;&lt;/a&gt;
This work is licensed under a &lt;a rel=&quot;license&quot;
href=&quot;http://creativecommons.org/licenses/by-sa/4.0/&quot;&gt;Creative Commons
Attribution-ShareAlike 4.0 International License&lt;/a&gt;. The
markdown+Rknitr source code of this blog is available under a &lt;a
href=&quot;https://www.gnu.org/licenses/gpl-3.0.html&quot;&gt;GNU General Public
License (GPL v3)&lt;/a&gt; license from github.&lt;/p&gt;
&lt;h2 id=&quot;motivation&quot;&gt;Motivation&lt;/h2&gt;
&lt;p&gt;A key parameter to know for an infectious disease pathogen like
SARS-nCoV-2 is the &lt;a
href=&quot;https://en.wikipedia.org/wiki/Basic_reproduction_number&quot;&gt;&lt;strong&gt;basic
reproduction number&lt;/strong&gt;&lt;/a&gt;, i.e. the expected number of secondary
cases per primary case in a completely susceptible population. This
quantity and its relation to the susceptible-infectious-recovered (SIR)
model was explained in the previous &lt;a
href=&quot;https://staff.math.su.se/hoehle/blog/2020/03/16/flatteningthecurve.html&quot;&gt;Flatten
the COVID-19 curve&lt;/a&gt; post. However, as intervention measures are put
in place and as a certain proportion of the population gains immunity,
interest switches to knowing the time-varying &lt;strong&gt;effective
reproduction number&lt;/strong&gt;. This quantity is defined as follows:
Consider an individual, who turns infectious on day &lt;span
class=&quot;math inline&quot;&gt;\(t\)&lt;/span&gt;. We denote by &lt;span
class=&quot;math inline&quot;&gt;\(R_e(t)\)&lt;/span&gt; the expected number of secondary
cases this infectious individual causes. For simplicity we will assume
that the timing of being able to infect others and the time of being
able to detect this infectivity (e.g. by symptoms or by a test)
coincides, i.e. on day &lt;span class=&quot;math inline&quot;&gt;\(t\)&lt;/span&gt; the above
individual will also appear in the incidence time series. The time
between symptom onset in the primary case and symptom onset in the
secondary case is called the &lt;a
href=&quot;https://en.wikipedia.org/wiki/Serial_interval&quot;&gt;&lt;strong&gt;serial
interval&lt;/strong&gt;&lt;/a&gt;. The distribution from which the observed serial
intervals origin is called the serial interval distribution. Note that
this is different from the &lt;strong&gt;generation time&lt;/strong&gt;, which is
the time period between exposure of the primary case and exposure of the
secondary case. However, since time of exposure is rarely observable,
one instead has to use the time series of incident symptom onsets as
basis for inference - see also &lt;span class=&quot;citation&quot;
data-cites=&quot;svensson2007&quot;&gt;Svensson (2007)&lt;/span&gt; for a thorough
discussion of the distinction between the generation time and the serial
interval. For the sake of simplicity, but slightly against the reality
of SARS-nCoV-2, the remainder of this post will not distinguish between
the generation time and the serial interval and will also assume that
the serial interval is always positive.&lt;/p&gt;
&lt;p&gt;The motivation of this blog post is now to show how to estimate the
time-varying effective reproduction number &lt;span
class=&quot;math inline&quot;&gt;\(R_e(t)\)&lt;/span&gt; using R - in particular the R
package &lt;a
href=&quot;https://cran.r-project.org/web/packages/R0/index.html&quot;&gt;&lt;code&gt;R0&lt;/code&gt;&lt;/a&gt;
&lt;span class=&quot;citation&quot; data-cites=&quot;obadia_etal2012&quot;&gt;(Obadia, Haneef, and
Boëlle 2012)&lt;/span&gt;. The R code of this post is available from &lt;a
href=&quot;https://raw.githubusercontent.com/hoehleatsu/hoehleatsu.github.io/master/_source/2020-04-15-effectiveR0.Rmd&quot;&gt;github&lt;/a&gt;.
We shall consider three estimators from the literature. One of the
estimators is used by the German Robert-Koch Institute (RKI). Since &lt;a
href=&quot;https://www.rki.de/DE/Content/InfAZ/N/Neuartiges_Coronavirus/Situationsberichte/2020-04-07-en.pdf?__blob=publicationFile&quot;&gt;8th
of April 2020&lt;/a&gt; the estimate is reported as part of their &lt;a
href=&quot;https://www.rki.de/DE/Content/InfAZ/N/Neuartiges_Coronavirus/Situationsberichte/Gesamt.html&quot;&gt;daily
COVID-19 situational reports&lt;/a&gt; and is thus discussed by major German
news media (e.g. &lt;a
href=&quot;https://www.tagesschau.de/inland/corona-rki-positivtrend-101.html&quot;&gt;ARD&lt;/a&gt;).&lt;/p&gt;
&lt;h2 id=&quot;outbreak-simulation&quot;&gt;Outbreak simulation&lt;/h2&gt;
&lt;p&gt;We consider a simple growth model and denote by &lt;span
class=&quot;math inline&quot;&gt;\(y_t\)&lt;/span&gt; the expected number of new symptom
onsets we observe on day &lt;span class=&quot;math inline&quot;&gt;\(t\)&lt;/span&gt;. Let
&lt;span class=&quot;math inline&quot;&gt;\((g_1, \ldots, g_M)&amp;#39;\)&lt;/span&gt;, denote the
probability mass function of the serial interval distribution,
i.e. &lt;span class=&quot;math inline&quot;&gt;\(P(GT=i) = g_i\)&lt;/span&gt; for &lt;span
class=&quot;math inline&quot;&gt;\(i=1,2,\ldots, M\)&lt;/span&gt; . The development in the
expected number of cases can be described by the homogeneous linear
difference equation &lt;span class=&quot;math display&quot;&gt;\[
\begin{align*}
y_t =  R_e(t-1) g_1 y_{t-1} + \ldots + R_e(t-M) g_M y_{t-M} =
\sum_{i=1}^M R_e(t-i) g_i y_{t-i},
\end{align*}
\]&lt;/span&gt; where &lt;span class=&quot;math inline&quot;&gt;\(t=2, 3, \ldots\)&lt;/span&gt; and
where we on the RHS ignore terms when &lt;span class=&quot;math inline&quot;&gt;\(t-M
\leq 0\)&lt;/span&gt;. Furthermore, we fix &lt;span
class=&quot;math inline&quot;&gt;\(y_1=1\)&lt;/span&gt; and conceptually denote by &lt;span
class=&quot;math inline&quot;&gt;\(t=1\)&lt;/span&gt; the 15th of February 2020 in calendar
time. To simulate a COVID-19 like outbreak with lockdown type
intervention we use &lt;span class=&quot;math display&quot;&gt;\[
\begin{align*}
R_e(t) = \left\{
\begin{array}{}
2.5 &amp;amp; \text{if } t \leq \text{2020-03-15} \\
0.95 &amp;amp; \text{otherwise}
\end{array}
\right.
\end{align*}
\]&lt;/span&gt;&lt;/p&gt;
&lt;h3 id=&quot;serial-interval-distribution&quot;&gt;Serial Interval Distribution&lt;/h3&gt;
&lt;p&gt;In what follows we shall use a simple discrete serial interval
distribution with support on the values 1-7 days. Such a distribution
can easily be stated as&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb1&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb1-1&quot;&gt;&lt;a href=&quot;#cb1-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;GT_pmf &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;structure&lt;/span&gt;( &lt;span class=&quot;fu&quot;&gt;c&lt;/span&gt;(&lt;span class=&quot;dv&quot;&gt;0&lt;/span&gt;, &lt;span class=&quot;fl&quot;&gt;0.1&lt;/span&gt;, &lt;span class=&quot;fl&quot;&gt;0.1&lt;/span&gt;, &lt;span class=&quot;fl&quot;&gt;0.2&lt;/span&gt;, &lt;span class=&quot;fl&quot;&gt;0.2&lt;/span&gt;, &lt;span class=&quot;fl&quot;&gt;0.2&lt;/span&gt;, &lt;span class=&quot;fl&quot;&gt;0.1&lt;/span&gt;, &lt;span class=&quot;fl&quot;&gt;0.1&lt;/span&gt;), &lt;span class=&quot;at&quot;&gt;names=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;7&lt;/span&gt;)&lt;/span&gt;
&lt;span id=&quot;cb1-2&quot;&gt;&lt;a href=&quot;#cb1-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;GT_obj &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; R0&lt;span class=&quot;sc&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;generation.time&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;quot;empirical&amp;quot;&lt;/span&gt;, &lt;span class=&quot;at&quot;&gt;val=&lt;/span&gt;GT_pmf)&lt;/span&gt;
&lt;span id=&quot;cb1-3&quot;&gt;&lt;a href=&quot;#cb1-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;GT_obj&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;## Discretized Generation Time distribution
## mean: 4 , sd: 1.732051 
##   0   1   2   3   4   5   6   7 
## 0.0 0.1 0.1 0.2 0.2 0.2 0.1 0.1&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Note that the selected PMF of the serial interval has mean 4.00 and
is symmetric around its mean.&lt;/p&gt;
&lt;h3 id=&quot;outbreak-simulation-1&quot;&gt;Outbreak simulation&lt;/h3&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb3&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb3-1&quot;&gt;&lt;a href=&quot;#cb3-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;# Define time varying effective reproduction number&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb3-2&quot;&gt;&lt;a href=&quot;#cb3-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;Ret &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;cf&quot;&gt;function&lt;/span&gt;(date) &lt;span class=&quot;fu&quot;&gt;ifelse&lt;/span&gt;(date &lt;span class=&quot;sc&quot;&gt;&amp;lt;=&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;as.Date&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;quot;2020-03-15&amp;quot;&lt;/span&gt;), &lt;span class=&quot;fl&quot;&gt;2.5&lt;/span&gt;, &lt;span class=&quot;fl&quot;&gt;0.95&lt;/span&gt;)&lt;/span&gt;
&lt;span id=&quot;cb3-3&quot;&gt;&lt;a href=&quot;#cb3-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb3-4&quot;&gt;&lt;a href=&quot;#cb3-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;# Generate an outbreak (no stochasticity, just the difference equation)&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb3-5&quot;&gt;&lt;a href=&quot;#cb3-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;out &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;routbreak&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;n=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;60&lt;/span&gt;, &lt;span class=&quot;at&quot;&gt;Ret=&lt;/span&gt;Ret, &lt;span class=&quot;at&quot;&gt;GT_obj=&lt;/span&gt;GT_obj)&lt;/span&gt;
&lt;span id=&quot;cb3-6&quot;&gt;&lt;a href=&quot;#cb3-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;out &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; out &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;mutate&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;ratio =&lt;/span&gt; y&lt;span class=&quot;sc&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;lag&lt;/span&gt;(y))&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;We simulate an outbreak using the above difference equation for the
selected serial interval distribution starting with one initial case on
2020-02-15. The daily incidence curve of the simulated outbreak looks as
follows:&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/blog/figure/source/2020-04-15-effectiveR0/THEOUTBREAK-1.png&quot; style=&quot;display: block; margin: auto;&quot; /&gt;&lt;/p&gt;
&lt;p&gt;For better visualisation the right hand panel shows a plot of &lt;span
class=&quot;math inline&quot;&gt;\(q_t = y_{t}/y_{t-1}\)&lt;/span&gt;. One interesting
question is how &lt;span class=&quot;math inline&quot;&gt;\(q_t\)&lt;/span&gt; is related to
&lt;span class=&quot;math inline&quot;&gt;\(R_e(t)\)&lt;/span&gt;.&lt;/p&gt;
&lt;h2 id=&quot;wallinga-and-teunis-2004&quot;&gt;Wallinga and Teunis (2004)&lt;/h2&gt;
&lt;p&gt;The method of &lt;span class=&quot;citation&quot;
data-cites=&quot;wallinga_teunis2004&quot;&gt;Wallinga and Teunis (2004)&lt;/span&gt;
developed as part of the 2003 SARS outbreak is available as function
&lt;code&gt;R0::est.R0.TD&lt;/code&gt;. It uses a statistical procedure based on the
relative likelihood for two cases &lt;span class=&quot;math inline&quot;&gt;\(i\)&lt;/span&gt;
and &lt;span class=&quot;math inline&quot;&gt;\(j\)&lt;/span&gt; with symptom onset at times
&lt;span class=&quot;math inline&quot;&gt;\(t_i &amp;gt; t_j\)&lt;/span&gt; to be a possible
infector-infectee pair. Further methodological details of the method can
be found in the paper.&lt;/p&gt;
&lt;p&gt;In code:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb4&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb4-1&quot;&gt;&lt;a href=&quot;#cb4-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;est_rt_wt &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;cf&quot;&gt;function&lt;/span&gt;(ts, GT_obj) {&lt;/span&gt;
&lt;span id=&quot;cb4-2&quot;&gt;&lt;a href=&quot;#cb4-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  end &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;length&lt;/span&gt;(ts) &lt;span class=&quot;sc&quot;&gt;-&lt;/span&gt; (&lt;span class=&quot;fu&quot;&gt;length&lt;/span&gt;(GT_obj&lt;span class=&quot;sc&quot;&gt;$&lt;/span&gt;GT)&lt;span class=&quot;sc&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;)&lt;/span&gt;
&lt;span id=&quot;cb4-3&quot;&gt;&lt;a href=&quot;#cb4-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  R0&lt;span class=&quot;sc&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;est.R0.TD&lt;/span&gt;(ts, &lt;span class=&quot;at&quot;&gt;GT=&lt;/span&gt;GT_obj, &lt;span class=&quot;at&quot;&gt;begin=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;, &lt;span class=&quot;at&quot;&gt;end=&lt;/span&gt;end, &lt;span class=&quot;at&quot;&gt;nsim=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;1000&lt;/span&gt;)&lt;/span&gt;
&lt;span id=&quot;cb4-4&quot;&gt;&lt;a href=&quot;#cb4-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3 id=&quot;wallinga-and-lipsitch-2006&quot;&gt;Wallinga and Lipsitch (2006)&lt;/h3&gt;
&lt;p&gt;&lt;span class=&quot;citation&quot; data-cites=&quot;wallinga_lipsitch2006&quot;&gt;Wallinga
and Lipsitch (2006)&lt;/span&gt; discuss the connection between the generation
time distribution and the reproduction number. They derive the important
relationship that &lt;span class=&quot;math inline&quot;&gt;\(R = 1/M(-r)\)&lt;/span&gt;,
where &lt;span class=&quot;math inline&quot;&gt;\(r\)&lt;/span&gt; is the per-capita
growth-rate of the epidemic and &lt;span
class=&quot;math inline&quot;&gt;\(M(\cdot)\)&lt;/span&gt; is the &lt;a
href=&quot;https://en.wikipedia.org/wiki/Moment-generating_function&quot;&gt;moment
generating function&lt;/a&gt; of the generation time distribution. As an
example, if the generation time distribution is a point-mass
distribution with all mass at the value &lt;span
class=&quot;math inline&quot;&gt;\(G\)&lt;/span&gt; then &lt;span class=&quot;math inline&quot;&gt;\(M(u) =
\exp(u G)\)&lt;/span&gt;. Two possible estimators for &lt;span
class=&quot;math inline&quot;&gt;\(R\)&lt;/span&gt; in dependence of the generation time
would be: &lt;span class=&quot;math display&quot;&gt;\[
\begin{align*}
R &amp;amp;= \exp(r \cdot G) &amp;amp; \text{(generation time is a point mass at
G)}\\
R &amp;amp;= \left[\sum_{k=1}^\infty \exp(-r \cdot k) \cdot g_k\right]^{-1}
&amp;amp; \text{(discrete generation time with PMF } g_1,g_2,\ldots)
\end{align*}
\]&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;A simple way to make the above an effective reproduction number
estimate is to use a sliding window of half-size &lt;span
class=&quot;math inline&quot;&gt;\(w\)&lt;/span&gt; centered around time &lt;span
class=&quot;math inline&quot;&gt;\(t\)&lt;/span&gt; in order to estimate the growth rate
parameter &lt;span class=&quot;math inline&quot;&gt;\(r\)&lt;/span&gt;. For example using a
Poisson GLM model of the kind &lt;span class=&quot;math display&quot;&gt;\[
\begin{align*}
y_s  &amp;amp;\sim \operatorname{Po}(\lambda_s), \text{ with }\\
\log(\lambda_s) &amp;amp;= a + r s,
\end{align*}
\]&lt;/span&gt; where &lt;span class=&quot;math inline&quot;&gt;\(s=t-w,\ldots, t+w\)&lt;/span&gt;.
An estimator for &lt;span class=&quot;math inline&quot;&gt;\(r\)&lt;/span&gt; is then easily
extracted together with a confidence interval using a &lt;code&gt;glm&lt;/code&gt;
approach. In code:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb5&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb5-1&quot;&gt;&lt;a href=&quot;#cb5-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;#&amp;#39; Window limited exponential growth rate estimator as in &lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb5-2&quot;&gt;&lt;a href=&quot;#cb5-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;#&amp;#39; Wallinga &amp;amp; Lipsitch (2007). &lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb5-3&quot;&gt;&lt;a href=&quot;#cb5-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;#&amp;#39;&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb5-4&quot;&gt;&lt;a href=&quot;#cb5-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;#&amp;#39; @param ts Time series of incident counts per time interval&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb5-5&quot;&gt;&lt;a href=&quot;#cb5-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;#&amp;#39; @param GT_obj PMF of the generation time R0.GT object &lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb5-6&quot;&gt;&lt;a href=&quot;#cb5-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;#&amp;#39; @param half_window_width Integer denoting the half-window width&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb5-7&quot;&gt;&lt;a href=&quot;#cb5-7&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb5-8&quot;&gt;&lt;a href=&quot;#cb5-8&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;est_rt_exp &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;cf&quot;&gt;function&lt;/span&gt;(ts, GT_obj, &lt;span class=&quot;at&quot;&gt;half_window_width=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;dt&quot;&gt;L&lt;/span&gt;) {&lt;/span&gt;
&lt;span id=&quot;cb5-9&quot;&gt;&lt;a href=&quot;#cb5-9&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;co&quot;&gt;# Loop over all time points where the sliding window fits in&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb5-10&quot;&gt;&lt;a href=&quot;#cb5-10&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  res &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;sapply&lt;/span&gt;((half_window_width&lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;)&lt;span class=&quot;sc&quot;&gt;:&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;length&lt;/span&gt;(ts)&lt;span class=&quot;sc&quot;&gt;-&lt;/span&gt;half_window_width), &lt;span class=&quot;cf&quot;&gt;function&lt;/span&gt;(t) {&lt;/span&gt;
&lt;span id=&quot;cb5-11&quot;&gt;&lt;a href=&quot;#cb5-11&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;co&quot;&gt;# Define the sliding window&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb5-12&quot;&gt;&lt;a href=&quot;#cb5-12&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    idx &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; (t&lt;span class=&quot;sc&quot;&gt;-&lt;/span&gt;half_window_width)&lt;span class=&quot;sc&quot;&gt;:&lt;/span&gt;(t&lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt;half_window_width)&lt;/span&gt;
&lt;span id=&quot;cb5-13&quot;&gt;&lt;a href=&quot;#cb5-13&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    data &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;data.frame&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;Date=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;length&lt;/span&gt;(ts), &lt;span class=&quot;at&quot;&gt;y=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;as.numeric&lt;/span&gt;(ts))&lt;/span&gt;
&lt;span id=&quot;cb5-14&quot;&gt;&lt;a href=&quot;#cb5-14&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;co&quot;&gt;# Fit a Poisson GLM&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb5-15&quot;&gt;&lt;a href=&quot;#cb5-15&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    m &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;glm&lt;/span&gt;( y &lt;span class=&quot;sc&quot;&gt;~&lt;/span&gt; &lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt; Date, &lt;span class=&quot;at&quot;&gt;family=&lt;/span&gt;poisson, &lt;span class=&quot;at&quot;&gt;data=&lt;/span&gt; data  &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;slice&lt;/span&gt;(idx))&lt;/span&gt;
&lt;span id=&quot;cb5-16&quot;&gt;&lt;a href=&quot;#cb5-16&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;co&quot;&gt;# Extract the growth rate &lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb5-17&quot;&gt;&lt;a href=&quot;#cb5-17&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    r &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;as.numeric&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;coef&lt;/span&gt;(m)[&lt;span class=&quot;st&quot;&gt;&amp;quot;Date&amp;quot;&lt;/span&gt;])&lt;/span&gt;
&lt;span id=&quot;cb5-18&quot;&gt;&lt;a href=&quot;#cb5-18&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;/span&gt;
&lt;span id=&quot;cb5-19&quot;&gt;&lt;a href=&quot;#cb5-19&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;co&quot;&gt;# Equation 2.9 from Wallinga &amp;amp; Lipsitch&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb5-20&quot;&gt;&lt;a href=&quot;#cb5-20&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    R &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;R.from.r&lt;/span&gt;(r, GT_obj)&lt;/span&gt;
&lt;span id=&quot;cb5-21&quot;&gt;&lt;a href=&quot;#cb5-21&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;fu&quot;&gt;return&lt;/span&gt;(R)&lt;/span&gt;
&lt;span id=&quot;cb5-22&quot;&gt;&lt;a href=&quot;#cb5-22&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  })&lt;/span&gt;
&lt;span id=&quot;cb5-23&quot;&gt;&lt;a href=&quot;#cb5-23&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;names&lt;/span&gt;(res) &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;names&lt;/span&gt;(ts)[(half_window_width&lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;)&lt;span class=&quot;sc&quot;&gt;:&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;length&lt;/span&gt;(ts)&lt;span class=&quot;sc&quot;&gt;-&lt;/span&gt;half_window_width)]&lt;/span&gt;
&lt;span id=&quot;cb5-24&quot;&gt;&lt;a href=&quot;#cb5-24&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;return&lt;/span&gt;(res)&lt;/span&gt;
&lt;span id=&quot;cb5-25&quot;&gt;&lt;a href=&quot;#cb5-25&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3 id=&quot;rki-method&quot;&gt;RKI Method&lt;/h3&gt;
&lt;p&gt;In a recent &lt;a
href=&quot;https://www.rki.de/DE/Content/Infekt/EpidBull/Archiv/2020/Ausgaben/17_20_SARS-CoV2_vorab.pdf?__blob=publicationFile&quot;&gt;report&lt;/a&gt;
&lt;span class=&quot;citation&quot; data-cites=&quot;anderheiden_hamouda2020&quot;&gt;(an der
Heiden and Hamouda 2020)&lt;/span&gt;&lt;a href=&quot;#fn1&quot; class=&quot;footnote-ref&quot;
id=&quot;fnref1&quot; role=&quot;doc-noteref&quot;&gt;&lt;sup&gt;1&lt;/sup&gt;&lt;/a&gt; the RKI described their
method for computing &lt;span class=&quot;math inline&quot;&gt;\(R_e(t)\)&lt;/span&gt; as part
of the COVID-19 outbreak as follows (p. 13): &lt;em&gt;For a constant
generation time of 4 days, one obtains &lt;span
class=&quot;math inline&quot;&gt;\(R\)&lt;/span&gt; as the ratio of new infections in two
consecutive time periods each consisting of 4 days&lt;/em&gt;. Mathematically,
this estimation could be formulated as part of a statistical model:
&lt;span class=&quot;math display&quot;&gt;\[
\begin{align*}
y_{s+4} \&amp;gt;| \&amp;gt; y_s &amp;amp;\sim \operatorname{Po}(R \cdot y_s), \quad
s=1,2,3,4.
\end{align*}
\]&lt;/span&gt; where &lt;span class=&quot;math inline&quot;&gt;\(y_1,\ldots, y_4\)&lt;/span&gt; are
considered as fixed. From this we obtain &lt;span
class=&quot;math inline&quot;&gt;\(\hat{R}_{RKI}=\sum_{s=1}^4 y_{s+4} / \sum_{s=1}^4
y_{s}\)&lt;/span&gt;. If we use a GLM to fit the model, we not only get &lt;span
class=&quot;math inline&quot;&gt;\(\hat{R}\)&lt;/span&gt; but also a confidence interval
for &lt;span class=&quot;math inline&quot;&gt;\(R\)&lt;/span&gt; out-of-the box. Somewhat
arbitrary, we denote by &lt;span class=&quot;math inline&quot;&gt;\(R_e(t)\)&lt;/span&gt; the
above estimate for &lt;span class=&quot;math inline&quot;&gt;\(R\)&lt;/span&gt; when &lt;span
class=&quot;math inline&quot;&gt;\(s=1\)&lt;/span&gt; corresponds to time &lt;span
class=&quot;math inline&quot;&gt;\(t-8\)&lt;/span&gt;, i.e. we assign the obtained value to
the last of the 8 values used in the computation.&lt;/p&gt;
&lt;p&gt;In code:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb6&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb6-1&quot;&gt;&lt;a href=&quot;#cb6-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;#&amp;#39; RKI R_e(t) estimator with generation time GT (default GT=4). Note: The time t&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb6-2&quot;&gt;&lt;a href=&quot;#cb6-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;#&amp;#39; is assigned to the last day in the blocks of cases on [t,t+1,t+2, t+3] vs.&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb6-3&quot;&gt;&lt;a href=&quot;#cb6-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;#&amp;#39; [t+4,t+5,t+6, t+7], i.e. s=t-8 (c.f. p. 14 of 2020-04-24 version of the RKI paper)&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb6-4&quot;&gt;&lt;a href=&quot;#cb6-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;#&amp;#39; @param ts - Vector of integer values containing the time series of incident cases&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb6-5&quot;&gt;&lt;a href=&quot;#cb6-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;#&amp;#39; @param GT - PMF of the generation time is a fixed point mass at the value GT.&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb6-6&quot;&gt;&lt;a href=&quot;#cb6-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb6-7&quot;&gt;&lt;a href=&quot;#cb6-7&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;est_rt_rki_last &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;cf&quot;&gt;function&lt;/span&gt;(ts, &lt;span class=&quot;at&quot;&gt;GT=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;dt&quot;&gt;L&lt;/span&gt;) {&lt;/span&gt;
&lt;span id=&quot;cb6-8&quot;&gt;&lt;a href=&quot;#cb6-8&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;co&quot;&gt;# Sanity check&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb6-9&quot;&gt;&lt;a href=&quot;#cb6-9&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;cf&quot;&gt;if&lt;/span&gt; (&lt;span class=&quot;sc&quot;&gt;!&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;is.integer&lt;/span&gt;(GT) &lt;span class=&quot;sc&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;sc&quot;&gt;!&lt;/span&gt;(GT&lt;span class=&quot;sc&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;0&lt;/span&gt;)) &lt;span class=&quot;fu&quot;&gt;stop&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;quot;GT has to be postive integer.&amp;quot;&lt;/span&gt;)&lt;/span&gt;
&lt;span id=&quot;cb6-10&quot;&gt;&lt;a href=&quot;#cb6-10&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;co&quot;&gt;# Estimate, if s=1 is t-7&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb6-11&quot;&gt;&lt;a href=&quot;#cb6-11&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  res &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;sapply&lt;/span&gt;( (&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;*&lt;/span&gt;GT)&lt;span class=&quot;sc&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;length&lt;/span&gt;(ts), &lt;span class=&quot;cf&quot;&gt;function&lt;/span&gt;(t) {&lt;/span&gt;
&lt;span id=&quot;cb6-12&quot;&gt;&lt;a href=&quot;#cb6-12&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;fu&quot;&gt;sum&lt;/span&gt;(ts[t&lt;span class=&quot;sc&quot;&gt;-&lt;/span&gt;(&lt;span class=&quot;dv&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;:&lt;/span&gt;(GT&lt;span class=&quot;dv&quot;&gt;-1&lt;/span&gt;))]) &lt;span class=&quot;sc&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;sum&lt;/span&gt;(ts[t&lt;span class=&quot;dv&quot;&gt;-2&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;*&lt;/span&gt;GT&lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;:&lt;/span&gt;GT])&lt;/span&gt;
&lt;span id=&quot;cb6-13&quot;&gt;&lt;a href=&quot;#cb6-13&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  })&lt;/span&gt;
&lt;span id=&quot;cb6-14&quot;&gt;&lt;a href=&quot;#cb6-14&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;names&lt;/span&gt;(res) &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;names&lt;/span&gt;(ts)[(&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;*&lt;/span&gt;GT)&lt;span class=&quot;sc&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;length&lt;/span&gt;(ts)]&lt;/span&gt;
&lt;span id=&quot;cb6-15&quot;&gt;&lt;a href=&quot;#cb6-15&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;return&lt;/span&gt;(res)&lt;/span&gt;
&lt;span id=&quot;cb6-16&quot;&gt;&lt;a href=&quot;#cb6-16&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Basically, the method appears to be the &lt;span class=&quot;citation&quot;
data-cites=&quot;wallinga_lipsitch2006&quot;&gt;Wallinga and Lipsitch (2006)&lt;/span&gt;
approach using a point mass generation time distribution, but with a
slightly different timing of the sliding windows. However, since no
references were given in the RKI publication, I got curious: what
happens for this approach when the generation time distribution is not a
point mass at &lt;span class=&quot;math inline&quot;&gt;\(G\)&lt;/span&gt;? What happens if
the mean generation time is not an integer? That these are not purely
hypothetical question is underlined by the fact that &lt;span
class=&quot;citation&quot;
data-cites=&quot;nishiura_serial_2020&quot;&gt;(&lt;strong&gt;nishiura_serial_2020?&lt;/strong&gt;)&lt;/span&gt;
find a serial interval distribution with mean 4.7 days and standard
deviation 2.9 as the most suitable fit to data from 28 COVID-19
infector-infectee pairs. Such a serial interval distribution has the
following shape:
&lt;img src=&quot;/blog/figure/source/2020-04-15-effectiveR0/SIDISTPLOT-1.png&quot; style=&quot;display: block; margin: auto;&quot; /&gt;&lt;/p&gt;
&lt;h3 id=&quot;the-comparison&quot;&gt;The Comparison&lt;/h3&gt;
&lt;p&gt;The aim of this post is thus to compare the performance of the RKI
estimator with both the &lt;span class=&quot;citation&quot;
data-cites=&quot;wallinga_teunis2004&quot;&gt;Wallinga and Teunis (2004)&lt;/span&gt; and
the &lt;span class=&quot;citation&quot; data-cites=&quot;wallinga_lipsitch2006&quot;&gt;Wallinga
and Lipsitch (2006)&lt;/span&gt; estimators for the single outbreak simulated
in this post. Results do, however, generalize to other
configurations.&lt;/p&gt;
&lt;p&gt;We compute and plot of the &lt;span
class=&quot;math inline&quot;&gt;\(R_e(t)\)&lt;/span&gt; estimates:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb7&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb7-1&quot;&gt;&lt;a href=&quot;#cb7-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;# RKI method as specified in 2020-04-24 version of the article&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb7-2&quot;&gt;&lt;a href=&quot;#cb7-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;rt_rki_last &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;est_rt_rki_last&lt;/span&gt;(out&lt;span class=&quot;sc&quot;&gt;$&lt;/span&gt;y  &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;setNames&lt;/span&gt;(out&lt;span class=&quot;sc&quot;&gt;$&lt;/span&gt;Date), &lt;span class=&quot;at&quot;&gt;GT=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;dt&quot;&gt;L&lt;/span&gt;)&lt;/span&gt;
&lt;span id=&quot;cb7-3&quot;&gt;&lt;a href=&quot;#cb7-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb7-4&quot;&gt;&lt;a href=&quot;#cb7-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;# Exponential growth with discrete Laplace transform of a GT \equiv = 4 distribution&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb7-5&quot;&gt;&lt;a href=&quot;#cb7-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;rt_exp2 &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;est_rt_exp&lt;/span&gt;( out&lt;span class=&quot;sc&quot;&gt;$&lt;/span&gt;y &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;setNames&lt;/span&gt;(out&lt;span class=&quot;sc&quot;&gt;$&lt;/span&gt;Date), &lt;span class=&quot;at&quot;&gt;GT_obj=&lt;/span&gt;R0&lt;span class=&quot;sc&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;generation.time&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;quot;empirical&amp;quot;&lt;/span&gt;, &lt;span class=&quot;fu&quot;&gt;c&lt;/span&gt;(&lt;span class=&quot;dv&quot;&gt;0&lt;/span&gt;,&lt;span class=&quot;dv&quot;&gt;0&lt;/span&gt;,&lt;span class=&quot;dv&quot;&gt;0&lt;/span&gt;,&lt;span class=&quot;dv&quot;&gt;0&lt;/span&gt;,&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;,&lt;span class=&quot;dv&quot;&gt;0&lt;/span&gt;,&lt;span class=&quot;dv&quot;&gt;0&lt;/span&gt;,&lt;span class=&quot;dv&quot;&gt;0&lt;/span&gt;)), &lt;span class=&quot;at&quot;&gt;half_window_width=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;3&lt;/span&gt;)&lt;/span&gt;
&lt;span id=&quot;cb7-6&quot;&gt;&lt;a href=&quot;#cb7-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb7-7&quot;&gt;&lt;a href=&quot;#cb7-7&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;# Exponential growth with discrete Laplace transform of the correct GT distribution&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb7-8&quot;&gt;&lt;a href=&quot;#cb7-8&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;rt_exp &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;est_rt_exp&lt;/span&gt;( out&lt;span class=&quot;sc&quot;&gt;$&lt;/span&gt;y &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;setNames&lt;/span&gt;(out&lt;span class=&quot;sc&quot;&gt;$&lt;/span&gt;Date), &lt;span class=&quot;at&quot;&gt;GT_obj=&lt;/span&gt;GT_obj, &lt;span class=&quot;at&quot;&gt;half_window_width=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;3&lt;/span&gt;)&lt;/span&gt;
&lt;span id=&quot;cb7-9&quot;&gt;&lt;a href=&quot;#cb7-9&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb7-10&quot;&gt;&lt;a href=&quot;#cb7-10&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;# Wallinga Teunis approach with correct GT distribution&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb7-11&quot;&gt;&lt;a href=&quot;#cb7-11&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;rt_wt &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;est_rt_wt&lt;/span&gt;( out&lt;span class=&quot;sc&quot;&gt;$&lt;/span&gt;y, &lt;span class=&quot;at&quot;&gt;GT=&lt;/span&gt;GT_obj)&lt;/span&gt;
&lt;span id=&quot;cb7-12&quot;&gt;&lt;a href=&quot;#cb7-12&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb7-13&quot;&gt;&lt;a href=&quot;#cb7-13&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;# Data frame with the true values&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb7-14&quot;&gt;&lt;a href=&quot;#cb7-14&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;Ret_true &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;data.frame&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;Date=&lt;/span&gt;out&lt;span class=&quot;sc&quot;&gt;$&lt;/span&gt;Date) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;mutate&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;R_hat=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;Ret&lt;/span&gt;(Date), &lt;span class=&quot;at&quot;&gt;Method=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;Truth&amp;quot;&lt;/span&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;img src=&quot;/blog/figure/source/2020-04-15-effectiveR0/EFFECTIVERPLOT-1.png&quot; style=&quot;display: block; margin: auto;&quot; /&gt;
The shaded area indicates the pointwise confidence intervals of the
&lt;span class=&quot;citation&quot; data-cites=&quot;wallinga_teunis2004&quot;&gt;Wallinga and
Teunis (2004)&lt;/span&gt; method. To make the results of the graph more
explicit, we take a look at 3 time points in the beginning of the
outbreak:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;##         Date W &amp;amp; T, correct GT RKI, GT=4 Truth Exp-G, correct GT
## 1 2020-03-11          2.418862  2.748119   2.5          2.499998
## 2 2020-03-12          2.303251  2.748070   2.5          2.500003
## 3 2020-03-13          2.140055  2.748073   2.5          2.500000&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;and 3 time points at the end of the outbreak:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;##         Date W &amp;amp; T, correct GT RKI, GT=4 Truth Exp-G, correct GT
## 1 2020-04-05              0.95 0.9499707  0.95         0.9502002
## 2 2020-04-06              0.95 0.9500350  0.95         0.9501288
## 3 2020-04-07              0.95 0.9499612  0.95         0.9500405&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;One observes that the RKI method has a bias in this situation. To
some extent this is not surprising, because both the W &amp;amp; T method as
well as the exponential growth model use the correct generation time
distribution, whereas the RKI method and the exponential growth with
point mass distribution use an incorrect serial interval distribution.
In practice “the correct” serial interval distribution would not be
available – only an estimate. However, one could reflect estimation
uncertainty through additional bootstrapping of the two more advanced
methods. A more thorough investigation of the methods would of course
also have to investigate the effect of misspecification for the W &amp;amp;
T (2004) method or the exponential growth approach. The point is,
however, that the RKI method as stated in the report is not able to
handle a non-point-mass generation time distribution, which does seem
necessary. There might be other reasons for choosing such a simplified
distribution, but from a statistical point of view it seems like the
estimator could be improved.&lt;/p&gt;
&lt;h3 id=&quot;instantaneous-reproduction-number&quot;&gt;Instantaneous reproduction
number&lt;/h3&gt;
&lt;p&gt;&lt;strong&gt;Update 2020-04-22&lt;/strong&gt;: Based on recent discussions, I’m
adding an additional reproduction number estimator, i.e. the
&lt;strong&gt;instantaneous reproduction number&lt;/strong&gt; as defined in &lt;span
class=&quot;citation&quot; data-cites=&quot;cori_etal2013&quot;&gt;Cori et al. (2013)&lt;/span&gt;.
This quantitity is different from the effective reproduction number,
because it compares the number of new infections on day &lt;span
class=&quot;math inline&quot;&gt;\(t\)&lt;/span&gt; with the infection pressure from the
days prior to &lt;span class=&quot;math inline&quot;&gt;\(t\)&lt;/span&gt;, i.e.&lt;/p&gt;
&lt;p&gt;&lt;span class=&quot;math display&quot;&gt;\[
\hat{R}(t) = \frac{y_t}{\sum_{s=1}^{t} g_{s} \cdot y_{t-s}}
\]&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;It can be interpreted as the average number of secondary cases that
each symptomatic individual at time &lt;span
class=&quot;math inline&quot;&gt;\(t\)&lt;/span&gt; would infect, if the conditions
remained as they were at time &lt;span
class=&quot;math inline&quot;&gt;\(t\)&lt;/span&gt;.&lt;/p&gt;
&lt;p&gt;Opposite to the forward looking approach of &lt;span class=&quot;citation&quot;
data-cites=&quot;wallinga_teunis2004&quot;&gt;Wallinga and Teunis (2004)&lt;/span&gt;, this
estimator is defined backwards in time. As illustrated by this comment
to a JAMA paper by &lt;a
href=&quot;https://github.com/keyajoshi/Pan_response&quot;&gt;Lipsitch et al.&lt;/a&gt;,
the definition of timing of &lt;span class=&quot;math inline&quot;&gt;\(R(t)\)&lt;/span&gt;
can make a big difference when comparing it with intervention measures.
The instantaneous reproduction number estimator is implemented in the &lt;a
href=&quot;https://cran.r-project.org/web/packages/EpiEstim/index.html&quot;&gt;&lt;code&gt;EpiEstim&lt;/code&gt;&lt;/a&gt;
package &lt;span class=&quot;citation&quot; data-cites=&quot;cori_etal2013&quot;&gt;(Cori et al.
2013)&lt;/span&gt;. For our small simulation and without any smoothing window
for the instantaneous estimator we obtain&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/blog/figure/source/2020-04-15-effectiveR0/PLOTINSTANTANEOUSR0-1.png&quot; style=&quot;display: block; margin: auto;&quot; /&gt;&lt;/p&gt;
&lt;p&gt;One observes that the change of the estimate in timing corresponds to
the intervention, but it takes time to adjust to the new situation and,
hence, provides too high values reproduction number values for some days
after the intervention, which is the point of &lt;a
href=&quot;https://github.com/keyajoshi/Pan_response&quot;&gt;Lipsitch et al.&lt;/a&gt;.
The plot shows how difficult it is to use reproduction number estimates
to assess interventions, where the change is abrupt and at a time scale
shorter than the serial interval. Furthermore, since the RKI method is
assigned to the last time point of the two 4-blocks compared, it appears
in interpretation to be closer to the instantenous reproduction
number.&lt;/p&gt;
&lt;p&gt;At this point it is good to remember why one started to consider the
effective reproduction number in the first place. That is, as a
real-time (i.e. with interventions and immunity) extension of the basic
reproduction number &lt;span class=&quot;math inline&quot;&gt;\(R_0\)&lt;/span&gt;. To me this
definition is inherently forward in time.&lt;/p&gt;
&lt;h2 id=&quot;discussion&quot;&gt;Discussion&lt;/h2&gt;
&lt;p&gt;In this post we showed how to compute the effective reproduction
number in R using both own implementations and the &lt;a
href=&quot;https://cran.r-project.org/web/packages/R0/index.html&quot;&gt;&lt;code&gt;R0&lt;/code&gt;&lt;/a&gt;
package. We illustrated this with data from a hypothetical outbreak. An
important message is that there is a mathematical relationship between
the daily growth factor and the reproduction number - this relationship
is governed by the generation time distribution.&lt;/p&gt;
&lt;p&gt;In the present analysis the RKI method, which basically is identical
to the approach of inserting the point mass distribution into the
formula of &lt;span class=&quot;citation&quot;
data-cites=&quot;wallinga_lipsitch2006&quot;&gt;Wallinga and Lipsitch (2006)&lt;/span&gt;,
showed a bias when the generation time had the anticipated mean, but had
a standard deviation larger than zero. The bias is more pronounced when
&lt;span class=&quot;math inline&quot;&gt;\(R_e(t)\)&lt;/span&gt; is further away from 1.
However, once the lockdown is gradually lifted, &lt;span
class=&quot;math inline&quot;&gt;\(R_e(t)\)&lt;/span&gt; is likely to raise again making
this potentially a relevant bias. The exponential growth approach using
the moment generating function of the (discretized) best estimate of the
serial interval distribution, can be realized with any statistics
package and is computationally fast. Further algorithmic improvements
such as &lt;span class=&quot;citation&quot; data-cites=&quot;wallinga_teunis2004&quot;&gt;Wallinga
and Teunis (2004)&lt;/span&gt; are readily available in R.&lt;/p&gt;
&lt;p&gt;A nice site, which computes time varying reproduction rates for many
countries in the world is &lt;a
href=&quot;https://epiforecasts.io/covid/&quot;&gt;Temporal variation in transmission
during the COVID-19 outbreak&lt;/a&gt; by the LSHTM.&lt;/p&gt;
&lt;h2 class=&quot;unnumbered&quot; id=&quot;literature&quot;&gt;Literature&lt;/h2&gt;
&lt;div id=&quot;refs&quot; class=&quot;references csl-bib-body hanging-indent&quot;
data-entry-spacing=&quot;0&quot; role=&quot;list&quot;&gt;
&lt;div id=&quot;ref-anderheiden_hamouda2020&quot; class=&quot;csl-entry&quot; role=&quot;listitem&quot;&gt;
an der Heiden, M., and O. Hamouda. 2020. &lt;span&gt;“Schätzung Der Aktuellen
Entwicklung Der SARS-CoV-2-Epidemie in Deutsch-Land –
Nowcasting.”&lt;/span&gt; &lt;em&gt;Epid Bull&lt;/em&gt; 17: 10–15. &lt;a
href=&quot;https://doi.org/10.25646/6692.4&quot;&gt;https://doi.org/10.25646/6692.4&lt;/a&gt;.
&lt;/div&gt;
&lt;div id=&quot;ref-cori_etal2013&quot; class=&quot;csl-entry&quot; role=&quot;listitem&quot;&gt;
Cori, Anne, Neil M. Ferguson, Christophe Fraser, and Simon Cauchemez.
2013. &lt;span&gt;“A New Framework and Software to Estimate Time-Varying
Reproduction Numbers During Epidemics.”&lt;/span&gt; &lt;em&gt;American Journal of
Epidemiology&lt;/em&gt; 178 (9): 1505–12. &lt;a
href=&quot;https://doi.org/10.1093/aje/kwt133&quot;&gt;https://doi.org/10.1093/aje/kwt133&lt;/a&gt;.
&lt;/div&gt;
&lt;div id=&quot;ref-obadia_etal2012&quot; class=&quot;csl-entry&quot; role=&quot;listitem&quot;&gt;
Obadia, Thomas, Romana Haneef, and Pierre-Yves Boëlle. 2012. &lt;span&gt;“The
R0 Package: A Toolbox to Estimate Reproduction Numbers for Epidemic
Outbreaks.”&lt;/span&gt; &lt;em&gt;BMC Medical Informatics and Decision Making&lt;/em&gt;
12 (1): 147.
&lt;/div&gt;
&lt;div id=&quot;ref-svensson2007&quot; class=&quot;csl-entry&quot; role=&quot;listitem&quot;&gt;
Svensson, Å. 2007. &lt;span&gt;“&lt;span class=&quot;nocase&quot;&gt;&lt;span&gt;A&lt;/span&gt; note on
generation times in epidemic models&lt;/span&gt;.”&lt;/span&gt; &lt;em&gt;Math Biosci&lt;/em&gt;
208 (1): 300–311. &lt;a
href=&quot;https://doi.org/10.1016/j.mbs.2006.10.010&quot;&gt;https://doi.org/10.1016/j.mbs.2006.10.010&lt;/a&gt;.
&lt;/div&gt;
&lt;div id=&quot;ref-wallinga_lipsitch2006&quot; class=&quot;csl-entry&quot; role=&quot;listitem&quot;&gt;
Wallinga, J., and M. Lipsitch. 2006. &lt;span&gt;“How Generation Intervals
Shape the Relationship Between Growth Rates and Reproductive
Numbers.”&lt;/span&gt; &lt;em&gt;Proc. R. Soc. B.&lt;/em&gt; 274: 599–604. &lt;a
href=&quot;https://doi.org/10.1098/rspb.2006.3754&quot;&gt;https://doi.org/10.1098/rspb.2006.3754&lt;/a&gt;.
&lt;/div&gt;
&lt;div id=&quot;ref-wallinga_teunis2004&quot; class=&quot;csl-entry&quot; role=&quot;listitem&quot;&gt;
Wallinga, J., and P. Teunis. 2004. &lt;span&gt;“&lt;span
class=&quot;nocase&quot;&gt;&lt;span&gt;D&lt;/span&gt;ifferent epidemic curves for severe acute
respiratory syndrome reveal similar impacts of control
measures&lt;/span&gt;.”&lt;/span&gt; &lt;em&gt;American Journal of Epidemiology&lt;/em&gt; 160
(6): 509–16.
&lt;/div&gt;
&lt;/div&gt;
&lt;section id=&quot;footnotes&quot; class=&quot;footnotes footnotes-end-of-document&quot;
role=&quot;doc-endnotes&quot;&gt;
&lt;hr /&gt;
&lt;ol&gt;
&lt;li id=&quot;fn1&quot;&gt;&lt;p&gt;My remarks are based on the 1st published version
(2020-04-09) of the article&lt;a href=&quot;#fnref1&quot; class=&quot;footnote-back&quot;
role=&quot;doc-backlink&quot;&gt;↩︎&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;/section&gt;
</description>
        <pubDate>Wed, 15 Apr 2020 00:00:00 +0200</pubDate>
        <link>https://mhoehle.github.io/blog/2020/04/15/effectiveR0.html</link>
        <guid isPermaLink="true">https://mhoehle.github.io/blog/2020/04/15/effectiveR0.html</guid>
        
        <category>rstats</category>
        
        <category>dataviz</category>
        
        <category>R</category>
        
        <category>COVID-19</category>
        
        <category>SARS-CoV-2</category>
        
        <category>epidemic models</category>
        
        
      </item>
    
      <item>
        <title>Flatten the COVID-19 curve</title>
        <description>&lt;h2 id=&quot;abstract&quot;&gt;Abstract:&lt;/h2&gt;
&lt;p&gt;We discuss why the message of flattening the COVID-19 curve is right,
but why some of the visualizations used to show the effect are wrong:
Reducing the basic reproduction number does not just stretch the
outbreak, it also reduces the final size of the outbreak. A Shiny app
exists to investigate different scenarios.&lt;/p&gt;
&lt;center&gt;
&lt;img src=&quot;/blog/figure/source/2020-03-16-flatteningthecurve/FLATTENTHECURVE-1.png&quot; width=&quot;550&quot;&gt;
&lt;/center&gt;
&lt;p&gt;&lt;br&gt;
&lt;a rel=&quot;license&quot; href=&quot;http://creativecommons.org/licenses/by-sa/4.0/&quot;&gt;&lt;img alt=&quot;Creative Commons License&quot; style=&quot;border-width:0&quot; src=&quot;https://i.creativecommons.org/l/by-sa/4.0/88x31.png&quot;/&gt;&lt;/a&gt;
This work is licensed under a &lt;a rel=&quot;license&quot;
href=&quot;http://creativecommons.org/licenses/by-sa/4.0/&quot;&gt;Creative Commons
Attribution-ShareAlike 4.0 International License&lt;/a&gt;. The
markdown+Rknitr source code of this blog is available under a &lt;a
href=&quot;https://www.gnu.org/licenses/gpl-3.0.html&quot;&gt;GNU General Public
License (GPL v3)&lt;/a&gt; license from github.&lt;/p&gt;
&lt;h2 id=&quot;motivation&quot;&gt;Motivation&lt;/h2&gt;
&lt;p&gt;Current discussions about interventions for the ongoing COVID-19
outbreak talk a lot about &lt;strong&gt;flattening the epidemic
curve&lt;/strong&gt;, i.e. to slow down the outbreak dynamics. Because of
limited health capacities, stretching out the outbreak over a longer
time period will ensure, that a larger proportion of those in need of
hospital treatment will actually get it. Other advantages of this
approach are to win time in order to find better treatment forms and,
possibly, to eventually develop a vaccine. Visualization of the
flatten-the-curve-effect often look like this one taken from
Twitter:&lt;/p&gt;
&lt;center&gt;
&lt;blockquote class=&quot;twitter-tweet&quot;&gt;
&lt;p lang=&quot;en&quot; dir=&quot;ltr&quot;&gt;
Our
&lt;a href=&quot;https://twitter.com/hashtag/FlattenTheCurve?src=hash&amp;amp;ref_src=twsrc%5Etfw&quot;&gt;#FlattenTheCurve&lt;/a&gt;
graphic is now up on
&lt;a href=&quot;https://twitter.com/Wikipedia?ref_src=twsrc%5Etfw&quot;&gt;&lt;span
class=&quot;citation&quot;
data-cites=&quot;Wikipedia&quot;&gt;(&lt;strong&gt;Wikipedia?&lt;/strong&gt;)&lt;/span&gt;&lt;/a&gt; with
proper attribution &amp;amp; a CC-BY-SA licence. Please share far &amp;amp; wide
and translate it into any language you can! Details in the thread below.
&lt;a href=&quot;https://twitter.com/hashtag/Covid_19?src=hash&amp;amp;ref_src=twsrc%5Etfw&quot;&gt;#Covid_19&lt;/a&gt;
&lt;a href=&quot;https://twitter.com/hashtag/COVID2019?src=hash&amp;amp;ref_src=twsrc%5Etfw&quot;&gt;#COVID2019&lt;/a&gt;
&lt;a href=&quot;https://twitter.com/hashtag/COVID19?src=hash&amp;amp;ref_src=twsrc%5Etfw&quot;&gt;#COVID19&lt;/a&gt;
&lt;a href=&quot;https://twitter.com/hashtag/coronavirus?src=hash&amp;amp;ref_src=twsrc%5Etfw&quot;&gt;#coronavirus&lt;/a&gt;
Thanks to &lt;a href=&quot;https://twitter.com/XTOTL?ref_src=twsrc%5Etfw&quot;&gt;&lt;span
class=&quot;citation&quot; data-cites=&quot;XTOTL&quot;&gt;(&lt;strong&gt;XTOTL?&lt;/strong&gt;)&lt;/span&gt;&lt;/a&gt;
&amp;amp;
&lt;a href=&quot;https://twitter.com/TheSpinoffTV?ref_src=twsrc%5Etfw&quot;&gt;&lt;span
class=&quot;citation&quot;
data-cites=&quot;TheSpinoffTV&quot;&gt;(&lt;strong&gt;TheSpinoffTV?&lt;/strong&gt;)&lt;/span&gt;&lt;/a&gt;
&lt;a href=&quot;https://t.co/BQop7yWu1Q&quot;&gt;pic.twitter.com/BQop7yWu1Q&lt;/a&gt;
&lt;/p&gt;
— Dr Siouxsie Wiles (&lt;span class=&quot;citation&quot;
data-cites=&quot;SiouxsieW&quot;&gt;(&lt;strong&gt;SiouxsieW?&lt;/strong&gt;)&lt;/span&gt;)
&lt;a href=&quot;https://twitter.com/SiouxsieW/status/1237275231783284736?ref_src=twsrc%5Etfw&quot;&gt;March
10, 2020&lt;/a&gt;
&lt;/blockquote&gt;
&lt;script async src=&quot;https://platform.twitter.com/widgets.js&quot; charset=&quot;utf-8&quot;&gt;&lt;/script&gt;
&lt;/center&gt;
&lt;p&gt;The origin of these illustration is discussed &lt;a
href=&quot;https://www.fastcompany.com/90476143/the-story-behind-flatten-the-curve-the-defining-chart-of-the-coronavirus?partner=rss&quot;&gt;here&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;As much as I support the message and reasons for flattening the
curve, some of the visualizations have shortcomings from an infectious
disease modelling point of view: They transport the message that the
number of individuals, which -as an result of the outbreak- will need
hospitalization, is fixed. Hence, the figure suggests that it’s
impossible to avoid a certain number of infected (say 40-70% of the
population), but we save lives by stretching out hospital cases over
time. Although the conclusion is correct, the premise is IMHO wrong:
Reducing the basic reproduction number by drastically reducing contacts
or quickly isolating infectious diseases also reduces the size of the
outbreak. Also others, like &lt;a
href=&quot;http://ms.mcmaster.ca/~bolker/misc/peak_I_simple.html&quot;&gt;Ben
Bolker&lt;/a&gt; have pointed out this flaw.&lt;/p&gt;
&lt;p&gt;We shall use a simple and common mathematical model from infectious
disease modelling to illustrate this point. This model is easily
implemented in R - showing how is a secondary objective of this post.
The R code of this post is available from &lt;a
href=&quot;https://raw.githubusercontent.com/hoehleatsu/hoehleatsu.github.io/master/_source/2020-03-16-flatteningthecurve.Rmd&quot;&gt;github&lt;/a&gt;
and is nicely visualized interactively by a &lt;a
href=&quot;https://tinu.shinyapps.io/Flatten_the_Curve/&quot;&gt;&lt;strong&gt;Shiny
App&lt;/strong&gt;&lt;/a&gt; made by Tinu Schneider.&lt;/p&gt;
&lt;p&gt;A word of caution at this point: &lt;strong&gt;The numbers and
illustrations used in this post address the point of visualization and
are not an attempt to generate actual policy advice&lt;/strong&gt;.&lt;/p&gt;
&lt;h2
id=&quot;susceptible-infectious-recovered-modelling&quot;&gt;Susceptible-Infectious-Recovered
modelling&lt;/h2&gt;
&lt;p&gt;A well-known mathematical model to describe the dynamics of an
infectious disease in a population is the so called
susceptible-infectious-recovered (SIR) compartment model &lt;span
class=&quot;citation&quot; data-cites=&quot;kermack_mckendrick1927&quot;&gt;(Kermack and
McKendrick 1927)&lt;/span&gt;. This model assumes that each individual in the
population population belongs to one of three states:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;em&gt;S&lt;/em&gt;usceptible: the individual has not yet had the disease,
but is not immune to the disease and thus can become infectious when
having an infectious contact with an infected individual&lt;/li&gt;
&lt;li&gt;&lt;em&gt;I&lt;/em&gt;nfectious: a person currently affected by the disease and
able to transmit the disease to others&lt;/li&gt;
&lt;li&gt;&lt;em&gt;R&lt;/em&gt;ecovered: an infectious person who is not affected anymore
by the disease and not able to transmit the disease anymore. No
re-infection can occur, i.e. recovered individuals are immune to the
disease once they had it.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;It is assumed that at time zero everyone is susceptible except for
&lt;span class=&quot;math inline&quot;&gt;\(m\)&lt;/span&gt; individuals, which are infectious
at time zero. Once infected an individual becomes infectious and then
recovers. Mathematically, we shall by &lt;span
class=&quot;math inline&quot;&gt;\(S(t)\)&lt;/span&gt;, &lt;span
class=&quot;math inline&quot;&gt;\(I(t)\)&lt;/span&gt; and &lt;span
class=&quot;math inline&quot;&gt;\(R(t)\)&lt;/span&gt; denote the number of susceptible,
infectious and recovered in the population at time &lt;span
class=&quot;math inline&quot;&gt;\(t\)&lt;/span&gt;. Furthermore, it is assumed that the
population consists of a constant number of &lt;span
class=&quot;math inline&quot;&gt;\(N\)&lt;/span&gt; individuals and at all times &lt;span
class=&quot;math inline&quot;&gt;\(S(t)+I(t)+R(t)=N\)&lt;/span&gt;. In other words the
population is closed and does not vary over time.&lt;/p&gt;
&lt;p&gt;The dynamics in the number of susceptibles, infectious and recovered
are now described using the following deterministic &lt;a
href=&quot;https://en.wikipedia.org/wiki/Ordinary_differential_equation&quot;&gt;ordinary
differential equation&lt;/a&gt; (ODE) system:&lt;/p&gt;
&lt;p&gt;&lt;span class=&quot;math display&quot;&gt;\[
\begin{eqnarray*}
\frac{dS(t)}{dt} &amp;amp;=&amp;amp; -\beta S(t) I(t), \\
\frac{dI(t)}{dt} &amp;amp;=&amp;amp; \beta S(t) I(t) - \gamma I(t), \\
\frac{dR(t)}{dt} &amp;amp;=&amp;amp; \gamma I(t).
\end{eqnarray*}
\]&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;What does this mean? It denotes the movement of individuals between
the three categories, in particular the movement from &lt;span
class=&quot;math inline&quot;&gt;\(S\rightarrow I\)&lt;/span&gt; and &lt;span
class=&quot;math inline&quot;&gt;\(I \rightarrow R\)&lt;/span&gt;. The most important term
in the equation system is &lt;span class=&quot;math inline&quot;&gt;\(\beta S(t)
I(t)\)&lt;/span&gt; and can be motivated as follows: Consider one specific
infectious individual at time &lt;span class=&quot;math inline&quot;&gt;\(t\)&lt;/span&gt;,
this individual meets a specific other person in the population at the
rate of &lt;span class=&quot;math inline&quot;&gt;\(\beta\)&lt;/span&gt; contacts per time
unit (say day). It is assumed that this rate is the same no matter which
other person we talk about (aka. homogeneous mixing in the population).
Of course this is a very strong simplification, because it ignores,
e.g., the distance between two individuals and that you tend to mix with
more with peers. But in a large population, the average is a good
description. Hence, the number of contacts with susceptible individuals
per time unit is &lt;span class=&quot;math inline&quot;&gt;\(\beta S(t)\)&lt;/span&gt;. Now
summing these contacts over all infectious individuals at time &lt;span
class=&quot;math inline&quot;&gt;\(t\)&lt;/span&gt; leads to &lt;span
class=&quot;math inline&quot;&gt;\(\sum_{j=1}^{I(t)}\beta S(t) = \beta I(t)
S(t)\)&lt;/span&gt;. Note that this is a non-linear term consisting of both
&lt;span class=&quot;math inline&quot;&gt;\(I(t)\)&lt;/span&gt; and &lt;span
class=&quot;math inline&quot;&gt;\(S(t)\)&lt;/span&gt;.&lt;/p&gt;
&lt;p&gt;In the above process description,for the ease of exposition, it is
assumed that once an infectious individual meets a susceptible person,
then the disease is always transmitted from the infected to the
susceptible person. Hence, the transmission probability does not depend
on, e.g., how long the infectious individual has already been
infectious. An equivalent way of formulating this statement is to say
that each individual has contacts at rate &lt;span
class=&quot;math inline&quot;&gt;\(\alpha\)&lt;/span&gt; for meeting a specific other
person, and a proportion &lt;span class=&quot;math inline&quot;&gt;\(p\)&lt;/span&gt; of these
contacts results in an infection. Then &lt;span class=&quot;math inline&quot;&gt;\(\beta
= \alpha p\)&lt;/span&gt; is the rate at which infectious contacts occur.&lt;/p&gt;
&lt;p&gt;The second component of the model is the term &lt;span
class=&quot;math inline&quot;&gt;\(\gamma I(t)\)&lt;/span&gt;. Again considering one
infectious individual it is assumed that the rate at which &lt;span
class=&quot;math inline&quot;&gt;\(I\rightarrow R\)&lt;/span&gt; transition occurs happens
at the constant rate &lt;span class=&quot;math inline&quot;&gt;\(\gamma\)&lt;/span&gt;. This
means that individuals are on average &lt;span
class=&quot;math inline&quot;&gt;\(1/\gamma\)&lt;/span&gt; days infectious before they
recover from the disease. In other words: The smaller &lt;span
class=&quot;math inline&quot;&gt;\(\gamma\)&lt;/span&gt; is the longer people are
infectious and, hence, the longer they can transmit the disease to
others. Note: Recovering from an epidemic modelling point of view does
not distinguish between individuals which recover by becoming healthy or
by dying - what is important is that they do not contribute to the
spread of the disease anymore.&lt;/p&gt;
&lt;p&gt;One important quantity, which can be derived from the above ODE
equation system is the so called &lt;strong&gt;basic reproduction
number&lt;/strong&gt;, aka. &lt;span class=&quot;math inline&quot;&gt;\(R_0\)&lt;/span&gt; and is
defined as &lt;span class=&quot;citation&quot;
data-cites=&quot;diekman_etal2013&quot;&gt;(Diekmann, Heesterbeek, and Britton
2013)&lt;/span&gt;&lt;/p&gt;
&lt;div class=&quot;blackbox&quot;&gt;
&lt;strong&gt;the expected number of secondary cases per primary case in
&lt;/strong&gt;a completely susceptible population. It is computed as** &lt;span
class=&quot;math inline&quot;&gt;\(R_0 = N \frac{\beta}{\gamma}\)&lt;/span&gt;.
&lt;/div&gt;
&lt;p&gt;
&lt;p&gt;This means that if we consider the dynamics of a disease in
generation time, i.e. in a time scale where one time unit is the time
period between infection in the primary case and infection in the
secondary case, then &lt;span class=&quot;math inline&quot;&gt;\(R_0\)&lt;/span&gt; denotes
the growth factor in the size of the population at the beginning of the
outbreak. What is special about the beginning of the outbreak? Well,
more or less all contacts an infectious individual has, will be with
susceptible individuals. However, once a large part of the population
has already been infected, then &lt;span class=&quot;math inline&quot;&gt;\(R_0\)&lt;/span&gt;
does not necessarily describe the expected number of cases per primary
case anymore. For the COVID-19 outbreak, since it is assumed that little
immunity exists against the disease, all individuals will be susceptible
and, hence, almost all contacts an infectious individual has, will be
with susceptible persons. However, at a later stage in the epidemic, due
to the depletion of susceptibles, the number of secondary cases will be
lower. Furthermore, possible interventions as part of the epidemic
response along the way might additionally lower the number of secondary
cases.&lt;/p&gt;
&lt;p&gt;Assuming &lt;span class=&quot;math inline&quot;&gt;\(R(0)\)&lt;/span&gt; and letting &lt;span
class=&quot;math inline&quot;&gt;\(I(0)=m\)&lt;/span&gt; we obtain &lt;span
class=&quot;math inline&quot;&gt;\(S(0) = N-m\)&lt;/span&gt;. We can use this initial
configuration together with a numerical solver for ODEs as implemented,
e.g., in the &lt;code&gt;lsoda&lt;/code&gt; function of the R package &lt;a
href=&quot;https://cran.r-project.org/web/packages/deSolve/index.html&quot;&gt;&lt;code&gt;deSolve&lt;/code&gt;&lt;/a&gt;
&lt;span class=&quot;citation&quot; data-cites=&quot;desolve2010&quot;&gt;(Soetaert, Petzoldt, and
Setzer 2010)&lt;/span&gt;. For this, we need to implement a function, which
describes the derivative of the ODE system:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb1&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb1-1&quot;&gt;&lt;a href=&quot;#cb1-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;######################################################################&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-2&quot;&gt;&lt;a href=&quot;#cb1-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;# Function to compute the derivative of the ODE system&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-3&quot;&gt;&lt;a href=&quot;#cb1-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;#&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-4&quot;&gt;&lt;a href=&quot;#cb1-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;#  t - time&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-5&quot;&gt;&lt;a href=&quot;#cb1-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;#  y - current state vector of the ODE at time t&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-6&quot;&gt;&lt;a href=&quot;#cb1-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;#  parms - Parameter vector used by the ODE system&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-7&quot;&gt;&lt;a href=&quot;#cb1-7&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;#&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-8&quot;&gt;&lt;a href=&quot;#cb1-8&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;# Returns:&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-9&quot;&gt;&lt;a href=&quot;#cb1-9&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;#  list with one component being a vector of length two containing&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-10&quot;&gt;&lt;a href=&quot;#cb1-10&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;#  dS(t)/dt and dI(t)/dt&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-11&quot;&gt;&lt;a href=&quot;#cb1-11&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;######################################################################&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-12&quot;&gt;&lt;a href=&quot;#cb1-12&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-13&quot;&gt;&lt;a href=&quot;#cb1-13&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;sir &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;cf&quot;&gt;function&lt;/span&gt;(t, y, parms) {&lt;/span&gt;
&lt;span id=&quot;cb1-14&quot;&gt;&lt;a href=&quot;#cb1-14&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  beta &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; parms[&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;]&lt;/span&gt;
&lt;span id=&quot;cb1-15&quot;&gt;&lt;a href=&quot;#cb1-15&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  gamma &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; parms[&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;]&lt;/span&gt;
&lt;span id=&quot;cb1-16&quot;&gt;&lt;a href=&quot;#cb1-16&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  S &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; y[&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;]&lt;/span&gt;
&lt;span id=&quot;cb1-17&quot;&gt;&lt;a href=&quot;#cb1-17&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  I &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; y[&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;]&lt;/span&gt;
&lt;span id=&quot;cb1-18&quot;&gt;&lt;a href=&quot;#cb1-18&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;return&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;list&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;c&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;S =&lt;/span&gt; &lt;span class=&quot;sc&quot;&gt;-&lt;/span&gt;beta &lt;span class=&quot;sc&quot;&gt;*&lt;/span&gt; S &lt;span class=&quot;sc&quot;&gt;*&lt;/span&gt; I, &lt;span class=&quot;at&quot;&gt;I =&lt;/span&gt; beta &lt;span class=&quot;sc&quot;&gt;*&lt;/span&gt; S &lt;span class=&quot;sc&quot;&gt;*&lt;/span&gt; I &lt;span class=&quot;sc&quot;&gt;-&lt;/span&gt; gamma &lt;span class=&quot;sc&quot;&gt;*&lt;/span&gt; I)))&lt;/span&gt;
&lt;span id=&quot;cb1-19&quot;&gt;&lt;a href=&quot;#cb1-19&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb2&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb2-1&quot;&gt;&lt;a href=&quot;#cb2-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;# Population size &lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb2-2&quot;&gt;&lt;a href=&quot;#cb2-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;N &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fl&quot;&gt;1e6&lt;/span&gt; &lt;/span&gt;
&lt;span id=&quot;cb2-3&quot;&gt;&lt;a href=&quot;#cb2-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;# Rate at which person stays in the infectious compartment (disease specific and tracing specific)&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb2-4&quot;&gt;&lt;a href=&quot;#cb2-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;gamma &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;5&lt;/span&gt; &lt;/span&gt;
&lt;span id=&quot;cb2-5&quot;&gt;&lt;a href=&quot;#cb2-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;# Infectious contact rate - beta = R0/N*gamma and when R0 \approx 2.25 then  2.25/N*gamma&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb2-6&quot;&gt;&lt;a href=&quot;#cb2-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;beta &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fl&quot;&gt;4.5e-07&lt;/span&gt; &lt;/span&gt;
&lt;span id=&quot;cb2-7&quot;&gt;&lt;a href=&quot;#cb2-7&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;# R0 for the beta and gamma values&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb2-8&quot;&gt;&lt;a href=&quot;#cb2-8&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;R0 &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; beta&lt;span class=&quot;sc&quot;&gt;*&lt;/span&gt;N&lt;span class=&quot;sc&quot;&gt;/&lt;/span&gt;gamma&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Assuming a hypothetical population of &lt;span class=&quot;math inline&quot;&gt;\(N =
1,000,000\)&lt;/span&gt; and a contact rate of &lt;span
class=&quot;math inline&quot;&gt;\(\beta = 0.0000004\)&lt;/span&gt; means that the contact
rate with a given individual is 0.0000004 contacts per day. The choice
of &lt;span class=&quot;math inline&quot;&gt;\(\gamma = 0.2\)&lt;/span&gt; corresponds to an
average length of the infective period of 5 days. Altogether, this leads
to an &lt;span class=&quot;math inline&quot;&gt;\(R_0\)&lt;/span&gt; of 2.25, which roughly
corresponds to the &lt;span class=&quot;math inline&quot;&gt;\(R_0\)&lt;/span&gt; of
SARS-CoV-2.&lt;/p&gt;
&lt;p&gt;We can now solve the ODE system using the above parameters and an
initial number of infectious of, say, 10:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb3&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb3-1&quot;&gt;&lt;a href=&quot;#cb3-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;# Load package to numerically solve ODEs&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb3-2&quot;&gt;&lt;a href=&quot;#cb3-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;suppressPackageStartupMessages&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;library&lt;/span&gt;(deSolve))&lt;/span&gt;
&lt;span id=&quot;cb3-3&quot;&gt;&lt;a href=&quot;#cb3-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb3-4&quot;&gt;&lt;a href=&quot;#cb3-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;# Grid where to evaluate&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb3-5&quot;&gt;&lt;a href=&quot;#cb3-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;max_time &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;dv&quot;&gt;150&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb3-6&quot;&gt;&lt;a href=&quot;#cb3-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;times &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;seq&lt;/span&gt;(&lt;span class=&quot;dv&quot;&gt;0&lt;/span&gt;, max_time, &lt;span class=&quot;at&quot;&gt;by=&lt;/span&gt;&lt;span class=&quot;fl&quot;&gt;0.01&lt;/span&gt;)&lt;/span&gt;
&lt;span id=&quot;cb3-7&quot;&gt;&lt;a href=&quot;#cb3-7&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb3-8&quot;&gt;&lt;a href=&quot;#cb3-8&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;# Solve ODE system using Runge-Kutta numerical method.&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb3-9&quot;&gt;&lt;a href=&quot;#cb3-9&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;ode_solution &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;rk4&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;y =&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;c&lt;/span&gt;(N &lt;span class=&quot;sc&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;dv&quot;&gt;10&lt;/span&gt;, &lt;span class=&quot;dv&quot;&gt;10&lt;/span&gt;), &lt;span class=&quot;at&quot;&gt;times =&lt;/span&gt; times, &lt;span class=&quot;at&quot;&gt;func =&lt;/span&gt; sir, &lt;span class=&quot;at&quot;&gt;parms =&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;c&lt;/span&gt;(beta, gamma)) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb3-10&quot;&gt;&lt;a href=&quot;#cb3-10&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;fu&quot;&gt;as.data.frame&lt;/span&gt;() &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb3-11&quot;&gt;&lt;a href=&quot;#cb3-11&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;fu&quot;&gt;setNames&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;c&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;quot;t&amp;quot;&lt;/span&gt;, &lt;span class=&quot;st&quot;&gt;&amp;quot;S&amp;quot;&lt;/span&gt;, &lt;span class=&quot;st&quot;&gt;&amp;quot;I&amp;quot;&lt;/span&gt;)) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb3-12&quot;&gt;&lt;a href=&quot;#cb3-12&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;fu&quot;&gt;mutate&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;beta =&lt;/span&gt; beta, &lt;span class=&quot;at&quot;&gt;gama =&lt;/span&gt; gamma, &lt;span class=&quot;at&quot;&gt;R0 =&lt;/span&gt; N &lt;span class=&quot;sc&quot;&gt;*&lt;/span&gt; beta &lt;span class=&quot;sc&quot;&gt;/&lt;/span&gt; gamma, &lt;span class=&quot;at&quot;&gt;s =&lt;/span&gt; S &lt;span class=&quot;sc&quot;&gt;/&lt;/span&gt; N, &lt;span class=&quot;at&quot;&gt;i =&lt;/span&gt; I &lt;span class=&quot;sc&quot;&gt;/&lt;/span&gt; N, &lt;span class=&quot;at&quot;&gt;type =&lt;/span&gt; &lt;span class=&quot;st&quot;&gt;&amp;quot;without_intervention&amp;quot;&lt;/span&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Here we have introduced &lt;span class=&quot;math inline&quot;&gt;\(s(t) =
S(t)/N\)&lt;/span&gt; and &lt;span class=&quot;math inline&quot;&gt;\(i(t) = I(t)/N\)&lt;/span&gt;
as, respectively, the proportion of susceptible and infectious
individuals in the population. Note that &lt;span
class=&quot;math inline&quot;&gt;\(I(t)\)&lt;/span&gt; is the number of currently
infectious persons. Since a person is usually infectious for more than
one day this curve is not equivalent to the number of
&lt;strong&gt;new&lt;/strong&gt; infections per day. If interest is in this value,
which would typically be what is reported by health authorities, this
can be computed as &lt;span class=&quot;math display&quot;&gt;\[
C(t) = \int_{t-1}^t \beta S(u) I(u) du.
\]&lt;/span&gt; or due to the SIR structure where re-infections are not
possible simply as &lt;span class=&quot;math inline&quot;&gt;\(S(t-1) -
S(t)\)&lt;/span&gt;.&lt;/p&gt;
&lt;p&gt;The epidemic curve of new infections per day is shown below:
&lt;img src=&quot;/blog/figure/source/2020-03-16-flatteningthecurve/unnamed-chunk-7-1.png&quot; style=&quot;display: block; margin: auto;&quot; /&gt;&lt;/p&gt;
&lt;p&gt;Another important quantity of the model is an estimate for how many
individuals are ultimately infected by the disease, i.e. &lt;span
class=&quot;math inline&quot;&gt;\(1-s(\infty)\)&lt;/span&gt; in a population where
initially everyone is susceptible to the disease. This can be either
calculated numerically from the above output as:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb4&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb4-1&quot;&gt;&lt;a href=&quot;#cb4-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;(&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;sc&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;tail&lt;/span&gt;(ode_solution, &lt;span class=&quot;at&quot;&gt;n=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;pull&lt;/span&gt;(s)) &lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;## [1] 0.8534244&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;or by numerically solving the following recursive equation &lt;span
class=&quot;citation&quot; data-cites=&quot;diekman_etal2013&quot;&gt;(Diekmann, Heesterbeek,
and Britton 2013, 15)&lt;/span&gt;: &lt;span class=&quot;math display&quot;&gt;\[
s(\infty) = \exp(-R_0 (1-s(\infty)))
\]&lt;/span&gt; using R:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb6&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb6-1&quot;&gt;&lt;a href=&quot;#cb6-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;# Function to compute the final size.&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb6-2&quot;&gt;&lt;a href=&quot;#cb6-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;s_inf &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;cf&quot;&gt;function&lt;/span&gt;(R0) {&lt;/span&gt;
&lt;span id=&quot;cb6-3&quot;&gt;&lt;a href=&quot;#cb6-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb6-4&quot;&gt;&lt;a href=&quot;#cb6-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  f_target &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;cf&quot;&gt;function&lt;/span&gt;(x) { x &lt;span class=&quot;sc&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;exp&lt;/span&gt;(&lt;span class=&quot;sc&quot;&gt;-&lt;/span&gt;R0&lt;span class=&quot;sc&quot;&gt;*&lt;/span&gt;(&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;-&lt;/span&gt;x)) }&lt;/span&gt;
&lt;span id=&quot;cb6-5&quot;&gt;&lt;a href=&quot;#cb6-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb6-6&quot;&gt;&lt;a href=&quot;#cb6-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  result &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;uniroot&lt;/span&gt;(f_target, &lt;span class=&quot;at&quot;&gt;lower=&lt;/span&gt;&lt;span class=&quot;fl&quot;&gt;1e-12&lt;/span&gt;, &lt;span class=&quot;at&quot;&gt;upper=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;fl&quot;&gt;-1e-12&lt;/span&gt;)&lt;span class=&quot;sc&quot;&gt;$&lt;/span&gt;root&lt;/span&gt;
&lt;span id=&quot;cb6-7&quot;&gt;&lt;a href=&quot;#cb6-7&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb6-8&quot;&gt;&lt;a href=&quot;#cb6-8&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;return&lt;/span&gt;(result)&lt;/span&gt;
&lt;span id=&quot;cb6-9&quot;&gt;&lt;a href=&quot;#cb6-9&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;}&lt;/span&gt;
&lt;span id=&quot;cb6-10&quot;&gt;&lt;a href=&quot;#cb6-10&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb6-11&quot;&gt;&lt;a href=&quot;#cb6-11&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;# Final proportion of infected.&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb6-12&quot;&gt;&lt;a href=&quot;#cb6-12&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;sc&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;s_inf&lt;/span&gt;(R0)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;## [1] 0.8534382&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;We can use the above equation to verify that the larger &lt;span
class=&quot;math inline&quot;&gt;\(R_0\)&lt;/span&gt;, the larger is the final size of the
outbreak:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb8&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb8-1&quot;&gt;&lt;a href=&quot;#cb8-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;R0_grid &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;c&lt;/span&gt;(&lt;span class=&quot;fl&quot;&gt;1.25&lt;/span&gt;, &lt;span class=&quot;fl&quot;&gt;1.5&lt;/span&gt;, &lt;span class=&quot;fl&quot;&gt;1.75&lt;/span&gt;,&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;, &lt;span class=&quot;fl&quot;&gt;2.25&lt;/span&gt;, &lt;span class=&quot;fl&quot;&gt;2.5&lt;/span&gt;, &lt;span class=&quot;dv&quot;&gt;3&lt;/span&gt;)&lt;/span&gt;
&lt;span id=&quot;cb8-2&quot;&gt;&lt;a href=&quot;#cb8-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;map_dbl&lt;/span&gt;( R0_grid, &lt;span class=&quot;sc&quot;&gt;~&lt;/span&gt; &lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;s_inf&lt;/span&gt;(.x)) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;setNames&lt;/span&gt;(R0_grid) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; scales&lt;span class=&quot;sc&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;percent&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;accuracy=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;##  1.25   1.5  1.75     2  2.25   2.5     3 
## &amp;quot;37%&amp;quot; &amp;quot;58%&amp;quot; &amp;quot;71%&amp;quot; &amp;quot;80%&amp;quot; &amp;quot;85%&amp;quot; &amp;quot;89%&amp;quot; &amp;quot;94%&amp;quot;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;However, despite a value of &lt;span
class=&quot;math inline&quot;&gt;\(R_0&amp;gt;1\)&lt;/span&gt;, not the entire population will
be infected, because of the depletion of susceptibles. Hence, the
exponential growth rate interpretation of &lt;span
class=&quot;math inline&quot;&gt;\(R_0\)&lt;/span&gt; is only valid at the beginning of an
outbreak.&lt;/p&gt;
&lt;h2 id=&quot;reducing-r_0&quot;&gt;Reducing &lt;span
class=&quot;math inline&quot;&gt;\(R_0\)&lt;/span&gt;&lt;/h2&gt;
&lt;p&gt;As we could see from the equation defining &lt;span
class=&quot;math inline&quot;&gt;\(R_0\)&lt;/span&gt; in our simple SIR-model, there are
two ways to reduce the &lt;span class=&quot;math inline&quot;&gt;\(R_0\)&lt;/span&gt; of a
disease:&lt;/p&gt;
&lt;ol type=&quot;1&quot;&gt;
&lt;li&gt;Reduce the number of contacts persons have with each-other,
i.e. make &lt;span class=&quot;math inline&quot;&gt;\(\beta\)&lt;/span&gt; smaller&lt;/li&gt;
&lt;li&gt;Reduce the duration for how long people are effectively spreading
the disease (e.g. by quarantine), i.e. reduce the average duration &lt;span
class=&quot;math inline&quot;&gt;\(\gamma\)&lt;/span&gt; of how long infectious individuals
can infect others.&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;For simplicity we shall only be interested in the first case and will
pursue the following very simple strategy, where the different measures
only depend on time:&lt;/p&gt;
&lt;p&gt;&lt;span class=&quot;math display&quot;&gt;\[
\beta(t) =
\left\{
\begin{array}{}
\beta_0 &amp;amp; \text{if } t\leq t_1, \\
\beta_1 &amp;amp; \text{if } t_1 &amp;lt; t\leq t_2, \\
\beta_2 &amp;amp; \text{if } t_2 &amp;lt; t
\end{array}
\right.
\]&lt;/span&gt; where &lt;span class=&quot;math inline&quot;&gt;\(\beta_0\)&lt;/span&gt; is the
ordinary &lt;span class=&quot;math inline&quot;&gt;\(\beta\)&lt;/span&gt; value of the
disease. We will use a large reduction of the contacts within the
interval &lt;span class=&quot;math inline&quot;&gt;\([t_1, t_2]\)&lt;/span&gt; and thus &lt;span
class=&quot;math inline&quot;&gt;\(\beta_1 &amp;lt; \beta_0\)&lt;/span&gt;. After some time,
the control measures are reduced slightly, i.e. &lt;span
class=&quot;math inline&quot;&gt;\(\beta_1 &amp;lt; \beta_2 &amp;lt; \beta_0\)&lt;/span&gt;. We
shall use &lt;span class=&quot;math inline&quot;&gt;\(\beta_1 = r_1 \beta_0\)&lt;/span&gt; and
&lt;span class=&quot;math inline&quot;&gt;\(\beta_2 = r_2 \beta_0\)&lt;/span&gt; with &lt;span
class=&quot;math inline&quot;&gt;\(r_1 \leq r_2\)&lt;/span&gt;. The two epidemic curves can
now be plotted as follows:&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/blog/figure/source/2020-03-16-flatteningthecurve/FLATTENTHECURVE-1.png&quot; style=&quot;display: block; margin: auto;&quot; /&gt;&lt;/p&gt;
&lt;p&gt;The final size in the two cases:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;## # A tibble: 2 x 2
## # Groups:   type [2]
##   type                 final_fraction
##   &amp;lt;chr&amp;gt;                &amp;lt;chr&amp;gt;         
## 1 without_intervention 85%           
## 2 with_intervention    68%&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Here we used the very conservative estimates that &lt;span
class=&quot;math inline&quot;&gt;\(R_0\)&lt;/span&gt; can be reduced by 60% to 1.35 for a
few weeks, hereafter the reduction is 80% of the original &lt;span
class=&quot;math inline&quot;&gt;\(R_0\)&lt;/span&gt;, i.e. 1.8. Things of course become
more optimistic, the larger the reduction is. One danger is although to
reduce &lt;span class=&quot;math inline&quot;&gt;\(R_0\)&lt;/span&gt; drastically and then
lift the measures too early and too much - in this case the outbreak is
delayed, but then almost of the same peak size and final size, only
later.&lt;/p&gt;
&lt;p&gt;The simple analysis in this post shows that the final size proportion
with interventions is several percentage points smaller than without
interventions. The larger the interventions, if done right and timed
right, the smaller the final size. In other words: the spread of an
infectious disease in a population is a dynamic phenomena. Time matters.
The timing of interventions matters. If done correctly, they stretch the
outbreak and reduce the final size!&lt;/p&gt;
&lt;h2 id=&quot;discussion&quot;&gt;Discussion&lt;/h2&gt;
&lt;p&gt;The epidemic model based approaches to flatten the curve shows that
the effect of reducing the basic reproduction number is not just to
stretch out the outbreak, but also to limit the size of the outbreak.
This is an aspect which seems to be ignored in some visualizations of
the effect.&lt;/p&gt;
&lt;p&gt;The simple SIR model used in this post suffers from a number of
limitations: It is a deterministic construction averaging over many
stochastic phenomena. However, at the large scale of the outbreak we are
now talking about, this simplification appears acceptable. Furthermore,
it assumes homogeneous mixing between individuals, which is way too
simple. Dividing the population into age-groups as well as their
geographic locations and modelling the interaction between these groups
would be a more realistic reflection of how the population is shaped.
Again, for the purpose of the visualization of the flatten-the-curve
effect again I think a simple model is OK. More involved modelling
covering the establishment of the disease as endemic in the population
are beyond this post, so is the effectiveness of the case-tracing. For
more background on the modelling see for example the YouTube video about
the &lt;a
href=&quot;https://www.youtube.com/watch?time_continue=1&amp;amp;v=gSqIwXl6IjQ&amp;amp;feature=emb_logo&quot;&gt;The
Mathematics of the Coronavirus Outbreak&lt;/a&gt; by my colleague Tom Britton
or the work by &lt;span class=&quot;citation&quot;
data-cites=&quot;fraser_etal2004&quot;&gt;Fraser et al. (2004)&lt;/span&gt;.&lt;/p&gt;
&lt;p&gt;It is worth pointing out that mathematical models are only tools to
gain insight. They are based on assumptions which are likely to be
wrong. The question is, if a violation is crucial or if the component is
still adequately captured by the model. A famous quote says: All models
are wrong, but some are useful… &lt;strong&gt;Useful&lt;/strong&gt; in this case is
the message: &lt;strong&gt;flatten the curve by reducing infectious contacts
and by efficient contact tracing&lt;/strong&gt;.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Update 2020-03-18&lt;/strong&gt;: Tinu Schneider from Switzerland
used the GitHub code of this post to program a small &lt;a
href=&quot;https://tinu.shinyapps.io/Flatten_the_Curve/&quot;&gt;Shiny app&lt;/a&gt;
allowing one to study the impact of changing the parameters. Check it
out!&lt;/p&gt;
&lt;h2 class=&quot;unnumbered&quot; id=&quot;literature&quot;&gt;Literature&lt;/h2&gt;
&lt;div id=&quot;refs&quot; class=&quot;references csl-bib-body hanging-indent&quot;
data-entry-spacing=&quot;0&quot; role=&quot;list&quot;&gt;
&lt;div id=&quot;ref-diekman_etal2013&quot; class=&quot;csl-entry&quot; role=&quot;listitem&quot;&gt;
Diekmann, Odo, Hans Heesterbeek, and Tom Britton. 2013. &lt;em&gt;Mathematical
Tools for Understanding Infectious Disease Dynamics&lt;/em&gt;. Princeton
University Press.
&lt;/div&gt;
&lt;div id=&quot;ref-fraser_etal2004&quot; class=&quot;csl-entry&quot; role=&quot;listitem&quot;&gt;
Fraser, Christophe, Steven Riley, Roy M Anderson, and Neil M Ferguson.
2004. &lt;span&gt;“Factors That Make an Infectious Disease Outbreak
Controllable.”&lt;/span&gt; &lt;em&gt;Proceedings of the National Academy of
Sciences of the United States of America&lt;/em&gt; 101 (16): 6146–51.
&lt;/div&gt;
&lt;div id=&quot;ref-kermack_mckendrick1927&quot; class=&quot;csl-entry&quot; role=&quot;listitem&quot;&gt;
Kermack, W. O., and A. G. McKendrick. 1927. &lt;span&gt;“A Contribution to the
Mathematical Theory of Epidemics.”&lt;/span&gt; &lt;em&gt;Proceedings of the Royal
Society, Series A&lt;/em&gt; 115: 700–721.
&lt;/div&gt;
&lt;div id=&quot;ref-desolve2010&quot; class=&quot;csl-entry&quot; role=&quot;listitem&quot;&gt;
Soetaert, Karline, Thomas Petzoldt, and R. Woodrow Setzer. 2010.
&lt;span&gt;“Solving Differential Equations in &lt;span&gt;R&lt;/span&gt;: Package
de&lt;span&gt;S&lt;/span&gt;olve.”&lt;/span&gt; &lt;em&gt;Journal of Statistical Software&lt;/em&gt;
33 (9): 1–25. &lt;a
href=&quot;https://doi.org/10.18637/jss.v033.i09&quot;&gt;https://doi.org/10.18637/jss.v033.i09&lt;/a&gt;.
&lt;/div&gt;
&lt;/div&gt;
</description>
        <pubDate>Mon, 16 Mar 2020 00:00:00 +0100</pubDate>
        <link>https://mhoehle.github.io/blog/2020/03/16/flatteningthecurve.html</link>
        <guid isPermaLink="true">https://mhoehle.github.io/blog/2020/03/16/flatteningthecurve.html</guid>
        
        <category>rstats</category>
        
        <category>dataviz</category>
        
        <category>R</category>
        
        <category>COVID-19</category>
        
        <category>epidemic model</category>
        
        
      </item>
    
      <item>
        <title>Scraping the Sugarcoat</title>
        <description>&lt;h2 id=&quot;abstract&quot;&gt;Abstract:&lt;/h2&gt;
&lt;p&gt;Web-scraped data are used to put a Rubik’s cube competition result
into perspective. The sugarcoating consists of altering the sampling
frame of the comparison to the more relevant population of senior first
time cubers.&lt;/p&gt;
&lt;center&gt;
&lt;img src=&quot;/blog/figure/source/2020-01-22-wcascrape/liveresults.png&quot; width=&quot;550&quot;&gt;
&lt;/center&gt;
&lt;p&gt;&lt;br&gt;
&lt;a rel=&quot;license&quot; href=&quot;http://creativecommons.org/licenses/by-sa/4.0/&quot;&gt;&lt;img alt=&quot;Creative Commons License&quot; style=&quot;border-width:0&quot; src=&quot;https://i.creativecommons.org/l/by-sa/4.0/88x31.png&quot;/&gt;&lt;/a&gt;
This work is licensed under a &lt;a rel=&quot;license&quot;
href=&quot;http://creativecommons.org/licenses/by-sa/4.0/&quot;&gt;Creative Commons
Attribution-ShareAlike 4.0 International License&lt;/a&gt;. The
markdown+Rknitr source code of this blog is available under a &lt;a
href=&quot;https://www.gnu.org/licenses/gpl-3.0.html&quot;&gt;GNU General Public
License (GPL v3)&lt;/a&gt; license from github.&lt;/p&gt;
&lt;h2 id=&quot;motivation&quot;&gt;Motivation&lt;/h2&gt;
&lt;p&gt;I just finished teaching an undergraduate course on &lt;a
href=&quot;https://mt5013-ht19.github.io/&quot;&gt;data wrangling with R&lt;/a&gt; at
Stockholm University about the tidyverse, SQL, and web-scraping&lt;a
href=&quot;#fn1&quot; class=&quot;footnote-ref&quot; id=&quot;fnref1&quot;
role=&quot;doc-noteref&quot;&gt;&lt;sup&gt;1&lt;/sup&gt;&lt;/a&gt;. Inspired by Jenny Bryan’s &lt;a
href=&quot;https://happygitwithr.com/classroom-overview.html&quot;&gt;STAT545
course&lt;/a&gt; the course used GitHub as communication platform. Similar to
the userR! &lt;a
href=&quot;https://en.wikipedia.org/wiki/Lightning_talk&quot;&gt;lightning talks&lt;/a&gt;,
each student had to pitch their project work in a 5 minute presentation
in order to woo other students to read their report. I was utterly
amazed by the content of the reports and the creativity of the
presentations, which included sung slide titles, shiny apps,
cliffhangers, and much more. Enabling mathematics students to pull their
own data gives them a power to realize ideas and test hypothesis that
were not possible before! Most of the students did web-scraping or API
calls to get their data. Since I - thanks to support by two TAs - never
got around to implement any scraping myself, a blog post feels like the
right way to catch up on this.&lt;/p&gt;
&lt;p&gt;After finishing last place in the &lt;a
href=&quot;https://www.worldcubeassociation.org/competitions/BerlinWinterCubing2020&quot;&gt;Berlin
Winter Cubing 2020&lt;/a&gt; competition, there was an acute need to sugarcoat
the result. The aim of the post is thus to substantiate that this last
place was purely due to lack of competitors. 😃 Since at the time of the
analysis, my results were not yet part of the &lt;a
href=&quot;https://www.worldcubeassociation.org/results/misc/export.html&quot;&gt;World
Cube Association (WCA) results database&lt;/a&gt;, the idea was to use
web-scraping from the live feed to pull my results and compare them to
the database. The resulting R code is available from &lt;a
href=&quot;https://raw.githubusercontent.com/hoehleatsu/hoehleatsu.github.io/master/_source/2020-01-22-wcascrape.Rmd&quot;&gt;github&lt;/a&gt;
and is described below.&lt;/p&gt;
&lt;h2 id=&quot;scraping-wca-live-results&quot;&gt;Scraping WCA live results&lt;/h2&gt;
&lt;p&gt;WCA competition results are reported live, i.e. as they are entered,
by a dynamically generated web page. Below is shown the round 1 results
of the &lt;a
href=&quot;%5D(https://live.worldcubeassociation.org/competitions/BerlinWinterCubing2020)&quot;&gt;Berlin
Winter Cubing2020&lt;/a&gt; competition. In case of the traditional Rubik’s
cube (aka. 3x3x3) event, one round of the competition consists of 5
solves. A trimmed mean is computed from the five solve times (aka. Ao5)
by removing the best and worst result and averaging the three remaining
results.&lt;/p&gt;
&lt;center&gt;
&lt;img src=&quot;/blog/figure/source/2020-01-22-wcascrape/liveresults.png&quot;&gt;
&lt;/center&gt;
&lt;p&gt;The data science job is now to automatically scrape the above results
as they become available. In other words dynamically generated pages are
to be scraped. The post &lt;a
href=&quot;https://thatdatatho.com/2019/01/22/tutorial-web-scraping-rselenium/&quot;&gt;RSelenium
Tutorial: A Tutorial to Basic Web Scraping With RSelenium&lt;/a&gt; provided
help here, including an explanation on how to change the &lt;a
href=&quot;https://sites.google.com/a/chromium.org/chromedriver/downloads&quot;&gt;web
driver version&lt;/a&gt; to match the installed Chrome version. The &lt;a
href=&quot;https://cran.r-project.org/web/packages/RSelenium/index.html&quot;&gt;&lt;code&gt;Rselenium&lt;/code&gt;&lt;/a&gt;
based scraping code to get the above table looks as follows.&lt;/p&gt;
&lt;!-- Note: Open ~/Programs/chromedriver --&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb1&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb1-1&quot;&gt;&lt;a href=&quot;#cb1-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;library&lt;/span&gt;(RSelenium)&lt;/span&gt;
&lt;span id=&quot;cb1-2&quot;&gt;&lt;a href=&quot;#cb1-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;driver &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;rsDriver&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;browser =&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;c&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;quot;chrome&amp;quot;&lt;/span&gt;), &lt;span class=&quot;at&quot;&gt;chromever =&lt;/span&gt; &lt;span class=&quot;st&quot;&gt;&amp;quot;79.0.3945.36&amp;quot;&lt;/span&gt;, &lt;span class=&quot;at&quot;&gt;port =&lt;/span&gt; &lt;span class=&quot;dv&quot;&gt;4568&lt;/span&gt;&lt;span class=&quot;dt&quot;&gt;L&lt;/span&gt;)&lt;/span&gt;
&lt;span id=&quot;cb1-3&quot;&gt;&lt;a href=&quot;#cb1-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;remote_driver &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; driver[[&lt;span class=&quot;st&quot;&gt;&amp;quot;client&amp;quot;&lt;/span&gt;]] &lt;/span&gt;
&lt;span id=&quot;cb1-4&quot;&gt;&lt;a href=&quot;#cb1-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-5&quot;&gt;&lt;a href=&quot;#cb1-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;# Fetch WCA live results of the 3x3x3 round 1 from the Berlin Winter Cubing 2020 competition&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-6&quot;&gt;&lt;a href=&quot;#cb1-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;url &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;st&quot;&gt;&amp;quot;https://live.worldcubeassociation.org/competitions/BerlinWinterCubing2020/rounds/333-r1&amp;quot;&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-7&quot;&gt;&lt;a href=&quot;#cb1-7&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;remote_driver&lt;span class=&quot;sc&quot;&gt;$&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;navigate&lt;/span&gt;(url)&lt;/span&gt;
&lt;span id=&quot;cb1-8&quot;&gt;&lt;a href=&quot;#cb1-8&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-9&quot;&gt;&lt;a href=&quot;#cb1-9&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;# Wait a little to make sure page has been generated.&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-10&quot;&gt;&lt;a href=&quot;#cb1-10&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;Sys.sleep&lt;/span&gt;(&lt;span class=&quot;dv&quot;&gt;5&lt;/span&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;The &lt;a
href=&quot;https://cran.r-project.org/web/packages/rvest/vignettes/selectorgadget.html&quot;&gt;&lt;code&gt;selectorgadget&lt;/code&gt;&lt;/a&gt;
bookmarklet was then used to find the css selector of the table
containing the results and the &lt;code&gt;rvest::html_table&lt;/code&gt; function
was used to extract the table as a &lt;code&gt;data.frame&lt;/code&gt;.&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb2&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb2-1&quot;&gt;&lt;a href=&quot;#cb2-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;library&lt;/span&gt;(rvest)&lt;/span&gt;
&lt;span id=&quot;cb2-2&quot;&gt;&lt;a href=&quot;#cb2-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb2-3&quot;&gt;&lt;a href=&quot;#cb2-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;# Extract table with all results from round 1&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb2-4&quot;&gt;&lt;a href=&quot;#cb2-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;results &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; remote_driver&lt;span class=&quot;sc&quot;&gt;$&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;getPageSource&lt;/span&gt;() &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; .[[&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;]] &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;read_html&lt;/span&gt;() &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;/span&gt;
&lt;span id=&quot;cb2-5&quot;&gt;&lt;a href=&quot;#cb2-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;html_nodes&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;css =&lt;/span&gt; &lt;span class=&quot;st&quot;&gt;&amp;quot;.MuiTable-root&amp;quot;&lt;/span&gt;) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;html_table&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;header=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; .[[&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;]] &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;as_tibble&lt;/span&gt;()&lt;/span&gt;
&lt;span id=&quot;cb2-6&quot;&gt;&lt;a href=&quot;#cb2-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb2-7&quot;&gt;&lt;a href=&quot;#cb2-7&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;# Small helper function to parse WCA results with lubridate, i.e. add &amp;quot;0:&amp;quot; if no minutes.&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb2-8&quot;&gt;&lt;a href=&quot;#cb2-8&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;time_2_ms &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;cf&quot;&gt;function&lt;/span&gt;(x) { &lt;span class=&quot;fu&quot;&gt;if_else&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;str_detect&lt;/span&gt;(x, &lt;span class=&quot;st&quot;&gt;&amp;quot;:&amp;quot;&lt;/span&gt;),  x, &lt;span class=&quot;fu&quot;&gt;str_c&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;quot;0:&amp;quot;&lt;/span&gt;, x)) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; lubridate&lt;span class=&quot;sc&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;ms&lt;/span&gt;() }&lt;/span&gt;
&lt;span id=&quot;cb2-9&quot;&gt;&lt;a href=&quot;#cb2-9&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb2-10&quot;&gt;&lt;a href=&quot;#cb2-10&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;# Convert reported timings to lubridate periods &lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb2-11&quot;&gt;&lt;a href=&quot;#cb2-11&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;my_results &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; results &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;filter&lt;/span&gt;(Name &lt;span class=&quot;sc&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;st&quot;&gt;&amp;quot;Michael Höhle&amp;quot;&lt;/span&gt;) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb2-12&quot;&gt;&lt;a href=&quot;#cb2-12&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;mutate_at&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;vars&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;at&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;`&lt;/span&gt;,&lt;span class=&quot;st&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;at&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;`&lt;/span&gt;,&lt;span class=&quot;st&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;at&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;`&lt;/span&gt;,&lt;span class=&quot;st&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;at&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;`&lt;/span&gt;,&lt;span class=&quot;st&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;at&quot;&gt;5&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;`&lt;/span&gt;,&lt;span class=&quot;st&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;at&quot;&gt;Average&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;`&lt;/span&gt;,&lt;span class=&quot;st&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;at&quot;&gt;Best&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;`&lt;/span&gt;), &lt;span class=&quot;at&quot;&gt;.funs=&lt;/span&gt; &lt;span class=&quot;sc&quot;&gt;~&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;time_2_ms&lt;/span&gt;(.))&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;In other words, my first (and as of today only) official 3x3x3
average is 1M 18.05S which corresponds to 7805 centiseconds. This is
much better than the 3 minutes anticipated in my &lt;a
href=&quot;http://staff.math.su.se/hoehle/blog/2019/05/06/wcamining.html&quot;&gt;analysis
from May 2019&lt;/a&gt; and was well under the 4:00 time limit of the round.
Still, I finished last place in the 3x3x3 competition (rank 84/84).
However, the competition was in no way representative of my peer group
(senior newbie cubers) as, for example, number 1, 3 and 7 of the &lt;a
href=&quot;https://www.worldcubeassociation.org/competitions/WC2019/results/all?event=333&quot;&gt;World
Championship 2019&lt;/a&gt; also competed.&lt;/p&gt;
&lt;p&gt;The aim of this post is thus to use a data based approach to alter
the sampling frame of the comparison in order to make the comparison
more relevant (aka. sugarcoating):&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;How does my result rank within the population of German first time
competitors?&lt;/li&gt;
&lt;li&gt;How does my result rank within the population of age 40+
cubers?&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&quot;german-first-time-competitors&quot;&gt;German first time
competitors&lt;/h3&gt;
&lt;p&gt;The &lt;a
href=&quot;https://www.worldcubeassociation.org/results/misc/export.html&quot;&gt;WCA
results database&lt;/a&gt; is used to determine all 3x3x3 results by German
cubers a shown in the previous &lt;a
href=&quot;http://staff.math.su.se/hoehle/blog/2019/05/06/wcamining.html&quot;&gt;Speedmining
the Cubing Community with dbplyr&lt;/a&gt; post. We perform a comparison with
the round 1 results of all German first time 3x3x3 competitors within
the last 5 years.&lt;/p&gt;
&lt;p&gt;This gives us 1024 cubers to compare with and constitutes a more
relevant population of comparison than, e.g., podium contestants from
World’s 2019. The plot below shows the cumulative distribution of the
Ao5 the cubers got in round 1 of their first competition. Given a value
on the x-axis, the y-axis denotes the proportion of cubers which
obtained an average lower or equal to the selected value.&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/blog/figure/source/2020-01-22-wcascrape/CDFNEWBIE-1.png&quot; style=&quot;display: block; margin: auto;&quot; /&gt;&lt;/p&gt;
&lt;p&gt;From the graph it becomes clear that my time corresponds to the 94.34
percentile of the distribution, i.e. 94% of the 5 last years German
first time competitors had an average better than me in their first
competition. This means that the performance was just about within 95%
percentile of German competition newbies. Yay!&lt;/p&gt;
&lt;p&gt;How do these cubers evolve after their first competition? I was
particularly interested in the trajectory of cubers within my skill
bracket, which here shall be defined as an average located between my
best and worst solve time of the round, i.e. 65.24s and 105.12s.&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/blog/figure/source/2020-01-22-wcascrape/TRAJPLOT-1.png&quot; style=&quot;display: block; margin: auto;&quot; /&gt;&lt;/p&gt;
&lt;p&gt;In the figure, the two horizontal lines indicate the limits of the
skill bracket and the cross denotes my average. A smooth line is fitted
to the longitudinal data, due to simplicity the smoothed fit does not
take the longitudinal data structure and the drop-out mechanisms into
account. By focusing on the cohort of cubers starting to compete within
the last 5 years induces censoring: Cubers who started with competitions
for example 1 years ago, will not be able to have results more than 1
years back in time. Still, a clear downward trend is visible, if the
cuber goes to further cubing competitions. However, only 25% of the
first time cubers have a second competition recorded in the data.
Somewhat demotivating is to see that only 3 out of the 84 first time
cubers in the skill bracket manage to obtain a sub-30s average at a
later stage.&lt;/p&gt;
&lt;h3 id=&quot;comparing-with-senior-cubers&quot;&gt;Comparing with senior cubers&lt;/h3&gt;
&lt;p&gt;&lt;a href=&quot;https://www.speedsolving.com/members/logiqx.17180/&quot;&gt;Michael
George&lt;/a&gt; maintains an &lt;a
href=&quot;https://logiqx.github.io/wca-ipy-www/&quot;&gt;unofficial ranking for the
senior cubing community&lt;/a&gt; based on the WCA results database and a
voluntary registration of senior cubers. As in other sports disciplines,
“senior” is defined as aged 40+. Based on a one-time anonymised extract
from the WCA database containing the true age of the cuber, the
completeness of the self-report sample as well as a statistical
extrapolation of the true rank within the WCA 40+ population can be
computed: Around 30% of the senior cubers are contained in the
self-reported sample. The WCA id as well a personal records of all
self-reported “old-cubers” is available in &lt;a
href=&quot;https://en.wikipedia.org/wiki/JSON&quot;&gt;JSON format&lt;/a&gt;’ish format and
can be scraped using the &lt;a
href=&quot;https://cran.r-project.org/web/packages/httr/index.html&quot;&gt;&lt;code&gt;httr&lt;/code&gt;&lt;/a&gt;
package.&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb3&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb3-1&quot;&gt;&lt;a href=&quot;#cb3-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;response &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; httr&lt;span class=&quot;sc&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;GET&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;quot;https://logiqx.github.io/wca-ipy-www/data/Senior_Rankings.js&amp;quot;&lt;/span&gt;) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;/span&gt;
&lt;span id=&quot;cb3-2&quot;&gt;&lt;a href=&quot;#cb3-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  httr&lt;span class=&quot;sc&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;content&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;as=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;text&amp;quot;&lt;/span&gt;) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;/span&gt;
&lt;span id=&quot;cb3-3&quot;&gt;&lt;a href=&quot;#cb3-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;str_replace&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;quot;rankings =&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;\n&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;&lt;/span&gt;, &lt;span class=&quot;st&quot;&gt;&amp;quot;&amp;quot;&lt;/span&gt;) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;/span&gt;
&lt;span id=&quot;cb3-4&quot;&gt;&lt;a href=&quot;#cb3-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  jsonlite&lt;span class=&quot;sc&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;fromJSON&lt;/span&gt;()&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;From the response we can extract the WCA id of the self-reported
senior cubers, which we then match to the WCA database to get their
round 1 result at their first cubing competition. Note: This is a slight
approximation to the population of relevance, because the cubers could
have been younger than 40 at the time of their first WCA average.
Furthermore, note also the cohort effects as cubing times in general
have declined, e.g., due to better hardware.&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb4&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb4-1&quot;&gt;&lt;a href=&quot;#cb4-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;# WCA IDs of the senior cubers&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-2&quot;&gt;&lt;a href=&quot;#cb4-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;ids &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; response&lt;span class=&quot;sc&quot;&gt;$&lt;/span&gt;persons &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;pull&lt;/span&gt;(id) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;unique&lt;/span&gt;()&lt;/span&gt;
&lt;span id=&quot;cb4-3&quot;&gt;&lt;a href=&quot;#cb4-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt; &lt;/span&gt;
&lt;span id=&quot;cb4-4&quot;&gt;&lt;a href=&quot;#cb4-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;# Extract all WCA 3x3x3 results of these senior cubers and restrict to their first&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-5&quot;&gt;&lt;a href=&quot;#cb4-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;# competition result.&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-6&quot;&gt;&lt;a href=&quot;#cb4-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;first_senior &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; detailed_results &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;filter&lt;/span&gt;(personId &lt;span class=&quot;sc&quot;&gt;%in%&lt;/span&gt; ids) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;/span&gt;
&lt;span id=&quot;cb4-7&quot;&gt;&lt;a href=&quot;#cb4-7&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;group_by&lt;/span&gt;(personId) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;/span&gt;
&lt;span id=&quot;cb4-8&quot;&gt;&lt;a href=&quot;#cb4-8&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;arrange&lt;/span&gt;(date,roundTypeId) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;/span&gt;
&lt;span id=&quot;cb4-9&quot;&gt;&lt;a href=&quot;#cb4-9&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;filter&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;row_number&lt;/span&gt;() &lt;span class=&quot;sc&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;/span&gt;
&lt;span id=&quot;cb4-10&quot;&gt;&lt;a href=&quot;#cb4-10&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  ungroup&lt;/span&gt;
&lt;span id=&quot;cb4-11&quot;&gt;&lt;a href=&quot;#cb4-11&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-12&quot;&gt;&lt;a href=&quot;#cb4-12&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;# Percentile in the first comp average of senior cubers&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-13&quot;&gt;&lt;a href=&quot;#cb4-13&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;senior_percentile__first_average &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;ecdf&lt;/span&gt;(first_senior &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;pull&lt;/span&gt;(average))(my_avg_333)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;From this it becomes clear that my average is located at the 70%
percentile of the first competition result of (self-reported) senior
cubers. Not so bad at all. How do comparable senior cubers evolve over
time? The graphic below shows how the senior 289 cubers, who
participated in their first competition within the last 5 years, evolved
over time.&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/blog/figure/source/2020-01-22-wcascrape/SENIORTRAJ-1.png&quot; style=&quot;display: block; margin: auto;&quot; /&gt;&lt;/p&gt;
&lt;p&gt;About 81% of these senior cubers attended more than one competition,
which is a higher proportion than in the overall cubing population, but
is likely to be explained by the sampling bias of senior cubers having
to self-report. Smoothed mean tendencies in 5 skill brackets,
i.e. cohorts of [0,30), [30, 60), [60, 90) and [90, 120) seconds Ao5 in
their first competition, are computed and visualized. The cross
indicates my Ao5 result. Interpretation of these curves is again
complicated by drop-out processes and cohort effects. Still the curves
show that if I stick to cubing, I have a good chance at becoming sub-50,
maybe even sub-40, within one year!&lt;/p&gt;
&lt;h2 id=&quot;discussion&quot;&gt;Discussion&lt;/h2&gt;
&lt;p&gt;It’s only logical and in the nature of competitions that somebody has
to finish last. From my previous analysis I knew this would be a risk,
but being both the age and skill outlier is still a bit of a party
pooper. On the positive side: Signing up for a competition helped me
shuffle some time free to practice, I learned how a competition works,
saw no. 1,3 and 7 from the World’s 2019 final in action and got to judge
other cubers. The statistical analyses in this post show that, by
rectifying the sampling frame to a more comparable group, results are
not so bad at all. 😃&lt;/p&gt;
&lt;h4 id=&quot;technical-note&quot;&gt;Technical note&lt;/h4&gt;
&lt;p&gt;I cube with a stickerless YuXin Little Magic using CFOP (F2L+4LL
accelerated with additional PLL algos). My 3x3x3 PBs at home are 46.19
(single) and 58.10 (Ao5) with scrambles generated by &lt;a
href=&quot;cstimer.net&quot;&gt;cstimer&lt;/a&gt;. This illustrates that a competition, in
terms of pressure, is something else than cubing relaxed at home. In one
of the attempts I failed the T-perm twice - despite having made a &lt;a
href=&quot;https://mt5013-ht19.github.io/HW/HW4.html&quot;&gt;regular expression
exercise&lt;/a&gt; for it as part of the course…&lt;/p&gt;
&lt;center&gt;
&lt;img src=&quot;/blog/figure/source/2020-01-22-wcascrape/toolset_small.jpg&quot; width=&quot;550&quot;&gt;
&lt;/center&gt;
&lt;h2 id=&quot;acknowledgments&quot;&gt;Acknowledgments&lt;/h2&gt;
&lt;p&gt;The terms of use of the WCA database requests any use of it to be
equipped with the following text:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;This information is based on competition results owned and maintained
by the World Cube Association, published at
https://worldcubeassociation.org/results as of Jan 22, 2020.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;Besides this formal note, I thank the WCA Results Team for providing
the WCA data for download in this comprehensive form! Also thanks to &lt;a
href=&quot;https://www.speedsolving.com/members/logiqx.17180/&quot;&gt;Michael
George&lt;/a&gt; for maintaining a database of senior cubers.&lt;/p&gt;
&lt;h2 id=&quot;literature&quot;&gt;Literature&lt;/h2&gt;
&lt;section id=&quot;footnotes&quot; class=&quot;footnotes footnotes-end-of-document&quot;
role=&quot;doc-endnotes&quot;&gt;
&lt;hr /&gt;
&lt;ol&gt;
&lt;li id=&quot;fn1&quot;&gt;&lt;p&gt;Original course development was done by &lt;a
href=&quot;https://www.su.se/profiles/mskold-1.187868&quot;&gt;Martin Sköld&lt;/a&gt; in
2018-2019.&lt;a href=&quot;#fnref1&quot; class=&quot;footnote-back&quot;
role=&quot;doc-backlink&quot;&gt;↩︎&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;/section&gt;
</description>
        <pubDate>Wed, 22 Jan 2020 00:00:00 +0100</pubDate>
        <link>https://mhoehle.github.io/blog/2020/01/22/wcascrape.html</link>
        <guid isPermaLink="true">https://mhoehle.github.io/blog/2020/01/22/wcascrape.html</guid>
        
        <category>rstats</category>
        
        <category>dataviz</category>
        
        <category>data science</category>
        
        <category>tidyverse</category>
        
        <category>Rubik&apos;s cube</category>
        
        <category>3x3x3</category>
        
        <category>speedsolving</category>
        
        
      </item>
    
      <item>
        <title>Speedmining the Cubing Community with dbplyr</title>
        <description>&lt;h2 id=&quot;abstract&quot;&gt;Abstract:&lt;/h2&gt;
&lt;p&gt;We use the &lt;code&gt;RMariaDB&lt;/code&gt; and &lt;code&gt;dbplyr&lt;/code&gt; packages to
analyze the results database of the World Cubing Association. In
particular we are interested in finding unofficial world records of
fastest 3x3x3 solves, countries with large proportion of female cubers
as well as acceptable solving times before entering a WCA
competition.&lt;/p&gt;
&lt;center&gt;
&lt;img src=&quot;/blog/figure/source/2019-05-06-wcamining/QUANTILEAVG-1.png&quot; width=&quot;550&quot;&gt;
&lt;/center&gt;
&lt;p&gt;&lt;br&gt;
&lt;a rel=&quot;license&quot; href=&quot;http://creativecommons.org/licenses/by-sa/4.0/&quot;&gt;&lt;img alt=&quot;Creative Commons License&quot; style=&quot;border-width:0&quot; src=&quot;https://i.creativecommons.org/l/by-sa/4.0/88x31.png&quot;/&gt;&lt;/a&gt;
This work is licensed under a &lt;a rel=&quot;license&quot;
href=&quot;http://creativecommons.org/licenses/by-sa/4.0/&quot;&gt;Creative Commons
Attribution-ShareAlike 4.0 International License&lt;/a&gt;. The
markdown+Rknitr source code of this blog is available under a &lt;a
href=&quot;https://www.gnu.org/licenses/gpl-3.0.html&quot;&gt;GNU General Public
License (GPL v3)&lt;/a&gt; license from github.&lt;/p&gt;
&lt;h2 id=&quot;motivation&quot;&gt;Motivation&lt;/h2&gt;
&lt;p&gt;An item on my bucket list of
irrelevant-things-to-excel-in-during-parental-leave™ is to solve the
Rubik’s cube again. In 2013 I learned the &lt;a
href=&quot;http://starlingsroost.asuscomm.com/cubestation/index.php?page=3x3x3/beginner/step1&quot;&gt;&lt;strong&gt;beginner’s
method&lt;/strong&gt;&lt;/a&gt; for solving the cube by reading &lt;a
href=&quot;https://www.speedsolving.com/wiki/index.php/Dan_Harris&quot;&gt;Dan
Harris’&lt;/a&gt; &lt;em&gt;Speedsolving the Cube&lt;/em&gt; book. However, any attempts
to improve times by learning &lt;a
href=&quot;https://en.wikipedia.org/wiki/CFOP_Method&quot;&gt;CFOP&lt;/a&gt; failed
miserably in 2013 due to lack of time. So in this 2019 attempt I just
try to revoke my beginner’s method and improve it slightly by &lt;a
href=&quot;https://www.cubeskills.com/tutorials/4-look-last-layer&quot;&gt;4LL&lt;/a&gt;.
Nevertheless, my solves fluctuate at 120-180s. This has made me worry
about the shame-factor of pulling through the next item on the bucket
list: competing in a &lt;a
href=&quot;https://www.worldcubeassociation.org&quot;&gt;World Cubing Association
(WCA)&lt;/a&gt; 3x3x3 competition. The motivating question of this post is
therefore: how large a &lt;strong&gt;skill outlier&lt;/strong&gt; would one be at
such a competition with, say, an 180s average?&lt;/p&gt;
&lt;h2 id=&quot;mining-the-world-cubing-association-database&quot;&gt;Mining the World
Cubing Association Database&lt;/h2&gt;
&lt;p&gt;Luckily, the WCA provides the results of all cubers and competitions
in a &lt;a
href=&quot;https://www.worldcubeassociation.org/results/misc/export.html&quot;&gt;downloadable
SQL database&lt;/a&gt; (400 MB mySQL/MariaDB SQL text file). The downloadable
version of 19 Apr 2019 contains tables with information on all 124,997
players, 6,014 competitions as well as the 2,130,374 results obtained by
players in competitions starting with the &lt;a
href=&quot;https://www.youtube.com/watch?v=m4qoeJMPv0Y&quot;&gt;Rubik’s Cube World
Championship in 1982&lt;/a&gt;. Not &lt;strong&gt;big data&lt;/strong&gt;, but big enough
and structured in a way that justifies using a SQL database backend for
the analysis instead of just a flat &lt;code&gt;data.frame&lt;/code&gt; in R.&lt;/p&gt;
&lt;p&gt;With a little bit of effort, one installs a &lt;a
href=&quot;https://mariadb.org&quot;&gt;MariaDB&lt;/a&gt; together with the &lt;a
href=&quot;https://downloads.mariadb.org/connector-c/&quot;&gt;MariaDB
Connector/C&lt;/a&gt; and imports the WCA data into the database.
Subsequently, the &lt;code&gt;RMariaDB&lt;/code&gt; &lt;span class=&quot;citation&quot;
data-cites=&quot;rmariadb&quot;&gt;(Müller et al. 2018)&lt;/span&gt; and &lt;code&gt;DBI&lt;/code&gt;
&lt;span class=&quot;citation&quot; data-cites=&quot;DBI&quot;&gt;(R Special Interest Group on
Databases (R-SIG-DB), Wickham, and Müller 2018)&lt;/span&gt; R packages allow
one to connect directly to the DB. Furthermore, the &lt;code&gt;dbplyr&lt;/code&gt;
&lt;span class=&quot;citation&quot; data-cites=&quot;dbplyr&quot;&gt;(Wickham and Ruiz
2019)&lt;/span&gt; package allows one to write &lt;code&gt;dplyr&lt;/code&gt; code, which
is then translated into and evaluated as SQL queries behind the
scenes.&lt;/p&gt;
&lt;p&gt;We connect to the database as follows:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb1&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb1-1&quot;&gt;&lt;a href=&quot;#cb1-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;library&lt;/span&gt;(DBI)&lt;/span&gt;
&lt;span id=&quot;cb1-2&quot;&gt;&lt;a href=&quot;#cb1-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;library&lt;/span&gt;(RMariaDB)&lt;/span&gt;
&lt;span id=&quot;cb1-3&quot;&gt;&lt;a href=&quot;#cb1-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;con &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; DBI&lt;span class=&quot;sc&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;dbConnect&lt;/span&gt;(RMariaDB&lt;span class=&quot;sc&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;MariaDB&lt;/span&gt;(), &lt;span class=&quot;at&quot;&gt;group=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;my-db&amp;quot;&lt;/span&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;where, as suggested in the &lt;a
href=&quot;https://mariadb.com/kb/en/library/configuring-mariadb-with-option-files/&quot;&gt;&lt;code&gt;RMariaDB&lt;/code&gt;
package documentation&lt;/a&gt;, &lt;code&gt;my-db&lt;/code&gt; is a custom group defined
in the option file &lt;code&gt;~/my.cnf&lt;/code&gt; containing the user, password,
protocol type and the database to use (&lt;code&gt;wca&lt;/code&gt;). This is
preferred instead of calling &lt;code&gt;dbConnect&lt;/code&gt; with options such as
&lt;code&gt;socket&lt;/code&gt;, &lt;code&gt;user&lt;/code&gt;, &lt;code&gt;password&lt;/code&gt; and
&lt;code&gt;dbname&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;To import the data one can either open a &lt;code&gt;mysql&lt;/code&gt; shell and
type SQL commands or send the SQL query from R to the database:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb2&quot;&gt;&lt;pre
class=&quot;sourceCode sql&quot;&gt;&lt;code class=&quot;sourceCode sql&quot;&gt;&lt;span id=&quot;cb2-1&quot;&gt;&lt;a href=&quot;#cb2-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kw&quot;&gt;SOURCE&lt;/span&gt; WCA_export.sql;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;After such an import we can view the contents of the database:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb3&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb3-1&quot;&gt;&lt;a href=&quot;#cb3-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;dbListTables&lt;/span&gt;(con)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;##  [1] &amp;quot;eligible_country_iso2s_for_championship&amp;quot; &amp;quot;Formats&amp;quot;                                 &amp;quot;Countries&amp;quot;                              
##  [4] &amp;quot;RoundTypes&amp;quot;                              &amp;quot;Rounds&amp;quot;                                  &amp;quot;Competitions&amp;quot;                           
##  [7] &amp;quot;Continents&amp;quot;                              &amp;quot;Persons&amp;quot;                                 &amp;quot;championships&amp;quot;                          
## [10] &amp;quot;Events&amp;quot;                                  &amp;quot;Scrambles&amp;quot;                               &amp;quot;RanksAverage&amp;quot;                           
## [13] &amp;quot;Results&amp;quot;                                 &amp;quot;RanksSingle&amp;quot;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Of particular interest is the &lt;code&gt;Results&lt;/code&gt; table, where each
row contains the results of a player (&lt;code&gt;personId&lt;/code&gt;) in a round
of a WCA competition of events such as the 2x2x2, 3x3x3, 4x4x4, etc. For
the &lt;a
href=&quot;https://www.worldcubeassociation.org/files/WCA_Competition_Tutorial.pdf&quot;&gt;3x3x3
event&lt;/a&gt; each round consist of five solves solves
(&lt;code&gt;values1&lt;/code&gt;-&lt;code&gt;values5&lt;/code&gt;) of which the best is
reported in the column &lt;code&gt;best&lt;/code&gt; and the trimmed mean (removing
the best and worst solve and computing the mean of the three other
solves) is reported in the column &lt;code&gt;average&lt;/code&gt;.&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;##  [1] &amp;quot;competitionId&amp;quot;         &amp;quot;eventId&amp;quot;               &amp;quot;roundTypeId&amp;quot;           &amp;quot;pos&amp;quot;                   &amp;quot;best&amp;quot;                  &amp;quot;average&amp;quot;              
##  [7] &amp;quot;personName&amp;quot;            &amp;quot;personId&amp;quot;              &amp;quot;personCountryId&amp;quot;       &amp;quot;formatId&amp;quot;              &amp;quot;value1&amp;quot;                &amp;quot;value2&amp;quot;               
## [13] &amp;quot;value3&amp;quot;                &amp;quot;value4&amp;quot;                &amp;quot;value5&amp;quot;                &amp;quot;regionalSingleRecord&amp;quot;  &amp;quot;regionalAverageRecord&amp;quot;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Furthermore, the table &lt;code&gt;Persons&lt;/code&gt;contains additional basic
information about each player:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;## [1] &amp;quot;id&amp;quot;        &amp;quot;subid&amp;quot;     &amp;quot;name&amp;quot;      &amp;quot;countryId&amp;quot; &amp;quot;gender&amp;quot;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Note: At WCA competitions there is no separate ranking according to
gender.&lt;/p&gt;
&lt;p&gt;After getting initially acquainted with the database, we do two small
SQL-side modifications. The first modification is to create an index for
the tables, which will help to substantially reduce the join times later
on. The second is to merge the separate year, month, day columns of the
event day in the &lt;code&gt;Competitions&lt;/code&gt; table into a single ISO 8601
date. See the &lt;a
href=&quot;https://raw.githubusercontent.com/hoehleatsu/hoehleatsu.github.io/master/_source/2019-05-06-wcamining.Rmd&quot;&gt;github
code&lt;/a&gt; for details.&lt;/p&gt;
&lt;p&gt;As the next step we create tables to use with &lt;code&gt;dbplyr&lt;/code&gt;.
These will then just dispatch to the database tables. For now, we work
only with the results of the 3x3x3 cubes, but will join the Results,
Persons and Competitions table in order to get relevant information
about gender of the person as well as date of the solve together with
the time of each solve.&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb7&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb7-1&quot;&gt;&lt;a href=&quot;#cb7-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;suppressPackageStartupMessages&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;library&lt;/span&gt;(dbplyr))&lt;/span&gt;
&lt;span id=&quot;cb7-2&quot;&gt;&lt;a href=&quot;#cb7-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;suppressPackageStartupMessages&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;library&lt;/span&gt;(dplyr))&lt;/span&gt;
&lt;span id=&quot;cb7-3&quot;&gt;&lt;a href=&quot;#cb7-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb7-4&quot;&gt;&lt;a href=&quot;#cb7-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;results &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;tbl&lt;/span&gt;(con, &lt;span class=&quot;st&quot;&gt;&amp;quot;Results&amp;quot;&lt;/span&gt;) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;filter&lt;/span&gt;(eventId &lt;span class=&quot;sc&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;st&quot;&gt;&amp;quot;333&amp;quot;&lt;/span&gt;)&lt;/span&gt;
&lt;span id=&quot;cb7-5&quot;&gt;&lt;a href=&quot;#cb7-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;persons &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;tbl&lt;/span&gt;(con, &lt;span class=&quot;st&quot;&gt;&amp;quot;Persons&amp;quot;&lt;/span&gt;)&lt;/span&gt;
&lt;span id=&quot;cb7-6&quot;&gt;&lt;a href=&quot;#cb7-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;competitions &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;tbl&lt;/span&gt;(con, &lt;span class=&quot;st&quot;&gt;&amp;quot;Competitions2&amp;quot;&lt;/span&gt;)&lt;/span&gt;
&lt;span id=&quot;cb7-7&quot;&gt;&lt;a href=&quot;#cb7-7&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb7-8&quot;&gt;&lt;a href=&quot;#cb7-8&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##JOIN the three tables together&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb7-9&quot;&gt;&lt;a href=&quot;#cb7-9&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;allResults &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; results &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;inner_join&lt;/span&gt;(persons, &lt;span class=&quot;at&quot;&gt;by=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;c&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;quot;personId&amp;quot;&lt;/span&gt;&lt;span class=&quot;ot&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;id&amp;quot;&lt;/span&gt;)) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb7-10&quot;&gt;&lt;a href=&quot;#cb7-10&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;inner_join&lt;/span&gt;(competitions, &lt;span class=&quot;at&quot;&gt;by=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;c&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;quot;competitionId&amp;quot;&lt;/span&gt;&lt;span class=&quot;ot&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;id&amp;quot;&lt;/span&gt;))&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Note that &lt;code&gt;dbplyr&lt;/code&gt; uses lazy evaluation, i.e. calls are
not executed before needed. However, one can with
&lt;code&gt;show_query&lt;/code&gt; check the SQL call, which is used in case of
evaluation. In this example the SQL query to get the results of female
cubers, i.e.:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb8&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb8-1&quot;&gt;&lt;a href=&quot;#cb8-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;fwr_single &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; allResults &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;filter&lt;/span&gt;(gender &lt;span class=&quot;sc&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;st&quot;&gt;&amp;quot;f&amp;quot;&lt;/span&gt;, best&lt;span class=&quot;sc&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;0&lt;/span&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;in SQL looks like&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb9&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb9-1&quot;&gt;&lt;a href=&quot;#cb9-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;fwr_single &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;show_query&lt;/span&gt;()&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;## &amp;lt;SQL&amp;gt;
## SELECT *
## FROM (SELECT `LHS`.`competitionId` AS `competitionId`, `LHS`.`eventId` AS `eventId`, `LHS`.`roundTypeId` AS `roundTypeId`, `LHS`.`pos` AS `pos`, `LHS`.`best` AS `best`, `LHS`.`average` AS `average`, `LHS`.`personName` AS `personName`, `LHS`.`personId` AS `personId`, `LHS`.`personCountryId` AS `personCountryId`, `LHS`.`formatId` AS `formatId`, `LHS`.`value1` AS `value1`, `LHS`.`value2` AS `value2`, `LHS`.`value3` AS `value3`, `LHS`.`value4` AS `value4`, `LHS`.`value5` AS `value5`, `LHS`.`regionalSingleRecord` AS `regionalSingleRecord`, `LHS`.`regionalAverageRecord` AS `regionalAverageRecord`, `LHS`.`subid` AS `subid`, `LHS`.`name` AS `name.x`, `LHS`.`countryId` AS `countryId.x`, `LHS`.`gender` AS `gender`, `RHS`.`name` AS `name.y`, `RHS`.`cityName` AS `cityName`, `RHS`.`countryId` AS `countryId.y`, `RHS`.`information` AS `information`, `RHS`.`year` AS `year`, `RHS`.`month` AS `month`, `RHS`.`day` AS `day`, `RHS`.`endMonth` AS `endMonth`, `RHS`.`endDay` AS `endDay`, `RHS`.`eventSpecs` AS `eventSpecs`, `RHS`.`wcaDelegate` AS `wcaDelegate`, `RHS`.`organiser` AS `organiser`, `RHS`.`venue` AS `venue`, `RHS`.`venueAddress` AS `venueAddress`, `RHS`.`venueDetails` AS `venueDetails`, `RHS`.`external_website` AS `external_website`, `RHS`.`cellName` AS `cellName`, `RHS`.`latitude` AS `latitude`, `RHS`.`longitude` AS `longitude`, `RHS`.`date` AS `date`
## FROM (SELECT `LHS`.`competitionId` AS `competitionId`, `LHS`.`eventId` AS `eventId`, `LHS`.`roundTypeId` AS `roundTypeId`, `LHS`.`pos` AS `pos`, `LHS`.`best` AS `best`, `LHS`.`average` AS `average`, `LHS`.`personName` AS `personName`, `LHS`.`personId` AS `personId`, `LHS`.`personCountryId` AS `personCountryId`, `LHS`.`formatId` AS `formatId`, `LHS`.`value1` AS `value1`, `LHS`.`value2` AS `value2`, `LHS`.`value3` AS `value3`, `LHS`.`value4` AS `value4`, `LHS`.`value5` AS `value5`, `LHS`.`regionalSingleRecord` AS `regionalSingleRecord`, `LHS`.`regionalAverageRecord` AS `regionalAverageRecord`, `RHS`.`subid` AS `subid`, `RHS`.`name` AS `name`, `RHS`.`countryId` AS `countryId`, `RHS`.`gender` AS `gender`
## FROM (SELECT *
## FROM `Results`
## WHERE (`eventId` = &amp;#39;333&amp;#39;)) `LHS`
## INNER JOIN `Persons` AS `RHS`
## ON (`LHS`.`personId` = `RHS`.`id`)
## ) `LHS`
## INNER JOIN `Competitions2` AS `RHS`
## ON (`LHS`.`competitionId` = `RHS`.`id`)
## ) `dbplyr_001`
## WHERE ((`gender` = &amp;#39;f&amp;#39;) AND (`best` &amp;gt; 0.0))&lt;/code&gt;&lt;/pre&gt;
&lt;h2 id=&quot;analysing-the-data&quot;&gt;Analysing the data&lt;/h2&gt;
&lt;p&gt;We are now all ready to perform some descriptive analyses of the
data. The top-5 females according to their time for 3x3x3 single solve
is obtained by:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb11&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb11-1&quot;&gt;&lt;a href=&quot;#cb11-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;fwr_single &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb11-2&quot;&gt;&lt;a href=&quot;#cb11-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;group_by&lt;/span&gt;(personId) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;top_n&lt;/span&gt;(&lt;span class=&quot;sc&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;, best) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; ungroup &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb11-3&quot;&gt;&lt;a href=&quot;#cb11-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;arrange&lt;/span&gt;(best) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb11-4&quot;&gt;&lt;a href=&quot;#cb11-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;select&lt;/span&gt;(competitionId, personName, personCountryId, best, date) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb11-5&quot;&gt;&lt;a href=&quot;#cb11-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;top_n&lt;/span&gt;(&lt;span class=&quot;sc&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;5&lt;/span&gt;, best)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;## # Source:     lazy query [?? x 5]
## # Database:   mysql 10.3.14-MariaDB-log [hoehle@localhost:/wca]
## # Ordered by: best
##   competitionId         personName          personCountryId  best date      
##   &amp;lt;chr&amp;gt;                 &amp;lt;chr&amp;gt;               &amp;lt;chr&amp;gt;           &amp;lt;int&amp;gt; &amp;lt;date&amp;gt;    
## 1 SlowNSteadySummer2017 Dana Yi             USA               537 2017-07-01
## 2 BarbyCubeOpen2018     Juliette Sébastien  France            581 2018-11-03
## 3 FruitSalad2018        Katie Hull          USA               606 2018-03-03
## 4 CubeduKorea2018       Yu Da-Hyun (유다현) Korea             629 2018-01-26
## 5 NewYorkCitySpring2018 Kymberlyn Calderon  USA               641 2018-04-21&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Note that the solve times are given in centiseconds (i.e. 1/100’th of
a second). The above result can be compare with the corresponding
information at &lt;a
href=&quot;https://wcadb.net/rankings.php?region=World&amp;amp;events=333&amp;amp;gender=female&amp;amp;show=100&amp;amp;type=single&quot;&gt;https://wcadb.net&lt;/a&gt;.&lt;/p&gt;
As professional data scientist one knows how important it is to
understand the data generating process and to know your data. So this is
how the 5.37s solve by Dana Yi in 2017 looks like:
&lt;p&gt;
&lt;center&gt;
&lt;iframe width=&quot;560&quot; height=&quot;315&quot; src=&quot;https://www.youtube.com/embed/WMd6JgC4DoQ&quot; frameborder=&quot;0&quot; allow=&quot;accelerometer; autoplay; encrypted-media; gyroscope;
picture-in-picture&quot; allowfullscreen&gt;
&lt;/iframe&gt;
&lt;/center&gt;
&lt;p&gt;
&lt;h3 id=&quot;the-evolution-of-the-3x3x3-single-solve-wr&quot;&gt;The evolution of the
3x3x3 single solve WR&lt;/h3&gt;
&lt;p&gt;So at this point we force an execution of the &lt;code&gt;allResults&lt;/code&gt;
query and cache the result as an object in R. This feels slightly
disappointing, because the hope was to leave the data in the database
management system (DBMS) as long as possible, but it felt like the most
efficient way to compute sequential ranks - however, it might have been
possible to perform the sequential rank directly using SQL statements,
although I did not succeed to find the correct approach within the
available time &lt;a href=&quot;#fn1&quot; class=&quot;footnote-ref&quot; id=&quot;fnref1&quot;
role=&quot;doc-noteref&quot;&gt;&lt;sup&gt;1&lt;/sup&gt;&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Instead, the results are sorted according to their date in R and
subsequently each result is checked to see if it’s sequential rank is 1,
i.e. whether the time is lower than all previous results. For this
purpose a fast Rcpp function &lt;code&gt;sequential_is_rank1&lt;/code&gt; function
is provided, which computes the sequential rank of a vector of values
(see &lt;a
href=&quot;https://raw.githubusercontent.com/hoehleatsu/hoehleatsu.github.io/master/_source/2019-05-06-wcamining.Rmd&quot;&gt;github
code&lt;/a&gt; for details). Note: If we had not pulled the data into R at
this point, such a computation within R would not have been
possible.&lt;/p&gt;
&lt;p&gt;The evolution of the world record for males and females over time is
then easily plotted. Note: As mentioned WCA doesn’t officially
distinguish between male and female results.&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/blog/figure/source/2019-05-06-wcamining/WREVO-1.png&quot; style=&quot;display: block; margin: auto;&quot; /&gt;
Is such a plot useful? Not really IMHO, but I had seen a similar plot at
the &lt;a
href=&quot;https://www.worldcubeassociation.org/results/misc/evolution/&quot;&gt;WCA
webpage&lt;/a&gt;, so it’s nice to be able to create it in R.&lt;/p&gt;
&lt;h3 id=&quot;countries-with-highest-proportion-of-female-cubers&quot;&gt;Countries
with highest proportion of female cubers&lt;/h3&gt;
&lt;p&gt;Since the overall fraction of female cubers is around 10%, we
determine the top-5 countries (with at least 50 cubers), having the
highest proportion of female cubers in the &lt;code&gt;Persons&lt;/code&gt;
database:&lt;/p&gt;
&lt;table class=&quot;table table-striped&quot; style=&quot;width: auto !important; margin-left: auto; margin-right: auto;&quot;&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th style=&quot;text-align:left;&quot;&gt;
countryId
&lt;/th&gt;
&lt;th style=&quot;text-align:right;&quot;&gt;
n_total
&lt;/th&gt;
&lt;th style=&quot;text-align:right;&quot;&gt;
n_male
&lt;/th&gt;
&lt;th style=&quot;text-align:right;&quot;&gt;
n_female
&lt;/th&gt;
&lt;th style=&quot;text-align:right;&quot;&gt;
frac_female (in %)
&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:left;&quot;&gt;
Algeria
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
157
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
103
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
54
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
34.4
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:left;&quot;&gt;
Mongolia
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
373
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
278
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
95
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
25.5
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:left;&quot;&gt;
Morocco
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
67
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
53
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
14
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
20.9
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:left;&quot;&gt;
Pakistan
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
54
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
42
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
12
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
22.2
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:left;&quot;&gt;
Tunisia
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
211
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
171
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
40
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
19.0
&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;
&lt;p&gt;I find this list quite surprising and also encouraging!&lt;/p&gt;
&lt;h3 id=&quot;skill-level-before-entering-a-wca-competition&quot;&gt;Skill level
before entering a WCA competition&lt;/h3&gt;
&lt;p&gt;Getting back to the motivating question of this post, we derive for
each result how experienced the cuber was at the time of obtaining the
result. We shall measure experience terms of years since the cuber’s
first WCA competition. Special interest will then be in results of
cubers in their very first WCA competition - see the &lt;a
href=&quot;https://raw.githubusercontent.com/hoehleatsu/hoehleatsu.github.io/master/_source/2019-05-06-wcamining.Rmd&quot;&gt;github
code&lt;/a&gt; for details.&lt;/p&gt;
&lt;p&gt;We then use this information to create a scatter plot with result
average (in seconds) and corresponding experience of the cuber (in
years). For better visualization we plot the marginal 5%, 10%, 50%, 90%,
95% quantiles as smooth function of experience - this is done with with
&lt;code&gt;ggplot2&lt;/code&gt;’s &lt;code&gt;geom_quantile&lt;/code&gt; function together with
the argument &lt;code&gt;method=&quot;rqss&quot;&lt;/code&gt;, which then uses the
&lt;code&gt;rqss&lt;/code&gt; function of the &lt;code&gt;quantreg&lt;/code&gt; package &lt;span
class=&quot;citation&quot; data-cites=&quot;quantreg&quot;&gt;(Koenker 2018)&lt;/span&gt; to compute
smooth quantile curves:&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/blog/figure/source/2019-05-06-wcamining/QUANTILEAVG-1.png&quot; style=&quot;display: block; margin: auto;&quot; /&gt;
We notice that the quantile curves stay more or less parallel, which is
indicative of a stable variance and skewness of the results over the
range of experiences. Focusing only on the round-1 results of those
participating for the first time in the period from 2018-04-19 to
2019-04-19 we see that the quantiles for the average is (in seconds)
are:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;##    5%   10%   50%   90%   95%   99% 99.9% 
##    16    19    36    77    93   136   208&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;This shows that with a 180s average one is located at the 99.7%
quantile of all cubers entering a WCA competition. In other words: if
the comfort zone is defined as &lt;strong&gt;being within the 95%
envelope&lt;/strong&gt;, then a ~90s average is needed before entering a WCA
competition.&lt;/p&gt;
&lt;p&gt;To further investigate, how cubers of that skill level evolve in
time, we study the solving skills of cubers entering their first WCA
competition with a solve time between 180s and 240s. In order to reduce
the potential effect of secular trends due to, e.g., better cubes, we
consider the skill evolution of the cohort of &lt;strong&gt;first time
cubers&lt;/strong&gt; from 2015 and onwards.&lt;/p&gt;
&lt;p&gt;The cohort inclusion criterion provide a total of 168 first time
competitors in this skill bracket. Only 28.0% of these cubers decide to
participate in further WCA competitions! The further development of the
averages of these cubers is best shown in a trajectory plot. Note that
the end of the lines does not necessarily mean that they stopped cubing,
instead it could be due to right truncation, because only competitions
until 2019-04-19 are available.&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/blog/figure/source/2019-05-06-wcamining/TRAJPLOT-1.png&quot; style=&quot;display: block; margin: auto;&quot; /&gt;
Instead of the trajectories we can also overlay an expectation smoother
on top of the data to see how the expected average progresses with time
in the cohort. Note, that this portrays the marginal expectation and
thus is only based on cubers, who are still cubing at that time. No
adjustment for any, potentially informative, drop-out is made.&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/blog/figure/source/2019-05-06-wcamining/TRAJSMOOTHED-1.png&quot; style=&quot;display: block; margin: auto;&quot; /&gt;&lt;/p&gt;
&lt;p&gt;From the figure we notice a rapid improvement the first 6 months
after entering the first WCA competition. Hereafter results only improve
slowly.&lt;/p&gt;
&lt;h2 id=&quot;discussion&quot;&gt;Discussion&lt;/h2&gt;
&lt;p&gt;Through analysis of the WCA results database it became clear that
participating in a 3x3x3 event with a 180s average &lt;del&gt;is uncool&lt;/del&gt;
&lt;a href=&quot;#fn2&quot; class=&quot;footnote-ref&quot; id=&quot;fnref2&quot;
role=&quot;doc-noteref&quot;&gt;&lt;sup&gt;2&lt;/sup&gt;&lt;/a&gt; does not take you to winners’
rostrum &lt;a href=&quot;#fn3&quot; class=&quot;footnote-ref&quot; id=&quot;fnref3&quot;
role=&quot;doc-noteref&quot;&gt;&lt;sup&gt;3&lt;/sup&gt;&lt;/a&gt;. The data also show that cubers
entering the world of WCA competitions with such an average are likely
to never participate in another WCA event. In case they do, their times
drop to 90-120s averages within 6 months after which they are stuck - it
is very unlikely that they will crack the 20s barrier. To conclude: In
my situation it seems wise to practice more, before going to the first
WCA competition. 😃&lt;/p&gt;
&lt;p&gt;From a data science perspective this post provided insights on using
&lt;code&gt;dbplyr&lt;/code&gt; as a tidyverse frontend for SQL queries. Being an
SQL novice, I learned that generating indexes is a &lt;em&gt;must&lt;/em&gt;, if you
do not want to wait forever for your &lt;em&gt;INNER JOIN&lt;/em&gt;s. Furthermore,
I ran into some trouble with mutates and filters with the package,
because the produced SQL code provide empty results. It remains unclear
to me if this was due to differences in SQL DBMSs (e.g. MariaDB being
differnet from PostGres), my lack of SQL knowledge or if it’s a
shortcoming of the &lt;code&gt;dbplyr&lt;/code&gt; package. My conclusion is that
performing the data wrangling within the DBMS was overkill for the
medium sized wca data. For larger or more structured datasets such an
approach can, however, be fruitful, because a DBMS’s main purpose is to
provide efficient solutions for working with your data. Furthermore, I
like the idea of having a familiar dplyr frontend and just auto-generate
an efficient backend code (here: SQL) to do the actual wrangling. This
also provides an opportunity to get an outside-R-implementation, which
can be an important aspect in &lt;a
href=&quot;http://staff.math.su.se/hoehle/blog/2017/09/02/pairprogramming.html&quot;&gt;quality
assurance of statistical analyses&lt;/a&gt;.&lt;/p&gt;
&lt;h2 id=&quot;acknowledgments&quot;&gt;Acknowledgments&lt;/h2&gt;
&lt;p&gt;The terms of use of the WCA database requests any use of it to be
equipped with the following text:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;This information is based on competition results owned and maintained
by the World Cube Association, published at
https://worldcubeassociation.org/results as of April 19, 2019.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;Besides this formal note, I thank the WCA Results Team for providing
the WCA data for download in this comprehensive form!&lt;/p&gt;
&lt;h2 class=&quot;unnumbered&quot; id=&quot;literature&quot;&gt;Literature&lt;/h2&gt;
&lt;div id=&quot;refs&quot; class=&quot;references csl-bib-body hanging-indent&quot;
data-entry-spacing=&quot;0&quot; role=&quot;list&quot;&gt;
&lt;div id=&quot;ref-quantreg&quot; class=&quot;csl-entry&quot; role=&quot;listitem&quot;&gt;
Koenker, Roger. 2018. &lt;em&gt;Quantreg: Quantile Regression&lt;/em&gt;. &lt;a
href=&quot;https://CRAN.R-project.org/package=quantreg&quot;&gt;https://CRAN.R-project.org/package=quantreg&lt;/a&gt;.
&lt;/div&gt;
&lt;div id=&quot;ref-rmariadb&quot; class=&quot;csl-entry&quot; role=&quot;listitem&quot;&gt;
Müller, Kirill, Jeroen Ooms, David James, Saikat DebRoy, Hadley Wickham,
and Jeffrey Horner. 2018. &lt;em&gt;RMariaDB: Database Interface and ’MariaDB’
Driver&lt;/em&gt;. &lt;a
href=&quot;https://CRAN.R-project.org/package=RMariaDB&quot;&gt;https://CRAN.R-project.org/package=RMariaDB&lt;/a&gt;.
&lt;/div&gt;
&lt;div id=&quot;ref-DBI&quot; class=&quot;csl-entry&quot; role=&quot;listitem&quot;&gt;
R Special Interest Group on Databases (R-SIG-DB), Hadley Wickham, and
Kirill Müller. 2018. &lt;em&gt;DBI: R Database Interface&lt;/em&gt;. &lt;a
href=&quot;https://CRAN.R-project.org/package=DBI&quot;&gt;https://CRAN.R-project.org/package=DBI&lt;/a&gt;.
&lt;/div&gt;
&lt;div id=&quot;ref-dbplyr&quot; class=&quot;csl-entry&quot; role=&quot;listitem&quot;&gt;
Wickham, Hadley, and Edgar Ruiz. 2019. &lt;em&gt;Dbplyr: A ’Dplyr’ Back End
for Databases&lt;/em&gt;. &lt;a
href=&quot;https://CRAN.R-project.org/package=dbplyr&quot;&gt;https://CRAN.R-project.org/package=dbplyr&lt;/a&gt;.
&lt;/div&gt;
&lt;/div&gt;
&lt;section id=&quot;footnotes&quot; class=&quot;footnotes footnotes-end-of-document&quot;
role=&quot;doc-endnotes&quot;&gt;
&lt;hr /&gt;
&lt;ol&gt;
&lt;li id=&quot;fn1&quot;&gt;&lt;p&gt;If you know how to do this efficiently in SQL, let me
know!&lt;a href=&quot;#fnref1&quot; class=&quot;footnote-back&quot;
role=&quot;doc-backlink&quot;&gt;↩︎&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;
&lt;li id=&quot;fn2&quot;&gt;A reddit user correctly pointed out that just because your
results are at the low end does not necessarily imply that it is
&lt;em&gt;uncool&lt;/em&gt; to participate in a WCA competition:
&lt;a class=&quot;embedly-card&quot; href=&quot;https://www.reddit.com/r/Cubers/comments/bl8r18/analysing_the_wca_database/emmwmu6&quot;&gt;Card&lt;/a&gt;
&lt;script async src=&quot;//embed.redditmedia.com/widgets/platform.js&quot;
charset=&quot;UTF-8&quot;&gt;&lt;/script&gt;
&lt;p&gt;This is very true and I’ve updated the post accordingly. However, if
you like me already are an age outlier while your kid is too young to
act as your alibi companion, I miss the courage to also be a total skill
outlier… But that’s my problem and just motivates me to train more (if
time permits) before signing up. 😏&lt;a href=&quot;#fnref2&quot;
class=&quot;footnote-back&quot; role=&quot;doc-backlink&quot;&gt;↩︎&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;
&lt;li id=&quot;fn3&quot;&gt;&lt;p&gt;From readings on &lt;a
href=&quot;http://www.speedsolving.com&quot;&gt;speedsolving.com&lt;/a&gt; I now learned
that there exist (partial) &lt;a
href=&quot;https://logiqx.github.io/wca-ipy/&quot;&gt;40+ rankings&lt;/a&gt;, which can
help to assess the skill level in that age bracket in more detail. My
interest was in the skill level of the overall cubing population
though.&lt;a href=&quot;#fnref3&quot; class=&quot;footnote-back&quot;
role=&quot;doc-backlink&quot;&gt;↩︎&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;/section&gt;
</description>
        <pubDate>Mon, 06 May 2019 00:00:00 +0200</pubDate>
        <link>https://mhoehle.github.io/blog/2019/05/06/wcamining.html</link>
        <guid isPermaLink="true">https://mhoehle.github.io/blog/2019/05/06/wcamining.html</guid>
        
        <category>rstats</category>
        
        <category>dataviz</category>
        
        <category>data science</category>
        
        <category>tidyverse</category>
        
        <category>Rubik&apos;s cube</category>
        
        <category>3x3x3</category>
        
        <category>speedsolving</category>
        
        
      </item>
    
      <item>
        <title>A Shiny app for your perfect circle</title>
        <description>&lt;h2 id=&quot;abstract&quot;&gt;Abstract:&lt;/h2&gt;
&lt;p&gt;&lt;em&gt;The perfect circle&lt;/em&gt; is a shiny app providing a user friendly
interface to the algorithm described in the previous blog post
&lt;em&gt;Judging Freehand Circle Drawing Competitions&lt;/em&gt;. The app allows
one to score freehand circles directly from the mobile by uploading
photos of them them to a shiny server. An R package “perfectcircle”
contains the scoring API as well as the shiny app.&lt;/p&gt;
&lt;center&gt;
&lt;img src=&quot;/blog/figure/source/2019-02-15-shinycircle/screenshot2.png&quot; width=&quot;450&quot;&gt;
&lt;/center&gt;
&lt;p&gt;&lt;br&gt;
&lt;a rel=&quot;license&quot; href=&quot;http://creativecommons.org/licenses/by-sa/4.0/&quot;&gt;&lt;img alt=&quot;Creative Commons License&quot; style=&quot;border-width:0&quot; src=&quot;https://i.creativecommons.org/l/by-sa/4.0/88x31.png&quot;/&gt;&lt;/a&gt;
This work is licensed under a &lt;a rel=&quot;license&quot;
href=&quot;http://creativecommons.org/licenses/by-sa/4.0/&quot;&gt;Creative Commons
Attribution-ShareAlike 4.0 International License&lt;/a&gt;. The
markdown+Rknitr source code of this blog is available under a &lt;a
href=&quot;https://www.gnu.org/licenses/gpl-3.0.html&quot;&gt;GNU General Public
License (GPL v3)&lt;/a&gt; license from github.&lt;/p&gt;
&lt;h2 id=&quot;introduction&quot;&gt;Introduction&lt;/h2&gt;
&lt;p&gt;The blog post &lt;a
href=&quot;http://staff.math.su.se/hoehle/blog/2018/07/31/circle.html&quot;&gt;Judging
Freehand Circle Drawing Competitions&lt;/a&gt; contained an image analysis
based procedure to automatically score the circularity of freehand drawn
circles. What motivated the post was a curiosity on how one would rank
different freehand drawn circles in a competition such as the one
mentioned by Alexander Overwijk in his 2007 &lt;a
href=&quot;https://www.youtube.com/embed/eAhfZUZiwSE&quot;&gt;‘Perfect Circle’
video&lt;/a&gt;. A few weeks ago, I got an email in response to this post
asking about the state of the scoring software, because there was an
interest to hold a freehand circle drawing competition as part of a math
teacher’s conference. This motivated me to wrap the algorithm into a
user friendly interface in order to increase the empty-set of potential
users.&lt;/p&gt;
&lt;h2 id=&quot;the-perfect-circle-app&quot;&gt;The Perfect Circle App&lt;/h2&gt;
&lt;p&gt;The circle segmentation functionality from the blog post was wrapped
into an R package. In particular the function &lt;a
href=&quot;https://github.com/hoehleatsu/perfectcircle/blob/fb92ef694b38eb8f409b018c80c827dfb23d0c09/R/perfectcircle.R#L129&quot;&gt;&lt;code&gt;circularity&lt;/code&gt;&lt;/a&gt;
takes an &lt;a
href=&quot;https://cran.r-project.org/web/packages/imager/index.html&quot;&gt;&lt;code&gt;imager&lt;/code&gt;&lt;/a&gt;
image &lt;span class=&quot;citation&quot; data-cites=&quot;imager&quot;&gt;(Barthelme 2019)&lt;/span&gt;
and a &lt;code&gt;data.frame&lt;/code&gt; with seedpoints and returns a circularity
measure. This allows one to easily batch process the images of an entire
competition in order to generate a leaderboard. Furthermore, a shiny app
&lt;span class=&quot;citation&quot; data-cites=&quot;shiny&quot;&gt;(Chang et al. 2018)&lt;/span&gt; is
shipped as part of the package, which adds a user interface around this
API of the package. Specifically, the app allows the user to upload
their image and provide seed points either by uploading a .csv file or
manually selecting the points in the image. The point selection was
possible by using the ggplot-plotting functionality of the
&lt;code&gt;imager&lt;/code&gt; package together with the &lt;a
href=&quot;https://shiny.rstudio.com/reference/shiny/1.2.0/nearPoints.html&quot;&gt;&lt;code&gt;shiny::nearPoints&lt;/code&gt;&lt;/a&gt;
function.&lt;/p&gt;
&lt;p&gt;A general overview of the app is given by the following
screencast:&lt;/p&gt;
&lt;center&gt;
&lt;iframe width=&quot;560&quot; height=&quot;315&quot; src=&quot;https://www.youtube.com/embed/g8zV5jfvvlo&quot; frameborder=&quot;0&quot; allow=&quot;accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture&quot; allowfullscreen&gt;
&lt;/iframe&gt;
&lt;/center&gt;
&lt;p&gt;
&lt;p&gt;The R source code of shiny app is available as part of the R package
&lt;a href=&quot;https://github.com/hoehleatsu/perfectcircle&quot;&gt;perfectcircle&lt;/a&gt;
available from github under a GPLv3 license. A running version of the
app can be reached at&lt;/p&gt;
&lt;center&gt;
&lt;a
href=&quot;http://michaelhoehle.eu/shiny/perfectcircle/&quot;&gt;http://michaelhoehle.eu/shiny/perfectcircle/&lt;/a&gt;
&lt;/center&gt;
&lt;p&gt;
&lt;p&gt;&lt;em&gt;Note&lt;/em&gt;: Using the app from the above link can lead to
“Disconnected from the server” errors when operating with high
resolution images. Even though tracking memory consumption appears to
reveal no problems, I suspect it to be an out-of-memory error of some
sort - either by the R session run by the shiny server or an error in
the &lt;code&gt;imager&lt;/code&gt; package. However, reducing the image resolution
using the &lt;em&gt;Scale Factor&lt;/em&gt; so far always fixed the problem.
Furthermore, I did not experience the problem when running the shiny app
locally (Mac OS)&lt;/p&gt;
&lt;p&gt;To better illustrate, how the shiny app can facilitate the scoring of
circles on the fly with the camera of your mobile, I made an additional
video tutorial about the adventures of a perfect circle:&lt;/p&gt;
&lt;center&gt;
&lt;iframe width=&quot;560&quot; height=&quot;315&quot; src=&quot;https://www.youtube.com/embed/QZOCKn9XNN4&quot; frameborder=&quot;0&quot; allow=&quot;accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture&quot; allowfullscreen&gt;
&lt;/iframe&gt;
&lt;/center&gt;
&lt;p&gt;
&lt;h2 id=&quot;discussion&quot;&gt;Discussion&lt;/h2&gt;
&lt;p&gt;As always it was amazingly easy to use shiny to wrap a user interface
around functionality written in R. I hope the app is useful to conduct
your local freehand circle drawing competition! I would very much
appreciate your feedback. If you want to share some of your best
circles: bundles of image + seed point .csv files as pull requests to
the &lt;a
href=&quot;https://github.com/hoehleatsu/worldfreehandcirclechampionship/tree/master/round-1&quot;&gt;round-1&lt;/a&gt;
folder on github are very welcomed!&lt;/p&gt;
&lt;p&gt;An insight for me as non-millennial was the ease of the screen
recording feature of Quicktime followed by uploading it to Youtube: With
a few clicks the static-blackboard-fan thus created a first video blog
entry! No less than amazing are IMHO the automatically generated
subtitles on Youtube - a lot of machine learning has happened in speech
recognition!&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Update Feb 2020&lt;/strong&gt;: Hanh Nguyen from &lt;a
href=&quot;https://nl.bettermarks.com/&quot;&gt;Bettermarks&lt;/a&gt; used the web-app
together with a blackboard + mobile phone setup to hold a Dutch freehand
circle drawing championship at the 2020 edition of the &lt;a
href=&quot;https://www.uu.nl/onderwijs/nationale-wiskunde-dagen/2020-editie&quot;&gt;National
Mathematics Days&lt;/a&gt;. The competition had more than 100 participants
(mostly mathematics high school teachers), some of them taking the app
to their classroom! Feedback like this makes me happy.&lt;/p&gt;
&lt;h2 class=&quot;unnumbered&quot; id=&quot;literature&quot;&gt;Literature&lt;/h2&gt;
&lt;div id=&quot;refs&quot; class=&quot;references csl-bib-body hanging-indent&quot;
data-entry-spacing=&quot;0&quot; role=&quot;list&quot;&gt;
&lt;div id=&quot;ref-imager&quot; class=&quot;csl-entry&quot; role=&quot;listitem&quot;&gt;
Barthelme, Simon. 2019. &lt;em&gt;Imager: Image Processing Library Based on
’CImg’&lt;/em&gt;. &lt;a
href=&quot;https://CRAN.R-project.org/package=imager&quot;&gt;https://CRAN.R-project.org/package=imager&lt;/a&gt;.
&lt;/div&gt;
&lt;div id=&quot;ref-shiny&quot; class=&quot;csl-entry&quot; role=&quot;listitem&quot;&gt;
Chang, Winston, Joe Cheng, JJ Allaire, Yihui Xie, and Jonathan
McPherson. 2018. &lt;em&gt;Shiny: Web Application Framework for r&lt;/em&gt;. &lt;a
href=&quot;https://CRAN.R-project.org/package=shiny&quot;&gt;https://CRAN.R-project.org/package=shiny&lt;/a&gt;.
&lt;/div&gt;
&lt;/div&gt;
</description>
        <pubDate>Fri, 15 Feb 2019 00:00:00 +0100</pubDate>
        <link>https://mhoehle.github.io/blog/2019/02/15/shinycircle.html</link>
        <guid isPermaLink="true">https://mhoehle.github.io/blog/2019/02/15/shinycircle.html</guid>
        
        <category>rstats</category>
        
        <category>dataviz</category>
        
        <category>image analysis</category>
        
        <category>shiny</category>
        
        <category>imager</category>
        
        
      </item>
    
      <item>
        <title>Purr yourself into a math genius</title>
        <description>&lt;h2 id=&quot;abstract&quot;&gt;Abstract:&lt;/h2&gt;
&lt;p&gt;We use the purrr package to solve a popular math puzzle via a
combinatorial functional programming approach. A small shiny app is
provided to allow the user to solve their own variations of the
puzzle.&lt;/p&gt;
&lt;center&gt;
&lt;img src=&quot;/blog/figure/source/2019-01-04-mathgenius/shinyapp.png&quot; width=&quot;450&quot;&gt;
&lt;/center&gt;
&lt;p&gt;&lt;br&gt;
&lt;a rel=&quot;license&quot; href=&quot;http://creativecommons.org/licenses/by-sa/4.0/&quot;&gt;&lt;img alt=&quot;Creative Commons License&quot; style=&quot;border-width:0&quot; src=&quot;https://i.creativecommons.org/l/by-sa/4.0/88x31.png&quot;/&gt;&lt;/a&gt;
This work is licensed under a &lt;a rel=&quot;license&quot;
href=&quot;http://creativecommons.org/licenses/by-sa/4.0/&quot;&gt;Creative Commons
Attribution-ShareAlike 4.0 International License&lt;/a&gt;. The
markdown+Rknitr source code of this blog is available under a &lt;a
href=&quot;https://www.gnu.org/licenses/gpl-3.0.html&quot;&gt;GNU General Public
License (GPL v3)&lt;/a&gt; license from github.&lt;/p&gt;
&lt;h2 id=&quot;introduction&quot;&gt;Introduction&lt;/h2&gt;
&lt;p&gt;&lt;a href=&quot;http://www.briddles.com/2011/12/maths-puzzle.html&quot;&gt;No. 4&lt;/a&gt;
of the &lt;a href=&quot;http://www.briddles.com/riddles/top-5-hard-math&quot;&gt;Top 5
hard math puzzles&lt;/a&gt; at &lt;a href=&quot;www.briddles.com&quot;&gt;briddles.com&lt;/a&gt;
goes like this:&lt;/p&gt;
&lt;div class=&quot;blackbox&quot;&gt;
&lt;em&gt;How can I get the answer 24 by only using the numbers 8,8,3,3. You
can use the main signs add, subtract multiply and divide.&lt;/em&gt;
&lt;/div&gt;
&lt;p&gt;
&lt;p&gt;Note: a solution has to use each of the specified 4 numbers exactly
ONCE, but they can be used in any order. In other words the standard
scheme is to solve expressions of the kind:&lt;/p&gt;
&lt;center&gt;
&lt;code&gt;a op1 b op2 c op3 d&lt;/code&gt;
&lt;/center&gt;
&lt;p&gt;
&lt;p&gt;where &lt;code&gt;a&lt;/code&gt;, &lt;code&gt;b&lt;/code&gt;, &lt;code&gt;c&lt;/code&gt; and
&lt;code&gt;d&lt;/code&gt; denote a permutation of the numbers 8, 8, 3, 3 and each
of &lt;code&gt;op1&lt;/code&gt;, &lt;code&gt;op2&lt;/code&gt; and &lt;code&gt;op3&lt;/code&gt; denotes the
use of one binary operator selected from +, -, * or /. An example is the
expression &lt;code&gt;8 + 3 + 8 * 3&lt;/code&gt;. Parentheses are used to control
the order in which the operators are applied, i.e.
&lt;code&gt;(8 + 3 + 8) * 3&lt;/code&gt; yields a different result than
&lt;code&gt;8 + 3 + (8 * 3)&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;After a few unsuccessful attempts to solve the above puzzle with pen
and paper it felt more &lt;em&gt;efficient&lt;/em&gt; and computationally
&lt;em&gt;challenging&lt;/em&gt; to solve this puzzle via a combinatorial approach:
Simply try out all permutations of the 4 numbers, the 4 binary operators
and all possible sets of parentheses to combine the operators. One can
show that there are at most&lt;/p&gt;
&lt;p&gt;&lt;span class=&quot;math display&quot;&gt;\[
\begin{align*} &amp;amp;&amp;amp; \text{# permutations of the
$k=4$ base numbers} \\ \times &amp;amp;&amp;amp; \text{# ways to select with
replacement $(k-1)$ binary operators from the set $\{+,-,*,/\}$ }\\
\times &amp;amp;&amp;amp;
\text{# ways to parenthesize the $(k-1)$ binary operators} \\
&amp;amp;=&amp;amp;k!
\times 4^{(k-1)} \times \frac{1}{k} \binom{2k-2}p{k-1}
\end{align*}
\]&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;different combinations to choose from &lt;a href=&quot;#fn1&quot;
class=&quot;footnote-ref&quot; id=&quot;fnref1&quot; role=&quot;doc-noteref&quot;&gt;&lt;sup&gt;1&lt;/sup&gt;&lt;/a&gt;. As
an example: for &lt;span class=&quot;math inline&quot;&gt;\(k=4\)&lt;/span&gt; the maximal
number of unique combinations is 21504.&lt;/p&gt;
&lt;h4 id=&quot;strategy&quot;&gt;Strategy&lt;/h4&gt;
&lt;p&gt;We will use a functional approach to solve the above combinatorial
problem. Why?&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;because it seems like a good use-case for &lt;a
href=&quot;https://en.wikipedia.org/wiki/Functional_programming&quot;&gt;functional
programming&lt;/a&gt;,&lt;/li&gt;
&lt;li&gt;because it is important to extend your programming horizon every
once in a while, and&lt;/li&gt;
&lt;li&gt;because the &lt;a
href=&quot;https://cran.r-project.org/web/packages/purrr/index.html&quot;&gt;&lt;code&gt;purrr&lt;/code&gt;&lt;/a&gt;
functional programming toolkit for R allows you to experiment with this
without having to leave the R universe &lt;a href=&quot;#fn2&quot;
class=&quot;footnote-ref&quot; id=&quot;fnref2&quot;
role=&quot;doc-noteref&quot;&gt;&lt;sup&gt;2&lt;/sup&gt;&lt;/a&gt;.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;For those not familar with &lt;code&gt;purrr&lt;/code&gt; can find a wonderful
didactic introduction in the &lt;a
href=&quot;https://github.com/cwickham/purrr-tutorial&quot;&gt;useR! 2017
tutorial&lt;/a&gt; by &lt;a href=&quot;https://twitter.com/CVWickham&quot;&gt;Charlotte
Wickham&lt;/a&gt;. Furthermore, learning &lt;code&gt;purrr&lt;/code&gt; was the 7th most
frequent mentioned package in the &lt;a
href=&quot;https://masalmon.eu/2019/01/01/r-goals/&quot;&gt;#rstats users’ 2019 R
goals&lt;/a&gt;. In other words: Attention #rstats new years resolution
makers: reading this post is as &lt;strong&gt;obligatory&lt;/strong&gt; as going to
the gym on 01 Jan!&lt;/p&gt;
&lt;h2 id=&quot;solving-the-math-puzzle&quot;&gt;Solving the Math Puzzle&lt;/h2&gt;
&lt;p&gt;We will divide-and-conquer the solution along the lines of the number
of combinations formula: Firstly, we will store all permutations of the
&lt;span class=&quot;math inline&quot;&gt;\((k-1)\)&lt;/span&gt; base numbers in a list
&lt;code&gt;perm&lt;/code&gt;. Secondly, we will store all possible combinations of
the &lt;span class=&quot;math inline&quot;&gt;\((k-1)\)&lt;/span&gt; operators in a list
&lt;code&gt;operators&lt;/code&gt; and, thirdly, we generate all possible ways of
putting parentheses around the operators into a list
&lt;code&gt;brackets&lt;/code&gt;. Subsequently, we form the Cartesian product of
these three lists and build the corresponding expression for each triple
of permutation, operators and parentheses. Finally, each generated
expression is evaluated. The entire result is a data frame containing
all possible expressions and their associated value obtained when
evaluating the expression.&lt;/p&gt;
&lt;h3 id=&quot;permutations-of-the-base-numbers&quot;&gt;Permutations of the base
numbers&lt;/h3&gt;
&lt;p&gt;We let the variable &lt;code&gt;base_numbers&lt;/code&gt; contain the
specification of the numbers to permute for the expression. The code
should be written general enough so it is possible to use a different
base, e.g., &lt;span class=&quot;math inline&quot;&gt;\(k=3\)&lt;/span&gt; or &lt;span
class=&quot;math inline&quot;&gt;\(k=5\)&lt;/span&gt;.&lt;/p&gt;
&lt;figure class=&quot;highlight&quot;&gt;
&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;span class=&quot;n&quot;&gt;base_numbers&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;8&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;8&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;k&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;length&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;base_numbers&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;

&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;number_perm&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;combinat&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;permn&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;base_numbers&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
  &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;map&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;setNames&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;nm&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;letters&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;seq_len&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;k&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)])&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;

&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;##Slim in case permutations of the base numbers contain duplicates.&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;perm&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;number_perm&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;!&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;duplicated&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;map&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;number_perm&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;paste0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;collapse&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))]&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;/figure&gt;
&lt;p&gt;For &lt;span class=&quot;math inline&quot;&gt;\(k=4\)&lt;/span&gt; the first step yields a
total 21504 combinations. However, since the numbers 8 and 3 both appear
more than once in the base numbers, we can slim the number of
permutations from 24 to 6. Hence, there are altogether only 5376
combinations to investigate.&lt;/p&gt;
&lt;h3 id=&quot;combinations-of-the-operators&quot;&gt;Combinations of the
operators&lt;/h3&gt;
&lt;p&gt;The next step is to make all combinations of the &lt;span
class=&quot;math inline&quot;&gt;\(k-1\)&lt;/span&gt; binary operators needed to combine
the &lt;span class=&quot;math inline&quot;&gt;\(k\)&lt;/span&gt; numbers. We use the string
format to represent the operators &lt;a href=&quot;#fn3&quot; class=&quot;footnote-ref&quot;
id=&quot;fnref3&quot; role=&quot;doc-noteref&quot;&gt;&lt;sup&gt;3&lt;/sup&gt;&lt;/a&gt; and thus just need the
&lt;span class=&quot;math inline&quot;&gt;\(k-1\)&lt;/span&gt;’th Cartesian product of the set
&lt;span class=&quot;math inline&quot;&gt;\(\{+, -, *, /\}\)&lt;/span&gt; represented as
strings. &lt;!-- i.e. $\times_{i=1}^{k-1} \{+,-,*,/\}$. --&gt;&lt;/p&gt;
&lt;figure class=&quot;highlight&quot;&gt;
&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;span class=&quot;n&quot;&gt;opList&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;list&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;+&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;-&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;*&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;/&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;##Repeat the opList k-1 times&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;opsList&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;map&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;seq_len&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;k&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;-1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;o&quot;&gt;~&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;opList&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;##Form the Cartesian product&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;operators&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;cross&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;opsList&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
  &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;map&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;setNames&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;nm&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;paste0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;op&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;seq_len&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;k&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;-1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)))&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;/figure&gt;
&lt;h3 id=&quot;arrangements-of-the-parentheses&quot;&gt;Arrangements of the
parentheses&lt;/h3&gt;
&lt;p&gt;As all the involved operators are binary it becomes clear that
finding all possible ways to parenthesize the expression corresponds to
finding all &lt;a href=&quot;https://en.wikipedia.org/wiki/Binary_tree&quot;&gt;binary
trees&lt;/a&gt; with &lt;span class=&quot;math inline&quot;&gt;\(k-1\)&lt;/span&gt; leaves.
Beautiful recursive code inspiration for how to solve this can be found
on &lt;a
href=&quot;https://leetcode.com/problems/all-possible-full-binary-trees/solution/&quot;&gt;leetcode.com&lt;/a&gt;.
Some adaptation to R and our problem at hand was necessary - the idea is
to use recursion in &lt;span class=&quot;math inline&quot;&gt;\(k\)&lt;/span&gt; and use a
hash-map to cache results of previous computations.&lt;/p&gt;
&lt;figure class=&quot;highlight&quot;&gt;
&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;span class=&quot;c1&quot;&gt;##Initialize hashmap to save the results of all binary trees up to n=1 leaves&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;trees&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;list&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;trees&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[[&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;0&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]]&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;kc&quot;&gt;NULL&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;trees&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[[&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;1&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]]&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;list&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;list&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;val&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;node&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;left&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;kc&quot;&gt;NULL&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;right&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;kc&quot;&gt;NULL&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;/figure&gt;
&lt;p&gt;The rather elegant &lt;strong&gt;recursive solution&lt;/strong&gt; for generating
all binary trees with &lt;span class=&quot;math inline&quot;&gt;\(n\)&lt;/span&gt; leaves
works by combining all possible ways to generate subbranches containing
&lt;span class=&quot;math inline&quot;&gt;\(x\)&lt;/span&gt; and &lt;span
class=&quot;math inline&quot;&gt;\(n-x\)&lt;/span&gt; leaves, respectively:&lt;/p&gt;
&lt;figure class=&quot;highlight&quot;&gt;
&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;span class=&quot;n&quot;&gt;allBinTrees&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;k&quot;&gt;function&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;n&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
  &lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;##Character version of n, which is used as hash key&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
  &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;n_char&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;as.character&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;n&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;

  &lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;##Only compute something if n is not already in the hashlist.&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
  &lt;/span&gt;&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;is.null&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;pluck&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;trees&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;n_char&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)))&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
    &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;trees&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;n_char&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]]&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;-&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;list&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;

    &lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;##Combine all possible ways  to generate bintrees with $i$ and $n-i$ leaves&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
    &lt;/span&gt;&lt;span class=&quot;k&quot;&gt;for&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;k&quot;&gt;in&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;n&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;-1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
      &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;j&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;n&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
      &lt;/span&gt;&lt;span class=&quot;k&quot;&gt;for&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;left_tree&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;k&quot;&gt;in&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;allBinTrees&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
        &lt;/span&gt;&lt;span class=&quot;k&quot;&gt;for&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;right_tree&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;k&quot;&gt;in&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;allBinTrees&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;j&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
          &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;trees&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;n_char&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]][[&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;length&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;trees&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;n_char&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]])&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]]&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;-&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;list&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;val&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;kc&quot;&gt;NULL&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;left&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;left_tree&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;right&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;right_tree&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
        &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
      &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
    &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
  &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;#end if not already in tree list&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
  &lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;##Return result from our hashmap&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
  &lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;pluck&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;trees&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;n_char&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;/figure&gt;
&lt;p&gt;We can test the function for &lt;span
class=&quot;math inline&quot;&gt;\(n=2\)&lt;/span&gt;, which yields exactly one tree:&lt;/p&gt;
&lt;figure class=&quot;highlight&quot;&gt;
&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;span class=&quot;c1&quot;&gt;##Manual construction&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;trees2&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;list&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;list&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;val&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;kc&quot;&gt;NULL&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;left&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;trees&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[[&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;1&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]][[&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]],&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;right&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;trees&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[[&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;1&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]][[&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]]))&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;all.equal&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;allBinTrees&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;n&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;trees2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;/figure&gt;
&lt;figure class=&quot;highlight&quot;&gt;
&lt;pre&gt;&lt;code class=&quot;language-text&quot; data-lang=&quot;text&quot;&gt;## [1] TRUE&lt;/code&gt;&lt;/pre&gt;
&lt;/figure&gt;
&lt;p&gt;The result is:&lt;/p&gt;
&lt;figure class=&quot;highlight&quot;&gt;
&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;span class=&quot;n&quot;&gt;tree2String&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;allBinTrees&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;n&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)[[&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]])&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;replaceNodes&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;addOpNumbers&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;/figure&gt;
&lt;figure class=&quot;highlight&quot;&gt;
&lt;pre&gt;&lt;code class=&quot;language-text&quot; data-lang=&quot;text&quot;&gt;## [1] &quot;(a op1 b)&quot;&lt;/code&gt;&lt;/pre&gt;
&lt;/figure&gt;
&lt;p&gt;In the above code segments the function &lt;code&gt;tree2String&lt;/code&gt; is a
small helper function to convert the nested list structure to a string -
in this case: &lt;code&gt;(node op node)&lt;/code&gt;. Furthermore, the function
&lt;code&gt;replaceNodes&lt;/code&gt; renames the terms &lt;code&gt;node&lt;/code&gt; into the
variables &lt;code&gt;(a op b)&lt;/code&gt;. The &lt;code&gt;op&lt;/code&gt;-strings are
converted into numbered &lt;code&gt;op&lt;/code&gt;-strings using
&lt;code&gt;addOpNumbers&lt;/code&gt;, i.e. the result becomes
&lt;code&gt;(a op1 b)&lt;/code&gt;. Details about the helper functions can be found
in the &lt;a
href=&quot;https://raw.githubusercontent.com/hoehleatsu/hoehleatsu.github.io/master/_source/2019-01-04-mathgenius.Rmd&quot;&gt;code&lt;/a&gt;
on github.&lt;/p&gt;
&lt;p&gt;With all preparations in place we can now generate all 5 possible
ways to parenthesize the 3 binary operations using the following
code:&lt;/p&gt;
&lt;figure class=&quot;highlight&quot;&gt;
&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;span class=&quot;c1&quot;&gt;##Make all possible brackets&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;bracketing&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;map_chr&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;allBinTrees&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;n&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;k&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
                      &lt;/span&gt;&lt;span class=&quot;o&quot;&gt;~&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;tree2String&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;.x&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;addOpNumbers&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;replaceNodes&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;/figure&gt;
&lt;figure class=&quot;highlight&quot;&gt;
&lt;pre&gt;&lt;code class=&quot;language-text&quot; data-lang=&quot;text&quot;&gt;## [1] &quot;(a op1 (b op2 (c op3 d)))&quot; &quot;(a op1 ((b op2 c) op3 d))&quot; &quot;((a op1 b) op2 (c op3 d))&quot; &quot;((a op1 (b op2 c)) op3 d)&quot; &quot;(((a op1 b) op2 c) op3 d)&quot;&lt;/code&gt;&lt;/pre&gt;
&lt;/figure&gt;
&lt;h3 id=&quot;putting-it-all-together&quot;&gt;Putting it all together&lt;/h3&gt;
&lt;p&gt;We can now generate all combinations of numbers, operators and
bracketing by the Cartesian of the three lists:&lt;/p&gt;
&lt;figure class=&quot;highlight&quot;&gt;
&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;span class=&quot;n&quot;&gt;combos&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;cross3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;perm&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;map&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;operators&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;unlist&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;bracketing&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
  &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;map&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;setNames&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;numbers&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;operators&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;bracket&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;/figure&gt;
&lt;p&gt;We can now finally evaluate each of the 1920 combinations. Note:
Because this might take a while it’s a good idea to add a &lt;a
href=&quot;https://github.com/tidyverse/purrr/issues/149#issuecomment-359236625&quot;&gt;progress
bar&lt;/a&gt; for this &lt;code&gt;purrr&lt;/code&gt; computation.&lt;/p&gt;
&lt;figure class=&quot;highlight&quot;&gt;
&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;span class=&quot;c1&quot;&gt;##Set up a progress bar for use with the map function&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;pb&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;progress_estimated&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;length&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;combos&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;

&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;##Compute&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;res&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;map&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;combos&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;.f&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;function&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;l&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
  &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;pb&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;tick&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;print&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
  &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;l&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[[&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;expr&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]]&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;l&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[[&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;bracket&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]]&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;replace&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;l&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[[&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;numbers&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]])&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;replace&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;l&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[[&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;operators&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]])&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
  &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;l&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[[&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;value&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]]&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;eval&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;parse&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;text&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;l&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[[&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;expr&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]]))&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
  &lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;l&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;})&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;/figure&gt;
&lt;p&gt;Again, &lt;code&gt;replace(v)&lt;/code&gt; is a small helper function to replace
the strings in &lt;code&gt;names(v)&lt;/code&gt; with &lt;code&gt;v&lt;/code&gt;’s content. The
actual evaluation of each possible solution string is done by parsing
the string with &lt;code&gt;parse&lt;/code&gt; and then evaluate the resulting
expression. We extract the relevant results into a
&lt;code&gt;data.frame&lt;/code&gt;&lt;/p&gt;
&lt;figure class=&quot;highlight&quot;&gt;
&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;span class=&quot;n&quot;&gt;df&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;map_df&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;res&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;o&quot;&gt;~&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;data.frame&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;expr&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;.x&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;expr&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;value&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;.x&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;value&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;/figure&gt;
&lt;p&gt;&lt;img src=&quot;/blog/figure/source/2019-01-04-mathgenius/DATATABLE-1.png&quot; style=&quot;display: block; margin: auto;&quot; /&gt;&lt;/p&gt;
&lt;p&gt;We can now easily extract the solution:&lt;/p&gt;
&lt;figure class=&quot;highlight&quot;&gt;
&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;span class=&quot;c1&quot;&gt;##First element to give the value 24&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;detect&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;res&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;o&quot;&gt;~&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;isTRUE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;all.equal&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;.x&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;value&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;m&quot;&gt;24&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)))&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;/figure&gt;
&lt;figure class=&quot;highlight&quot;&gt;
&lt;pre&gt;&lt;code class=&quot;language-text&quot; data-lang=&quot;text&quot;&gt;## $numbers
## a b c d 
## 8 3 8 3 
## 
## $operators
## op1 op2 op3 
## &quot;/&quot; &quot;-&quot; &quot;/&quot; 
## 
## $bracket
## [1] &quot;(a op1 (b op2 (c op3 d)))&quot;
## 
## $expr
## [1] &quot;(8 / (3 - (8 / 3)))&quot;
## 
## $value
## [1] 24&lt;/code&gt;&lt;/pre&gt;
&lt;/figure&gt;
&lt;p&gt;Voila! QED!&lt;/p&gt;
&lt;h4 id=&quot;extended-new-years-fun&quot;&gt;Extended New Years Fun&lt;/h4&gt;
&lt;p&gt;For user experimentation we wrapped all the above steps into one
function &lt;code&gt;solveMathPuzzle&lt;/code&gt; (see &lt;a
href=&quot;https://raw.githubusercontent.com/hoehleatsu/hoehleatsu.github.io/master/_source/2019-01-04-mathgenius.Rmd&quot;&gt;github
code&lt;/a&gt; for details). To underline the generalizability of the approach
we solve a classical 2019 new-year’s puzzle:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb1&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb1-1&quot;&gt;&lt;a href=&quot;#cb1-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;res &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;suppressWarnings&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;solveMathPuzzle&lt;/span&gt;( &lt;span class=&quot;at&quot;&gt;base_numbers=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;c&lt;/span&gt;(&lt;span class=&quot;dv&quot;&gt;7&lt;/span&gt;,&lt;span class=&quot;dv&quot;&gt;7&lt;/span&gt;,&lt;span class=&quot;dv&quot;&gt;11&lt;/span&gt;,&lt;span class=&quot;dv&quot;&gt;11&lt;/span&gt;,&lt;span class=&quot;dv&quot;&gt;43&lt;/span&gt;,&lt;span class=&quot;dv&quot;&gt;43&lt;/span&gt;), &lt;span class=&quot;at&quot;&gt;expr_result=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;2019&lt;/span&gt;, &lt;span class=&quot;at&quot;&gt;operatorList=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;c&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;quot;+&amp;quot;&lt;/span&gt;,&lt;span class=&quot;st&quot;&gt;&amp;quot;*&amp;quot;&lt;/span&gt;)))&lt;/span&gt;
&lt;span id=&quot;cb1-2&quot;&gt;&lt;a href=&quot;#cb1-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;res&lt;span class=&quot;sc&quot;&gt;$&lt;/span&gt;expr[[&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;]]&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;## [1] &amp;quot;((7 * 7) + ((11 * 11) + (43 * 43)))&amp;quot;&lt;/code&gt;&lt;/pre&gt;
&lt;h2 id=&quot;shiny-app&quot;&gt;Shiny App&lt;/h2&gt;
&lt;p&gt;To make the above solution accessible to a wider audience we wrote a
small Shiny app to play with the code for &lt;span
class=&quot;math inline&quot;&gt;\(k=4\)&lt;/span&gt;:&lt;/p&gt;
&lt;center&gt;
&lt;!-- [https://hoehle.shinyapps.io/mathgenius/](https://hoehle.shinyapps.io/mathgenius/) --&gt;
&lt;a href=&quot;http://michaelhoehle.eu/shiny/mathgenius/&quot;&gt;http://michaelhoehle.eu/shiny/mathgenius/&lt;/a&gt;
&lt;/center&gt;
&lt;p&gt;
&lt;p&gt;
&lt;p&gt;Here one can alter the input numbers in case variants of the puzzle
are in need of a solution or, if you occasionally need to generate math
puzzles for your nephew…&lt;/p&gt;
&lt;center&gt;
&lt;img src=&quot;/blog/figure/source/2019-01-04-mathgenius/shinyapp.png&quot; width=&quot;600&quot;&gt;
&lt;/center&gt;
&lt;p&gt;Besides possible solutions one can view the result of all possible
combinations yielding integer results in the “Details” tab. We invite
you to experiment with the app or download the &lt;a
href=&quot;https://raw.githubusercontent.com/hoehleatsu/hoehleatsu.github.io/master/figure/source/2019-01-04-mathgenius/mathgenius/app.R&quot;&gt;source
code of the Shiny app&lt;/a&gt; from github for the full math experience.
😃&lt;/p&gt;
&lt;p&gt;As always: it’s amazing how easy you can wrap a interactive web based
UI around your running R code with Shiny!&lt;/p&gt;
&lt;h2 id=&quot;discussion&quot;&gt;Discussion&lt;/h2&gt;
&lt;p&gt;We used a brute force solution approach by trying out all possible
combinations to solve the math puzzle. The code of our solution approach
is flexible enough to handle more or less base numbers, however, the
number of combinations to try quickly exceeds reasonable memory and
timing constraints. We stress that &lt;strong&gt;a mathematical purr does not
need speed, it lives from the beauty of recursion and mappings&lt;/strong&gt;!
Clever mathematicians might be able to achieve considerable speed gains
by exploiting for example commutative properties of the operators
whereas skilled computer scientists would parallelise the
computations.&lt;/p&gt;
&lt;h2 id=&quot;literature&quot;&gt;Literature&lt;/h2&gt;
&lt;section id=&quot;footnotes&quot; class=&quot;footnotes footnotes-end-of-document&quot;
role=&quot;doc-endnotes&quot;&gt;
&lt;hr /&gt;
&lt;ol&gt;
&lt;li id=&quot;fn1&quot;&gt;&lt;p&gt;Note: The term &lt;span class=&quot;math inline&quot;&gt;\(\frac{1}{k}
\binom{2k-2}{k-1}\)&lt;/span&gt; is the so called &lt;a
href=&quot;https://en.wikipedia.org/wiki/Catalan_number#Applications_in_combinatorics&quot;&gt;Catalan
number&lt;/a&gt;, which - among other applications - also denotes the number
of ways to parenthesize &lt;span class=&quot;math inline&quot;&gt;\(k-1\)&lt;/span&gt; binary
operations.&lt;a href=&quot;#fnref1&quot; class=&quot;footnote-back&quot;
role=&quot;doc-backlink&quot;&gt;↩︎&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;
&lt;li id=&quot;fn2&quot;&gt;&lt;p&gt;Actually, the package more or less adds a lot of
convenience wrapping for functional programming in R, the functional
programming approach is rather deeply rooted in R due to the &lt;a
href=&quot;https://web.archive.org/web/20140414081950/https://daspringate.github.io/posts/2013/05/Functional_programming_in_R.html&quot;&gt;S
language being inspired by Scheme&lt;/a&gt;.&lt;a href=&quot;#fnref2&quot;
class=&quot;footnote-back&quot; role=&quot;doc-backlink&quot;&gt;↩︎&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;
&lt;li id=&quot;fn3&quot;&gt;&lt;p&gt;A purer functional approach would have been to use the
function definition of the operators directly, i.e. to define
&lt;code&gt;operatorList&lt;/code&gt; with elements such as &lt;code&gt;`+`(e1, e2)&lt;/code&gt;
and then use these functions to build the parse tree as an expression.
The disadvantage of such an approach is that the expressions become more
cumbersome to write. For example &lt;code&gt;(5 + 3 + 2) * 4&lt;/code&gt; as
&lt;code&gt;`*`( `+`( `+`(5, 3), 2), 4)&lt;/code&gt;.&lt;a href=&quot;#fnref3&quot;
class=&quot;footnote-back&quot; role=&quot;doc-backlink&quot;&gt;↩︎&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;/section&gt;
</description>
        <pubDate>Fri, 04 Jan 2019 00:00:00 +0100</pubDate>
        <link>https://mhoehle.github.io/blog/2019/01/04/mathgenius.html</link>
        <guid isPermaLink="true">https://mhoehle.github.io/blog/2019/01/04/mathgenius.html</guid>
        
        <category>rstats</category>
        
        <category>purrr</category>
        
        <category>combinatorics</category>
        
        <category>math puzzle</category>
        
        
      </item>
    
      <item>
        <title>Is the answer to everything Gaussian?</title>
        <description>&lt;h2 id=&quot;abstract&quot;&gt;Abstract:&lt;/h2&gt;
&lt;p&gt;As an applied statistician you get in touch with many challenging
problems in need of a statistical solution. Often, your client/colleague
already has a working solution and just wants to clarify a small
statistical detail with you. Equally often, your intuition suggests you
that the working solution is not statistically adequate, but how to
substantiate this? As motivating example we use the statistical process
control methodology used in &lt;span class=&quot;citation&quot;
data-cites=&quot;sarma_etal2018&quot;&gt;Sarma et al. (2018)&lt;/span&gt; for monitoring a
binomial proportion as part of a syndromic surveillance kit.&lt;/p&gt;
&lt;center&gt;
&lt;img src=&quot;/blog/figure/source/2018-10-29-gauss/fig1a-hilight.png&quot; width=&quot;600&quot;&gt;
&lt;/center&gt;
&lt;p&gt;&lt;br&gt;
&lt;a rel=&quot;license&quot; href=&quot;http://creativecommons.org/licenses/by-sa/4.0/&quot;&gt;&lt;img alt=&quot;Creative Commons License&quot; style=&quot;border-width:0&quot; src=&quot;https://i.creativecommons.org/l/by-sa/4.0/88x31.png&quot;/&gt;&lt;/a&gt;
This work is licensed under a &lt;a rel=&quot;license&quot;
href=&quot;http://creativecommons.org/licenses/by-sa/4.0/&quot;&gt;Creative Commons
Attribution-ShareAlike 4.0 International License&lt;/a&gt;. The
markdown+Rknitr source code of this blog is available under a &lt;a
href=&quot;https://www.gnu.org/licenses/gpl-3.0.html&quot;&gt;GNU General Public
License (GPL v3)&lt;/a&gt; license from github.&lt;/p&gt;
&lt;h2 id=&quot;introduction&quot;&gt;Introduction&lt;/h2&gt;
&lt;p&gt;A few weeks ago I became aware of the publication by &lt;span
class=&quot;citation&quot; data-cites=&quot;sarma_etal2018&quot;&gt;Sarma et al. (2018)&lt;/span&gt;
who, as part of a syndromic surveillance system, monitor the time series
of a proportion with the aim of timely detecting changes. What initially
caught my intention was their figure 1A:&lt;/p&gt;
&lt;center&gt;
&lt;img src=&quot;/blog/figure/source/2018-10-29-gauss/fig1a.png&quot; width=&quot;600&quot;&gt;
&lt;/center&gt;
&lt;FONT COLOR=&quot;bbbbbb&quot;&gt;Figure : Figure 1A from &lt;span class=&quot;citation&quot;
data-cites=&quot;sarma_etal2018&quot;&gt;Sarma et al. (2018)&lt;/span&gt; showing the time
series of proportions that reports of acute respiratory infection make
up of all syndrome reports that day. &lt;/FONT&gt;
&lt;p&gt;
&lt;p&gt;Reading the details of the paper reveals that the number of daily
counts on 14 syndromes is collected and for each syndrome the proportion
of the particular syndrome out of all syndrome reports is calculated. In
other words: given that the counts for a particular day &lt;span
class=&quot;math inline&quot;&gt;\(t\)&lt;/span&gt; are &lt;span class=&quot;math inline&quot;&gt;\(y_{it},
i=1, \ldots, 14\)&lt;/span&gt;, the monitored proportion is &lt;span
class=&quot;math inline&quot;&gt;\(p_{it}
= y_{it}/\sum_{j=1}^{14} y_{jt}\)&lt;/span&gt;. It is thus clear that it’s
impossible to get beyond 100%. The more surprising was that the upper
level in the figure goes beyond it - a sign of an inadequate statistical
method. What the authors do is to compute an upper threshold for a
particular day &lt;span class=&quot;math inline&quot;&gt;\(t_{0}\)&lt;/span&gt; as
follows:&lt;/p&gt;
&lt;p&gt;&lt;span class=&quot;math display&quot;&gt;\[
U_{t_0} = \overline{p}_{t_0}(d) + k \cdot s_{t_0}(d), \quad
\text{where}\\
\quad \overline{p}_{t_0}(d) = \frac{1}{d}\sum_{t=t_0-d}^{t_0-1} p_{t}
\quad\text{and}\quad
s_{t_0}(d) = \frac{1}{d-1} \sum_{t=t_0-d}^{t_0-1}
(p_{t} - \overline{p}_{t_0}(d))^2
\]&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;is the mean and standard deviation of the &lt;span
class=&quot;math inline&quot;&gt;\(d\)&lt;/span&gt; baseline observations&lt;a href=&quot;#fn1&quot;
class=&quot;footnote-ref&quot; id=&quot;fnref1&quot; role=&quot;doc-noteref&quot;&gt;&lt;sup&gt;1&lt;/sup&gt;&lt;/a&gt;,
respectively, and &lt;span class=&quot;math inline&quot;&gt;\(k\)&lt;/span&gt; is a tuning
parameter - for 12 out of the 14 syndromes &lt;span
class=&quot;math inline&quot;&gt;\(k=2\)&lt;/span&gt; is used, but for the two syndromes
with highest proportions, including acute respiratory infections, &lt;span
class=&quot;math inline&quot;&gt;\(k=4\)&lt;/span&gt; is used. As the method looks like an
adaptation of the simple EARS method &lt;span class=&quot;citation&quot;
data-cites=&quot;fricker_etal2008&quot;&gt;(Fricker, Hegler, and Dunfee 2008)&lt;/span&gt;
to proportions, this caused me to tweet the following critical remark
(no harm intended besides the scientific criticism of using a somewhat
inadequate statistical method):&lt;/p&gt;
&lt;center&gt;
&lt;img src=&quot;/blog/figure/source/2018-10-29-gauss/tweet1.png&quot; width=&quot;600&quot;&gt;
&lt;/center&gt;
&lt;p&gt;To which one of the authors, &lt;a
href=&quot;https://twitter.com/evolution_v2&quot;&gt;Alexander Ullrich&lt;/a&gt;,
replied&lt;/p&gt;
&lt;center&gt;
&lt;img src=&quot;/blog/figure/source/2018-10-29-gauss/tweet2.png&quot; width=&quot;600&quot;&gt;
&lt;/center&gt;
&lt;p&gt;
&lt;p&gt;Initially, I replied by twitter, but realized that twitter is not a
good format for a well-balanced and thorough scientific discourse. Also,
my answers lacked exemplification and supporting numbers, so I deleted
the answers and shall instead use this blog post to provide a thorough
answer. Please note that my discussion focuses on the paper’s
statistical methodology approach - I do think the published application
is very important and I’m happy to see that the resulting Excel tool is
made available to a greater audience under a creative common
license!&lt;/p&gt;
&lt;p&gt;As much I can understand the motives, working in applied statistics
is always a balance between mathematical exactness and pragmatism. A &lt;a
href=&quot;https://quoteinvestigator.com/2011/05/13/einstein-simple/&quot;&gt;famous
quote&lt;/a&gt; says that things should be as simple as possible, but not
simpler. But if mathematical rigour always comes in second place,
something is amiss. In this light, I’d like to comment on the four
reasons given in Alexander’s reply.&lt;/p&gt;
&lt;h3 id=&quot;reason-1-2&quot;&gt;Reason 1 &amp;amp; 2:&lt;/h3&gt;
&lt;p&gt;In principle I agree and taking a non-parametric and distribution
free approach is healthy, if you fear your assumptions are more quickly
violated than you can formulate them. Using the mean plus two times
standard deviation of the &lt;span class=&quot;math inline&quot;&gt;\(d=15\)&lt;/span&gt;
baseline proportions does, however, imply certain assumptions. It means
that you believe i the distribution being sufficiently stable that the
expectation and standard deviation estimated from the baseline values is
indicative for the next observation’s expectation and standard
deviation. In other words: no trends, no day of the week effects and no
previous outbreaks are allowed in the baseline. Looking at the jump of
the upper-bound line after the single peak in June 2016 in Fig 1A one
concludes that this might be a problematic assumption. Furthermore, one
assumes that the distribution is sufficiently symmetric such that its
quantiles can be described as a number of times the standard deviations
away from the mean. Finally, by using the usual formula to estimate the
standard deviation one assumes that the observations are independent.
They are likely not and, hence, the estimated standard deviation might
be too small. All these limitations need to be mentioned and are
probably the biggest problem with the method, but could be addressed by
semi-simple modelling approaches as done, e.g., in &lt;span
class=&quot;citation&quot;
data-cites=&quot;farrington96&quot;&gt;(&lt;strong&gt;farrington96?&lt;/strong&gt;)&lt;/span&gt; for
counts.&lt;/p&gt;
&lt;p&gt;For the remainder of this post, I shall instead focus on using the
mean plus two times standard deviation (sd) rule, as I have seen it too
many times - also in other surveilance contexts. The problem we are
solving &lt;em&gt;is&lt;/em&gt; a statistical one, so writing that the
k-times-sd-rule is not meant to have a probabilistic interpretation
leaves the user alone with the choice of threshold. In particular many
users will know from their Statistics 101 class that mean plus/minus two
times sd is as a way to get approximately 95% of the mass for anything
which has a Gaussian shape. Due to the &lt;strong&gt;central limit
theorem&lt;/strong&gt; this shape will apply to a certain degree.&lt;/p&gt;
&lt;p&gt;So what we do is to compare an out-of-sample observation with a
threshold. In this case the &lt;strong&gt;prediction interval&lt;/strong&gt; for the
observation is the statistical correct object for the comparison.
Because the standard deviation is estimated from data, the prediction
interval should be based on quantiles of a t-distribution with &lt;span
class=&quot;math inline&quot;&gt;\(d-1\)&lt;/span&gt; degrees of freedom. In this case the
appropriate upper limit of a two-sided &lt;span
class=&quot;math inline&quot;&gt;\((1-\alpha)\cdot 100%\)&lt;/span&gt; prediction interval
is given as&lt;/p&gt;
&lt;p&gt;&lt;span class=&quot;math display&quot;&gt;\[
\begin{align} \label{eq:predict-ul-gauss} \
U_{t_0} = \overline{p}_{t_0}(d) +
  t_{1-\alpha/2}(d-1) \cdot \sqrt{1+\frac{1}{d}} \cdot s_{t_0}(d),
  \end{align}
\]&lt;/span&gt; where &lt;span class=&quot;math inline&quot;&gt;\(t_{1-\alpha/2}(d-1)\)&lt;/span&gt;
denotes the &lt;span class=&quot;math inline&quot;&gt;\(1-\alpha/2\)&lt;/span&gt; quantile of
the t-distribution with &lt;span class=&quot;math inline&quot;&gt;\(d-1\)&lt;/span&gt; degrees
of freedom. In our case &lt;span class=&quot;math inline&quot;&gt;\(\alpha=0.05\)&lt;/span&gt;
so we need the 97.5% quantile. See for example Chapter 10 of &lt;span
class=&quot;citation&quot; data-cites=&quot;young_smith2005&quot;&gt;Young and Smith
(2005)&lt;/span&gt; or the Wikipedia page on &lt;a
href=&quot;https://en.wikipedia.org/wiki/Prediction_interval#Unknown_mean,_unknown_variance&quot;&gt;prediction
intervals&lt;/a&gt; for details.&lt;/p&gt;
&lt;p&gt;With &lt;span class=&quot;math inline&quot;&gt;\(d=15\)&lt;/span&gt; &lt;a href=&quot;#fn2&quot;
class=&quot;footnote-ref&quot; id=&quot;fnref2&quot; role=&quot;doc-noteref&quot;&gt;&lt;sup&gt;2&lt;/sup&gt;&lt;/a&gt; the
upper limit of a one-sided 97.5% prediction interval would have the
multiplication factor 2.22 on the estimated standard deviation. Using a
factor of 2 instead means your procedure is slightly more sensitive than
the possibly anticipated 2.5% false alarm probability. Calculations show
that the false alarm probability under the null hypothesis is 3.7%
(assuming the Gaussian assumption holds). For the sake of simplicity one
can say that this difference in the &lt;span
class=&quot;math inline&quot;&gt;\(d=15\)&lt;/span&gt; case appears ignorable. Had &lt;span
class=&quot;math inline&quot;&gt;\(d\)&lt;/span&gt; been smaller the difference becomes
more relevant though.&lt;/p&gt;
&lt;h3 id=&quot;reason-3&quot;&gt;Reason 3&lt;/h3&gt;
&lt;p&gt;I’m not sure I got the point, but one problem is that if your
baseline consists of the observations &lt;span
class=&quot;math inline&quot;&gt;\(y\)&lt;/span&gt;, &lt;span
class=&quot;math inline&quot;&gt;\(y\)&lt;/span&gt;, &lt;span
class=&quot;math inline&quot;&gt;\(\ldots\)&lt;/span&gt;, &lt;span
class=&quot;math inline&quot;&gt;\(y\)&lt;/span&gt; then the upper limit by your method
will also be &lt;span class=&quot;math inline&quot;&gt;\(y\)&lt;/span&gt;, because the
estimated standard deviation will be zero. Another problem is if the
denominator &lt;span class=&quot;math inline&quot;&gt;\(n_t\)&lt;/span&gt; is zero, but
because this appears to have a regular shape (no reports on weekends),
this can just be left out of the modelling?&lt;/p&gt;
&lt;h3 id=&quot;reason-4&quot;&gt;Reason 4&lt;/h3&gt;
&lt;p&gt;This reason I find particular troublesome, because it is an argument
statisticians hear often. A wider audience expects a
&lt;strong&gt;valid&lt;/strong&gt; statistical method, not more complicated than
necessary, but &lt;strong&gt;sound&lt;/strong&gt; and available within the tools at
hand. I argued above that two times standard deviation for proportions
might be working, but you implicitly leave a lot of problems for the
user to solve due to insufficient statistical modelling. I agree that
too complicated might not work, but if -for the sake of pragmatism- we
neither inform or quantify potential problems of a &lt;em&gt;too
simplistic&lt;/em&gt; solution nor fail to provide something workable which is
better, we’ll be out of a job quickly.&lt;/p&gt;
&lt;h2 id=&quot;can-we-do-better&quot;&gt;Can we do better?&lt;/h2&gt;
&lt;p&gt;Initially it appeared natural to either try a data or parameter
transformation in order to ensure that the computed upper limit respects
the &lt;span class=&quot;math inline&quot;&gt;\([0,1]\)&lt;/span&gt; bound. However, all
suggestions I tried proved problematic one way or the other, e.g., due
to small sample sizes or proportions being zero. Instead, a simple
Bayesian and a simple non-parametric variant are considered.&lt;/p&gt;
&lt;h4 id=&quot;beta-binomial&quot;&gt;Beta-Binomial&lt;/h4&gt;
&lt;p&gt;A simple approach is to use a conjugate prior-posterior Bayesian
updating scheme. Letting &lt;span class=&quot;math inline&quot;&gt;\(\pi_{t_0}\)&lt;/span&gt;
be the true underlying proportion at time &lt;span
class=&quot;math inline&quot;&gt;\(t_0\)&lt;/span&gt; which we try to estimate from the
baseline data, we assume a &lt;span
class=&quot;math inline&quot;&gt;\(\operatorname{Be}(0.5, 0.5)\)&lt;/span&gt; prior for it
initially. Observing &lt;span class=&quot;math inline&quot;&gt;\(y_{t} \sim
\operatorname{Bin}(n_t, \pi_{t_0})\)&lt;/span&gt; for &lt;span
class=&quot;math inline&quot;&gt;\(t=t_0-d,
\ldots, t_0-1\)&lt;/span&gt;, the posterior for &lt;span
class=&quot;math inline&quot;&gt;\(\pi_{t_0}\)&lt;/span&gt; will be &lt;span
class=&quot;math display&quot;&gt;\[
\pi_{t_0} | y_{t_0-d},
\ldots, y_{t_0-1} \sim
\operatorname{Be}\left(0.5 + \sum_{t=t_0-d}^{t_0-1} y_t, 0.5 +
\sum_{t=t_0-d}^{t_0-1} (n_t - y_t)\right)
\]&lt;/span&gt; One can then show that the posterior predictive distribution
for the next observation, i.e. &lt;span
class=&quot;math inline&quot;&gt;\(y_{t_0}\)&lt;/span&gt;, is &lt;span class=&quot;math display&quot;&gt;\[
y_{t_0} | y_{t_0-d}, \ldots, y_{t_0-1} \sim
\operatorname{BeBin}\left(n_{t_0}, 0.5 + \sum_{t=t_0-d}^{t_0-1} y_t, 0.5
+ \sum_{t=t_0-d}^{t_0-1} (n_t - y_t)\right),
\]&lt;/span&gt; where &lt;span class=&quot;math inline&quot;&gt;\(\operatorname{BeBin}(n, a,
b)\)&lt;/span&gt; denotes the &lt;a
href=&quot;https://en.wikipedia.org/wiki/Beta-binomial_distribution&quot;&gt;beta-binomial
distribution&lt;/a&gt; with size parameter &lt;span
class=&quot;math inline&quot;&gt;\(n\)&lt;/span&gt; and the two shape parameters &lt;span
class=&quot;math inline&quot;&gt;\(a\)&lt;/span&gt; and &lt;span
class=&quot;math inline&quot;&gt;\(b\)&lt;/span&gt; implemented in, e.g., the &lt;a
href=&quot;https://cran.r-project.org/web/packages/VGAM/index.html&quot;&gt;&lt;code&gt;VGAM&lt;/code&gt;
package&lt;/a&gt;. We then use the upper 97.5% quantile of this distribution
to define the threshold &lt;span class=&quot;math inline&quot;&gt;\(U_{t_0}\)&lt;/span&gt; for
&lt;span class=&quot;math inline&quot;&gt;\(p_{t_0}\)&lt;/span&gt; and sound an alarm if &lt;span
class=&quot;math inline&quot;&gt;\(p_{t_0} &amp;gt; U_{t_0}\)&lt;/span&gt;.&lt;/p&gt;
&lt;p&gt;A simple variant of this procedure is to use a &lt;em&gt;plug-in&lt;/em&gt; type
prediction interval by obtaining the upper limit as the 97.5% quantile
of the binomial with size parameter &lt;span
class=&quot;math inline&quot;&gt;\(n_{t_0}\)&lt;/span&gt; and probability &lt;span
class=&quot;math inline&quot;&gt;\(\overline{p}_{t_0}\)&lt;/span&gt;. However, this
approach ignores all uncertainty originating from the estimation of
&lt;span class=&quot;math inline&quot;&gt;\(\pi_{t_0}\)&lt;/span&gt; by &lt;span
class=&quot;math inline&quot;&gt;\(p_{t_0}\)&lt;/span&gt; and, hence, is likely to result
in somewhat narrower prediction intervals than the Beta-Binomial
approach.&lt;/p&gt;
&lt;h2 id=&quot;non-parametric&quot;&gt;Non-parametric&lt;/h2&gt;
&lt;p&gt;A non-parametric one-sided 97.5% prediction interval &lt;span
class=&quot;math inline&quot;&gt;\([0, U]\)&lt;/span&gt; based on the continuous values
&lt;span class=&quot;math inline&quot;&gt;\(p_{t_0-39},\ldots, p_{t_0-1}\)&lt;/span&gt;
without ties is given as (see e.g. &lt;span class=&quot;citation&quot;
data-cites=&quot;arts_etal2004&quot;&gt;Arts, Coolen, and van der Laan (2004)&lt;/span&gt;
or the Wikipedia entry on &lt;a
href=&quot;https://en.wikipedia.org/wiki/Prediction_interval#Non-parametric_methods&quot;&gt;non-parametric
prediction intervals&lt;/a&gt;): &lt;span class=&quot;math display&quot;&gt;\[
U_{t_0} = \max(p_{t_0-39},\ldots, p_{t_0-1}).
\]&lt;/span&gt; Hence, an alarm is flagged if &lt;span
class=&quot;math inline&quot;&gt;\(p_{t_0}&amp;gt; U_{t_0}\)&lt;/span&gt;. This means we simply
compare the current value with the maximum of the baseline values. If we
only have &lt;span class=&quot;math inline&quot;&gt;\(d=19\)&lt;/span&gt; values, then the
interval from zero to the maximum of these values would constitute a
one-sided 95% prediction interval.&lt;/p&gt;
&lt;h2 id=&quot;simulation-study&quot;&gt;Simulation Study&lt;/h2&gt;
&lt;p&gt;We consider the false alarm proportion of the suggested method (2
times and 4 times standard deviation, as well as the prediction interval
method and a beta-binomial approach by simulating from a null model,
where &lt;span class=&quot;math inline&quot;&gt;\(d+1\)&lt;/span&gt; observations are iid.
from a binomial distribution &lt;span
class=&quot;math inline&quot;&gt;\(\operatorname{Bin}(25, \pi)\)&lt;/span&gt;. The first
&lt;span class=&quot;math inline&quot;&gt;\(d\)&lt;/span&gt; observations are used for
estimation and then upper limit computed by the algorithm is compared to
the last observations. Note: the non-parametric method requires the
simulation of 39+1 values. For all methods: If the last observation
exceeds the upper limit an alarm is sounded. We will be interested in
the false alarm probability, i.e. the probability that an alarm is
sounded even though we know that the last observation originates from
the same model as the baseline parameters. For the methods using a 97.5%
one-sided prediction interval, we expect this false error probability to
be 2.5%.&lt;/p&gt;
&lt;p&gt;The function implementing the six algorithms to compare looks as
follows:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb1&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb1-1&quot;&gt;&lt;a href=&quot;#cb1-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;algo_sysu_all &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;cf&quot;&gt;function&lt;/span&gt;(y, n, t0, d) {&lt;/span&gt;
&lt;span id=&quot;cb1-2&quot;&gt;&lt;a href=&quot;#cb1-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;stopifnot&lt;/span&gt;(t0&lt;span class=&quot;sc&quot;&gt;-&lt;/span&gt;d &lt;span class=&quot;sc&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;dv&quot;&gt;0&lt;/span&gt;)&lt;/span&gt;
&lt;span id=&quot;cb1-3&quot;&gt;&lt;a href=&quot;#cb1-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  p &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; y&lt;span class=&quot;sc&quot;&gt;/&lt;/span&gt;n&lt;/span&gt;
&lt;span id=&quot;cb1-4&quot;&gt;&lt;a href=&quot;#cb1-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  baseline_idx &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; (t0&lt;span class=&quot;dv&quot;&gt;-1&lt;/span&gt;)&lt;span class=&quot;sc&quot;&gt;:&lt;/span&gt;(t0&lt;span class=&quot;sc&quot;&gt;-&lt;/span&gt;d)&lt;/span&gt;
&lt;span id=&quot;cb1-5&quot;&gt;&lt;a href=&quot;#cb1-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  baseline &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; p[baseline_idx]&lt;/span&gt;
&lt;span id=&quot;cb1-6&quot;&gt;&lt;a href=&quot;#cb1-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  m &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;mean&lt;/span&gt;(baseline)&lt;/span&gt;
&lt;span id=&quot;cb1-7&quot;&gt;&lt;a href=&quot;#cb1-7&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  sd &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;sd&lt;/span&gt;(baseline)&lt;/span&gt;
&lt;span id=&quot;cb1-8&quot;&gt;&lt;a href=&quot;#cb1-8&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  U_twosd &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt;  m &lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;*&lt;/span&gt;sd&lt;/span&gt;
&lt;span id=&quot;cb1-9&quot;&gt;&lt;a href=&quot;#cb1-9&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  U_pred &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; m &lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;sqrt&lt;/span&gt;(&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;/&lt;/span&gt;d)&lt;span class=&quot;sc&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;qt&lt;/span&gt;(&lt;span class=&quot;fl&quot;&gt;0.975&lt;/span&gt;, &lt;span class=&quot;at&quot;&gt;df=&lt;/span&gt;d&lt;span class=&quot;dv&quot;&gt;-1&lt;/span&gt;)&lt;span class=&quot;sc&quot;&gt;*&lt;/span&gt;sd&lt;/span&gt;
&lt;span id=&quot;cb1-10&quot;&gt;&lt;a href=&quot;#cb1-10&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  U_foursd &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt;  m &lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;dv&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;*&lt;/span&gt;sd&lt;/span&gt;
&lt;span id=&quot;cb1-11&quot;&gt;&lt;a href=&quot;#cb1-11&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-12&quot;&gt;&lt;a href=&quot;#cb1-12&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;do&quot;&gt;##Beta binomial&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-13&quot;&gt;&lt;a href=&quot;#cb1-13&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  astar &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fl&quot;&gt;0.5&lt;/span&gt; &lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;sum&lt;/span&gt;(y[baseline_idx])&lt;/span&gt;
&lt;span id=&quot;cb1-14&quot;&gt;&lt;a href=&quot;#cb1-14&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  bstar &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fl&quot;&gt;0.5&lt;/span&gt; &lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;sum&lt;/span&gt;((n[baseline_idx] &lt;span class=&quot;sc&quot;&gt;-&lt;/span&gt; y[baseline_idx]))&lt;/span&gt;
&lt;span id=&quot;cb1-15&quot;&gt;&lt;a href=&quot;#cb1-15&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  U_betabinom &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;qbetabinom.ab&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;q=&lt;/span&gt;&lt;span class=&quot;fl&quot;&gt;0.975&lt;/span&gt;, &lt;span class=&quot;at&quot;&gt;size=&lt;/span&gt;n[t0], &lt;span class=&quot;at&quot;&gt;shape1=&lt;/span&gt;astar, &lt;span class=&quot;at&quot;&gt;shape2=&lt;/span&gt;bstar) &lt;span class=&quot;sc&quot;&gt;/&lt;/span&gt; n[t0]&lt;/span&gt;
&lt;span id=&quot;cb1-16&quot;&gt;&lt;a href=&quot;#cb1-16&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-17&quot;&gt;&lt;a href=&quot;#cb1-17&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;do&quot;&gt;##Prediction interval based on the Binomal directly, ignoring estimation uncertainty&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-18&quot;&gt;&lt;a href=&quot;#cb1-18&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  U_binom &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;qbinom&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;p=&lt;/span&gt;&lt;span class=&quot;fl&quot;&gt;0.975&lt;/span&gt;, &lt;span class=&quot;at&quot;&gt;size=&lt;/span&gt;n[t0], &lt;span class=&quot;at&quot;&gt;prob=&lt;/span&gt;m) &lt;span class=&quot;sc&quot;&gt;/&lt;/span&gt; n[t0]&lt;/span&gt;
&lt;span id=&quot;cb1-19&quot;&gt;&lt;a href=&quot;#cb1-19&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-20&quot;&gt;&lt;a href=&quot;#cb1-20&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;do&quot;&gt;##Non-parametric with a 97.5% one-sided PI (this approach needs 39 obs)&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-21&quot;&gt;&lt;a href=&quot;#cb1-21&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  U_nonpar &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;max&lt;/span&gt;( p[(t0&lt;span class=&quot;dv&quot;&gt;-1&lt;/span&gt;)&lt;span class=&quot;sc&quot;&gt;:&lt;/span&gt;(t0&lt;span class=&quot;dv&quot;&gt;-39&lt;/span&gt;)])&lt;/span&gt;
&lt;span id=&quot;cb1-22&quot;&gt;&lt;a href=&quot;#cb1-22&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-23&quot;&gt;&lt;a href=&quot;#cb1-23&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;do&quot;&gt;##Done&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-24&quot;&gt;&lt;a href=&quot;#cb1-24&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;return&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;data.frame&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;t=&lt;/span&gt;t0, &lt;span class=&quot;at&quot;&gt;U_twosd=&lt;/span&gt;U_twosd, &lt;span class=&quot;at&quot;&gt;U_foursd=&lt;/span&gt;U_foursd, &lt;span class=&quot;at&quot;&gt;U_pred=&lt;/span&gt;U_pred, &lt;span class=&quot;at&quot;&gt;U_betabinom=&lt;/span&gt;U_betabinom, &lt;span class=&quot;at&quot;&gt;U_nonpar=&lt;/span&gt;U_nonpar, &lt;span class=&quot;at&quot;&gt;U_binom=&lt;/span&gt;U_binom))&lt;/span&gt;
&lt;span id=&quot;cb1-25&quot;&gt;&lt;a href=&quot;#cb1-25&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;This can be wrapped into a function performing a single simulation
:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb2&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb2-1&quot;&gt;&lt;a href=&quot;#cb2-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##Simulate one iid binomial time series&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb2-2&quot;&gt;&lt;a href=&quot;#cb2-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;simone &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;cf&quot;&gt;function&lt;/span&gt;(pi0, &lt;span class=&quot;at&quot;&gt;d=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;21&lt;/span&gt;, &lt;span class=&quot;at&quot;&gt;n=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;25&lt;/span&gt;) {&lt;/span&gt;
&lt;span id=&quot;cb2-3&quot;&gt;&lt;a href=&quot;#cb2-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  length_ts &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;max&lt;/span&gt;(&lt;span class=&quot;dv&quot;&gt;39&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;, d&lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;)&lt;/span&gt;
&lt;span id=&quot;cb2-4&quot;&gt;&lt;a href=&quot;#cb2-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  y &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;rbinom&lt;/span&gt;(length_ts, &lt;span class=&quot;at&quot;&gt;size=&lt;/span&gt;n, &lt;span class=&quot;at&quot;&gt;prob=&lt;/span&gt;pi0)&lt;/span&gt;
&lt;span id=&quot;cb2-5&quot;&gt;&lt;a href=&quot;#cb2-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  n &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;rep&lt;/span&gt;(n, length_ts)&lt;/span&gt;
&lt;span id=&quot;cb2-6&quot;&gt;&lt;a href=&quot;#cb2-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  p &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; y&lt;span class=&quot;sc&quot;&gt;/&lt;/span&gt;n&lt;/span&gt;
&lt;span id=&quot;cb2-7&quot;&gt;&lt;a href=&quot;#cb2-7&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  res &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;algo_sysu_all&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;y=&lt;/span&gt;y, &lt;span class=&quot;at&quot;&gt;n=&lt;/span&gt;n, &lt;span class=&quot;at&quot;&gt;t0=&lt;/span&gt;length_ts, &lt;span class=&quot;at&quot;&gt;d=&lt;/span&gt;d)&lt;/span&gt;
&lt;span id=&quot;cb2-8&quot;&gt;&lt;a href=&quot;#cb2-8&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;return&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;c&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;twosd=&lt;/span&gt;res&lt;span class=&quot;sc&quot;&gt;$&lt;/span&gt;U_twosd, &lt;span class=&quot;at&quot;&gt;foursd=&lt;/span&gt;res&lt;span class=&quot;sc&quot;&gt;$&lt;/span&gt;U_foursd, &lt;span class=&quot;at&quot;&gt;pred=&lt;/span&gt;res&lt;span class=&quot;sc&quot;&gt;$&lt;/span&gt;U_pred, &lt;span class=&quot;at&quot;&gt;betabinom=&lt;/span&gt;res&lt;span class=&quot;sc&quot;&gt;$&lt;/span&gt;U_betabinom, &lt;span class=&quot;at&quot;&gt;nonpar=&lt;/span&gt;res&lt;span class=&quot;sc&quot;&gt;$&lt;/span&gt;U_nonpar, &lt;span class=&quot;at&quot;&gt;binom=&lt;/span&gt;res&lt;span class=&quot;sc&quot;&gt;$&lt;/span&gt;U_binom) &lt;span class=&quot;sc&quot;&gt;&amp;lt;&lt;/span&gt; p[length_ts])&lt;/span&gt;
&lt;span id=&quot;cb2-9&quot;&gt;&lt;a href=&quot;#cb2-9&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;We then perform the simulation study using several cores using the &lt;a
href=&quot;https://cran.r-project.org/web/packages/future/index.html&quot;&gt;&lt;code&gt;future&lt;/code&gt;&lt;/a&gt;
and &lt;a
href=&quot;https://cran.r-project.org/web/packages/future/index.html&quot;&gt;&lt;code&gt;future.apply&lt;/code&gt;&lt;/a&gt;
packages by &lt;a href=&quot;https://twitter.com/henrikbengtsson&quot;&gt;Henrik
Bengtsson&lt;/a&gt;:&lt;/p&gt;
&lt;center&gt;
&lt;img src=&quot;/blog/figure/source/2018-10-29-gauss/PLOTFAP-1.png&quot; style=&quot;display: block; margin: auto;&quot; /&gt;
&lt;/center&gt;
&lt;FONT COLOR=&quot;bbbbbb&quot;&gt;Figure 2: False positive probability for different
&lt;span class=&quot;math inline&quot;&gt;\(\pi\)&lt;/span&gt; values each estimated by 10,000
Monte Carlo simulations. &lt;/FONT&gt;
&lt;p&gt;
&lt;p&gt;In the figure we see that both the two and four times standard
deviation approach (twosd, foursd) as well as the approach based on the
97.5% predictive distribution in a Gaussian setting (pred) have a
varying FAP over the range of true proportions: The smaller &lt;span
class=&quot;math inline&quot;&gt;\(\pi\)&lt;/span&gt; the higher the FAP: The FAP can be as
high as 7% instead of the nominal 2.5%. When monitoring 145 time points
this means that we will on average see &lt;span
class=&quot;math inline&quot;&gt;\(145\cdot 0.07=10\)&lt;/span&gt; false alarms, if the
process does not change. This is problematic, because the behaviour of
the detection procedure depends on the underlying &lt;span
class=&quot;math inline&quot;&gt;\(\pi\)&lt;/span&gt;: the user will get way more false
alarm at low &lt;span class=&quot;math inline&quot;&gt;\(\pi\)&lt;/span&gt;’s than possibly
expecting. Altogether, it appears better to use a slightly higher
threshold than 2. However, &lt;span class=&quot;math inline&quot;&gt;\(k=4\)&lt;/span&gt;
looks awfully conservative!&lt;/p&gt;
&lt;p&gt;All considered procedures dip down to a FAP of 0% for &lt;span
class=&quot;math inline&quot;&gt;\(\pi\)&lt;/span&gt; near 100%, which means no alarms are
sounded here. This is related to the fact that if &lt;span
class=&quot;math inline&quot;&gt;\(U_{t_0}=n_{t_0}\)&lt;/span&gt; then, because &lt;span
class=&quot;math inline&quot;&gt;\(p_{t_0} &amp;gt;
U_{t_0}\)&lt;/span&gt; is required before an alarm will be sounded, no alarm
is possible. Furthermore, both the beta-binomial, the binomial variant
and the non-parametric procedure have FAPs slightly lower than the
nominal 2.5%. This is again related to the discreteness of the problem:
It might not be possible to find an integer limit &lt;span
class=&quot;math inline&quot;&gt;\(U\)&lt;/span&gt; such that the CDF at &lt;span
class=&quot;math inline&quot;&gt;\(U\)&lt;/span&gt; is exactly 97.5%, i.e. usually &lt;span
class=&quot;math inline&quot;&gt;\(F(q_{0.975})&amp;gt;0.975\)&lt;/span&gt;. Because we only
sound alarms if &lt;span class=&quot;math inline&quot;&gt;\(y_{t_0} &amp;gt; U\)&lt;/span&gt;,
i.e. the probability for this to occur is even smaller, namely, &lt;span
class=&quot;math inline&quot;&gt;\(1-F(q_{0.975}+1)\)&lt;/span&gt;.&lt;/p&gt;
&lt;p&gt;Note that in the above simulation study the binomial and
beta-binomial models are in advantage, because the model used to
simulate data is identical and closely identical, respectively, to how
data are simulated. In order to make the simulation more comprehensive
we investigate an additional scenario where the marginal distribution
are binomial &lt;span class=&quot;math inline&quot;&gt;\(\operatorname{Bin}(25,
0.215)\)&lt;/span&gt;, but are correlated&lt;a href=&quot;#fn3&quot; class=&quot;footnote-ref&quot;
id=&quot;fnref3&quot; role=&quot;doc-noteref&quot;&gt;&lt;sup&gt;3&lt;/sup&gt;&lt;/a&gt;. We simulate variables
&lt;span class=&quot;math inline&quot;&gt;\(y_t^*\)&lt;/span&gt; using an &lt;span
class=&quot;math inline&quot;&gt;\(AR(1)\)&lt;/span&gt; process with parameter &lt;span
class=&quot;math inline&quot;&gt;\(\rho\)&lt;/span&gt;, &lt;span class=&quot;math inline&quot;&gt;\(|\rho|
&amp;lt; 1\)&lt;/span&gt;, i.e. &lt;span class=&quot;math display&quot;&gt;\[
y_t^* | y_{t-1}^* = \rho \cdot y_{t-1}^* + \epsilon_t, \quad
t=2,3,\ldots,
\]&lt;/span&gt; where &lt;span class=&quot;math inline&quot;&gt;\(y_1^* \sim N(0,1)\)&lt;/span&gt;
and &lt;span class=&quot;math inline&quot;&gt;\(\epsilon_t \stackrel{\text{iid}}{\sim}
N(0,1)\)&lt;/span&gt;. These latent variables are then marginally
back-transformed to standard uniforms &lt;span class=&quot;math inline&quot;&gt;\(u_t
\sim U(0,1)\)&lt;/span&gt; using the &lt;a
href=&quot;https://en.wikipedia.org/wiki/Probability_integral_transform&quot;&gt;probability
integral transform&lt;/a&gt; and are then transformed using the quantile
function of the &lt;span class=&quot;math inline&quot;&gt;\(\operatorname{Bin}(25,
0.215)\)&lt;/span&gt; distribution, i.e.&lt;/p&gt;
&lt;center&gt;
&lt;span class=&quot;math inline&quot;&gt;\(y_t\)&lt;/span&gt; =
&lt;code&gt;qbinom(pnorm(ystar[t]))&lt;/code&gt;
&lt;/center&gt;
&lt;p&gt;
&lt;p&gt;Altogether, this corresponds to a &lt;a
href=&quot;https://stackoverflow.com/questions/10535235/generate-correlated-random-numbers-from-binomial-distributions-in-r#10540234&quot;&gt;Gaussian
copula&lt;/a&gt; approach for generating correlated random variables with a
given marginal distribution. The correlation between the &lt;span
class=&quot;math inline&quot;&gt;\(y_t\)&lt;/span&gt; will not be exactly &lt;span
class=&quot;math inline&quot;&gt;\(\rho\)&lt;/span&gt; due to the discrete nature of the
binomial, but will approach &lt;span class=&quot;math inline&quot;&gt;\(\rho\)&lt;/span&gt; as
&lt;span class=&quot;math inline&quot;&gt;\(n\)&lt;/span&gt; in the binomial becomes large.
Figure 3 shows the results for the false alarm probability based on
10,000 Monte Carlo simulations for marginal &lt;span
class=&quot;math inline&quot;&gt;\(\operatorname{Bin}(25, 0.215)\)&lt;/span&gt;
distribution and latent &lt;span class=&quot;math inline&quot;&gt;\(AR(1)\)&lt;/span&gt;
one-off-the-diagonal correlation parameter &lt;span
class=&quot;math inline&quot;&gt;\(\rho\)&lt;/span&gt;.&lt;/p&gt;
&lt;img src=&quot;/blog/figure/source/2018-10-29-gauss/SIMCORRELATED-1.png&quot; style=&quot;display: block; margin: auto;&quot; /&gt;
&lt;/center&gt;
&lt;FONT COLOR=&quot;bbbbbb&quot;&gt;Figure 3: Equivalent of a false alarm probability
by 10,000 Monte Carlo simulation for the algorithms when there is a
correlation &lt;span class=&quot;math inline&quot;&gt;\(\rho\)&lt;/span&gt; on the latent
scale, but the marginal mean of all observations is &lt;span
class=&quot;math inline&quot;&gt;\(\pi=0.215\)&lt;/span&gt;. &lt;/FONT&gt;
&lt;p&gt;
&lt;p&gt;We see that the binomial and beta binomial approaches sound too many
alarms as the correlation increases. Same goes for the two times
standard deviation and the predictive approach. The non-parametric
approach appears to behave slightly better.&lt;/p&gt;
&lt;h2 id=&quot;application&quot;&gt;Application&lt;/h2&gt;
&lt;p&gt;We use the &lt;strong&gt;synthetic acute respiratory infection
data&lt;/strong&gt; made available as part of the paper’s SySu Excel tool
available for &lt;a
href=&quot;https://www.rki.de/DE/Content/Gesundheitsmonitoring/Gesundheitsberichterstattung/GesundAZ/Content/A/Asylsuchende/SynSurv/SynSurv_Tab_gesamt.html&quot;&gt;download&lt;/a&gt;
under a creative common license. In what follows we focus on the time
series for the symptom &lt;em&gt;acute respiratory infections&lt;/em&gt;. Figure
shows the daily proportions 2017-01-01 until 2017-07-20 for all weekdays
as vertical bars with the monitoring starting at time point 40. Also
shown is the upper threshold &lt;span class=&quot;math inline&quot;&gt;\(U_t\)&lt;/span&gt;
for six methods discussed above.&lt;/p&gt;
&lt;center&gt;
&lt;img src=&quot;/blog/figure/source/2018-10-29-gauss/PLOTALLMONITORING-1.png&quot; style=&quot;display: block; margin: auto;&quot; /&gt;
&lt;/center&gt;
&lt;FONT COLOR=&quot;bbbbbb&quot;&gt;Figure 4: Upper bound curves for all detection
procedures.&lt;/FONT&gt;
&lt;p&gt;
&lt;p&gt;The correlation between &lt;span class=&quot;math inline&quot;&gt;\(p_{t}\)&lt;/span&gt;
and &lt;span class=&quot;math inline&quot;&gt;\(p_{t-1}\)&lt;/span&gt; in the time series is
0.04, which could be a sign that the synthetic were artificially
generated using an independence assumption.&lt;/p&gt;
&lt;p&gt;For all algorithms we see the effect on the upper threshold as spikes
enter the baseline. In particular the non-parametric method, which uses
&lt;span class=&quot;math inline&quot;&gt;\(d=39\)&lt;/span&gt; baseline values, will only
sound an alarm during 39 days after time 60, if the proportion is larger
than the &lt;span class=&quot;math inline&quot;&gt;\(p_{60} = 69.6\)&lt;/span&gt; percent
spike.&lt;/p&gt;
&lt;h2 id=&quot;discussion&quot;&gt;Discussion&lt;/h2&gt;
&lt;p&gt;This post discussed how to use statistical process control in order
to monitor a proportion within a syndromic surveillance context. The
suitability and performance of Gaussian approximations was discussed: It
was shown that the false alarm probability for this approach depends on
the level of the considered proportion and that auto-correlation also
has a substantial impact on the chart. The investigation in this post
were done in order to provide the user of such charts with a guidance on
how to choose &lt;span class=&quot;math inline&quot;&gt;\(k\)&lt;/span&gt;.&lt;/p&gt;
&lt;p&gt;Altogether, a full scientific analysis would need a more
comprehensive simulation study and likely access to the real data, but
the point of this post was to substantiate that statistical problems
need a statistical investigation. From the simulation results in this
post it appears more prudent to use &lt;span
class=&quot;math inline&quot;&gt;\(k&amp;gt;2\)&lt;/span&gt;, e.g., the upper limit of a 97.5%
one-sided prediction interval (&lt;span
class=&quot;math inline&quot;&gt;\(k\)&lt;/span&gt;=2.22) or the upper limit of a 99.5%
one-sided prediction interval (&lt;span
class=&quot;math inline&quot;&gt;\(k\)&lt;/span&gt;=3.07). Choosing &lt;span
class=&quot;math inline&quot;&gt;\(k&amp;gt;2\)&lt;/span&gt; is also supported by the fact that
&lt;span class=&quot;citation&quot; data-cites=&quot;sarma_etal2018&quot;&gt;Sarma et al.
(2018)&lt;/span&gt; report that none of the 204 signals generated by the
system were subsequently interpreted as an outbreak. Furthermore, a
simple fix to avoid confusion could be to chop the upper threshold at
100% in the graphics, i.e. to report &lt;span class=&quot;math inline&quot;&gt;\(U_t^* =
\max(1, U_t)\)&lt;/span&gt; for the Gaussian based procedures. Better would be
to use the predictive approach and let the user choose &lt;span
class=&quot;math inline&quot;&gt;\(\alpha\)&lt;/span&gt; and thus give the parameter choice
a probabilistic interpretation. However, binomial and beta-binomial
based approaches provide more stable results over the full range of
&lt;span class=&quot;math inline&quot;&gt;\(\pi\)&lt;/span&gt; and are guaranteed to respect
the &lt;span class=&quot;math inline&quot;&gt;\([0,1]\)&lt;/span&gt; support. In particular
the &lt;strong&gt;non-parametric method looks promising&lt;/strong&gt; despite being
even simpler than the proposed k-sd-system. All in all, addressing
trends or other type of auto-correlation as well as previous outbreaks
in the baseline appears to be important in order to get a more specific
syndromic surveillance system - see Sect. 3.4 of &lt;span class=&quot;citation&quot;
data-cites=&quot;salmon_etal2016a&quot;&gt;Salmon, Schumacher, and Höhle
(2016)&lt;/span&gt; for how this could look. I invite you to read the &lt;span
class=&quot;citation&quot; data-cites=&quot;sarma_etal2018&quot;&gt;Sarma et al. (2018)&lt;/span&gt;
paper to form your own opinion.&lt;/p&gt;
&lt;h4 id=&quot;acknowledgments&quot;&gt;Acknowledgments&lt;/h4&gt;
&lt;p&gt;The contents of this post were discussed as part of the ht2018
Statistical Consultancy M.Sc. course at the Department of Mathematics,
Stockholm University. I thank Jan-Olov Persson, Rolf Sundberg and the
students of the course for their comments, remarks and questions.&lt;/p&gt;
&lt;h4 id=&quot;conflict-of-interest&quot;&gt;Conflict of Interest&lt;/h4&gt;
&lt;p&gt;I have previously worked for the Robert Koch Institute. Some of the
co-authors of the &lt;span class=&quot;citation&quot;
data-cites=&quot;sarma_etal2018&quot;&gt;Sarma et al. (2018)&lt;/span&gt; paper are
previous colleagues, which I have published together with.&lt;/p&gt;
&lt;h2 class=&quot;unnumbered&quot; id=&quot;literature&quot;&gt;Literature&lt;/h2&gt;
&lt;div id=&quot;refs&quot; class=&quot;references csl-bib-body hanging-indent&quot;
data-entry-spacing=&quot;0&quot; role=&quot;list&quot;&gt;
&lt;div id=&quot;ref-arts_etal2004&quot; class=&quot;csl-entry&quot; role=&quot;listitem&quot;&gt;
Arts, G. R. J., F. P. A. Coolen, and P. van der Laan. 2004.
&lt;span&gt;“Nonparametric Predictive Inference in Statistical Process
Control.”&lt;/span&gt; &lt;em&gt;Quality Technology &amp;amp; Quantitative
Management&lt;/em&gt; 1 (2): 201–16.
&lt;/div&gt;
&lt;div id=&quot;ref-fricker_etal2008&quot; class=&quot;csl-entry&quot; role=&quot;listitem&quot;&gt;
Fricker, R. D., B. L. Hegler, and D. A. Dunfee. 2008. &lt;span&gt;“&lt;span
class=&quot;nocase&quot;&gt;&lt;span&gt;C&lt;/span&gt;omparing syndromic surveillance detection
methods: &lt;span&gt;E&lt;/span&gt;&lt;span&gt;A&lt;/span&gt;&lt;span&gt;R&lt;/span&gt;&lt;span&gt;S&lt;/span&gt;’
versus a
&lt;span&gt;C&lt;/span&gt;&lt;span&gt;U&lt;/span&gt;&lt;span&gt;S&lt;/span&gt;&lt;span&gt;U&lt;/span&gt;&lt;span&gt;M&lt;/span&gt;-based
methodology&lt;/span&gt;.”&lt;/span&gt; &lt;em&gt;Stat Med&lt;/em&gt; 27 (17): 3407–29.
&lt;/div&gt;
&lt;div id=&quot;ref-salmon_etal2016a&quot; class=&quot;csl-entry&quot; role=&quot;listitem&quot;&gt;
Salmon, M., D. Schumacher, and M. Höhle. 2016. &lt;span&gt;“Monitoring Count
Time Series in &lt;span&gt;R&lt;/span&gt;: Aberration Detection in Public Health
Surveillance.”&lt;/span&gt; &lt;em&gt;Journal of Statistical Software&lt;/em&gt; 70 (10).
&lt;a
href=&quot;https://doi.org/10.18637/jss.v070.i10&quot;&gt;https://doi.org/10.18637/jss.v070.i10&lt;/a&gt;.
&lt;/div&gt;
&lt;div id=&quot;ref-sarma_etal2018&quot; class=&quot;csl-entry&quot; role=&quot;listitem&quot;&gt;
Sarma, N., A. Ullrich, H. Wilking, S. Ghozzi, A. K. Lindner, C. Weber,
A. Holzer, A. Jansen, K. Stark, and S. Vygen-Bonnet. 2018. &lt;span&gt;“&lt;span
class=&quot;nocase&quot;&gt;&lt;span&gt;S&lt;/span&gt;urveillance on speed: &lt;span&gt;B&lt;/span&gt;eing
aware of infectious diseases in migrants mass accommodations - an easy
and flexible toolkit for field application of syndromic surveillance,
&lt;span&gt;G&lt;/span&gt;ermany, 2016 to 2017&lt;/span&gt;.”&lt;/span&gt; &lt;em&gt;Euro
Surveill.&lt;/em&gt; 23 (40).
&lt;/div&gt;
&lt;div id=&quot;ref-young_smith2005&quot; class=&quot;csl-entry&quot; role=&quot;listitem&quot;&gt;
Young, G. A., and R. L. Smith. 2005. &lt;em&gt;Essentials of Statistical
Inference&lt;/em&gt;. Cambridge University Press.
&lt;/div&gt;
&lt;/div&gt;
&lt;section id=&quot;footnotes&quot; class=&quot;footnotes footnotes-end-of-document&quot;
role=&quot;doc-endnotes&quot;&gt;
&lt;hr /&gt;
&lt;ol&gt;
&lt;li id=&quot;fn1&quot;&gt;&lt;p&gt;The method contains two additional parameters: one being
the minimum number of cases needed on a particular day to sound an alarm
(low-count protection) and a fixed threshold for the proportion beyond
which a signal was always created. For the sake of statistical
investigation we shall disregard these two features in the analysis of
this post.&lt;a href=&quot;#fnref1&quot; class=&quot;footnote-back&quot;
role=&quot;doc-backlink&quot;&gt;↩︎&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;
&lt;li id=&quot;fn2&quot;&gt;&lt;p&gt;In the paper d=21 was used, but due to many missing
values, e.g., due to weekends, the actual number of observations used
was on average 15. We therefore use &lt;span
class=&quot;math inline&quot;&gt;\(d=15\)&lt;/span&gt; in the blog post.&lt;a href=&quot;#fnref2&quot;
class=&quot;footnote-back&quot; role=&quot;doc-backlink&quot;&gt;↩︎&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;
&lt;li id=&quot;fn3&quot;&gt;&lt;p&gt;The 21.5% is taken from Table 2 of &lt;span
class=&quot;citation&quot; data-cites=&quot;sarma_etal2018&quot;&gt;Sarma et al. (2018)&lt;/span&gt;
for acute respiratory infections.&lt;a href=&quot;#fnref3&quot; class=&quot;footnote-back&quot;
role=&quot;doc-backlink&quot;&gt;↩︎&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;/section&gt;
</description>
        <pubDate>Mon, 29 Oct 2018 00:00:00 +0100</pubDate>
        <link>https://mhoehle.github.io/blog/2018/10/29/gauss.html</link>
        <guid isPermaLink="true">https://mhoehle.github.io/blog/2018/10/29/gauss.html</guid>
        
        <category>rstats</category>
        
        <category>stats</category>
        
        <category>statistical process control</category>
        
        <category>Gaussian</category>
        
        <category>binomial</category>
        
        <category>proportion</category>
        
        <category>data science</category>
        
        
      </item>
    
      <item>
        <title>Judging Freehand Circle Drawing Competitions</title>
        <description>&lt;h2 id=&quot;abstract&quot;&gt;Abstract:&lt;/h2&gt;
&lt;p&gt;In 2007 Alexander Overwijk went viral with his ‘Perfect Circle’
video. The same year a World Freehand Circle Drawing Championship was
organized which he won. In this post we show how a mobile camera, R and
the imager package can be used to develop an image analysis based method
to judge future instances of the championship.&lt;/p&gt;
&lt;center&gt;
&lt;img src=&quot;/blog/figure/source/2018-07-31-circle/HUD-1.png&quot; /&gt;
&lt;/center&gt;
&lt;p&gt;&lt;br&gt;
&lt;a rel=&quot;license&quot; href=&quot;http://creativecommons.org/licenses/by-sa/4.0/&quot;&gt;&lt;img alt=&quot;Creative Commons License&quot; style=&quot;border-width:0&quot; src=&quot;https://i.creativecommons.org/l/by-sa/4.0/88x31.png&quot;/&gt;&lt;/a&gt;
This work is licensed under a &lt;a rel=&quot;license&quot;
href=&quot;http://creativecommons.org/licenses/by-sa/4.0/&quot;&gt;Creative Commons
Attribution-ShareAlike 4.0 International License&lt;/a&gt;. The
markdown+Rknitr source code of this blog is available under a &lt;a
href=&quot;https://www.gnu.org/licenses/gpl-3.0.html&quot;&gt;GNU General Public
License (GPL v3)&lt;/a&gt; license from github.&lt;/p&gt;
&lt;h2 id=&quot;introduction&quot;&gt;Introduction&lt;/h2&gt;
&lt;p&gt;A few years back I watched with awe the 2007 video of &lt;a
href=&quot;https://twitter.com/AlexOverwijk&quot;&gt;Alexander Overwijk&lt;/a&gt;’s
freehand drawing a 1m diameter circle:&lt;/p&gt;
&lt;center&gt;
&lt;iframe width=&quot;560&quot; height=&quot;315&quot; src=&quot;https://www.youtube.com/embed/eAhfZUZiwSE&quot; frameborder=&quot;10&quot; allow=&quot;autoplay; encrypted-media&quot; allowfullscreen&gt;
&lt;/iframe&gt;
&lt;/center&gt;
&lt;FONT COLOR=&quot;bbbbbb&quot;&gt;Note: Depending on your browser you might need to
click “&lt;a href=&quot;https://www.youtube.com/watch?v=eAhfZUZiwSE&quot;&gt;Watch on
Youtube&lt;/a&gt;” to see the video.&lt;/FONT&gt;
&lt;p&gt;
&lt;p&gt;Ever since watching that video I have wondered how one would go about
to judge the winner of such an alleged &lt;a
href=&quot;https://www.youtube.com/watch?v=u1J5ANnq0T8&quot;&gt;World Freehand Circle
Drawing Championship&lt;/a&gt; (WFHCDC). While researching for this post I
finally figured it out. On his web page Alexander in the story behind
the video &lt;a href=&quot;http://slamdunkmath.blogspot.com&quot;&gt;“reveals”&lt;/a&gt;:&lt;/p&gt;
&lt;p&gt;&lt;em&gt;They have a laser machine called the
&lt;strong&gt;circleometer&lt;/strong&gt; that creates the perfect circle closest to
the one you drew. The circleometer then calculates the difference in
area between the laser circle and the circle that you drew. The machine
then calibrates the area difference as if you had drawn a circle with
radius one meter. The person with the smallest area difference is
declared the world freehand circle drawing champion.&lt;/em&gt;&lt;/p&gt;
&lt;p&gt;Aha! Imaginary circleometers are expensive and my dean of study most
likely isn’t open for investing in perfect circle measurement equipment…
So here is a cheaper solution involving a mobile device camera, &lt;a
href=&quot;https://www.r-project.org&quot;&gt;R&lt;/a&gt; and the &lt;a
href=&quot;https://cran.r-project.org/web/packages/imager/index.html&quot;&gt;&lt;code&gt;imager&lt;/code&gt;&lt;/a&gt;
package by &lt;a href=&quot;https://sites.google.com/site/simonbarthelme/&quot;&gt;Simon
Barthelmé&lt;/a&gt; et al. Altogether a combination of modern &lt;strong&gt;data
science&lt;/strong&gt; tools, which my dean of study is most likely to
approve! We’ll use a screenshot from the perfect circle video as
motivating example to guide through the 3 phases of the method:&lt;/p&gt;
&lt;ol type=&quot;1&quot;&gt;
&lt;li&gt;Image rectification&lt;/li&gt;
&lt;li&gt;Freehand circle identification and perfect circle estimation&lt;/li&gt;
&lt;li&gt;Quantifying deviation from the perfect circle&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;We start by loading the screenshot into R using
&lt;code&gt;imager&lt;/code&gt;:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb1&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb1-1&quot;&gt;&lt;a href=&quot;#cb1-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;library&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;quot;imager&amp;quot;&lt;/span&gt;)&lt;/span&gt;
&lt;span id=&quot;cb1-2&quot;&gt;&lt;a href=&quot;#cb1-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;file &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;st&quot;&gt;&amp;quot;circle2.png&amp;quot;&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-3&quot;&gt;&lt;a href=&quot;#cb1-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;img &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; imager&lt;span class=&quot;sc&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;load.image&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;file.path&lt;/span&gt;(fullFigPath, file))&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;img src=&quot;/blog/figure/source/2018-07-31-circle/PLOTSCREENSHOT-1.png&quot; style=&quot;display: block; margin: auto;&quot; /&gt;&lt;/p&gt;
&lt;h2 id=&quot;image-rectification&quot;&gt;Image rectification&lt;/h2&gt;
&lt;p&gt;The image clearly suffers from perspective distortions caused by the
camera being positioned to the right of the circle and, hence, not being
orthogonal to the blackboard plane. Furthermore, small lense distortions
are also visible - for example the right vertical line of the blackboard
arcs slightly. Since the video contains no details about what sort of
lense equipment was used, for the sake of simplicity, we will ignore
lense distortions in this post. If such information is available one can
use a program such as &lt;a href=&quot;http://rawtherapee.com&quot;&gt;RawTherapee&lt;/a&gt;
(available under a GNU GPL v3 license) to read the EXIF information in
the meta data of the image and automatically correct for lens
distortion.&lt;/p&gt;
&lt;p&gt;To rectify the image we estimate the parameters of the 2D projection
based on 4 ground control points (GPC). We use R’s &lt;code&gt;locator&lt;/code&gt;
function to determine the pixel location of the four corner points of
the blackboard in the image, but could just as well use any image
analysis program such as &lt;a href=&quot;https://www.gimp.org&quot;&gt;Gimp&lt;/a&gt;.
Furthermore, we need the true object coordinates of these GPC.
Unfortunately, these are only approximately available to due lack of
knowledge of the size of the blackboard in the classroom. As a
consequence a &lt;em&gt;guesstimate&lt;/em&gt; of the horizontal length is used.&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb2&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb2-1&quot;&gt;&lt;a href=&quot;#cb2-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;plot&lt;/span&gt;(img)&lt;/span&gt;
&lt;span id=&quot;cb2-2&quot;&gt;&lt;a href=&quot;#cb2-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;p &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;locator&lt;/span&gt;(&lt;span class=&quot;dv&quot;&gt;4&lt;/span&gt;)&lt;/span&gt;
&lt;span id=&quot;cb2-3&quot;&gt;&lt;a href=&quot;#cb2-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;p &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;round&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;cbind&lt;/span&gt;(p&lt;span class=&quot;sc&quot;&gt;$&lt;/span&gt;x, p&lt;span class=&quot;sc&quot;&gt;$&lt;/span&gt;y))&lt;/span&gt;
&lt;span id=&quot;cb2-4&quot;&gt;&lt;a href=&quot;#cb2-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;dump&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;list=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;c&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;quot;p&amp;quot;&lt;/span&gt;), &lt;span class=&quot;st&quot;&gt;&amp;quot;&amp;quot;&lt;/span&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;These points are now used to rectify the image by a Direct Linear
Transformation (DLT) based on exactly 4 control points &lt;span
class=&quot;citation&quot; data-cites=&quot;hartley_zisserman2004&quot;&gt;(Hartley and
Zisserman 2004, chap. 4)&lt;/span&gt;&lt;a href=&quot;#fn1&quot; class=&quot;footnote-ref&quot;
id=&quot;fnref1&quot; role=&quot;doc-noteref&quot;&gt;&lt;sup&gt;1&lt;/sup&gt;&lt;/a&gt;. That is the parameters
of the 3x3 transformation matrix &lt;span class=&quot;math inline&quot;&gt;\(H\)&lt;/span&gt;
in homogeneous coordinates are estimated such that &lt;span
class=&quot;math inline&quot;&gt;\(p&amp;#39; = H p\)&lt;/span&gt;, see the &lt;a
href=&quot;https://raw.githubusercontent.com/hoehleatsu/hoehleatsu.github.io/master/_source/2018-07-31-circle.Rmd&quot;&gt;code&lt;/a&gt;
on github for details.&lt;/p&gt;
&lt;p&gt;We can implement the rectifying transformation using the
&lt;code&gt;imager::warp&lt;/code&gt; function:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb3&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb3-1&quot;&gt;&lt;a href=&quot;#cb3-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##Transform image coordinates (x&amp;#39;,y&amp;#39;) to (x,y), i.e. note we specify&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb3-2&quot;&gt;&lt;a href=&quot;#cb3-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##the back transformation p = H * p&amp;#39;, so H here is the inverse.&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb3-3&quot;&gt;&lt;a href=&quot;#cb3-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;map.persp.inv &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;cf&quot;&gt;function&lt;/span&gt;(x,y, H) {&lt;/span&gt;
&lt;span id=&quot;cb3-4&quot;&gt;&lt;a href=&quot;#cb3-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  out_image &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; H &lt;span class=&quot;sc&quot;&gt;%*%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;rbind&lt;/span&gt;(x,y,&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;)&lt;/span&gt;
&lt;span id=&quot;cb3-5&quot;&gt;&lt;a href=&quot;#cb3-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;list&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;x=&lt;/span&gt;out_image[&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;,]&lt;span class=&quot;sc&quot;&gt;/&lt;/span&gt;out_image[&lt;span class=&quot;dv&quot;&gt;3&lt;/span&gt;,], &lt;span class=&quot;at&quot;&gt;y=&lt;/span&gt;out_image[&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;,]&lt;span class=&quot;sc&quot;&gt;/&lt;/span&gt;out_image[&lt;span class=&quot;dv&quot;&gt;3&lt;/span&gt;,])&lt;/span&gt;
&lt;span id=&quot;cb3-6&quot;&gt;&lt;a href=&quot;#cb3-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;}&lt;/span&gt;
&lt;span id=&quot;cb3-7&quot;&gt;&lt;a href=&quot;#cb3-7&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##Pad dx_blackboard pixels to the right to make space for the blackboard coming closer&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb3-8&quot;&gt;&lt;a href=&quot;#cb3-8&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;img_padded &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;pad&lt;/span&gt;(img, &lt;span class=&quot;at&quot;&gt;nPix=&lt;/span&gt;dx_blackboard, &lt;span class=&quot;at&quot;&gt;axes=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;x&amp;quot;&lt;/span&gt;, &lt;span class=&quot;at&quot;&gt;pos=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;)&lt;/span&gt;
&lt;span id=&quot;cb3-9&quot;&gt;&lt;a href=&quot;#cb3-9&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##Warp image&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb3-10&quot;&gt;&lt;a href=&quot;#cb3-10&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;warp &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;imwarp&lt;/span&gt;(img_padded, &lt;span class=&quot;at&quot;&gt;map=&lt;/span&gt;&lt;span class=&quot;cf&quot;&gt;function&lt;/span&gt;(x,y) &lt;span class=&quot;fu&quot;&gt;map.persp.inv&lt;/span&gt;(x,y,&lt;span class=&quot;fu&quot;&gt;solve&lt;/span&gt;(H)),&lt;span class=&quot;at&quot;&gt;coordinates=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;absolute&amp;quot;&lt;/span&gt;, &lt;span class=&quot;at&quot;&gt;direction=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;backward&amp;quot;&lt;/span&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;The result looks as follows:
&lt;img src=&quot;/blog/figure/source/2018-07-31-circle/PLOTRECTIFICATION-1.png&quot; style=&quot;display: block; margin: auto;&quot; /&gt;
Please notice the different x-axes of the two images when comparing
them. For faster computation and better visualization in the remainder
of this post, we crop the x-axis of the image to the relevant parts of
the circle.&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb4&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb4-1&quot;&gt;&lt;a href=&quot;#cb4-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;warp &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;imsub&lt;/span&gt;(warp, x &lt;span class=&quot;sc&quot;&gt;%inr%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;c&lt;/span&gt;(dx_blackboard, &lt;span class=&quot;fu&quot;&gt;nrow&lt;/span&gt;(warp)))&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;img src=&quot;/blog/figure/source/2018-07-31-circle/PLOTRECTIFIED-1.png&quot; style=&quot;display: block; margin: auto;&quot; /&gt;&lt;/p&gt;
&lt;h2 id=&quot;freehand-circle-identification&quot;&gt;Freehand circle
identification&lt;/h2&gt;
&lt;p&gt;As described in the &lt;code&gt;imager&lt;/code&gt; &lt;a
href=&quot;https://dahtah.github.io/imager/canny.html&quot;&gt;edge detection
tutorial&lt;/a&gt; we use length of the gradient to determine the edges in the
image. This can be done by applying filters to the image.&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb5&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb5-1&quot;&gt;&lt;a href=&quot;#cb5-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##Edge detection function. Sigma is the size of the blur window.&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb5-2&quot;&gt;&lt;a href=&quot;#cb5-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;detect.edges &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;cf&quot;&gt;function&lt;/span&gt;(im, &lt;span class=&quot;at&quot;&gt;sigma=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;) {&lt;/span&gt;
&lt;span id=&quot;cb5-3&quot;&gt;&lt;a href=&quot;#cb5-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;isoblur&lt;/span&gt;(im,sigma) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;imgradient&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;quot;xy&amp;quot;&lt;/span&gt;) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;enorm&lt;/span&gt;() &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;imsplit&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;quot;c&amp;quot;&lt;/span&gt;) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; add&lt;/span&gt;
&lt;span id=&quot;cb5-4&quot;&gt;&lt;a href=&quot;#cb5-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;}&lt;/span&gt;
&lt;span id=&quot;cb5-5&quot;&gt;&lt;a href=&quot;#cb5-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;#Edge detection filter sequence.&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb5-6&quot;&gt;&lt;a href=&quot;#cb5-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;edges &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;detect.edges&lt;/span&gt;(warp,&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; sqrt&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;To detect the circle from this we specify a few seed points for a &lt;a
href=&quot;https://en.wikipedia.org/wiki/Watershed_%28image_processing%29&quot;&gt;watershed&lt;/a&gt;
algorithm with a priority map inverse proportional to gradient
magnitude. This includes a few points inside and outside the circle and
a few points &lt;em&gt;on&lt;/em&gt; the circle. Note: a perfect circle would have
no border, but when drawing a circle with a piece of chalk it’s destined
to have a thin border line.&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/blog/figure/source/2018-07-31-circle/SEGMENTATION-1.png&quot; style=&quot;display: block; margin: auto;&quot; /&gt;
We can now extract the circle by:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb6&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb6-1&quot;&gt;&lt;a href=&quot;#cb6-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##Just the circle&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb6-2&quot;&gt;&lt;a href=&quot;#cb6-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;freehandCircle &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; (warp &lt;span class=&quot;sc&quot;&gt;*&lt;/span&gt; (mask&lt;span class=&quot;sc&quot;&gt;==&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;) &lt;span class=&quot;sc&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;dv&quot;&gt;0&lt;/span&gt;) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; grayscale&lt;/span&gt;
&lt;span id=&quot;cb6-3&quot;&gt;&lt;a href=&quot;#cb6-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##Total area covered by the circle&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb6-4&quot;&gt;&lt;a href=&quot;#cb6-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;freehandDisc &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;label&lt;/span&gt;(freehandCircle, &lt;span class=&quot;at&quot;&gt;high_connectivity=&lt;/span&gt;&lt;span class=&quot;cn&quot;&gt;TRUE&lt;/span&gt;) &lt;span class=&quot;sc&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;dv&quot;&gt;0&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;…and by morphological operations we get just the outer border as a
hairline&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb7&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb7-1&quot;&gt;&lt;a href=&quot;#cb7-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;dilatedDisc &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; freehandDisc &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;dilate_rect&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;sx=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;3&lt;/span&gt;,&lt;span class=&quot;at&quot;&gt;sy=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;3&lt;/span&gt;)&lt;/span&gt;
&lt;span id=&quot;cb7-2&quot;&gt;&lt;a href=&quot;#cb7-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;freehandCircleThinBorder &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; (freehandDisc &lt;span class=&quot;sc&quot;&gt;-&lt;/span&gt; dilatedDisc) &lt;span class=&quot;sc&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;dv&quot;&gt;0&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;img src=&quot;/blog/figure/source/2018-07-31-circle/PLOTTHINBORDER-1.png&quot; style=&quot;display: block; margin: auto;&quot; /&gt;&lt;/p&gt;
&lt;h2 id=&quot;perfect-circle-estimation&quot;&gt;Perfect circle estimation&lt;/h2&gt;
&lt;p&gt;Once the freehand circle path in the image has been identified, we
need to find the best fitting &lt;em&gt;perfect&lt;/em&gt; circle matching this
path. This problem is elegantly solved by &lt;span class=&quot;citation&quot;
data-cites=&quot;coope1993&quot;&gt;Coope (1993)&lt;/span&gt;, who formulates the problem
as finding center and radius of the circle minimizing the squared
Euclidean distance to &lt;span class=&quot;math inline&quot;&gt;\(m\)&lt;/span&gt; data points
&lt;span class=&quot;math inline&quot;&gt;\(a_j\)&lt;/span&gt;, &lt;span
class=&quot;math inline&quot;&gt;\(j=1,\ldots,m\)&lt;/span&gt;. Denoting by &lt;span
class=&quot;math inline&quot;&gt;\(c\)&lt;/span&gt; the center of the circle and by &lt;span
class=&quot;math inline&quot;&gt;\(r&amp;gt;0\)&lt;/span&gt; the radius we want to find the
solution of&lt;/p&gt;
&lt;p&gt;&lt;span class=&quot;math display&quot;&gt;\[
\min_{c\in \mathbb{R^2}, r&amp;gt;0} \sum_{j=1}^m F_j(c,r)^2,
\quad\text{where}\quad F_j(c,r) = \left|r - ||c-a_j||_2\right|,
\]&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;and &lt;span class=&quot;math inline&quot;&gt;\(||x||_2\)&lt;/span&gt; denotes Euclidean
distance. Because the curve fitting minimizes the distance between an
observed point &lt;span class=&quot;math inline&quot;&gt;\(a_j\)&lt;/span&gt; and its closest
point on the circle and thus involves both the &lt;span
class=&quot;math inline&quot;&gt;\(x\)&lt;/span&gt; and the &lt;span
class=&quot;math inline&quot;&gt;\(y\)&lt;/span&gt; direction , this is a so called
&lt;strong&gt;&lt;a
href=&quot;https://en.wikipedia.org/wiki/Total_least_squares&quot;&gt;total least
squares&lt;/a&gt;&lt;/strong&gt; problem. The problem is non-linear and can only be
solved by iterative numerical methods. However, the dimension of the
parameter space can be reduced by one, because given the center &lt;span
class=&quot;math inline&quot;&gt;\(c\)&lt;/span&gt; we can determine that &lt;span
class=&quot;math inline&quot;&gt;\(r(c)=\frac{1}{m} \sum_{j=1}^m
||c-a_j||_2\)&lt;/span&gt;.&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb8&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb8-1&quot;&gt;&lt;a href=&quot;#cb8-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##Compute radius given center&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb8-2&quot;&gt;&lt;a href=&quot;#cb8-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;radius_given_center &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;cf&quot;&gt;function&lt;/span&gt;(center, &lt;span class=&quot;at&quot;&gt;dist=&lt;/span&gt;&lt;span class=&quot;cn&quot;&gt;NULL&lt;/span&gt;) {&lt;/span&gt;
&lt;span id=&quot;cb8-3&quot;&gt;&lt;a href=&quot;#cb8-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;cf&quot;&gt;if&lt;/span&gt; (&lt;span class=&quot;fu&quot;&gt;is.null&lt;/span&gt;(dist)) {&lt;/span&gt;
&lt;span id=&quot;cb8-4&quot;&gt;&lt;a href=&quot;#cb8-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    a &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;as.matrix&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;where&lt;/span&gt;(freehandCircleThinBorder &lt;span class=&quot;sc&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;dv&quot;&gt;0&lt;/span&gt;))&lt;/span&gt;
&lt;span id=&quot;cb8-5&quot;&gt;&lt;a href=&quot;#cb8-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    dist &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;sqrt&lt;/span&gt;((a[,&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;] &lt;span class=&quot;sc&quot;&gt;-&lt;/span&gt; center[&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;])&lt;span class=&quot;sc&quot;&gt;^&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt; &lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt; (a[,&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;] &lt;span class=&quot;sc&quot;&gt;-&lt;/span&gt; center[&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;])&lt;span class=&quot;sc&quot;&gt;^&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;)&lt;/span&gt;
&lt;span id=&quot;cb8-6&quot;&gt;&lt;a href=&quot;#cb8-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  }&lt;/span&gt;
&lt;span id=&quot;cb8-7&quot;&gt;&lt;a href=&quot;#cb8-7&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;return&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;mean&lt;/span&gt;(dist))&lt;/span&gt;
&lt;span id=&quot;cb8-8&quot;&gt;&lt;a href=&quot;#cb8-8&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;}&lt;/span&gt;
&lt;span id=&quot;cb8-9&quot;&gt;&lt;a href=&quot;#cb8-9&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb8-10&quot;&gt;&lt;a href=&quot;#cb8-10&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##Target functin of the total least squares criterion of Coope (1993)&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb8-11&quot;&gt;&lt;a href=&quot;#cb8-11&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;target_tls &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;cf&quot;&gt;function&lt;/span&gt;(theta) {&lt;/span&gt;
&lt;span id=&quot;cb8-12&quot;&gt;&lt;a href=&quot;#cb8-12&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;do&quot;&gt;##Extract parameters&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb8-13&quot;&gt;&lt;a href=&quot;#cb8-13&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  center &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;exp&lt;/span&gt;(theta[&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;])&lt;/span&gt;
&lt;span id=&quot;cb8-14&quot;&gt;&lt;a href=&quot;#cb8-14&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb8-15&quot;&gt;&lt;a href=&quot;#cb8-15&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;do&quot;&gt;##Total least squares criterion from Coope (1993)&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb8-16&quot;&gt;&lt;a href=&quot;#cb8-16&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  a &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;as.matrix&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;where&lt;/span&gt;(freehandCircleThinBorder &lt;span class=&quot;sc&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;dv&quot;&gt;0&lt;/span&gt;))&lt;/span&gt;
&lt;span id=&quot;cb8-17&quot;&gt;&lt;a href=&quot;#cb8-17&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  dist &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;sqrt&lt;/span&gt;((a[,&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;] &lt;span class=&quot;sc&quot;&gt;-&lt;/span&gt; center[&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;])&lt;span class=&quot;sc&quot;&gt;^&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt; &lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt; (a[,&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;] &lt;span class=&quot;sc&quot;&gt;-&lt;/span&gt; center[&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;])&lt;span class=&quot;sc&quot;&gt;^&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;)&lt;/span&gt;
&lt;span id=&quot;cb8-18&quot;&gt;&lt;a href=&quot;#cb8-18&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;do&quot;&gt;##Compute radius given center&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb8-19&quot;&gt;&lt;a href=&quot;#cb8-19&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  radius &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;radius_given_center&lt;/span&gt;(center, dist)&lt;/span&gt;
&lt;span id=&quot;cb8-20&quot;&gt;&lt;a href=&quot;#cb8-20&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb8-21&quot;&gt;&lt;a href=&quot;#cb8-21&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  F &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;abs&lt;/span&gt;( radius &lt;span class=&quot;sc&quot;&gt;-&lt;/span&gt; dist)&lt;/span&gt;
&lt;span id=&quot;cb8-22&quot;&gt;&lt;a href=&quot;#cb8-22&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;sum&lt;/span&gt;(F&lt;span class=&quot;sc&quot;&gt;^&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;)&lt;/span&gt;
&lt;span id=&quot;cb8-23&quot;&gt;&lt;a href=&quot;#cb8-23&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;}&lt;/span&gt;
&lt;span id=&quot;cb8-24&quot;&gt;&lt;a href=&quot;#cb8-24&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb8-25&quot;&gt;&lt;a href=&quot;#cb8-25&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb8-26&quot;&gt;&lt;a href=&quot;#cb8-26&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;res_tls &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;optim&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;par=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;log&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;c&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;x=&lt;/span&gt;background[&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;,&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;], &lt;span class=&quot;at&quot;&gt;y=&lt;/span&gt;background[&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;,&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;])), &lt;span class=&quot;at&quot;&gt;fn=&lt;/span&gt;target_tls)&lt;/span&gt;
&lt;span id=&quot;cb8-27&quot;&gt;&lt;a href=&quot;#cb8-27&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;center &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;exp&lt;/span&gt;(res_tls&lt;span class=&quot;sc&quot;&gt;$&lt;/span&gt;par)&lt;/span&gt;
&lt;span id=&quot;cb8-28&quot;&gt;&lt;a href=&quot;#cb8-28&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;fit_tls &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;c&lt;/span&gt;(center,&lt;span class=&quot;at&quot;&gt;radius=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;radius_given_center&lt;/span&gt;(center))&lt;/span&gt;
&lt;span id=&quot;cb8-29&quot;&gt;&lt;a href=&quot;#cb8-29&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;fit_tls&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;##        x        y   radius 
## 894.3885 707.3191 518.4119&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;We illustrate the freehand circle (in black) and the fitted circle
(magenta) on top of each other using the alpha channel. You have to
study the image carefully to detect differences between the two
curves!&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/blog/figure/source/2018-07-31-circle/DRAWCIRCLE-1.png&quot; style=&quot;display: block; margin: auto;&quot; /&gt;&lt;/p&gt;
&lt;h2 id=&quot;quantifying-the-circularness-of-the-freehand-circle&quot;&gt;Quantifying
the circularness of the freehand circle&lt;/h2&gt;
&lt;p&gt;We quantify the &lt;strong&gt;circularness&lt;/strong&gt; of the freehand circle
by contrasting the area covered by it with the area of the fitted
perfect circle. The closer this ratio is to 1 the more perfect is the
freehand circle.&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb10&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb10-1&quot;&gt;&lt;a href=&quot;#cb10-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##Area of the freehand drawn disc&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb10-2&quot;&gt;&lt;a href=&quot;#cb10-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;areaFreehandDisc &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;sum&lt;/span&gt;(freehandDisc)&lt;/span&gt;
&lt;span id=&quot;cb10-3&quot;&gt;&lt;a href=&quot;#cb10-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb10-4&quot;&gt;&lt;a href=&quot;#cb10-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##Area of the disc corresponding to the idealized circle fitted&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb10-5&quot;&gt;&lt;a href=&quot;#cb10-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##to the freehand circle&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb10-6&quot;&gt;&lt;a href=&quot;#cb10-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;areaIdealDisc &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; pi &lt;span class=&quot;sc&quot;&gt;*&lt;/span&gt; fit_tls[&lt;span class=&quot;st&quot;&gt;&amp;quot;radius&amp;quot;&lt;/span&gt;]&lt;span class=&quot;sc&quot;&gt;^&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb10-7&quot;&gt;&lt;a href=&quot;#cb10-7&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb10-8&quot;&gt;&lt;a href=&quot;#cb10-8&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##Ratio between the two areas&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb10-9&quot;&gt;&lt;a href=&quot;#cb10-9&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;ratio_area &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;as.numeric&lt;/span&gt;(areaFreehandDisc  &lt;span class=&quot;sc&quot;&gt;/&lt;/span&gt; areaIdealDisc)&lt;/span&gt;
&lt;span id=&quot;cb10-10&quot;&gt;&lt;a href=&quot;#cb10-10&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;ratio_area&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;## [1] 0.9971778&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Yup, it’s a pretty perfect circle! Since the fitted circle already
takes the desired shape into account, my intuition is that this ratio is
a pretty good way to quantify circularness. However, to avoid
&lt;strong&gt;measurehacks&lt;/strong&gt;, we use as backup measure the circleometer
approach: for each point on the freehand circle we measure its distance
to the freehand circle and integrate/sum this up over the path of the
freehand circle. We can approximate this integration using image pixels
as follows.&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb12&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb12-1&quot;&gt;&lt;a href=&quot;#cb12-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##Create a pixel based circle in an image of the same size as the&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb12-2&quot;&gt;&lt;a href=&quot;#cb12-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##freehandCircle img. For visibility we use a border of &amp;#39;border&amp;#39; pixels&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb12-3&quot;&gt;&lt;a href=&quot;#cb12-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##s.t. circle goes [radius - border/2, radius + border/2].&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb12-4&quot;&gt;&lt;a href=&quot;#cb12-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;Circle &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;cf&quot;&gt;function&lt;/span&gt;(center, radius, border) {&lt;/span&gt;
&lt;span id=&quot;cb12-5&quot;&gt;&lt;a href=&quot;#cb12-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;as.cimg&lt;/span&gt;(&lt;span class=&quot;cf&quot;&gt;function&lt;/span&gt;(x,y) {&lt;/span&gt;
&lt;span id=&quot;cb12-6&quot;&gt;&lt;a href=&quot;#cb12-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    lhs &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; (x&lt;span class=&quot;sc&quot;&gt;-&lt;/span&gt;center[&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;])&lt;span class=&quot;sc&quot;&gt;^&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt; &lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt; (y&lt;span class=&quot;sc&quot;&gt;-&lt;/span&gt;center[&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;])&lt;span class=&quot;sc&quot;&gt;^&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb12-7&quot;&gt;&lt;a href=&quot;#cb12-7&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;fu&quot;&gt;return&lt;/span&gt;( (lhs &lt;span class=&quot;sc&quot;&gt;&amp;gt;=&lt;/span&gt; (radius&lt;span class=&quot;sc&quot;&gt;-&lt;/span&gt;border&lt;span class=&quot;sc&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;)&lt;span class=&quot;sc&quot;&gt;^&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;) &lt;span class=&quot;sc&quot;&gt;&amp;amp;&lt;/span&gt; (lhs &lt;span class=&quot;sc&quot;&gt;&amp;lt;=&lt;/span&gt; (radius&lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt;border&lt;span class=&quot;sc&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;)&lt;span class=&quot;sc&quot;&gt;^&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;))&lt;/span&gt;
&lt;span id=&quot;cb12-8&quot;&gt;&lt;a href=&quot;#cb12-8&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  }, &lt;span class=&quot;at&quot;&gt;dim=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;dim&lt;/span&gt;(freehandCircle))&lt;/span&gt;
&lt;span id=&quot;cb12-9&quot;&gt;&lt;a href=&quot;#cb12-9&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;}&lt;/span&gt;
&lt;span id=&quot;cb12-10&quot;&gt;&lt;a href=&quot;#cb12-10&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb12-11&quot;&gt;&lt;a href=&quot;#cb12-11&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##Build pixel circle based on the fitted parameters&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb12-12&quot;&gt;&lt;a href=&quot;#cb12-12&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;C_tls &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;Circle&lt;/span&gt;(fit_tls[&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;], fit_tls[&lt;span class=&quot;dv&quot;&gt;3&lt;/span&gt;], &lt;span class=&quot;at&quot;&gt;border=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;)&lt;/span&gt;
&lt;span id=&quot;cb12-13&quot;&gt;&lt;a href=&quot;#cb12-13&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##Calculate Euclidean distance to circle for each pixel in the image&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb12-14&quot;&gt;&lt;a href=&quot;#cb12-14&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;dist &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;distance_transform&lt;/span&gt;(C_tls, &lt;span class=&quot;at&quot;&gt;value=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;, &lt;span class=&quot;at&quot;&gt;metric=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;)&lt;/span&gt;
&lt;span id=&quot;cb12-15&quot;&gt;&lt;a href=&quot;#cb12-15&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##Distance between outer border of freehand circle and perfect circle&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb12-16&quot;&gt;&lt;a href=&quot;#cb12-16&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;area_difference &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;sum&lt;/span&gt;(dist[freehandCircleThinBorder&lt;span class=&quot;sc&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;0&lt;/span&gt;])&lt;/span&gt;
&lt;span id=&quot;cb12-17&quot;&gt;&lt;a href=&quot;#cb12-17&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb12-18&quot;&gt;&lt;a href=&quot;#cb12-18&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##Compute area difference and scaled it by the area of the fitted disc&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb12-19&quot;&gt;&lt;a href=&quot;#cb12-19&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;ratio_areadifference &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;as.numeric&lt;/span&gt;(area_difference &lt;span class=&quot;sc&quot;&gt;/&lt;/span&gt; areaIdealDisc)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;The image below illustrates this by overlaying the result on top of
the distance map. For better visualization we zoom in on the 270-300
degree part of the circle (i.e. the bottom right). In magenta is the
fitted perfect circle, in gray the freehand circle and the area between
the two paths is summed up over the entire path of the freehand
circle:&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/blog/figure/source/2018-07-31-circle/PLOTAREADIFF-1.png&quot; style=&quot;display: block; margin: auto;&quot; /&gt;&lt;/p&gt;
&lt;p&gt;We obtain &lt;code&gt;ratio_areadifference&lt;/code&gt;= 0.01735. Thus also this
measure tells us: it’s a pretty perfect circle! To summarise: The output
on the display of the judge’s Circle-O-Meter App (available under a GPL
v3 license) at the World Freehand Circle Drawing Championship would be
as follows: 😉&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/blog/figure/source/2018-07-31-circle/HUD-1.png&quot; style=&quot;display: block; margin: auto;&quot; /&gt;&lt;/p&gt;
&lt;h2 id=&quot;discussion&quot;&gt;Discussion&lt;/h2&gt;
&lt;p&gt;We took elements of computer vision, image analysis and total least
squares to segment a chalk-drawn circle on a blackboard and provided
measures of it’s circularness. Since we did not have direct access to
the measurements of the blackboard in object space, a little
guesstimation was necessary, nevertheless, the results show that it was
a pretty circular freehand circle!&lt;/p&gt;
&lt;p&gt;With the machinery in place for judging freehand circles, its time to
send out the call for contributions to the &lt;strong&gt;2nd World Freehand
Circle Drawing Championship&lt;/strong&gt; (online edition). Stay tuned for
the call: participants would upload their photo plus minor modifications
of a general analysis R-script computing the two area ratios measures
and submit their contribution by a pull request to the github &lt;a
href=&quot;https://github.com/hoehleatsu/worldfreehandcirclechampionship&quot;&gt;WFHCDC
repository&lt;/a&gt;. You can spend the anxious waiting time practicing your
freehand 1m diameter circles - it’s a good way to loosen up long and
unproductive meetings!&lt;/p&gt;
&lt;h2 id=&quot;appendix&quot;&gt;Appendix&lt;/h2&gt;
&lt;p&gt;If we instead of the total sum of squares criterion involving &lt;span
class=&quot;math inline&quot;&gt;\(F_j(c,r)\)&lt;/span&gt; mentioned in the text solve the
related criterion &lt;span class=&quot;math display&quot;&gt;\[
\sum_{j=1}^m f_j(c,r)^2, \quad\text{where}\quad f_j(c,r) =
||c-a_j||_2^2 - r^2,
\]&lt;/span&gt; then a much simpler solution emerges. &lt;span class=&quot;citation&quot;
data-cites=&quot;coope1993&quot;&gt;Coope (1993)&lt;/span&gt; explains that this
alternative criterion geometrically corresponds to minimizing the
product&lt;/p&gt;
&lt;p&gt;&lt;span class=&quot;math display&quot;&gt;\[
\text{(distance to the closest point on the circle)}\times
\text{(distance to
the furthest away point point on the circle)}
\]&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;over the measurement point. In order to obtain the solution write the
residuals &lt;span class=&quot;math inline&quot;&gt;\(f_j\)&lt;/span&gt; as &lt;span
class=&quot;math inline&quot;&gt;\(f_j(c,r) = c^T c - 2 c^T a_j +
a_j^T a_j - r^2\)&lt;/span&gt; and perform a change of variables from &lt;span
class=&quot;math inline&quot;&gt;\((c_1, c_2,
r)&amp;#39;\)&lt;/span&gt; to &lt;span class=&quot;math display&quot;&gt;\[
y  =
\left[
\begin{matrix}
2 c_1 \\
2 c_2 \\
r^2 - c^T c \\
\end{matrix}
\right]
\quad \text{and let} \quad
b_j =
\left[
\begin{matrix}
a_{j1} \\
a_{j2} \\
1
\end{matrix}
\right].
\]&lt;/span&gt; The minimization problem then becomes &lt;span
class=&quot;math display&quot;&gt;\[
\min_{y \in \mathbb{R}^3} \sum_{j=1}^m \left\{ a_j^T a_j - b_j^T y
\right\},
\]&lt;/span&gt; which can be written as a linear least square (LLS) expression
&lt;span class=&quot;math display&quot;&gt;\[
\min_y ||By - d||_2^2,
\]&lt;/span&gt; where &lt;span class=&quot;math inline&quot;&gt;\(B\)&lt;/span&gt; is a &lt;span
class=&quot;math inline&quot;&gt;\(3\times m\)&lt;/span&gt; matrix with the &lt;span
class=&quot;math inline&quot;&gt;\(b_j\)&lt;/span&gt;-vectors as columns and &lt;span
class=&quot;math inline&quot;&gt;\(d=||a_j||_2^2\)&lt;/span&gt;. This expression is then
easily solved using the standard least squares machinery.&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb13&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb13-1&quot;&gt;&lt;a href=&quot;#cb13-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##Fast linear least squares problem as described in Coope (1993)&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb13-2&quot;&gt;&lt;a href=&quot;#cb13-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;fitCircle_lls &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;cf&quot;&gt;function&lt;/span&gt;(freehandCircle) {&lt;/span&gt;
&lt;span id=&quot;cb13-3&quot;&gt;&lt;a href=&quot;#cb13-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  a &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;as.matrix&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;where&lt;/span&gt;(freehandCircle &lt;span class=&quot;sc&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;dv&quot;&gt;0&lt;/span&gt;))&lt;/span&gt;
&lt;span id=&quot;cb13-4&quot;&gt;&lt;a href=&quot;#cb13-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  b &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;cbind&lt;/span&gt;(a,&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;)&lt;/span&gt;
&lt;span id=&quot;cb13-5&quot;&gt;&lt;a href=&quot;#cb13-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  B &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; b&lt;/span&gt;
&lt;span id=&quot;cb13-6&quot;&gt;&lt;a href=&quot;#cb13-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  d &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; a[,&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;]&lt;span class=&quot;sc&quot;&gt;^&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt; &lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt; a[,&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;]&lt;span class=&quot;sc&quot;&gt;^&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb13-7&quot;&gt;&lt;a href=&quot;#cb13-7&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  y &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;solve&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;t&lt;/span&gt;(B) &lt;span class=&quot;sc&quot;&gt;%*%&lt;/span&gt; B) &lt;span class=&quot;sc&quot;&gt;%*%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;t&lt;/span&gt;(B) &lt;span class=&quot;sc&quot;&gt;%*%&lt;/span&gt; d&lt;/span&gt;
&lt;span id=&quot;cb13-8&quot;&gt;&lt;a href=&quot;#cb13-8&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  x &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;*&lt;/span&gt;y[&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;]&lt;/span&gt;
&lt;span id=&quot;cb13-9&quot;&gt;&lt;a href=&quot;#cb13-9&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  r &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;as.numeric&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;sqrt&lt;/span&gt;(y[&lt;span class=&quot;dv&quot;&gt;3&lt;/span&gt;] &lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;t&lt;/span&gt;(x) &lt;span class=&quot;sc&quot;&gt;%*%&lt;/span&gt; x))&lt;/span&gt;
&lt;span id=&quot;cb13-10&quot;&gt;&lt;a href=&quot;#cb13-10&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;return&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;c&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;x=&lt;/span&gt;x[&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;], &lt;span class=&quot;at&quot;&gt;y=&lt;/span&gt;x[&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;], &lt;span class=&quot;at&quot;&gt;radius=&lt;/span&gt;r))&lt;/span&gt;
&lt;span id=&quot;cb13-11&quot;&gt;&lt;a href=&quot;#cb13-11&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;}&lt;/span&gt;
&lt;span id=&quot;cb13-12&quot;&gt;&lt;a href=&quot;#cb13-12&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb13-13&quot;&gt;&lt;a href=&quot;#cb13-13&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##Fit using linear least squares procedure of Coole (1993)&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb13-14&quot;&gt;&lt;a href=&quot;#cb13-14&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;fit_lls &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;fitCircle_lls&lt;/span&gt;(freehandCircleThinBorder)&lt;/span&gt;
&lt;span id=&quot;cb13-15&quot;&gt;&lt;a href=&quot;#cb13-15&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb13-16&quot;&gt;&lt;a href=&quot;#cb13-16&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##Compare TLS and LLS fit&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb13-17&quot;&gt;&lt;a href=&quot;#cb13-17&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;rbind&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;lls=&lt;/span&gt;fit_lls,&lt;span class=&quot;at&quot;&gt;tls=&lt;/span&gt;fit_tls)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;##            x        y   radius
## lls 894.3666 707.3901 518.4295
## tls 894.3885 707.3191 518.4119&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;In other words: the results are nearly identical.&lt;/p&gt;
&lt;h2 class=&quot;unnumbered&quot; id=&quot;literature&quot;&gt;Literature&lt;/h2&gt;
&lt;div id=&quot;refs&quot; class=&quot;references csl-bib-body hanging-indent&quot;
data-entry-spacing=&quot;0&quot; role=&quot;list&quot;&gt;
&lt;div id=&quot;ref-coope1993&quot; class=&quot;csl-entry&quot; role=&quot;listitem&quot;&gt;
Coope, I. D. 1993. &lt;span&gt;“Circle Fitting by Linear and Nonlinear Least
Squares.”&lt;/span&gt; &lt;em&gt;Journal of Optimization Theory and
Applications&lt;/em&gt; 76 (2): 381–88. &lt;a
href=&quot;https://doi.org/10.1007/BF00939613&quot;&gt;https://doi.org/10.1007/BF00939613&lt;/a&gt;.
&lt;/div&gt;
&lt;div id=&quot;ref-hartley_zisserman2004&quot; class=&quot;csl-entry&quot; role=&quot;listitem&quot;&gt;
Hartley, R., and A. Zisserman. 2004. &lt;em&gt;Multiple View Geometry in
Computer Vision&lt;/em&gt;. 2nd ed. Cambridge University Press. &lt;a
href=&quot;http://www.robots.ox.ac.uk/~vgg/hzbook/&quot;&gt;http://www.robots.ox.ac.uk/~vgg/hzbook/&lt;/a&gt;.
&lt;/div&gt;
&lt;/div&gt;
&lt;section id=&quot;footnotes&quot; class=&quot;footnotes footnotes-end-of-document&quot;
role=&quot;doc-endnotes&quot;&gt;
&lt;hr /&gt;
&lt;ol&gt;
&lt;li id=&quot;fn1&quot;&gt;&lt;p&gt;Alternatively, see slide 18 and onward in
https://ags.cs.uni-kl.de/fileadmin/inf_ags/3dcv-ws11-12/3DCV_WS11-12_lec04.pdf&lt;a
href=&quot;#fnref1&quot; class=&quot;footnote-back&quot; role=&quot;doc-backlink&quot;&gt;↩︎&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;/section&gt;
</description>
        <pubDate>Tue, 31 Jul 2018 00:00:00 +0200</pubDate>
        <link>https://mhoehle.github.io/blog/2018/07/31/circle.html</link>
        <guid isPermaLink="true">https://mhoehle.github.io/blog/2018/07/31/circle.html</guid>
        
        <category>rstats</category>
        
        <category>stats</category>
        
        <category>computer vision</category>
        
        <category>image analysis</category>
        
        <category>data science</category>
        
        
      </item>
    
      <item>
        <title>Amazon&apos;s Hanging Cable Problem (Golden Gate Edition)</title>
        <description>&lt;h2 id=&quot;abstract&quot;&gt;Abstract:&lt;/h2&gt;
&lt;p&gt;In this post we use R’s capabilities to solve nonlinear equation
systems in order to answer an extension of the hanging cable problem to
suspension bridges. We then use R and ggplot to overlay the solution to
an image of the Golden Gate Bridge in order to bring together theory and
practice.&lt;/p&gt;
&lt;center&gt;
&lt;img src=&quot;/blog/figure/source/2018-07-23-cable/GOLDENGATE-1.png&quot; /&gt;
&lt;/center&gt;
&lt;p&gt;&lt;br&gt;
&lt;a rel=&quot;license&quot; href=&quot;http://creativecommons.org/licenses/by-sa/4.0/&quot;&gt;&lt;img alt=&quot;Creative Commons License&quot; style=&quot;border-width:0&quot; src=&quot;https://i.creativecommons.org/l/by-sa/4.0/88x31.png&quot;/&gt;&lt;/a&gt;
This work is licensed under a &lt;a rel=&quot;license&quot;
href=&quot;http://creativecommons.org/licenses/by-sa/4.0/&quot;&gt;Creative Commons
Attribution-ShareAlike 4.0 International License&lt;/a&gt;. The
markdown+Rknitr source code of this blog is available under a &lt;a
href=&quot;https://www.gnu.org/licenses/gpl-3.0.html&quot;&gt;GNU General Public
License (GPL v3)&lt;/a&gt; license from github.&lt;/p&gt;
&lt;h2 id=&quot;introduction&quot;&gt;Introduction&lt;/h2&gt;
&lt;p&gt;The so called &lt;a
href=&quot;https://mindyourdecisions.com/blog/2018/07/12/can-you-solve-amazons-hanging-cable-interview-question/&quot;&gt;Amazon’s
hanging cable problem&lt;/a&gt; explained in this &lt;a
href=&quot;https://youtu.be/l_ffdarcJiQ&quot;&gt;youtube video&lt;/a&gt; (watched 2.4 mio
times!&lt;a href=&quot;#fn1&quot; class=&quot;footnote-ref&quot; id=&quot;fnref1&quot;
role=&quot;doc-noteref&quot;&gt;&lt;sup&gt;1&lt;/sup&gt;&lt;/a&gt;) goes as follows:&lt;/p&gt;
&lt;p&gt;&lt;em&gt;A cable of 80 meters (m) is hanging from the top of two poles
that are both 50 m from the ground. What is the distance between the two
poles, to one decimal place, if the center of the cable is&lt;/em&gt;:&lt;/p&gt;
&lt;ol type=&quot;a&quot;&gt;
&lt;li&gt;&lt;em&gt;20 m above the ground?&lt;/em&gt;&lt;br&gt;&lt;/li&gt;
&lt;li&gt;&lt;em&gt;10 m above the ground?&lt;/em&gt;&lt;br&gt;&lt;/li&gt;
&lt;/ol&gt;
Allegedly, (b) has been used as an Amazon interview question, however,
the problem is much older and has otherwise nothing to do with Amazon.
Can you solve (b)? Or even (a)? The problem can be illustrated as
follows:
&lt;p&gt;
&lt;center&gt;
&lt;img src=&quot;/blog/figure/source/2018-07-23-cable/cableproblem.png&quot; /&gt;
&lt;/center&gt;
&lt;FONT COLOR=&quot;bbbbbb&quot;&gt;Screenshot from &lt;a
href=&quot;https://mindyourdecisions.com/blog/2018/07/12/can-you-solve-amazons-hanging-cable-interview-question/&quot;&gt;Presh
Talwalkar’s&lt;/a&gt; website.&lt;/FONT&gt;
&lt;p&gt;
&lt;p&gt;Hint: The &lt;a
href=&quot;https://mindyourdecisions.com/blog/2018/07/12/can-you-solve-amazons-hanging-cable-interview-question/&quot;&gt;solution
to (a)&lt;/a&gt; is concisely described in &lt;span class=&quot;citation&quot;
data-cites=&quot;chatterjee_nita2010&quot;&gt;Chatterjee and Nita (2010)&lt;/span&gt; and
for (b) you need to do little more than just think. So instead of
applying at Amazon, let’s take the question to the next level: Apply for
the &lt;span style=&quot;color:orange&quot;&gt;orange&lt;/span&gt; belt in R: How you
&lt;em&gt;wouldn’t&lt;/em&gt; solve the hanging cable problem by instead solving the
hanging cable problem &lt;strong&gt;suspension bridge style&lt;/strong&gt;!&lt;/p&gt;
&lt;p&gt;As explained in the video the &lt;a
href=&quot;https://en.wikipedia.org/wiki/Catenary&quot;&gt;catenary curve&lt;/a&gt; is the
&lt;a
href=&quot;https://www.youtube.com/watch?v=npt6IkyL_f4&amp;amp;pbjreload=10&quot;&gt;geometric
shape&lt;/a&gt;, a cable assumes under its own weight when supported only at
its ends. If instead the cable supports a uniformly distributed vertical
load, the cable has the shape of a &lt;a
href=&quot;https://en.wikipedia.org/wiki/Parabola&quot;&gt;parabolic curve&lt;/a&gt;. This
would for example be the case for a &lt;strong&gt;&lt;a
href=&quot;https://en.wikipedia.org/wiki/Suspension_bridge&quot;&gt;suspension
bridge&lt;/a&gt;&lt;/strong&gt; with a horizontal suspended deck, if the cable
itself is not too heavy compared to the road sections. A prominent
example of a suspension bridges is the &lt;a
href=&quot;https://en.wikipedia.org/wiki/Golden_Gate_Bridge&quot;&gt;Golden Gate
Bridge&lt;/a&gt;, which we will use as motivating example for this post.&lt;/p&gt;
&lt;h2 id=&quot;solving-the-cable-problem&quot;&gt;Solving the Cable Problem&lt;/h2&gt;
&lt;h3 id=&quot;parabola-shape&quot;&gt;Parabola Shape&lt;/h3&gt;
&lt;p&gt;Rephrasing the cable problem as the ‘&lt;em&gt;suspension bridge
problem&lt;/em&gt;’ we need to solve a two-component non-linear equation
system:&lt;/p&gt;
&lt;ol type=&quot;1&quot;&gt;
&lt;li&gt;&lt;p&gt;the first component ensures that the parabolic curve with vertex
at &lt;span class=&quot;math inline&quot;&gt;\((0,0)\)&lt;/span&gt; goes through the poles at
the x-values &lt;span class=&quot;math inline&quot;&gt;\(-x\)&lt;/span&gt; and &lt;span
class=&quot;math inline&quot;&gt;\(x\)&lt;/span&gt;. In other words: the distance between
the two poles is &lt;span class=&quot;math inline&quot;&gt;\(2x\)&lt;/span&gt;. Note that the
coordinate system is aligned such that the lowest point of the cable is
at the origo.&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;the second component ensures that the arc-length of the parabola
is as given by the problem. Since the parabola is symmetric it is
sufficient to study the positive x-axis&lt;/p&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;The two criteria are converted into an equation system as follows:
&lt;span class=&quot;math display&quot;&gt;\[
\begin{align*} a x^2 &amp;amp;= 50 - \text{height above ground} \\
\int_0^x \sqrt{1 + \left(\frac{d}{du} a u^2\right)^2} du &amp;amp;= 40.
\end{align*}
\]&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;Here, the general equation for &lt;a
href=&quot;https://en.wikipedia.org/wiki/Arc_length&quot;&gt;arc-length&lt;/a&gt; of a
function &lt;span class=&quot;math inline&quot;&gt;\(y=f(u)\)&lt;/span&gt; has been used.
Solving the arc-length integral for a parabola can either be done by
numerical integration or by &lt;a
href=&quot;http://www.math.drexel.edu/~tolya/arc_length_x%5e2.pdf&quot;&gt;solving
the integral analytically&lt;/a&gt; or just look up the resulting analytic
expression as eqn 4.25 in &lt;span class=&quot;citation&quot;
data-cites=&quot;spiegel1968&quot;&gt;Spiegel (1968)&lt;/span&gt;. Subtracting the RHS from
each LHS gives us a non-linear equation system with unknowns &lt;span
class=&quot;math inline&quot;&gt;\(a\)&lt;/span&gt; and &lt;span
class=&quot;math inline&quot;&gt;\(x\)&lt;/span&gt; of the form&lt;/p&gt;
&lt;p&gt;&lt;span class=&quot;math display&quot;&gt;\[
\left[
\begin{array}{c}
y_1(a,x) \\
y_2(a,x)
\end{array}
\right]
=
\left[
\begin{array}{c}
0 \\
0
\end{array}
\right].
\]&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;Writing this in R code:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb1&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb1-1&quot;&gt;&lt;a href=&quot;#cb1-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;## Height of function at the location x from center is (pole_height - height_above_ground)&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-2&quot;&gt;&lt;a href=&quot;#cb1-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;y1_parabola &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;cf&quot;&gt;function&lt;/span&gt;(a, x, &lt;span class=&quot;at&quot;&gt;pole_height=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;50&lt;/span&gt;, &lt;span class=&quot;at&quot;&gt;above_ground=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;20&lt;/span&gt;) {&lt;/span&gt;
&lt;span id=&quot;cb1-3&quot;&gt;&lt;a href=&quot;#cb1-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  a&lt;span class=&quot;sc&quot;&gt;*&lt;/span&gt;x&lt;span class=&quot;sc&quot;&gt;^&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt; &lt;span class=&quot;sc&quot;&gt;-&lt;/span&gt; (pole_height &lt;span class=&quot;sc&quot;&gt;-&lt;/span&gt; above_ground)&lt;/span&gt;
&lt;span id=&quot;cb1-4&quot;&gt;&lt;a href=&quot;#cb1-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;}&lt;/span&gt;
&lt;span id=&quot;cb1-5&quot;&gt;&lt;a href=&quot;#cb1-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-6&quot;&gt;&lt;a href=&quot;#cb1-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;## Arc-length of the parabola between [-x,x] is given as cable_length&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-7&quot;&gt;&lt;a href=&quot;#cb1-7&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;y2_parabola &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;cf&quot;&gt;function&lt;/span&gt;(a,x, &lt;span class=&quot;at&quot;&gt;cable_length=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;80&lt;/span&gt;, &lt;span class=&quot;at&quot;&gt;arc_method=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;c&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;quot;analytic&amp;quot;&lt;/span&gt;,&lt;span class=&quot;st&quot;&gt;&amp;quot;numeric&amp;quot;&lt;/span&gt;)) {&lt;/span&gt;
&lt;span id=&quot;cb1-8&quot;&gt;&lt;a href=&quot;#cb1-8&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-9&quot;&gt;&lt;a href=&quot;#cb1-9&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;do&quot;&gt;##Arc-length of a parabola a*u^2 within interval [0,x]&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-10&quot;&gt;&lt;a href=&quot;#cb1-10&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;cf&quot;&gt;if&lt;/span&gt;(arc_method &lt;span class=&quot;sc&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;st&quot;&gt;&amp;quot;numeric&amp;quot;&lt;/span&gt;) {&lt;/span&gt;
&lt;span id=&quot;cb1-11&quot;&gt;&lt;a href=&quot;#cb1-11&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    f &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;cf&quot;&gt;function&lt;/span&gt;(u) &lt;span class=&quot;fu&quot;&gt;return&lt;/span&gt;( &lt;span class=&quot;fu&quot;&gt;sqrt&lt;/span&gt;(&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt; (&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;*&lt;/span&gt;a&lt;span class=&quot;sc&quot;&gt;*&lt;/span&gt;u)&lt;span class=&quot;sc&quot;&gt;^&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;))&lt;/span&gt;
&lt;span id=&quot;cb1-12&quot;&gt;&lt;a href=&quot;#cb1-12&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    half_arclength &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;integrate&lt;/span&gt;(f, &lt;span class=&quot;at&quot;&gt;lower=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;0&lt;/span&gt;, &lt;span class=&quot;at&quot;&gt;upper=&lt;/span&gt;x)&lt;span class=&quot;sc&quot;&gt;$&lt;/span&gt;value&lt;/span&gt;
&lt;span id=&quot;cb1-13&quot;&gt;&lt;a href=&quot;#cb1-13&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  } &lt;span class=&quot;cf&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;cf&quot;&gt;if&lt;/span&gt; (arc_method&lt;span class=&quot;sc&quot;&gt;==&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;analytic&amp;quot;&lt;/span&gt;) {&lt;/span&gt;
&lt;span id=&quot;cb1-14&quot;&gt;&lt;a href=&quot;#cb1-14&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    half_arclength &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt;  &lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;/&lt;/span&gt;(&lt;span class=&quot;dv&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;*&lt;/span&gt;a)&lt;span class=&quot;sc&quot;&gt;*&lt;/span&gt;(&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;*&lt;/span&gt;a&lt;span class=&quot;sc&quot;&gt;*&lt;/span&gt;x&lt;span class=&quot;sc&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;sqrt&lt;/span&gt;(&lt;span class=&quot;dv&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;*&lt;/span&gt;a&lt;span class=&quot;sc&quot;&gt;^&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;*&lt;/span&gt;x&lt;span class=&quot;sc&quot;&gt;^&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;) &lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;asinh&lt;/span&gt;(&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;*&lt;/span&gt;a&lt;span class=&quot;sc&quot;&gt;*&lt;/span&gt;x))&lt;/span&gt;
&lt;span id=&quot;cb1-15&quot;&gt;&lt;a href=&quot;#cb1-15&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  }&lt;/span&gt;
&lt;span id=&quot;cb1-16&quot;&gt;&lt;a href=&quot;#cb1-16&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-17&quot;&gt;&lt;a href=&quot;#cb1-17&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;do&quot;&gt;##The equation: s = cable_length/2&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-18&quot;&gt;&lt;a href=&quot;#cb1-18&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  half_arclength &lt;span class=&quot;sc&quot;&gt;-&lt;/span&gt; cable_length&lt;span class=&quot;sc&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-19&quot;&gt;&lt;a href=&quot;#cb1-19&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;}&lt;/span&gt;
&lt;span id=&quot;cb1-20&quot;&gt;&lt;a href=&quot;#cb1-20&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-21&quot;&gt;&lt;a href=&quot;#cb1-21&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;## The non-linear equation system \bm{y}(\theta) = \bm{0}, where the LHS&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-22&quot;&gt;&lt;a href=&quot;#cb1-22&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;## is given by a list with two components containing y_1(\theta) and y_2(\theta)&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-23&quot;&gt;&lt;a href=&quot;#cb1-23&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;f_sys &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;cf&quot;&gt;function&lt;/span&gt;(theta, y, &lt;span class=&quot;at&quot;&gt;pole_height=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;50&lt;/span&gt;, &lt;span class=&quot;at&quot;&gt;above_ground=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;20&lt;/span&gt;, &lt;span class=&quot;at&quot;&gt;cable_length=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;80&lt;/span&gt;, ...) {&lt;/span&gt;
&lt;span id=&quot;cb1-24&quot;&gt;&lt;a href=&quot;#cb1-24&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;do&quot;&gt;##Parameters&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-25&quot;&gt;&lt;a href=&quot;#cb1-25&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  a &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; theta[&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;]&lt;/span&gt;
&lt;span id=&quot;cb1-26&quot;&gt;&lt;a href=&quot;#cb1-26&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  x &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;exp&lt;/span&gt;(theta[&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;]) &lt;span class=&quot;do&quot;&gt;##ensure x is positive&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-27&quot;&gt;&lt;a href=&quot;#cb1-27&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-28&quot;&gt;&lt;a href=&quot;#cb1-28&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;c&lt;/span&gt;(y[[&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;]](a,x, &lt;span class=&quot;at&quot;&gt;pole_height=&lt;/span&gt;pole_height, &lt;span class=&quot;at&quot;&gt;above_ground=&lt;/span&gt;above_ground),&lt;/span&gt;
&lt;span id=&quot;cb1-29&quot;&gt;&lt;a href=&quot;#cb1-29&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    y[[&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;]](a,x, &lt;span class=&quot;at&quot;&gt;cable_length=&lt;/span&gt;cable_length, ...))&lt;/span&gt;
&lt;span id=&quot;cb1-30&quot;&gt;&lt;a href=&quot;#cb1-30&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;}&lt;/span&gt;
&lt;span id=&quot;cb1-31&quot;&gt;&lt;a href=&quot;#cb1-31&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-32&quot;&gt;&lt;a href=&quot;#cb1-32&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##Helper function to transform theta parameter vector to (a,x)&amp;#39;&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-33&quot;&gt;&lt;a href=&quot;#cb1-33&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;theta2ax &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;cf&quot;&gt;function&lt;/span&gt;(theta) {&lt;/span&gt;
&lt;span id=&quot;cb1-34&quot;&gt;&lt;a href=&quot;#cb1-34&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;c&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;a=&lt;/span&gt;theta[&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;], &lt;span class=&quot;at&quot;&gt;x=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;exp&lt;/span&gt;(theta[&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;]))&lt;/span&gt;
&lt;span id=&quot;cb1-35&quot;&gt;&lt;a href=&quot;#cb1-35&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;To ensure &lt;span class=&quot;math inline&quot;&gt;\(x&amp;gt;0\)&lt;/span&gt; we
re-parametrized the equations with &lt;span class=&quot;math inline&quot;&gt;\(\theta_2
=
\log(x)\)&lt;/span&gt; and provide the function &lt;code&gt;theta2ax&lt;/code&gt; to
backtransform the result. We can now use the &lt;a
href=&quot;https://cran.r-project.org/web/packages/nleqslv/index.html&quot;&gt;&lt;code&gt;nleqslv&lt;/code&gt;&lt;/a&gt;
package to solve the non-linear equation system using a one-liner:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb2&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb2-1&quot;&gt;&lt;a href=&quot;#cb2-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;y_parabola &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;list&lt;/span&gt;(y1_parabola, y2_parabola)&lt;/span&gt;
&lt;span id=&quot;cb2-2&quot;&gt;&lt;a href=&quot;#cb2-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;sol_parabola &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;nleqslv&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;x=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;c&lt;/span&gt;(&lt;span class=&quot;fl&quot;&gt;0.1&lt;/span&gt;,&lt;span class=&quot;fl&quot;&gt;0.1&lt;/span&gt;),f_sys, &lt;span class=&quot;at&quot;&gt;y=&lt;/span&gt;y_parabola,  &lt;span class=&quot;at&quot;&gt;arc_method=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;analytic&amp;quot;&lt;/span&gt;)&lt;/span&gt;
&lt;span id=&quot;cb2-3&quot;&gt;&lt;a href=&quot;#cb2-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;theta2ax&lt;/span&gt;(sol_parabola&lt;span class=&quot;sc&quot;&gt;$&lt;/span&gt;x)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;##           a           x 
##  0.05355207 23.66859605&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;In other words, for a cable of length 80m the pole of a suspension
bridge will be located 23.7m from the origo, which means the two poles
of the bridge will be 47.3m apart, which is also the span of the
bridge.&lt;/p&gt;
&lt;p&gt;Using &lt;code&gt;arc_method=&quot;numeric&quot;&lt;/code&gt; instead of the analytic
solution gives&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;##           a           x 
##  0.05355207 23.66859605&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;It is re-assuring to see that the numerical integration method yields
the same result as the analytic method. The analytic method has
mathematical beauty, the numerical method allows the data scientist to
solve the problem without diving into formula compendiums or
geometry.&lt;/p&gt;
&lt;h3 id=&quot;catenary-shape&quot;&gt;Catenary Shape&lt;/h3&gt;
&lt;p&gt;Using the same code, but with the y-functions formulated for the
catenary case we obtain&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb5&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb5-1&quot;&gt;&lt;a href=&quot;#cb5-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;## Value of y=f(u) evaluated at u=x&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb5-2&quot;&gt;&lt;a href=&quot;#cb5-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;y1_catenary &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;cf&quot;&gt;function&lt;/span&gt;(a,x, &lt;span class=&quot;at&quot;&gt;pole_height=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;50&lt;/span&gt;, &lt;span class=&quot;at&quot;&gt;above_ground=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;20&lt;/span&gt;) {&lt;/span&gt;
&lt;span id=&quot;cb5-3&quot;&gt;&lt;a href=&quot;#cb5-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  a &lt;span class=&quot;sc&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;cosh&lt;/span&gt;(x&lt;span class=&quot;sc&quot;&gt;/&lt;/span&gt;a) &lt;span class=&quot;sc&quot;&gt;-&lt;/span&gt; a &lt;span class=&quot;sc&quot;&gt;-&lt;/span&gt; (pole_height&lt;span class=&quot;sc&quot;&gt;-&lt;/span&gt; above_ground)&lt;/span&gt;
&lt;span id=&quot;cb5-4&quot;&gt;&lt;a href=&quot;#cb5-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;}&lt;/span&gt;
&lt;span id=&quot;cb5-5&quot;&gt;&lt;a href=&quot;#cb5-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;## Arc-length condition&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb5-6&quot;&gt;&lt;a href=&quot;#cb5-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;y2_catenary &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;cf&quot;&gt;function&lt;/span&gt;(a,x, &lt;span class=&quot;at&quot;&gt;cable_length=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;80&lt;/span&gt;) {&lt;/span&gt;
&lt;span id=&quot;cb5-7&quot;&gt;&lt;a href=&quot;#cb5-7&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  a &lt;span class=&quot;sc&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;sinh&lt;/span&gt;(x&lt;span class=&quot;sc&quot;&gt;/&lt;/span&gt;a) &lt;span class=&quot;sc&quot;&gt;-&lt;/span&gt; cable_length&lt;span class=&quot;sc&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb5-8&quot;&gt;&lt;a href=&quot;#cb5-8&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;}&lt;/span&gt;
&lt;span id=&quot;cb5-9&quot;&gt;&lt;a href=&quot;#cb5-9&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb5-10&quot;&gt;&lt;a href=&quot;#cb5-10&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;## Solve equation system&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb5-11&quot;&gt;&lt;a href=&quot;#cb5-11&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;y_catenary &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;list&lt;/span&gt;(y1_catenary, y2_catenary)&lt;/span&gt;
&lt;span id=&quot;cb5-12&quot;&gt;&lt;a href=&quot;#cb5-12&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;sol_catenary &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;nleqslv&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;x=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;c&lt;/span&gt;(&lt;span class=&quot;fl&quot;&gt;0.1&lt;/span&gt;,&lt;span class=&quot;fl&quot;&gt;0.1&lt;/span&gt;),f_sys, &lt;span class=&quot;at&quot;&gt;y=&lt;/span&gt;y_catenary, &lt;span class=&quot;at&quot;&gt;method=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;Newton&amp;quot;&lt;/span&gt;)&lt;/span&gt;
&lt;span id=&quot;cb5-13&quot;&gt;&lt;a href=&quot;#cb5-13&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;theta2ax&lt;/span&gt;(sol_catenary&lt;span class=&quot;sc&quot;&gt;$&lt;/span&gt;x)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;##        a        x 
## 11.66667 22.70229&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;In other words the solution to the original cable problem is &lt;span
class=&quot;math inline&quot;&gt;\(x=22.7 m\)&lt;/span&gt; whereas the answer to the
suspension bridge version is &lt;span
class=&quot;math inline&quot;&gt;\(x=23.7m\)&lt;/span&gt;. The difference to the parabolic
form can be seen from the following graph:&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/blog/figure/source/2018-07-23-cable/PARABOLACATENARYPLOT-1.png&quot; style=&quot;display: block; margin: auto;&quot; /&gt;&lt;/p&gt;
&lt;h2 id=&quot;testing-the-theory&quot;&gt;Testing the theory&lt;/h2&gt;
&lt;p&gt;We test our theory by studying the cable of the Golden Gate
suspension bridge. Shown below is a photograph by &lt;a
href=&quot;https://commons.wikimedia.org/wiki/File:Golden_Gate_Bridge_Dec_15_2015_by_D_Ramey_Logan.jpg&quot;&gt;D
Ramey Logan&lt;/a&gt; available under a &lt;a
href=&quot;https://creativecommons.org/licenses/by/4.0/deed.en&quot;&gt;CC BY 4.0&lt;/a&gt;
license. For presentation in this post the image was tilted by -0.75
degrees (around the camera’s view axis) with the &lt;a
href=&quot;https://dahtah.github.io/imager/imager.html&quot;&gt;&lt;code&gt;imager&lt;/code&gt;&lt;/a&gt;
package to make the sea level approximately horizontal. Parabolic and
catenary overlays (no real difference between the two) were done using
the theory described above.&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb7&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb7-1&quot;&gt;&lt;a href=&quot;#cb7-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##Preprocess image&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb7-2&quot;&gt;&lt;a href=&quot;#cb7-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;img &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; imager&lt;span class=&quot;sc&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;load.image&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;file.path&lt;/span&gt;(fullFigPath, &lt;span class=&quot;st&quot;&gt;&amp;quot;Golden_Gate_Bridge.png&amp;quot;&lt;/span&gt;))&lt;/span&gt;
&lt;span id=&quot;cb7-3&quot;&gt;&lt;a href=&quot;#cb7-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;img &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; imager&lt;span class=&quot;sc&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;imrotate&lt;/span&gt;(img, &lt;span class=&quot;at&quot;&gt;angle=&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;fl&quot;&gt;0.75&lt;/span&gt;, &lt;span class=&quot;at&quot;&gt;interpolation=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;)&lt;/span&gt;
&lt;span id=&quot;cb7-4&quot;&gt;&lt;a href=&quot;#cb7-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;img &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; imager&lt;span class=&quot;sc&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;resize&lt;/span&gt;(img,&lt;span class=&quot;sc&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;50&lt;/span&gt;,&lt;span class=&quot;sc&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;50&lt;/span&gt;, &lt;span class=&quot;at&quot;&gt;interpolation_type=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;5&lt;/span&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;We manually identify center, sea level and poles from the image and
use &lt;a
href=&quot;https://ggplot2.tidyverse.org/reference/annotation_raster.html&quot;&gt;&lt;code&gt;annotation_raster&lt;/code&gt;&lt;/a&gt;
to overlay the image on the &lt;code&gt;ggplot&lt;/code&gt; of the corresponding
parabola and catenary. See the &lt;a
href=&quot;https://raw.githubusercontent.com/hoehleatsu/hoehleatsu.github.io/master/_source/2018-07-23-cable.Rmd&quot;&gt;code&lt;/a&gt;
on github for details.&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/blog/figure/source/2018-07-23-cable/GOLDENGATE-1.png&quot; style=&quot;display: block; margin: auto;&quot; /&gt;&lt;/p&gt;
&lt;p&gt;The fit is not perfect, which is due to the camera’s direction not
being orthogonal to the plane spanned by the bridge - for example the
right pole appears to be closer to the camera than the left pole&lt;a
href=&quot;#fn2&quot; class=&quot;footnote-ref&quot; id=&quot;fnref2&quot;
role=&quot;doc-noteref&quot;&gt;&lt;sup&gt;2&lt;/sup&gt;&lt;/a&gt;. We scaled and ‘offsetted’ the image
so the left pole is at distance 640m from origo, but did not correct for
the tilting around the &lt;span class=&quot;math inline&quot;&gt;\(y\)&lt;/span&gt;-axis.
Furthermore, distances are being distorted by the lens, which might
explain the poles being too small. &lt;a
href=&quot;https://en.wikipedia.org/wiki/Image_rectification&quot;&gt;Rectification&lt;/a&gt;
and &lt;a
href=&quot;https://en.wikipedia.org/wiki/Perspective_control&quot;&gt;perspective
control&lt;/a&gt; of such images is a &lt;strong&gt;&lt;a
href=&quot;https://en.wikipedia.org/wiki/Photogrammetry&quot;&gt;photogrammetric&lt;/a&gt;&lt;/strong&gt;
method beyond the scope of this post!&lt;/p&gt;
&lt;h2 id=&quot;discussion&quot;&gt;Discussion&lt;/h2&gt;
&lt;p&gt;This post may not to impress a Matlab coding engineer, but it shows
how R has developed into a versatile tool going way beyond statistics:
We used its optimization and image analysis capabilities. Furthermore,
given an analytic form of &lt;span
class=&quot;math inline&quot;&gt;\(y(\theta)\)&lt;/span&gt;, R can symbolically determine
the Jacobian and, hence, implement the required Newton-Raphson solving
of the non-linear equation system directly - see the Appendix. In other
words: R is also a full stack mathematical problem solving tool!&lt;/p&gt;
&lt;p&gt;As a &lt;strong&gt;challenge&lt;/strong&gt; to the interested reader: Can you
write R code, for example using &lt;code&gt;imager&lt;/code&gt;, which automatically
identifies poles and cable in the image and based on the known
specification of these parameters of the Golden Gate Bridge (pole
height: 230m, span 1280m, clearance above sea level: 67.1m), and perform
a rectification of the image? If yes, Stockholm University’s Math
Department &lt;a
href=&quot;https://www.math.su.se/english/education/phd-studies/admission-and-vacant-positions&quot;&gt;hires&lt;/a&gt;
for Ph.D. positions every April! The challenge could work well as
pre-interview project. 😉&lt;/p&gt;
&lt;h2 id=&quot;appendix---newton-raphson-algorithm&quot;&gt;Appendix - Newton-Raphson
Algorithm&lt;/h2&gt;
&lt;p&gt;Because the &lt;code&gt;y_1(a,x)&lt;/code&gt; and &lt;code&gt;y_2(a,x)&lt;/code&gt; are both
available in closed analytic form, one can form the Jacobian of
non-linear equations system by combining the two gradients. This can be
achieved symbolically using the &lt;code&gt;deriv&lt;/code&gt; or &lt;a
href=&quot;https://cran.r-project.org/web/packages/Deriv/index.html&quot;&gt;&lt;code&gt;Deriv::Deriv&lt;/code&gt;&lt;/a&gt;
functions in R.&lt;/p&gt;
&lt;p&gt;Given starting value &lt;span class=&quot;math inline&quot;&gt;\(\theta\)&lt;/span&gt; the
iterative procedure to find the root of the non-linear equation system
&lt;span class=&quot;math inline&quot;&gt;\(y(\theta) = 0\)&lt;/span&gt; is given by &lt;span
class=&quot;citation&quot; data-cites=&quot;nocedal_wright2006&quot;&gt;(Nocedal and Wright
2006, Sect. 11.1)&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span class=&quot;math display&quot;&gt;\[
\theta^{(k+1)} = \theta^k - J(\theta^k)^{-1} y(\theta),
\]&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;where &lt;span class=&quot;math inline&quot;&gt;\(J\)&lt;/span&gt; is the &lt;a
href=&quot;https://en.wikipedia.org/wiki/Jacobian_matrix_and_determinant&quot;&gt;Jacobian&lt;/a&gt;
of the system, which in this case is a 2x2 matrix.&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb8&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb8-1&quot;&gt;&lt;a href=&quot;#cb8-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;gradient_y1 &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; Deriv&lt;span class=&quot;sc&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;Deriv&lt;/span&gt;(y1_parabola, &lt;span class=&quot;at&quot;&gt;x=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;c&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;quot;a&amp;quot;&lt;/span&gt;,&lt;span class=&quot;st&quot;&gt;&amp;quot;x&amp;quot;&lt;/span&gt;))&lt;/span&gt;
&lt;span id=&quot;cb8-2&quot;&gt;&lt;a href=&quot;#cb8-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb8-3&quot;&gt;&lt;a href=&quot;#cb8-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;y2_parabola_analytic &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;cf&quot;&gt;function&lt;/span&gt;(a,x, &lt;span class=&quot;at&quot;&gt;cable_length=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;80&lt;/span&gt;) {&lt;/span&gt;
&lt;span id=&quot;cb8-4&quot;&gt;&lt;a href=&quot;#cb8-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;/&lt;/span&gt;(&lt;span class=&quot;dv&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;*&lt;/span&gt;a)&lt;span class=&quot;sc&quot;&gt;*&lt;/span&gt;(&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;*&lt;/span&gt;a&lt;span class=&quot;sc&quot;&gt;*&lt;/span&gt;x&lt;span class=&quot;sc&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;sqrt&lt;/span&gt;(&lt;span class=&quot;dv&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;*&lt;/span&gt;a&lt;span class=&quot;sc&quot;&gt;^&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;*&lt;/span&gt;x&lt;span class=&quot;sc&quot;&gt;^&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;) &lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;asinh&lt;/span&gt;(&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;*&lt;/span&gt;a&lt;span class=&quot;sc&quot;&gt;*&lt;/span&gt;x)) &lt;span class=&quot;sc&quot;&gt;-&lt;/span&gt; cable_length&lt;span class=&quot;sc&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb8-5&quot;&gt;&lt;a href=&quot;#cb8-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;}&lt;/span&gt;
&lt;span id=&quot;cb8-6&quot;&gt;&lt;a href=&quot;#cb8-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb8-7&quot;&gt;&lt;a href=&quot;#cb8-7&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;gradient_y2 &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; Deriv&lt;span class=&quot;sc&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;Deriv&lt;/span&gt;(y2_parabola_analytic, &lt;span class=&quot;at&quot;&gt;x=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;c&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;quot;a&amp;quot;&lt;/span&gt;,&lt;span class=&quot;st&quot;&gt;&amp;quot;x&amp;quot;&lt;/span&gt;))&lt;/span&gt;
&lt;span id=&quot;cb8-8&quot;&gt;&lt;a href=&quot;#cb8-8&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb8-9&quot;&gt;&lt;a href=&quot;#cb8-9&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##Jacobian&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb8-10&quot;&gt;&lt;a href=&quot;#cb8-10&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;J &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;cf&quot;&gt;function&lt;/span&gt;(theta, &lt;span class=&quot;at&quot;&gt;pole_height=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;50&lt;/span&gt;, &lt;span class=&quot;at&quot;&gt;above_ground=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;20&lt;/span&gt;, &lt;span class=&quot;at&quot;&gt;cable_length=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;80&lt;/span&gt;, ...) {&lt;/span&gt;
&lt;span id=&quot;cb8-11&quot;&gt;&lt;a href=&quot;#cb8-11&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  a &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; theta[&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;]&lt;/span&gt;
&lt;span id=&quot;cb8-12&quot;&gt;&lt;a href=&quot;#cb8-12&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  x &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;exp&lt;/span&gt;(theta[&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;]) &lt;span class=&quot;co&quot;&gt;#  x &amp;lt;- exp(theta[2])&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb8-13&quot;&gt;&lt;a href=&quot;#cb8-13&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb8-14&quot;&gt;&lt;a href=&quot;#cb8-14&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;do&quot;&gt;##Since we use x = exp(theta[2])=g(theta[2]) we need the chain rule to find the gradient in theta&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb8-15&quot;&gt;&lt;a href=&quot;#cb8-15&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;do&quot;&gt;##this is g&amp;#39;(theta[2]) = exp(theta[2]) = x&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb8-16&quot;&gt;&lt;a href=&quot;#cb8-16&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;rbind&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;gradient_y1&lt;/span&gt;(a,x, &lt;span class=&quot;at&quot;&gt;pole_height=&lt;/span&gt;pole_height, &lt;span class=&quot;at&quot;&gt;above_ground=&lt;/span&gt;above_ground)&lt;span class=&quot;sc&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;c&lt;/span&gt;(&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;, x),&lt;/span&gt;
&lt;span id=&quot;cb8-17&quot;&gt;&lt;a href=&quot;#cb8-17&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;        &lt;span class=&quot;fu&quot;&gt;gradient_y2&lt;/span&gt;(a,x, &lt;span class=&quot;at&quot;&gt;cable_length=&lt;/span&gt;cable_length)  &lt;span class=&quot;sc&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;c&lt;/span&gt;(&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;, x))&lt;/span&gt;
&lt;span id=&quot;cb8-18&quot;&gt;&lt;a href=&quot;#cb8-18&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;By iterating Newton-Raphson steps we can find the solution of the
equation system manually:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb9&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb9-1&quot;&gt;&lt;a href=&quot;#cb9-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##Start values&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb9-2&quot;&gt;&lt;a href=&quot;#cb9-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;theta &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;c&lt;/span&gt;(&lt;span class=&quot;fl&quot;&gt;0.1&lt;/span&gt;,&lt;span class=&quot;fu&quot;&gt;log&lt;/span&gt;(&lt;span class=&quot;dv&quot;&gt;10&lt;/span&gt;))&lt;/span&gt;
&lt;span id=&quot;cb9-3&quot;&gt;&lt;a href=&quot;#cb9-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;thetanew &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;c&lt;/span&gt;(&lt;span class=&quot;fl&quot;&gt;0.1&lt;/span&gt;,&lt;span class=&quot;fu&quot;&gt;log&lt;/span&gt;(&lt;span class=&quot;dv&quot;&gt;20&lt;/span&gt;))&lt;/span&gt;
&lt;span id=&quot;cb9-4&quot;&gt;&lt;a href=&quot;#cb9-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##Log with the values&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb9-5&quot;&gt;&lt;a href=&quot;#cb9-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;log &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;t&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;theta2ax&lt;/span&gt;(theta))&lt;/span&gt;
&lt;span id=&quot;cb9-6&quot;&gt;&lt;a href=&quot;#cb9-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb9-7&quot;&gt;&lt;a href=&quot;#cb9-7&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##Iterate Newton-Raphson steps until convergence&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb9-8&quot;&gt;&lt;a href=&quot;#cb9-8&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;cf&quot;&gt;while&lt;/span&gt; ( (&lt;span class=&quot;fu&quot;&gt;sum&lt;/span&gt;(thetanew &lt;span class=&quot;sc&quot;&gt;-&lt;/span&gt; theta)&lt;span class=&quot;sc&quot;&gt;^&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt; &lt;span class=&quot;sc&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;sum&lt;/span&gt;(theta&lt;span class=&quot;sc&quot;&gt;^&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;)) &lt;span class=&quot;sc&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;fl&quot;&gt;1e-15&lt;/span&gt;) {&lt;/span&gt;
&lt;span id=&quot;cb9-9&quot;&gt;&lt;a href=&quot;#cb9-9&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  theta &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; thetanew&lt;/span&gt;
&lt;span id=&quot;cb9-10&quot;&gt;&lt;a href=&quot;#cb9-10&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;do&quot;&gt;##Update step&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb9-11&quot;&gt;&lt;a href=&quot;#cb9-11&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  thetanew &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; theta &lt;span class=&quot;sc&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;solve&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;J&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;theta=&lt;/span&gt;theta)) &lt;span class=&quot;sc&quot;&gt;%*%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;f_sys&lt;/span&gt;(theta, &lt;span class=&quot;at&quot;&gt;y=&lt;/span&gt;y_parabola, &lt;span class=&quot;at&quot;&gt;arc_method=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;analytic&amp;quot;&lt;/span&gt;)&lt;/span&gt;
&lt;span id=&quot;cb9-12&quot;&gt;&lt;a href=&quot;#cb9-12&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;do&quot;&gt;##Add to log&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb9-13&quot;&gt;&lt;a href=&quot;#cb9-13&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  log &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;rbind&lt;/span&gt;(log, &lt;span class=&quot;fu&quot;&gt;theta2ax&lt;/span&gt;(thetanew))&lt;/span&gt;
&lt;span id=&quot;cb9-14&quot;&gt;&lt;a href=&quot;#cb9-14&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;}&lt;/span&gt;
&lt;span id=&quot;cb9-15&quot;&gt;&lt;a href=&quot;#cb9-15&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb9-16&quot;&gt;&lt;a href=&quot;#cb9-16&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##Look at the steps taken&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb9-17&quot;&gt;&lt;a href=&quot;#cb9-17&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;log&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;##               a        x
## [1,] 0.10000000 10.00000
## [2,] 0.02667392 25.46647
## [3,] 0.04632177 25.43589
## [4,] 0.05270610 23.75416
## [5,] 0.05354318 23.66953
## [6,] 0.05355207 23.66860
## [7,] 0.05355207 23.66860&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;We show the moves of the algorithm in a 2D contour plot for &lt;span
class=&quot;math inline&quot;&gt;\(r(a,x) =
\sqrt{y_1(a,x)^2 + y_2(a,x)^2}\)&lt;/span&gt;. The solution to the system has
&lt;span class=&quot;math inline&quot;&gt;\(r(a,x)=0\)&lt;/span&gt;. See the &lt;a
href=&quot;%60r%20paste0(%22https://raw.githubusercontent.com/hoehleatsu/hoehleatsu.github.io/master/_source/%22,current_input())%60&quot;&gt;code&lt;/a&gt;
on github for details.&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/blog/figure/source/2018-07-23-cable/NRSTEPSPLOT-1.png&quot; style=&quot;display: block; margin: auto;&quot; /&gt;&lt;/p&gt;
&lt;h2 class=&quot;unnumbered&quot; id=&quot;literature&quot;&gt;Literature&lt;/h2&gt;
&lt;div id=&quot;refs&quot; class=&quot;references csl-bib-body hanging-indent&quot;
data-entry-spacing=&quot;0&quot; role=&quot;list&quot;&gt;
&lt;div id=&quot;ref-chatterjee_nita2010&quot; class=&quot;csl-entry&quot; role=&quot;listitem&quot;&gt;
Chatterjee, N., and B. G. Nita. 2010. &lt;span&gt;“The Hanging Cable Problem
for Practical Applications.”&lt;/span&gt; &lt;em&gt;Atlantic Electronic Journal of
Mathematics&lt;/em&gt; 4 (1): 70–77. &lt;a
href=&quot;http://euclid.trentu.ca/aejm/V4N1/Chatterjee.V4N1.pdf&quot;&gt;http://euclid.trentu.ca/aejm/V4N1/Chatterjee.V4N1.pdf&lt;/a&gt;.
&lt;/div&gt;
&lt;div id=&quot;ref-nocedal_wright2006&quot; class=&quot;csl-entry&quot; role=&quot;listitem&quot;&gt;
Nocedal, J., and S. J. Wright. 2006. &lt;em&gt;Numerical Optimization&lt;/em&gt;.
2nd ed. Springer-Verlag.
&lt;/div&gt;
&lt;div id=&quot;ref-spiegel1968&quot; class=&quot;csl-entry&quot; role=&quot;listitem&quot;&gt;
Spiegel, M. R. 1968. &lt;em&gt;Mathematical Handbook of Formulas and
Tables&lt;/em&gt;. Schaum’s Outline Series. McGraw-Hill Book Company. &lt;a
href=&quot;https://ia800703.us.archive.org/23/items/MathematicalHandbookOfFormulasAndTables/Spiegel-MathematicalHandbook_text.pdf&quot;&gt;https://ia800703.us.archive.org/23/items/MathematicalHandbookOfFormulasAndTables/Spiegel-MathematicalHandbook_text.pdf&lt;/a&gt;.
&lt;/div&gt;
&lt;/div&gt;
&lt;section id=&quot;footnotes&quot; class=&quot;footnotes footnotes-end-of-document&quot;
role=&quot;doc-endnotes&quot;&gt;
&lt;hr /&gt;
&lt;ol&gt;
&lt;li id=&quot;fn1&quot;&gt;&lt;p&gt;As of 2018-07-23.&lt;a href=&quot;#fnref1&quot; class=&quot;footnote-back&quot;
role=&quot;doc-backlink&quot;&gt;↩︎&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;
&lt;li id=&quot;fn2&quot;&gt;&lt;p&gt;A manual investigation using the “Map | Map Object”
Filter in Gimp showed that the angle of tilting around the y-axis is
about 20 degrees.&lt;a href=&quot;#fnref2&quot; class=&quot;footnote-back&quot;
role=&quot;doc-backlink&quot;&gt;↩︎&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;/section&gt;
</description>
        <pubDate>Mon, 23 Jul 2018 00:00:00 +0200</pubDate>
        <link>https://mhoehle.github.io/blog/2018/07/23/cable.html</link>
        <guid isPermaLink="true">https://mhoehle.github.io/blog/2018/07/23/cable.html</guid>
        
        <category>rstats</category>
        
        <category>stats</category>
        
        <category>economics</category>
        
        <category>data visualization</category>
        
        <category>income</category>
        
        <category>equality</category>
        
        
      </item>
    
      <item>
        <title>World Income, Inequality and Murder</title>
        <description>&lt;h2 id=&quot;abstract&quot;&gt;Abstract:&lt;/h2&gt;
&lt;p&gt;We follow up on last weeks post on using Gapminder data to study the
world’s income distribution. In order to assess the inequality of the
distribution we compute the Gini coefficient for the world’s income
distribution by Monte Carlo approximation and visualize the result as a
time series. Furthermore, we animate the association between Gini
coefficient and homicide rate per country using the new version of
&lt;code&gt;gganimate&lt;/code&gt;.&lt;/p&gt;
&lt;center&gt;
&lt;img src=&quot;/blog/figure/source/2018-07-09-gini/MURDERGINIPLOT-1.png&quot; /&gt;
&lt;/center&gt;
&lt;p&gt;&lt;br&gt;
&lt;a rel=&quot;license&quot; href=&quot;http://creativecommons.org/licenses/by-sa/4.0/&quot;&gt;&lt;img alt=&quot;Creative Commons License&quot; style=&quot;border-width:0&quot; src=&quot;https://i.creativecommons.org/l/by-sa/4.0/88x31.png&quot;/&gt;&lt;/a&gt;
This work is licensed under a &lt;a rel=&quot;license&quot;
href=&quot;http://creativecommons.org/licenses/by-sa/4.0/&quot;&gt;Creative Commons
Attribution-ShareAlike 4.0 International License&lt;/a&gt;. The
markdown+Rknitr source code of this blog is available under a &lt;a
href=&quot;https://www.gnu.org/licenses/gpl-3.0.html&quot;&gt;GNU General Public
License (GPL v3)&lt;/a&gt; license from github.&lt;/p&gt;
&lt;h2 id=&quot;introduction&quot;&gt;Introduction&lt;/h2&gt;
&lt;p&gt;One of the main messages of the Chapter ‘The Gap Instinct’ of the
book &lt;a
href=&quot;https://www.gapminder.org/factfulness/&quot;&gt;&lt;em&gt;Factfulness&lt;/em&gt;&lt;/a&gt;
is that there is no justification of the ‘we’ and ‘them’ classification
of countries anymore, because ‘they’ have converged towards the same
levels in key indicators such as life expectancy, child mortality,
births per female. The difference between countries is, hence, not as
many imagine it to be: there is less inequality and no real gap. While
reading, I became curious about the following: &lt;strong&gt;what if countries
became more equal, but simultaneously inequality within countries became
bigger?&lt;/strong&gt; This was also indirectly a Disqus comment by F.
Weidemann to the post &lt;a
href=&quot;http://staff.math.su.se/hoehle/blog/2018/07/02/factfulness.html&quot;&gt;&lt;em&gt;Factfulness:
Building Gapminder Income Mountains&lt;/em&gt;&lt;/a&gt;. Aim of the present post is
to investigate this hypothesis using the Gapminder data by calculating
Gini coefficients. Furthermore, we use the country specific Gini
coefficients to investigate the association with the number of homicides
in the country.&lt;/p&gt;
&lt;h2 id=&quot;gini-coefficient&quot;&gt;Gini coefficient&lt;/h2&gt;
&lt;p&gt;There are different ways to measure income inequality, both in terms
of which response you consider and which statistical summary you compute
for it. Not going into the details of these discussion we use the
GDP/capita in &lt;a
href=&quot;https://en.wikipedia.org/wiki/Purchasing_power_parity&quot;&gt;Purchasing
Power Parities (PPP)&lt;/a&gt; measured in so called international dollars
(fixed prices 2011). In other words, comparison between years and
countries are possible, because the response is adjusted for inflation
and differences in price of living.&lt;/p&gt;
&lt;p&gt;The &lt;a
href=&quot;https://en.wikipedia.org/wiki/Gini_coefficient&quot;&gt;&lt;strong&gt;Gini
coefficient&lt;/strong&gt;&lt;/a&gt; is a statistical measure to quantify
inequality. In what follows we shall focus on computing the Gini
coefficient for a continuous probability distribution with a known
probability density function. Let the probability density function of
the non-negative continuous income distribution be defined by &lt;span
class=&quot;math inline&quot;&gt;\(f\)&lt;/span&gt;, then the Gini coefficient is given as
&lt;strong&gt;half the relative mean difference&lt;/strong&gt;:&lt;/p&gt;
&lt;p&gt;&lt;span class=&quot;math display&quot;&gt;\[
G
= \frac{1}{2\mu}\int_0^\infty \int_0^\infty |x-y| \&amp;gt; f(x) \&amp;gt; f(y)
\&amp;gt;
dx\&amp;gt; dy, \quad\text{where}\quad \mu = \int_{0}^\infty x\cdot f(x) dx.
\]&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;Depending on &lt;span class=&quot;math inline&quot;&gt;\(f\)&lt;/span&gt; it might be
possible to &lt;a
href=&quot;https://en.wikipedia.org/wiki/Gini_coefficient#Continuous_probability_distribution&quot;&gt;solve
these integrals analytically&lt;/a&gt;, however, a straightforward
computational approach is to use Monte Carlo sampling - as we shall see
shortly. Personally, I find the above relative mean difference
presentation of the Gini index much more intuitive than the area
argument using the Lorenz curve. From the eqution it also becomes clear
that the Gini coefficient is invariant to multiplicative changes in the
income: if everybody increases their income by factor &lt;span
class=&quot;math inline&quot;&gt;\(k&amp;gt;0\)&lt;/span&gt; then the Gini coefficient remains
the same, because &lt;span class=&quot;math inline&quot;&gt;\(|k x - k y|
= k | x - y|\)&lt;/span&gt; and &lt;span class=&quot;math inline&quot;&gt;\(E(k \cdot X) = k
\mu\)&lt;/span&gt; and, hence, &lt;span class=&quot;math inline&quot;&gt;\(k\)&lt;/span&gt; cancels
from numerator and denominator.&lt;/p&gt;
&lt;p&gt;The above formula indirectly also states how to compute the Gini
coefficient for a discrete sample of size &lt;span
class=&quot;math inline&quot;&gt;\(n\)&lt;/span&gt; and with incomes &lt;span
class=&quot;math inline&quot;&gt;\(x_1,\ldots, x_n\)&lt;/span&gt;: &lt;span
class=&quot;math display&quot;&gt;\[
G =  \frac{\sum_{i=1}^n \sum_{j=1}^n  |x_i -
x_j| \frac{1}{n} \frac{1}{n}}{2 \sum_{i=1}^n  x_i \frac{1}{n}} =
\frac{\sum_{i=1}^n \sum_{j=1}^n |x_i - x_j|}{2 n \sum_{j=1}^n x_j}.
\]&lt;/span&gt;&lt;/p&gt;
&lt;h4 id=&quot;approximating-the-integral-by-monte-carlo&quot;&gt;Approximating the
integral by Monte Carlo&lt;/h4&gt;
&lt;p&gt;If one is able to easily sample from &lt;span
class=&quot;math inline&quot;&gt;\(f\)&lt;/span&gt; then can instead of solving the
integral analytically use &lt;span class=&quot;math inline&quot;&gt;\(k\)&lt;/span&gt; pairs
&lt;span class=&quot;math inline&quot;&gt;\((x,y)\)&lt;/span&gt; both drawn at random from
&lt;span class=&quot;math inline&quot;&gt;\(f\)&lt;/span&gt; to approximate the double
integral:&lt;/p&gt;
&lt;p&gt;&lt;span class=&quot;math display&quot;&gt;\[
G \approx \frac{1}{2\mu K} \sum_{k=1}^K |x_k - y_k|,
\quad\text{where}\quad
x_k \stackrel{\text{iid}}{\sim} f \text{ and } y_k
\stackrel{\text{iid}}{\sim} f,
\]&lt;/span&gt; where for our mixture model &lt;span class=&quot;math display&quot;&gt;\[
\mu = \sum_{i=1}^{192} w_i \&amp;gt; E(X_i) = \sum_{i=1}^{192} w_i
\exp\left(\mu_i + \frac{1}{2}\sigma_i^2\right).
\]&lt;/span&gt; This allows us to compute &lt;span
class=&quot;math inline&quot;&gt;\(G\)&lt;/span&gt; even in case of a complex &lt;span
class=&quot;math inline&quot;&gt;\(f\)&lt;/span&gt; such as the log-normal mixture
distribution. As always, the larger &lt;span
class=&quot;math inline&quot;&gt;\(K\)&lt;/span&gt; is, the better the Monte Carlo
approximation is.&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb1&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb1-1&quot;&gt;&lt;a href=&quot;#cb1-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##Precision of Monte Carlo approx is controlled by the number of samples&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-2&quot;&gt;&lt;a href=&quot;#cb1-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;K &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fl&quot;&gt;1e6&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-3&quot;&gt;&lt;a href=&quot;#cb1-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-4&quot;&gt;&lt;a href=&quot;#cb1-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##Compute Gini index of world income per year&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-5&quot;&gt;&lt;a href=&quot;#cb1-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;gini_year &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; gm &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;group_by&lt;/span&gt;(year) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;do&lt;/span&gt;({&lt;/span&gt;
&lt;span id=&quot;cb1-6&quot;&gt;&lt;a href=&quot;#cb1-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  x &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;rmix&lt;/span&gt;(K, &lt;span class=&quot;at&quot;&gt;meanlog=&lt;/span&gt;.&lt;span class=&quot;sc&quot;&gt;$&lt;/span&gt;meanlog, &lt;span class=&quot;at&quot;&gt;sdlog=&lt;/span&gt; .&lt;span class=&quot;sc&quot;&gt;$&lt;/span&gt;sdlog, &lt;span class=&quot;at&quot;&gt;w=&lt;/span&gt;.&lt;span class=&quot;sc&quot;&gt;$&lt;/span&gt;w)&lt;/span&gt;
&lt;span id=&quot;cb1-7&quot;&gt;&lt;a href=&quot;#cb1-7&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  y &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;rmix&lt;/span&gt;(K, &lt;span class=&quot;at&quot;&gt;meanlog=&lt;/span&gt;.&lt;span class=&quot;sc&quot;&gt;$&lt;/span&gt;meanlog, &lt;span class=&quot;at&quot;&gt;sdlog=&lt;/span&gt; .&lt;span class=&quot;sc&quot;&gt;$&lt;/span&gt;sdlog, &lt;span class=&quot;at&quot;&gt;w=&lt;/span&gt;.&lt;span class=&quot;sc&quot;&gt;$&lt;/span&gt;w)&lt;/span&gt;
&lt;span id=&quot;cb1-8&quot;&gt;&lt;a href=&quot;#cb1-8&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  int &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;mean&lt;/span&gt;( &lt;span class=&quot;fu&quot;&gt;abs&lt;/span&gt;(x&lt;span class=&quot;sc&quot;&gt;-&lt;/span&gt;y) )&lt;/span&gt;
&lt;span id=&quot;cb1-9&quot;&gt;&lt;a href=&quot;#cb1-9&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  mu &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;sum&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;exp&lt;/span&gt;( .&lt;span class=&quot;sc&quot;&gt;$&lt;/span&gt;meanlog &lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt; &lt;span class=&quot;sc&quot;&gt;*&lt;/span&gt; .&lt;span class=&quot;sc&quot;&gt;$&lt;/span&gt;sdlog&lt;span class=&quot;sc&quot;&gt;^&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;) &lt;span class=&quot;sc&quot;&gt;*&lt;/span&gt; .&lt;span class=&quot;sc&quot;&gt;$&lt;/span&gt;w)&lt;/span&gt;
&lt;span id=&quot;cb1-10&quot;&gt;&lt;a href=&quot;#cb1-10&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;data.frame&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;gini_all_mc=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;/&lt;/span&gt;(&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;*&lt;/span&gt;mu)&lt;span class=&quot;sc&quot;&gt;*&lt;/span&gt;int,&lt;/span&gt;
&lt;span id=&quot;cb1-11&quot;&gt;&lt;a href=&quot;#cb1-11&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;             &lt;span class=&quot;at&quot;&gt;country_gini=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;gini&lt;/span&gt;(.&lt;span class=&quot;sc&quot;&gt;$&lt;/span&gt;gdp&lt;span class=&quot;sc&quot;&gt;*&lt;/span&gt;.&lt;span class=&quot;sc&quot;&gt;$&lt;/span&gt;population))&lt;/span&gt;
&lt;span id=&quot;cb1-12&quot;&gt;&lt;a href=&quot;#cb1-12&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;}) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-13&quot;&gt;&lt;a href=&quot;#cb1-13&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;rename&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;at&quot;&gt;World Population GDP/capita&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;ot&quot;&gt;=&lt;/span&gt;gini_all_mc, &lt;span class=&quot;st&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;at&quot;&gt;Country GDP/capita&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;ot&quot;&gt;=&lt;/span&gt;country_gini)&lt;/span&gt;
&lt;span id=&quot;cb1-14&quot;&gt;&lt;a href=&quot;#cb1-14&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-15&quot;&gt;&lt;a href=&quot;#cb1-15&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##Convert to long format&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-16&quot;&gt;&lt;a href=&quot;#cb1-16&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;gini_ts &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; gini_year &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;gather&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;key=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;type&amp;quot;&lt;/span&gt;, &lt;span class=&quot;at&quot;&gt;value=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;gini&amp;quot;&lt;/span&gt;, &lt;span class=&quot;sc&quot;&gt;-&lt;/span&gt;year)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3 id=&quot;results&quot;&gt;Results&lt;/h3&gt;
&lt;p&gt;We start by showing the country specific Gini coefficient per year
since 1950 for a somewhat arbitrary selection of countries. The dashed
black line shows the mean Gini coefficient each year over all 192
country specific Gini coefficients in the dataset.&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/blog/figure/source/2018-07-09-gini/GINITSSELECTED-1.png&quot; style=&quot;display: block; margin: auto;&quot; /&gt;&lt;/p&gt;
&lt;p&gt;In addition, we compute and show as time series the Gini coefficient
of the 192 countries’ GDP/capita per year. Furthermore, we show the
Monte Carlo computed Gini coefficient for the world’s income
distribution given as a log-normal mixture with 192 components.&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/blog/figure/source/2018-07-09-gini/PLOTGINI-1.png&quot; style=&quot;display: block; margin: auto;&quot; /&gt;&lt;/p&gt;
&lt;p&gt;We notice that the Gini coefficient for the 192 countries’ GDP/capita
remains very stable over time. This, however, does not take the large
differences in populations between countries into account. A fairer
measure is thus the Gini coefficient for the world’s income
distribution. We see that this Gini coefficient increased over time
until peaking around 1990. From then on it has declined. However, the
pre-1950 Gini coefficients are rather guesstimates as stated by
Gapminder, hence, we zoom in on the period from 1970, because data are
more reliable from this point on.&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/blog/figure/source/2018-07-09-gini/PLOTGINIFROM1970-1.png&quot; style=&quot;display: block; margin: auto;&quot; /&gt;&lt;/p&gt;
&lt;h2 id=&quot;gini-coefficient-and-homicide-rate&quot;&gt;Gini coefficient and
Homicide Rate&lt;/h2&gt;
&lt;p&gt;Finally, we end the post by illustrating the association between the
Gini coefficient and the homicide rate per country using a 2D
scatterplot over the years. The Gapminder data download page also
contains &lt;a
href=&quot;https://docs.google.com/spreadsheet/pub?key=tZgPgT_sx3VdAuyDxEzenYA&amp;amp;output=xlsx&quot;&gt;data&lt;/a&gt;
for this for the years 1950- 2005. Unfortunately, no data for more
recent years are available from the Gapminder homepage, but the plot
shown below is the situation in 2005 with a log-base-10 y-axis for the
homicide rates. For each of the four Gapminder regional groups we also
fit a simple linear regression line to the points of all countries
within the region. Findings such as &lt;span class=&quot;citation&quot;
data-cites=&quot;fajnzylber_etal2002&quot;&gt;Fajnzylber, Lederman, and Loayza
(2002)&lt;/span&gt; suggest that there is a strong positive correlation
between Gini coefficient and homicide rate. To illustrate this the thin
dashed line is the result of a linear regression (on the log-base-10
scale) for all data points. However, we see from the plot that there are
regional differences even having a reversed sign of the relationship. Of
course correlation does not imply causality and explanations for this
relationship are &lt;a
href=&quot;https://www.theguardian.com/us-news/2017/dec/08/income-inequality-murder-homicide-rates&quot;&gt;debated&lt;/a&gt;
and beyond the scope of this post.&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/blog/figure/source/2018-07-09-gini/MURDERGINIPLOT-1.png&quot; style=&quot;display: block; margin: auto;&quot; /&gt;&lt;/p&gt;
&lt;p&gt;We extend the plots to all years 1950-2005. Unfortunately, not all
countries are available every year - so we only plot the available
countries each year. This means that many African countries are missing
from the animation. An improvement would be to try some form of linear
interpolation. Furthermore, for the sake of simplicity of illustration,
we fix countries with a reported murder rate of zero in a given year
(happens for example for Cyprus, Iceland, Fiji in some years) to 0.01
per 100,000 population. This can be nicely animated using the new
version of the &lt;a
href=&quot;https://github.com/thomasp85/gganimate&quot;&gt;&lt;code&gt;gganimate&lt;/code&gt;&lt;/a&gt;
package by &lt;a href=&quot;https://twitter.com/thomasp85&quot;&gt;Thomas Lin
Pedersen&lt;/a&gt;.&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb2&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb2-1&quot;&gt;&lt;a href=&quot;#cb2-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;## New version of gganimate. Not on CRAN yet.&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb2-2&quot;&gt;&lt;a href=&quot;#cb2-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;## devtools::install_github(&amp;#39;thomasp85/gganimate&amp;#39;)&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb2-3&quot;&gt;&lt;a href=&quot;#cb2-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;require&lt;/span&gt;(gganimate)&lt;/span&gt;
&lt;span id=&quot;cb2-4&quot;&gt;&lt;a href=&quot;#cb2-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb2-5&quot;&gt;&lt;a href=&quot;#cb2-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;p &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;ggplot&lt;/span&gt;(gm2_nozero, &lt;span class=&quot;fu&quot;&gt;aes&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;x=&lt;/span&gt;gini, &lt;span class=&quot;at&quot;&gt;y=&lt;/span&gt;murder_rate,&lt;span class=&quot;at&quot;&gt;size=&lt;/span&gt;population, &lt;span class=&quot;at&quot;&gt;color=&lt;/span&gt;Region)) &lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb2-6&quot;&gt;&lt;a href=&quot;#cb2-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;geom_point&lt;/span&gt;() &lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb2-7&quot;&gt;&lt;a href=&quot;#cb2-7&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;scale_x_continuous&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;labels=&lt;/span&gt;scales&lt;span class=&quot;sc&quot;&gt;::&lt;/span&gt;percent) &lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb2-8&quot;&gt;&lt;a href=&quot;#cb2-8&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;scale_y_continuous&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;trans=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;log10&amp;quot;&lt;/span&gt;,&lt;/span&gt;
&lt;span id=&quot;cb2-9&quot;&gt;&lt;a href=&quot;#cb2-9&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;                     &lt;span class=&quot;at&quot;&gt;breaks =&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;trans_breaks&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;quot;log10&amp;quot;&lt;/span&gt;, &lt;span class=&quot;cf&quot;&gt;function&lt;/span&gt;(x) &lt;span class=&quot;dv&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;^&lt;/span&gt;x,&lt;span class=&quot;at&quot;&gt;n=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;5&lt;/span&gt;),&lt;/span&gt;
&lt;span id=&quot;cb2-10&quot;&gt;&lt;a href=&quot;#cb2-10&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;                     &lt;span class=&quot;at&quot;&gt;labels =&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;trans_format&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;quot;log10&amp;quot;&lt;/span&gt;, &lt;span class=&quot;cf&quot;&gt;function&lt;/span&gt;(x) &lt;span class=&quot;fu&quot;&gt;ifelse&lt;/span&gt;(x&lt;span class=&quot;sc&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;0&lt;/span&gt;, &lt;span class=&quot;fu&quot;&gt;sprintf&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;paste0&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;quot;%.&amp;quot;&lt;/span&gt;,&lt;span class=&quot;fu&quot;&gt;ifelse&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;is.na&lt;/span&gt;(x),&lt;span class=&quot;st&quot;&gt;&amp;quot;0&amp;quot;&lt;/span&gt;,&lt;span class=&quot;fu&quot;&gt;round&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;abs&lt;/span&gt;(x))),&lt;span class=&quot;st&quot;&gt;&amp;quot;f&amp;quot;&lt;/span&gt;),&lt;span class=&quot;dv&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;^&lt;/span&gt;x), &lt;span class=&quot;fu&quot;&gt;sprintf&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;quot;%.0f&amp;quot;&lt;/span&gt;,&lt;span class=&quot;dv&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;^&lt;/span&gt;x)))) &lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb2-11&quot;&gt;&lt;a href=&quot;#cb2-11&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;geom_smooth&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;se=&lt;/span&gt;&lt;span class=&quot;cn&quot;&gt;FALSE&lt;/span&gt;, &lt;span class=&quot;at&quot;&gt;method=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;lm&amp;quot;&lt;/span&gt;, &lt;span class=&quot;at&quot;&gt;formula=&lt;/span&gt;y&lt;span class=&quot;sc&quot;&gt;~&lt;/span&gt;x) &lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb2-12&quot;&gt;&lt;a href=&quot;#cb2-12&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;geom_text&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;data=&lt;/span&gt;gm2, &lt;span class=&quot;fu&quot;&gt;aes&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;x=&lt;/span&gt;gini,&lt;span class=&quot;at&quot;&gt;y=&lt;/span&gt;murder_rate, &lt;span class=&quot;at&quot;&gt;label=&lt;/span&gt;country), &lt;span class=&quot;at&quot;&gt;vjust=&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;fl&quot;&gt;0.9&lt;/span&gt;, &lt;span class=&quot;at&quot;&gt;show.legend=&lt;/span&gt;&lt;span class=&quot;cn&quot;&gt;FALSE&lt;/span&gt;) &lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb2-13&quot;&gt;&lt;a href=&quot;#cb2-13&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;ylab&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;quot;Murder rate [per 100,000 population]&amp;quot;&lt;/span&gt;) &lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb2-14&quot;&gt;&lt;a href=&quot;#cb2-14&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;xlab&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;quot;Gini coefficient [in %]&amp;quot;&lt;/span&gt;) &lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb2-15&quot;&gt;&lt;a href=&quot;#cb2-15&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;guides&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;size=&lt;/span&gt;&lt;span class=&quot;cn&quot;&gt;FALSE&lt;/span&gt;) &lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb2-16&quot;&gt;&lt;a href=&quot;#cb2-16&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;labs&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;title =&lt;/span&gt; &lt;span class=&quot;st&quot;&gt;&amp;#39;Year: {frame_time}&amp;#39;&lt;/span&gt;) &lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb2-17&quot;&gt;&lt;a href=&quot;#cb2-17&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;transition_time&lt;/span&gt;(year) &lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb2-18&quot;&gt;&lt;a href=&quot;#cb2-18&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;shadow_wake&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;wake_length=&lt;/span&gt;&lt;span class=&quot;fl&quot;&gt;0.15&lt;/span&gt;, &lt;span class=&quot;at&quot;&gt;exclude_layer=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;c&lt;/span&gt;(&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;,&lt;span class=&quot;dv&quot;&gt;3&lt;/span&gt;)) &lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb2-19&quot;&gt;&lt;a href=&quot;#cb2-19&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;ease_aes&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;#39;linear&amp;#39;&lt;/span&gt;)&lt;/span&gt;
&lt;span id=&quot;cb2-20&quot;&gt;&lt;a href=&quot;#cb2-20&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb2-21&quot;&gt;&lt;a href=&quot;#cb2-21&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;animate&lt;/span&gt;(p, &lt;span class=&quot;at&quot;&gt;nframes=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;length&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;unique&lt;/span&gt;(gm2&lt;span class=&quot;sc&quot;&gt;$&lt;/span&gt;year)), &lt;span class=&quot;at&quot;&gt;fps=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;4&lt;/span&gt;, &lt;span class=&quot;at&quot;&gt;width=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;800&lt;/span&gt;, &lt;span class=&quot;at&quot;&gt;height=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;400&lt;/span&gt;, &lt;span class=&quot;at&quot;&gt;res=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;100&lt;/span&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;img src=&quot;/blog/figure/source/2018-07-09-gini/ANIMATE-1.gif&quot; style=&quot;display: block; margin: auto;&quot; /&gt;&lt;/p&gt;
&lt;h2 id=&quot;discussion&quot;&gt;Discussion&lt;/h2&gt;
&lt;p&gt;Based on the available Gapminder data we showed that in the last 25
years the Gini coefficient for the world’s income distribution has
decreased. For several individual countries opposite dynamics are,
however, observed. One particular concern is the share that the richest
1% have of the overall wealth: &lt;a
href=&quot;https://www.theguardian.com/inequality/2017/nov/14/worlds-richest-wealth-credit-suisse&quot;&gt;more
than 50%&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/blog/figure/source/2018-07-09-gini/REDDITPLOTS-1.png&quot; style=&quot;display: block; margin: auto;&quot; /&gt;&lt;/p&gt;
&lt;h2 class=&quot;unnumbered&quot; id=&quot;literature&quot;&gt;Literature&lt;/h2&gt;
&lt;div id=&quot;refs&quot; class=&quot;references csl-bib-body hanging-indent&quot;
data-entry-spacing=&quot;0&quot; role=&quot;list&quot;&gt;
&lt;div id=&quot;ref-fajnzylber_etal2002&quot; class=&quot;csl-entry&quot; role=&quot;listitem&quot;&gt;
Fajnzylber, P., D. Lederman, and N. Loayza. 2002. &lt;span&gt;“Inequality and
Violent Crime.”&lt;/span&gt; &lt;em&gt;Journal of Law and Economics&lt;/em&gt; 45 (April).
&lt;a
href=&quot;http://siteresources.worldbank.org/DEC/Resources/Crime&amp;amp;Inequality.pdf&quot;&gt;http://siteresources.worldbank.org/DEC/Resources/Crime&amp;amp;Inequality.pdf&lt;/a&gt;.
&lt;/div&gt;
&lt;/div&gt;
</description>
        <pubDate>Mon, 09 Jul 2018 00:00:00 +0200</pubDate>
        <link>https://mhoehle.github.io/blog/2018/07/09/gini.html</link>
        <guid isPermaLink="true">https://mhoehle.github.io/blog/2018/07/09/gini.html</guid>
        
        <category>rstats</category>
        
        <category>stats</category>
        
        <category>economics</category>
        
        <category>data visualization</category>
        
        <category>income</category>
        
        <category>equality</category>
        
        
      </item>
    
      <item>
        <title>Factfulness: Building Gapminder Income Mountains</title>
        <description>&lt;h2 id=&quot;abstract&quot;&gt;Abstract:&lt;/h2&gt;
&lt;p&gt;We work out the math behind the so called income mountain plots used
in the book “Factfulness” by Hans Rosling and use these insight to
generate such plots using tidyverse code. The trip includes a mixture of
log-normals, the density transformation theorem, histogram vs. density
and then skipping all those details again to make nice moving mountain
plots.&lt;/p&gt;
&lt;center&gt;
&lt;img
src=&quot;/blog/figure/source/2018-07-02-factfulness/moving-mountains.gif&quot; /&gt;
&lt;/center&gt;
&lt;p&gt;&lt;br&gt;
&lt;a rel=&quot;license&quot; href=&quot;http://creativecommons.org/licenses/by-sa/4.0/&quot;&gt;&lt;img alt=&quot;Creative Commons License&quot; style=&quot;border-width:0&quot; src=&quot;https://i.creativecommons.org/l/by-sa/4.0/88x31.png&quot;/&gt;&lt;/a&gt;
This work is licensed under a &lt;a rel=&quot;license&quot;
href=&quot;http://creativecommons.org/licenses/by-sa/4.0/&quot;&gt;Creative Commons
Attribution-ShareAlike 4.0 International License&lt;/a&gt;. The
markdown+Rknitr source code of this blog is available under a &lt;a
href=&quot;https://www.gnu.org/licenses/gpl-3.0.html&quot;&gt;GNU General Public
License (GPL v3)&lt;/a&gt; license from github.&lt;/p&gt;
&lt;h2 id=&quot;introduction&quot;&gt;Introduction&lt;/h2&gt;
&lt;p&gt;Reading the book &lt;a
href=&quot;https://www.gapminder.org/factfulness/&quot;&gt;Factfulness&lt;/a&gt; by &lt;a
href=&quot;https://en.wikipedia.org/wiki/Hans_Rosling&quot;&gt;Hans Rosling&lt;/a&gt;
seemed like a good thing to do during the summer months. The ‘&lt;a
href=&quot;https://www.nature.com/news/three-minutes-with-hans-rosling-will-change-your-mind-about-the-world-1.21143&quot;&gt;possibilistic&lt;/a&gt;’
writing style is contagious and his &lt;a
href=&quot;https://www.youtube.com/watch?v=hVimVzgtD6w&quot;&gt;TedEx&lt;/a&gt;
presentations and &lt;a
href=&quot;https://www.youtube.com/watch?v=Oxxx03_JHlM&quot;&gt;media interviews&lt;/a&gt;
are legendary teaching material on how to support your arguments with
data. What a shame he passed away in 2017.&lt;/p&gt;
What is really enjoyable about the book is that the &lt;a
href=&quot;https://www.gapminder.org&quot;&gt;Gapminder web page&lt;/a&gt; allows you to
study many of the graphs from the book interactively and contains the
data for download. Being a fan of &lt;strong&gt;transparency&lt;/strong&gt; and
&lt;strong&gt;reproducibility&lt;/strong&gt;, I got interested in the so called &lt;a
href=&quot;https://www.gapminder.org/data/documentation/income-mountains-dataset/&quot;&gt;&lt;strong&gt;income
mountain plots&lt;/strong&gt;&lt;/a&gt;, which show how incomes are distributed
within individuals of a population:
&lt;p&gt;
&lt;center&gt;
&lt;img
src=&quot;/blog/figure/source/2018-07-02-factfulness/gapminder-income-mountain.png&quot; /&gt;
&lt;/center&gt;
&lt;FONT COLOR=&quot;bbbbbb&quot;&gt;Screenshot of the 2010 income mountain plot. Free
material from &lt;a
href=&quot;https://www.gapminder.org&quot;&gt;www.gapminder.org&lt;/a&gt;.&lt;/FONT&gt;
&lt;p&gt;
&lt;p&gt;One notices that the “mountains” are plotted on a log-base-2 x-axis
and without a y-axis annotation. Why? Furthermore, world income data
usually involve mean income per country, so I got curious how/if these
plots were made without access to finer granularity level data? Aim of
this blog post is to answer these questions by using Gapminder data
freely available from their webpage. The answer ended up as a nice
&lt;code&gt;tidyverse&lt;/code&gt; exercise and could serve as motivating
application for basic probability course content.&lt;/p&gt;
&lt;h2 id=&quot;data-munging-gapminder&quot;&gt;Data Munging Gapminder&lt;/h2&gt;
&lt;p&gt;Data on income, population and Gini coefficient were needed to
analyse the above formulated questions. I have done this previously in
order to visualize the &lt;a
href=&quot;http://staff.math.su.se/hoehle/blog/2016/08/21/gapMedal.html&quot;&gt;Olympic
Medal Table Gapminder Style&lt;/a&gt;. We start by downloading the GDP data,
which is the annual gross domestic product per capita by Purchasing
Power Parities (PPP) measured in &lt;a
href=&quot;https://en.wikipedia.org/wiki/Geary–Khamis_dollar&quot;&gt;international
dollars&lt;/a&gt;, fixed 2011 prices. Hence, the inflation over the years and
differences in the cost of living between countries is accounted for and
can thus be compared - see the &lt;a
href=&quot;https://www.gapminder.org/data/documentation/gd001/&quot;&gt;Gapminder
documentation&lt;/a&gt; for further details. We download the &lt;a
href=&quot;https://github.com/Gapminder-Indicators/gdppc_cppp/raw/master/gdppc_cppp-by-gapminder.xlsx&quot;&gt;data
from Gapminder&lt;/a&gt; where they are available in &lt;em&gt;wide format&lt;/em&gt; as
Excel-file. For tidyverse handling we reshape them into &lt;em&gt;long
format&lt;/em&gt;.&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb1&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb1-1&quot;&gt;&lt;a href=&quot;#cb1-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##Download gdp data from gapminder - available under a CC BY-4 license.&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-2&quot;&gt;&lt;a href=&quot;#cb1-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;cf&quot;&gt;if&lt;/span&gt; (&lt;span class=&quot;sc&quot;&gt;!&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;file.exists&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;file.path&lt;/span&gt;(fullFigPath, &lt;span class=&quot;st&quot;&gt;&amp;quot;gapminder-gdp.xlsx&amp;quot;&lt;/span&gt;))) {&lt;/span&gt;
&lt;span id=&quot;cb1-3&quot;&gt;&lt;a href=&quot;#cb1-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;download.file&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;quot;https://github.com/Gapminder-Indicators/gdppc_cppp/raw/master/gdppc_cppp-by-gapminder.xlsx&amp;quot;&lt;/span&gt;, &lt;span class=&quot;at&quot;&gt;destfile=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;file.path&lt;/span&gt;(fullFigPath,&lt;span class=&quot;st&quot;&gt;&amp;quot;gapminder-gdp.xlsx&amp;quot;&lt;/span&gt;))&lt;/span&gt;
&lt;span id=&quot;cb1-4&quot;&gt;&lt;a href=&quot;#cb1-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;}&lt;/span&gt;
&lt;span id=&quot;cb1-5&quot;&gt;&lt;a href=&quot;#cb1-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-6&quot;&gt;&lt;a href=&quot;#cb1-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;gdp_long &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; readxl&lt;span class=&quot;sc&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;read_xlsx&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;file.path&lt;/span&gt;(fullFigPath, &lt;span class=&quot;st&quot;&gt;&amp;quot;gapminder-gdp.xlsx&amp;quot;&lt;/span&gt;), &lt;span class=&quot;at&quot;&gt;sheet=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-7&quot;&gt;&lt;a href=&quot;#cb1-7&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;rename&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;country=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;at&quot;&gt;geo.name&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;`&lt;/span&gt;) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-8&quot;&gt;&lt;a href=&quot;#cb1-8&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;select&lt;/span&gt;(&lt;span class=&quot;sc&quot;&gt;-&lt;/span&gt;geo,&lt;span class=&quot;sc&quot;&gt;-&lt;/span&gt;indicator,&lt;span class=&quot;sc&quot;&gt;-&lt;/span&gt;indicator.name) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-9&quot;&gt;&lt;a href=&quot;#cb1-9&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;gather&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;key=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;year&amp;quot;&lt;/span&gt;, &lt;span class=&quot;at&quot;&gt;value=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;gdp&amp;quot;&lt;/span&gt;, &lt;span class=&quot;sc&quot;&gt;-&lt;/span&gt;country,) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-10&quot;&gt;&lt;a href=&quot;#cb1-10&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;filter&lt;/span&gt;(&lt;span class=&quot;sc&quot;&gt;!&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;is.na&lt;/span&gt;(gdp))&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Furthermore, we rescale GDP per year to daily income, because this is
the unit used in the book.&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb2&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb2-1&quot;&gt;&lt;a href=&quot;#cb2-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;gdp_long &lt;span class=&quot;sc&quot;&gt;%&amp;lt;&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;mutate&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;gdp =&lt;/span&gt; gdp &lt;span class=&quot;sc&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;fl&quot;&gt;365.25&lt;/span&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Similar code segments are written for (see the &lt;a
href=&quot;https://raw.githubusercontent.com/hoehleatsu/hoehleatsu.github.io/master/_source/2018-07-02-factfulness.Rmd&quot;&gt;code&lt;/a&gt;
on github for details)&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;the gini (&lt;code&gt;gini_long&lt;/code&gt;) and population
(&lt;code&gt;pop_long&lt;/code&gt;) data&lt;/li&gt;
&lt;li&gt;the regional group (=continent) each country belongs two
(&lt;code&gt;group&lt;/code&gt;)&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;The four data sources are then joined into one long tibble
&lt;code&gt;gm&lt;/code&gt;. For each year we also compute the fraction a country’s
population makes up of the world population that year (column
&lt;code&gt;w&lt;/code&gt;) as well as the fraction within the year and region the
population makes up (column &lt;code&gt;w_region&lt;/code&gt;) :&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;## # A tibble: 15,552 x 9
##   country     region code  year   gini   gdp population          w  w_region
##   &amp;lt;chr&amp;gt;       &amp;lt;chr&amp;gt;  &amp;lt;chr&amp;gt; &amp;lt;chr&amp;gt; &amp;lt;dbl&amp;gt; &amp;lt;dbl&amp;gt;      &amp;lt;dbl&amp;gt;      &amp;lt;dbl&amp;gt;     &amp;lt;dbl&amp;gt;
## 1 Afghanistan Asia   AFG   1800  0.305  1.65    3280000 0.00347    0.00518  
## 2 Albania     Europe ALB   1800  0.389  1.83     410445 0.000434   0.00192  
## 3 Algeria     Africa DZA   1800  0.562  1.96    2503218 0.00264    0.0342   
## 4 Andorra     Europe AND   1800  0.4    3.28       2654 0.00000280 0.0000124
## 5 Angola      Africa AGO   1800  0.477  1.69    1567028 0.00166    0.0214   
## # ... with 1.555e+04 more rows&lt;/code&gt;&lt;/pre&gt;
&lt;h2 id=&quot;income-mountain-plots&quot;&gt;Income Mountain Plots&lt;/h2&gt;
&lt;p&gt;The construction of the income mountain plots is thoroughly described
on the &lt;a
href=&quot;https://www.gapminder.org/data/documentation/income-mountains-dataset/&quot;&gt;Gapminder
webpage&lt;/a&gt;, but without mathematical detail. With respect to the math
it says: &lt;em&gt;“Bas van Leeuwen shared his formulas with us and explained
how to the math from ginis and mean income, to accumulated distribution
shapes on a logarithmic scale.”&lt;/em&gt; Unfortunately, the formulas are not
shared with the reader. It’s not black magic though: The income
distribution of a country is assumed to be &lt;a
href=&quot;https://en.wikipedia.org/wiki/Log-normal_distribution&quot;&gt;log-normal&lt;/a&gt;
with a given mean &lt;span class=&quot;math inline&quot;&gt;\(\mu\)&lt;/span&gt; and standard
deviation &lt;span class=&quot;math inline&quot;&gt;\(\sigma\)&lt;/span&gt; on the log-scale,
i.e. &lt;span class=&quot;math inline&quot;&gt;\(X \sim
\operatorname{LogN}(\mu,\sigma^2)\)&lt;/span&gt;. From knowing the mean income
&lt;span class=&quot;math inline&quot;&gt;\(\overline{x}\)&lt;/span&gt; of the distribution as
well as the Gini index &lt;span class=&quot;math inline&quot;&gt;\(G\)&lt;/span&gt; of the
distribution, one can show that it’s possible to directly infer &lt;span
class=&quot;math inline&quot;&gt;\((\mu, \sigma)\)&lt;/span&gt; of the log-normal
distribution.&lt;/p&gt;
&lt;p&gt;Because the &lt;a
href=&quot;https://en.wikipedia.org/wiki/Gini_coefficient&quot;&gt;Gini index&lt;/a&gt; of
the log-normal distribution is given by &lt;span class=&quot;math display&quot;&gt;\[
G = 2\Phi\left(\frac{\sigma}{\sqrt{2}}\right)-1,
\]&lt;/span&gt; where &lt;span class=&quot;math inline&quot;&gt;\(\Phi\)&lt;/span&gt; denotes the
CDF of the standard normal distribution, and by knowing that the
expectation of the log-normal is &lt;span class=&quot;math inline&quot;&gt;\(E(X) =
\exp(\mu + \frac{1}{2}\sigma^2)\)&lt;/span&gt;, it is possible to determine
&lt;span class=&quot;math inline&quot;&gt;\((\mu,\sigma)\)&lt;/span&gt; as:&lt;/p&gt;
&lt;p&gt;&lt;span class=&quot;math display&quot;&gt;\[
\sigma = \sqrt{2}\&amp;gt; \Phi^{-1}\left(\frac{G+1}{2}\right)
\quad\text{and}\quad
\mu = \log(\overline{x}) - \frac{1}{2} \sigma^2.
\]&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;We can use this to determine the parameters of the log-normal for
every country in each year.&lt;/p&gt;
&lt;h3 id=&quot;mixture-distribution&quot;&gt;Mixture distribution&lt;/h3&gt;
&lt;p&gt;The income distribution of a &lt;strong&gt;set of countries&lt;/strong&gt; is now
given as a &lt;a
href=&quot;https://en.wikipedia.org/wiki/Mixture_distribution&quot;&gt;Mixture
distribution&lt;/a&gt; of log-normals, i.e. one component for each of the
countries in the set with a weight proportional to the population of the
country. As an example, the world income distribution would be a mixture
of the 192 countries in the Gapminder dataset, i.e.&lt;/p&gt;
&lt;p&gt;&lt;span class=&quot;math display&quot;&gt;\[
f_{\text{mix}}(x) = \sum_{i=1}^{192} w_i \&amp;gt;\cdot
\&amp;gt;f_{\operatorname{LogN}}(x; \mu_i, \sigma_i^2), \quad\text{where}
\quad w_i = \frac{\text{population}_i}{\sum_{j=1}^{192}
\text{population}_j},
\]&lt;/span&gt; and &lt;span class=&quot;math inline&quot;&gt;\(f_{\operatorname{LogN}}(x;
\mu_i, \sigma_i^2)\)&lt;/span&gt; is the density of the log-normal
distribution with country specific parameters. Note that we could have
equally used the mixture approach to define the income of, e.g., a
continent region. With the above definition we define standard
R-functions for computing the PDF (&lt;code&gt;dmix&lt;/code&gt;), CDF
(&lt;code&gt;pmix&lt;/code&gt;), quantile function (&lt;code&gt;qmix&lt;/code&gt;) and a
function for sampling from the distribution (&lt;code&gt;rmix&lt;/code&gt;) - see
the &lt;a
href=&quot;https://raw.githubusercontent.com/hoehleatsu/hoehleatsu.github.io/master/_source/2018-07-02-factfulness.Rmd&quot;&gt;github
code&lt;/a&gt; for details.&lt;/p&gt;
&lt;p&gt;We use the mixture approach to compute the density of the world
income distribution obtained by “mixing” all 192 log-normal
distributions. This is shown below for the World income distribution of
the year 2015. Note the &lt;span class=&quot;math inline&quot;&gt;\(\log_2\)&lt;/span&gt;
x-axis. This presentation is &lt;em&gt;Factfulness&lt;/em&gt;’ preferred way of
illustrating the skew income distribution.&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb4&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb4-1&quot;&gt;&lt;a href=&quot;#cb4-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##Restrict to year 2015&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-2&quot;&gt;&lt;a href=&quot;#cb4-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;gm_recent &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; gm &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;filter&lt;/span&gt;(year &lt;span class=&quot;sc&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;dv&quot;&gt;2015&lt;/span&gt;) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; ungroup&lt;/span&gt;
&lt;span id=&quot;cb4-3&quot;&gt;&lt;a href=&quot;#cb4-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-4&quot;&gt;&lt;a href=&quot;#cb4-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##Make a data frame containing the densities of each region for&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-5&quot;&gt;&lt;a href=&quot;#cb4-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##the gm_recent dataset&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-6&quot;&gt;&lt;a href=&quot;#cb4-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;df_pdf &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;data.frame&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;log2x=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;seq&lt;/span&gt;(&lt;span class=&quot;sc&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;,&lt;span class=&quot;dv&quot;&gt;9&lt;/span&gt;,&lt;span class=&quot;at&quot;&gt;by=&lt;/span&gt;&lt;span class=&quot;fl&quot;&gt;0.05&lt;/span&gt;)) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-7&quot;&gt;&lt;a href=&quot;#cb4-7&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;mutate&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;x=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;^&lt;/span&gt;log2x)&lt;/span&gt;
&lt;span id=&quot;cb4-8&quot;&gt;&lt;a href=&quot;#cb4-8&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-9&quot;&gt;&lt;a href=&quot;#cb4-9&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;pdf_region &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; gm_recent &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;group_by&lt;/span&gt;(region) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;do&lt;/span&gt;({&lt;/span&gt;
&lt;span id=&quot;cb4-10&quot;&gt;&lt;a href=&quot;#cb4-10&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  pdf &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;dmix&lt;/span&gt;(df_pdf&lt;span class=&quot;sc&quot;&gt;$&lt;/span&gt;x, &lt;span class=&quot;at&quot;&gt;meanlog=&lt;/span&gt;.&lt;span class=&quot;sc&quot;&gt;$&lt;/span&gt;meanlog, &lt;span class=&quot;at&quot;&gt;sdlog=&lt;/span&gt;.&lt;span class=&quot;sc&quot;&gt;$&lt;/span&gt;sdlog, &lt;span class=&quot;at&quot;&gt;w=&lt;/span&gt;.&lt;span class=&quot;sc&quot;&gt;$&lt;/span&gt;w_region)&lt;/span&gt;
&lt;span id=&quot;cb4-11&quot;&gt;&lt;a href=&quot;#cb4-11&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;data.frame&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;x=&lt;/span&gt;df_pdf&lt;span class=&quot;sc&quot;&gt;$&lt;/span&gt;x, &lt;span class=&quot;at&quot;&gt;pdf=&lt;/span&gt;pdf, &lt;span class=&quot;at&quot;&gt;w=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;sum&lt;/span&gt;(.&lt;span class=&quot;sc&quot;&gt;$&lt;/span&gt;w), &lt;span class=&quot;at&quot;&gt;population=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;sum&lt;/span&gt;(.&lt;span class=&quot;sc&quot;&gt;$&lt;/span&gt;population), &lt;span class=&quot;at&quot;&gt;w_pdf =&lt;/span&gt; pdf&lt;span class=&quot;sc&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;sum&lt;/span&gt;(.&lt;span class=&quot;sc&quot;&gt;$&lt;/span&gt;w))&lt;/span&gt;
&lt;span id=&quot;cb4-12&quot;&gt;&lt;a href=&quot;#cb4-12&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;})&lt;/span&gt;
&lt;span id=&quot;cb4-13&quot;&gt;&lt;a href=&quot;#cb4-13&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-14&quot;&gt;&lt;a href=&quot;#cb4-14&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;## Total is the sum over all regions - note the summation is done on&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-15&quot;&gt;&lt;a href=&quot;#cb4-15&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;## the original income scale and NOT the log_2 scale. However, one can show that in the special case the result on the log-base-2-scale is the same as summing the individual log-base-2 transformed densities (see hidden CHECKMIXTUREPROPERTIES chunk).&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-16&quot;&gt;&lt;a href=&quot;#cb4-16&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-17&quot;&gt;&lt;a href=&quot;#cb4-17&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;pdf_total &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; pdf_region &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;group_by&lt;/span&gt;(x) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-18&quot;&gt;&lt;a href=&quot;#cb4-18&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;summarise&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;region=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;Total&amp;quot;&lt;/span&gt;,&lt;span class=&quot;at&quot;&gt;w=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;sum&lt;/span&gt;(w), &lt;span class=&quot;at&quot;&gt;pdf =&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;sum&lt;/span&gt;(w_pdf))&lt;/span&gt;
&lt;span id=&quot;cb4-19&quot;&gt;&lt;a href=&quot;#cb4-19&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-20&quot;&gt;&lt;a href=&quot;#cb4-20&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;## Expectation of the distribution&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-21&quot;&gt;&lt;a href=&quot;#cb4-21&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;mean_mix &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; gm_recent &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-22&quot;&gt;&lt;a href=&quot;#cb4-22&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;summarise&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;mean=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;sum&lt;/span&gt;(w &lt;span class=&quot;sc&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;exp&lt;/span&gt;(meanlog &lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;*&lt;/span&gt;sdlog&lt;span class=&quot;sc&quot;&gt;^&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;))) &lt;span class=&quot;sc&quot;&gt;%$%&lt;/span&gt; mean&lt;/span&gt;
&lt;span id=&quot;cb4-23&quot;&gt;&lt;a href=&quot;#cb4-23&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-24&quot;&gt;&lt;a href=&quot;#cb4-24&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;## Median of the distribution&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-25&quot;&gt;&lt;a href=&quot;#cb4-25&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;median_mix &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;qmix&lt;/span&gt;(&lt;span class=&quot;fl&quot;&gt;0.5&lt;/span&gt;, gm_recent&lt;span class=&quot;sc&quot;&gt;$&lt;/span&gt;meanlog, gm_recent&lt;span class=&quot;sc&quot;&gt;$&lt;/span&gt;sdlog, gm_recent&lt;span class=&quot;sc&quot;&gt;$&lt;/span&gt;w)&lt;/span&gt;
&lt;span id=&quot;cb4-26&quot;&gt;&lt;a href=&quot;#cb4-26&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-27&quot;&gt;&lt;a href=&quot;#cb4-27&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;## Mode of the distribution on the log2-scale (not transformation invariant!)&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-28&quot;&gt;&lt;a href=&quot;#cb4-28&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;mode_mix &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; pdf_total &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-29&quot;&gt;&lt;a href=&quot;#cb4-29&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;mutate&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;pdf_log2x =&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;log&lt;/span&gt;(&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;) &lt;span class=&quot;sc&quot;&gt;*&lt;/span&gt; x &lt;span class=&quot;sc&quot;&gt;*&lt;/span&gt; pdf) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-30&quot;&gt;&lt;a href=&quot;#cb4-30&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;filter&lt;/span&gt;(pdf_log2x &lt;span class=&quot;sc&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;max&lt;/span&gt;(pdf_log2x)) &lt;span class=&quot;sc&quot;&gt;%$%&lt;/span&gt; x&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;img src=&quot;/blog/figure/source/2018-07-02-factfulness/DENSITYPLOTS-1.png&quot; style=&quot;display: block; margin: auto;&quot; /&gt;&lt;/p&gt;
&lt;p&gt;For illustration we compute a mixture distribution for each region
using all countries within region. This is shown in the left pane. Note:
because a log-base-2-transformation is used for the x-axis, we need to
perform a &lt;a
href=&quot;https://en.wikipedia.org/wiki/Probability_density_function#Dependent_variables_and_change_of_variables&quot;&gt;change
of variables&lt;/a&gt;, i.e. we compute the density for &lt;span
class=&quot;math inline&quot;&gt;\(Y=\log_2(X)=g(X)\)&lt;/span&gt; where &lt;span
class=&quot;math inline&quot;&gt;\(X\sim f_{\text{mix}}\)&lt;/span&gt;, i.e. &lt;span
class=&quot;math display&quot;&gt;\[
f_Y(y) = \left| \frac{d}{dy}(g^{-1}(y)) \right| f_X(g^{-1}(y)) = \log(2)
\cdot 2^y \cdot f_{\text{mix}}( 2^y) = \log(2) \cdot x \cdot
f_{\text{mix}}(x), \text{ where } x=2^y.
\]&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;In the right pane we then show the region specific densities each
weighted by their population fraction. These are then summed up to yield
the world income shown as a thick blue line. The median of the resulting
world income distribution is at 20.0 $/day, whereas the mean of the
mixture is at an income of 39.9$/day and the mode (on the log-base-2
scale) is 17.1$/day. Note that the later is not transformation
invariant, i.e. the value is not the mode of the income distribution,
but of &lt;span class=&quot;math inline&quot;&gt;\(\log_2(X)\)&lt;/span&gt;.&lt;/p&gt;
&lt;p&gt;To get the income mountain plots as shown in &lt;em&gt;Factfulness&lt;/em&gt;, we
additionally need to obtain number of people on the &lt;span
class=&quot;math inline&quot;&gt;\(y\)&lt;/span&gt;-axis and not density. We do this by
partitioning the x-axis into non-overlapping intervals and then compute
the number of individuals expected to fall into a given interval with
limits &lt;span class=&quot;math inline&quot;&gt;\([l, u]\)&lt;/span&gt;. Under our model this
expectation is&lt;/p&gt;
&lt;p&gt;&lt;span class=&quot;math display&quot;&gt;\[n \cdot
(F_{\text{mix}}(u)-F_{\text{mix}}(l)),\]&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;where &lt;span class=&quot;math inline&quot;&gt;\(F_{\text{mix}}\)&lt;/span&gt; is the CDF
of the mixture distribution and &lt;span class=&quot;math inline&quot;&gt;\(n\)&lt;/span&gt;
is the total world population. The mountain plot below shows this for a
given partition with &lt;span
class=&quot;math inline&quot;&gt;\(n=7,305,116,647\)&lt;/span&gt;. Note that &lt;span
class=&quot;math inline&quot;&gt;\(2.5\cdot
10^8\)&lt;/span&gt; corresponds to 250 mio people. Also note the &lt;span
class=&quot;math inline&quot;&gt;\(\log_2\)&lt;/span&gt; x-axis, and hence (on the linear
scale) unequally wide intervals of the partitioning. Contrary to
&lt;em&gt;Factfulness&lt;/em&gt;’, I prefer to make this more explicit by indicating
the intervals explicitly on the x-axis of the mountain plot, because it
is about number of people in certain &lt;strong&gt;income
brackets&lt;/strong&gt;.&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb5&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb5-1&quot;&gt;&lt;a href=&quot;#cb5-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##Function to prepare the data.frame to be used in a mountain plot&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb5-2&quot;&gt;&lt;a href=&quot;#cb5-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;make_mountain_df &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;cf&quot;&gt;function&lt;/span&gt;(gm_df, &lt;span class=&quot;at&quot;&gt;log2x=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;seq&lt;/span&gt;(&lt;span class=&quot;sc&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;,&lt;span class=&quot;dv&quot;&gt;9&lt;/span&gt;,&lt;span class=&quot;at&quot;&gt;by=&lt;/span&gt;&lt;span class=&quot;fl&quot;&gt;0.25&lt;/span&gt;)) {&lt;/span&gt;
&lt;span id=&quot;cb5-3&quot;&gt;&lt;a href=&quot;#cb5-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;do&quot;&gt;##Make a data.frame containing the intervals with appropriate annotation&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb5-4&quot;&gt;&lt;a href=&quot;#cb5-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  df &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;data.frame&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;log2x=&lt;/span&gt;log2x) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb5-5&quot;&gt;&lt;a href=&quot;#cb5-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;fu&quot;&gt;mutate&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;x=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;^&lt;/span&gt;log2x)  &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb5-6&quot;&gt;&lt;a href=&quot;#cb5-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;fu&quot;&gt;mutate&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;xm1 =&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;lag&lt;/span&gt;(x), &lt;span class=&quot;at&quot;&gt;log2xm1=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;lag&lt;/span&gt;(log2x)) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb5-7&quot;&gt;&lt;a href=&quot;#cb5-7&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;fu&quot;&gt;mutate&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;xm1=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;if_else&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;is.na&lt;/span&gt;(xm1),&lt;span class=&quot;dv&quot;&gt;0&lt;/span&gt;,xm1),&lt;/span&gt;
&lt;span id=&quot;cb5-8&quot;&gt;&lt;a href=&quot;#cb5-8&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;           &lt;span class=&quot;at&quot;&gt;log2xm1=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;if_else&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;is.na&lt;/span&gt;(log2xm1),&lt;span class=&quot;dv&quot;&gt;0&lt;/span&gt;,log2xm1),&lt;/span&gt;
&lt;span id=&quot;cb5-9&quot;&gt;&lt;a href=&quot;#cb5-9&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;           &lt;span class=&quot;at&quot;&gt;mid_log2 =&lt;/span&gt; (log2x&lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt;log2xm1)&lt;span class=&quot;sc&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;,&lt;/span&gt;
&lt;span id=&quot;cb5-10&quot;&gt;&lt;a href=&quot;#cb5-10&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;           &lt;span class=&quot;at&quot;&gt;width =&lt;/span&gt; (x&lt;span class=&quot;sc&quot;&gt;-&lt;/span&gt;xm1),&lt;/span&gt;
&lt;span id=&quot;cb5-11&quot;&gt;&lt;a href=&quot;#cb5-11&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;           &lt;span class=&quot;at&quot;&gt;width_log2 =&lt;/span&gt; (log2x&lt;span class=&quot;sc&quot;&gt;-&lt;/span&gt;log2xm1)) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb5-12&quot;&gt;&lt;a href=&quot;#cb5-12&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;do&quot;&gt;##Format the interval character representation&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb5-13&quot;&gt;&lt;a href=&quot;#cb5-13&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;fu&quot;&gt;mutate&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;interval=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;if_else&lt;/span&gt;(xm1&lt;span class=&quot;sc&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;, &lt;span class=&quot;fu&quot;&gt;sprintf&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;quot;[%6.1f-%6.1f]&amp;quot;&lt;/span&gt;,xm1,x), &lt;span class=&quot;fu&quot;&gt;sprintf&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;quot;[%4.0f-%4.0f]&amp;quot;&lt;/span&gt;,xm1,x)),&lt;/span&gt;
&lt;span id=&quot;cb5-14&quot;&gt;&lt;a href=&quot;#cb5-14&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;           &lt;span class=&quot;at&quot;&gt;interval_log2x=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;sprintf&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;quot;[2^(%4.1f)-2^(%4.1f)]&amp;quot;&lt;/span&gt;,log2xm1,log2x))&lt;/span&gt;
&lt;span id=&quot;cb5-15&quot;&gt;&lt;a href=&quot;#cb5-15&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb5-16&quot;&gt;&lt;a href=&quot;#cb5-16&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;do&quot;&gt;##Compute expected number of individuals in each bin.&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb5-17&quot;&gt;&lt;a href=&quot;#cb5-17&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  people &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; gm_df &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;group_by&lt;/span&gt;(region) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;do&lt;/span&gt;({&lt;/span&gt;
&lt;span id=&quot;cb5-18&quot;&gt;&lt;a href=&quot;#cb5-18&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    countries &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; .&lt;/span&gt;
&lt;span id=&quot;cb5-19&quot;&gt;&lt;a href=&quot;#cb5-19&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    temp &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; df &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;slice&lt;/span&gt;(&lt;span class=&quot;sc&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; rowwise &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb5-20&quot;&gt;&lt;a href=&quot;#cb5-20&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;      &lt;span class=&quot;fu&quot;&gt;mutate&lt;/span&gt;(&lt;/span&gt;
&lt;span id=&quot;cb5-21&quot;&gt;&lt;a href=&quot;#cb5-21&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;        &lt;span class=&quot;at&quot;&gt;prob_mass =&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;diff&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;pmix&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;c&lt;/span&gt;(xm1,x), &lt;span class=&quot;at&quot;&gt;meanlog=&lt;/span&gt;countries&lt;span class=&quot;sc&quot;&gt;$&lt;/span&gt;meanlog, &lt;span class=&quot;at&quot;&gt;sdlog=&lt;/span&gt;countries&lt;span class=&quot;sc&quot;&gt;$&lt;/span&gt;sdlog, &lt;span class=&quot;at&quot;&gt;w=&lt;/span&gt;countries&lt;span class=&quot;sc&quot;&gt;$&lt;/span&gt;w_region)),&lt;/span&gt;
&lt;span id=&quot;cb5-22&quot;&gt;&lt;a href=&quot;#cb5-22&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;        &lt;span class=&quot;at&quot;&gt;people =&lt;/span&gt; prob_mass &lt;span class=&quot;sc&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;sum&lt;/span&gt;(countries&lt;span class=&quot;sc&quot;&gt;$&lt;/span&gt;population)&lt;/span&gt;
&lt;span id=&quot;cb5-23&quot;&gt;&lt;a href=&quot;#cb5-23&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;      )&lt;/span&gt;
&lt;span id=&quot;cb5-24&quot;&gt;&lt;a href=&quot;#cb5-24&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    temp &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;mutate&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;year =&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;max&lt;/span&gt;(gm_df&lt;span class=&quot;sc&quot;&gt;$&lt;/span&gt;year))&lt;/span&gt;
&lt;span id=&quot;cb5-25&quot;&gt;&lt;a href=&quot;#cb5-25&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  })&lt;/span&gt;
&lt;span id=&quot;cb5-26&quot;&gt;&lt;a href=&quot;#cb5-26&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb5-27&quot;&gt;&lt;a href=&quot;#cb5-27&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;do&quot;&gt;##Done&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb5-28&quot;&gt;&lt;a href=&quot;#cb5-28&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;return&lt;/span&gt;(people)&lt;/span&gt;
&lt;span id=&quot;cb5-29&quot;&gt;&lt;a href=&quot;#cb5-29&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;}&lt;/span&gt;
&lt;span id=&quot;cb5-30&quot;&gt;&lt;a href=&quot;#cb5-30&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb5-31&quot;&gt;&lt;a href=&quot;#cb5-31&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##Create mountain plot data set for gm_recent with default spacing.&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb5-32&quot;&gt;&lt;a href=&quot;#cb5-32&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;(people &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;make_mountain_df&lt;/span&gt;(gm_recent))&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;## # A tibble: 176 x 13
## # Groups:   region [4]
##   region log2x     x   xm1 log2xm1 mid_log2  width width_log2 interval        interval_log2x      prob_mass   people year 
##   &amp;lt;chr&amp;gt;  &amp;lt;dbl&amp;gt; &amp;lt;dbl&amp;gt; &amp;lt;dbl&amp;gt;   &amp;lt;dbl&amp;gt;    &amp;lt;dbl&amp;gt;  &amp;lt;dbl&amp;gt;      &amp;lt;dbl&amp;gt; &amp;lt;chr&amp;gt;           &amp;lt;chr&amp;gt;                   &amp;lt;dbl&amp;gt;    &amp;lt;dbl&amp;gt; &amp;lt;chr&amp;gt;
## 1 Africa -1.75 0.297 0.25    -2      -1.88  0.0473       0.25 [   0.2-   0.3] [2^(-2.0)-2^(-1.8)]   0.00134 1586808. 2015 
## 2 Africa -1.5  0.354 0.297   -1.75   -1.62  0.0563       0.25 [   0.3-   0.4] [2^(-1.8)-2^(-1.5)]   0.00205 2432998. 2015 
## 3 Africa -1.25 0.420 0.354   -1.5    -1.38  0.0669       0.25 [   0.4-   0.4] [2^(-1.5)-2^(-1.2)]   0.00307 3639365. 2015 
## 4 Africa -1    0.5   0.420   -1.25   -1.12  0.0796       0.25 [   0.4-   0.5] [2^(-1.2)-2^(-1.0)]   0.00448 5305674. 2015 
## 5 Africa -0.75 0.595 0.5     -1      -0.875 0.0946       0.25 [   0.5-   0.6] [2^(-1.0)-2^(-0.8)]   0.00636 7537067. 2015 
## # ... with 171 more rows&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;This can then be plotted with &lt;code&gt;ggplot2&lt;/code&gt;:
&lt;img src=&quot;/blog/figure/source/2018-07-02-factfulness/TRUEMOUNTAINPLOT-1.png&quot; style=&quot;display: block; margin: auto;&quot; /&gt;&lt;/p&gt;
&lt;p&gt;In light of all the talk about gaps, it can also be healthy to plot
the income distribution on the linear scale. From this it becomes
obvious that linearly there indeed are larger absolute differences in
income, but -as argued in the book- the exp-scale (base 2) incorporates
peoples perception about the worth of additional income.&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/blog/figure/source/2018-07-02-factfulness/LINEARSCALE-MOUNTAINPLOT-1.png&quot; style=&quot;display: block; margin: auto;&quot; /&gt;
Because the intervals are not equally wide, only the height of the bars
should be interpreted in this plot. However, the eye perceives area,
which in this case is misguiding. Showing histograms with unequal bin
widths is a constant dilemma between area, height, density and
perception. The recommendation would be that if one wants to use the
linear-scale, then one should use equal width linear intervals or
directly plot the density. As a consequence, plots like the above are
not recommended, but they make obvious the tail behaviour of the income
distribution - a feature which is somewhat hidden by the
log-base-2-scale plots.&lt;/p&gt;
&lt;p&gt;Of course none of the above plots looks as nice as the Gapminder
plots, but they have proper x and y-axes annotation and, IMHO, are
clearer to interpret, because they do not mix the concept of density
with the concept of individuals falling into income bins. As the
bin-width converges to zero, one gets the density multiplied by &lt;span
class=&quot;math inline&quot;&gt;\(n\)&lt;/span&gt;, but this complication of infinitesimal
width bins is impossible to communicate. In the end this was the talent
of Hans Rosling and Gapminder - to make the complicated easy and
intuitive! We honor this by skipping the math&lt;a href=&quot;#fn1&quot;
class=&quot;footnote-ref&quot; id=&quot;fnref1&quot; role=&quot;doc-noteref&quot;&gt;&lt;sup&gt;1&lt;/sup&gt;&lt;/a&gt; and
celebrate the result as the &lt;strong&gt;art&lt;/strong&gt; it is!&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb7&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb7-1&quot;&gt;&lt;a href=&quot;#cb7-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##Make mountain plot with smaller intervals than in previous plot.&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb7-2&quot;&gt;&lt;a href=&quot;#cb7-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;ggplot_oneyear_mountain &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;cf&quot;&gt;function&lt;/span&gt;(people, &lt;span class=&quot;at&quot;&gt;ymax=&lt;/span&gt;&lt;span class=&quot;cn&quot;&gt;NA&lt;/span&gt;) {&lt;/span&gt;
&lt;span id=&quot;cb7-3&quot;&gt;&lt;a href=&quot;#cb7-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;do&quot;&gt;##Make the ggplot&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb7-4&quot;&gt;&lt;a href=&quot;#cb7-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  p &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;ggplot&lt;/span&gt;(people &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;rename&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;Region=&lt;/span&gt;region), &lt;span class=&quot;fu&quot;&gt;aes&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;x=&lt;/span&gt;mid_log2,&lt;span class=&quot;at&quot;&gt;y=&lt;/span&gt;people, &lt;span class=&quot;at&quot;&gt;fill=&lt;/span&gt;Region)) &lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb7-5&quot;&gt;&lt;a href=&quot;#cb7-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;fu&quot;&gt;geom_col&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;width=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;min&lt;/span&gt;(people&lt;span class=&quot;sc&quot;&gt;$&lt;/span&gt;width_log2)) &lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb7-6&quot;&gt;&lt;a href=&quot;#cb7-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;fu&quot;&gt;ylab&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;quot;Number of individuals&amp;quot;&lt;/span&gt;) &lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb7-7&quot;&gt;&lt;a href=&quot;#cb7-7&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;fu&quot;&gt;xlab&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;quot;Income [$/day]&amp;quot;&lt;/span&gt;) &lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb7-8&quot;&gt;&lt;a href=&quot;#cb7-8&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;fu&quot;&gt;scale_x_continuous&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;minor_breaks =&lt;/span&gt; &lt;span class=&quot;cn&quot;&gt;NULL&lt;/span&gt;, &lt;span class=&quot;at&quot;&gt;trans=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;identity&amp;quot;&lt;/span&gt;,&lt;/span&gt;
&lt;span id=&quot;cb7-9&quot;&gt;&lt;a href=&quot;#cb7-9&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;                       &lt;span class=&quot;at&quot;&gt;breaks =&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;trans_breaks&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;quot;identity&amp;quot;&lt;/span&gt;, &lt;span class=&quot;cf&quot;&gt;function&lt;/span&gt;(x) x,&lt;span class=&quot;at&quot;&gt;n=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;11&lt;/span&gt;),&lt;/span&gt;
&lt;span id=&quot;cb7-10&quot;&gt;&lt;a href=&quot;#cb7-10&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;                       &lt;span class=&quot;at&quot;&gt;labels =&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;trans_format&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;trans=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;identity&amp;quot;&lt;/span&gt;, &lt;span class=&quot;at&quot;&gt;format=&lt;/span&gt;&lt;span class=&quot;cf&quot;&gt;function&lt;/span&gt;(x) &lt;span class=&quot;fu&quot;&gt;ifelse&lt;/span&gt;(x&lt;span class=&quot;sc&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;0&lt;/span&gt;, &lt;span class=&quot;fu&quot;&gt;sprintf&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;quot;%.1f&amp;quot;&lt;/span&gt;,&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;^&lt;/span&gt;x), &lt;span class=&quot;fu&quot;&gt;sprintf&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;quot;%.0f&amp;quot;&lt;/span&gt;,&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;^&lt;/span&gt;x)))) &lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb7-11&quot;&gt;&lt;a href=&quot;#cb7-11&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;fu&quot;&gt;theme&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;axis.text.y=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;element_blank&lt;/span&gt;(), &lt;span class=&quot;at&quot;&gt;axis.ticks.y=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;element_blank&lt;/span&gt;()) &lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb7-12&quot;&gt;&lt;a href=&quot;#cb7-12&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;fu&quot;&gt;scale_y_continuous&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;minor_breaks =&lt;/span&gt; &lt;span class=&quot;cn&quot;&gt;NULL&lt;/span&gt;, &lt;span class=&quot;at&quot;&gt;breaks =&lt;/span&gt; &lt;span class=&quot;cn&quot;&gt;NULL&lt;/span&gt;, &lt;span class=&quot;at&quot;&gt;limits=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;c&lt;/span&gt;(&lt;span class=&quot;dv&quot;&gt;0&lt;/span&gt;,ymax)) &lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb7-13&quot;&gt;&lt;a href=&quot;#cb7-13&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;fu&quot;&gt;ggtitle&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;paste0&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;quot;World Income Mountain &amp;quot;&lt;/span&gt;,&lt;span class=&quot;fu&quot;&gt;max&lt;/span&gt;(people&lt;span class=&quot;sc&quot;&gt;$&lt;/span&gt;year))) &lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb7-14&quot;&gt;&lt;a href=&quot;#cb7-14&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;cn&quot;&gt;NULL&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb7-15&quot;&gt;&lt;a href=&quot;#cb7-15&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb7-16&quot;&gt;&lt;a href=&quot;#cb7-16&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;co&quot;&gt;#Show it and return it.&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb7-17&quot;&gt;&lt;a href=&quot;#cb7-17&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;print&lt;/span&gt;(p)&lt;/span&gt;
&lt;span id=&quot;cb7-18&quot;&gt;&lt;a href=&quot;#cb7-18&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;invisible&lt;/span&gt;(p)&lt;/span&gt;
&lt;span id=&quot;cb7-19&quot;&gt;&lt;a href=&quot;#cb7-19&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;}&lt;/span&gt;
&lt;span id=&quot;cb7-20&quot;&gt;&lt;a href=&quot;#cb7-20&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb7-21&quot;&gt;&lt;a href=&quot;#cb7-21&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##Create the mountain plot for 2015&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb7-22&quot;&gt;&lt;a href=&quot;#cb7-22&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;gm_recent &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb7-23&quot;&gt;&lt;a href=&quot;#cb7-23&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;make_mountain_df&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;log2x=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;seq&lt;/span&gt;(&lt;span class=&quot;sc&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;,&lt;span class=&quot;dv&quot;&gt;9&lt;/span&gt;,&lt;span class=&quot;at&quot;&gt;by=&lt;/span&gt;&lt;span class=&quot;fl&quot;&gt;0.01&lt;/span&gt;)) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb7-24&quot;&gt;&lt;a href=&quot;#cb7-24&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;ggplot_oneyear_mountain&lt;/span&gt;()&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;img src=&quot;/blog/figure/source/2018-07-02-factfulness/ARTISTICMOUNTAINPLOT-1.png&quot; style=&quot;display: block; margin: auto;&quot; /&gt;&lt;/p&gt;
&lt;h2 id=&quot;discussion&quot;&gt;Discussion&lt;/h2&gt;
&lt;p&gt;Our replicated mountain plots do not exactly match those made by
Gapminder (c.f. the screenshot). It appears as if our distributions are
located slightly more to the right. It is not entirely clear why there
is a deviation, but one possible problem could be that we do the
translation into income per day differently? I’m not an econometrician,
so this could be a trivial blunder on my side, however, the values in
this post are roughly of the same magnitude as the graph on p. 45 in
&lt;span class=&quot;citation&quot; data-cites=&quot;vanzanden_etal2011&quot;&gt;van Zanden et al.
(2011)&lt;/span&gt; mentioned in the &lt;a
href=&quot;https://www.gapminder.org/data/documentation/income-mountains-dataset/&quot;&gt;Gapminder
documentation page&lt;/a&gt;, whereas the Gapminder curves appear too far to
the left. It might be worthwhile to check &lt;a
href=&quot;https://docs.google.com/spreadsheets/d/1939CzZ5HHoLreb0YyopaWfNjJ9mnN27IhywI6-TuwZs/edit#gid=501532268&quot;&gt;individual
country data&lt;/a&gt; underlying the graphs to see where the difference is.
&lt;br&gt; &lt;strong&gt;Edit 2018-07-05:&lt;/strong&gt; I checked this and read the &lt;a
href=&quot;https://www.gapminder.org/data/documentation/income-mountains-dataset/&quot;&gt;documentation&lt;/a&gt;
again more carefully: Apparently, Gapminder uses &lt;em&gt;mean household
income (or consumption) per person per day (measured in PPP$ 2011)&lt;/em&gt;
opposite to the &lt;em&gt;GDP/capita&lt;/em&gt; used in the scientific literature
they quote and for which you can download the data from their website.
To me this was not clear when reading Factfulness and, unfortunately,
there is no documentation for how exactly their mean household income
value per individual is computed from the GDP/capita.&lt;a href=&quot;#fn2&quot;
class=&quot;footnote-ref&quot; id=&quot;fnref2&quot; role=&quot;doc-noteref&quot;&gt;&lt;sup&gt;2&lt;/sup&gt;&lt;/a&gt; For
the sake of illustrating the dynamics in the world income the difference
in scale is not that important, though.&lt;/p&gt;
&lt;p&gt;We end the post by animating the dynamics of the income mountains
since 1950 using &lt;code&gt;gganimate&lt;/code&gt;. To put it in possibilistic
terms: Let the &lt;a href=&quot;https://youtu.be/hVimVzgtD6w?t=8m12s&quot;&gt;world move
forward&lt;/a&gt;! It is not as bad as it seems. Facts matter.&lt;/p&gt;
&lt;center&gt;
&lt;img
src=&quot;/blog/figure/source/2018-07-02-factfulness/moving-mountains.gif&quot; /&gt;
&lt;/center&gt;
&lt;h2 class=&quot;unnumbered&quot; id=&quot;literature&quot;&gt;Literature&lt;/h2&gt;
&lt;div id=&quot;refs&quot; class=&quot;references csl-bib-body hanging-indent&quot;
data-entry-spacing=&quot;0&quot; role=&quot;list&quot;&gt;
&lt;div id=&quot;ref-vanzanden_etal2011&quot; class=&quot;csl-entry&quot; role=&quot;listitem&quot;&gt;
van Zanden, J. L., J. Baten, P. Foldvari, and B. van Leeuwen. 2011.
&lt;span&gt;“&lt;span class=&quot;nocase&quot;&gt;The Changing Shape of Global Inequality -
exploring a new dataset&lt;/span&gt;.”&lt;/span&gt; Working Papers 0001. Utrecht
University, Centre for Global Economic History. &lt;a
href=&quot;https://ideas.repec.org/p/ucg/wpaper/0001.html&quot;&gt;https://ideas.repec.org/p/ucg/wpaper/0001.html&lt;/a&gt;.
&lt;/div&gt;
&lt;/div&gt;
&lt;section id=&quot;footnotes&quot; class=&quot;footnotes footnotes-end-of-document&quot;
role=&quot;doc-endnotes&quot;&gt;
&lt;hr /&gt;
&lt;ol&gt;
&lt;li id=&quot;fn1&quot;&gt;&lt;p&gt;Shown is the expected number of individuals in thin bins
of size 0.01 on the log-base-2-scale. As done in Factfulness we also
skip the interval annotation on the x-axis and, as a consequence, do
without y-axis tick marks, which would require one to explain the
interval widths.&lt;a href=&quot;#fnref1&quot; class=&quot;footnote-back&quot;
role=&quot;doc-backlink&quot;&gt;↩︎&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;
&lt;li id=&quot;fn2&quot;&gt;&lt;p&gt;The Gapminder &lt;a
href=&quot;http://www.gapm.io/ioihhinc&quot;&gt;Household Income v1&lt;/a&gt; description
is currently (as of 2018-07-05) blank and so is the link specified as
reference &lt;a href=&quot;gapm.io/elev&quot;&gt;Gapminder [3]&lt;/a&gt; in
&lt;em&gt;Factfulness&lt;/em&gt;. The detailed data just contain the column
&lt;code&gt;household_income&lt;/code&gt; without further explanation. Altogether, a
somewhat disappointing number of links in the book are currently still
under construction. Reading the document &lt;a
href=&quot;https://www.gapminder.org/news/data-sources-dont-panic-end-poverty/&quot;&gt;Data
Sources used in Don’t Panic — End Poverty&lt;/a&gt; it appears to me that the
GDP/capita are converted to household incomes by scaling all countries
GDPs per capita until the global income log-normal mixture distribution
is such that &lt;em&gt;11.3% of world population are below the extreme poverty
line of 1.85$/day (in PPP 2011) in year 2015&lt;/em&gt;. When I tried this
rather ad-hoc approach I got a scale parameter of approximately 0.379
for the GDP, which corresponds to a shift of 1.402 to the left on the
log-base-2 scale. This worked ok for the single benchmark of Sweden in
1970 that I tested. Furthermore, Gapminder uses something they call
&lt;strong&gt;log-normal-topping&lt;/strong&gt; per country in order to get better
tail behaviour. &lt;a
href=&quot;https://drive.google.com/drive/folders/11_k8_sTa7ycuprJjaORotbGVQyX1b_tx&quot;&gt;Adventurous
Excel-files&lt;/a&gt; not directly linked to in any explanation are used for
the calculation and can be consulted for further details. The authors
note themselves that they hope to convert these computations to python
soon…😄&lt;a href=&quot;#fnref2&quot; class=&quot;footnote-back&quot;
role=&quot;doc-backlink&quot;&gt;↩︎&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;/section&gt;
</description>
        <pubDate>Mon, 02 Jul 2018 00:00:00 +0200</pubDate>
        <link>https://mhoehle.github.io/blog/2018/07/02/factfulness.html</link>
        <guid isPermaLink="true">https://mhoehle.github.io/blog/2018/07/02/factfulness.html</guid>
        
        <category>rstats</category>
        
        <category>stats</category>
        
        <category>economics</category>
        
        <category>data visualization</category>
        
        <category>world health</category>
        
        
      </item>
    
      <item>
        <title>Retracing Prenatal Testing Algorithms</title>
        <description>&lt;h2 id=&quot;abstract&quot;&gt;Abstract&lt;/h2&gt;
&lt;p&gt;A good understanding of the statistical procedure used to calculate
trisomy 21 (Down syndrome) risk in combined first trimester screening is
a precondition for taking an informed decision on how to proceed with
the screening results. For this purpose we implement the Fetal Medicine
Foundation (FMF) Germany procedure described in &lt;span class=&quot;citation&quot;
data-cites=&quot;merz_etal2016&quot;&gt;Merz et al. (2016)&lt;/span&gt;. To allow
soon-to-become-parents an insight on what the procedure does and how
sensitive conclusions are to perturbations, we wrote a small Shiny app
as part of the R package &lt;code&gt;trisomy21risk&lt;/code&gt; to visualize the
results. We hope the tool can be helpful in the individual decision
making process associated with first trimester screening.&lt;/p&gt;
&lt;center&gt;
&lt;img
src=&quot;https://upload.wikimedia.org/wikipedia/commons/thumb/a/aa/Feindiagnostik_%28Ultraschall%29.jpg/320px-Feindiagnostik_%28Ultraschall%29.jpg&quot; /&gt;
&lt;/center&gt;
&lt;p&gt;&lt;br&gt;
&lt;a rel=&quot;license&quot; href=&quot;http://creativecommons.org/licenses/by-sa/4.0/&quot;&gt;&lt;img alt=&quot;Creative Commons License&quot; style=&quot;border-width:0&quot; src=&quot;https://i.creativecommons.org/l/by-sa/4.0/88x31.png&quot;/&gt;&lt;/a&gt;
This work is licensed under a &lt;a rel=&quot;license&quot;
href=&quot;http://creativecommons.org/licenses/by-sa/4.0/&quot;&gt;Creative Commons
Attribution-ShareAlike 4.0 International License&lt;/a&gt;. The
markdown+Rknitr source code of this blog is available under a &lt;a
href=&quot;https://www.gnu.org/licenses/gpl-3.0.html&quot;&gt;GNU General Public
License (GPL v3)&lt;/a&gt; license from github.&lt;/p&gt;
&lt;h2 id=&quot;introduction&quot;&gt;Introduction&lt;/h2&gt;
&lt;p&gt;Biostatisticians predominantly analyse samples from populations of
dead and diseased in the hope of substantiating answers to question
aimed at preventing the adverse event in future individuals. Less common
is the personalized &lt;span class=&quot;math inline&quot;&gt;\(n=1\)&lt;/span&gt; case, where
-based on historical data- one has to choose an optimal test sequence or
treatment regime for a specific individual. However, when interpreting
your own laboratory values that is what you have to do - implicitly or
explicitly!&lt;/p&gt;
&lt;p&gt;In the case of first trimester &lt;a
href=&quot;en.wikipedia.org/wiki/Prenatal_testing&quot;&gt;prenatal testing&lt;/a&gt; for
&lt;a href=&quot;https://en.wikipedia.org/wiki/Down_syndrome&quot;&gt;Down syndrome&lt;/a&gt;,
aka. trisomy 21 (T21), parents are at the end of the screening routine
given a piece of paper containing the results of a combined test. This
consists of&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;the &lt;a href=&quot;https://en.wikipedia.org/wiki/Nuchal_scan&quot;&gt;nuchal
translucency&lt;/a&gt; (NT) measurement (in mm) of the fetus&lt;/li&gt;
&lt;li&gt;concentration of the Pregnancy-associated plasma protein A &lt;a
href=&quot;https://en.wikipedia.org/wiki/Pregnancy-associated_plasma_protein_A&quot;&gt;(PAPP-A)&lt;/a&gt;
and the human chorionic gonadotropin &lt;a
href=&quot;https://en.wikipedia.org/wiki/Human_chorionic_gonadotropin&quot;&gt;(β-HCG)&lt;/a&gt;
hormone in the serum of the mother (measured in &lt;a
href=&quot;https://en.wikipedia.org/wiki/International_unit&quot;&gt;miU&lt;/a&gt;/ml)&lt;/li&gt;
&lt;li&gt;(optional) results for other markers (e.g. ethnicity, maternal
smoking, fetal heart rate, visibility of the nasal bone on the
ultrasound)&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;From the biomarker values NT, PAPPA-A and β-HCG (and possibly
additional markers) a risk for T21 is calculated and presented as an
odds, say, 1:486. The question for the concerned soon-to-become-parents
is now, whether to proceed with further tests - for example a DNA based
approach in maternal blood plasma, a so called &lt;strong&gt;non-invasive
prenatal test&lt;/strong&gt; (NIPT) or, further down the line, an invasive &lt;a
href=&quot;https://en.wikipedia.org/wiki/Amniocentesis&quot;&gt;amniotic fluid
test&lt;/a&gt;. Recommendations for when to perform which additional screening
steps exist and are discussed with the supervising gynecologist, but at
the end its your choice as soon-to-become-parents.&lt;/p&gt;
&lt;p&gt;The aim of this blog post is to illustrate how we failed to identify
and understand the algorithm used to calculate the risk. As a
consequence, we attempt a transparent and reproducible risk calculation
algorithm based on the procedure described in &lt;span class=&quot;citation&quot;
data-cites=&quot;merz_etal2016&quot;&gt;Merz et al. (2016)&lt;/span&gt;. To enhance risk
communication we wrote an interactive Shiny app to calculate the risk,
perform sensitivity analyses and graph distributions. Even though we are
not experts on prenatal screening and have no access to any data, we
hope such tools can inspire the experts or even be helpful in the
individual decision making process associated with first trimester
screening.&lt;/p&gt;
&lt;h3 id=&quot;what-is-the-fmf-algorithm-2012&quot;&gt;What is the FMF Algorithm
2012?&lt;/h3&gt;
&lt;p&gt;The first step in a scientific approach towards the problem is to
understand, how the &lt;span class=&quot;math inline&quot;&gt;\(y\)&lt;/span&gt; in the
reported &lt;span class=&quot;math inline&quot;&gt;\(1:y\)&lt;/span&gt; odds was determined.
For this purpose the exemplary result report (in this case from a German
prenatal diagnosis facility) contained a cryptic note to a “FMF
Algorithm 2012”. Unfortunately, no further reference to any scientific
article, no link to a website with additional information nor any
separate pamphlet was provided. Nevertheless, the soon-to-be-parents are
assured that “The model for calculating the risk is based on intensive
research work coordinated by the fetal medicine foundation (registered
charity 1037116)”. Cranking the google handle we found that there exists
both an UK &lt;a href=&quot;https://fetalmedicine.org&quot;&gt;Fetal Medicine
Foundation&lt;/a&gt; (FMF), which has the stated registered charity number, as
well as a &lt;a
href=&quot;https://www.fmf-deutschland.info/en/fmf-deutschland/&quot;&gt;Fetal
Medicine Foundation Germany&lt;/a&gt;. For reasons unclear to the outsider
these two organizations use different risk algorithms: FMF-Germany uses
a so called DoE-algorithm (DoE = Degree of extremeness) documented in
the &lt;span class=&quot;citation&quot; data-cites=&quot;merz_etal2008&quot;&gt;Merz et al.
(2008)&lt;/span&gt;, &lt;span class=&quot;citation&quot; data-cites=&quot;merz_etal2011&quot;&gt;Merz et
al. (2011)&lt;/span&gt; and &lt;span class=&quot;citation&quot;
data-cites=&quot;merz_etal2016&quot;&gt;Merz et al. (2016)&lt;/span&gt; (open-access)
sequence of papers. In contrast FMF-UK uses software following “The
First Trimester Screening module 2012 algorithm”, which uses so called
MoMs (multiples of the median). What this entails we could only find in
a &lt;a
href=&quot;https://doclegend.com/queue/03-guide-for-the-first-trimester-screening-module_5a17d7fbd64ab28f8c88fe0e_pdf?queue_id=5b205c29d64ab23ffc4c2e34&quot;&gt;rogue
access software manual&lt;/a&gt;: the document contains a large body of
references sketching the different analysis components - in particular
&lt;span class=&quot;citation&quot; data-cites=&quot;kagan_etal2008a&quot;&gt;Kagan, Wright,
Baker, et al. (2008)&lt;/span&gt; and &lt;span class=&quot;citation&quot;
data-cites=&quot;kagan_etal2008b&quot;&gt;Kagan, Wright, Valencia, et al.
(2008)&lt;/span&gt; seem to cover the essentials components of the algorithm.
However, for each component (nuchal translucency, β-HCG, PAPP-A, nasal
bone, ductus venosus, heart rate, …) further references are given
without it being clear, if or how they enter the algorithm. As an
example, the FMF 2012 algorithm seems to analyze the NT measurement by a
mixture model approach described in &lt;span class=&quot;citation&quot;
data-cites=&quot;wright_etal2008&quot;&gt;Wright et al. (2008)&lt;/span&gt; so the original
approach in &lt;span class=&quot;citation&quot; data-cites=&quot;kagan_etal2008a&quot;&gt;Kagan,
Wright, Baker, et al. (2008)&lt;/span&gt; now seems obsolete. This might all
be scientifically justified, but for an outsider it is impossible to
retrace what is done: Even though we spent quite some time searching the
FMF-UK website, which provides access to many of the FMF’s 957
scientific publications and watched &lt;a
href=&quot;http://www.perkinelmer.co.uk/lab-products-and-services/maternal-fetal-health/FMF-risk-algorithm.html&quot;&gt;videos
about the algorithm&lt;/a&gt;, we could not find a more coherent document on
what the FMF 2012 algorithm exactly is. Even the FMF &lt;a
href=&quot;https://fetalmedicine.org/research/assess/trisomies&quot;&gt;on-line risk
calculator&lt;/a&gt; does not contain a specific reference and seems to
implement its own a variant of the algorithm (&lt;a
href=&quot;https://fetalmedicine.org/assets/b302e11a/js/_fmf.min.js?v=14397&quot;&gt;undocumented
javascript source code&lt;/a&gt;).&lt;/p&gt;
&lt;p&gt;At this point it is instrumental to recall paragraph V.3.3 in the &lt;a
href=&quot;https://www.rki.de/DE/Content/Kommissionen/GendiagnostikKommission/Richtlinien/RL-VorgeburtlicheRisikoabklaerung.pdf?__blob=publicationFile&quot;&gt;Commission
on Genetic Testing&lt;/a&gt;’s guideline for prenatal screening. It demands
that the algorithm for the computation of such risks to be
&lt;em&gt;comprehensible, scientifically justified and published in a peer
review process&lt;/em&gt;. In particular the guideline stresses that
&lt;em&gt;scientifically justified&lt;/em&gt; means:&lt;/p&gt;
&lt;div class=&quot;blackbox&quot;&gt;
&lt;em&gt;Demanded is publication of the entire algorithm with detailed
software specification, which precisely and comprehensible describes how
the risks are calculated.&lt;/em&gt;
&lt;/div&gt;
&lt;p&gt;
&lt;p&gt;With such a strong statement by the guideline about the
&lt;strong&gt;transparency&lt;/strong&gt; and &lt;strong&gt;reproducibility&lt;/strong&gt; of
the algorithm the above hide-and-seek seems absurd.&lt;/p&gt;
&lt;p&gt;Since we at the time of testing (wrongly?) believed that the
FMF-Germany algorithm was the one used in the lab report and its papers
appeared comprehensible enough for a re-implementation, we decided to
scrutinize the FMF-Germany algorithm further in order to understand the
computations. Aim was to understand how components influenced the
calculation, perform a sensitivity analysis and better understand the
uncertainty associated with the reported risk. The FMF Algorithm 2012
was expected to be similar in style.&lt;/p&gt;
&lt;h2 id=&quot;the-fmf-germany-procedure---prc-3.0&quot;&gt;The FMF-Germany Procedure -
PRC 3.0&lt;/h2&gt;
&lt;p&gt;The procedure described in &lt;span class=&quot;citation&quot;
data-cites=&quot;merz_etal2016&quot;&gt;Merz et al. (2016)&lt;/span&gt; entitled
&lt;strong&gt;Prenatal Risk Calculation&lt;/strong&gt; (PRC) uses a classic Bayesian
diagnostic approach, where one computes a posterior odds for the fetus
having T21 as&lt;/p&gt;
&lt;p&gt;&lt;span class=&quot;math display&quot;&gt;\[
\text{Posterior odds} = \text{Likelihood ratio} \cdot \text{Prior odds}
\]&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;In the context of T21 first trimester screening, the prior odds is
known to depend on maternal age and gestational age (at the time of
screening) of the fetus. Tables for this can be found in, e.g., Table 4
of &lt;span class=&quot;citation&quot; data-cites=&quot;snijders_etal1999&quot;&gt;Snijders et al.
(1999)&lt;/span&gt;, which is shown below in the form of odds &lt;span
class=&quot;math inline&quot;&gt;\(1:x\)&lt;/span&gt; for maternal age gaps of 5 years and
selected &lt;a
href=&quot;https://en.wikipedia.org/wiki/Gestational_age&quot;&gt;gestational
ages&lt;/a&gt; (measured in weeks). The gestational weeks relevant for the
first trimester screening are the gestational weeks 10-13. Using a
linear interpolation we obtain values for maternal and gestational age
not covered in the table - see the &lt;code&gt;trisomy21risk&lt;/code&gt; package
code for details.&lt;/p&gt;
&lt;table class=&quot;table table-striped&quot; style=&quot;margin-left: auto; margin-right: auto;&quot;&gt;
&lt;caption&gt;
Table 1: Background risk in matrix form for T21 for maternal age (in
years) and gestational age (in weeks) by Snijders et al. (1999).
&lt;/caption&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th style=&quot;text-align:right;&quot;&gt;
Maternal Age
&lt;/th&gt;
&lt;th style=&quot;text-align:right;&quot;&gt;
W10
&lt;/th&gt;
&lt;th style=&quot;text-align:right;&quot;&gt;
W12
&lt;/th&gt;
&lt;th style=&quot;text-align:right;&quot;&gt;
W14
&lt;/th&gt;
&lt;th style=&quot;text-align:right;&quot;&gt;
W16
&lt;/th&gt;
&lt;th style=&quot;text-align:right;&quot;&gt;
W20
&lt;/th&gt;
&lt;th style=&quot;text-align:right;&quot;&gt;
W40
&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
20
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
983
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
1068
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
1140
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
1200
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
1295
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
1527
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
25
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
870
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
946
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
1009
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
1062
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
1147
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
1352
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
30
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
576
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
626
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
668
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
703
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
759
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
895
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
35
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
229
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
249
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
266
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
280
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
302
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
356
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
40
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
62
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
68
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
72
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
76
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
82
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
97
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
45
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
15
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
16
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
17
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
18
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
19
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
23
&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;
&lt;p&gt;From the table we see that the background risk increases with
maternal age and decreases with gestational age. The latter is related
to the fact that a T21 fetus has an increased risk of spontaneous
abortion. One criticism of using the maternal age as background risk is
that age is merely a proxy for processes and complications not well
understood. From a certain maternal age, it is thus almost impossible to
get a test-negative result, even though most babies born by mothers that
age are healthy &lt;span class=&quot;citation&quot;
data-cites=&quot;schmidt_etal2007&quot;&gt;(Schmidt et al. 2007)&lt;/span&gt;.&lt;/p&gt;
&lt;p&gt;The above formula for the posterior odds means that we can compute
the posterior probability for T21 as &lt;span class=&quot;math display&quot;&gt;\[
\text{Posterior probability} = \left( 1 +
\frac{1}{\operatorname{LR}_{joint}} \cdot \frac{1-\text{Prior
probability}}{\text{Prior probability}} \right)^{-1}.
\]&lt;/span&gt; The complicated part of the analysis is now to determine the
joint likelihood ratio between the aneuploid pregnancies (i.e. T21
pregnancies) vs. euploid pregnancies (i.e. non-T21 pregnancies) as a
function of the three biomarkers. In some cases additional continuous or
binary markers indicating for example the smoking status, the visibility
of the nasal bone on the ultrasound or the ductus venosus blood flow
(expressed as pulsatility index) are used to distinguish further. For
sake of exposition we use the presence of a nasal bone on the ultrasound
as additional marker.&lt;/p&gt;
&lt;p&gt;In &lt;span class=&quot;citation&quot; data-cites=&quot;merz_etal2011&quot;&gt;Merz et al.
(2011)&lt;/span&gt; and &lt;span class=&quot;citation&quot; data-cites=&quot;merz_etal2016&quot;&gt;Merz
et al. (2016)&lt;/span&gt; the likelihood ratio between aneuploid and euploid
pregnancies is broken down into individual components by assuming that
the random variables describing the observed value for the four risk
factors are independent given ploidy (i.e. the T21 status):&lt;/p&gt;
&lt;p&gt;&lt;span class=&quot;math display&quot;&gt;\[
\begin{align*}
\operatorname{LR}_{joint} &amp;amp;= \frac{f_{\text{aneu}}(y_{\text{NT}},
y_{\beta\text{-HCG}}, y_{\text{PAPP-A}}, y_{\text{nasal
bone}})}{f_{\text{eu}}(y_{\text{NT}}, y_{\beta\text{-HCG}},
y_{\text{PAPP-A}}, y_{\text{nasal bone}})} \\
&amp;amp;=
\left(
  \frac{f_{\text{aneu}, \text{NT}}(y_{\text{NT}})}{f_{\text{eu},
\text{NT}}(y_{\text{NT}})}
\right)
\cdot
\left(
  \frac{f_{\text{aneu},
\beta\text{-HCG}}(y_{\beta\text{-HCG}}}{f_{\text{eu},
\beta\text{-HCG}}(y_{\beta\text{-HCG}})}
\right)
\cdot
\left(
  \frac{f_{\text{aneu}, \text{PAPP-A}}(y_{\text{PAPP-A}})}{f_{\text{eu},
\text{PAPP-A}}(y_{\text{PAPP-A}})}
\right)
  \cdot
\left(
\frac{f_{\text{aneu}, \text{nasal bone}}(y_{\text{nasal
bone}})}{f_{\text{eu}, \text{nasal bone}}(y_{\text{nasal bone}})}
\right)\\
&amp;amp;=  \operatorname{LR}_{\text{NT}} \cdot
\operatorname{LR}_{\beta\text{-HCG}} \cdot
\operatorname{LR}_{\text{PAPP-A}} \cdot \operatorname{LR}_{\text{nasal
bone}}
\end{align*}
\]&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;In the above, the &lt;span class=&quot;math inline&quot;&gt;\(f\)&lt;/span&gt;’s denote the
respective probability density functions, which may depend on covariates
such as gestational age (at the time of measuring) or the weight of the
mother. In &lt;a
href=&quot;/blog/figure/source/2018-06-14-prc/fts-appendix.html#appendix1&quot;&gt;Appendix
1&lt;/a&gt; we look in detail at how the likelihood ratio is computed for the
NT measurement. The procedure is then analogous for the β-HCG and
PAPPA-A markers - one difference is, though, that &lt;span class=&quot;citation&quot;
data-cites=&quot;merz_etal2016&quot;&gt;Merz et al. (2016)&lt;/span&gt; extends the
analysis to allow for these β-HCG and PAPPA serum markers to be
collected at a gestational age 2-3 weeks earlier than the NT
measurement, because the discrimination is better for these biochemistry
markers at this gestational age. Altogether, if the prior odds is given
in the form &lt;span class=&quot;math inline&quot;&gt;\(1:x\)&lt;/span&gt; then &lt;span
class=&quot;math inline&quot;&gt;\(\operatorname{LR}_{joint}\)&lt;/span&gt; is the factor
multiplied onto &lt;span class=&quot;math inline&quot;&gt;\(x\)&lt;/span&gt; to get the
posterior odds in the form of &lt;span class=&quot;math inline&quot;&gt;\(1:y\)&lt;/span&gt;.
That means that if &lt;span
class=&quot;math inline&quot;&gt;\(\operatorname{LR}_{joint}&amp;gt;1\)&lt;/span&gt; then the
marker values are such that the risk for T21 increases.&lt;/p&gt;
&lt;h2 id=&quot;r-implementation&quot;&gt;R Implementation&lt;/h2&gt;
&lt;p&gt;The &lt;code&gt;trisomy21&lt;/code&gt; function in the &lt;code&gt;trisomy21risk&lt;/code&gt;
package performs all the computations to take one from the prior odds,
covariates and biomarker values to the posterior odds.&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb1&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb1-1&quot;&gt;&lt;a href=&quot;#cb1-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;formalArgs&lt;/span&gt;(trisomy21risk&lt;span class=&quot;sc&quot;&gt;::&lt;/span&gt;trisomy21)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;## [1] &amp;quot;age&amp;quot;        &amp;quot;weight&amp;quot;     &amp;quot;crlbe&amp;quot;      &amp;quot;crl&amp;quot;        &amp;quot;nt&amp;quot;         &amp;quot;pappa&amp;quot;     
## [7] &amp;quot;betahCG&amp;quot;    &amp;quot;nasalbone&amp;quot;  &amp;quot;background&amp;quot;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;In the above &lt;code&gt;age&lt;/code&gt; (in years) and &lt;code&gt;weight&lt;/code&gt; (in
kg) refer to the mother, &lt;code&gt;crl&lt;/code&gt; is the &lt;a
href=&quot;https://en.wikipedia.org/wiki/Crown-rump_length&quot;&gt;crown-rump-length&lt;/a&gt;
(measured in mm) at the time of the NT measurement and
&lt;code&gt;crlbe&lt;/code&gt; is the crown-rump-length at the time of the biomarker
measurement. The &lt;code&gt;pappa&lt;/code&gt; and &lt;code&gt;betahCG&lt;/code&gt;
concentrations are both measured in miU/ml. Finally,
&lt;code&gt;background&lt;/code&gt; is the &lt;span class=&quot;math inline&quot;&gt;\(x\)&lt;/span&gt; of
the prior odds &lt;span class=&quot;math inline&quot;&gt;\(1:x\)&lt;/span&gt;. The function
outputs a named list of which one element is the posterior odds (in the
form of &lt;span class=&quot;math inline&quot;&gt;\(1:y\)&lt;/span&gt;).&lt;/p&gt;
&lt;div class=&quot;framedbox&quot;&gt;
Philosophical note: The obtained posterior odds for the risk from the
analysis is technically not really &lt;strong&gt;your individual
risk&lt;/strong&gt;, but the proportion in a population of, say, 1000
individuals with the same (measurable) covariate configuration as your
own. As Bayesians we, however, feel a certain pain towards such a
frequentist interpretation of the probability concept at the end of a
Bayesian analysis. Believing that assumptions and model choice are
subjective, we dare say that the obtained number has become &lt;strong&gt;&lt;a
href=&quot;https://t.co/iekXiiKGn1&quot;&gt;your risk&lt;/a&gt;&lt;/strong&gt; as soon as you
have to deal with the number.
&lt;/div&gt;
&lt;p&gt;
&lt;p&gt;We can now compare our results to, e.g., the 12 randomly selected
patients listed in Tab. 5 of &lt;span class=&quot;citation&quot;
data-cites=&quot;merz_etal2016&quot;&gt;Merz et al. (2016)&lt;/span&gt;. Note that the
first patient has a posterior odds of 1:486, which we used as example
patient in the introduction. Results are compared in two ways:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;using the background risk as specified in the
&lt;code&gt;Background&lt;/code&gt; column by the paper and comparing our result
(Column: &lt;code&gt;our_Post&lt;/code&gt;) to the &lt;span
class=&quot;math inline&quot;&gt;\(y\)&lt;/span&gt; of the posterior odds stated in the
paper (Column: &lt;code&gt;Post&lt;/code&gt;).&lt;/li&gt;
&lt;li&gt;Manually calculate the background risk using maternal age and
gestational age by interpolation of the Snijders table (Column:
&lt;code&gt;our_Background&lt;/code&gt;) and compare our result (Column:
&lt;code&gt;our_Post_Back&lt;/code&gt;) with the result of the paper (Column:
&lt;code&gt;Post&lt;/code&gt;).&lt;/li&gt;
&lt;/ul&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb3&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb3-1&quot;&gt;&lt;a href=&quot;#cb3-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##Load numbers from Tab. 5 of the paper (contains 12 patients)&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb3-2&quot;&gt;&lt;a href=&quot;#cb3-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;tab5 &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;read.csv2&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;file.path&lt;/span&gt;(filePath,&lt;span class=&quot;st&quot;&gt;&amp;quot;merzetal2015-tab5.csv&amp;quot;&lt;/span&gt;))&lt;/span&gt;
&lt;span id=&quot;cb3-3&quot;&gt;&lt;a href=&quot;#cb3-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb3-4&quot;&gt;&lt;a href=&quot;#cb3-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##Compute our own results for each patient&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb3-5&quot;&gt;&lt;a href=&quot;#cb3-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;tab5 &lt;span class=&quot;sc&quot;&gt;%&amp;lt;&amp;gt;%&lt;/span&gt; rowwise &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;do&lt;/span&gt;({&lt;/span&gt;
&lt;span id=&quot;cb3-6&quot;&gt;&lt;a href=&quot;#cb3-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;do&quot;&gt;##Arguments for the call to the trisomy21 function&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb3-7&quot;&gt;&lt;a href=&quot;#cb3-7&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  args &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;list&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;age=&lt;/span&gt;.&lt;span class=&quot;sc&quot;&gt;$&lt;/span&gt;Age, &lt;span class=&quot;at&quot;&gt;weight=&lt;/span&gt;.&lt;span class=&quot;sc&quot;&gt;$&lt;/span&gt;Weight, &lt;span class=&quot;at&quot;&gt;crlbe=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;gestage2crl&lt;/span&gt;(.&lt;span class=&quot;sc&quot;&gt;$&lt;/span&gt;CRLBE), &lt;span class=&quot;at&quot;&gt;crl=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;gestage2crl&lt;/span&gt;(.&lt;span class=&quot;sc&quot;&gt;$&lt;/span&gt;CRL), &lt;span class=&quot;at&quot;&gt;nt=&lt;/span&gt;.&lt;span class=&quot;sc&quot;&gt;$&lt;/span&gt;NT, &lt;span class=&quot;at&quot;&gt;pappa=&lt;/span&gt;.&lt;span class=&quot;sc&quot;&gt;$&lt;/span&gt;PAPP_A, &lt;span class=&quot;at&quot;&gt;betahCG=&lt;/span&gt;.&lt;span class=&quot;sc&quot;&gt;$&lt;/span&gt;beta_hCG, &lt;span class=&quot;at&quot;&gt;nasalbone=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;Unknown&amp;quot;&lt;/span&gt;, &lt;span class=&quot;at&quot;&gt;background=&lt;/span&gt;.&lt;span class=&quot;sc&quot;&gt;$&lt;/span&gt;Background)&lt;/span&gt;
&lt;span id=&quot;cb3-8&quot;&gt;&lt;a href=&quot;#cb3-8&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb3-9&quot;&gt;&lt;a href=&quot;#cb3-9&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;do&quot;&gt;##Manually compute the prior odds&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb3-10&quot;&gt;&lt;a href=&quot;#cb3-10&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  our_Background &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;background_risk&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;age_mother=&lt;/span&gt;.&lt;span class=&quot;sc&quot;&gt;$&lt;/span&gt;Age, &lt;span class=&quot;at&quot;&gt;gestage=&lt;/span&gt;.&lt;span class=&quot;sc&quot;&gt;$&lt;/span&gt;CRL&lt;span class=&quot;sc&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;7&lt;/span&gt;)&lt;/span&gt;
&lt;span id=&quot;cb3-11&quot;&gt;&lt;a href=&quot;#cb3-11&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb3-12&quot;&gt;&lt;a href=&quot;#cb3-12&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;do&quot;&gt;##Call the trisomy function with the two type of background odds&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb3-13&quot;&gt;&lt;a href=&quot;#cb3-13&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  post &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;do.call&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;quot;trisomy21&amp;quot;&lt;/span&gt;,&lt;span class=&quot;at&quot;&gt;args=&lt;/span&gt;args)&lt;/span&gt;
&lt;span id=&quot;cb3-14&quot;&gt;&lt;a href=&quot;#cb3-14&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  post_back &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;do.call&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;quot;trisomy21&amp;quot;&lt;/span&gt;,&lt;span class=&quot;at&quot;&gt;args=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;modifyList&lt;/span&gt;(args, &lt;span class=&quot;fu&quot;&gt;list&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;background=&lt;/span&gt;our_Background)))&lt;/span&gt;
&lt;span id=&quot;cb3-15&quot;&gt;&lt;a href=&quot;#cb3-15&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb3-16&quot;&gt;&lt;a href=&quot;#cb3-16&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;do&quot;&gt;##Return result&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb3-17&quot;&gt;&lt;a href=&quot;#cb3-17&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;data.frame&lt;/span&gt;(., &lt;span class=&quot;at&quot;&gt;our_Post =&lt;/span&gt; post&lt;span class=&quot;sc&quot;&gt;$&lt;/span&gt;onetox, &lt;span class=&quot;at&quot;&gt;our_Background=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;round&lt;/span&gt;(our_Background,&lt;span class=&quot;at&quot;&gt;digits=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;0&lt;/span&gt;), &lt;span class=&quot;at&quot;&gt;our_Post_Back=&lt;/span&gt;post_back&lt;span class=&quot;sc&quot;&gt;$&lt;/span&gt;onetox)&lt;/span&gt;
&lt;span id=&quot;cb3-18&quot;&gt;&lt;a href=&quot;#cb3-18&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;})&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;table class=&quot;table table-striped&quot; style=&quot;font-size: 14px; margin-left: auto; margin-right: auto;&quot;&gt;
&lt;caption style=&quot;font-size: initial !important;&quot;&gt;
Table 2: Table 5 in Merz et al. (2016) annotated with our manually
computed results. Note: The gestational ages (CRL and CRLBE) are now
suddenly measured in gestation week and not mm.
&lt;/caption&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th style=&quot;text-align:right;&quot;&gt;
Age
&lt;/th&gt;
&lt;th style=&quot;text-align:right;&quot;&gt;
Weight
&lt;/th&gt;
&lt;th style=&quot;text-align:right;&quot;&gt;
CRLBE
&lt;/th&gt;
&lt;th style=&quot;text-align:right;&quot;&gt;
CRL
&lt;/th&gt;
&lt;th style=&quot;text-align:right;&quot;&gt;
NT
&lt;/th&gt;
&lt;th style=&quot;text-align:right;&quot;&gt;
PAPP_A
&lt;/th&gt;
&lt;th style=&quot;text-align:right;&quot;&gt;
beta_hCG
&lt;/th&gt;
&lt;th style=&quot;text-align:right;&quot;&gt;
Background
&lt;/th&gt;
&lt;th style=&quot;text-align:right;&quot;&gt;
Post
&lt;/th&gt;
&lt;th style=&quot;text-align:right;&quot;&gt;
our_Post
&lt;/th&gt;
&lt;th style=&quot;text-align:right;&quot;&gt;
our_Background
&lt;/th&gt;
&lt;th style=&quot;text-align:right;&quot;&gt;
our_Post_Back
&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
37
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
74.5
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
58
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
86
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
2.3
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
0.330
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
52.5
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
145
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
486
&lt;/td&gt;
&lt;td style=&quot;text-align:right;background-color: lightblue;&quot;&gt;
494
&lt;/td&gt;
&lt;td style=&quot;text-align:right;background-color: lightblue;&quot;&gt;
140
&lt;/td&gt;
&lt;td style=&quot;text-align:right;background-color: lightblue;&quot;&gt;
477
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
33
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
65.1
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
58
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
86
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
2.0
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
0.526
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
124.7
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
349
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
1022
&lt;/td&gt;
&lt;td style=&quot;text-align:right;background-color: lightblue;&quot;&gt;
1043
&lt;/td&gt;
&lt;td style=&quot;text-align:right;background-color: lightblue;&quot;&gt;
352
&lt;/td&gt;
&lt;td style=&quot;text-align:right;background-color: lightblue;&quot;&gt;
1052
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
27
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
48.6
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
59
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
88
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
1.2
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
0.210
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
71.6
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
876
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
2901
&lt;/td&gt;
&lt;td style=&quot;text-align:right;background-color: lightblue;&quot;&gt;
3412
&lt;/td&gt;
&lt;td style=&quot;text-align:right;background-color: lightblue;&quot;&gt;
752
&lt;/td&gt;
&lt;td style=&quot;text-align:right;background-color: lightblue;&quot;&gt;
2931
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
23
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
65.4
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
58
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
88
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
1.9
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
0.725
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
96.0
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
1021
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
13238
&lt;/td&gt;
&lt;td style=&quot;text-align:right;background-color: lightblue;&quot;&gt;
13583
&lt;/td&gt;
&lt;td style=&quot;text-align:right;background-color: lightblue;&quot;&gt;
915
&lt;/td&gt;
&lt;td style=&quot;text-align:right;background-color: lightblue;&quot;&gt;
12175
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
42
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
72.8
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
59
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
89
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
2.0
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
0.359
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
77.0
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
45
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
176
&lt;/td&gt;
&lt;td style=&quot;text-align:right;background-color: lightblue;&quot;&gt;
208
&lt;/td&gt;
&lt;td style=&quot;text-align:right;background-color: lightblue;&quot;&gt;
35
&lt;/td&gt;
&lt;td style=&quot;text-align:right;background-color: lightblue;&quot;&gt;
162
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
37
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
69.0
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
58
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
89
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
1.8
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
0.241
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
47.2
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
147
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
1355
&lt;/td&gt;
&lt;td style=&quot;text-align:right;background-color: lightblue;&quot;&gt;
1526
&lt;/td&gt;
&lt;td style=&quot;text-align:right;background-color: lightblue;&quot;&gt;
140
&lt;/td&gt;
&lt;td style=&quot;text-align:right;background-color: lightblue;&quot;&gt;
1453
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
36
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
84.4
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
58
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
90
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
2.0
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
0.290
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
51.9
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
225
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
2198
&lt;/td&gt;
&lt;td style=&quot;text-align:right;background-color: lightblue;&quot;&gt;
2332
&lt;/td&gt;
&lt;td style=&quot;text-align:right;background-color: lightblue;&quot;&gt;
180
&lt;/td&gt;
&lt;td style=&quot;text-align:right;background-color: lightblue;&quot;&gt;
1865
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
41
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
61.6
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
55
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
90
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
1.7
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
0.219
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
84.6
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
55
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
264
&lt;/td&gt;
&lt;td style=&quot;text-align:right;background-color: lightblue;&quot;&gt;
285
&lt;/td&gt;
&lt;td style=&quot;text-align:right;background-color: lightblue;&quot;&gt;
47
&lt;/td&gt;
&lt;td style=&quot;text-align:right;background-color: lightblue;&quot;&gt;
243
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
30
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
57.6
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
59
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
91
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
1.6
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
0.349
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
75.3
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
677
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
6329
&lt;/td&gt;
&lt;td style=&quot;text-align:right;background-color: lightblue;&quot;&gt;
6990
&lt;/td&gt;
&lt;td style=&quot;text-align:right;background-color: lightblue;&quot;&gt;
576
&lt;/td&gt;
&lt;td style=&quot;text-align:right;background-color: lightblue;&quot;&gt;
5947
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
26
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
64.7
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
59
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
92
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
1.6
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
0.230
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
73.9
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
945
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
3983
&lt;/td&gt;
&lt;td style=&quot;text-align:right;background-color: lightblue;&quot;&gt;
4506
&lt;/td&gt;
&lt;td style=&quot;text-align:right;background-color: lightblue;&quot;&gt;
811
&lt;/td&gt;
&lt;td style=&quot;text-align:right;background-color: lightblue;&quot;&gt;
3868
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
35
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
74.3
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
59
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
92
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
1.5
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
0.399
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
69.6
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
233
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
5072
&lt;/td&gt;
&lt;td style=&quot;text-align:right;background-color: lightblue;&quot;&gt;
5691
&lt;/td&gt;
&lt;td style=&quot;text-align:right;background-color: lightblue;&quot;&gt;
229
&lt;/td&gt;
&lt;td style=&quot;text-align:right;background-color: lightblue;&quot;&gt;
5593
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
34
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
51.6
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
58
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
93
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
2.1
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
0.563
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
142.4
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
338
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
902
&lt;/td&gt;
&lt;td style=&quot;text-align:right;background-color: lightblue;&quot;&gt;
966
&lt;/td&gt;
&lt;td style=&quot;text-align:right;background-color: lightblue;&quot;&gt;
287
&lt;/td&gt;
&lt;td style=&quot;text-align:right;background-color: lightblue;&quot;&gt;
821
&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;
&lt;p&gt;Altogether, we observe that the results do not fully agree, but are
in most cases of the same magnitude. Even when using the same prior odds
there are still differences, which can be explained by the use of
different polynomial &lt;span class=&quot;math inline&quot;&gt;\(\hat{y}(x)\)&lt;/span&gt;
forms for NT, PAPP-A and β-HCG, because of problems reproducing the
results with the polynomials stated in &lt;span class=&quot;citation&quot;
data-cites=&quot;merz_etal2016&quot;&gt;Merz et al. (2016)&lt;/span&gt; - see &lt;a
href=&quot;/blog/figure/source/2018-06-14-prc/fts-appendix.html#appendix2&quot;&gt;Appendix
2&lt;/a&gt;. Furthermore, the interpolation of the background risks from the
Snijders table (Column: &lt;code&gt;our_Background&lt;/code&gt;) deviates:
Apparently, a different interpolation procedure is used by &lt;span
class=&quot;citation&quot; data-cites=&quot;merz_etal2016&quot;&gt;Merz et al. (2016)&lt;/span&gt; -
we could not find an explicit mentioning of how this part is done.&lt;/p&gt;
&lt;h2 id=&quot;shiny-app&quot;&gt;Shiny App&lt;/h2&gt;
&lt;p&gt;For better illustration we have written a small Shiny app in order to
get a better feeling of what the algorithm does, for example, by
performing a sensitivity analysis where one changes one measurement
value slightly. The App is available from:&lt;/p&gt;
&lt;center&gt;
&lt;a
href=&quot;https://hoehle.shinyapps.io/t21app/&quot;&gt;https://hoehle.shinyapps.io/t21app/&lt;/a&gt;
&lt;/center&gt;
&lt;p&gt;
&lt;p&gt;and can also be ran locally, by installing the &lt;a
href=&quot;https://github.com/hoehleatsu/trisomy21risk&quot;&gt;&lt;code&gt;trisomy21risk&lt;/code&gt;&lt;/a&gt;
package from github:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb4&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb4-1&quot;&gt;&lt;a href=&quot;#cb4-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;devtools&lt;span class=&quot;sc&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;install_github&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;quot;hoehleatsu/trisomy21risk&amp;quot;&lt;/span&gt;)&lt;/span&gt;
&lt;span id=&quot;cb4-2&quot;&gt;&lt;a href=&quot;#cb4-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;trisomy21risk&lt;span class=&quot;sc&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;runExample&lt;/span&gt;()&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h4 id=&quot;screenshots&quot;&gt;Screenshots&lt;/h4&gt;
Computing the T21 risk:
&lt;center&gt;
&lt;img src=&quot;/blog/figure/source/2018-06-14-prc/shinyapp.png&quot; alt=&quot;Second screenshot from the Shiny App&quot;  width=&quot;85%&quot;&gt;
&lt;/center&gt;
&lt;p&gt;As example: the NT measurement in the ultrasound image is subject to
some measurement error - even the most skilled operator has difficulties
obtaining errors smaller than 0.2 - 0.3 mm. With the app we can easily
investigate how such measurement error influences the calculated risk.
Another aspect to investigate is the influence of the background risk
from maternal age.&lt;/p&gt;
Visualizing the likelihood ratios:
&lt;center&gt;
&lt;img src=&quot;/blog/figure/source/2018-06-14-prc/shinyapp2.png&quot; alt=&quot;Second screenshot from the Shiny App&quot;  width=&quot;85%&quot;&gt;
&lt;/center&gt;
&lt;h2 id=&quot;discussion&quot;&gt;Discussion&lt;/h2&gt;
&lt;p&gt;With a cut-off of value of 1:150 for the posterior odds, &lt;span
class=&quot;citation&quot; data-cites=&quot;merz_etal2016&quot;&gt;Merz et al. (2016)&lt;/span&gt;
report a detection rate for T21 of 86.8% and a false positive rate of
3.42%. The 1:150 is also the threshold they suggest for further invasive
action. For posterior odds up to 1:500 the suggestion in &lt;span
class=&quot;citation&quot; data-cites=&quot;merz_etal2011&quot;&gt;Merz et al. (2011)&lt;/span&gt; is
to perform additional sonographic investigations in the second
trimester. Nowadays, one would typically perform a NIPT.&lt;/p&gt;
&lt;p&gt;Was the algorithm for the computation of the risk detailed and
comprehensive as demanded by the Commission on Genetic Testing? Well,
since we -despite quite some effort- were not able to find a full
description of the FMF 2012 algorithm and, as described in &lt;a
href=&quot;/blog/figure/source/2018-06-14-prc/fts-appendix.html#appendix2&quot;&gt;Appendix
2&lt;/a&gt;, were not able to reproduce the numbers in &lt;span class=&quot;citation&quot;
data-cites=&quot;merz_etal2016&quot;&gt;Merz et al. (2016)&lt;/span&gt;, we say: no. As
algorithms become more complex and -as for the FMF 2012 algorithm-
contain the combined insights of 10+ scientific papers, transparency
starts with a single easy-to-find accessible document coarsely
describing the overall algorithm. The FMF software manual, which
apparently is not accessible to the public, would have been a start.
Even better would be an open-source reference implementation! To this
date it remained unclear how the standard NT, PAPP-A and β-HCG
measurements entered the analysis and if additional components
(ethnicity? smoking status? nasal bone? heart rate? ductus flow?)
entered the risk calculation. Similarly, publishing a statistical
description of the FMF-Germany algorithm in open-access articles,
e.g. such as &lt;span class=&quot;citation&quot; data-cites=&quot;merz_etal2016&quot;&gt;Merz et
al. (2016)&lt;/span&gt;, is a step in the right direction, however, some of
the equations in the paper were either erroneous or intentionally kept
so vague, the algorithm became impossible to reconstruct. Altogether,
transparency and risk communication for this sensitive diagnostic
procedure should be improved to meet guideline standards.&lt;/p&gt;
&lt;p&gt;What do you do with the obtained posterior risk once you have it?
This is indeed a very personal decision, which make the shortcomings of
statistics clear: Statisticians can annotate even the most unlikely
event with a probability of happening, but the probability is rarely
zero, so it’s your personal threshold for &lt;em&gt;likely enough&lt;/em&gt;
balanced against the ethics and personal beliefs of what to do if, which
determines your actions… In this &lt;span
class=&quot;math inline&quot;&gt;\(n=1\)&lt;/span&gt; context the reported risk might
merely be a hypothetical number - at most its rough magnitude is of
interest. However, from a system perspective &lt;span
class=&quot;math inline&quot;&gt;\(n\)&lt;/span&gt; is much larger, so everything possible
should be done such that the probabilistic forecast is both calibrated
and sharp and that the recipient(s) knows what this number entails.&lt;/p&gt;
&lt;h4 id=&quot;postscript&quot;&gt;Postscript&lt;/h4&gt;
&lt;p&gt;Further information about first trimester screening can be obtained
from the &lt;a href=&quot;https://fetalmedicine.org/&quot;&gt;Fetal Medicine
Foundation&lt;/a&gt;. In particular their &lt;a
href=&quot;http://www.fetalmedicine.com/fmf/FMF-English.pdf&quot;&gt;book&lt;/a&gt; about
the 11-13 weeks scan (available in several languages) is very helpful
&lt;span class=&quot;citation&quot; data-cites=&quot;FMF2004&quot;&gt;(Nicolaides 2004)&lt;/span&gt;. As
mentioned the FMF-UK offers a web-based &lt;a
href=&quot;https://fetalmedicine.org/research/assess/trisomies&quot;&gt;trisomies
risk assessment calculator&lt;/a&gt;. Similarly, the &lt;a
href=&quot;https://www.fmf-deutschland.info/en/fmf-deutschland/&quot;&gt;FMF-Germany&lt;/a&gt;
has their own website with information - apparently it is now also
possible to obtain a demo version of their risk calculation software &lt;a
href=&quot;https://www.fmf-deutschland.info/en/software/&quot;&gt;PRC 3.0&lt;/a&gt;.&lt;/p&gt;
&lt;h2 id=&quot;update-2018-07-24&quot;&gt;Update 2018-07-24&lt;/h2&gt;
&lt;p&gt;Directly after publishing the post I contacted the German &lt;a
href=&quot;https://www.rki.de/EN/Content/Institute/Committees/GEKO/GEKO_content.html&quot;&gt;Commission
on Genetic Testing (GEKO)&lt;/a&gt; to make them aware of the post and my
troubles to determine what the algorithm actually does, what information
enters and the lack of will of the FMF-Germany authors to communicate
certain details of the algorithm. As a consequence, I asked which steps
the commission performs to ensure and track the realisation of the
guideline’s demands for “&lt;em&gt;publication of the entire algorithm with
detailed software specification&lt;/em&gt;”. In their email reply from
2018-07-16 they answer&lt;a href=&quot;#fn1&quot; class=&quot;footnote-ref&quot; id=&quot;fnref1&quot;
role=&quot;doc-noteref&quot;&gt;&lt;sup&gt;1&lt;/sup&gt;&lt;/a&gt;: “&lt;em&gt;… The area of responsibility
of the GEKO is clearly regulated by legal requirements. The
implementation of the Gene Diagnostic Act (GenDG) or the examination of
the guideline’s requirements are not tasks of the GEKO. The
interpretation of the regulatory content of the Gene Diagnostic Act as
well as the enforcement of the requirements of the GEKO guidelines are
dealt with by the appropriate authorities of the Länder.&lt;/em&gt;” As a
consequence of this, their recommendation was to address my question to
the equivalent of the Ministry of Health in my federal state (Berlin). I
did this on 2018-07-16 (awaiting reply), but would be surprised, if the
Federal State of Berlin has the resources and expertise to look into
software transparency of national and internationally operating software
vendors in this field. I doubt this is different for any of the 15 other
federal states in Germany. I might be wrong and in for a surprise, but
as a citizen and scientist it seems like the guideline’s demand for a
detailed software specification in order to make it transparent and
reproducible how the 1:x is calculated is nothing else than wishful
thinking…&lt;/p&gt;
&lt;h2 id=&quot;update-2019-03-29&quot;&gt;Update 2019-03-29&lt;/h2&gt;
&lt;p&gt;After several inquiries about what is done to ensure the algorithmic
transparency of the prenatal diagnostic procedures remained unanswered
by Berlin’s &lt;a
href=&quot;https://www.berlin.de/sen/gpg/&quot;&gt;&lt;em&gt;Senatsverwaltung für
Gesundheit, Pflege und Gleichstellung&lt;/em&gt;&lt;/a&gt;, I decided to formulate a
&lt;a
href=&quot;http://gesetze.berlin.de/jportal/?quelle=jlink&amp;amp;query=InfFrG+BE&amp;amp;psml=bsbeprod.psml&amp;amp;max=true&amp;amp;aiz=true&quot;&gt;freedom
of information act&lt;/a&gt; request, which ensures that the public authority
has to answer, typically within ~4 weeks. A very good interface to
formulate such requests in Germany is &lt;a
href=&quot;https://fragdenstaat.de&quot;&gt;fragdenstaat.de&lt;/a&gt;. The &lt;a
href=&quot;https://fragdenstaat.de/anfrage/vorgeburtliche-risikoabklarung/&quot;&gt;subsequent
answer&lt;/a&gt; (in German) shows that no measures are performed in Berlin to
ensure the requested algorithmic transparency. My conclusion: The
current setup of a) recommendations being in the hand of the GEKO while
b) compliance assurance being in the hand of 16 federal states results
in the software providers not being under any pressure to provide
algorithmic transparency. This is rather frustrating for an ethical
sensitive issue such as prenatal screening.&lt;/p&gt;
&lt;h2 id=&quot;appendix&quot;&gt;Appendix&lt;/h2&gt;
&lt;p&gt;The mathematical details of the post and our troubles reproducing the
results of &lt;span class=&quot;citation&quot; data-cites=&quot;merz_etal2016&quot;&gt;Merz et al.
(2016)&lt;/span&gt; are described in two separate &lt;a
href=&quot;/blog/figure/source/2018-06-14-prc/fts-appendix.html&quot;&gt;Appendixes&lt;/a&gt;,&lt;/p&gt;
&lt;h2 class=&quot;unnumbered&quot; id=&quot;literature&quot;&gt;Literature&lt;/h2&gt;
&lt;div id=&quot;refs&quot; class=&quot;references csl-bib-body hanging-indent&quot;
data-entry-spacing=&quot;0&quot; role=&quot;list&quot;&gt;
&lt;div id=&quot;ref-kagan_etal2008a&quot; class=&quot;csl-entry&quot; role=&quot;listitem&quot;&gt;
Kagan, K. O., D. Wright, A. Baker, D. Sahota, and K. H. Nicolaides.
2008. &lt;span&gt;“&lt;span class=&quot;nocase&quot;&gt;&lt;span&gt;S&lt;/span&gt;creening for trisomy 21
by maternal age, fetal nuchal translucency thickness, free beta-human
chorionic gonadotropin and pregnancy-associated plasma
protein-&lt;span&gt;A&lt;/span&gt;&lt;/span&gt;.”&lt;/span&gt; &lt;em&gt;Ultrasound Obstet
Gynecol&lt;/em&gt; 31 (6): 618–24.
&lt;/div&gt;
&lt;div id=&quot;ref-kagan_etal2008b&quot; class=&quot;csl-entry&quot; role=&quot;listitem&quot;&gt;
Kagan, K. O., D. Wright, C. Valencia, N. Maiz, and K. H. Nicolaides.
2008. &lt;span&gt;“&lt;span class=&quot;nocase&quot;&gt;&lt;span&gt;S&lt;/span&gt;creening for trisomies
21, 18 and 13 by maternal age, fetal nuchal translucency, fetal heart
rate, free beta-h&lt;span&gt;C&lt;/span&gt;&lt;span&gt;G&lt;/span&gt; and pregnancy-associated
plasma protein-&lt;span&gt;A&lt;/span&gt;&lt;/span&gt;.”&lt;/span&gt; &lt;em&gt;Hum. Reprod.&lt;/em&gt; 23
(9): 1968–75.
&lt;/div&gt;
&lt;div id=&quot;ref-merz_etal2008&quot; class=&quot;csl-entry&quot; role=&quot;listitem&quot;&gt;
Merz, E., C. Thode, A. Alkier, B. J. Hackelöer, M. Hansmann, G. Huesgen,
P. Kozlowski, M. Pruggmaier, and S. Wellek. 2008. &lt;span&gt;“A New Approach
to Calculating the Risk of Chromoso- Mal Abnormalities with
First-Trimester Screening Data.”&lt;/span&gt; &lt;em&gt;Ultraschall in Der Medizin /
European Journal of Ultrasound&lt;/em&gt; 29: 639–45. &lt;a
href=&quot;https://doi.org/10.1055/s-2008-1027958&quot;&gt;https://doi.org/10.1055/s-2008-1027958&lt;/a&gt;.
&lt;/div&gt;
&lt;div id=&quot;ref-merz_etal2011&quot; class=&quot;csl-entry&quot; role=&quot;listitem&quot;&gt;
Merz, E., C. Thode, B. Eiben, R. Faber, B. J. Hackelöer, G. Huesgen, M.
Pruggmaier, and S. Wellek. 2011. &lt;span&gt;“Individualized Correction for
Maternal Weight in Calculating the Risk of Chromosomal Abnormalities
with First-Trimester Screening Data.”&lt;/span&gt; &lt;em&gt;Ultraschall in Der
Medizin/European Journal of Ultrasound&lt;/em&gt; 32: 33–39.
https://doi.org/&lt;a
href=&quot;http://dx.doi.org/10.1055/&quot;&gt;http://dx.doi.org/10.1055/&lt;/a&gt;.
&lt;/div&gt;
&lt;div id=&quot;ref-merz_etal2016&quot; class=&quot;csl-entry&quot; role=&quot;listitem&quot;&gt;
Merz, E., C. Thode, B. Eiben, and S. Wellek. 2016. &lt;span&gt;“Prenatal Risk
Calculation (&lt;span&gt;PRC&lt;/span&gt;) 3.0: An Extended DoE-Based
First-Trimester Screening Algorithm Allowing for Early Blood
Sampling.”&lt;/span&gt; &lt;em&gt;Ultrasound International Open&lt;/em&gt; 2: E19–26. &lt;a
href=&quot;https://doi.org/10.1055/s-0035-1569403&quot;&gt;https://doi.org/10.1055/s-0035-1569403&lt;/a&gt;.
&lt;/div&gt;
&lt;div id=&quot;ref-FMF2004&quot; class=&quot;csl-entry&quot; role=&quot;listitem&quot;&gt;
Nicolaides, K. H. 2004. &lt;em&gt;The 11–13&lt;span
class=&quot;math inline&quot;&gt;\(^{+6}\)&lt;/span&gt; Weeks Scan&lt;/em&gt;. Fetal Medicine
Foundation,. &lt;a
href=&quot;https://fetalmedicine.com/synced/fmf/FMF-English.pdf&quot;&gt;https://fetalmedicine.com/synced/fmf/FMF-English.pdf&lt;/a&gt;.
&lt;/div&gt;
&lt;div id=&quot;ref-schmidt_etal2007&quot; class=&quot;csl-entry&quot; role=&quot;listitem&quot;&gt;
Schmidt, P., J. Rom, H. Maul, B. Vaske, P. Hillemanns, and A. Scharf.
2007. &lt;span&gt;“&lt;span class=&quot;nocase&quot;&gt;&lt;span&gt;A&lt;/span&gt;dvanced first trimester
screening (&lt;span&gt;A&lt;/span&gt;&lt;span&gt;F&lt;/span&gt;&lt;span&gt;S&lt;/span&gt;): an improved test
strategy for the individual risk assessment of fetal aneuploidies and
malformations&lt;/span&gt;.”&lt;/span&gt; &lt;em&gt;Arch. Gynecol. Obstet.&lt;/em&gt; 276 (2):
159–66.
&lt;/div&gt;
&lt;div id=&quot;ref-snijders_etal1999&quot; class=&quot;csl-entry&quot; role=&quot;listitem&quot;&gt;
Snijders, R. J., K. Sundberg, W. Holzgreve, G. Henry, and K. H.
Nicolaides. 1999. &lt;span&gt;“&lt;span class=&quot;nocase&quot;&gt;&lt;span&gt;M&lt;/span&gt;aternal age-
and gestation-specific risk for trisomy 21&lt;/span&gt;.”&lt;/span&gt;
&lt;em&gt;Ultrasound Obstet Gynecol&lt;/em&gt; 13 (3): 167–70.
&lt;/div&gt;
&lt;div id=&quot;ref-wright_etal2008&quot; class=&quot;csl-entry&quot; role=&quot;listitem&quot;&gt;
Wright, D., K. O. Kagan, F. S. Molina, A. Gazzoni, and K. H. Nicolaides.
2008. &lt;span&gt;“&lt;span class=&quot;nocase&quot;&gt;&lt;span&gt;A&lt;/span&gt; mixture model of nuchal
translucency thickness in screening for chromosomal
defects&lt;/span&gt;.”&lt;/span&gt; &lt;em&gt;Ultrasound Obstet Gynecol&lt;/em&gt; 31 (4):
376–83.
&lt;/div&gt;
&lt;/div&gt;
&lt;section id=&quot;footnotes&quot; class=&quot;footnotes footnotes-end-of-document&quot;
role=&quot;doc-endnotes&quot;&gt;
&lt;hr /&gt;
&lt;ol&gt;
&lt;li id=&quot;fn1&quot;&gt;&lt;p&gt;My email and their answer was in German - the quoted
part of the answer is translated to English by me.&lt;a href=&quot;#fnref1&quot;
class=&quot;footnote-back&quot; role=&quot;doc-backlink&quot;&gt;↩︎&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;/section&gt;
</description>
        <pubDate>Thu, 14 Jun 2018 00:00:00 +0200</pubDate>
        <link>https://mhoehle.github.io/blog/2018/06/14/prc.html</link>
        <guid isPermaLink="true">https://mhoehle.github.io/blog/2018/06/14/prc.html</guid>
        
        <category>rstats</category>
        
        <category>stats</category>
        
        <category>diagnostic test</category>
        
        <category>Bayesian inference</category>
        
        
      </item>
    
      <item>
        <title>Safe Disposal of Unexploded WWII Bombs</title>
        <description>&lt;h2 id=&quot;abstract&quot;&gt;Abstract&lt;/h2&gt;
&lt;p&gt;Unexploded WWII bombs are ticking threats despite being dropped more
than 70 years ago. In this post we explain how statistical methods are
used to plan the search and disposal of unexploded WWII bombs. In
particular we consider and exemplify the non-parametric nearest
neighbour distance (NND) method implemented in the R package
&lt;code&gt;highriskzone&lt;/code&gt;. The method analyses the spatial pattern of
exploded bombs to determine so called risk-zones, that is regions with a
high likelihood of containing unexploded bombs. The coverage of such
risk-zones is investigated through both non-parametric and parametric
point process simulation.&lt;/p&gt;
&lt;center&gt;
&lt;img
src=&quot;https://ncap.org.uk/sites/default/files/frames/download/000/000/022/NCAP-000-000-022-423.jpg&quot; /&gt;
&lt;/center&gt;
&lt;p&gt;&lt;FONT
COLOR=&quot;bbbbbb&quot;&gt;&lt;a
href=&quot;http://ncap.org.uk/NCAP-000-000-022-423&quot;&gt;NCAP&lt;/a&gt; aerial photo
from 1944 showing the bombing of the V2 rocket facility at Peenemünde,
Germany. Image is available under a custom NCAP license - higher
resolution images are available from NCAP. &lt;/FONT&gt;&lt;/p&gt;
&lt;p&gt;&lt;br&gt;
&lt;a rel=&quot;license&quot; href=&quot;http://creativecommons.org/licenses/by-sa/4.0/&quot;&gt;&lt;img alt=&quot;Creative Commons License&quot; style=&quot;border-width:0&quot; src=&quot;https://i.creativecommons.org/l/by-sa/4.0/88x31.png&quot;/&gt;&lt;/a&gt;
This work is licensed under a &lt;a rel=&quot;license&quot;
href=&quot;http://creativecommons.org/licenses/by-sa/4.0/&quot;&gt;Creative Commons
Attribution-ShareAlike 4.0 International License&lt;/a&gt;. The
markdown+Rknitr source code of this blog is available under a &lt;a
href=&quot;https://www.gnu.org/licenses/gpl-3.0.html&quot;&gt;GNU General Public
License (GPL v3)&lt;/a&gt; license from github.&lt;/p&gt;
&lt;p&gt;&lt;span class=&quot;math display&quot;&gt;\[
\newcommand{\bm}[1]{\boldsymbol{\mathbf{#1}}}
\]&lt;/span&gt;&lt;/p&gt;
&lt;h2 id=&quot;introduction&quot;&gt;Introduction&lt;/h2&gt;
&lt;p&gt;During WWII Germany was pounded with about &lt;a
href=&quot;https://www.smithsonianmag.com/history/seventy-years-world-war-two-thousands-tons-unexploded-bombs-germany-180957680/&quot;&gt;1.5
mio tons of bombs&lt;/a&gt; of which about 10-15% did not explode. More than
70 years after the end of WWII these unexploded bombs (UXBs) still pose
a threat and are the frequent cause of large scale evacuations to secure
their &lt;a
href=&quot;https://ncap.org.uk/case-studies/explosive-ordnance-disposal&quot;&gt;safe
disposal&lt;/a&gt; when found. Luckily, lethal incidents are rare thanks to a
huge effort to &lt;a
href=&quot;https://www.youtube.com/watch?v=wrIDT26BAt0&quot;&gt;localise and safely
dismantle&lt;/a&gt; UXBs. As part of this effort, aerial photos taken by the
allies after the attacks provide valuable information about the possible
locations of UXBs. Some UXBs are directly visible in the photos - see
for example the green circles in this &lt;a
href=&quot;https://ncap.org.uk/sites/default/files/NCAP_JARIC_106G_4923_4226_UXO_600.jpg&quot;&gt;NCAP
image&lt;/a&gt; or p. 6 in the following &lt;a
href=&quot;https://www.luftbilddatenbank.de/download/luftbilddatenbank.pdf&quot;&gt;information
flyer&lt;/a&gt; by one of the companies offering such aerial identification
services (featured in this &lt;a
href=&quot;http://www.spiegel.de/international/business/firm-uses-historic-aerial-photos-to-find-unexploded-wwii-bombs-a-825836.html&quot;&gt;news
article&lt;/a&gt;). In other cases the photos only provide information about
the location of the exploded bombs. This information can be used to
identify areas where there is a high likelihood of UXBs. Such areas
would then be carefully scrutinized using on-the-ground search methods,
for example, electromagnetic and magnetic detectors.&lt;/p&gt;
&lt;p&gt;The aim of &lt;span class=&quot;citation&quot;
data-cites=&quot;mahling_etal2013&quot;&gt;Mahling, Höhle, and Küchenhoff
(2013)&lt;/span&gt; was to develop statistical methods for the identification
of such risk-zones in co-operation with &lt;em&gt;Oberfinanzdirektion
Niedersachsen&lt;/em&gt;, which supports the removal of unexploded ordnance in
federal properties in Germany. In what follows we will discuss
&lt;em&gt;one&lt;/em&gt; of the methods used in the paper, the so called
&lt;strong&gt;nearest neighbourhood distance method&lt;/strong&gt; and illustrate
its implementation in the R package &lt;code&gt;highriskzone&lt;/code&gt; originally
created by &lt;a href=&quot;http://heidiseibold.github.io&quot;&gt;Heidi Seibold&lt;/a&gt; and
now maintained by &lt;a
href=&quot;http://www.stablab.stat.uni-muenchen.de/personen/doktoranden/guenther/index.html&quot;&gt;Felix
Günther&lt;/a&gt;.&lt;/p&gt;
&lt;h3 id=&quot;mathematical-setup&quot;&gt;Mathematical Setup&lt;/h3&gt;
&lt;p&gt;Casting matters into mathematical notation: Let &lt;span
class=&quot;math inline&quot;&gt;\(X\)&lt;/span&gt; be a point process denoting the spatial
locations of all bombs dropped in the particular window of interest
&lt;span class=&quot;math inline&quot;&gt;\(W \subseteq \mathbb{R}^2\)&lt;/span&gt;.
Furthermore, let &lt;span class=&quot;math inline&quot;&gt;\(Y\)&lt;/span&gt; denote the
observed point process of exploded bomb and &lt;span
class=&quot;math inline&quot;&gt;\(Z=X\backslash Y\)&lt;/span&gt; the point process of
unexploded bombs. Note that only the process &lt;span
class=&quot;math inline&quot;&gt;\(Y\)&lt;/span&gt; is observed; &lt;span
class=&quot;math inline&quot;&gt;\(Z\)&lt;/span&gt; is not observed and the target of our
inference. We assume that the probability &lt;span
class=&quot;math inline&quot;&gt;\(q\)&lt;/span&gt; of a dropped bomb not exploding is
homogeneous in &lt;span class=&quot;math inline&quot;&gt;\(W\)&lt;/span&gt;. Thus if &lt;span
class=&quot;math inline&quot;&gt;\(X\)&lt;/span&gt; is a inhomogeneous Poisson point
process with intensity function &lt;span
class=&quot;math inline&quot;&gt;\(\lambda_X(\bm{s})\)&lt;/span&gt;, &lt;span
class=&quot;math inline&quot;&gt;\(\bm{s}\in W\)&lt;/span&gt;, then&lt;/p&gt;
&lt;p&gt;&lt;span class=&quot;math display&quot;&gt;\[
\lambda_Y(\bm{s}) = (1-q) \lambda_X(\bm{s})
\quad \text{and}\quad
\lambda_Z(\bm{s}) = q \lambda_X(\bm{s})
\]&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;are the intensity functions of &lt;span class=&quot;math inline&quot;&gt;\(Y\)&lt;/span&gt;
and &lt;span class=&quot;math inline&quot;&gt;\(Z\)&lt;/span&gt;, respectively.&lt;/p&gt;
&lt;p&gt;The figure below shows &lt;span class=&quot;math inline&quot;&gt;\(Y\)&lt;/span&gt; for an
actual observed WWII bomb point consisting of n=443 bombs available from
the R package &lt;code&gt;highriskzone&lt;/code&gt; &lt;span class=&quot;citation&quot;
data-cites=&quot;highriskzone&quot;&gt;(Seibold et al. 2017)&lt;/span&gt;. The observation
window contains a particular area of interest for which a risk
assessment needs to be done - often these contain a known WWII military
target, e.g., an airport, an arms factory or a military casern. In order
to not disclose the exact location of the considered area, coordinates
are given relative to an arbitrary origo. In reality one would closely
link such digitized aerial images to other terrain features using a GIS
system.&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb1&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb1-1&quot;&gt;&lt;a href=&quot;#cb1-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;library&lt;/span&gt;(highriskzone)&lt;/span&gt;
&lt;span id=&quot;cb1-2&quot;&gt;&lt;a href=&quot;#cb1-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;library&lt;/span&gt;(spatstat)&lt;/span&gt;
&lt;span id=&quot;cb1-3&quot;&gt;&lt;a href=&quot;#cb1-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;data&lt;/span&gt;(craterA)&lt;/span&gt;
&lt;span id=&quot;cb1-4&quot;&gt;&lt;a href=&quot;#cb1-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;summary&lt;/span&gt;(craterA)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;## Planar point pattern:  443 points
## Average intensity 0.0001082477 points per square unit
## 
## Coordinates are given to 4 decimal places
## 
## Window: polygonal boundary
## single connected closed polygon with 208 vertices
## enclosing rectangle: [0, 2334.3758] x [0, 2456.4061] units
## Window area = 4092470 square units
## Fraction of frame area: 0.714&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;img src=&quot;/blog/figure/source/2018-05-25-uxb/unnamed-chunk-5-1.png&quot; title=&quot;Observed bomb point pattern ($Y$) within the observation window $W$.&quot; alt=&quot;Observed bomb point pattern ($Y$) within the observation window $W$.&quot; style=&quot;display: block; margin: auto;&quot; /&gt;
The point pattern &lt;code&gt;craterA&lt;/code&gt; corresponding to an instance of
the process &lt;span class=&quot;math inline&quot;&gt;\(Y\)&lt;/span&gt; is provided in R as
an object of class ppp from the R package &lt;code&gt;spatstat&lt;/code&gt; &lt;span
class=&quot;citation&quot; data-cites=&quot;baddeley_etal2015&quot;&gt;(Baddeley, Rubak, and
Turner 2015)&lt;/span&gt;. Instead of inferring the locations in &lt;span
class=&quot;math inline&quot;&gt;\(Z\)&lt;/span&gt; directly, we shall be interested in
determining a region within &lt;span class=&quot;math inline&quot;&gt;\(W\)&lt;/span&gt;, a so
called &lt;strong&gt;high risk zone&lt;/strong&gt;, which with a high likelihood
contains the points of &lt;span class=&quot;math inline&quot;&gt;\(Z\)&lt;/span&gt;. We shall
consider two methods for this job: a non-parametric method based on
nearest neighbour distances in &lt;span class=&quot;math inline&quot;&gt;\(Y\)&lt;/span&gt;
and an intensity function based inhomogeneous Poisson process approach
incorporating &lt;span class=&quot;math inline&quot;&gt;\(q\)&lt;/span&gt;.&lt;/p&gt;
&lt;h3 id=&quot;high-risk-zones&quot;&gt;High Risk Zones&lt;/h3&gt;
&lt;p&gt;A heuristic way to determine a high-risk zone is the following:
Determine the distribution function &lt;span
class=&quot;math inline&quot;&gt;\(D\)&lt;/span&gt; of the nearest neighbour distance (NND)
distribution based on the 443 points in the point pattern. Use the
distribution to determine a desired quantile, say &lt;span
class=&quot;math inline&quot;&gt;\(0 \leq p \leq 1\)&lt;/span&gt; of the NND distribution.
Denoting the &lt;span class=&quot;math inline&quot;&gt;\(p\)&lt;/span&gt; sample quantile of
the NND distribution by &lt;span class=&quot;math inline&quot;&gt;\(Q(p)\)&lt;/span&gt;, a
&lt;span class=&quot;math inline&quot;&gt;\(p\)&lt;/span&gt;-quantile NND based high-risk zone
is then obtained as the union of putting a disc of radius &lt;span
class=&quot;math inline&quot;&gt;\(x_q\)&lt;/span&gt; around each observed exploded bomb in
&lt;span class=&quot;math inline&quot;&gt;\(Y\)&lt;/span&gt; - in mathematical terms:&lt;/p&gt;
&lt;p&gt;&lt;span class=&quot;math display&quot;&gt;\[
R_p = \left(\bigcup_{\bm{y} \in Y} B(\bm{y}, Q(p))\right) \bigcap W =
\left\{\bm{s} \in W : \min_{\bm{y}\in Y} || \bm{s} − \bm{y} || \leq
Q_Y(p) \right\},
\]&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;where &lt;span class=&quot;math inline&quot;&gt;\(B(\bm{s}, r)\)&lt;/span&gt; denotes a
disc of radius &lt;span class=&quot;math inline&quot;&gt;\(r\)&lt;/span&gt; around the point
&lt;span class=&quot;math inline&quot;&gt;\(\bm{s}\)&lt;/span&gt; and &lt;span
class=&quot;math inline&quot;&gt;\(||\bm{s} - \bm{y}||\)&lt;/span&gt; is the distance
between the two points &lt;span class=&quot;math inline&quot;&gt;\(\bm{s}\)&lt;/span&gt; and
&lt;span class=&quot;math inline&quot;&gt;\(\bm{y}\)&lt;/span&gt;. The intersection with &lt;span
class=&quot;math inline&quot;&gt;\(W\)&lt;/span&gt; is done in order to guarantee that the
risk zone lies entirely within &lt;span class=&quot;math inline&quot;&gt;\(W\)&lt;/span&gt;.
As an example, we would determine the 99%-quantile NND zone for
&lt;code&gt;craterA&lt;/code&gt; using &lt;code&gt;spatstat&lt;/code&gt; functionality as
follows:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb3&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb3-1&quot;&gt;&lt;a href=&quot;#cb3-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;(Qp &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;quantile&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;nndist&lt;/span&gt;(craterA), &lt;span class=&quot;at&quot;&gt;p =&lt;/span&gt; &lt;span class=&quot;fl&quot;&gt;0.99&lt;/span&gt;, &lt;span class=&quot;at&quot;&gt;type =&lt;/span&gt; &lt;span class=&quot;dv&quot;&gt;8&lt;/span&gt;))&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;##      99% 
## 142.1391&lt;/code&gt;&lt;/pre&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb5&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb5-1&quot;&gt;&lt;a href=&quot;#cb5-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;dmap &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;distmap&lt;/span&gt;(craterA)&lt;/span&gt;
&lt;span id=&quot;cb5-2&quot;&gt;&lt;a href=&quot;#cb5-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;zone_dist &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;eval.im&lt;/span&gt;( dmap &lt;span class=&quot;sc&quot;&gt;&amp;lt;&lt;/span&gt; Qp )&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;The above can also be done directly using
&lt;code&gt;highriskzone::det_hrz&lt;/code&gt; function:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb6&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb6-1&quot;&gt;&lt;a href=&quot;#cb6-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;zone_dist &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;det_hrz&lt;/span&gt;(craterA, &lt;span class=&quot;at&quot;&gt;type=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;dist&amp;quot;&lt;/span&gt;, &lt;span class=&quot;at&quot;&gt;criterion =&lt;/span&gt; &lt;span class=&quot;st&quot;&gt;&amp;quot;indirect&amp;quot;&lt;/span&gt;, &lt;span class=&quot;at&quot;&gt;cutoff=&lt;/span&gt;&lt;span class=&quot;fl&quot;&gt;0.99&lt;/span&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Either way, the resulting risk-zone is as follows:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb7&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb7-1&quot;&gt;&lt;a href=&quot;#cb7-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;summary&lt;/span&gt;(zone_dist)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;## high-risk zone of type dist  
## criterion: indirect  
## cutoff: 0.99  
##  
## threshold: 142.1391  
## area of the high-risk zone: 2580654&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;img src=&quot;/blog/figure/source/2018-05-25-uxb/unnamed-chunk-9-1.png&quot; style=&quot;display: block; margin: auto;&quot; /&gt;
&lt;span class=&quot;citation&quot; data-cites=&quot;mahling_etal2013&quot;&gt;Mahling, Höhle, and
Küchenhoff (2013)&lt;/span&gt; show that risk zones constructed by the NND
method work surprisingly well despite lacking a clear theoretical
justification. One theoretical issue is, for example, that the NND
distribution function determined by the above method is for the &lt;span
class=&quot;math inline&quot;&gt;\((1-q)\)&lt;/span&gt; thinned process &lt;span
class=&quot;math inline&quot;&gt;\(Y\)&lt;/span&gt;, even though the actual interest is in
the process &lt;span class=&quot;math inline&quot;&gt;\(X=Y\cup Z\)&lt;/span&gt;. Because of
the thinning one would typically have that &lt;span
class=&quot;math inline&quot;&gt;\(D_Y(r) \leq D_X(r)\)&lt;/span&gt; and thus &lt;span
class=&quot;math inline&quot;&gt;\(Q_Y(p) &amp;gt; Q_X(p)\)&lt;/span&gt;. Using &lt;span
class=&quot;math inline&quot;&gt;\(Q_Y(p)\)&lt;/span&gt; to make statements about &lt;span
class=&quot;math inline&quot;&gt;\(X\)&lt;/span&gt; (and thus &lt;span
class=&quot;math inline&quot;&gt;\(Z\)&lt;/span&gt;) is therefore slightly wrong. However,
this error cancels, because we then use the points in &lt;span
class=&quot;math inline&quot;&gt;\(Y\)&lt;/span&gt; to add a buffer of radius &lt;span
class=&quot;math inline&quot;&gt;\(Q_Y(p)\)&lt;/span&gt;. Had we instead used the smaller,
but true, &lt;span class=&quot;math inline&quot;&gt;\(Q_X(p)\)&lt;/span&gt; the risk zone
would have gotten a too small, because &lt;span
class=&quot;math inline&quot;&gt;\(X\)&lt;/span&gt; would also have contained more points
to form discs around than &lt;span class=&quot;math inline&quot;&gt;\(Y\)&lt;/span&gt;. The
method thus implicitly takes &lt;span class=&quot;math inline&quot;&gt;\(q\)&lt;/span&gt;
non-parametrically into account, because its NND is determined based on
&lt;span class=&quot;math inline&quot;&gt;\(Y\)&lt;/span&gt; and subsequently discs of radius
&lt;span class=&quot;math inline&quot;&gt;\(Q_Y(p)\)&lt;/span&gt; are formed around the points
of &lt;span class=&quot;math inline&quot;&gt;\(Y\)&lt;/span&gt;.&lt;/p&gt;
&lt;div class=&quot;framedbox&quot;&gt;
&lt;p&gt;Technical details you might want to skip: The above feature is most
easily illustrated if &lt;span class=&quot;math inline&quot;&gt;\(X\)&lt;/span&gt; is a
homogeneous Poisson process with intensity &lt;span
class=&quot;math inline&quot;&gt;\(\lambda_X\)&lt;/span&gt;. In this case we have that the
NND distribution function is &lt;span class=&quot;citation&quot;
data-cites=&quot;illian_etal2008&quot;&gt;(p.68, Illian et al. 2008)&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span class=&quot;math display&quot;&gt;\[
D_X(r) = 1 - \exp(-\lambda_X \pi r^2), \quad r&amp;gt;0.
\]&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;Also note that &lt;span class=&quot;math inline&quot;&gt;\(D_Y(r) = 1 -
\exp(-(1-q)\lambda_X \pi r^2)\)&lt;/span&gt; and therefore &lt;span
class=&quot;math inline&quot;&gt;\(D_Y(r) &amp;gt; D_X(r)\)&lt;/span&gt;. Now solving for the
&lt;span class=&quot;math inline&quot;&gt;\(p\)&lt;/span&gt;-quantile of the NND in this
homogeneous Poisson case means solving&lt;/p&gt;
&lt;p&gt;&lt;span class=&quot;math display&quot;&gt;\[
Q_Y(p) = \min_{r\geq 0} \{ D_Y(r) \geq p \} \Leftrightarrow Q_Y(p) =
\sqrt{ \frac{\log(1-p)}{\lambda_Y \pi}}.
\]&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;From this it becomes clear than in the homogeneous Poisson case &lt;span
class=&quot;math inline&quot;&gt;\(Q_
Y(p)\)&lt;/span&gt; is a factor &lt;span
class=&quot;math inline&quot;&gt;\(\sqrt{1/(1-q)}\)&lt;/span&gt; larger than &lt;span
class=&quot;math inline&quot;&gt;\(Q_X(p)\)&lt;/span&gt;, which is the actual target of
interest.&lt;/p&gt;
&lt;/div&gt;
&lt;p&gt;
&lt;h3 id=&quot;assessing-the-coverage-of-a-risk-zone&quot;&gt;Assessing the coverage of
a risk-zone&lt;/h3&gt;
&lt;p&gt;Two criterion appear immediate in order to assess the coverage of a
risk-zone &lt;span class=&quot;math inline&quot;&gt;\(R\)&lt;/span&gt;:&lt;/p&gt;
&lt;ol type=&quot;1&quot;&gt;
&lt;li&gt;&lt;p&gt;The probability &lt;span
class=&quot;math inline&quot;&gt;\(p_{\text{out}}\)&lt;/span&gt; that there will be at
least one bomb outside the risk zone, i.e. &lt;span
class=&quot;math inline&quot;&gt;\(P( N( Z \backslash R) &amp;gt; 0)\)&lt;/span&gt;, where
&lt;span class=&quot;math inline&quot;&gt;\(N(A)\)&lt;/span&gt; denotes the number of events
in the set &lt;span class=&quot;math inline&quot;&gt;\(A \subseteq W\)&lt;/span&gt;. Note:
this probability is depending heavily on the amount of points in &lt;span
class=&quot;math inline&quot;&gt;\(Z\)&lt;/span&gt;, the more points there are, the higher
is &lt;span class=&quot;math inline&quot;&gt;\(p_{\text{out}}\)&lt;/span&gt;. However, it
reflects the idea “one miss is all it takes to get in trouble”.&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;The proportion of events in &lt;span
class=&quot;math inline&quot;&gt;\(Z\)&lt;/span&gt; not located in &lt;span
class=&quot;math inline&quot;&gt;\(R\)&lt;/span&gt;, i.e. &lt;span class=&quot;math inline&quot;&gt;\(N( Z
\backslash R) / N(Z)\)&lt;/span&gt;, we shall denote this criterion by &lt;span
class=&quot;math inline&quot;&gt;\(p_{\text{miss}}\)&lt;/span&gt;. Note: This probability
is taking possible different sizes of &lt;span
class=&quot;math inline&quot;&gt;\(Z\)&lt;/span&gt; into account, but also takes a more
relative approach towards how many bombs are not covered by the
zone.&lt;/p&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;Under the assumption of independence between whether &lt;span
class=&quot;math inline&quot;&gt;\(Z\)&lt;/span&gt;-events are within or outside the
risk-zone one can convert back and forth between &lt;span
class=&quot;math inline&quot;&gt;\(p_{\text{miss}}\)&lt;/span&gt; and &lt;span
class=&quot;math inline&quot;&gt;\(p_{\text{out}}\)&lt;/span&gt; by&lt;/p&gt;
&lt;p&gt;&lt;span class=&quot;math display&quot;&gt;\[
p_{\text{out}} = P( N( Z \backslash R) &amp;gt; 0) = 1- P(N(Z
\backslash R) = 0) \approx  1 - (1-p_{\text{miss}})^{N(Z)},
\]&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;where one in a simulation setup would know &lt;span
class=&quot;math inline&quot;&gt;\(Z\)&lt;/span&gt; and thus also &lt;span
class=&quot;math inline&quot;&gt;\(N(Z)\)&lt;/span&gt;. Note that for a &lt;span
class=&quot;math inline&quot;&gt;\(p\)&lt;/span&gt;-quantile NND risk-zone we expect &lt;span
class=&quot;math inline&quot;&gt;\(1-p_{\text{miss}}\)&lt;/span&gt; to be approximately
equal to &lt;span class=&quot;math inline&quot;&gt;\(p\)&lt;/span&gt;. We can investigate the
behaviour of risk-zones according to the two above criterion through the
use of simulation. Either by simply &lt;span
class=&quot;math inline&quot;&gt;\(q\)&lt;/span&gt;-thinning of the existing point pattern
&lt;span class=&quot;math inline&quot;&gt;\(Y\)&lt;/span&gt; and then use this thinned pattern
to determine a risk-zone, which is then evaluated. An alternative
approach is to estimate the intensity surface from &lt;span
class=&quot;math inline&quot;&gt;\(Y\)&lt;/span&gt;, upscale it to get the intensity of
&lt;span class=&quot;math inline&quot;&gt;\(X\)&lt;/span&gt;, simulate &lt;span
class=&quot;math inline&quot;&gt;\(X\)&lt;/span&gt; as an inhomogeneous Poisson point
process with this intensity surface, thin this pattern to get a
simulated instance of &lt;span class=&quot;math inline&quot;&gt;\(Y\)&lt;/span&gt;, construct
the risk-zone based on this pattern and then evaluate the coverage of
the zone &lt;span class=&quot;citation&quot; data-cites=&quot;mahling_etal2013&quot;&gt;(Mahling,
Höhle, and Küchenhoff 2013)&lt;/span&gt;. Note that this type of simulation is
based on more assumptions compared to the non-parametric thinning
simulation approach.&lt;/p&gt;
&lt;p&gt;We generate 1,000 realizations of &lt;span
class=&quot;math inline&quot;&gt;\(Y\)&lt;/span&gt; and &lt;span
class=&quot;math inline&quot;&gt;\(Z\)&lt;/span&gt; through &lt;span
class=&quot;math inline&quot;&gt;\(q\)&lt;/span&gt;-thinning of the original
&lt;code&gt;craterA&lt;/code&gt; pattern while computing the coverage measures for
the NND method as follows:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb9&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb9-1&quot;&gt;&lt;a href=&quot;#cb9-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;suppressPackageStartupMessages&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;library&lt;/span&gt;(doParallel))&lt;/span&gt;
&lt;span id=&quot;cb9-2&quot;&gt;&lt;a href=&quot;#cb9-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;registerDoParallel&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;cores=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;4&lt;/span&gt;)&lt;/span&gt;
&lt;span id=&quot;cb9-3&quot;&gt;&lt;a href=&quot;#cb9-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb9-4&quot;&gt;&lt;a href=&quot;#cb9-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;simulate_method &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;st&quot;&gt;&amp;quot;thinning&amp;quot;&lt;/span&gt; &lt;span class=&quot;co&quot;&gt;#&amp;quot;intensity&amp;quot; # &amp;quot;cond_intensity&amp;quot;&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb9-5&quot;&gt;&lt;a href=&quot;#cb9-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;sim &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;foreach&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;i=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;seq_len&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;getDoParWorkers&lt;/span&gt;()), &lt;span class=&quot;at&quot;&gt;.combine=&lt;/span&gt;rbind) &lt;span class=&quot;sc&quot;&gt;%dopar%&lt;/span&gt; {&lt;/span&gt;
&lt;span id=&quot;cb9-6&quot;&gt;&lt;a href=&quot;#cb9-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;tryCatch&lt;/span&gt;(&lt;/span&gt;
&lt;span id=&quot;cb9-7&quot;&gt;&lt;a href=&quot;#cb9-7&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;fu&quot;&gt;eval_method&lt;/span&gt;(craterA, &lt;span class=&quot;at&quot;&gt;type=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;c&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;quot;dist&amp;quot;&lt;/span&gt;), &lt;span class=&quot;at&quot;&gt;criterion=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;c&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;quot;indirect&amp;quot;&lt;/span&gt;),&lt;/span&gt;
&lt;span id=&quot;cb9-8&quot;&gt;&lt;a href=&quot;#cb9-8&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;                &lt;span class=&quot;at&quot;&gt;cutoff=&lt;/span&gt;&lt;span class=&quot;fl&quot;&gt;0.99&lt;/span&gt;, &lt;span class=&quot;at&quot;&gt;numit =&lt;/span&gt; &lt;span class=&quot;dv&quot;&gt;250&lt;/span&gt;, &lt;span class=&quot;at&quot;&gt;simulate=&lt;/span&gt;simulate_method,&lt;/span&gt;
&lt;span id=&quot;cb9-9&quot;&gt;&lt;a href=&quot;#cb9-9&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;                &lt;span class=&quot;at&quot;&gt;pbar=&lt;/span&gt;&lt;span class=&quot;cn&quot;&gt;FALSE&lt;/span&gt;),&lt;/span&gt;
&lt;span id=&quot;cb9-10&quot;&gt;&lt;a href=&quot;#cb9-10&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;at&quot;&gt;error=&lt;/span&gt; &lt;span class=&quot;cf&quot;&gt;function&lt;/span&gt;(e) &lt;span class=&quot;fu&quot;&gt;return&lt;/span&gt;(&lt;span class=&quot;cn&quot;&gt;NULL&lt;/span&gt;))&lt;/span&gt;
&lt;span id=&quot;cb9-11&quot;&gt;&lt;a href=&quot;#cb9-11&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;## # A tibble: 1 x 5
##   p_out  p_miss `1-p_miss` p_out_derived    nZ
##   &amp;lt;dbl&amp;gt;   &amp;lt;dbl&amp;gt;      &amp;lt;dbl&amp;gt;         &amp;lt;dbl&amp;gt; &amp;lt;dbl&amp;gt;
## 1 0.097 0.00236      0.998        0.0996  44.4&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;The numbers state the average &lt;code&gt;p_out&lt;/code&gt; and
&lt;code&gt;p_miss&lt;/code&gt;in the 1000 simulations. Furthermore, &lt;code&gt;nZ&lt;/code&gt;
denotes the average number of events in &lt;span
class=&quot;math inline&quot;&gt;\(Z\)&lt;/span&gt;. We see that the NND method performs
even a little better than intended, because &lt;span
class=&quot;math inline&quot;&gt;\(1-p_{\text{miss}}\)&lt;/span&gt; is even higher than the
intended &lt;span class=&quot;math inline&quot;&gt;\(p\)&lt;/span&gt;=99%. The probability
that the risk-zone misses at least one bomb lies as low as 0.097. This
is quite close to the above described approximate conversion from &lt;span
class=&quot;math inline&quot;&gt;\(p_{\text{miss}}\)&lt;/span&gt; (0.100 vs. 0.097).
Changing the simulation method for &lt;span
class=&quot;math inline&quot;&gt;\(X\)&lt;/span&gt; to that of an inhomogeneous Poisson
process with intensity &lt;span class=&quot;math inline&quot;&gt;\(1/(1-q) \cdot
\hat{\lambda}_Y(\bm{s})\)&lt;/span&gt; yields similar results:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;## # A tibble: 1 x 5
##   p_out  p_miss `1-p_miss` p_out_derived    nZ
##   &amp;lt;dbl&amp;gt;   &amp;lt;dbl&amp;gt;      &amp;lt;dbl&amp;gt;         &amp;lt;dbl&amp;gt; &amp;lt;dbl&amp;gt;
## 1 0.352 0.00897      0.991         0.361  49.6&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;We note that the probability of missing at least one bomb is much
higher under this parametric simulation method. Only a small fraction of
this is explained by &lt;span class=&quot;math inline&quot;&gt;\(Z\)&lt;/span&gt; now
consisting of more points. A likely explanation is that the parametric
model is only semi-adequate to describe how the point patterns form.
Therefore, the new &lt;span class=&quot;math inline&quot;&gt;\(X\)&lt;/span&gt; might have a
somewhat different neighbourhood distribution than anticipated.&lt;/p&gt;
&lt;p&gt;To compare more specifically with the intensity function based
risk-zone method of &lt;span class=&quot;citation&quot;
data-cites=&quot;mahling_etal2013&quot;&gt;Mahling, Höhle, and Küchenhoff
(2013)&lt;/span&gt; we use a specification, where the risk-zone derived by the
NND method or the intensity method have the same area (250 hectare).&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb12&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb12-1&quot;&gt;&lt;a href=&quot;#cb12-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;sim_area &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;foreach&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;i=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;seq_len&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;getDoParWorkers&lt;/span&gt;()), &lt;span class=&quot;at&quot;&gt;.combine=&lt;/span&gt;rbind) &lt;span class=&quot;sc&quot;&gt;%dopar%&lt;/span&gt; {&lt;/span&gt;
&lt;span id=&quot;cb12-2&quot;&gt;&lt;a href=&quot;#cb12-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;tryCatch&lt;/span&gt;(&lt;/span&gt;
&lt;span id=&quot;cb12-3&quot;&gt;&lt;a href=&quot;#cb12-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;fu&quot;&gt;eval_method&lt;/span&gt;(craterA, &lt;span class=&quot;at&quot;&gt;type=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;c&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;quot;dist&amp;quot;&lt;/span&gt;,&lt;span class=&quot;st&quot;&gt;&amp;quot;intens&amp;quot;&lt;/span&gt;), &lt;span class=&quot;at&quot;&gt;criterion=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;rep&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;quot;area&amp;quot;&lt;/span&gt;,&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;),&lt;/span&gt;
&lt;span id=&quot;cb12-4&quot;&gt;&lt;a href=&quot;#cb12-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;                &lt;span class=&quot;at&quot;&gt;cutoff=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;rep&lt;/span&gt;(&lt;span class=&quot;dv&quot;&gt;2500000&lt;/span&gt;,&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;), &lt;span class=&quot;at&quot;&gt;numit =&lt;/span&gt; &lt;span class=&quot;dv&quot;&gt;100&lt;/span&gt;,&lt;/span&gt;
&lt;span id=&quot;cb12-5&quot;&gt;&lt;a href=&quot;#cb12-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;                &lt;span class=&quot;at&quot;&gt;simulate=&lt;/span&gt;simulate_method, &lt;span class=&quot;at&quot;&gt;pbar=&lt;/span&gt;&lt;span class=&quot;cn&quot;&gt;FALSE&lt;/span&gt;),&lt;/span&gt;
&lt;span id=&quot;cb12-6&quot;&gt;&lt;a href=&quot;#cb12-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;at&quot;&gt;error=&lt;/span&gt; &lt;span class=&quot;cf&quot;&gt;function&lt;/span&gt;(e) &lt;span class=&quot;fu&quot;&gt;return&lt;/span&gt;(&lt;span class=&quot;cn&quot;&gt;NULL&lt;/span&gt;))&lt;/span&gt;
&lt;span id=&quot;cb12-7&quot;&gt;&lt;a href=&quot;#cb12-7&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;## # A tibble: 2 x 6
##   Type   p_out  p_miss `1-p_miss` p_out_derived area_zone
##   &amp;lt;fct&amp;gt;  &amp;lt;dbl&amp;gt;   &amp;lt;dbl&amp;gt;      &amp;lt;dbl&amp;gt;         &amp;lt;dbl&amp;gt;     &amp;lt;dbl&amp;gt;
## 1 dist   0.123 0.00278      0.997         0.117  2500009.
## 2 intens 0.55  0.0172       0.983         0.539  2499994.&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;For the particular example we see an advantage of using the NND
method, because both &lt;code&gt;p_out&lt;/code&gt; &lt;code&gt;p_miss&lt;/code&gt; are much
lower for the intensity based method. Again, this might be due to the
intensity method being based on assumptions, which for the particular
example do not appear to be so adequate. Results in &lt;span
class=&quot;citation&quot; data-cites=&quot;mahling2013&quot;&gt;Mahling (2013)&lt;/span&gt; were,
however, much better for this example (c.f. Tab 2), which could be an
indication that there is a problem in the &lt;code&gt;highriskzone&lt;/code&gt;
package implementation of this method?&lt;/p&gt;
&lt;h2 id=&quot;discussion&quot;&gt;Discussion&lt;/h2&gt;
&lt;p&gt;Being a statistician is fascinating, because the job is the entry
ticket to so many diverse research fields. The proposed methods and
evaluations helped the &lt;em&gt;Oberfinanzdirektion&lt;/em&gt; obtain a
quantitative framework to decide which methods to use in their routine
risk-assessment. Further details on the above application can be found
in &lt;span class=&quot;citation&quot; data-cites=&quot;mahling_etal2013&quot;&gt;Mahling, Höhle,
and Küchenhoff (2013)&lt;/span&gt; as well as in &lt;a
href=&quot;https://edoc.ub.uni-muenchen.de/15886/&quot;&gt;Monia’s
Ph.D. dissertation&lt;/a&gt; &lt;span class=&quot;citation&quot;
data-cites=&quot;mahling2013&quot;&gt;(Mahling 2013)&lt;/span&gt;. Note also that the
techniques are not limited to UXB detection:
Infer-unknown-points-from-a-thinned-process problems occur both in 1D
and 2D point processes in a range of other fields, e.g., under-reporting
of infectious disease locations or in the calculation of animal
abundance in ecology.&lt;/p&gt;
&lt;p&gt;As a personal anecdote: When finishing the work on &lt;span
class=&quot;citation&quot; data-cites=&quot;mahling_etal2013&quot;&gt;Mahling, Höhle, and
Küchenhoff (2013)&lt;/span&gt; I was in transition from university to working
at a public health institute. The deal was to finish the UXB work partly
in spare-time and partly in the new work time. To honour this I added my
new work place as second affiliation before submitting, but as part of
the institution’s internal clearing procedure of the publication, I was
asked to remove this affiliation again by the higher management, because
the work ‘had nothing to do with public health’. While its questionable
whether exploding bombs really do not have a public health impact, a few
months later, I ended up using very similar statistical techniques to
model occurred-but-not-yet-reported cases during a critical infectious
disease outbreak &lt;span class=&quot;citation&quot;
data-cites=&quot;hoehle_anderheiden2014&quot;&gt;(Höhle and an der Heiden
2014)&lt;/span&gt;.&lt;/p&gt;
&lt;center&gt;
&lt;a title=&quot;By No 4 RAFFPU, Royal Air Force official photographer [Public domain], via Wikimedia Commons&quot; href=&quot;https://commons.wikimedia.org/wiki/File:Grand_Slam_bomb_exploding_near_Arnsberg_viaduct_1945.jpg&quot;&gt;&lt;img width=&quot;512&quot; alt=&quot;Grand Slam bomb exploding near Arnsberg viaduct 1945&quot; src=&quot;https://upload.wikimedia.org/wikipedia/commons/2/2c/Grand_Slam_bomb_exploding_near_Arnsberg_viaduct_1945.jpg&quot;&gt;&lt;/a&gt;
&lt;/center&gt;
&lt;p&gt;
&lt;h2 class=&quot;unnumbered&quot; id=&quot;literature&quot;&gt;Literature&lt;/h2&gt;
&lt;div id=&quot;refs&quot; class=&quot;references csl-bib-body hanging-indent&quot;
data-entry-spacing=&quot;0&quot; role=&quot;list&quot;&gt;
&lt;div id=&quot;ref-baddeley_etal2015&quot; class=&quot;csl-entry&quot; role=&quot;listitem&quot;&gt;
Baddeley, A., E. Rubak, and R. Turner. 2015. &lt;em&gt;Spatial Point Patterns:
Methodology and Applications with &lt;span&gt;R&lt;/span&gt;&lt;/em&gt;. London: Chapman;
Hall/CRC. &lt;a
href=&quot;http://www.crcpress.com/books/details/9781482210200/&quot;&gt;http://www.crcpress.com/books/details/9781482210200/&lt;/a&gt;.
&lt;/div&gt;
&lt;div id=&quot;ref-hoehle_anderheiden2014&quot; class=&quot;csl-entry&quot; role=&quot;listitem&quot;&gt;
Höhle, M., and M. an der Heiden. 2014. &lt;span&gt;“Bayesian Nowcasting During
the &lt;span&gt;STEC O104:H4&lt;/span&gt; Outbreak in &lt;span&gt;Germany&lt;/span&gt;,
2011.”&lt;/span&gt; &lt;em&gt;Biometrics&lt;/em&gt; 70 (4): 993–1002. &lt;a
href=&quot;https://doi.org/10.1111/biom.12194&quot;&gt;https://doi.org/10.1111/biom.12194&lt;/a&gt;.
&lt;/div&gt;
&lt;div id=&quot;ref-illian_etal2008&quot; class=&quot;csl-entry&quot; role=&quot;listitem&quot;&gt;
Illian, J., A. Penttinen, H. Stoyan, and D. Stoyan. 2008. &lt;em&gt;Stistical
Analysis and Modelling of Spatial Point Patterns&lt;/em&gt;. Wiley.
&lt;/div&gt;
&lt;div id=&quot;ref-mahling2013&quot; class=&quot;csl-entry&quot; role=&quot;listitem&quot;&gt;
Mahling, M. 2013. &lt;span&gt;“Determining High-Risk Zones by Using Spatial
Point Process Methodology.”&lt;/span&gt; PhD thesis, Department of Statistics,
University of Munich. &lt;a
href=&quot;https://edoc.ub.uni-muenchen.de/15886/1/Mahling_Monia.pdf&quot;&gt;https://edoc.ub.uni-muenchen.de/15886/1/Mahling_Monia.pdf&lt;/a&gt;.
&lt;/div&gt;
&lt;div id=&quot;ref-mahling_etal2013&quot; class=&quot;csl-entry&quot; role=&quot;listitem&quot;&gt;
Mahling, M., M. Höhle, and H. Küchenhoff. 2013. &lt;span&gt;“&lt;span
class=&quot;nocase&quot;&gt;Determining high-risk zones for unexploded World War II
bombs by using point process methodology&lt;/span&gt;.”&lt;/span&gt; &lt;em&gt;Journal of
the Royal Statistical Society, Series C&lt;/em&gt; 62 (2): 181–99. &lt;a
href=&quot;https://doi.org/10.1111/j.1467-9876.2012.01055.x&quot;&gt;https://doi.org/10.1111/j.1467-9876.2012.01055.x&lt;/a&gt;.
&lt;/div&gt;
&lt;div id=&quot;ref-highriskzone&quot; class=&quot;csl-entry&quot; role=&quot;listitem&quot;&gt;
Seibold, H., M. Mahling, S. Linne, and F. Günther. 2017.
&lt;em&gt;Highriskzone: Determining and Evaluating High-Risk Zones&lt;/em&gt;. &lt;a
href=&quot;https://cran.r-project.org/web/packages/highriskzone/index.html&quot;&gt;https://cran.r-project.org/web/packages/highriskzone/index.html&lt;/a&gt;.
&lt;/div&gt;
&lt;/div&gt;
</description>
        <pubDate>Fri, 25 May 2018 00:00:00 +0200</pubDate>
        <link>https://mhoehle.github.io/blog/2018/05/25/uxb.html</link>
        <guid isPermaLink="true">https://mhoehle.github.io/blog/2018/05/25/uxb.html</guid>
        
        <category>rstats</category>
        
        <category>stats</category>
        
        <category>spatial statistics</category>
        
        <category>spatial point processes</category>
        
        
      </item>
    
      <item>
        <title>Inkognito - Sequential Bayesian Identity Disclosure</title>
        <description>&lt;h2 id=&quot;abstract&quot;&gt;Abstract&lt;/h2&gt;
&lt;p&gt;We provide Bayesian decision support for revealing the identity of
opponents in the board game &lt;em&gt;Inkognito&lt;/em&gt;. This includes the use of
combinatorics to deduce the likelihood of observing a particular
configuration and a sequential Bayesian belief updating scheme to infer
opponent’s identity. From a R point of view we use base R where it’s
best: manipulating matrices and supplement this with modern
&lt;code&gt;dplyr&lt;/code&gt; style manipulation of data frames and
&lt;code&gt;magrittr&lt;/code&gt; pipes for sequential belief updating.&lt;/p&gt;
&lt;center&gt;
&lt;img
src=&quot;https://cf.geekdo-images.com/medium/img/8XRGQbD_bCDKdA_ToSA8BKSnKN4=/fit-in/500x500/filters:no_upscale()/pic696789.jpg&quot; /&gt;
&lt;/center&gt;
&lt;p&gt;&lt;FONT COLOR=&quot;bbbbbb&quot;&gt;Image from &lt;a
href=&quot;https://www.boardgamegeek.com/image/696789/inkognito&quot;&gt;boardgamegeek.com&lt;/a&gt;
by &lt;a href=&quot;https://www.boardgamegeek.com/user/yzemaze&quot;&gt;yzemaze&lt;/a&gt;
available under a CC BY-NC-SA 3.0 license.&lt;/FONT&gt;&lt;/p&gt;
&lt;p&gt;&lt;br&gt;
&lt;a rel=&quot;license&quot; href=&quot;http://creativecommons.org/licenses/by-sa/4.0/&quot;&gt;&lt;img alt=&quot;Creative Commons License&quot; style=&quot;border-width:0&quot; src=&quot;https://i.creativecommons.org/l/by-sa/4.0/88x31.png&quot;/&gt;&lt;/a&gt;
This work is licensed under a &lt;a rel=&quot;license&quot;
href=&quot;http://creativecommons.org/licenses/by-sa/4.0/&quot;&gt;Creative Commons
Attribution-ShareAlike 4.0 International License&lt;/a&gt;. The
markdown+Rknitr source code of this blog is available under a &lt;a
href=&quot;https://www.gnu.org/licenses/gpl-3.0.html&quot;&gt;GNU General Public
License (GPL v3)&lt;/a&gt; license from github.&lt;/p&gt;
&lt;h2 id=&quot;introduction&quot;&gt;Introduction&lt;/h2&gt;
&lt;p&gt;&lt;a href=&quot;https://en.wikipedia.org/wiki/Inkognito&quot;&gt;Inkognito&lt;/a&gt; is a
board game for four players first published in 1988. Each player has a
secret &lt;strong&gt;identity&lt;/strong&gt; (either Lord Fiddlebottom, Madame Zsa
Zsa, Col. Bubble or Agent X) and moves four figures around the game
board (a tall, a short, a fat, and a thin figure). However, only one of
the figures (the player’s so called &lt;strong&gt;build&lt;/strong&gt; type) is the
player, the other three are smokescreen, i.e. friendly spies serving to
confuse the other players. As part of the game one has to learn the
identity and build of the other players in order to solve a mission
goal. To this end the players move on the board, whenever one of the
four figures meets one of the figures of an opponent, the opponent has
to reveal information about their identity and build. There is a further
neutral character, the so called &lt;strong&gt;ambassador&lt;/strong&gt;, which can
be moved by all players. There are two types of revelations depending on
which figures meet:&lt;/p&gt;
&lt;ol type=&quot;1&quot;&gt;
&lt;li&gt;&lt;strong&gt;Player question&lt;/strong&gt;: The player can decide to ask the
opponent about either identity or build. If the question is about the
&lt;em&gt;identity&lt;/em&gt; the player has to state two (of the four) identities
and one (of the four) builds. At least one of the three statements has
to be correct, for example, if the opponent is Agent X and has the thin
figure, then the statement could be: I’m Lord Fiddlebottom or Madame Zsa
Zsa and have the thin figure. Conversely, if the question is
&lt;em&gt;build&lt;/em&gt; then two builds and one identity is stated – again at
least one of the statements has to be true.&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Ambassador question&lt;/strong&gt; about either identity or build:
If about identity the opponent has to state two identities, one of them
has to be correct. Similarly if the question is about build.&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;The information arising from each question is logged on a so called
&lt;strong&gt;worksheet&lt;/strong&gt; as shown below. The picture shows the logged
information a game where the player asked one opponent (the red figure)
a total of three questions (two player questions and one ambassador
question).&lt;/p&gt;
&lt;center&gt;
&lt;img src=&quot;/blog/figure/source/2018-04-03-inkognito/worksheet.jpg&quot; /&gt;
&lt;/center&gt;
&lt;p&gt;The idea is to sequentially guide your questioning in order to reveal
the identity of the other players and their build. For a more detailed
description of the game see this &lt;a
href=&quot;http://www.theboardgamefamily.com/2015/03/inkognito-deduction-game-review/&quot;&gt;review&lt;/a&gt;
or this &lt;a
href=&quot;http://islaythedragon.com/featured/carnival-of-spies-a-review-of-inkognito/&quot;&gt;even
longer review&lt;/a&gt;. In what follows, we shall be less interested in all
the particularities of the game and focus on the sequential belief
update of identity and build from the questions, which is central part
of the game.&lt;/p&gt;
&lt;h2 id=&quot;statistical-approach-to-the-belief-updating&quot;&gt;Statistical
Approach to the Belief Updating&lt;/h2&gt;
&lt;p&gt;We cast the questioning into mathematical notation as follows. Let
&lt;span class=&quot;math inline&quot;&gt;\(I\in \{1,2,3,4\}\)&lt;/span&gt; be the opponent’s
identity and &lt;span class=&quot;math inline&quot;&gt;\(B=\{1,2,3,4\}\)&lt;/span&gt; the
opponent’s build. Let&lt;/p&gt;
&lt;p&gt;&lt;span class=&quot;math display&quot;&gt;\[
D_k=(I_{k,1},I_{k,2},I_{k,3},I_{k,4},B_{k,1},B_{k,2},B_{k,3},B_{k,4})&amp;#39;
\]&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;be the information the opponent offers the &lt;span
class=&quot;math inline&quot;&gt;\(k\)&lt;/span&gt;’th time the person is asked about the
identity. Here, &lt;span class=&quot;math inline&quot;&gt;\(I_{k,j}\)&lt;/span&gt; is an
indicator variable showing whether in the &lt;span
class=&quot;math inline&quot;&gt;\(k\)&lt;/span&gt;’th question the opponent claims to have
identity &lt;span class=&quot;math inline&quot;&gt;\(j\)&lt;/span&gt;. Furthermore, &lt;span
class=&quot;math inline&quot;&gt;\(B_{k,j}\)&lt;/span&gt; is an indicator variable showing
whether the opponent in the &lt;span class=&quot;math inline&quot;&gt;\(k\)&lt;/span&gt;’th
question claims to have aspect &lt;span class=&quot;math inline&quot;&gt;\(j\)&lt;/span&gt;.
Altogether &lt;span class=&quot;math inline&quot;&gt;\(D_k\)&lt;/span&gt; corresponds to one
row of information in the worksheet. In what follows we address the two
types of questions, the resulting likelihoods and how a Bayesian
framework can be used to update the belief about the opponent’s identity
and build.&lt;/p&gt;
&lt;h3 id=&quot;player-question-about-identity-or-aspect&quot;&gt;Player question about
identity or aspect&lt;/h3&gt;
&lt;p&gt;A player question consists of asking the opponent about either their
identity or build. In response the opponent has to provide 3 pieces of
information: if asked about the identity two of the statements have to
concern the identity and one the build. Similarly, if asked about the
build, one identity and two build statements have to be given. In other
words, if the question is about identity, the vector &lt;span
class=&quot;math inline&quot;&gt;\(D_k\)&lt;/span&gt; has to be such that &lt;span
class=&quot;math inline&quot;&gt;\(\sum_{j=1}^4 I_{k,j} = 2\)&lt;/span&gt; and &lt;span
class=&quot;math inline&quot;&gt;\(\sum_{c=1}^4 B_{k,c} =
1\)&lt;/span&gt;. Furthermore, at least one of the three statements provided
needs to be true, i.e. if the opponent has identity &lt;span
class=&quot;math inline&quot;&gt;\(i\)&lt;/span&gt; and build &lt;span
class=&quot;math inline&quot;&gt;\(b\)&lt;/span&gt;, then the provided information has to
be such that&lt;/p&gt;
&lt;p&gt;&lt;span class=&quot;math display&quot;&gt;\[
\begin{align*}
\sum_{j=1}^4 I(I=i) I_{k,j} + \sum_{c=1}^4 I(B=b) B_{k,c}
\geq 1 &amp;amp;\Leftrightarrow I_{k,i} + B_{k,b} \geq 1.
\end{align*}
\]&lt;/span&gt;&lt;/p&gt;
&lt;h3 id=&quot;ambassador-question&quot;&gt;Ambassador question&lt;/h3&gt;
&lt;p&gt;If instead a player moves the ambassador on the same location as
another player’s figure, then one can – as before – inquire about the
other player’s identity or build. However, when the ambassador asks one
has to provide two statements about the inquired aspect – of which one
has to be true. In other words, the answer to an ambassador question
&lt;span class=&quot;math inline&quot;&gt;\(D_k\)&lt;/span&gt; will be such that the sum over
either the identity indicators or the builds equal 2. Furthermore, again
assuming that the opponent’s true identity is &lt;span
class=&quot;math inline&quot;&gt;\(i\)&lt;/span&gt; and true build is &lt;span
class=&quot;math inline&quot;&gt;\(b\)&lt;/span&gt; we must have&lt;/p&gt;
&lt;p&gt;&lt;span class=&quot;math display&quot;&gt;\[
I_{k,i} + B_{k,b} =  1,
\]&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;because the answer will either be to identity or build.&lt;/p&gt;
&lt;h2 id=&quot;implementation-in-r&quot;&gt;Implementation in R&lt;/h2&gt;
&lt;p&gt;We implement the possible configurations &lt;span
class=&quot;math inline&quot;&gt;\(D_k\)&lt;/span&gt; on the worksheet as a matrix. Base R
code does this very effectively:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb1&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb1-1&quot;&gt;&lt;a href=&quot;#cb1-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##Factor levels of identities and builds&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-2&quot;&gt;&lt;a href=&quot;#cb1-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;identities &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;paste0&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;quot;I&amp;quot;&lt;/span&gt;,&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;4&lt;/span&gt;)&lt;/span&gt;
&lt;span id=&quot;cb1-3&quot;&gt;&lt;a href=&quot;#cb1-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;builds &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;paste0&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;quot;B&amp;quot;&lt;/span&gt;,&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;4&lt;/span&gt;)&lt;/span&gt;
&lt;span id=&quot;cb1-4&quot;&gt;&lt;a href=&quot;#cb1-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##Make a matrix containing all levels&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-5&quot;&gt;&lt;a href=&quot;#cb1-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;M &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;expand.grid&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;identity=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;4&lt;/span&gt;,&lt;span class=&quot;at&quot;&gt;build=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;4&lt;/span&gt;,&lt;/span&gt;
&lt;span id=&quot;cb1-6&quot;&gt;&lt;a href=&quot;#cb1-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;                 &lt;span class=&quot;at&quot;&gt;I1=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;,&lt;span class=&quot;at&quot;&gt;I2=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;,&lt;span class=&quot;at&quot;&gt;I3=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;,&lt;span class=&quot;at&quot;&gt;I4=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;,&lt;span class=&quot;at&quot;&gt;B1=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;,&lt;span class=&quot;at&quot;&gt;B2=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;,&lt;span class=&quot;at&quot;&gt;B3=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;,&lt;span class=&quot;at&quot;&gt;B4=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-7&quot;&gt;&lt;a href=&quot;#cb1-7&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;     as.matrix&lt;/span&gt;
&lt;span id=&quot;cb1-8&quot;&gt;&lt;a href=&quot;#cb1-8&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;head&lt;/span&gt;(M,&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;##      identity build I1 I2 I3 I4 B1 B2 B3 B4
## [1,]        1     1  0  0  0  0  0  0  0  0
## [2,]        2     1  0  0  0  0  0  0  0  0&lt;/code&gt;&lt;/pre&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb3&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb3-1&quot;&gt;&lt;a href=&quot;#cb3-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##Subset only to valid configurations&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb3-2&quot;&gt;&lt;a href=&quot;#cb3-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;iRows &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;dv&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;6&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb3-3&quot;&gt;&lt;a href=&quot;#cb3-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;bRows &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;dv&quot;&gt;7&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;10&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb3-4&quot;&gt;&lt;a href=&quot;#cb3-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb3-5&quot;&gt;&lt;a href=&quot;#cb3-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##Player questions about identity or build&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb3-6&quot;&gt;&lt;a href=&quot;#cb3-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;pqI &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; (&lt;span class=&quot;fu&quot;&gt;rowSums&lt;/span&gt;(M[,iRows]) &lt;span class=&quot;sc&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;) &lt;span class=&quot;sc&quot;&gt;&amp;amp;&lt;/span&gt; (&lt;span class=&quot;fu&quot;&gt;rowSums&lt;/span&gt;(M[,bRows]) &lt;span class=&quot;sc&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;)&lt;/span&gt;
&lt;span id=&quot;cb3-7&quot;&gt;&lt;a href=&quot;#cb3-7&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;pqB &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; (&lt;span class=&quot;fu&quot;&gt;rowSums&lt;/span&gt;(M[,iRows]) &lt;span class=&quot;sc&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;) &lt;span class=&quot;sc&quot;&gt;&amp;amp;&lt;/span&gt; (&lt;span class=&quot;fu&quot;&gt;rowSums&lt;/span&gt;(M[,bRows]) &lt;span class=&quot;sc&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;)&lt;/span&gt;
&lt;span id=&quot;cb3-8&quot;&gt;&lt;a href=&quot;#cb3-8&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##Ambassafor questions about identity or build&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb3-9&quot;&gt;&lt;a href=&quot;#cb3-9&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;aqI &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; (&lt;span class=&quot;fu&quot;&gt;rowSums&lt;/span&gt;(M[,iRows]) &lt;span class=&quot;sc&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;) &lt;span class=&quot;sc&quot;&gt;&amp;amp;&lt;/span&gt; (&lt;span class=&quot;fu&quot;&gt;rowSums&lt;/span&gt;(M[,bRows]) &lt;span class=&quot;sc&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;dv&quot;&gt;0&lt;/span&gt;)&lt;/span&gt;
&lt;span id=&quot;cb3-10&quot;&gt;&lt;a href=&quot;#cb3-10&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;aqB &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; (&lt;span class=&quot;fu&quot;&gt;rowSums&lt;/span&gt;(M[,iRows]) &lt;span class=&quot;sc&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;dv&quot;&gt;0&lt;/span&gt;) &lt;span class=&quot;sc&quot;&gt;&amp;amp;&lt;/span&gt; (&lt;span class=&quot;fu&quot;&gt;rowSums&lt;/span&gt;(M[,bRows]) &lt;span class=&quot;sc&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;)&lt;/span&gt;
&lt;span id=&quot;cb3-11&quot;&gt;&lt;a href=&quot;#cb3-11&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb3-12&quot;&gt;&lt;a href=&quot;#cb3-12&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##At least one of the provided information has to be correct,&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb3-13&quot;&gt;&lt;a href=&quot;#cb3-13&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##i.e. I_{k,i_true} or A_{k,b_true} has to be one.&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb3-14&quot;&gt;&lt;a href=&quot;#cb3-14&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;atleast1  &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; (M[&lt;span class=&quot;fu&quot;&gt;cbind&lt;/span&gt;(&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;nrow&lt;/span&gt;(M),M[,&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;]&lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;)] &lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt; M[&lt;span class=&quot;fu&quot;&gt;cbind&lt;/span&gt;(&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;nrow&lt;/span&gt;(M),M[,&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;]&lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;6&lt;/span&gt;)]) &lt;span class=&quot;sc&quot;&gt;&amp;gt;=&lt;/span&gt; &lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb3-15&quot;&gt;&lt;a href=&quot;#cb3-15&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb3-16&quot;&gt;&lt;a href=&quot;#cb3-16&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##Restrict matrix to all valid answers&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb3-17&quot;&gt;&lt;a href=&quot;#cb3-17&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;Mprime &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;data.frame&lt;/span&gt;(M, &lt;span class=&quot;at&quot;&gt;atleast1=&lt;/span&gt;atleast1, &lt;span class=&quot;at&quot;&gt;pqI=&lt;/span&gt;pqI, &lt;span class=&quot;at&quot;&gt;pqB=&lt;/span&gt;pqB, &lt;span class=&quot;at&quot;&gt;aqI=&lt;/span&gt;aqI, &lt;span class=&quot;at&quot;&gt;aqB=&lt;/span&gt;aqB) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb3-18&quot;&gt;&lt;a href=&quot;#cb3-18&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;filter&lt;/span&gt;(pqI &lt;span class=&quot;sc&quot;&gt;|&lt;/span&gt; pqB &lt;span class=&quot;sc&quot;&gt;|&lt;/span&gt; aqI &lt;span class=&quot;sc&quot;&gt;|&lt;/span&gt; aqB)&lt;/span&gt;
&lt;span id=&quot;cb3-19&quot;&gt;&lt;a href=&quot;#cb3-19&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb3-20&quot;&gt;&lt;a href=&quot;#cb3-20&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##Additional column containing the identity build combination&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb3-21&quot;&gt;&lt;a href=&quot;#cb3-21&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;Mprime &lt;span class=&quot;sc&quot;&gt;%&amp;lt;&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;mutate&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;ib=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;paste0&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;quot;I&amp;quot;&lt;/span&gt;,identity,&lt;span class=&quot;st&quot;&gt;&amp;quot;/B&amp;quot;&lt;/span&gt;,build)) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb3-22&quot;&gt;&lt;a href=&quot;#cb3-22&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;select&lt;/span&gt;(ib, &lt;span class=&quot;fu&quot;&gt;everything&lt;/span&gt;())&lt;/span&gt;
&lt;span id=&quot;cb3-23&quot;&gt;&lt;a href=&quot;#cb3-23&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb3-24&quot;&gt;&lt;a href=&quot;#cb3-24&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##Show 3 random rows to get an impression&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb3-25&quot;&gt;&lt;a href=&quot;#cb3-25&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;Mprime[&lt;span class=&quot;fu&quot;&gt;sample&lt;/span&gt;(&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;nrow&lt;/span&gt;(Mprime), &lt;span class=&quot;at&quot;&gt;size=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;3&lt;/span&gt;), ]&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;##        ib identity build I1 I2 I3 I4 B1 B2 B3 B4 atleast1   pqI  pqB   aqI   aqB
## 783 I3/B4        3     4  0  0  1  0  1  0  0  1     TRUE FALSE TRUE FALSE FALSE
## 769 I1/B1        1     1  0  0  1  0  1  0  0  1     TRUE FALSE TRUE FALSE FALSE
## 308 I4/B1        4     1  1  0  0  0  1  1  0  0     TRUE FALSE TRUE FALSE FALSE&lt;/code&gt;&lt;/pre&gt;
&lt;h4 id=&quot;likelihood&quot;&gt;Likelihood&lt;/h4&gt;
&lt;p&gt;Considering the possible answers to a player question and assuming
that the true opponent values are &lt;span
class=&quot;math inline&quot;&gt;\((i,b)\)&lt;/span&gt;, then the opponent for a player
question can choose between one of a total of 15 valid combinations:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Assuming the identity will be correct in the revealed
information,the opponent has to choose one of three remaining identities
for the second information about identity and needs to pick between one
of four builds to report (3*4=12 possible combinations).&lt;/li&gt;
&lt;li&gt;Assuming the build of the revealed information is correct, &lt;em&gt;but
not the identity&lt;/em&gt;, then the opponent has to choose 2 of the 3
remaining identities for the identity part of the revealed information
(&lt;code&gt;choose(3,2)&lt;/code&gt;=3 combinations).&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Hence, the total number of possible valid combinations is 15, that is
the likelihood for each valid combination is 1/15. For a given provided
combination &lt;span class=&quot;math inline&quot;&gt;\(D_k\)&lt;/span&gt; and &lt;span
class=&quot;math inline&quot;&gt;\((i,b)\)&lt;/span&gt; we thus need to check if &lt;span
class=&quot;math inline&quot;&gt;\(D_k\)&lt;/span&gt; is valid given &lt;span
class=&quot;math inline&quot;&gt;\((i,b)\)&lt;/span&gt;. If not the likelihood is zero, if
valid, then the likelihood is 1/15.&lt;/p&gt;
&lt;p&gt;For an ambassador question about identity, the opponent has to choose
their true identity and one of the three other identities, i.e. the
likelihood is easily found to be &lt;span
class=&quot;math inline&quot;&gt;\(1/3\)&lt;/span&gt;, if the opponent is indifferent about
which of the three identities to report back. Altogether, given our own
identity &lt;span class=&quot;math inline&quot;&gt;\((i,b)\)&lt;/span&gt; we thus need to
check if &lt;span class=&quot;math inline&quot;&gt;\(D_k\)&lt;/span&gt; is possible given
&lt;span class=&quot;math inline&quot;&gt;\((i,b)\)&lt;/span&gt;. If this is not the case then
likelihood is zero, otherwise the likelihood is 1/15.&lt;/p&gt;
&lt;h2 id=&quot;likelihood-implementation-in-r&quot;&gt;Likelihood Implementation in
R&lt;/h2&gt;
&lt;p&gt;This is conveniently done using either an &lt;code&gt;apply&lt;/code&gt; to the
rows or – allowing for a more readable way using the column names –
using a &lt;code&gt;dplyr&lt;/code&gt; mutate statement:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb5&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb5-1&quot;&gt;&lt;a href=&quot;#cb5-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##Compute likelihood for each valid answer (assuming indifference between choices)&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb5-2&quot;&gt;&lt;a href=&quot;#cb5-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;Mprime &lt;span class=&quot;sc&quot;&gt;%&amp;lt;&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;mutate&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;prob =&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;if_else&lt;/span&gt;(&lt;span class=&quot;sc&quot;&gt;!&lt;/span&gt;atleast1, &lt;span class=&quot;dv&quot;&gt;0&lt;/span&gt;,&lt;/span&gt;
&lt;span id=&quot;cb5-3&quot;&gt;&lt;a href=&quot;#cb5-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;                                  &lt;span class=&quot;fu&quot;&gt;if_else&lt;/span&gt;(aqI &lt;span class=&quot;sc&quot;&gt;|&lt;/span&gt; aqB, &lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;3&lt;/span&gt;, &lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;15&lt;/span&gt;)))&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3 id=&quot;prior&quot;&gt;Prior&lt;/h3&gt;
&lt;p&gt;The prior distribution consists of the joint prior &lt;span
class=&quot;math inline&quot;&gt;\(P(I=i, B=b)\)&lt;/span&gt; for all 4*4=16 combinations
of identity and build. For easier vector multiplication we flatten the
table into a vector. In the particular game, from which the above
worksheet originates, the player with the worksheet was &lt;span
class=&quot;math inline&quot;&gt;\(I=4\)&lt;/span&gt; and &lt;span
class=&quot;math inline&quot;&gt;\(B=2\)&lt;/span&gt;, hence, we assign these states the
probability zero.&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb6&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb6-1&quot;&gt;&lt;a href=&quot;#cb6-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##Factor levels of identities and builds&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb6-2&quot;&gt;&lt;a href=&quot;#cb6-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;identities &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;paste0&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;quot;I&amp;quot;&lt;/span&gt;,&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;4&lt;/span&gt;)&lt;/span&gt;
&lt;span id=&quot;cb6-3&quot;&gt;&lt;a href=&quot;#cb6-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;builds &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;paste0&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;quot;B&amp;quot;&lt;/span&gt;,&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;4&lt;/span&gt;)&lt;/span&gt;
&lt;span id=&quot;cb6-4&quot;&gt;&lt;a href=&quot;#cb6-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##Generate levels of joint table of identity and build&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb6-5&quot;&gt;&lt;a href=&quot;#cb6-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;ib_combs &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;as.character&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;outer&lt;/span&gt;(identities, builds, paste, &lt;span class=&quot;at&quot;&gt;sep=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;/&amp;quot;&lt;/span&gt;))&lt;/span&gt;
&lt;span id=&quot;cb6-6&quot;&gt;&lt;a href=&quot;#cb6-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##Generate joint table based on player&amp;#39;s identity&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb6-7&quot;&gt;&lt;a href=&quot;#cb6-7&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;prior &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;structure&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;as.numeric&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;outer&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;c&lt;/span&gt;(&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;3&lt;/span&gt;,&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;3&lt;/span&gt;,&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;3&lt;/span&gt;,&lt;span class=&quot;dv&quot;&gt;0&lt;/span&gt;), &lt;span class=&quot;fu&quot;&gt;c&lt;/span&gt;(&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;3&lt;/span&gt;,&lt;span class=&quot;dv&quot;&gt;0&lt;/span&gt;,&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;3&lt;/span&gt;,&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;3&lt;/span&gt;))),&lt;span class=&quot;at&quot;&gt;names=&lt;/span&gt;ib_combs)&lt;/span&gt;
&lt;span id=&quot;cb6-8&quot;&gt;&lt;a href=&quot;#cb6-8&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;prior&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;##     I1/B1     I2/B1     I3/B1     I4/B1     I1/B2     I2/B2     I3/B2     I4/B2     I1/B3 
## 0.1111111 0.1111111 0.1111111 0.0000000 0.0000000 0.0000000 0.0000000 0.0000000 0.1111111 
##     I2/B3     I3/B3     I4/B3     I1/B4     I2/B4     I3/B4     I4/B4 
## 0.1111111 0.1111111 0.0000000 0.1111111 0.1111111 0.1111111 0.0000000&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Furthermore, we create a small helper function
&lt;code&gt;p_marginal&lt;/code&gt; allowing us to compute the marginal
distributions of identity and build, respectively, from the joint
distribution. That is &lt;span class=&quot;math inline&quot;&gt;\(P(I=i)=\sum_{b=1}^4
P(i,b)\)&lt;/span&gt; and &lt;span class=&quot;math inline&quot;&gt;\(P(B=b)=\sum_{i=1}^4
P(i,b)\)&lt;/span&gt;.&lt;/p&gt;
&lt;p&gt;This allows us to compute:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb8&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb8-1&quot;&gt;&lt;a href=&quot;#cb8-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;p_marginal&lt;/span&gt;(prior, &lt;span class=&quot;at&quot;&gt;what=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;I&amp;quot;&lt;/span&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;##        I1        I2        I3        I4 
## 0.3333333 0.3333333 0.3333333 0.0000000&lt;/code&gt;&lt;/pre&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb10&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb10-1&quot;&gt;&lt;a href=&quot;#cb10-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;p_marginal&lt;/span&gt;(prior, &lt;span class=&quot;at&quot;&gt;what=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;B&amp;quot;&lt;/span&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;##        B1        B2        B3        B4 
## 0.3333333 0.0000000 0.3333333 0.3333333&lt;/code&gt;&lt;/pre&gt;
&lt;h3 id=&quot;posterior&quot;&gt;Posterior&lt;/h3&gt;
&lt;p&gt;For &lt;span class=&quot;math inline&quot;&gt;\(i=1,\ldots, 4\)&lt;/span&gt; and &lt;span
class=&quot;math inline&quot;&gt;\(b=1,...,4\)&lt;/span&gt; we can compute the posterior
distribution using Bayes’ theorem: &lt;span class=&quot;math display&quot;&gt;\[
\begin{align*}
P(I=i,B=b\&amp;gt;|\&amp;gt;D_k) &amp;amp;=
\frac{P(D_k|\&amp;gt;I=i,B=b)P(I=i,B=b)}{P(D_k)} \\
&amp;amp;=
\frac{P(D_k|\&amp;gt; I=i,B=b)P(I=i,B=b)}{\sum_{j=1}^4 \sum_{c=1}^4
P(D_k|\&amp;gt;
I=j,B=c)P(I=j,B=c)}.
\end{align*}
\]&lt;/span&gt; In code:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb12&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb12-1&quot;&gt;&lt;a href=&quot;#cb12-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;#############################################################&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb12-2&quot;&gt;&lt;a href=&quot;#cb12-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;## Function for sequentially updating the state information&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb12-3&quot;&gt;&lt;a href=&quot;#cb12-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;############################################################&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb12-4&quot;&gt;&lt;a href=&quot;#cb12-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;update &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;cf&quot;&gt;function&lt;/span&gt;(prior, Dk) {&lt;/span&gt;
&lt;span id=&quot;cb12-5&quot;&gt;&lt;a href=&quot;#cb12-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;do&quot;&gt;##Sanity check&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb12-6&quot;&gt;&lt;a href=&quot;#cb12-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;stopifnot&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;names&lt;/span&gt;(prior) &lt;span class=&quot;sc&quot;&gt;==&lt;/span&gt; ib_combs)&lt;/span&gt;
&lt;span id=&quot;cb12-7&quot;&gt;&lt;a href=&quot;#cb12-7&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb12-8&quot;&gt;&lt;a href=&quot;#cb12-8&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;do&quot;&gt;##Configurations matching the observed data Dk&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb12-9&quot;&gt;&lt;a href=&quot;#cb12-9&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  idx &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;apply&lt;/span&gt;(Mprime[, &lt;span class=&quot;fu&quot;&gt;grep&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;quot;I+|B+&amp;quot;&lt;/span&gt;, &lt;span class=&quot;fu&quot;&gt;names&lt;/span&gt;(Mprime))], &lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;, &lt;span class=&quot;cf&quot;&gt;function&lt;/span&gt;(x) &lt;span class=&quot;fu&quot;&gt;all&lt;/span&gt;(x&lt;span class=&quot;sc&quot;&gt;==&lt;/span&gt;Dk))&lt;/span&gt;
&lt;span id=&quot;cb12-10&quot;&gt;&lt;a href=&quot;#cb12-10&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb12-11&quot;&gt;&lt;a href=&quot;#cb12-11&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;do&quot;&gt;##Extract likelihood and put it in same order as the ib_combs vector&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb12-12&quot;&gt;&lt;a href=&quot;#cb12-12&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;do&quot;&gt;##for prior and likelihood vectors to match in order of the entries&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb12-13&quot;&gt;&lt;a href=&quot;#cb12-13&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  vector_idx &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;pmatch&lt;/span&gt;(ib_combs, Mprime[idx,]&lt;span class=&quot;sc&quot;&gt;$&lt;/span&gt;ib)&lt;/span&gt;
&lt;span id=&quot;cb12-14&quot;&gt;&lt;a href=&quot;#cb12-14&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  lik &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; (Mprime[idx,]&lt;span class=&quot;sc&quot;&gt;$&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;prob&amp;quot;&lt;/span&gt;)[vector_idx]&lt;/span&gt;
&lt;span id=&quot;cb12-15&quot;&gt;&lt;a href=&quot;#cb12-15&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb12-16&quot;&gt;&lt;a href=&quot;#cb12-16&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;do&quot;&gt;##Compute P(I=i,B=b|D_k), i.e. our updated belief&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb12-17&quot;&gt;&lt;a href=&quot;#cb12-17&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  belief &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; lik &lt;span class=&quot;sc&quot;&gt;*&lt;/span&gt; prior &lt;span class=&quot;sc&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;sum&lt;/span&gt;(lik &lt;span class=&quot;sc&quot;&gt;*&lt;/span&gt; prior)&lt;/span&gt;
&lt;span id=&quot;cb12-18&quot;&gt;&lt;a href=&quot;#cb12-18&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;return&lt;/span&gt;(belief)&lt;/span&gt;
&lt;span id=&quot;cb12-19&quot;&gt;&lt;a href=&quot;#cb12-19&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;We use the data from the above shown worksheet, combine it with our
prior and thus update our belief of which identity and build the
opponent has.&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb13&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb13-1&quot;&gt;&lt;a href=&quot;#cb13-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##The three data lines of the worksheet&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb13-2&quot;&gt;&lt;a href=&quot;#cb13-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;D &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;bind_rows&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;data.frame&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;I1=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;,&lt;span class=&quot;at&quot;&gt;I2=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;0&lt;/span&gt;,&lt;span class=&quot;at&quot;&gt;I3=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;0&lt;/span&gt;,&lt;span class=&quot;at&quot;&gt;I4=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;0&lt;/span&gt;,&lt;span class=&quot;at&quot;&gt;B1=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;0&lt;/span&gt;,&lt;span class=&quot;at&quot;&gt;B2=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;,&lt;span class=&quot;at&quot;&gt;B3=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;,&lt;span class=&quot;at&quot;&gt;B4=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;0&lt;/span&gt;),&lt;/span&gt;
&lt;span id=&quot;cb13-3&quot;&gt;&lt;a href=&quot;#cb13-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;               &lt;span class=&quot;fu&quot;&gt;data.frame&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;I1=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;0&lt;/span&gt;,&lt;span class=&quot;at&quot;&gt;I2=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;0&lt;/span&gt;,&lt;span class=&quot;at&quot;&gt;I3=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;0&lt;/span&gt;,&lt;span class=&quot;at&quot;&gt;I4=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;0&lt;/span&gt;,&lt;span class=&quot;at&quot;&gt;B1=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;0&lt;/span&gt;,&lt;span class=&quot;at&quot;&gt;B2=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;0&lt;/span&gt;,&lt;span class=&quot;at&quot;&gt;B3=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;,&lt;span class=&quot;at&quot;&gt;B4=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;),&lt;/span&gt;
&lt;span id=&quot;cb13-4&quot;&gt;&lt;a href=&quot;#cb13-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;               &lt;span class=&quot;fu&quot;&gt;data.frame&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;I1=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;,&lt;span class=&quot;at&quot;&gt;I2=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;,&lt;span class=&quot;at&quot;&gt;I3=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;0&lt;/span&gt;,&lt;span class=&quot;at&quot;&gt;I4=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;0&lt;/span&gt;,&lt;span class=&quot;at&quot;&gt;B1=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;0&lt;/span&gt;,&lt;span class=&quot;at&quot;&gt;B2=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;0&lt;/span&gt;,&lt;span class=&quot;at&quot;&gt;B3=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;,&lt;span class=&quot;at&quot;&gt;B4=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;0&lt;/span&gt;))&lt;/span&gt;
&lt;span id=&quot;cb13-5&quot;&gt;&lt;a href=&quot;#cb13-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb13-6&quot;&gt;&lt;a href=&quot;#cb13-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##Sequential belief updating (we use a version using pipes)&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb13-7&quot;&gt;&lt;a href=&quot;#cb13-7&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;prior &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;update&lt;/span&gt;(D[&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;,]) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;update&lt;/span&gt;(D[&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;,]) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;update&lt;/span&gt;(D[&lt;span class=&quot;dv&quot;&gt;3&lt;/span&gt;,]) &lt;span class=&quot;ot&quot;&gt;-&amp;gt;&lt;/span&gt; belief&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;The above way of piping is a nice way to illustrate the sequential
aspect of the inference!&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb14&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb14-1&quot;&gt;&lt;a href=&quot;#cb14-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##Show results&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb14-2&quot;&gt;&lt;a href=&quot;#cb14-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;p_marginal&lt;/span&gt;(belief, &lt;span class=&quot;at&quot;&gt;what=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;I&amp;quot;&lt;/span&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;##   I1   I2   I3   I4 
## 0.50 0.25 0.25 0.00&lt;/code&gt;&lt;/pre&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb16&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb16-1&quot;&gt;&lt;a href=&quot;#cb16-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;p_marginal&lt;/span&gt;(belief, &lt;span class=&quot;at&quot;&gt;what=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;B&amp;quot;&lt;/span&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;##   B1   B2   B3   B4 
## 0.00 0.00 0.75 0.25&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Based on these results we are somewhat certain that the player has
identity 1, i.e. is Lord Fiddlebottom, and has build 3, i.e. is the fat
figure. The belief update can also be visualized as shown below for
identity.&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/blog/figure/source/2018-04-03-inkognito/PLOTBELIEF-1.png&quot; style=&quot;display: block; margin: auto;&quot; /&gt;&lt;/p&gt;
&lt;h2 id=&quot;discussion&quot;&gt;Discussion&lt;/h2&gt;
&lt;p&gt;After the end of the particular game the above worksheet is from, it
turned out that the opponent was &lt;span
class=&quot;math inline&quot;&gt;\(I=1\)&lt;/span&gt; and &lt;span
class=&quot;math inline&quot;&gt;\(B=4\)&lt;/span&gt;. Altogether, the opponent was not too
impressed by the decision support provided by this post: That identity 1
was most likely appears natural when simply counting the number of
crosses for this identity on the worksheet. Same goes for the build,
however, she was deliberately attempting to fool the player by providing
the impression that she was build 3. As always with statistics,
heuristics can take you part of the way, however, simply counting
crosses would for example not reveal that identity 3 still also is an
option. Furthermore, the slyness of misinformation is not handled by the
combinatorical approach towards calculating the likelihood, because it
is assumed that every valid choice is equally likely. To this end, more
games need to be played in order to learn the opponent’s confusion
strategy and adapt the probabilities to reflect these strategies.
Finally, in longer games, one would have answers from several opponents
and this would be combined in one model, because knowing opponent 1 is
Lord Fiddlebotom certainly also helps to rule out some options for
opponent 2.&lt;/p&gt;
&lt;p&gt;So what is next: If time permits, a shiny app allowing the user to
fill in their worksheet and calculate and visualize the subsequent
belief about each opponent’s identity and build.&lt;/p&gt;
</description>
        <pubDate>Tue, 03 Apr 2018 00:00:00 +0200</pubDate>
        <link>https://mhoehle.github.io/blog/2018/04/03/inkognito.html</link>
        <guid isPermaLink="true">https://mhoehle.github.io/blog/2018/04/03/inkognito.html</guid>
        
        <category>rstats</category>
        
        <category>stats</category>
        
        <category>quality</category>
        
        
      </item>
    
      <item>
        <title>Pair Programming Statistical Analyses</title>
        <description>&lt;h2 id=&quot;abstract&quot;&gt;Abstract&lt;/h2&gt;
&lt;p&gt;Control calculation ping-pong is the process of iteratively improving
a statistical analysis by comparing results from two independent
analysis approaches until agreement. We use the &lt;code&gt;daff&lt;/code&gt;
package to simplify the comparison of the two results and illustrate its
use by a case study with two statisticians ping-ponging an analysis
using dplyr and SQL, respectively.&lt;/p&gt;
&lt;center&gt;
&lt;img
src=&quot;/blog/figure/source/2017-09-02-pairprogramming/pingpong.png&quot; /&gt;
&lt;/center&gt;
&lt;p&gt;&lt;br&gt; &lt;FONT COLOR=&quot;bbbbbb&quot;&gt;Clip art is based on work by &lt;a
href=&quot;https://thenounproject.com/term/ping-pong/655102/&quot;&gt;Gan Khoon
Lay&lt;/a&gt; available under a CC BY 3.0 US license.&lt;/FONT&gt;&lt;/p&gt;
&lt;p&gt;&lt;br&gt;
&lt;a rel=&quot;license&quot; href=&quot;http://creativecommons.org/licenses/by-sa/4.0/&quot;&gt;&lt;img alt=&quot;Creative Commons License&quot; style=&quot;border-width:0&quot; src=&quot;https://i.creativecommons.org/l/by-sa/4.0/88x31.png&quot;/&gt;&lt;/a&gt;
This work is licensed under a &lt;a rel=&quot;license&quot;
href=&quot;http://creativecommons.org/licenses/by-sa/4.0/&quot;&gt;Creative Commons
Attribution-ShareAlike 4.0 International License&lt;/a&gt;. The
markdown+Rknitr source code of this blog is available under a &lt;a
href=&quot;https://www.gnu.org/licenses/gpl-3.0.html&quot;&gt;GNU General Public
License (GPL v3)&lt;/a&gt; license from github.&lt;/p&gt;
&lt;h2 id=&quot;introduction&quot;&gt;Introduction&lt;/h2&gt;
&lt;p&gt;If you are a statistician working in climate science, data driven
journalism, official statistics, public health, economics or any related
field working with &lt;em&gt;real&lt;/em&gt; data, chances are that you have to
perform analyses, where you know there is zero tolerance for errors. The
easiest way to ensure the correctness of such an analysis is to check
your results over and over again (the &lt;strong&gt;iterated 2-eye
principle&lt;/strong&gt;). A better approach is to pair-program the analysis
by either having a colleague read through your code (the &lt;strong&gt;4-eye
principle&lt;/strong&gt;) or have a skilled colleague completely redo your
analysis from scratch using her favorite toolchain (the
&lt;strong&gt;2-mindset principle&lt;/strong&gt;). Structured software development
in the form of, e.g. version control and unit tests, provides valuable
inspiration on how to ensure the quality of your code. However, when it
comes to pair-programming analyses, surprisingly many steps remain
manual. The &lt;code&gt;daff&lt;/code&gt; package provides the equivalent of a
&lt;code&gt;diff&lt;/code&gt; statement on data frames and we shall illustrate its
use by automatizing the comparison step of the control calculation
ping-pong process.&lt;/p&gt;
&lt;h2 id=&quot;the-case-story&quot;&gt;The Case Story&lt;/h2&gt;
&lt;p&gt;Ada and Bob have to calculate their country’s quadrennial official
statistics on the total income and number of employed people in &lt;a
href=&quot;https://www.destatis.de/DE/Publikationen/Qualitaetsberichte/Dienstleistungen/SonstDienstleistungsbereiche2010.pdf?__blob=publicationFile&quot;&gt;fitness
centers&lt;/a&gt;. A sample of fitness centers is asked to fill out a
questionnaire containing their yearly sales volume, staff costs and
number of employees. The present exposition will for the sake of
convenience ignore the complex survey part of the problem and just
pretend that the sample corresponds to the population (complete
inventory count).&lt;/p&gt;
&lt;h3 id=&quot;the-data&quot;&gt;The Data&lt;/h3&gt;
&lt;p&gt;After the questionnaire phase, the following data are available to
Ada and Bob.&lt;/p&gt;
&lt;table class=&quot;table table-striped&quot; style=&quot;margin-left: auto; margin-right: auto;&quot;&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th style=&quot;text-align:left;&quot;&gt;
Id
&lt;/th&gt;
&lt;th style=&quot;text-align:right;&quot;&gt;
Version
&lt;/th&gt;
&lt;th style=&quot;text-align:left;&quot;&gt;
Region
&lt;/th&gt;
&lt;th style=&quot;text-align:right;&quot;&gt;
Sales Volume
&lt;/th&gt;
&lt;th style=&quot;text-align:right;&quot;&gt;
Staff Costs
&lt;/th&gt;
&lt;th style=&quot;text-align:right;&quot;&gt;
People
&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:left;&quot;&gt;
01
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
1
&lt;/td&gt;
&lt;td style=&quot;text-align:left;&quot;&gt;
A
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
23000
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
10003
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
5
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:left;&quot;&gt;
02
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
1
&lt;/td&gt;
&lt;td style=&quot;text-align:left;&quot;&gt;
B
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
12200
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
7200
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
1
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:left;&quot;&gt;
03
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
1
&lt;/td&gt;
&lt;td style=&quot;text-align:left;&quot;&gt;
NA
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
19500
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
7609
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
2
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:left;&quot;&gt;
04
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
1
&lt;/td&gt;
&lt;td style=&quot;text-align:left;&quot;&gt;
A
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
17500
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
13000
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
3
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:left;&quot;&gt;
05
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
1
&lt;/td&gt;
&lt;td style=&quot;text-align:left;&quot;&gt;
B
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
119500
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
90000
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
NA
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:left;&quot;&gt;
05
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
2
&lt;/td&gt;
&lt;td style=&quot;text-align:left;&quot;&gt;
B
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
119500
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
95691
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
19
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:left;&quot;&gt;
06
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
1
&lt;/td&gt;
&lt;td style=&quot;text-align:left;&quot;&gt;
B
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
NA
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
19990
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
6
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:left;&quot;&gt;
07
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
1
&lt;/td&gt;
&lt;td style=&quot;text-align:left;&quot;&gt;
A
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
19123
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
20100
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
8
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:left;&quot;&gt;
08
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
1
&lt;/td&gt;
&lt;td style=&quot;text-align:left;&quot;&gt;
D
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
25000
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
100
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
NA
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:left;&quot;&gt;
09
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
1
&lt;/td&gt;
&lt;td style=&quot;text-align:left;&quot;&gt;
D
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
45860
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
32555
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
9
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:left;&quot;&gt;
10
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
1
&lt;/td&gt;
&lt;td style=&quot;text-align:left;&quot;&gt;
E
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
33020
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
25010
&lt;/td&gt;
&lt;td style=&quot;text-align:right;&quot;&gt;
7
&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;Here &lt;code&gt;Id&lt;/code&gt; denotes the unique identifier of the sampled
fitness center, &lt;code&gt;Version&lt;/code&gt; indicates the version of a center’s
questionnaire and &lt;code&gt;Region&lt;/code&gt; denotes the region in which the
center is located. In case a center’s questionnaire lacks information or
has inconsistent information, the protocol is to get back to the center
and have it send a revised questionnaire. All Ada and Bob now need to do
is aggregate the data per region in order to obtain region stratified
estimates of:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;the overall number of fitness centres&lt;/li&gt;
&lt;li&gt;total sales volume&lt;/li&gt;
&lt;li&gt;total staff cost&lt;/li&gt;
&lt;li&gt;total number of people employed in fitness centres&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;However, the analysis protocol instructs that only fitness centers
with an annual sales volume larger than or equal to €17,500 are to be
included in the analysis. Furthermore, if missing values occur, they are
to be ignored in the summations. Since a lot of muscle will be angered
in case of errors, Ada and Bob agree on following the 2-mindset
procedure and meet after an hour to discuss their results. Here is what
each of them came up with.&lt;/p&gt;
&lt;h3 id=&quot;ada&quot;&gt;Ada&lt;/h3&gt;
&lt;p&gt;Ada loves the tidyverse and in particular &lt;code&gt;dplyr&lt;/code&gt;. This is
her solution:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb1&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb1-1&quot;&gt;&lt;a href=&quot;#cb1-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;ada &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; fitness &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;na.omit&lt;/span&gt;() &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;group_by&lt;/span&gt;(Region,Id) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;top_n&lt;/span&gt;(&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;,Version) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-2&quot;&gt;&lt;a href=&quot;#cb1-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;group_by&lt;/span&gt;(Region) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-3&quot;&gt;&lt;a href=&quot;#cb1-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;filter&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;at&quot;&gt;Sales Volume&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;`&lt;/span&gt; &lt;span class=&quot;sc&quot;&gt;&amp;gt;=&lt;/span&gt; &lt;span class=&quot;dv&quot;&gt;17500&lt;/span&gt;) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-4&quot;&gt;&lt;a href=&quot;#cb1-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;summarise&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;at&quot;&gt;NoOfUnits&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;ot&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;n&lt;/span&gt;(),&lt;/span&gt;
&lt;span id=&quot;cb1-5&quot;&gt;&lt;a href=&quot;#cb1-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;            &lt;span class=&quot;st&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;at&quot;&gt;Sales Volume&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;ot&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;sum&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;at&quot;&gt;Sales Volume&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;`&lt;/span&gt;),&lt;/span&gt;
&lt;span id=&quot;cb1-6&quot;&gt;&lt;a href=&quot;#cb1-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;            &lt;span class=&quot;st&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;at&quot;&gt;Staff Costs&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;ot&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;sum&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;at&quot;&gt;Staff Costs&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;`&lt;/span&gt;),&lt;/span&gt;
&lt;span id=&quot;cb1-7&quot;&gt;&lt;a href=&quot;#cb1-7&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;            &lt;span class=&quot;at&quot;&gt;People=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;sum&lt;/span&gt;(People))&lt;/span&gt;
&lt;span id=&quot;cb1-8&quot;&gt;&lt;a href=&quot;#cb1-8&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;ada&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;## # A tibble: 4 x 5
##   Region NoOfUnits `Sales Volume` `Staff Costs` People
##   &amp;lt;chr&amp;gt;      &amp;lt;int&amp;gt;          &amp;lt;int&amp;gt;         &amp;lt;int&amp;gt;  &amp;lt;int&amp;gt;
## 1 A              3          59623         43103     16
## 2 B              1         119500         95691     19
## 3 D              1          45860         32555      9
## 4 E              1          33020         25010      7&lt;/code&gt;&lt;/pre&gt;
&lt;h3 id=&quot;bob&quot;&gt;Bob&lt;/h3&gt;
&lt;p&gt;Bob has a dark past as a relational database management system
(RDBMS) developer and, hence, only recently experienced the joys of R.
He therefore chooses a no-SQL-server-necessary &lt;a
href=&quot;https://www.r-bloggers.com/r-and-sqlite-part-1/&quot;&gt;&lt;code&gt;SQLite&lt;/code&gt;
within R&lt;/a&gt; approach. The hope is that in big data situation this might
be a little more speedy than base R:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb3&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb3-1&quot;&gt;&lt;a href=&quot;#cb3-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;library&lt;/span&gt;(RSQLite)&lt;/span&gt;
&lt;span id=&quot;cb3-2&quot;&gt;&lt;a href=&quot;#cb3-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;## Create ad-hoc database&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb3-3&quot;&gt;&lt;a href=&quot;#cb3-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;db &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;dbConnect&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;SQLite&lt;/span&gt;(), &lt;span class=&quot;at&quot;&gt;dbname =&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;file.path&lt;/span&gt;(filePath,&lt;span class=&quot;st&quot;&gt;&amp;quot;Test.sqlite&amp;quot;&lt;/span&gt;))&lt;/span&gt;
&lt;span id=&quot;cb3-4&quot;&gt;&lt;a href=&quot;#cb3-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##Move fitness data into the ad-hoc DB&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb3-5&quot;&gt;&lt;a href=&quot;#cb3-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;dbWriteTable&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;conn =&lt;/span&gt; db, &lt;span class=&quot;at&quot;&gt;name =&lt;/span&gt; &lt;span class=&quot;st&quot;&gt;&amp;quot;fitness&amp;quot;&lt;/span&gt;, fitness, &lt;span class=&quot;at&quot;&gt;overwrite=&lt;/span&gt;&lt;span class=&quot;cn&quot;&gt;TRUE&lt;/span&gt;, &lt;span class=&quot;at&quot;&gt;row.names=&lt;/span&gt;&lt;span class=&quot;cn&quot;&gt;FALSE&lt;/span&gt;)&lt;/span&gt;
&lt;span id=&quot;cb3-6&quot;&gt;&lt;a href=&quot;#cb3-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##Query using SQL&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb3-7&quot;&gt;&lt;a href=&quot;#cb3-7&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;bob &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;dbGetQuery&lt;/span&gt;(db, &lt;span class=&quot;st&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb3-8&quot;&gt;&lt;a href=&quot;#cb3-8&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;st&quot;&gt;    SELECT Region,&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb3-9&quot;&gt;&lt;a href=&quot;#cb3-9&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;st&quot;&gt;           COUNT(*) As NoOfUnits,&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb3-10&quot;&gt;&lt;a href=&quot;#cb3-10&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;st&quot;&gt;           SUM([Sales Volume]) As [Sales Volume],&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb3-11&quot;&gt;&lt;a href=&quot;#cb3-11&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;st&quot;&gt;           SUM([Staff Costs]) AS [Staff Costs],&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb3-12&quot;&gt;&lt;a href=&quot;#cb3-12&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;st&quot;&gt;           SUM(People) AS People&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb3-13&quot;&gt;&lt;a href=&quot;#cb3-13&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;st&quot;&gt;    FROM fitness&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb3-14&quot;&gt;&lt;a href=&quot;#cb3-14&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;st&quot;&gt;    WHERE [Sales Volume] &amp;gt; 17500 GROUP BY Region&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb3-15&quot;&gt;&lt;a href=&quot;#cb3-15&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;&lt;/span&gt;)&lt;/span&gt;
&lt;span id=&quot;cb3-16&quot;&gt;&lt;a href=&quot;#cb3-16&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;bob&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;##   Region NoOfUnits Sales Volume Staff Costs People
## 1   &amp;lt;NA&amp;gt;         1        19500        7609      2
## 2      A         2        42123       30103     13
## 3      B         2       239000      185691     19
## 4      D         2        70860       32655      9
## 5      E         1        33020       25010      7&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;em&gt;Update&lt;/em&gt;: An alternative approach with less syntactic overhead
would have been the &lt;a
href=&quot;https://github.com/ggrothendieck/sqldf&quot;&gt;&lt;code&gt;sqldf&lt;/code&gt;&lt;/a&gt;
package, which has a standard SQLite backend and automagically handles
the import of the &lt;code&gt;data.frame&lt;/code&gt; into the DB using the
&lt;code&gt;RSQLite&lt;/code&gt; pkg.&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb5&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb5-1&quot;&gt;&lt;a href=&quot;#cb5-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##Load package&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb5-2&quot;&gt;&lt;a href=&quot;#cb5-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;suppressPackageStartupMessages&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;library&lt;/span&gt;(sqldf))&lt;/span&gt;
&lt;span id=&quot;cb5-3&quot;&gt;&lt;a href=&quot;#cb5-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##Ensure SQLite backend.&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb5-4&quot;&gt;&lt;a href=&quot;#cb5-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;options&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;sqldf.driver =&lt;/span&gt; &lt;span class=&quot;st&quot;&gt;&amp;quot;SQLite&amp;quot;&lt;/span&gt;)&lt;/span&gt;
&lt;span id=&quot;cb5-5&quot;&gt;&lt;a href=&quot;#cb5-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##Same query as before&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb5-6&quot;&gt;&lt;a href=&quot;#cb5-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;bob &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;sqldf&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb5-7&quot;&gt;&lt;a href=&quot;#cb5-7&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;st&quot;&gt;    SELECT Region,&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb5-8&quot;&gt;&lt;a href=&quot;#cb5-8&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;st&quot;&gt;           COUNT(*) As NoOfUnits,&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb5-9&quot;&gt;&lt;a href=&quot;#cb5-9&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;st&quot;&gt;           SUM([Sales Volume]) As [Sales Volume],&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb5-10&quot;&gt;&lt;a href=&quot;#cb5-10&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;st&quot;&gt;           SUM([Staff Costs]) AS [Staff Costs],&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb5-11&quot;&gt;&lt;a href=&quot;#cb5-11&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;st&quot;&gt;           SUM(People) AS People&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb5-12&quot;&gt;&lt;a href=&quot;#cb5-12&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;st&quot;&gt;    FROM fitness&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb5-13&quot;&gt;&lt;a href=&quot;#cb5-13&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;st&quot;&gt;    WHERE [Sales Volume] &amp;gt; 17500 GROUP BY Region&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb5-14&quot;&gt;&lt;a href=&quot;#cb5-14&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;&lt;/span&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Even shorter is the &lt;a
href=&quot;https://twitter.com/zevross/status/895663618158501888&quot;&gt;direct use
of SQL chunks&lt;/a&gt; in knitr using the variable &lt;code&gt;db&lt;/code&gt; as
connection and using the chunk argument &lt;code&gt;output.var=bob&lt;/code&gt;:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb6&quot;&gt;&lt;pre
class=&quot;sourceCode sql&quot;&gt;&lt;code class=&quot;sourceCode sql&quot;&gt;&lt;span id=&quot;cb6-1&quot;&gt;&lt;a href=&quot;#cb6-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kw&quot;&gt;SELECT&lt;/span&gt; Region,&lt;/span&gt;
&lt;span id=&quot;cb6-2&quot;&gt;&lt;a href=&quot;#cb6-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;       &lt;span class=&quot;fu&quot;&gt;COUNT&lt;/span&gt;(&lt;span class=&quot;op&quot;&gt;*&lt;/span&gt;) &lt;span class=&quot;kw&quot;&gt;As&lt;/span&gt; NoOfUnits,&lt;/span&gt;
&lt;span id=&quot;cb6-3&quot;&gt;&lt;a href=&quot;#cb6-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;       &lt;span class=&quot;fu&quot;&gt;SUM&lt;/span&gt;([Sales Volume]) &lt;span class=&quot;kw&quot;&gt;As&lt;/span&gt; [Sales Volume],&lt;/span&gt;
&lt;span id=&quot;cb6-4&quot;&gt;&lt;a href=&quot;#cb6-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;       &lt;span class=&quot;fu&quot;&gt;SUM&lt;/span&gt;([Staff Costs]) &lt;span class=&quot;kw&quot;&gt;AS&lt;/span&gt; [Staff Costs],&lt;/span&gt;
&lt;span id=&quot;cb6-5&quot;&gt;&lt;a href=&quot;#cb6-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;       &lt;span class=&quot;fu&quot;&gt;SUM&lt;/span&gt;(People) &lt;span class=&quot;kw&quot;&gt;AS&lt;/span&gt; People&lt;/span&gt;
&lt;span id=&quot;cb6-6&quot;&gt;&lt;a href=&quot;#cb6-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kw&quot;&gt;FROM&lt;/span&gt; fitness&lt;/span&gt;
&lt;span id=&quot;cb6-7&quot;&gt;&lt;a href=&quot;#cb6-7&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kw&quot;&gt;WHERE&lt;/span&gt; [Sales Volume] &lt;span class=&quot;op&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;dv&quot;&gt;17500&lt;/span&gt; &lt;span class=&quot;kw&quot;&gt;GROUP&lt;/span&gt; &lt;span class=&quot;kw&quot;&gt;BY&lt;/span&gt; Region&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3 id=&quot;the-ping-pong-phase&quot;&gt;The Ping-Pong Phase&lt;/h3&gt;
&lt;p&gt;After Ada and Bob each have a result, they compare their resulting
&lt;code&gt;data.frame&lt;/code&gt; using the &lt;a
href=&quot;https://cran.r-project.org/web/packages/daff/index.html&quot;&gt;&lt;code&gt;daff&lt;/code&gt;&lt;/a&gt;
package, which was recently presented by &lt;a
href=&quot;https://twitter.com/edwindjonge&quot;&gt;@edwindjonge&lt;/a&gt; at the &lt;a
href=&quot;https://channel9.msdn.com/Events/useR-international-R-User-conferences/useR-International-R-User-2017-Conference/Daff-diff-patch-and-merge-for-dataframes&quot;&gt;useR!
2017 conference&lt;/a&gt;.&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb7&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb7-1&quot;&gt;&lt;a href=&quot;#cb7-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;library&lt;/span&gt;(daff)&lt;/span&gt;
&lt;span id=&quot;cb7-2&quot;&gt;&lt;a href=&quot;#cb7-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;diff &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;diff_data&lt;/span&gt;(ada, bob)&lt;/span&gt;
&lt;span id=&quot;cb7-3&quot;&gt;&lt;a href=&quot;#cb7-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;diff&lt;span class=&quot;sc&quot;&gt;$&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;get_data&lt;/span&gt;()&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;##    @@ Region NoOfUnits   Sales Volume   Staff Costs People
## 1 +++   &amp;lt;NA&amp;gt;         1          19500          7609      2
## 2  -&amp;gt;      A      3-&amp;gt;2   59623-&amp;gt;42123  43103-&amp;gt;30103 16-&amp;gt;13
## 3  -&amp;gt;      B      1-&amp;gt;2 119500-&amp;gt;239000 95691-&amp;gt;185691     19
## 4  -&amp;gt;      D      1-&amp;gt;2   45860-&amp;gt;70860  32555-&amp;gt;32655      9
## 5          E         1          33020         25010      7&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;After Ada’s and Bob’s serve, the two realize that their results just
agree for the region E.&lt;/p&gt;
&lt;p&gt;&lt;em&gt;Note&lt;/em&gt;: Currently, &lt;code&gt;daff&lt;/code&gt; has the semi-annoying
feature of not being able to show all the diffs when printing, but just
&lt;code&gt;n&lt;/code&gt; lines of the head and tail. As a consequence, for the
purpose of this post, we overwrite the printing function such that it
always shows all rows with differences.&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb9&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb9-1&quot;&gt;&lt;a href=&quot;#cb9-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##Small helper function for better printing&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb9-2&quot;&gt;&lt;a href=&quot;#cb9-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;print.data_diff &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;cf&quot;&gt;function&lt;/span&gt;(x) x&lt;span class=&quot;sc&quot;&gt;$&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;get_data&lt;/span&gt;() &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;filter&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;at&quot;&gt;@@&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;`&lt;/span&gt; &lt;span class=&quot;sc&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;st&quot;&gt;&amp;quot;&amp;quot;&lt;/span&gt;)&lt;/span&gt;
&lt;span id=&quot;cb9-3&quot;&gt;&lt;a href=&quot;#cb9-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb9-4&quot;&gt;&lt;a href=&quot;#cb9-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;diff &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;print&lt;/span&gt;()&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;##    @@ Region NoOfUnits   Sales Volume   Staff Costs People
## 1 +++   &amp;lt;NA&amp;gt;         1          19500          7609      2
## 2  -&amp;gt;      A      3-&amp;gt;2   59623-&amp;gt;42123  43103-&amp;gt;30103 16-&amp;gt;13
## 3  -&amp;gt;      B      1-&amp;gt;2 119500-&amp;gt;239000 95691-&amp;gt;185691     19
## 4  -&amp;gt;      D      1-&amp;gt;2   45860-&amp;gt;70860  32555-&amp;gt;32655      9&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;The two decide to first agree on the number of units per region.&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb11&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb11-1&quot;&gt;&lt;a href=&quot;#cb11-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;diff&lt;span class=&quot;sc&quot;&gt;$&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;get_data&lt;/span&gt;() &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;filter&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;at&quot;&gt;@@&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;`&lt;/span&gt; &lt;span class=&quot;sc&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;st&quot;&gt;&amp;quot;&amp;quot;&lt;/span&gt;) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;select&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;at&quot;&gt;@@&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;`&lt;/span&gt;, Region, NoOfUnits)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;##    @@ Region NoOfUnits
## 1 +++   &amp;lt;NA&amp;gt;         1
## 2  -&amp;gt;      A      3-&amp;gt;2
## 3  -&amp;gt;      B      1-&amp;gt;2
## 4  -&amp;gt;      D      1-&amp;gt;2&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;One obvious reason for the discrepancies appears to be that Bob has
results for an extra &lt;code&gt;&amp;lt;NA&amp;gt;&lt;/code&gt; region. Therefore, Bob
takes another look at his management of missing values and decides to
improve his code by:&lt;/p&gt;
&lt;h4 id=&quot;pong-bob&quot;&gt;Pong Bob&lt;/h4&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb13&quot;&gt;&lt;pre
class=&quot;sourceCode sql&quot;&gt;&lt;code class=&quot;sourceCode sql&quot;&gt;&lt;span id=&quot;cb13-1&quot;&gt;&lt;a href=&quot;#cb13-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kw&quot;&gt;SELECT&lt;/span&gt; Region,&lt;/span&gt;
&lt;span id=&quot;cb13-2&quot;&gt;&lt;a href=&quot;#cb13-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;       &lt;span class=&quot;fu&quot;&gt;COUNT&lt;/span&gt;(&lt;span class=&quot;op&quot;&gt;*&lt;/span&gt;) &lt;span class=&quot;kw&quot;&gt;As&lt;/span&gt; NoOfUnits,&lt;/span&gt;
&lt;span id=&quot;cb13-3&quot;&gt;&lt;a href=&quot;#cb13-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;       &lt;span class=&quot;fu&quot;&gt;SUM&lt;/span&gt;([Sales Volume]) &lt;span class=&quot;kw&quot;&gt;As&lt;/span&gt; [Sales Volume],&lt;/span&gt;
&lt;span id=&quot;cb13-4&quot;&gt;&lt;a href=&quot;#cb13-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;       &lt;span class=&quot;fu&quot;&gt;SUM&lt;/span&gt;([Staff Costs]) &lt;span class=&quot;kw&quot;&gt;AS&lt;/span&gt; [Staff Costs],&lt;/span&gt;
&lt;span id=&quot;cb13-5&quot;&gt;&lt;a href=&quot;#cb13-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;       &lt;span class=&quot;fu&quot;&gt;SUM&lt;/span&gt;(People) &lt;span class=&quot;kw&quot;&gt;AS&lt;/span&gt; People&lt;/span&gt;
&lt;span id=&quot;cb13-6&quot;&gt;&lt;a href=&quot;#cb13-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kw&quot;&gt;FROM&lt;/span&gt; fitness&lt;/span&gt;
&lt;span id=&quot;cb13-7&quot;&gt;&lt;a href=&quot;#cb13-7&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kw&quot;&gt;WHERE&lt;/span&gt; ([Sales Volume] &lt;span class=&quot;op&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;dv&quot;&gt;17500&lt;/span&gt; &lt;span class=&quot;kw&quot;&gt;AND&lt;/span&gt; REGION &lt;span class=&quot;kw&quot;&gt;IS&lt;/span&gt; &lt;span class=&quot;kw&quot;&gt;NOT&lt;/span&gt; &lt;span class=&quot;kw&quot;&gt;NULL&lt;/span&gt;)&lt;/span&gt;
&lt;span id=&quot;cb13-8&quot;&gt;&lt;a href=&quot;#cb13-8&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kw&quot;&gt;GROUP&lt;/span&gt; &lt;span class=&quot;kw&quot;&gt;BY&lt;/span&gt; Region&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;##   @@ Region NoOfUnits   Sales Volume   Staff Costs People
## 1 -&amp;gt;      A      3-&amp;gt;2   59623-&amp;gt;42123  43103-&amp;gt;30103 16-&amp;gt;13
## 2 -&amp;gt;      B      1-&amp;gt;2 119500-&amp;gt;239000 95691-&amp;gt;185691     19
## 3 -&amp;gt;      D      1-&amp;gt;2   45860-&amp;gt;70860  32555-&amp;gt;32655      9&lt;/code&gt;&lt;/pre&gt;
&lt;h4 id=&quot;ping-bob&quot;&gt;Ping Bob&lt;/h4&gt;
&lt;p&gt;Better. Now the &lt;code&gt;NA&lt;/code&gt; region is gone, but still quite some
differences remain. &lt;em&gt;Note&lt;/em&gt;: You may at this point want to stop
reading and try yourself to fix the analysis - the &lt;a
href=&quot;https://github.com/hoehleatsu/hoehleatsu.github.io/blob/master/figure/source/2017-09-02-pairprogramming/fitness.csv&quot;&gt;data&lt;/a&gt;
and &lt;a
href=&quot;https://github.com/hoehleatsu/hoehleatsu.github.io/blob/master/_source/2017-09-02-pairprogramming.Rmd&quot;&gt;code&lt;/a&gt;
are available from the github repository.&lt;/p&gt;
&lt;h4 id=&quot;pong-bob-1&quot;&gt;Pong Bob&lt;/h4&gt;
&lt;p&gt;Now Bob notices that he forgot to handle the duplicate records and
apparently misunderstood the exact definition of the €17,500 exclusion
limit. His massaged SQL query looks as follows:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb15&quot;&gt;&lt;pre
class=&quot;sourceCode sql&quot;&gt;&lt;code class=&quot;sourceCode sql&quot;&gt;&lt;span id=&quot;cb15-1&quot;&gt;&lt;a href=&quot;#cb15-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kw&quot;&gt;SELECT&lt;/span&gt; Region,&lt;/span&gt;
&lt;span id=&quot;cb15-2&quot;&gt;&lt;a href=&quot;#cb15-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;       &lt;span class=&quot;fu&quot;&gt;COUNT&lt;/span&gt;(&lt;span class=&quot;op&quot;&gt;*&lt;/span&gt;) &lt;span class=&quot;kw&quot;&gt;As&lt;/span&gt; NoOfUnits,&lt;/span&gt;
&lt;span id=&quot;cb15-3&quot;&gt;&lt;a href=&quot;#cb15-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;       &lt;span class=&quot;fu&quot;&gt;SUM&lt;/span&gt;([Sales Volume]) &lt;span class=&quot;kw&quot;&gt;As&lt;/span&gt; [Sales Volume],&lt;/span&gt;
&lt;span id=&quot;cb15-4&quot;&gt;&lt;a href=&quot;#cb15-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;       &lt;span class=&quot;fu&quot;&gt;SUM&lt;/span&gt;([Staff Costs]) &lt;span class=&quot;kw&quot;&gt;AS&lt;/span&gt; [Staff Costs],&lt;/span&gt;
&lt;span id=&quot;cb15-5&quot;&gt;&lt;a href=&quot;#cb15-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;       &lt;span class=&quot;fu&quot;&gt;SUM&lt;/span&gt;(People) &lt;span class=&quot;kw&quot;&gt;AS&lt;/span&gt; People&lt;/span&gt;
&lt;span id=&quot;cb15-6&quot;&gt;&lt;a href=&quot;#cb15-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kw&quot;&gt;FROM&lt;/span&gt; (&lt;span class=&quot;kw&quot;&gt;SELECT&lt;/span&gt; &lt;span class=&quot;kw&quot;&gt;Id&lt;/span&gt;, &lt;span class=&quot;fu&quot;&gt;MAX&lt;/span&gt;(Version), Region, [Sales Volume], [Staff Costs], People &lt;span class=&quot;kw&quot;&gt;FROM&lt;/span&gt; fitness &lt;span class=&quot;kw&quot;&gt;GROUP&lt;/span&gt; &lt;span class=&quot;kw&quot;&gt;BY&lt;/span&gt; &lt;span class=&quot;kw&quot;&gt;Id&lt;/span&gt;)&lt;/span&gt;
&lt;span id=&quot;cb15-7&quot;&gt;&lt;a href=&quot;#cb15-7&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kw&quot;&gt;WHERE&lt;/span&gt; ([Sales Volume] &lt;span class=&quot;op&quot;&gt;&amp;gt;=&lt;/span&gt; &lt;span class=&quot;dv&quot;&gt;17500&lt;/span&gt; &lt;span class=&quot;kw&quot;&gt;AND&lt;/span&gt; REGION &lt;span class=&quot;kw&quot;&gt;IS&lt;/span&gt; &lt;span class=&quot;kw&quot;&gt;NOT&lt;/span&gt; &lt;span class=&quot;kw&quot;&gt;NULL&lt;/span&gt;)&lt;/span&gt;
&lt;span id=&quot;cb15-8&quot;&gt;&lt;a href=&quot;#cb15-8&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kw&quot;&gt;GROUP&lt;/span&gt; &lt;span class=&quot;kw&quot;&gt;BY&lt;/span&gt; Region&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;##    @@ Region NoOfUnits Sales Volume  Staff Costs People
## 1 ...    ...       ...          ...          ...    ...
## 2  -&amp;gt;      D      1-&amp;gt;2 45860-&amp;gt;70860 32555-&amp;gt;32655      9&lt;/code&gt;&lt;/pre&gt;
&lt;h4 id=&quot;ping-ada&quot;&gt;Ping Ada&lt;/h4&gt;
&lt;p&gt;Comparing with Ada, Bob is sort of envious that she was able to just
use &lt;code&gt;dplyr&lt;/code&gt;’s &lt;code&gt;group_by&lt;/code&gt; and &lt;code&gt;top_n&lt;/code&gt;
functions. However, &lt;code&gt;daff&lt;/code&gt; shows that there still is one
difference left. By looking more carefully at Ada’s code it becomes
clear that she accidentally leaves out one unit in region D. The reason
is the too liberate use of &lt;code&gt;na.omit&lt;/code&gt;, which also removes the
one entry with an &lt;code&gt;NA&lt;/code&gt; in one of the not so important
columns. However, they discuss the issue, if one really wants to include
partial records or not, because summation in the different columns then
is over a different number of units. After consulting with the standard
operation procedure (SOP) for these kind of surveys they decide to
include the observation where possible. Here is Ada’s modified code:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb17&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb17-1&quot;&gt;&lt;a href=&quot;#cb17-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;ada2 &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; fitness &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;filter&lt;/span&gt;(&lt;span class=&quot;sc&quot;&gt;!&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;is.na&lt;/span&gt;(Region)) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;group_by&lt;/span&gt;(Region,Id) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;top_n&lt;/span&gt;(&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;,Version) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb17-2&quot;&gt;&lt;a href=&quot;#cb17-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;group_by&lt;/span&gt;(Region) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb17-3&quot;&gt;&lt;a href=&quot;#cb17-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;filter&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;at&quot;&gt;Sales Volume&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;`&lt;/span&gt; &lt;span class=&quot;sc&quot;&gt;&amp;gt;=&lt;/span&gt; &lt;span class=&quot;dv&quot;&gt;17500&lt;/span&gt;) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb17-4&quot;&gt;&lt;a href=&quot;#cb17-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;summarise&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;at&quot;&gt;NoOfUnits&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;ot&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;n&lt;/span&gt;(),&lt;/span&gt;
&lt;span id=&quot;cb17-5&quot;&gt;&lt;a href=&quot;#cb17-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;            &lt;span class=&quot;st&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;at&quot;&gt;Sales Volume&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;ot&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;sum&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;at&quot;&gt;Sales Volume&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;`&lt;/span&gt;),&lt;/span&gt;
&lt;span id=&quot;cb17-6&quot;&gt;&lt;a href=&quot;#cb17-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;            &lt;span class=&quot;st&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;at&quot;&gt;Staff Costs&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;ot&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;sum&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;at&quot;&gt;Staff Costs&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;`&lt;/span&gt;),&lt;/span&gt;
&lt;span id=&quot;cb17-7&quot;&gt;&lt;a href=&quot;#cb17-7&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;            &lt;span class=&quot;at&quot;&gt;People=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;sum&lt;/span&gt;(People))&lt;/span&gt;
&lt;span id=&quot;cb17-8&quot;&gt;&lt;a href=&quot;#cb17-8&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;(diff_final &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;diff_data&lt;/span&gt;(ada2,bob3)) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;print&lt;/span&gt;()&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;##    @@ Region NoOfUnits ... Staff Costs People
## 1 ...    ...       ... ...         ...    ...
## 2  -&amp;gt;      D         2 ...       32655  NA-&amp;gt;9&lt;/code&gt;&lt;/pre&gt;
&lt;h4 id=&quot;pong-ada&quot;&gt;Pong Ada&lt;/h4&gt;
&lt;p&gt;Oops, Ada forgot to take care of the &lt;code&gt;NA&lt;/code&gt; in the
summation:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb19&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb19-1&quot;&gt;&lt;a href=&quot;#cb19-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;ada3 &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; fitness &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;filter&lt;/span&gt;(&lt;span class=&quot;sc&quot;&gt;!&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;is.na&lt;/span&gt;(Region)) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;group_by&lt;/span&gt;(Region,Id) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;top_n&lt;/span&gt;(&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;,Version) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb19-2&quot;&gt;&lt;a href=&quot;#cb19-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;group_by&lt;/span&gt;(Region) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb19-3&quot;&gt;&lt;a href=&quot;#cb19-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;filter&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;at&quot;&gt;Sales Volume&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;`&lt;/span&gt; &lt;span class=&quot;sc&quot;&gt;&amp;gt;=&lt;/span&gt; &lt;span class=&quot;dv&quot;&gt;17500&lt;/span&gt;) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb19-4&quot;&gt;&lt;a href=&quot;#cb19-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;summarise&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;at&quot;&gt;NoOfUnits&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;ot&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;n&lt;/span&gt;(),&lt;/span&gt;
&lt;span id=&quot;cb19-5&quot;&gt;&lt;a href=&quot;#cb19-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;            &lt;span class=&quot;st&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;at&quot;&gt;Sales Volume&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;ot&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;sum&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;at&quot;&gt;Sales Volume&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;`&lt;/span&gt;),&lt;/span&gt;
&lt;span id=&quot;cb19-6&quot;&gt;&lt;a href=&quot;#cb19-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;            &lt;span class=&quot;st&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;at&quot;&gt;Staff Costs&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;ot&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;sum&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;at&quot;&gt;Staff Costs&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;`&lt;/span&gt;),&lt;/span&gt;
&lt;span id=&quot;cb19-7&quot;&gt;&lt;a href=&quot;#cb19-7&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;            &lt;span class=&quot;at&quot;&gt;People=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;sum&lt;/span&gt;(People,&lt;span class=&quot;at&quot;&gt;na.rm=&lt;/span&gt;&lt;span class=&quot;cn&quot;&gt;TRUE&lt;/span&gt;))&lt;/span&gt;
&lt;span id=&quot;cb19-8&quot;&gt;&lt;a href=&quot;#cb19-8&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;diff_final &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;diff_data&lt;/span&gt;(ada3,bob3)&lt;/span&gt;
&lt;span id=&quot;cb19-9&quot;&gt;&lt;a href=&quot;#cb19-9&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb19-10&quot;&gt;&lt;a href=&quot;#cb19-10&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##Check if the results really are the same&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb19-11&quot;&gt;&lt;a href=&quot;#cb19-11&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;length&lt;/span&gt;(diff_final&lt;span class=&quot;sc&quot;&gt;$&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;get_data&lt;/span&gt;()) &lt;span class=&quot;sc&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;dv&quot;&gt;0&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;## [1] TRUE&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Finally, their results agree and they move on to production and their
results are published in a &lt;a
href=&quot;https://www.destatis.de/DE/Publikationen/Thematisch/DienstleistungenFinanzdienstleistungen/KostenStruktur/KostenstrukturFitness2020163109004.pdf?__blob=publicationFile&quot;&gt;nice
report&lt;/a&gt;.&lt;/p&gt;
&lt;h2 id=&quot;conclusion&quot;&gt;Conclusion&lt;/h2&gt;
&lt;p&gt;As shown, the ping-pong game is quite manual and particularly
annoying, if at some point someone steps into the office with a
statement like &lt;em&gt;Btw, I found some extra questionnaires, which need to
be added to the analysis asap&lt;/em&gt;. However, the two now aligned
analysis scripts and the corresponding daff-overlay could be put into a
script, which is triggered every time the data change. In case new
discrepancies emerge as &lt;code&gt;length(diff$get_data()) &amp;gt; 0&lt;/code&gt;, the
two could then be automatically informed.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Question 1&lt;/strong&gt;: Now the two get the same results, do you
agree with them?&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;## # A tibble: 4 x 5
##   Region NoOfUnits `Sales Volume` `Staff Costs` People
##   &amp;lt;chr&amp;gt;      &amp;lt;int&amp;gt;          &amp;lt;int&amp;gt;         &amp;lt;int&amp;gt;  &amp;lt;int&amp;gt;
## 1 A              3          59623         43103     16
## 2 B              1         119500         95691     19
## 3 D              2          70860         32655      9
## 4 E              1          33020         25010      7&lt;/code&gt;&lt;/pre&gt;
&lt;strong&gt;Question 2&lt;/strong&gt;: Are you aware of any other good ways and
tools to structure and automatize such a process? If so, please share
your experiences as a Disqus comment below. Control calculations appear
quite common, but little structured code support appears to be available
for such processes.
&lt;p&gt;
&lt;p&gt;
&lt;center&gt;
&lt;figure&gt;
&lt;img
src=&quot;https://upload.wikimedia.org/wikipedia/commons/thumb/9/96/A_Perfect_Pair_Daffodills_%28Narcissus%29_-_8.jpg/320px-A_Perfect_Pair_Daffodills_%28Narcissus%29_-_8.jpg&quot;
alt=&quot;Daffodills&quot; /&gt;
&lt;figcaption aria-hidden=&quot;true&quot;&gt;Daffodills&lt;/figcaption&gt;
&lt;/figure&gt;
&lt;/center&gt;
&lt;p&gt;&lt;br&gt; &lt;FONT COLOR=&quot;bbbbbb&quot;&gt;Photo is copyright &lt;a
href=&quot;https://en.wikipedia.org/wiki/Narcissus_(plant)#/media/File:A_Perfect_Pair_Daffodills_(Narcissus)_-_8.jpg&quot;&gt;Johnathan
J. Stegeman&lt;/a&gt; under the &lt;a
href=&quot;https://commons.wikimedia.org/wiki/Commons:GNU_Free_Documentation_License,_version_1.2&quot;&gt;GNU
Free Documentation License, version 1.2&lt;/a&gt;.&lt;/FONT&gt;&lt;/p&gt;
</description>
        <pubDate>Sat, 02 Sep 2017 00:00:00 +0200</pubDate>
        <link>https://mhoehle.github.io/blog/2017/09/02/pairprogramming.html</link>
        <guid isPermaLink="true">https://mhoehle.github.io/blog/2017/09/02/pairprogramming.html</guid>
        
        <category>rstats</category>
        
        <category>stats</category>
        
        <category>quality</category>
        
        
      </item>
    
      <item>
        <title>Confidence Intervals without Your Collaborator&apos;s Tears</title>
        <description>&lt;h2 id=&quot;abstract&quot;&gt;Abstract&lt;/h2&gt;
&lt;p&gt;We provide an interpretation for the confidence interval for a
binomial proportion hidden as the transcript of an hypothetical
statistical consulting session.&lt;/p&gt;
&lt;center&gt;
&lt;img
src=&quot;/blog/figure/source/2017-06-22-interpretcis/BETABINOMIALCI-1.png&quot; /&gt;
&lt;/center&gt;
&lt;p&gt;&lt;br&gt;
&lt;a rel=&quot;license&quot; href=&quot;http://creativecommons.org/licenses/by-sa/4.0/&quot;&gt;&lt;img alt=&quot;Creative Commons License&quot; style=&quot;border-width:0&quot; src=&quot;https://i.creativecommons.org/l/by-sa/4.0/88x31.png&quot;/&gt;&lt;/a&gt;
This work is licensed under a &lt;a rel=&quot;license&quot;
href=&quot;http://creativecommons.org/licenses/by-sa/4.0/&quot;&gt;Creative Commons
Attribution-ShareAlike 4.0 International License&lt;/a&gt;. The
markdown+Rknitr source code of this blog is available under a &lt;a
href=&quot;https://www.gnu.org/licenses/gpl-3.0.html&quot;&gt;GNU General Public
License (GPL v3)&lt;/a&gt; license from github.&lt;/p&gt;
&lt;p&gt;
&lt;h2 id=&quot;the-statistical-consulting-session&quot;&gt;The Statistical Consulting
Session&lt;/h2&gt;
&lt;p&gt;&lt;strong&gt;[Client]:&lt;/strong&gt; So I did this important experiment where I
investigated 420 turtles whether they had a specific phenotype trait. 52
out of my 420 turtles had the trait, i.e. the proportion in the sample
was 12.4%. Now I’d like to state a 95% confidence interval for what the
proportion of the trait is in the population of turtles (which is pretty
large).&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;[Statistician]:&lt;/strong&gt; Interesting, but no so fast. Before
going into the statistical specifics I would like to talk about the
representativeness of your sample. Can you explain in more detail what
is the population of turtles you would like to make a statement about
and how the sample was selected.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;[Client]:&lt;/strong&gt; I’m surprised you care about turtles
(&lt;em&gt;eyes start to glow&lt;/em&gt;). My research area is the indo-pacific
subpopulation of the &lt;a
href=&quot;https://en.wikipedia.org/wiki/Green_sea_turtle&quot;&gt;green sea
turtle&lt;/a&gt;, in particular the one outside the Great Barrier Reef. The
population is believed to be a few thousands large and we sample by
catching turtles using the &lt;a
href=&quot;https://www.youtube.com/watch?v=FnKcBZBaAW8&quot;&gt;rodeo method&lt;/a&gt; at
specific feeding grounds. Each turtle was then tagged and a skin biopsy
was taken. From the biopsy it was determined if the turtle is clinically
unhealthy by measuring marker values and then check if its specific
value was outside the presented reference interval.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;[Statistician]:&lt;/strong&gt; Hmm, that’s a lot of information.
And what population do you want to make a statement about? All green
turtles?&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;[Client]:&lt;/strong&gt; That would be nice, but no. There are
genetic differences between the varies subspecies so I would be happy
just to make a statement about the Great Barrier Reef population.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;[Statistician]:&lt;/strong&gt; That sounds fair. You might get some
bias by only sampling from feeding grounds and I’m unsure about the
spatial design of your capture strategy.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;[Client:]&lt;/strong&gt; We gave this a lot of thought and varied
both the time and site of sampling, but there is no hypothesis that
there is great spatial variation within the reef area.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;[Statistician]:&lt;/strong&gt; Well, it’s my job to check the
representativeness of the sample, but it sounds like you already gave
this great thought. From what you describe sampling appears to be
without replacement. However, since your population is large (and also
not really known), it appears acceptable to skip the finite population
correction. Since your sample is also pretty large, let’s therefore go
with the textbook large-sample confidence interval for a binomial
proportion, that is &lt;span class=&quot;math inline&quot;&gt;\(\hat{p} \pm 1.96
\sqrt{\hat{p}(1-\hat{p})/n}\)&lt;/span&gt;, where &lt;span
class=&quot;math inline&quot;&gt;\(\hat{p}=x/n\)&lt;/span&gt;. Don’t worry about the
equation, let’s use R and the &lt;code&gt;binom&lt;/code&gt; package to compute the
interval:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb1&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb1-1&quot;&gt;&lt;a href=&quot;#cb1-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;(ci &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; binom&lt;span class=&quot;sc&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;binom.asymp&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;x=&lt;/span&gt;x, &lt;span class=&quot;at&quot;&gt;n=&lt;/span&gt;n, &lt;span class=&quot;at&quot;&gt;conf.level=&lt;/span&gt;&lt;span class=&quot;fl&quot;&gt;0.95&lt;/span&gt;))&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;##       method  x   n      mean      lower     upper
## 1 asymptotic 52 420 0.1238095 0.09231031 0.1553087&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;So the requested 95% CI is 9.2%- 15.5%. Happy?&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;[Client]:&lt;/strong&gt; Well, yes, that looks nice, but I wonder
how I can interpret the confidence interval. Is it correct to say that
the interval denotes a region, which contains the true value with 95%
probability?&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;[Statistician]:&lt;/strong&gt; A confidence interval constructing
procedure yields a random interval, because it depends on quantities (in
particular &lt;span class=&quot;math inline&quot;&gt;\(x\)&lt;/span&gt;), which are random.
However, once you plug-in the realization of the random variable
(i.e. your observation), you get a realization of the confidence
interval consisting of two numbers. Would we know the true value then we
could tell, whether the value is covered by this particular interval or
not. The specific interval we calculated above thus contains the true
value with probability 0% or 100% - which of the two is the cases we
unfortunately do not know.&lt;/p&gt;
&lt;p&gt;The correct interpretation is thus that the confidence interval is
constructed by a procedure, which, when you repeat the experiment many
many times, is such that in 95% of the experiments the corresponding
confidence interval would cover the true value. I can illustrate this
using a small simulation study in R. Let’s assume your true proportion
is 10%.&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb3&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb3-1&quot;&gt;&lt;a href=&quot;#cb3-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##Assumed true value of the proportion of turtles with the trait&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb3-2&quot;&gt;&lt;a href=&quot;#cb3-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;theta_true &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fl&quot;&gt;0.1&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb3-3&quot;&gt;&lt;a href=&quot;#cb3-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb3-4&quot;&gt;&lt;a href=&quot;#cb3-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##Prepare data.frame with 10000 realizations of the experiment&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb3-5&quot;&gt;&lt;a href=&quot;#cb3-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;df &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;data.frame&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;x=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;rbinom&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;n=&lt;/span&gt;&lt;span class=&quot;fl&quot;&gt;1e4&lt;/span&gt;, &lt;span class=&quot;at&quot;&gt;size=&lt;/span&gt;n, &lt;span class=&quot;at&quot;&gt;prob=&lt;/span&gt;theta_true))&lt;/span&gt;
&lt;span id=&quot;cb3-6&quot;&gt;&lt;a href=&quot;#cb3-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb3-7&quot;&gt;&lt;a href=&quot;#cb3-7&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##Compute 95% CI for each experiment&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb3-8&quot;&gt;&lt;a href=&quot;#cb3-8&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;df &lt;span class=&quot;sc&quot;&gt;%&amp;lt;&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;do&lt;/span&gt;( {&lt;/span&gt;
&lt;span id=&quot;cb3-9&quot;&gt;&lt;a href=&quot;#cb3-9&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;as.data.frame&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;cbind&lt;/span&gt;(.,&lt;span class=&quot;at&quot;&gt;rate=&lt;/span&gt;.&lt;span class=&quot;sc&quot;&gt;$&lt;/span&gt;x&lt;span class=&quot;sc&quot;&gt;/&lt;/span&gt;n,binom&lt;span class=&quot;sc&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;binom.asymp&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;x=&lt;/span&gt;.&lt;span class=&quot;sc&quot;&gt;$&lt;/span&gt;x, &lt;span class=&quot;at&quot;&gt;n=&lt;/span&gt;n)[&lt;span class=&quot;fu&quot;&gt;c&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;quot;lower&amp;quot;&lt;/span&gt;,&lt;span class=&quot;st&quot;&gt;&amp;quot;upper&amp;quot;&lt;/span&gt;)]))&lt;/span&gt;
&lt;span id=&quot;cb3-10&quot;&gt;&lt;a href=&quot;#cb3-10&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;})&lt;/span&gt;
&lt;span id=&quot;cb3-11&quot;&gt;&lt;a href=&quot;#cb3-11&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##Check if the interval covers the true value&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb3-12&quot;&gt;&lt;a href=&quot;#cb3-12&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;df &lt;span class=&quot;sc&quot;&gt;%&amp;lt;&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;mutate&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;covers_true_value =&lt;/span&gt; lower &lt;span class=&quot;sc&quot;&gt;&amp;lt;&lt;/span&gt; theta_true &lt;span class=&quot;sc&quot;&gt;&amp;amp;&lt;/span&gt; upper &lt;span class=&quot;sc&quot;&gt;&amp;gt;&lt;/span&gt; theta_true)&lt;/span&gt;
&lt;span id=&quot;cb3-13&quot;&gt;&lt;a href=&quot;#cb3-13&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb3-14&quot;&gt;&lt;a href=&quot;#cb3-14&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##Proportion of intervals covering the true value. This would be 95%&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb3-15&quot;&gt;&lt;a href=&quot;#cb3-15&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;df &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;summarise&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;coverage =&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;mean&lt;/span&gt;(covers_true_value))&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;##   coverage
## 1   0.9446&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;A graphic for the first 50 experiments shows their point estimates,
corresponding intervals and how they overlap the true value or not:
&lt;img src=&quot;/blog/figure/source/2017-06-22-interpretcis/unnamed-chunk-6-1.png&quot; style=&quot;display: block; margin: auto;&quot; /&gt;&lt;/p&gt;
&lt;p&gt;The specific confidence interval &lt;code&gt;ci&lt;/code&gt; we computed above is
thus just one of many possible confidence intervals originating from the
above procedure.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;[Client]:&lt;/strong&gt; Ok, I get that is what happens when you do
it many times. But I only have this one experiment with x = 52 out of n
= 420 subjects having the trait of interest. Your above output does
contain a very specific CI, with some very specific numbers, i.e. 9.2%-
15.5%. Is the true value in this interval with 95% probability?&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;[Statistician]:&lt;/strong&gt; No, the realized interval either
covers the true value or not. But since we do not know the true value
it’s a bit like Schrödinger’s cat… To keep things very sketchy: The
width of the interval gives you an indication of your estimation
certainty, but the particular values are hard to interpret - except
maybe as the critical limits in a corresponding hypothesis test. The
later can loosely be interpreted as the range of parameters consistent
with the data, where &lt;em&gt;consistency&lt;/em&gt; is defined by a pre-defined
type-I error probability.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;[Client]:&lt;/strong&gt; I’m sorry, but this is
&lt;strong&gt;useless&lt;/strong&gt;! You suggest to follow a common statistical
protocol, you compute some numbers, but these numbers don’t really mean
anything?&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;[Statistician]:&lt;/strong&gt; Sorry, that’s the way it is.
However, allow me to offer a different explanation: We both appear to
agree that there is a true value of the proportion, right? Let’s denote
this &lt;span class=&quot;math inline&quot;&gt;\(\theta\)&lt;/span&gt; with &lt;span
class=&quot;math inline&quot;&gt;\(0 \leq \theta \leq 1\)&lt;/span&gt;. We don’t know the
true value, but we might have some prior idea about the range of
plausible values for it. Would you be willing to characterize your
belief about this by a distribution for &lt;span
class=&quot;math inline&quot;&gt;\(\theta\)&lt;/span&gt;? This could be something as simple
as assuming &lt;span class=&quot;math inline&quot;&gt;\(\theta \sim U(0,1)\)&lt;/span&gt;,
i.e. you would assume that every value of &lt;span
class=&quot;math inline&quot;&gt;\(\theta\)&lt;/span&gt; between zero and one is equally
probable initially. Then the interval we computed above denotes a 95%
equal tail probability &lt;strong&gt;credibility region&lt;/strong&gt; in a Bayesian
framework when we assume this flat prior and use an asymptotic argument
resulting in the posterior being Gaussian with the same mean and
variance as the one would get from the asymptotic frequentist
procedure.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;[Client]:&lt;/strong&gt; Umm, ok, but how’s that helpful?&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;[Statistician]:&lt;/strong&gt; In the Bayesian context a 95%
credibility region is a summary of your posterior belief about the
parameter. Hence, it is ok to interpret this interval as that your
belief after seeing the data is such that &lt;em&gt;the true value is in that
interval with 95% probability&lt;/em&gt;.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;[Client]:&lt;/strong&gt; I love this Bayes thing! This is what I
wanted initially. But hang on, I don’t really believe in all values of
the parameter being initially equally probable. I’ve seen some previous
studies in the literature who under pretty similar conditions find that
proportion is around 5-15%. How would I incorporate that?&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;[Statistician]:&lt;/strong&gt; You could modify the large-sample
Gaussian posterior such that it includes this prior information. Instead
of using Gaussians you could alternatively also use a &lt;a
href=&quot;https://en.wikipedia.org/wiki/Beta_distribution&quot;&gt;Beta
distribution&lt;/a&gt; to perform so called &lt;strong&gt;conjugate prior-posterior
updating&lt;/strong&gt; of your belief about the true proportion. Let’s say
the 5-15% denotes your prior 95% credibility region for the parameter.
We would use this to find the parameters of a beta distribution. Then we
would update your prior belief with the observed data to get the
posterior distribution. A feature of such a conjugate approach is that
this updated distribution, i.e. the posterior, is again beta. Doing this
in R is easy:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb5&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb5-1&quot;&gt;&lt;a href=&quot;#cb5-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##Function to determine beta parameters s.t. the 2.5% and 97.5% quantile match the specified values&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb5-2&quot;&gt;&lt;a href=&quot;#cb5-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;target &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;cf&quot;&gt;function&lt;/span&gt;(theta, prior_interval, &lt;span class=&quot;at&quot;&gt;alpha=&lt;/span&gt;&lt;span class=&quot;fl&quot;&gt;0.05&lt;/span&gt;) {&lt;/span&gt;
&lt;span id=&quot;cb5-3&quot;&gt;&lt;a href=&quot;#cb5-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;sum&lt;/span&gt;( (&lt;span class=&quot;fu&quot;&gt;qbeta&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;c&lt;/span&gt;(alpha&lt;span class=&quot;sc&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;, &lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;-&lt;/span&gt;alpha&lt;span class=&quot;sc&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;), theta[&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;], theta[&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;]) &lt;span class=&quot;sc&quot;&gt;-&lt;/span&gt; prior_interval)&lt;span class=&quot;sc&quot;&gt;^&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;)&lt;/span&gt;
&lt;span id=&quot;cb5-4&quot;&gt;&lt;a href=&quot;#cb5-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;}&lt;/span&gt;
&lt;span id=&quot;cb5-5&quot;&gt;&lt;a href=&quot;#cb5-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb5-6&quot;&gt;&lt;a href=&quot;#cb5-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##Find the prior parameters&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb5-7&quot;&gt;&lt;a href=&quot;#cb5-7&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;prior_params &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;optim&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;c&lt;/span&gt;(&lt;span class=&quot;dv&quot;&gt;10&lt;/span&gt;,&lt;span class=&quot;dv&quot;&gt;10&lt;/span&gt;),target, &lt;span class=&quot;at&quot;&gt;prior_interval=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;c&lt;/span&gt;(&lt;span class=&quot;fl&quot;&gt;0.05&lt;/span&gt;, &lt;span class=&quot;fl&quot;&gt;0.15&lt;/span&gt;))&lt;span class=&quot;sc&quot;&gt;$&lt;/span&gt;par&lt;/span&gt;
&lt;span id=&quot;cb5-8&quot;&gt;&lt;a href=&quot;#cb5-8&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;prior_params&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;## [1]  12.04737 116.06022&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Actually, you can interpret the above prior parameters as the number
of turtles you have seen with the trait (12) and without the trait
(116), respectively, before conducting your above investigation. The
posterior parameters are then 12 + 52 = 64 turtles with the trait and
116 + 368 = 484 turtles without the trait. You get the credible interval
based on this posterior in R by:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb7&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb7-1&quot;&gt;&lt;a href=&quot;#cb7-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##Compute credibile interval from a beta-binomial conjugate prior-posterior approach&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb7-2&quot;&gt;&lt;a href=&quot;#cb7-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;(ci_bayes &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; binom&lt;span class=&quot;sc&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;binom.bayes&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;x=&lt;/span&gt;x, &lt;span class=&quot;at&quot;&gt;n=&lt;/span&gt;n, &lt;span class=&quot;at&quot;&gt;type=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;central&amp;quot;&lt;/span&gt;, &lt;span class=&quot;at&quot;&gt;prior.shape1=&lt;/span&gt;prior_params[&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;], &lt;span class=&quot;at&quot;&gt;prior.shape2=&lt;/span&gt;prior_params[&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;]))&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;##   method  x   n   shape1   shape2      mean      lower     upper  sig
## 1  bayes 52 420 64.04737 484.0602 0.1168518 0.09134069 0.1450096 0.05&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Graphically, your belief updating looks as follows:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb9&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb9-1&quot;&gt;&lt;a href=&quot;#cb9-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##Plot of the beta-posterior&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb9-2&quot;&gt;&lt;a href=&quot;#cb9-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;p &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; binom&lt;span class=&quot;sc&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;binom.bayes.densityplot&lt;/span&gt;(ci_bayes)&lt;/span&gt;
&lt;span id=&quot;cb9-3&quot;&gt;&lt;a href=&quot;#cb9-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##Add plot of the beta-prior&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb9-4&quot;&gt;&lt;a href=&quot;#cb9-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;df &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;data.frame&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;x=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;seq&lt;/span&gt;(&lt;span class=&quot;dv&quot;&gt;0&lt;/span&gt;,&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;,&lt;span class=&quot;at&quot;&gt;length=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;1000&lt;/span&gt;)) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;mutate&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;pdf=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;dbeta&lt;/span&gt;(x, prior_params[&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;], prior_params[&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;]))&lt;/span&gt;
&lt;span id=&quot;cb9-5&quot;&gt;&lt;a href=&quot;#cb9-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;p &lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;geom_line&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;data=&lt;/span&gt;df, &lt;span class=&quot;fu&quot;&gt;aes&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;x=&lt;/span&gt;x, &lt;span class=&quot;at&quot;&gt;y=&lt;/span&gt;pdf), &lt;span class=&quot;at&quot;&gt;col=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;darkgray&amp;quot;&lt;/span&gt;,&lt;span class=&quot;at&quot;&gt;lty=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;) &lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb9-6&quot;&gt;&lt;a href=&quot;#cb9-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;coord_cartesian&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;xlim=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;c&lt;/span&gt;(&lt;span class=&quot;dv&quot;&gt;0&lt;/span&gt;,&lt;span class=&quot;fl&quot;&gt;0.25&lt;/span&gt;)) &lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;scale_x_continuous&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;labels=&lt;/span&gt;scales&lt;span class=&quot;sc&quot;&gt;::&lt;/span&gt;percent)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;img src=&quot;/blog/figure/source/2017-06-22-interpretcis/BETABINOMIALCI-1.png&quot; style=&quot;display: block; margin: auto;&quot; /&gt;&lt;/p&gt;
&lt;p&gt;The dashed line in the graphic shows the density of your beta prior
distribution. The shaded region shows the density of your beta posterior
distribution, in particular, the gray shaded area denotes your 95%
credibility region on the x-axis. One advantage of the beta-binomial
approach is that this ensures that the prior as well as the posterior
distribution have the same support as your parameter, i.e. the interval
between zero and one.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;[Client]:&lt;/strong&gt; So I can really write that the interval
9.1%- 14.5% contains the true parameter with a probability of 95%?&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;[Statistician]:&lt;/strong&gt; Depending on the technical level of
your readership you might want to state that it’s a 95% equi-tailed
credible interval resulting from a beta-binomial conjugate Bayesian
approach obtained when using a prior beta with parameters such that the
similar 95% equi-tailed &lt;strong&gt;prior credible interval&lt;/strong&gt; has
limits 0.05 and 0.15. Given these assumptions the interval 9.1%- 14.5%
contains 95% of your subjective posterior density for the parameter.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;[Client]:&lt;/strong&gt; ???&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;[Statistician]:&lt;/strong&gt; You might want to skip all the
details and write that the 95% &lt;strong&gt;Bayesian confidence
interval&lt;/strong&gt; is 9.1%- 14.5%.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;[Client]:&lt;/strong&gt; And what if the reviewers do not agree
with my prior distribution?&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;[Statistician]:&lt;/strong&gt; Then return to your flat prior,
i.e. the uniform. Nobody usually questions that even though you told me
that you don’t believe in it yourself:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb10&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb10-1&quot;&gt;&lt;a href=&quot;#cb10-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;(ci_bayes_unif &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; binom&lt;span class=&quot;sc&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;binom.bayes&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;x=&lt;/span&gt;x, &lt;span class=&quot;at&quot;&gt;n=&lt;/span&gt;n, &lt;span class=&quot;at&quot;&gt;type=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;central&amp;quot;&lt;/span&gt;, &lt;span class=&quot;at&quot;&gt;prior.shape1=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;, &lt;span class=&quot;at&quot;&gt;prior.shape2=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;))&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;##   method  x   n shape1 shape2      mean      lower    upper  sig
## 1  bayes 52 420     53    369 0.1255924 0.09574062 0.158803 0.05&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;[Client]:&lt;/strong&gt; Alright, that’s settled then - I just use
a Bayesian confidence interval with a flat prior and am done. That was
not so hard after all. Now to something else, the reviewers of the
paper, which by the way has to be revised by tomorrow, also asked us to
substantiate our findings with a &lt;strong&gt;p-value&lt;/strong&gt;. How would I
get a p-value related to the above?&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;[Statistician]:&lt;/strong&gt; Look how late it already is! I
really need to go. I have this Bayesian Methods class to teach…&lt;/p&gt;
</description>
        <pubDate>Thu, 22 Jun 2017 00:00:00 +0200</pubDate>
        <link>https://mhoehle.github.io/blog/2017/06/22/interpretcis.html</link>
        <guid isPermaLink="true">https://mhoehle.github.io/blog/2017/06/22/interpretcis.html</guid>
        
        <category>rstats</category>
        
        <category>stats</category>
        
        <category>uncertainty</category>
        
        
      </item>
    
      <item>
        <title>Beware the Argument: The Flint Water Crisis and Quantiles</title>
        <description>&lt;h2 id=&quot;abstract&quot;&gt;Abstract&lt;/h2&gt;
&lt;p&gt;If your tap water suddenly becomes brown while authorities claim
everything is okay, you start to worry. &lt;span class=&quot;citation&quot;
data-cites=&quot;langkjaerbain2017&quot;&gt;Langkjær-Bain (2017)&lt;/span&gt; tells the &lt;a
href=&quot;https://en.wikipedia.org/wiki/Flint_water_crisis&quot;&gt;Flint Water
Crisis&lt;/a&gt; story from a statistical viewpoint: essentially the interest
is in whether the 90th percentile in a sample of lead concentration
measurements is above a certain threshold or not. We illustrate how to
perform the necessary calculations with R’s quantile function and show
that the type-argument of the function matters.&lt;/p&gt;
&lt;center&gt;
&lt;img src=&quot;/blog/figure/source/2017-06-18-quantiles/SAWTOOTH-1.png&quot; /&gt;
&lt;/center&gt;
&lt;p&gt;&lt;br&gt;
&lt;a rel=&quot;license&quot; href=&quot;http://creativecommons.org/licenses/by-sa/4.0/&quot;&gt;&lt;img alt=&quot;Creative Commons License&quot; style=&quot;border-width:0&quot; src=&quot;https://i.creativecommons.org/l/by-sa/4.0/88x31.png&quot;/&gt;&lt;/a&gt;
This work is licensed under a &lt;a rel=&quot;license&quot;
href=&quot;http://creativecommons.org/licenses/by-sa/4.0/&quot;&gt;Creative Commons
Attribution-ShareAlike 4.0 International License&lt;/a&gt;. The
markdown+Rknitr source code of this blog is available under a &lt;a
href=&quot;https://www.gnu.org/licenses/gpl-3.0.html&quot;&gt;GNU General Public
License (GPL v3)&lt;/a&gt; license from github.&lt;/p&gt;
&lt;h2 id=&quot;introduction&quot;&gt;Introduction&lt;/h2&gt;
&lt;p&gt;In a recent &lt;a
href=&quot;https://www.significancemagazine.com/&quot;&gt;Significance&lt;/a&gt; article,
&lt;span class=&quot;citation&quot; data-cites=&quot;langkjaerbain2017&quot;&gt;Langkjær-Bain
(2017)&lt;/span&gt; tells the story about the &lt;a
href=&quot;https://en.wikipedia.org/wiki/Flint_water_crisis&quot;&gt;Flint water
crisis&lt;/a&gt;. In 2014 the city of Flint, Michigan, USA, decided to change
its water supply to Flint River. Due to insufficient treatment of the
water with corrosion inhibitors the lead concentration in the drinking
water increased, because lead in the aging pipes leached into the water
supply. This created serious health problems - as explained in this &lt;a
href=&quot;https://youtu.be/QnDQFivtCd0&quot;&gt;short video summary&lt;/a&gt;. In this
blog post we investigate further the computation of the 90th percentile
of the tap water lead concentration samples described in &lt;span
class=&quot;citation&quot; data-cites=&quot;langkjaerbain2017&quot;&gt;Langkjær-Bain
(2017)&lt;/span&gt;. Quantile estimation in this context has already been
discussed in a recent blog entry entitled &lt;a
href=&quot;https://blogs.sas.com/content/iml/2017/05/17/quantiles-flint-water-crisis.html&quot;&gt;Quantiles
and the Flint water crisis&lt;/a&gt; by &lt;a
href=&quot;https://blogs.sas.com/content/author/rickwicklin/&quot;&gt;Rick
Wicklin&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;The monitoring of drinking water in the US is regulated by the &lt;a
href=&quot;https://www.epa.gov/dwreginfo/lead-and-copper-rule&quot;&gt;Lead and
Copper Rule&lt;/a&gt; of the United States Environmental Protection Agency.
The entire text of the rule is available as electronic code of federal
regulation (e-CFR) Title 40: Protection of Environment, &lt;a
href=&quot;https://www.ecfr.gov/cgi-bin/text-idx?SID=531617f923c3de2cbf5d12ae4663f56d&amp;amp;mc=true&amp;amp;node=sp40.23.141.i&amp;amp;rgn=div6&quot;&gt;Part
141 - National Primary Drinking Water Regulations&lt;/a&gt;. In particular the
regulation defines a sampling plan for collecting tap water samples. The
size of the sample depends on the number of people the water system
serves. In case this number is bigger than 100,000 a sample of 100 sites
is needed. If there are 10,001-100,000 people served, then a sample from
60 sites is needed. For systems serving fewer than 10,000 sizes of 40,
20, 10 and 5 are defined - see &lt;a
href=&quot;https://www.ecfr.gov/cgi-bin/text-idx?SID=531617f923c3de2cbf5d12ae4663f56d&amp;amp;mc=true&amp;amp;node=sp40.23.141.i&amp;amp;rgn=div6#se40.25.141_186&quot;&gt;§141.86(c)&lt;/a&gt;
of the rule for details. Of interest for this blog post is that action
needs to be taken, if too many of the samples are above a given
threshold of 15 part per billion (ppb):&lt;/p&gt;
&lt;center&gt;
&lt;img src=&quot;/blog/figure/source/2017-06-18-quantiles/ecfr141.png&quot; /&gt;
&lt;/center&gt;
&lt;FONT COLOR=&quot;bbbbbb&quot;&gt;Figure: Excerpt of &lt;a
href=&quot;https://www.ecfr.gov/cgi-bin/text-idx?SID=531617f923c3de2cbf5d12ae4663f56d&amp;amp;mc=true&amp;amp;node=sp40.23.141.i&amp;amp;rgn=div6#se40.25.141_180&quot;&gt;CFR
40 §141.80&lt;/a&gt; with the quantile calculation highlighted in
yellow.&lt;/FONT&gt;
&lt;p&gt;
&lt;p&gt;We note the explicit duality in the CFR between the &lt;em&gt;in more than
10%&lt;/em&gt; and the 90% quantile in the text. However, we also note that it
is not clear how to proceed, if the number calculated in (c)(3)(ii) is
&lt;strong&gt;not an integer&lt;/strong&gt;. This is not a problem per se, because
the CFR itself only operates with samples sizes 100, 60, 40, 20, 10 and
5, where 0.9 times the sample size always gives an integer number. But
if one for some reason does not obtain exactly the required number this
quickly can become an issue as we shall see below.&lt;/p&gt;
&lt;h2 id=&quot;the-flint-data&quot;&gt;The Flint Data&lt;/h2&gt;
&lt;p&gt;The data of the spring 2015 Flint water supply monitoring conducted
by the Michigan Department of Environmental Quality are presented in the
figure on p. 20 of &lt;span class=&quot;citation&quot;
data-cites=&quot;langkjaerbain2017&quot;&gt;Langkjær-Bain (2017)&lt;/span&gt;.
Alternatively, they can also be taken directly from the Blog entry &lt;a
href=&quot;https://blogs.sas.com/content/iml/2017/05/17/quantiles-flint-water-crisis.html&quot;&gt;Quantiles
and the Flint water crisis&lt;/a&gt; by &lt;a
href=&quot;https://blogs.sas.com/content/author/rickwicklin/&quot;&gt;Rick
Wicklin&lt;/a&gt;.&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb1&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb1-1&quot;&gt;&lt;a href=&quot;#cb1-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##Read flint water monitoring data (the column lead is the measurement)&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-2&quot;&gt;&lt;a href=&quot;#cb1-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;flint &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;read.csv&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;file=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;file.path&lt;/span&gt;(filePath,&lt;span class=&quot;st&quot;&gt;&amp;quot;flint.csv&amp;quot;&lt;/span&gt;))&lt;/span&gt;
&lt;span id=&quot;cb1-3&quot;&gt;&lt;a href=&quot;#cb1-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##Sort the measured lead values in ascending order&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-4&quot;&gt;&lt;a href=&quot;#cb1-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;lead  &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;sort&lt;/span&gt;(flint&lt;span class=&quot;sc&quot;&gt;$&lt;/span&gt;lead)&lt;/span&gt;
&lt;span id=&quot;cb1-5&quot;&gt;&lt;a href=&quot;#cb1-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##Number of observations&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-6&quot;&gt;&lt;a href=&quot;#cb1-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;n &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;length&lt;/span&gt;(lead)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;img src=&quot;/blog/figure/source/2017-06-18-quantiles/HISTOGRAM-1.png&quot; style=&quot;display: block; margin: auto;&quot; /&gt;&lt;/p&gt;
&lt;p&gt;The proportion of observations above the 15 ppb threshold is&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb2&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb2-1&quot;&gt;&lt;a href=&quot;#cb2-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;mean&lt;/span&gt;(lead &lt;span class=&quot;sc&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;dv&quot;&gt;15&lt;/span&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;## [1] 0.1126761&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;In other words, the proportion 11.3% is above the 10% action
threshold and, hence, something needs to be done. However, as &lt;span
class=&quot;citation&quot; data-cites=&quot;langkjaerbain2017&quot;&gt;Langkjær-Bain
(2017)&lt;/span&gt; describes, the story is a little more complicated, because
two of the values above 15 were removed with the argument that they
originated from sites which are not covered by the sampling plan. Only
private households at high risk, i.e. with lead pipelines, are supposed
to be sampled. As one can read in the article the removal is highly
controversial, in particular, because the proportion of critical
observations falls below the 10% action threshold when these two values
are removed. For this blog entry, we will, however, work with the full
&lt;span class=&quot;math inline&quot;&gt;\(n=71\)&lt;/span&gt; sample and focus on the
&lt;strong&gt;quantile aspect&lt;/strong&gt; of the calculation.&lt;/p&gt;
&lt;h2 id=&quot;percentages-and-quantiles&quot;&gt;Percentages and Quantiles&lt;/h2&gt;
&lt;p&gt;Let &lt;span class=&quot;math inline&quot;&gt;\(n\)&lt;/span&gt; denote the size of the
selected sample, which in our case is &lt;span
class=&quot;math inline&quot;&gt;\(n=71\)&lt;/span&gt;. If more than 10% of the sample is
to be above 15 ppb, this means that &lt;span class=&quot;math inline&quot;&gt;\(\lfloor
0.1\cdot n +
1\rfloor\)&lt;/span&gt; of the samples need to be above 15 ppb, where &lt;span
class=&quot;math inline&quot;&gt;\(\lfloor y
\rfloor\)&lt;/span&gt; denotes the largest integer less than or equal to &lt;span
class=&quot;math inline&quot;&gt;\(y\)&lt;/span&gt;. We shall denote this the
&lt;strong&gt;number of critical samples&lt;/strong&gt;. If we divide this number by
&lt;span class=&quot;math inline&quot;&gt;\(n\)&lt;/span&gt; we get the actual proportion of
critical samples needed before action. It is worthwhile noting the
difference between this critical proportion and the 10% threshold
illustrated by the sawtooth curve in the figure below. The explanation
for these sawtooth step-spikes is the discreteness of the decision
problem (i.e. &lt;span class=&quot;math inline&quot;&gt;\(x\)&lt;/span&gt; out of &lt;span
class=&quot;math inline&quot;&gt;\(n\)&lt;/span&gt;).&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/blog/figure/source/2017-06-18-quantiles/SAWTOOTH-1.png&quot; style=&quot;display: block; margin: auto;&quot; /&gt;&lt;/p&gt;
&lt;p&gt;Turning to the equivalent &lt;em&gt;90% quantile is above 15 ppm&lt;/em&gt;
decision criterion of the CFR, one will need to determine the 90%
quantile from the finite sample of lead concentration measurements. How
to estimate quantiles with statistical software is discussed in the
excellent survey of &lt;span class=&quot;citation&quot;
data-cites=&quot;hyndman_fan1996&quot;&gt;Hyndman and Fan (1996)&lt;/span&gt;. In their
work they describe the nine different quantile estimators implemented in
R’s &lt;code&gt;quantile&lt;/code&gt; function. The estimators are all based on the
&lt;a href=&quot;https://en.wikipedia.org/wiki/Order_statistic&quot;&gt;order
statistic&lt;/a&gt; of the sample, i.e. let &lt;span
class=&quot;math inline&quot;&gt;\(x_{(1)} \leq x_{(2)} &amp;lt; \cdots \leq
x_{(n)}\)&lt;/span&gt; denote the ordered lead concentration measurements.
Then the simplest estimator for the &lt;span class=&quot;math inline&quot;&gt;\(p\cdot
100\%\)&lt;/span&gt; quantile is&lt;/p&gt;
&lt;p&gt;&lt;span class=&quot;math display&quot;&gt;\[
\hat{x}_p = \min_{k} \left\{\hat{F}(x_{(k)}) \geq p\right\} =
x_{(\lceil n \cdot p\rceil)},
\]&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;where &lt;span class=&quot;math inline&quot;&gt;\(\hat{F}\)&lt;/span&gt; is the &lt;a
href=&quot;https://en.wikipedia.org/wiki/Empirical_distribution_function&quot;&gt;empirical
cumulative distribution&lt;/a&gt; function of the sample and &lt;span
class=&quot;math inline&quot;&gt;\(\lceil y \rceil\)&lt;/span&gt; denotes the smallest
integer greater than or equal to &lt;span class=&quot;math inline&quot;&gt;\(y\)&lt;/span&gt;.
This method corresponds to R’s &lt;code&gt;type=1&lt;/code&gt;. For our application
&lt;span class=&quot;math inline&quot;&gt;\(p\)&lt;/span&gt; would be 0.9 and the 90th
percentile for the Flint data is thus&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb4&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb4-1&quot;&gt;&lt;a href=&quot;#cb4-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;c&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;quot;manual.90%&amp;quot;&lt;/span&gt;&lt;span class=&quot;ot&quot;&gt;=&lt;/span&gt;lead[&lt;span class=&quot;fu&quot;&gt;ceiling&lt;/span&gt;(n&lt;span class=&quot;sc&quot;&gt;*&lt;/span&gt;p)], &lt;span class=&quot;at&quot;&gt;R=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;quantile&lt;/span&gt;(lead, &lt;span class=&quot;at&quot;&gt;probs=&lt;/span&gt;p, &lt;span class=&quot;at&quot;&gt;type=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;))&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;## manual.90%      R.90% 
##         18         18&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;which is above the action threshold of 15 ppb. It is also important
to note that when &lt;span class=&quot;math inline&quot;&gt;\(x_{(\lceil n \cdot
0.9\rceil)} &amp;gt; 15\&amp;gt; \text{ppb}\)&lt;/span&gt; then a total &lt;span
class=&quot;math inline&quot;&gt;\(n - \lceil n \cdot 0.9\rceil + 1\)&lt;/span&gt; samples
are above 15 ppm. In other words the proportion of samples above 15 ppm
in this situation is &lt;span class=&quot;math display&quot;&gt;\[ \frac{n - \lceil n
\cdot 0.9\rceil + 1}{n}.\]&lt;/span&gt; To show the duality between the
&lt;em&gt;more than 10% critical samples&lt;/em&gt; and the 90% quantile being above
15 ppm we thus need to show that &lt;span class=&quot;math inline&quot;&gt;\((n - \lceil
n
\cdot 0.9\rceil + 1)/n = (\lfloor 0.1\cdot n + 1\rfloor)/n\)&lt;/span&gt;.
This is possible since the following &lt;a
href=&quot;https://en.wikipedia.org/wiki/Floor_and_ceiling_functions&quot;&gt;relations
hold for the floor and ceiling functions&lt;/a&gt;: &lt;span
class=&quot;math display&quot;&gt;\[ \begin{align*}
- \lceil y \rceil &amp;amp;= \lfloor -y \rfloor \quad \text{and} \\
n + \lfloor y \rfloor &amp;amp;= \lfloor n + y \rfloor,
\end{align*}
\]&lt;/span&gt; with &lt;span class=&quot;math inline&quot;&gt;\(n\)&lt;/span&gt; being an integer
and &lt;span class=&quot;math inline&quot;&gt;\(y\)&lt;/span&gt; any real number. Thus, &lt;span
class=&quot;math display&quot;&gt;\[
(n+1) - \lceil n \cdot 0.9\rceil = (n+1) + \lfloor -n \cdot 0.9\rfloor =
\lfloor (n+1) -  n \cdot 0.9\rfloor = \lfloor 0.1n+1 \rfloor.
\]&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Important conclusion&lt;/strong&gt;: We have thus shown that with
the &lt;code&gt;type=1&lt;/code&gt; quantile method we have the duality between
having more than 10% critical samples and the 90th percentile of the
measurements being above 15 ppm.&lt;/p&gt;
&lt;h3 id=&quot;other-quantile-types&quot;&gt;Other Quantile Types&lt;/h3&gt;
&lt;p&gt;Since &lt;span class=&quot;math inline&quot;&gt;\(\hat{F}\)&lt;/span&gt; has jumps of size
&lt;span class=&quot;math inline&quot;&gt;\(1/n\)&lt;/span&gt; the actual value of &lt;span
class=&quot;math inline&quot;&gt;\(\hat{F}(\hat{x}_{p})\)&lt;/span&gt; can end up being
somewhat larger than the desired &lt;span class=&quot;math inline&quot;&gt;\(p\)&lt;/span&gt;.
Therefore, &lt;span class=&quot;citation&quot; data-cites=&quot;hyndman_fan1996&quot;&gt;Hyndman
and Fan (1996)&lt;/span&gt; prefer estimators interpolating between two
adjacent order statistics. Also because such estimators have a lower
mean squared error in most cases &lt;span class=&quot;citation&quot;
data-cites=&quot;dielman_etal1994&quot;&gt;(Dielman, Lowry, and Pfaffenberger
1994)&lt;/span&gt;. As an example of such an extended estimator, the
&lt;code&gt;type=5&lt;/code&gt; quantile estimator is defined by letting &lt;span
class=&quot;math inline&quot;&gt;\(h=p n + 1/2\)&lt;/span&gt; and then computing: &lt;span
class=&quot;math display&quot;&gt;\[
\hat{x}_p = x_{\lfloor h \rfloor} + (h - \lfloor h \rfloor) (x_{\lfloor
h
\rfloor + 1} - x_{\lfloor h \rfloor}).
\]&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;Doing this either manually or using the &lt;code&gt;quantile&lt;/code&gt;
function one obtains:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb6&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb6-1&quot;&gt;&lt;a href=&quot;#cb6-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;## Small function to manually compute the type=5 p*100th quantile&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb6-2&quot;&gt;&lt;a href=&quot;#cb6-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;## for the sample x&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb6-3&quot;&gt;&lt;a href=&quot;#cb6-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;manual_quantile_5 &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;cf&quot;&gt;function&lt;/span&gt;(x, p) {&lt;/span&gt;
&lt;span id=&quot;cb6-4&quot;&gt;&lt;a href=&quot;#cb6-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  h &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;length&lt;/span&gt;(x)&lt;span class=&quot;sc&quot;&gt;*&lt;/span&gt;p &lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;fl&quot;&gt;0.5&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb6-5&quot;&gt;&lt;a href=&quot;#cb6-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  x &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;sort&lt;/span&gt;(x)&lt;/span&gt;
&lt;span id=&quot;cb6-6&quot;&gt;&lt;a href=&quot;#cb6-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;return&lt;/span&gt;(x[&lt;span class=&quot;fu&quot;&gt;floor&lt;/span&gt;(h)] &lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt; (h &lt;span class=&quot;sc&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;floor&lt;/span&gt;(h))&lt;span class=&quot;sc&quot;&gt;*&lt;/span&gt; (x[&lt;span class=&quot;fu&quot;&gt;floor&lt;/span&gt;(h)&lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;] &lt;span class=&quot;sc&quot;&gt;-&lt;/span&gt; x[&lt;span class=&quot;fu&quot;&gt;floor&lt;/span&gt;(h)]))&lt;/span&gt;
&lt;span id=&quot;cb6-7&quot;&gt;&lt;a href=&quot;#cb6-7&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;}&lt;/span&gt;
&lt;span id=&quot;cb6-8&quot;&gt;&lt;a href=&quot;#cb6-8&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb6-9&quot;&gt;&lt;a href=&quot;#cb6-9&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;c&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;quot;manual.90%&amp;quot;&lt;/span&gt;&lt;span class=&quot;ot&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;manual_quantile_5&lt;/span&gt;(lead, &lt;span class=&quot;at&quot;&gt;p=&lt;/span&gt;&lt;span class=&quot;fl&quot;&gt;0.9&lt;/span&gt;), &lt;span class=&quot;at&quot;&gt;R=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;quantile&lt;/span&gt;(lead, &lt;span class=&quot;at&quot;&gt;probs=&lt;/span&gt;&lt;span class=&quot;fl&quot;&gt;0.9&lt;/span&gt;,&lt;span class=&quot;at&quot;&gt;type=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;5&lt;/span&gt;))&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;## manual.90%      R.90% 
##       18.8       18.8&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Instead of reading the above or using the R code one can also instead
watch a more &lt;a href=&quot;https://youtu.be/9pql00zr700&quot;&gt;didactic whiteboard
explanation&lt;/a&gt; for &lt;a
href=&quot;http://michiganradio.org/post/video-how-dropping-two-flints-lead-test-numbers-changed-things-state&quot;&gt;Michigan
Radio&lt;/a&gt; by Professor &lt;a
href=&quot;http://www.emich.edu/math/faculty/cgardiner.php&quot;&gt;Christopher
Gardiner&lt;/a&gt; on how to calculate the 90% quantile using a
&lt;code&gt;type=5&lt;/code&gt; argument for the Flint sample. However, the
important point of the above calculations is that this quantile type is
&lt;strong&gt;of limited interest&lt;/strong&gt;, because the Lead and Copper Rule
implicitly defines that one has to use the &lt;code&gt;type=1&lt;/code&gt; quantile.
To make this point even more explicit, we use sampling with replacement
from the Flint data to construct a dataset, where the 90%
&lt;code&gt;type=5&lt;/code&gt;-quantile is above 15 ppm, but the percentage of
samples above the 15 ppm threshold is less than 10%.&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb8&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb8-1&quot;&gt;&lt;a href=&quot;#cb8-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##Function to compute the proportion critical as well as the 90% quantile&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb8-2&quot;&gt;&lt;a href=&quot;#cb8-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##using type (type)-quantiles. Returns the quantile as well as the proportion&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb8-3&quot;&gt;&lt;a href=&quot;#cb8-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##above the 15 ppm threshold&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb8-4&quot;&gt;&lt;a href=&quot;#cb8-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;prop_critical_and_q90 &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;cf&quot;&gt;function&lt;/span&gt;(x, &lt;span class=&quot;at&quot;&gt;type=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;5&lt;/span&gt;) {&lt;/span&gt;
&lt;span id=&quot;cb8-5&quot;&gt;&lt;a href=&quot;#cb8-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  q90 &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;as.numeric&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;quantile&lt;/span&gt;(x, &lt;span class=&quot;at&quot;&gt;type=&lt;/span&gt;type,&lt;span class=&quot;at&quot;&gt;probs=&lt;/span&gt;p))&lt;/span&gt;
&lt;span id=&quot;cb8-6&quot;&gt;&lt;a href=&quot;#cb8-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  prop &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;mean&lt;/span&gt;(x&lt;span class=&quot;sc&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;15&lt;/span&gt;)&lt;/span&gt;
&lt;span id=&quot;cb8-7&quot;&gt;&lt;a href=&quot;#cb8-7&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;c&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;q90=&lt;/span&gt;q90,&lt;span class=&quot;at&quot;&gt;prop=&lt;/span&gt; prop)&lt;/span&gt;
&lt;span id=&quot;cb8-8&quot;&gt;&lt;a href=&quot;#cb8-8&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;}&lt;/span&gt;
&lt;span id=&quot;cb8-9&quot;&gt;&lt;a href=&quot;#cb8-9&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb8-10&quot;&gt;&lt;a href=&quot;#cb8-10&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##Make 100 datasets by sampling with replacement&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb8-11&quot;&gt;&lt;a href=&quot;#cb8-11&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;r &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;data.frame&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;seed=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;seq_len&lt;/span&gt;(&lt;span class=&quot;dv&quot;&gt;100&lt;/span&gt;)) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; rowwise &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;do&lt;/span&gt;({&lt;/span&gt;
&lt;span id=&quot;cb8-12&quot;&gt;&lt;a href=&quot;#cb8-12&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;set.seed&lt;/span&gt;(.&lt;span class=&quot;sc&quot;&gt;$&lt;/span&gt;seed)&lt;/span&gt;
&lt;span id=&quot;cb8-13&quot;&gt;&lt;a href=&quot;#cb8-13&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  newdata &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;sample&lt;/span&gt;(lead, &lt;span class=&quot;at&quot;&gt;replace=&lt;/span&gt;&lt;span class=&quot;cn&quot;&gt;TRUE&lt;/span&gt;)&lt;/span&gt;
&lt;span id=&quot;cb8-14&quot;&gt;&lt;a href=&quot;#cb8-14&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;as.data.frame&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;seed=&lt;/span&gt;.&lt;span class=&quot;sc&quot;&gt;$&lt;/span&gt;seed, &lt;span class=&quot;fu&quot;&gt;t&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;prop_critical_and_q90&lt;/span&gt;(newdata)))&lt;/span&gt;
&lt;span id=&quot;cb8-15&quot;&gt;&lt;a href=&quot;#cb8-15&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;})&lt;/span&gt;
&lt;span id=&quot;cb8-16&quot;&gt;&lt;a href=&quot;#cb8-16&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb8-17&quot;&gt;&lt;a href=&quot;#cb8-17&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##Check which datasets violate the duality between quantile and&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb8-18&quot;&gt;&lt;a href=&quot;#cb8-18&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##percentage above threshold assumption&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb8-19&quot;&gt;&lt;a href=&quot;#cb8-19&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;r &lt;span class=&quot;sc&quot;&gt;%&amp;lt;&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;mutate&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;violates_duality =&lt;/span&gt;  q90 &lt;span class=&quot;sc&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;dv&quot;&gt;15&lt;/span&gt; &lt;span class=&quot;sc&quot;&gt;&amp;amp;&lt;/span&gt; prop &lt;span class=&quot;sc&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;fl&quot;&gt;0.1&lt;/span&gt;)&lt;/span&gt;
&lt;span id=&quot;cb8-20&quot;&gt;&lt;a href=&quot;#cb8-20&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb8-21&quot;&gt;&lt;a href=&quot;#cb8-21&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##Do the stats for this dataset&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb8-22&quot;&gt;&lt;a href=&quot;#cb8-22&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;(five &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; r &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;filter&lt;/span&gt;(violates_duality) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;slice&lt;/span&gt;(&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;5&lt;/span&gt;))&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;## Source: local data frame [5 x 3]
## Groups: &amp;lt;by row&amp;gt;
## 
## # A tibble: 5 x 3
##     q90   prop violates_duality
##   &amp;lt;dbl&amp;gt;  &amp;lt;dbl&amp;gt; &amp;lt;lgl&amp;gt;           
## 1  15.  0.0986 TRUE            
## 2  15.  0.0986 TRUE            
## 3  16.2 0.0986 TRUE            
## 4  15.  0.0986 TRUE            
## 5  15.8 0.0986 TRUE&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;We note that some of the lines in the above output are artifacts of
lacking numerical precision: the quantile is only above 15 due to
numerical imprecision in the calculation of the &lt;code&gt;type=5&lt;/code&gt;
quantile:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb10&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb10-1&quot;&gt;&lt;a href=&quot;#cb10-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;print&lt;/span&gt;(five&lt;span class=&quot;sc&quot;&gt;$&lt;/span&gt;q90, &lt;span class=&quot;at&quot;&gt;digits=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;20&lt;/span&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;## [1] 15.000000000000028422 15.000000000000028422 16.200000000000045475
## [4] 15.000000000000028422 15.800000000000039790&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;This shows that regulatory business with &lt;a
href=&quot;https://en.wikipedia.org/wiki/Floating-point_arithmetic&quot;&gt;floating
point arithmetic&lt;/a&gt; is tricky. As a step towards fixing the problem,
one could redefine the greater and less than operators, respectively, to
only compare up to numerical precision:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb12&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb12-1&quot;&gt;&lt;a href=&quot;#cb12-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##Function to do numerical safe greater than comparision&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb12-2&quot;&gt;&lt;a href=&quot;#cb12-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;%greater%&amp;quot;&lt;/span&gt; &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;cf&quot;&gt;function&lt;/span&gt;(x,y) {&lt;/span&gt;
&lt;span id=&quot;cb12-3&quot;&gt;&lt;a href=&quot;#cb12-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  equal_up_to_numerical_precision &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;isTRUE&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;all.equal&lt;/span&gt;(x,y))&lt;/span&gt;
&lt;span id=&quot;cb12-4&quot;&gt;&lt;a href=&quot;#cb12-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;return&lt;/span&gt;( (x &lt;span class=&quot;sc&quot;&gt;&amp;gt;&lt;/span&gt; y) &lt;span class=&quot;sc&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;sc&quot;&gt;!&lt;/span&gt;(equal_up_to_numerical_precision) )&lt;/span&gt;
&lt;span id=&quot;cb12-5&quot;&gt;&lt;a href=&quot;#cb12-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;}&lt;/span&gt;
&lt;span id=&quot;cb12-6&quot;&gt;&lt;a href=&quot;#cb12-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb12-7&quot;&gt;&lt;a href=&quot;#cb12-7&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##Function to do numerical safe less than  comparision&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb12-8&quot;&gt;&lt;a href=&quot;#cb12-8&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;%less%&amp;quot;&lt;/span&gt; &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;cf&quot;&gt;function&lt;/span&gt;(x,y) {&lt;/span&gt;
&lt;span id=&quot;cb12-9&quot;&gt;&lt;a href=&quot;#cb12-9&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  equal_up_to_numerical_precision &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;isTRUE&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;all.equal&lt;/span&gt;(x,y))&lt;/span&gt;
&lt;span id=&quot;cb12-10&quot;&gt;&lt;a href=&quot;#cb12-10&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;return&lt;/span&gt;( (x &lt;span class=&quot;sc&quot;&gt;&amp;lt;&lt;/span&gt; y) &lt;span class=&quot;sc&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;sc&quot;&gt;!&lt;/span&gt;(equal_up_to_numerical_precision) )&lt;/span&gt;
&lt;span id=&quot;cb12-11&quot;&gt;&lt;a href=&quot;#cb12-11&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;}&lt;/span&gt;
&lt;span id=&quot;cb12-12&quot;&gt;&lt;a href=&quot;#cb12-12&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb12-13&quot;&gt;&lt;a href=&quot;#cb12-13&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##Add the new column, which does &amp;lt; and &amp;gt; comparisons only up to&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb12-14&quot;&gt;&lt;a href=&quot;#cb12-14&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##numerical precision&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb12-15&quot;&gt;&lt;a href=&quot;#cb12-15&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;r &lt;span class=&quot;sc&quot;&gt;%&amp;lt;&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;mutate&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;violates_duality_numsafe =&lt;/span&gt;  (q90 &lt;span class=&quot;sc&quot;&gt;%greater%&lt;/span&gt; &lt;span class=&quot;dv&quot;&gt;15&lt;/span&gt;) &lt;span class=&quot;sc&quot;&gt;&amp;amp;&lt;/span&gt; (prop &lt;span class=&quot;sc&quot;&gt;%less%&lt;/span&gt; &lt;span class=&quot;fl&quot;&gt;0.1&lt;/span&gt;))&lt;/span&gt;
&lt;span id=&quot;cb12-16&quot;&gt;&lt;a href=&quot;#cb12-16&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb12-17&quot;&gt;&lt;a href=&quot;#cb12-17&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##Show five violation candidates for this corrected dataset&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb12-18&quot;&gt;&lt;a href=&quot;#cb12-18&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;(five &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; r &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;filter&lt;/span&gt;(violates_duality_numsafe) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;slice&lt;/span&gt;(&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;5&lt;/span&gt;))&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;## Source: local data frame [5 x 4]
## Groups: &amp;lt;by row&amp;gt;
## 
## # A tibble: 5 x 4
##     q90   prop violates_duality violates_duality_numsafe
##   &amp;lt;dbl&amp;gt;  &amp;lt;dbl&amp;gt; &amp;lt;lgl&amp;gt;            &amp;lt;lgl&amp;gt;                   
## 1  16.2 0.0986 TRUE             TRUE                    
## 2  15.8 0.0986 TRUE             TRUE                    
## 3  15.8 0.0986 TRUE             TRUE                    
## 4  16.2 0.0986 TRUE             TRUE                    
## 5  16.2 0.0986 TRUE             TRUE&lt;/code&gt;&lt;/pre&gt;
&lt;h2 id=&quot;discussion&quot;&gt;Discussion&lt;/h2&gt;
&lt;p&gt;To summarize the findings: The type of quantile estimation used in
practice matters. It is not clear what to do, if &lt;span
class=&quot;math inline&quot;&gt;\(0.9\cdot n\)&lt;/span&gt; is not integer in the
estimation of the 90% quantile under the Lead and Copper Rule. For the
Flint example the 63’rd sorted value is 13 which is below threshold,
whereas the 64’th value is 18 which is above the threshold. If we use
&lt;code&gt;type=1&lt;/code&gt; then &lt;span class=&quot;math inline&quot;&gt;\(\lceil 71\cdot
0.9\rceil=64\)&lt;/span&gt; would be the correct value to take and the 90%
quantile of the sample would be estimated to be 18 ppb. This means that
the 19 ppb vertical line in the figure of &lt;span class=&quot;citation&quot;
data-cites=&quot;langkjaerbain2017&quot;&gt;Langkjær-Bain (2017)&lt;/span&gt; is a little
misleading, because this appears to be the rounded &lt;code&gt;type=5&lt;/code&gt;
quantile. For the setting with &lt;span class=&quot;math inline&quot;&gt;\(n=71\)&lt;/span&gt;
samples, both estimators are although above the action threshold of 15
ppb, so in the particular Flint application it does not matter so much
which method to take. However, in other settings this might very well
make a difference! So &lt;strong&gt;be careful with the type argument of the
quantile function&lt;/strong&gt;. As an example, the nine different types of
R’s &lt;code&gt;quantile&lt;/code&gt; function provide estimates for the 90%
quantile in the range from 17.50 to 19.60 for the Flint data. The
default type argument in R is &lt;code&gt;type=7&lt;/code&gt;, so if nothing else is
specified when calling the quantile function &lt;code&gt;type=7&lt;/code&gt; is what
you get.&lt;/p&gt;
&lt;p&gt;On another note, one can discuss if it is a good idea to rely on the
&lt;code&gt;type=1&lt;/code&gt; quantile estimator in the rule, because it is well
known that this type does not have as good estimation properties as,
e.g., &lt;code&gt;type=5&lt;/code&gt;. However, &lt;code&gt;type=1&lt;/code&gt; is simpler to
compute, &lt;strong&gt;ensures duality&lt;/strong&gt; with the intuitive critical
proportion, and has the property that the obtained value is always one
also occurring in the sample. The later thus avoids the issue of
numerical instability.&lt;/p&gt;
&lt;p&gt;Finally, the &lt;a
href=&quot;https://blogs.sas.com/content/iml/2017/05/17/quantiles-flint-water-crisis.html&quot;&gt;blog
post&lt;/a&gt; by Rick Wicklin addresses quantile estimation from an even more
statistical viewpoint by computing confidence intervals for the quantile
- a topic, which has been &lt;a
href=&quot;http://staff.math.su.se/hoehle/blog/2016/10/23/quantileCI.html&quot;&gt;previously
treated theoretically&lt;/a&gt; in this blog. Compliance to a given quantile
threshold based on samples has also been treated in the entirely
different context of digital elevation models &lt;span class=&quot;citation&quot;
data-cites=&quot;hoehle_hoehle2009&quot;&gt;(Höhle and Höhle 2009)&lt;/span&gt;. Typically,
tests and the dual confidence intervals are in this regulation setting
formulated in a reversed way, such that one needs to provide enough
evidence to show that underlying 90th percentile is indeed below 15 ppm
beyond reasonable doubt. An interesting question in this context is how
large the sample needs to be in order to do this with a given certainty
- see &lt;span class=&quot;citation&quot; data-cites=&quot;hoehle_hoehle2009&quot;&gt;Höhle and
Höhle (2009)&lt;/span&gt; for details. It is, however, worthwhile pointing out
that the Lead and Copper Rule does not know about confidence intervals.
Currently, &lt;strong&gt;estimation uncertainty&lt;/strong&gt; is only treated
implicitly by specifying sample size as a function of number of people
served by the water system and then hard-thresholding the result at 15
ppm.&lt;/p&gt;
&lt;strong&gt;On a Personal Note&lt;/strong&gt;: If you want more details on the use
of confidence intervals for quantiles, join my 5 minute &lt;a
href=&quot;https://user2017.sched.com/event/Axs8/better-confidence-intervals-for-quantiles?iframe=yes&amp;amp;w=100%&amp;amp;sidebar=yes&amp;amp;bg=no&quot;&gt;lightning
talk&lt;/a&gt; on 6th of July at the &lt;a
href=&quot;https://user2017.brussels&quot;&gt;useR!2017 conference&lt;/a&gt; in Brussels.
&lt;p&gt;
&lt;center&gt;
&lt;img
src=&quot;https://c1.staticflickr.com/9/8760/29032559971_6662607e05.jpg&quot; /&gt;
&lt;/center&gt;
&lt;FONT COLOR=&quot;bbbbbb&quot;&gt;Photo is copyright &lt;a
href=&quot;https://www.flickr.com/photos/hz536n/29032559971/&quot;&gt;George
Thomas&lt;/a&gt; under a CC BY-NC-ND 2.0 license.&lt;/FONT&gt;
&lt;p&gt;
&lt;h2 id=&quot;acknowledgments&quot;&gt;Acknowledgments&lt;/h2&gt;
&lt;p&gt;Thanks goes to Brian Tarran, editor of the Significance Magazine, for
providing additional information about the quantile computation of the
&lt;span class=&quot;citation&quot; data-cites=&quot;langkjaerbain2017&quot;&gt;Langkjær-Bain
(2017)&lt;/span&gt; article and for pointing out the Gardiner video.&lt;/p&gt;
&lt;h2 class=&quot;unnumbered&quot; id=&quot;references&quot;&gt;References&lt;/h2&gt;
&lt;div id=&quot;refs&quot; class=&quot;references csl-bib-body hanging-indent&quot;
data-entry-spacing=&quot;0&quot; role=&quot;list&quot;&gt;
&lt;div id=&quot;ref-dielman_etal1994&quot; class=&quot;csl-entry&quot; role=&quot;listitem&quot;&gt;
Dielman, T., C. Lowry, and R. Pfaffenberger. 1994. &lt;span&gt;“A Comparison
of Quantile Estimators.”&lt;/span&gt; &lt;em&gt;Communications in Statistics -
Simulation and Computation&lt;/em&gt; 23 (2): 355–71. &lt;a
href=&quot;https://doi.org/10.1080/03610919408813175&quot;&gt;https://doi.org/10.1080/03610919408813175&lt;/a&gt;.
&lt;/div&gt;
&lt;div id=&quot;ref-hoehle_hoehle2009&quot; class=&quot;csl-entry&quot; role=&quot;listitem&quot;&gt;
Höhle, J., and M. Höhle. 2009. &lt;span&gt;“Accuracy Assessment of Digital
Elevation Models by Means of Robust Statistical Methods.”&lt;/span&gt;
&lt;em&gt;ISPRS Journal of Photogrammetry and Remote Sensing&lt;/em&gt; 64 (4):
398–406. &lt;a
href=&quot;https://doi.org/10.1016/j.isprsjprs.2009.02.003&quot;&gt;https://doi.org/10.1016/j.isprsjprs.2009.02.003&lt;/a&gt;.
&lt;/div&gt;
&lt;div id=&quot;ref-hyndman_fan1996&quot; class=&quot;csl-entry&quot; role=&quot;listitem&quot;&gt;
Hyndman, R. J., and Y. Fan. 1996. &lt;span&gt;“Sample Quantiles in Statistical
Packages.”&lt;/span&gt; &lt;em&gt;American Statistician&lt;/em&gt; 50 (4): 361–65. &lt;a
href=&quot;https://doi.org/10.2307/2684934&quot;&gt;https://doi.org/10.2307/2684934&lt;/a&gt;.
&lt;/div&gt;
&lt;div id=&quot;ref-langkjaerbain2017&quot; class=&quot;csl-entry&quot; role=&quot;listitem&quot;&gt;
Langkjær-Bain, Robert. 2017. &lt;span&gt;“The Murky Tale of Flint’s Deceptive
Water Data.”&lt;/span&gt; &lt;em&gt;Significance&lt;/em&gt; 14 (2): 16–21. &lt;a
href=&quot;https://doi.org/10.1111/j.1740-9713.2017.01016.x&quot;&gt;https://doi.org/10.1111/j.1740-9713.2017.01016.x&lt;/a&gt;.
&lt;/div&gt;
&lt;/div&gt;
</description>
        <pubDate>Sun, 18 Jun 2017 00:00:00 +0200</pubDate>
        <link>https://mhoehle.github.io/blog/2017/06/18/quantiles.html</link>
        <guid isPermaLink="true">https://mhoehle.github.io/blog/2017/06/18/quantiles.html</guid>
        
        <category>rstats</category>
        
        <category>stats</category>
        
        <category>regulation</category>
        
        <category>EPA</category>
        
        
      </item>
    
      <item>
        <title>Estimating the Size of a Demonstration</title>
        <description>&lt;h2 id=&quot;abstract&quot;&gt;Abstract&lt;/h2&gt;
&lt;p&gt;Inspired by the recent &lt;strong&gt;March For Science&lt;/strong&gt; we look
into methods for the statistical estimation of the number of people
participating in a demonstration organized as a march. In particular, we
provide R code to reproduce the &lt;strong&gt;two on-the-spot counting
method&lt;/strong&gt; analysis of &lt;span class=&quot;citation&quot;
data-cites=&quot;yip_etal2010&quot;&gt;Yip et al. (2010)&lt;/span&gt; for the data of the
July 1 March in Hong Kong 2006.&lt;/p&gt;
&lt;center&gt;
&lt;img
src=&quot;https://upload.wikimedia.org/wikipedia/commons/thumb/c/c0/Hong_Kong_July_1_Marches.jpg/640px-Hong_Kong_July_1_Marches.jpg&quot; /&gt;
&lt;/center&gt;
&lt;p&gt;&lt;br&gt;
&lt;a rel=&quot;license&quot; href=&quot;http://creativecommons.org/licenses/by-sa/4.0/&quot;&gt;&lt;img alt=&quot;Creative Commons License&quot; style=&quot;border-width:0&quot; src=&quot;https://i.creativecommons.org/l/by-sa/4.0/88x31.png&quot;/&gt;&lt;/a&gt;
This work is licensed under a &lt;a rel=&quot;license&quot;
href=&quot;http://creativecommons.org/licenses/by-sa/4.0/&quot;&gt;Creative Commons
Attribution-ShareAlike 4.0 International License&lt;/a&gt;. The
markdown+Rknitr source code of this blog is available under a &lt;a
href=&quot;https://www.gnu.org/licenses/gpl-3.0.html&quot;&gt;GNU General Public
License (GPL v3)&lt;/a&gt; license from github.&lt;/p&gt;
&lt;h2 id=&quot;introduction&quot;&gt;Introduction&lt;/h2&gt;
&lt;p&gt;Exercising your democratic right to express support for a cause by
demonstration has found anew usage. The &lt;a
href=&quot;https://en.wikipedia.org/wiki/March_for_Science&quot;&gt;March for
Science&lt;/a&gt; is a recent examples of such a demonstration inspired by
recent political developments. The number of persons participating in
such marches is &lt;em&gt;the&lt;/em&gt; indicator by which the support of the cause
is measured. Crowd size estimates have therefore always been subject to
political interpretation and, hence, possible politically motivated
bias. In this work we focus on what statistics has to offer with respect
to finding the &lt;strong&gt;true number&lt;/strong&gt; of participants. A good
overview of this task’s challenges is given in &lt;span class=&quot;citation&quot;
data-cites=&quot;watson_yip2011&quot;&gt;Watson and Yip (2011)&lt;/span&gt;. A particular
difficulty is the size estimation of moving crowds as seen in
marches.&lt;/p&gt;
&lt;p&gt;As case study we replicate the analysis of &lt;span class=&quot;citation&quot;
data-cites=&quot;yip_etal2010&quot;&gt;Yip et al. (2010)&lt;/span&gt; on estimating the
number of participants in the &lt;a
href=&quot;https://en.wikipedia.org/wiki/Hong_Kong_1_July_marches#2006&quot;&gt;1st
of July Marches&lt;/a&gt; in Hong Kong. Since the handover to China in 1997
these marches have been conducted yearly to demonstrate for democracy
and freedom of speech in Hong Kong. Below is shown the 3.6 km long
demonstration route from &lt;a
href=&quot;https://de.wikipedia.org/wiki/Victoria_Park_(Hongkong)&quot;&gt;Victoria
Park&lt;/a&gt; to Government Headquarters for the 2006 demonstration as
described by &lt;span class=&quot;citation&quot; data-cites=&quot;yip_etal2010&quot;&gt;Yip et al.
(2010)&lt;/span&gt;. A &lt;a
href=&quot;https://www.youtube.com/watch?v=8WQ2TAEquxM&quot;&gt;youtube video&lt;/a&gt; of
the 2006 demonstration illustrates this better than words.&lt;/p&gt;
&lt;center&gt;
&lt;figure&gt;
&lt;img src=&quot;/blog/figure/source/2017-05-04-crowdsize/Route.png&quot;
alt=&quot;Route of the 1st of July 2006 demonstration in Hong Kong. The two points A and B indicate the location of the two counting points. Courtesy goes to Open Street Map.&quot; /&gt;
&lt;figcaption aria-hidden=&quot;true&quot;&gt;Route of the 1st of July 2006
demonstration in Hong Kong. The two points A and B indicate the location
of the two counting points. Courtesy goes to Open Street
Map.&lt;/figcaption&gt;
&lt;/figure&gt;
&lt;/center&gt;
Map Source: &lt;a
href=&quot;http://www.openstreetmap.org/#map=10/22.3810/114.1370&quot;&gt;Open Street
Map&lt;/a&gt;
&lt;p&gt;
&lt;p&gt;In order to estimate the number of participants a &lt;strong&gt;two
on-the-spot counting method&lt;/strong&gt; was devised by &lt;span
class=&quot;citation&quot; data-cites=&quot;yip_etal2010&quot;&gt;Yip et al. (2010)&lt;/span&gt;: Two
points along the march were selected as shown in the above map: Point A
denotes the location after which an individual is counted as being part
of the march. In order to take into account that people join the march
at a later point than A, a second point B is selected to adjust the
count at A for such late entries. Three to four persons were stationed
at each of the two counting locations. Once the demonstration passed the
respective point each of them started to count the number of people
passing in a one-minute intervals. They counted for one minute every 5
minutes until the last person of the march had passed the counting
point.&lt;/p&gt;
&lt;h3 id=&quot;loading-the-data&quot;&gt;Loading the Data&lt;/h3&gt;
&lt;p&gt;We store the resulting counting data displayed in Table 2 and Table 3
of &lt;span class=&quot;citation&quot; data-cites=&quot;yip_etal2010&quot;&gt;Yip et al.
(2010)&lt;/span&gt; as two Excel-files. In a data pre-processing step these
are then read and combined into one data.frame containing the columns
&lt;code&gt;Y1&lt;/code&gt;-&lt;code&gt;Y4&lt;/code&gt;. Furthermore, we re-format the table’s
time specification to proper POSIX formatted date-times. The exact data
dancing steps can be found in the accompanying &lt;a
href=&quot;https://github.com/hoehleatsu/hoehleatsu.github.io/blob/master/_source/2017-05-04-crowdsize.Rmd&quot;&gt;Rmd
code of this post&lt;/a&gt;. Altogether, this yields a &lt;code&gt;tbl&lt;/code&gt; with
the first couple of lines looking as follows:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;## # A tibble: 6 × 7
##      Y1    Y2    Y3    Y4     Mean Point          Time_POSIX
##   &amp;lt;dbl&amp;gt; &amp;lt;dbl&amp;gt; &amp;lt;dbl&amp;gt; &amp;lt;dbl&amp;gt;    &amp;lt;dbl&amp;gt; &amp;lt;chr&amp;gt;              &amp;lt;dttm&amp;gt;
## 1   150    NA   160   180 163.3333     A 2006-07-01 15:55:00
## 2   308   360   250   280 299.5000     A 2006-07-01 16:00:00
## 3   430   350   300   270 337.5000     A 2006-07-01 16:05:00
## 4   210   280   240   252 245.5000     A 2006-07-01 16:10:00
## 5   130   216   200   180 181.5000     A 2006-07-01 16:15:00
## 6   210   260   300   280 262.5000     A 2006-07-01 16:20:00&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;We then compute a number of row-wise statistics for all columns
containing the counts - which columns contain the counts is specified by
a regular expression &lt;code&gt;ccol_regexp&lt;/code&gt;. In our case would be
&lt;code&gt;&quot;^Y[0-9]+&quot;&lt;/code&gt;.&lt;/p&gt;
&lt;h3 id=&quot;descriptive-statistics&quot;&gt;Descriptive Statistics&lt;/h3&gt;
&lt;p&gt;The counts of the 4 counters at point A and the 3 counters at point B
are summarized in the following small table:&lt;/p&gt;
&lt;center&gt;
&lt;!-- html table generated in R 3.3.3 by xtable 1.8-2 package --&gt;
&lt;!-- Sat May  6 10:58:03 2017 --&gt;
&lt;table border=&quot;1,&quot; padding=&quot;10,&quot; style=&quot;width=80%&quot;&gt;
&lt;tr&gt;
&lt;th&gt;
Point
&lt;/th&gt;
&lt;th&gt;
n_counters
&lt;/th&gt;
&lt;th&gt;
n_timepoints
&lt;/th&gt;
&lt;th&gt;
sum_of_the_mean_counts
&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;
A
&lt;/td&gt;
&lt;td align=&quot;right&quot;&gt;
4
&lt;/td&gt;
&lt;td align=&quot;right&quot;&gt;
22
&lt;/td&gt;
&lt;td align=&quot;right&quot;&gt;
4849.50
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;
B
&lt;/td&gt;
&lt;td align=&quot;right&quot;&gt;
3
&lt;/td&gt;
&lt;td align=&quot;right&quot;&gt;
26
&lt;/td&gt;
&lt;td align=&quot;right&quot;&gt;
4746.67
&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/center&gt;
&lt;p&gt;
&lt;p&gt;A time series for the individual counts as well as their mean is
shown below. One observes that at point B the intensity of the crowd was
lower, as the observation had stretched over a larger distance. The
later is seen from the time span between the first and last count for
the two points: approximately 1:45h for A vs. 2:45h for B.&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/blog/figure/source/2017-05-04-crowdsize/TIMESERIES-1.png&quot; style=&quot;display: block; margin: auto;&quot; /&gt;&lt;/p&gt;
&lt;h2 id=&quot;two-on-the-spot-counting-method&quot;&gt;Two On-the-Spot Counting
Method&lt;/h2&gt;
&lt;p&gt;Below we give the mathematical details of the two on-the-spot
counting method. Consider the counting point &lt;span
class=&quot;math inline&quot;&gt;\(X\)&lt;/span&gt; of the march, i.e. &lt;span
class=&quot;math inline&quot;&gt;\(X\in
\{A,B\}\)&lt;/span&gt;. Let &lt;span class=&quot;math inline&quot;&gt;\(m_X\)&lt;/span&gt; be the
number of counters at this point. Assume that the first people of the
march pass &lt;span class=&quot;math inline&quot;&gt;\(X\)&lt;/span&gt; at time point &lt;span
class=&quot;math inline&quot;&gt;\(a_X\)&lt;/span&gt; and that last people of the march
reach &lt;span class=&quot;math inline&quot;&gt;\(X\)&lt;/span&gt; at time point &lt;span
class=&quot;math inline&quot;&gt;\(e_X\)&lt;/span&gt;. The time unit could for example be
minutes. Counting is done such that at regular intervals &lt;span
class=&quot;math inline&quot;&gt;\(c\)&lt;/span&gt; one counts all people passing the point
of observation within a time block of 1 unit - say 1 minute. Let &lt;span
class=&quot;math inline&quot;&gt;\(k_X\)&lt;/span&gt; denote the number of time points
where observations are available at &lt;span
class=&quot;math inline&quot;&gt;\(X\)&lt;/span&gt;. Hence, the &lt;span
class=&quot;math inline&quot;&gt;\(k_X\)&lt;/span&gt; observations at &lt;span
class=&quot;math inline&quot;&gt;\(X\)&lt;/span&gt; are available for the time points &lt;span
class=&quot;math inline&quot;&gt;\(a_X,a_X+c,a_X+2c,a_X+(k_X-1)c\)&lt;/span&gt;. Denote by
&lt;span class=&quot;math inline&quot;&gt;\(Y_{X,i}(t)\)&lt;/span&gt; the &lt;span
class=&quot;math inline&quot;&gt;\(i\)&lt;/span&gt;’th person’s count at time &lt;span
class=&quot;math inline&quot;&gt;\(t\)&lt;/span&gt;. Then&lt;/p&gt;
&lt;p&gt;&lt;span class=&quot;math display&quot;&gt;\[\overline{Y}_X(t) = \frac{1}{m_X}
\sum_{i=1}^{m_X} Y_{X,i}(t)\]&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;is the average of the observer’s counts at point &lt;span
class=&quot;math inline&quot;&gt;\(X\)&lt;/span&gt; for time &lt;span
class=&quot;math inline&quot;&gt;\(t\)&lt;/span&gt;. By scaling up each observer’s
observations to account for the time blocks without a count and
averaging over the different observers we get an estimate for the number
of participants at point &lt;span class=&quot;math inline&quot;&gt;\(X\)&lt;/span&gt;:&lt;/p&gt;
&lt;p&gt;&lt;span class=&quot;math display&quot;&gt;\[ \hat{N}_X = \frac{e_X}{k_X}
\sum_{j=1}^{k_X} \overline{Y}_X(a_X +
(j-1)c).\]&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;In most cases one would have that &lt;span
class=&quot;math inline&quot;&gt;\(e_X/k_X=c\)&lt;/span&gt;. As an example: If a counter
counts 200 people for &lt;em&gt;every&lt;/em&gt; 1-minute-counting-block during
two-hours, i.e. corresponding to 24 observations (one every five
minutes), her estimate for &lt;span class=&quot;math inline&quot;&gt;\(N_X\)&lt;/span&gt;
would be 200&lt;span class=&quot;math inline&quot;&gt;\(\cdot\)&lt;/span&gt; 24&lt;span
class=&quot;math inline&quot;&gt;\(\cdot\)&lt;/span&gt; 5= 24000.&lt;/p&gt;
&lt;p&gt;In order to adjust the estimate at point &lt;span
class=&quot;math inline&quot;&gt;\(A\)&lt;/span&gt; for people who joined the march after
point &lt;span class=&quot;math inline&quot;&gt;\(A\)&lt;/span&gt;, we perform an independent
counting at point &lt;span class=&quot;math inline&quot;&gt;\(B\)&lt;/span&gt; and
additionally ask &lt;span class=&quot;math inline&quot;&gt;\(m\)&lt;/span&gt; people at point
&lt;span class=&quot;math inline&quot;&gt;\(B\)&lt;/span&gt;, whether they marched past point
&lt;span class=&quot;math inline&quot;&gt;\(A\)&lt;/span&gt; or not. Denoting &lt;span
class=&quot;math inline&quot;&gt;\(\hat{\phi}\)&lt;/span&gt; the fraction of people
answering yes to this question the &lt;strong&gt;two on-the-spot counting
estimator&lt;/strong&gt; is &lt;span class=&quot;math display&quot;&gt;\[
\hat{N} = \hat{N}_A + (1-\hat{\phi}) \hat{N}_B.
\]&lt;/span&gt; Note that this estimator does not take into account that
people could potentially leave the march between &lt;span
class=&quot;math inline&quot;&gt;\(A\)&lt;/span&gt; and &lt;span
class=&quot;math inline&quot;&gt;\(B\)&lt;/span&gt; and that its also possible to join the
march after &lt;span class=&quot;math inline&quot;&gt;\(B\)&lt;/span&gt;. However, the
proportion of such participants is assumed to be negligible.&lt;/p&gt;
&lt;p&gt;A confidence interval (CI) based on an asymptotic normal assumption
can be obtained by deriving that &lt;span class=&quot;math display&quot;&gt;\[
\operatorname{se}(\hat{N}) =
\sqrt{\widehat{\operatorname{Var}}(\hat{N}_A) + (1-\hat{\phi})^2
\widehat{\operatorname{Var}}(\hat{N}_B) + \hat{N}_B^2
\frac{\hat{\phi}(1-\hat{\phi})}{m}},
\]&lt;/span&gt; where we have used that &lt;span class=&quot;math display&quot;&gt;\[
\widehat{\operatorname{Var}}(\hat{N}_X) =
\frac{e_X^2}{k_X^2} \sum_{j=1}^{k_X}
\widehat{\operatorname{Var}}(\overline{Y}_X(a_X + (j-1)c)) =
\frac{e_X^2}{k_X^2} \sum_{j=1}^{k_X}
\frac{\widehat{\operatorname{Var}}(Y_X(a_X + (j-1)c))}{m_X}
\]&lt;/span&gt; and &lt;span class=&quot;math display&quot;&gt;\[
\widehat{\operatorname{Var}}(Y_X(t)) =
\frac{1}{m_X-1}\sum_{i=1}^{m_X} (Y_{X,i}(t) - \overline{Y}_X(t)).
\]&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;A two-sided &lt;span class=&quot;math inline&quot;&gt;\((1-\alpha)\cdot
100\%\)&lt;/span&gt; CI is then constructed as &lt;span
class=&quot;math inline&quot;&gt;\(\hat{N}
\pm z_{1-\alpha/2} \operatorname{se}(\hat{N})\)&lt;/span&gt;, where &lt;span
class=&quot;math inline&quot;&gt;\(z_{1-\alpha/2}\)&lt;/span&gt; is the &lt;span
class=&quot;math inline&quot;&gt;\(1-\alpha/2\)&lt;/span&gt; quantile of the standard
normal distribution. To get a 95% CI the value is &lt;span
class=&quot;math inline&quot;&gt;\(z_{1-0.05/2}=1.96\)&lt;/span&gt;. Since &lt;span
class=&quot;math inline&quot;&gt;\(N\)&lt;/span&gt; is expected to be at least of moderate
size before one bothers counting this asymptotic CI should have decent
coverage.&lt;/p&gt;
&lt;h3 id=&quot;implementation-in-r&quot;&gt;Implementation in R&lt;/h3&gt;
&lt;p&gt;The above equations have been implemented as function
&lt;code&gt;two_on_the_spot_N&lt;/code&gt; in R, which given a &lt;code&gt;counts&lt;/code&gt;
data.frame computes the estimate and a corresponding confidence
interval. The &lt;a
href=&quot;https://github.com/hoehleatsu/hoehleatsu.github.io/blob/master/_source/2017-05-04-crowdsize.Rmd&quot;&gt;github
code of this post&lt;/a&gt; contains the details.&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb2&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb2-1&quot;&gt;&lt;a href=&quot;#cb2-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;args&lt;/span&gt;(two_on_the_spot_N)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;## function (counts, ccol_regexp = &amp;quot;^Y[0-9]+&amp;quot;, phi_estim, c = 5, 
##     conf.level = 0.95) 
## NULL&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Among 480 interviewed persons at point B, 437 reported to also have
passed point A. In other words &lt;span
class=&quot;math inline&quot;&gt;\(\hat{\phi}\)&lt;/span&gt;=91% and we obtain &lt;span
class=&quot;math inline&quot;&gt;\(\hat{N}\)&lt;/span&gt; as follows with R:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb4&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb4-1&quot;&gt;&lt;a href=&quot;#cb4-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##Compute the two on the spot estimate based on the data in counts&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-2&quot;&gt;&lt;a href=&quot;#cb4-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;N &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;two_on_the_spot_N&lt;/span&gt;(counts, &lt;span class=&quot;at&quot;&gt;phi_estim=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;c&lt;/span&gt;(&lt;span class=&quot;dv&quot;&gt;437&lt;/span&gt;,&lt;span class=&quot;dv&quot;&gt;480&lt;/span&gt;),&lt;span class=&quot;at&quot;&gt;conf.level=&lt;/span&gt;&lt;span class=&quot;fl&quot;&gt;0.95&lt;/span&gt;)&lt;/span&gt;
&lt;span id=&quot;cb4-3&quot;&gt;&lt;a href=&quot;#cb4-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-4&quot;&gt;&lt;a href=&quot;#cb4-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##Rounded version&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-5&quot;&gt;&lt;a href=&quot;#cb4-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;with&lt;/span&gt;(N, &lt;span class=&quot;fu&quot;&gt;round&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;c&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;estimate=&lt;/span&gt;estimate,ci)&lt;span class=&quot;sc&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;100&lt;/span&gt;)&lt;span class=&quot;sc&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;100&lt;/span&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;## estimate ci_lower ci_upper 
##    26400    25600    27200&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Our estimate for the number of participants is thus around 26400 with
a 95% confidence interval of 25600-27200. For comparison the authors
state that the Hong Kong Police’s estimate was around 28000, whereas the
organizers claimed a size of 58000.&lt;/p&gt;
&lt;h2 id=&quot;discussion&quot;&gt;Discussion&lt;/h2&gt;
&lt;p&gt;We were able to reproduce the results of &lt;span class=&quot;citation&quot;
data-cites=&quot;yip_etal2010&quot;&gt;Yip et al. (2010)&lt;/span&gt; using the article’s
data (up to some rounding issues). An R function is now available for
supporting mobile crowd estimation in the future. It will be interesting
to synthesize the traditional and easy to implement counting approach
described above with more modern data sources such as mobile phone or
twitter data &lt;span class=&quot;citation&quot; data-cites=&quot;botta_etal2015&quot;&gt;(Botta,
Moat, and Preis 2015)&lt;/span&gt;.&lt;/p&gt;
&lt;center&gt;
&lt;img
src=&quot;https://upload.wikimedia.org/wikipedia/commons/thumb/3/3d/Hong_Kong_1_July_march.jpg/640px-Hong_Kong_1_July_march.jpg&quot; /&gt;
&lt;/center&gt;
&lt;p&gt;&lt;br&gt; &lt;a
href=&quot;https://en.wikipedia.org/wiki/File:Hong_Kong_1_July_march.jpg&quot;&gt;Picture
Source&lt;/a&gt;: Ding Yuin Shan, Hong Kong, licensed under the Creative
Commons Attribution 2.0 Generic license.&lt;/p&gt;
&lt;div data-align=&quot;right&quot;&gt;
&lt;p&gt;QED.&lt;/p&gt;
&lt;/div&gt;
&lt;h2 class=&quot;unnumbered&quot; id=&quot;references&quot;&gt;References&lt;/h2&gt;
&lt;div id=&quot;refs&quot; class=&quot;references csl-bib-body hanging-indent&quot;
data-entry-spacing=&quot;0&quot; role=&quot;list&quot;&gt;
&lt;div id=&quot;ref-botta_etal2015&quot; class=&quot;csl-entry&quot; role=&quot;listitem&quot;&gt;
Botta, Federico, Helen Susannah Moat, and Tobias Preis. 2015.
&lt;span&gt;“Quantifying Crowd Size with Mobile Phone and Twitter
Data.”&lt;/span&gt; &lt;em&gt;Royal Society Open Science&lt;/em&gt; 2 (5). &lt;a
href=&quot;https://doi.org/10.1098/rsos.150162&quot;&gt;https://doi.org/10.1098/rsos.150162&lt;/a&gt;.
&lt;/div&gt;
&lt;div id=&quot;ref-watson_yip2011&quot; class=&quot;csl-entry&quot; role=&quot;listitem&quot;&gt;
Watson, Ray, and Paul Yip. 2011. &lt;span&gt;“How Many Were There When It
Mattered?”&lt;/span&gt; &lt;em&gt;Significance&lt;/em&gt; 8 (3): 104–7. &lt;a
href=&quot;https://doi.org/10.1111/j.1740-9713.2011.00502.x&quot;&gt;https://doi.org/10.1111/j.1740-9713.2011.00502.x&lt;/a&gt;.
&lt;/div&gt;
&lt;div id=&quot;ref-yip_etal2010&quot; class=&quot;csl-entry&quot; role=&quot;listitem&quot;&gt;
Yip, Paul S. F., Ray Watson, K. S. Chan, Eric H. Y. Lau, Feng Chen, Ying
Xu, Liqun Xi, Derek Y. T. Cheung, Brian Y. T. Ip, and Danping Liu. 2010.
&lt;span&gt;“Estimation of the Number of People in a Demonstration.”&lt;/span&gt;
&lt;em&gt;Australian &amp;amp; New Zealand Journal of Statistics&lt;/em&gt; 52 (1):
17–26. &lt;a
href=&quot;https://doi.org/10.1111/j.1467-842X.2009.00562.x&quot;&gt;https://doi.org/10.1111/j.1467-842X.2009.00562.x&lt;/a&gt;.
&lt;/div&gt;
&lt;/div&gt;
</description>
        <pubDate>Thu, 04 May 2017 00:00:00 +0200</pubDate>
        <link>https://mhoehle.github.io/blog/2017/05/04/crowdsize.html</link>
        <guid isPermaLink="true">https://mhoehle.github.io/blog/2017/05/04/crowdsize.html</guid>
        
        <category>rstats</category>
        
        <category>stats</category>
        
        <category>data journalism</category>
        
        
      </item>
    
      <item>
        <title>On a First Name Basis with Statistics Sweden</title>
        <description>&lt;h2 id=&quot;abstract&quot;&gt;Abstract&lt;/h2&gt;
&lt;p&gt;Judging from recent R-Bloggers posts, it appears that many data
scientists are concerned with scraping data from various media sources
(Wikipedia, twitter, etc.). However, one should be aware that well
structured and high quality datasets are available through state’s and
country’s bureau of statistics. Increasingly these are offered to the
public through direct database access, e.g., using a REST like API. We
illustrate the usefulness of such an approach by accessing data from
Statistics Sweden.&lt;/p&gt;
&lt;center&gt;
&lt;img src=&quot;/blog/figure/source/2017-03-25-scbnames/COLLISION26-1.png&quot; /&gt;
&lt;/center&gt;
&lt;p&gt;&lt;br&gt;
&lt;a rel=&quot;license&quot; href=&quot;http://creativecommons.org/licenses/by-sa/4.0/&quot;&gt;&lt;img alt=&quot;Creative Commons License&quot; style=&quot;border-width:0&quot; src=&quot;https://i.creativecommons.org/l/by-sa/4.0/88x31.png&quot;/&gt;&lt;/a&gt;
This work is licensed under a &lt;a rel=&quot;license&quot;
href=&quot;http://creativecommons.org/licenses/by-sa/4.0/&quot;&gt;Creative Commons
Attribution-ShareAlike 4.0 International License&lt;/a&gt;. The
markdown+Rknitr source code of this blog is available under a &lt;a
href=&quot;https://www.gnu.org/licenses/gpl-3.0.html&quot;&gt;GNU General Public
License (GPL v3)&lt;/a&gt; license from github.&lt;/p&gt;
&lt;h2 id=&quot;introduction&quot;&gt;Introduction&lt;/h2&gt;
&lt;p&gt;Scandinavian countries are world-class when it comes to public
registries. So when in need for reliable population data, this is the
place to look. As an example, we access Statistics Sweden data by their
API using the &lt;code&gt;pxweb&lt;/code&gt; package developed by &lt;a
href=&quot;https://twitter.com/MansMeg&quot;&gt;@MansMeg&lt;/a&gt;, &lt;a
href=&quot;https://twitter.com/antagomir&quot;&gt;@antagomir&lt;/a&gt; and &lt;a
href=&quot;https://twitter.com/LCHansson&quot;&gt;@LCHansson&lt;/a&gt;. Love was the first
speaker at a Stockholm R-Meetup some &lt;a
href=&quot;https://www.meetup.com/StockholmR/events/105738342/&quot;&gt;years
ago&lt;/a&gt;, where I also gave a talk. Funny how such R-Meetups become
useful many years after!&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb1&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb1-1&quot;&gt;&lt;a href=&quot;#cb1-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;library&lt;/span&gt;(pxweb)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;By browsing the Statistics Sweden (in Swedish: Statistiska
Centralbyrån (SCB)) data using their &lt;a
href=&quot;http://www.scb.se/en/finding-statistics/&quot;&gt;web interface&lt;/a&gt; one
sees that they have two relevant first name datasets: one containing the
&lt;em&gt;tilltalsnamn&lt;/em&gt; of newborns for each year during 1998-2016 and one
for the years 2004-2016. &lt;strong&gt;Note&lt;/strong&gt;: A &lt;a
href=&quot;https://translate.google.com/translate?sl=auto&amp;amp;tl=en&amp;amp;js=y&amp;amp;prev=_t&amp;amp;hl=en&amp;amp;ie=UTF-8&amp;amp;u=https%3A%2F%2Fsv.wikipedia.org%2Fwiki%2FTilltalsnamn&amp;amp;edit-text=&amp;amp;act=url&quot;&gt;&lt;em&gt;tilltalsnamn&lt;/em&gt;&lt;/a&gt;
in Sweden is &lt;em&gt;the&lt;/em&gt; first name (of several possible first names)
by which a person is usually addressed. About 2/3 of the persons in the
Swedish name registry indicate which of their first names is their
tilltalsnamn. For the remaining persons it is automatically implied that
their tilltalsnamn is the &lt;a
href=&quot;http://www.scb.se/hitta-statistik/statistik-efter-amne/befolkning/amnesovergripande-statistik/namnstatistik/produktrelaterat/Fordjupad-information/fragor-och-svar-om-namnstatistiken/#fem&quot;&gt;first
of the first names&lt;/a&gt;. &lt;strong&gt;Also note:&lt;/strong&gt; For reasons of data
protection the 1998-2016 dataset contains only first names used 10 or
more times in a given year, the 2004-2016 dataset contains only first
names used 2 or more times in a given year.&lt;/p&gt;
&lt;p&gt;Downloading such data through the SCB web-interface is cumbersome,
because the downloads are limited to 50,000 data cells per query. Hence,
one has to do several manual queries to get hold of the relevant data.
This is where their &lt;a
href=&quot;http://www.scb.se/en_/About-us/Open-data-API/API-for-the-Statistical-Database-/&quot;&gt;API&lt;/a&gt;
becomes a real time-saver. Instead of trying to fiddle with the API
directly using &lt;code&gt;rjson&lt;/code&gt; or &lt;code&gt;RJSONIO&lt;/code&gt; we use the
specially designed &lt;code&gt;pxweb&lt;/code&gt; package to fetch the data. One can
either use the web-interface to determine the name of the desired data
matrix to query or navigate directly through the api using
&lt;code&gt;pxweb&lt;/code&gt;:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb2&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb2-1&quot;&gt;&lt;a href=&quot;#cb2-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;d &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;interactive_pxweb&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;api =&lt;/span&gt; &lt;span class=&quot;st&quot;&gt;&amp;quot;api.scb.se&amp;quot;&lt;/span&gt;, &lt;span class=&quot;at&quot;&gt;version =&lt;/span&gt; &lt;span class=&quot;st&quot;&gt;&amp;quot;v1&amp;quot;&lt;/span&gt;, &lt;span class=&quot;at&quot;&gt;lang =&lt;/span&gt; &lt;span class=&quot;st&quot;&gt;&amp;quot;en&amp;quot;&lt;/span&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;and select &lt;em&gt;Population&lt;/em&gt; followed by &lt;em&gt;Name statistics&lt;/em&gt;
and then &lt;code&gt;BE0001T04Ar&lt;/code&gt; or &lt;code&gt;BE0001T04BAr&lt;/code&gt;,
respectively, in order to obtain the relevant data and api download
url.&lt;/p&gt;
&lt;h4 id=&quot;downloading-the-first-name-data-with-pxweb&quot;&gt;Downloading the
first name data with &lt;code&gt;pxweb&lt;/code&gt;&lt;/h4&gt;
&lt;p&gt;This leads to the following R code for download:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb3&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb3-1&quot;&gt;&lt;a href=&quot;#cb3-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;names10 &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;get_pxweb_data&lt;/span&gt;(&lt;/span&gt;
&lt;span id=&quot;cb3-2&quot;&gt;&lt;a href=&quot;#cb3-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;at&quot;&gt;url =&lt;/span&gt; &lt;span class=&quot;st&quot;&gt;&amp;quot;http://api.scb.se/OV0104/v1/doris/en/ssd/BE/BE0001/BE0001T04Ar&amp;quot;&lt;/span&gt;,&lt;/span&gt;
&lt;span id=&quot;cb3-3&quot;&gt;&lt;a href=&quot;#cb3-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;at&quot;&gt;dims =&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;list&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;Tilltalsnamn =&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;c&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;#39;*&amp;#39;&lt;/span&gt;),&lt;/span&gt;
&lt;span id=&quot;cb3-4&quot;&gt;&lt;a href=&quot;#cb3-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;              &lt;span class=&quot;at&quot;&gt;ContentsCode =&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;c&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;#39;BE0001AH&amp;#39;&lt;/span&gt;),&lt;/span&gt;
&lt;span id=&quot;cb3-5&quot;&gt;&lt;a href=&quot;#cb3-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;              &lt;span class=&quot;at&quot;&gt;Tid =&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;c&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;#39;*&amp;#39;&lt;/span&gt;)),&lt;/span&gt;
&lt;span id=&quot;cb3-6&quot;&gt;&lt;a href=&quot;#cb3-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;at&quot;&gt;clean =&lt;/span&gt; &lt;span class=&quot;cn&quot;&gt;TRUE&lt;/span&gt;) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; as.tbl&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;For better usability we rename the columns a little and replace
&lt;code&gt;NA&lt;/code&gt; counts to be zero. For visualization we pick 5 random
lines of the dataset.&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb4&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb4-1&quot;&gt;&lt;a href=&quot;#cb4-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;names10 &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; names10 &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;select&lt;/span&gt;(&lt;span class=&quot;sc&quot;&gt;-&lt;/span&gt;observations) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-2&quot;&gt;&lt;a href=&quot;#cb4-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;rename&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;firstname=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;at&quot;&gt;first name normally used&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;`&lt;/span&gt;,&lt;span class=&quot;at&quot;&gt;counts=&lt;/span&gt;values) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-3&quot;&gt;&lt;a href=&quot;#cb4-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;mutate&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;counts =&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;ifelse&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;is.na&lt;/span&gt;(counts),&lt;span class=&quot;dv&quot;&gt;0&lt;/span&gt;,counts))&lt;/span&gt;
&lt;span id=&quot;cb4-4&quot;&gt;&lt;a href=&quot;#cb4-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##Look at 5 random lines&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-5&quot;&gt;&lt;a href=&quot;#cb4-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;names10 &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;slice&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;sample&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;seq_len&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;nrow&lt;/span&gt;(names10)),&lt;span class=&quot;at&quot;&gt;size=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;5&lt;/span&gt;))&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;## # A tibble: 5 × 3
##   firstname   year counts
##      &amp;lt;fctr&amp;gt; &amp;lt;fctr&amp;gt;  &amp;lt;dbl&amp;gt;
## 1     Livia   1998      0
## 2   Elicia    2010     21
## 3     Amie    2000      0
## 4    Albert   2011    108
## 5       Kim   2008     14&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Note: Each spelling variant of a name in the data is treated as a
unique name. In similar fashion we download the &lt;code&gt;BE0001AL&lt;/code&gt;
dataset as &lt;code&gt;names2&lt;/code&gt;.&lt;/p&gt;
&lt;h4 id=&quot;imputing-first-names-with-only-one-use&quot;&gt;Imputing first names
with only one use&lt;/h4&gt;
&lt;p&gt;Since the &lt;code&gt;names2&lt;/code&gt; dataset contains all first names with 2
or more uses in a given year it is possible to deduce how many first
names are used only once by subtracting the total number of names in
&lt;code&gt;names2&lt;/code&gt; from the total number of live births per year.&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb6&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb6-1&quot;&gt;&lt;a href=&quot;#cb6-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##Total number of newborns in the data per year&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb6-2&quot;&gt;&lt;a href=&quot;#cb6-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;names2_year &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; names2 &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;group_by&lt;/span&gt;(year) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;summarise&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;names=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;sum&lt;/span&gt;(counts))&lt;/span&gt;
&lt;span id=&quot;cb6-3&quot;&gt;&lt;a href=&quot;#cb6-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb6-4&quot;&gt;&lt;a href=&quot;#cb6-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##Fetch number of live births per year from the corresponding data set&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb6-5&quot;&gt;&lt;a href=&quot;#cb6-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;births &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;get_pxweb_data&lt;/span&gt;(&lt;/span&gt;
&lt;span id=&quot;cb6-6&quot;&gt;&lt;a href=&quot;#cb6-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;at&quot;&gt;url =&lt;/span&gt; &lt;span class=&quot;st&quot;&gt;&amp;quot;http://api.scb.se/OV0104/v1/doris/en/ssd/BE/BE0101/BE0101H/FoddaK&amp;quot;&lt;/span&gt;,&lt;/span&gt;
&lt;span id=&quot;cb6-7&quot;&gt;&lt;a href=&quot;#cb6-7&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;at&quot;&gt;dims =&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;list&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;Region =&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;c&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;#39;00&amp;#39;&lt;/span&gt;),&lt;/span&gt;
&lt;span id=&quot;cb6-8&quot;&gt;&lt;a href=&quot;#cb6-8&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;              &lt;span class=&quot;at&quot;&gt;AlderModer =&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;c&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;#39;tot&amp;#39;&lt;/span&gt;),&lt;/span&gt;
&lt;span id=&quot;cb6-9&quot;&gt;&lt;a href=&quot;#cb6-9&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;              &lt;span class=&quot;at&quot;&gt;Kon =&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;c&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;#39;*&amp;#39;&lt;/span&gt;),&lt;/span&gt;
&lt;span id=&quot;cb6-10&quot;&gt;&lt;a href=&quot;#cb6-10&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;              &lt;span class=&quot;at&quot;&gt;ContentsCode =&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;c&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;#39;BE0101E2&amp;#39;&lt;/span&gt;),&lt;/span&gt;
&lt;span id=&quot;cb6-11&quot;&gt;&lt;a href=&quot;#cb6-11&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;              &lt;span class=&quot;at&quot;&gt;Tid =&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;c&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;#39;*&amp;#39;&lt;/span&gt;)), &lt;span class=&quot;at&quot;&gt;clean =&lt;/span&gt; &lt;span class=&quot;cn&quot;&gt;TRUE&lt;/span&gt;)&lt;/span&gt;
&lt;span id=&quot;cb6-12&quot;&gt;&lt;a href=&quot;#cb6-12&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##Aggregate per year&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb6-13&quot;&gt;&lt;a href=&quot;#cb6-13&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;births_year &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; births &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;group_by&lt;/span&gt;(year) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;summarise&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;births=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;sum&lt;/span&gt;(values))&lt;/span&gt;
&lt;span id=&quot;cb6-14&quot;&gt;&lt;a href=&quot;#cb6-14&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb6-15&quot;&gt;&lt;a href=&quot;#cb6-15&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##Join and compute difference, which is the number of names used exactly once.&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb6-16&quot;&gt;&lt;a href=&quot;#cb6-16&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;(names_join &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;inner_join&lt;/span&gt;(names2_year, births_year, &lt;span class=&quot;at&quot;&gt;by=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;year&amp;quot;&lt;/span&gt;) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb6-17&quot;&gt;&lt;a href=&quot;#cb6-17&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;mutate&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;nNames1=&lt;/span&gt;births&lt;span class=&quot;sc&quot;&gt;-&lt;/span&gt;names, &lt;span class=&quot;at&quot;&gt;propNames1=&lt;/span&gt;nNames1&lt;span class=&quot;sc&quot;&gt;/&lt;/span&gt;births))&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;## # A tibble: 13 × 5
##     year  names births nNames1  propNames1
##    &amp;lt;chr&amp;gt;  &amp;lt;dbl&amp;gt;  &amp;lt;dbl&amp;gt;   &amp;lt;dbl&amp;gt;       &amp;lt;dbl&amp;gt;
## 1   2004  99958 100928     970 0.009610812
## 2   2005  98718 101346    2628 0.025930969
## 3   2006 101944 105913    3969 0.037474153
## 4   2007 101262 107421    6159 0.057335158
## 5   2008 101356 109301    7945 0.072689179
## 6   2009 102989 111801    8812 0.078818615
## 7   2010 108405 115641    7236 0.062572963
## 8   2011 103480 111770    8290 0.074170171
## 9   2012 104448 113177    8729 0.077126978
## 10  2013 104465 113593    9128 0.080357064
## 11  2014 106021 114907    8886 0.077332103
## 12  2015 105012 114870    9858 0.085818752
## 13  2016 107536 117425    9889 0.084215457&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;We notice that the proportion of names occurring exactly once
increases substantially over the years - going from 1.0% in 2004 to 8.4%
in 2016. It’s not clear if the imputation by subtraction is 100% exact,
but it does sound plausible that names have become more unique.&lt;/p&gt;
&lt;h4 id=&quot;merging-it-all&quot;&gt;Merging it all&lt;/h4&gt;
&lt;p&gt;Based on the above we can create a &lt;code&gt;data.frame&lt;/code&gt; containing
the correct number of names used once.&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb8&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb8-1&quot;&gt;&lt;a href=&quot;#cb8-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;missing1names &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; names_join &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;group_by&lt;/span&gt;(year) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;do&lt;/span&gt;({&lt;/span&gt;
&lt;span id=&quot;cb8-2&quot;&gt;&lt;a href=&quot;#cb8-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;data.frame&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;firstname=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;paste0&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;quot;Uniquename&amp;quot;&lt;/span&gt;,.&lt;span class=&quot;sc&quot;&gt;$&lt;/span&gt;year,&lt;span class=&quot;st&quot;&gt;&amp;quot;-&amp;quot;&lt;/span&gt;,&lt;span class=&quot;fu&quot;&gt;sprintf&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;quot;%.5d&amp;quot;&lt;/span&gt;,&lt;span class=&quot;fu&quot;&gt;seq_len&lt;/span&gt;(.&lt;span class=&quot;sc&quot;&gt;$&lt;/span&gt;nNames1))),&lt;span class=&quot;at&quot;&gt;year=&lt;/span&gt;.&lt;span class=&quot;sc&quot;&gt;$&lt;/span&gt;year,&lt;span class=&quot;at&quot;&gt;counts=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;dt&quot;&gt;L&lt;/span&gt;)&lt;/span&gt;
&lt;span id=&quot;cb8-3&quot;&gt;&lt;a href=&quot;#cb8-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;}) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; ungroup&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;We now join the three datasets into one large &lt;code&gt;data.frame&lt;/code&gt;
by&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb9&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb9-1&quot;&gt;&lt;a href=&quot;#cb9-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;names &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;rbind&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;data.frame&lt;/span&gt;(names10,&lt;span class=&quot;at&quot;&gt;type=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;min10&amp;quot;&lt;/span&gt;),&lt;/span&gt;
&lt;span id=&quot;cb9-2&quot;&gt;&lt;a href=&quot;#cb9-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;               &lt;span class=&quot;fu&quot;&gt;data.frame&lt;/span&gt;(names2,&lt;span class=&quot;at&quot;&gt;type=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;min02&amp;quot;&lt;/span&gt;),&lt;/span&gt;
&lt;span id=&quot;cb9-3&quot;&gt;&lt;a href=&quot;#cb9-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;               &lt;span class=&quot;fu&quot;&gt;data.frame&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;rbind&lt;/span&gt;(names2,missing1names),&lt;span class=&quot;at&quot;&gt;type=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;min01&amp;quot;&lt;/span&gt;)) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; as.tbl&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h4 id=&quot;collision-probabilities&quot;&gt;Collision probabilities&lt;/h4&gt;
&lt;p&gt;We thus got everything in place to compute the name collision
probability over time using the &lt;code&gt;birthdayproblem&lt;/code&gt; package (as
shown in &lt;a
href=&quot;http://staff.math.su.se/hoehle/blog/2017/02/13/bday.html&quot;&gt;previous
posts&lt;/a&gt;).&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb10&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb10-1&quot;&gt;&lt;a href=&quot;#cb10-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;library&lt;/span&gt;(birthdayproblem)&lt;/span&gt;
&lt;span id=&quot;cb10-2&quot;&gt;&lt;a href=&quot;#cb10-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;collision &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; names &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;group_by&lt;/span&gt;(year,type) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;do&lt;/span&gt;({&lt;/span&gt;
&lt;span id=&quot;cb10-3&quot;&gt;&lt;a href=&quot;#cb10-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;data.frame&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;p=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;pbirthday_up&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;n=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;26&lt;/span&gt;&lt;span class=&quot;dt&quot;&gt;L&lt;/span&gt;, &lt;span class=&quot;at&quot;&gt;prob=&lt;/span&gt; .&lt;span class=&quot;sc&quot;&gt;$&lt;/span&gt;counts &lt;span class=&quot;sc&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;sum&lt;/span&gt;(.&lt;span class=&quot;sc&quot;&gt;$&lt;/span&gt;counts),&lt;span class=&quot;at&quot;&gt;method=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;mase1992&amp;quot;&lt;/span&gt;)&lt;span class=&quot;sc&quot;&gt;$&lt;/span&gt;prob, &lt;span class=&quot;at&quot;&gt;gini=&lt;/span&gt; ineq&lt;span class=&quot;sc&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;Gini&lt;/span&gt;(.&lt;span class=&quot;sc&quot;&gt;$&lt;/span&gt;counts))&lt;/span&gt;
&lt;span id=&quot;cb10-4&quot;&gt;&lt;a href=&quot;#cb10-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;}) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; ungroup &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;mutate&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;year=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;as.numeric&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;as.character&lt;/span&gt;(year)))&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;And the resulting probabilities based on the three datasets
&lt;code&gt;min02&lt;/code&gt; (at least two instances of the name in a given year),
&lt;code&gt;min10&lt;/code&gt; (at least ten instances of the name in a given year)
and the complete dataset &lt;code&gt;min01&lt;/code&gt; can easily be visualized
over time.&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb11&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb11-1&quot;&gt;&lt;a href=&quot;#cb11-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;ggplot&lt;/span&gt;( collision, &lt;span class=&quot;fu&quot;&gt;aes&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;x=&lt;/span&gt;year, &lt;span class=&quot;at&quot;&gt;y=&lt;/span&gt;p, &lt;span class=&quot;at&quot;&gt;color=&lt;/span&gt;type)) &lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;geom_line&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;size=&lt;/span&gt;&lt;span class=&quot;fl&quot;&gt;1.5&lt;/span&gt;) &lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb11-2&quot;&gt;&lt;a href=&quot;#cb11-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;scale_y_continuous&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;label=&lt;/span&gt;scales&lt;span class=&quot;sc&quot;&gt;::&lt;/span&gt;percent,&lt;span class=&quot;at&quot;&gt;limits=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;c&lt;/span&gt;(&lt;span class=&quot;dv&quot;&gt;0&lt;/span&gt;,&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;)) &lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb11-3&quot;&gt;&lt;a href=&quot;#cb11-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;xlab&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;quot;Year&amp;quot;&lt;/span&gt;) &lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;ylab&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;quot;Probability&amp;quot;&lt;/span&gt;) &lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb11-4&quot;&gt;&lt;a href=&quot;#cb11-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;ggtitle&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;quot;Probability of a name collision in a class of 26 kids born in year YYYY&amp;quot;&lt;/span&gt;) &lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb11-5&quot;&gt;&lt;a href=&quot;#cb11-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;scale_colour_discrete&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;name =&lt;/span&gt; &lt;span class=&quot;st&quot;&gt;&amp;quot;Dataset&amp;quot;&lt;/span&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;img src=&quot;http://staff.math.su.se/hoehle/blog/figure/source/2017-03-25-scbnames/COLLISION26-1.png&quot; style=&quot;display: block; margin: auto;&quot; /&gt;&lt;/p&gt;
&lt;p&gt;As seen in similar plots for other countries, there is a decline in
the collision probability over time. Note also that the two curves are
upper limits to the true collision probabilities. The true
probabilities, i.e. taking all tilltalsnamn into account, have been
computed based on the &lt;code&gt;min01&lt;/code&gt; data set, which has been
created by finding the difference between the total number of live
births in a year and the total number of names in
&lt;code&gt;names2&lt;/code&gt;.&lt;/p&gt;
&lt;h2 id=&quot;summary&quot;&gt;Summary&lt;/h2&gt;
&lt;p&gt;With all due respect for the need to anonymise the name statistics,
it’s hard to understand why the summary figures of how many names with
less than X uses, which have been removed due to privacy concerns, are
not automatically reported. This would allow one to immediately compute
correct totals and collision probabilities. The same problem occurs,
e.g., in the corresponding &lt;a
href=&quot;https://www.ons.gov.uk/peoplepopulationandcommunity/birthsdeathsandmarriages/livebirths/datasets/babynamesenglandandwalesbabynamesstatisticsboys&quot;&gt;UK
and Wales data&lt;/a&gt;. Here, Table 6 is listing all first names with 3 or
more uses, but not stating how many newborns have a name occurring once
and twice, respectively.&lt;/p&gt;
&lt;p&gt;Luckily, the missing number could be obtained for the Swedish data
with a bit of data dancing and a simple subtraction. Based on these data
the collision probabilities are - opposite to some of my &lt;a
href=&quot;http://staff.math.su.se/hoehle/blog/2017/02/13/bday.html&quot;&gt;previous
blog analyses&lt;/a&gt; - exact. Have a look at the &lt;a
href=&quot;http://www.scb.se/en/finding-statistics/&quot;&gt;SCB data website&lt;/a&gt;,
maybe the data you are looking for can be found here!&lt;/p&gt;
</description>
        <pubDate>Sat, 25 Mar 2017 00:00:00 +0100</pubDate>
        <link>https://mhoehle.github.io/blog/2017/03/25/scbnames.html</link>
        <guid isPermaLink="true">https://mhoehle.github.io/blog/2017/03/25/scbnames.html</guid>
        
        <category>rstats</category>
        
        <category>stats</category>
        
        <category>data journalism</category>
        
        <category>onomastics</category>
        
        
      </item>
    
      <item>
        <title>Did Mary and John go West?</title>
        <description>&lt;h2 id=&quot;abstract&quot;&gt;Abstract&lt;/h2&gt;
&lt;p&gt;As a final post in the &lt;em&gt;baby-names-the-data-scientist’s-way&lt;/em&gt;
series, we use the US Social Security Administration 1910-2015 data to
space-time visualize for each state the most popular baby name for girls
and boys, respectively. The code uses in parts the simple features
package (&lt;code&gt;sf&lt;/code&gt;) in order to to get some first experience with
the new approach for handling spatial maps.&lt;/p&gt;
&lt;center&gt;
&lt;img
src=&quot;/blog/figure/source/2017-03-06-spacetimenames/US-babynames-spacetime.gif&quot; /&gt;
&lt;/center&gt;
&lt;p&gt;&lt;br&gt;
&lt;a rel=&quot;license&quot; href=&quot;http://creativecommons.org/licenses/by-sa/4.0/&quot;&gt;&lt;img alt=&quot;Creative Commons License&quot; style=&quot;border-width:0&quot; src=&quot;https://i.creativecommons.org/l/by-sa/4.0/88x31.png&quot;/&gt;&lt;/a&gt;
This work is licensed under a &lt;a rel=&quot;license&quot;
href=&quot;http://creativecommons.org/licenses/by-sa/4.0/&quot;&gt;Creative Commons
Attribution-ShareAlike 4.0 International License&lt;/a&gt;. The
markdown+Rknitr source code of this blog is available under a &lt;a
href=&quot;https://www.gnu.org/licenses/gpl-3.0.html&quot;&gt;GNU General Public
License (GPL v3)&lt;/a&gt; license from github.&lt;/p&gt;
&lt;h2 id=&quot;introduction&quot;&gt;Introduction&lt;/h2&gt;
&lt;p&gt;After a series of posts on &lt;a
href=&quot;http://staff.math.su.se/hoehle/blog/2017/02/06/onomastics.html&quot;&gt;naming
uncertainty&lt;/a&gt;, &lt;a
href=&quot;http://staff.math.su.se/hoehle/blog/2017/02/13/bday.html&quot;&gt;name
collisions in classrooms&lt;/a&gt; and illustrating these &lt;a
href=&quot;http://staff.math.su.se/hoehle/blog/2017/03/01/morebabynames.html&quot;&gt;name
collisions over time&lt;/a&gt;, it is time to leave onomatology for now.
However, the availability of the US social security baby name data at &lt;a
href=&quot;https://www.ssa.gov/oact/babynames/limits.html&quot;&gt;state level&lt;/a&gt;
requires one last effort: visualizing the top names per state for the
years 1910-2015. Creating a map-based visualization also provides a nice
opportunity to experiment with the new &lt;code&gt;sf&lt;/code&gt; (simple features)
package for spatial visualization.&lt;/p&gt;
&lt;h2 id=&quot;data-dancing&quot;&gt;Data Dancing&lt;/h2&gt;
&lt;p&gt;We download the US social security data, which consists of a zip file
containing a bunch of 51 text files - one for each state.&lt;/p&gt;
&lt;p&gt;We then read these individual text files and bind them together into
one large &lt;code&gt;data.frame&lt;/code&gt;:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb1&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb1-1&quot;&gt;&lt;a href=&quot;#cb1-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##Get list of all file names containing state specific baby name data&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-2&quot;&gt;&lt;a href=&quot;#cb1-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;fList &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;list.files&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;path=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;file.path&lt;/span&gt;(filePath,&lt;span class=&quot;st&quot;&gt;&amp;quot;namesbystate&amp;quot;&lt;/span&gt;), &lt;span class=&quot;at&quot;&gt;pattern=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;.TXT&amp;quot;&lt;/span&gt;)&lt;/span&gt;
&lt;span id=&quot;cb1-3&quot;&gt;&lt;a href=&quot;#cb1-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-4&quot;&gt;&lt;a href=&quot;#cb1-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##Read complete name list of each state&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-5&quot;&gt;&lt;a href=&quot;#cb1-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;names &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; purrr&lt;span class=&quot;sc&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;map_df&lt;/span&gt;(fList, &lt;span class=&quot;at&quot;&gt;.f=&lt;/span&gt;&lt;span class=&quot;cf&quot;&gt;function&lt;/span&gt;(f) {&lt;/span&gt;
&lt;span id=&quot;cb1-6&quot;&gt;&lt;a href=&quot;#cb1-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;read_csv&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;file=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;file.path&lt;/span&gt;(filePath,&lt;span class=&quot;st&quot;&gt;&amp;quot;namesbystate&amp;quot;&lt;/span&gt;,f), &lt;span class=&quot;at&quot;&gt;col_names=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;c&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;quot;State&amp;quot;&lt;/span&gt;,&lt;span class=&quot;st&quot;&gt;&amp;quot;Sex&amp;quot;&lt;/span&gt;,&lt;span class=&quot;st&quot;&gt;&amp;quot;Year&amp;quot;&lt;/span&gt;,&lt;span class=&quot;st&quot;&gt;&amp;quot;Name&amp;quot;&lt;/span&gt;,&lt;span class=&quot;st&quot;&gt;&amp;quot;Count&amp;quot;&lt;/span&gt;),&lt;span class=&quot;at&quot;&gt;col_types=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;cols&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;col_character&lt;/span&gt;(), &lt;span class=&quot;fu&quot;&gt;col_factor&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;c&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;quot;M&amp;quot;&lt;/span&gt;,&lt;span class=&quot;st&quot;&gt;&amp;quot;F&amp;quot;&lt;/span&gt;)), &lt;span class=&quot;fu&quot;&gt;col_integer&lt;/span&gt;(), &lt;span class=&quot;fu&quot;&gt;col_character&lt;/span&gt;(), &lt;span class=&quot;fu&quot;&gt;col_integer&lt;/span&gt;()))&lt;/span&gt;
&lt;span id=&quot;cb1-7&quot;&gt;&lt;a href=&quot;#cb1-7&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;})&lt;/span&gt;
&lt;span id=&quot;cb1-8&quot;&gt;&lt;a href=&quot;#cb1-8&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-9&quot;&gt;&lt;a href=&quot;#cb1-9&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##Show result&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-10&quot;&gt;&lt;a href=&quot;#cb1-10&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;head&lt;/span&gt;(names, &lt;span class=&quot;at&quot;&gt;n=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;4&lt;/span&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;## # A tibble: 4 × 5
##   State    Sex  Year     Name Count
##   &amp;lt;chr&amp;gt; &amp;lt;fctr&amp;gt; &amp;lt;int&amp;gt;    &amp;lt;chr&amp;gt; &amp;lt;int&amp;gt;
## 1    AK      F  1910     Mary    14
## 2    AK      F  1910    Annie    12
## 3    AK      F  1910     Anna    10
## 4    AK      F  1910 Margaret     8&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;With the complete data in place, it’s easy to compute the top boy and
girl name per state and year. For later use we convert this information
into long-format.&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb3&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb3-1&quot;&gt;&lt;a href=&quot;#cb3-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##Find top-1 names for each state by gender. Data are already sorted.&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb3-2&quot;&gt;&lt;a href=&quot;#cb3-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;topnames &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; names &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;group_by&lt;/span&gt;(Year,State,Sex) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;do&lt;/span&gt;({&lt;/span&gt;
&lt;span id=&quot;cb3-3&quot;&gt;&lt;a href=&quot;#cb3-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;head&lt;/span&gt;(.,&lt;span class=&quot;at&quot;&gt;n=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; dplyr&lt;span class=&quot;sc&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;select&lt;/span&gt;(Name)&lt;/span&gt;
&lt;span id=&quot;cb3-4&quot;&gt;&lt;a href=&quot;#cb3-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;}) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;spread&lt;/span&gt;(Sex, Name)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;## Source: local data frame [4 x 4]
## Groups: Year, State [4]
## 
##    Year State     M     F
##   &amp;lt;int&amp;gt; &amp;lt;chr&amp;gt; &amp;lt;chr&amp;gt; &amp;lt;chr&amp;gt;
## 1  1910    AK  John  Mary
## 2  1910    AL James  Mary
## 3  1910    AR James  Mary
## 4  1910    AZ  John  Mary&lt;/code&gt;&lt;/pre&gt;
&lt;h2 id=&quot;map-massaging&quot;&gt;Map Massaging&lt;/h2&gt;
&lt;p&gt;For the map visualization we use an US map from the R package &lt;a
href=&quot;https://cran.r-project.org/web/packages/fiftystater/index.html&quot;&gt;&lt;code&gt;fiftystater&lt;/code&gt;&lt;/a&gt;
where Alaska and Hawaii have been re-located as map-insets. The process
for doing the necessary transforms &lt;code&gt;sp&lt;/code&gt;-style are described
in the package &lt;a
href=&quot;https://cran.r-project.org/web/packages/fiftystater/vignettes/fiftystater.html&quot;&gt;vignette&lt;/a&gt;.
We store the output of this transformation as a shapefile
&lt;code&gt;usa.shp&lt;/code&gt; with appropriate support files. Furthermore, a
&lt;code&gt;lines.shp&lt;/code&gt; shapefile was created which contains information
on where to put the text labels for each state. This was easily edited
interactively in &lt;a href=&quot;http://www.qgis.org/en/site/&quot;&gt;QGIS&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;We then use the &lt;code&gt;sf&lt;/code&gt; package for loading these two
shapefiles back into R:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb5&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb5-1&quot;&gt;&lt;a href=&quot;#cb5-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;suppressMessages&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;library&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;quot;sf&amp;quot;&lt;/span&gt;))&lt;/span&gt;
&lt;span id=&quot;cb5-2&quot;&gt;&lt;a href=&quot;#cb5-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;usa &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;st_read&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;file.path&lt;/span&gt;(filePath, &lt;span class=&quot;st&quot;&gt;&amp;quot;maps&amp;quot;&lt;/span&gt;, &lt;span class=&quot;st&quot;&gt;&amp;quot;usa.shp&amp;quot;&lt;/span&gt;))&lt;/span&gt;
&lt;span id=&quot;cb5-3&quot;&gt;&lt;a href=&quot;#cb5-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;textplacement &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;st_read&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;file.path&lt;/span&gt;(filePath, &lt;span class=&quot;st&quot;&gt;&amp;quot;maps&amp;quot;&lt;/span&gt;, &lt;span class=&quot;st&quot;&gt;&amp;quot;lines.shp&amp;quot;&lt;/span&gt;))&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;The &lt;code&gt;textplacement&lt;/code&gt; information is converted to a
&lt;code&gt;data.frame&lt;/code&gt; where each row contains the state name and the
coordinates of the start and endpoint of each line-segment - this
corresponds to text location and geographical centroid of the region,
respectively.&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb6&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb6-1&quot;&gt;&lt;a href=&quot;#cb6-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;location &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; textplacement &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;split&lt;/span&gt;(.&lt;span class=&quot;sc&quot;&gt;$&lt;/span&gt;State) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; purrr&lt;span class=&quot;sc&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;map_df&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;.f =&lt;/span&gt; &lt;span class=&quot;cf&quot;&gt;function&lt;/span&gt;(x) {&lt;/span&gt;
&lt;span id=&quot;cb6-2&quot;&gt;&lt;a href=&quot;#cb6-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  pos &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;st_geometry&lt;/span&gt;(x)[[&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;]]&lt;/span&gt;
&lt;span id=&quot;cb6-3&quot;&gt;&lt;a href=&quot;#cb6-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;data.frame&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;State=&lt;/span&gt;x&lt;span class=&quot;sc&quot;&gt;$&lt;/span&gt;State, &lt;span class=&quot;at&quot;&gt;x1.loc=&lt;/span&gt;pos[&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;,&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;], &lt;span class=&quot;at&quot;&gt;x2.loc=&lt;/span&gt;pos[&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;,&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;], &lt;span class=&quot;at&quot;&gt;x1.center=&lt;/span&gt;pos[&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;,&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;],&lt;span class=&quot;at&quot;&gt;x2.center=&lt;/span&gt;pos[&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;,&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;])&lt;/span&gt;
&lt;span id=&quot;cb6-4&quot;&gt;&lt;a href=&quot;#cb6-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;}) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; ungroup&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;(Note: Is there a fancier way to extract the coordinates for the
geometry of the &lt;code&gt;sf&lt;/code&gt; objects while keeping the
&lt;code&gt;data.frame&lt;/code&gt; part alongside?)&lt;/p&gt;
&lt;h2 id=&quot;state-time-visualization&quot;&gt;State-Time Visualization&lt;/h2&gt;
&lt;p&gt;By using the &lt;code&gt;animation::saveGIF&lt;/code&gt; function we create an
animation of the the top girl and boy name for each state for the
sequence of years 1910-2015.&lt;/p&gt;
&lt;p&gt;&lt;img
src=&quot;/blog/figure/source/2017-03-06-spacetimenames/US-babynames-spacetime.gif&quot; /&gt;&lt;/p&gt;
&lt;h2 id=&quot;state-time-cartogram&quot;&gt;State-Time Cartogram&lt;/h2&gt;
&lt;p&gt;We use the &lt;code&gt;Rcartogram&lt;/code&gt; and &lt;code&gt;getcartr&lt;/code&gt; packages
to create an analogous cartogram - see the previous &lt;a
href=&quot;http://staff.math.su.se/hoehle/blog/2016/10/10/cartograms.html&quot;&gt;Cartograms
with R&lt;/a&gt; post for further details. The total number of births per
state in a given year is used as scaling variable for the cartogram.&lt;/p&gt;
&lt;p&gt;&lt;img
src=&quot;/blog/figure/source/2017-03-06-spacetimenames/US-cartogram-babynames-spacetime.gif&quot; /&gt;&lt;/p&gt;
&lt;p&gt;Its amazing to observe how births &lt;em&gt;go west&lt;/em&gt; in the US during
the considered time period.&lt;/p&gt;
&lt;!-- Note: This graphic is in need for some smart text placement, e.g., by
ensuring that the bound box of the text is not in conflict with any
other bounding box. --&gt;
</description>
        <pubDate>Mon, 06 Mar 2017 00:00:00 +0100</pubDate>
        <link>https://mhoehle.github.io/blog/2017/03/06/spacetimenames.html</link>
        <guid isPermaLink="true">https://mhoehle.github.io/blog/2017/03/06/spacetimenames.html</guid>
        
        <category>rstats</category>
        
        <category>stats</category>
        
        <category>data journalism</category>
        
        <category>onomastics</category>
        
        
      </item>
    
      <item>
        <title>US Baby Name Collisions 1880-2014</title>
        <description>&lt;h2 id=&quot;abstract&quot;&gt;Abstract&lt;/h2&gt;
&lt;p&gt;We use US Social Security Administration data to compute the
probability of a name clash in a class of year-YYYY born kids during the
years 1880-2014.&lt;/p&gt;
&lt;center&gt;
&lt;img
src=&quot;/blog/figure/source/2017-03-01-morebabynames/COLLIDEPROBTS-1.png&quot; /&gt;
&lt;/center&gt;
&lt;p&gt;&lt;br&gt;
&lt;a rel=&quot;license&quot; href=&quot;http://creativecommons.org/licenses/by-sa/4.0/&quot;&gt;&lt;img alt=&quot;Creative Commons License&quot; style=&quot;border-width:0&quot; src=&quot;https://i.creativecommons.org/l/by-sa/4.0/88x31.png&quot;/&gt;&lt;/a&gt;
This work is licensed under a &lt;a rel=&quot;license&quot;
href=&quot;http://creativecommons.org/licenses/by-sa/4.0/&quot;&gt;Creative Commons
Attribution-ShareAlike 4.0 International License&lt;/a&gt;. The
markdown+Rknitr source code of this blog is available under a &lt;a
href=&quot;https://www.gnu.org/licenses/gpl-3.0.html&quot;&gt;GNU General Public
License (GPL v3)&lt;/a&gt; license from github.&lt;/p&gt;
&lt;h2 id=&quot;introduction&quot;&gt;Introduction&lt;/h2&gt;
&lt;p&gt;After reading a cool post by &lt;a
href=&quot;https://kkulma.github.io/&quot;&gt;Kasia Kulma&lt;/a&gt; on how the release of
&lt;a href=&quot;https://kkulma.github.io/2017-02-22-disney-names/&quot;&gt;Disney films
have an impact on girl namings in the US&lt;/a&gt;, I became aware of the
&lt;code&gt;babynames&lt;/code&gt; package by Hadley Wickham. The package wraps the
data by the &lt;a href=&quot;https://www.ssa.gov/oact/babynames/limits.html&quot;&gt;USA
social security administration&lt;/a&gt; on the frequency of all baby names
each year during the period 1880-2014 in the US. Because the data fit
phenomenally in spirit to this blog’s two previous posts on &lt;a
href=&quot;http://staff.math.su.se/hoehle/blog/2017/02/06/onomastics.html&quot;&gt;onomastics&lt;/a&gt;
and the &lt;a
href=&quot;http://staff.math.su.se/hoehle/blog/2017/02/13/bday.html&quot;&gt;birthday
problem with unequal probabilities&lt;/a&gt;, we use the data to extend our
name analyses in temporal fashion.&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb1&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb1-1&quot;&gt;&lt;a href=&quot;#cb1-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;library&lt;/span&gt;(babynames)&lt;/span&gt;
&lt;span id=&quot;cb1-2&quot;&gt;&lt;a href=&quot;#cb1-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;head&lt;/span&gt;(babynames,&lt;span class=&quot;at&quot;&gt;n=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;## # A tibble: 2 × 5
##    year   sex  name     n       prop
##   &amp;lt;dbl&amp;gt; &amp;lt;chr&amp;gt; &amp;lt;chr&amp;gt; &amp;lt;int&amp;gt;      &amp;lt;dbl&amp;gt;
## 1  1880     F  Mary  7065 0.07238359
## 2  1880     F  Anna  2604 0.02667896&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Check how many babies and how many unique first names are contained
in the data each year:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb3&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb3-1&quot;&gt;&lt;a href=&quot;#cb3-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;p1 &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; babynames &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;group_by&lt;/span&gt;(year) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;summarise&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;n=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;sum&lt;/span&gt;(n)) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;ggplot&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;aes&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;x=&lt;/span&gt;year, &lt;span class=&quot;at&quot;&gt;y=&lt;/span&gt;n)) &lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;geom_line&lt;/span&gt;() &lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;xlab&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;quot;Time (years)&amp;quot;&lt;/span&gt;) &lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;ylab&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;quot;Number of babies&amp;quot;&lt;/span&gt;)&lt;/span&gt;
&lt;span id=&quot;cb3-2&quot;&gt;&lt;a href=&quot;#cb3-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;p2 &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; babynames &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;group_by&lt;/span&gt;(year) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;summarise&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;n=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;n&lt;/span&gt;()) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;ggplot&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;aes&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;x=&lt;/span&gt;year, &lt;span class=&quot;at&quot;&gt;y=&lt;/span&gt;n)) &lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;geom_line&lt;/span&gt;() &lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;xlab&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;quot;Time (years)&amp;quot;&lt;/span&gt;) &lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;ylab&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;quot;Number of unique names&amp;quot;&lt;/span&gt;)&lt;/span&gt;
&lt;span id=&quot;cb3-3&quot;&gt;&lt;a href=&quot;#cb3-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;gridExtra&lt;span class=&quot;sc&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;grid.arrange&lt;/span&gt;(p1, p2, &lt;span class=&quot;at&quot;&gt;ncol=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;img src=&quot;http://staff.math.su.se/hoehle/blog/figure/source/2017-03-01-morebabynames/UNIQUENAMES-1.png&quot; style=&quot;display: block; margin: auto;&quot; /&gt;&lt;/p&gt;
&lt;p&gt;We see that the number of live-births remains at an
&lt;em&gt;approximately&lt;/em&gt; stable level the last 50 years, whereas the
number of unique names kept increasing. Note that for reasons of privacy
protection, only names with 5 or more occurrences in a given year, are
contained in the data. We therefore investigate the proportion of
babies, which apparently have been removed due to privacy protection of
the names. This is done by investigating the sum of the proportions
column for each year. If all names would be available, the sum per year
would be 2 (1 for each gender).&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb4&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb4-1&quot;&gt;&lt;a href=&quot;#cb4-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;babynames &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;group_by&lt;/span&gt;(year) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;summarise&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;prop=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;sum&lt;/span&gt;(prop)) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;ggplot&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;aes&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;x=&lt;/span&gt;year, &lt;span class=&quot;at&quot;&gt;y=&lt;/span&gt;(&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;-&lt;/span&gt;prop)&lt;span class=&quot;sc&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;)) &lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;geom_line&lt;/span&gt;() &lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;xlab&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;quot;Time (years)&amp;quot;&lt;/span&gt;) &lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;ylab&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;quot;Proportion of the population removed&amp;quot;&lt;/span&gt;) &lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;scale_y_continuous&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;labels=&lt;/span&gt;scales&lt;span class=&quot;sc&quot;&gt;::&lt;/span&gt;percent)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;img src=&quot;http://staff.math.su.se/hoehle/blog/figure/source/2017-03-01-morebabynames/PROPMISSING-1.png&quot; style=&quot;display: block; margin: auto;&quot; /&gt;
It becomes clear that a non-negligible part of the names are removed and
the proportion appears to vary with time. As a simple fix, we re-scale
the yearly proportions per year s.t. they really sum to one.&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb5&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb5-1&quot;&gt;&lt;a href=&quot;#cb5-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;babynames &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; babynames &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;group_by&lt;/span&gt;(year) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;mutate&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;p =&lt;/span&gt; n&lt;span class=&quot;sc&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;sum&lt;/span&gt;(n))&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3 id=&quot;birthday-problem-with-unequal-occurrence-probabilities&quot;&gt;Birthday
Problem with Unequal Occurrence Probabilities&lt;/h3&gt;
&lt;p&gt;The data are perfect for testing the name-collision functionality
from the previous &lt;a
href=&quot;http://staff.math.su.se/hoehle/blog/2017/02/13/bday.html&quot;&gt;Happy
pbirthday class of 2016&lt;/a&gt; post. Since the writing of the post, the
&lt;code&gt;pbirthday_up&lt;/code&gt; function for computing the name collision
probability, which is an instance of the birthday problem with unequal
occurrence probabilities, has been assembled into a preliminary &lt;a
href=&quot;https://github.com/hoehleatsu/birthdayproblem&quot;&gt;&lt;code&gt;birthdayproblem&lt;/code&gt;&lt;/a&gt;
R package available from github.&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb6&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb6-1&quot;&gt;&lt;a href=&quot;#cb6-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;devtools&lt;span class=&quot;sc&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;install_github&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;quot;hoehleatsu/birthdayproblem&amp;quot;&lt;/span&gt;)&lt;/span&gt;
&lt;span id=&quot;cb6-2&quot;&gt;&lt;a href=&quot;#cb6-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;library&lt;/span&gt;(birthdayproblem)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;We can now easily calculate for each year the probability that 2 or
more kids in a class of &lt;span class=&quot;math inline&quot;&gt;\(n\in
\{20,25,30\}\)&lt;/span&gt; kids all born in a given year YYYY will have same
first name:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb7&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb7-1&quot;&gt;&lt;a href=&quot;#cb7-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;collision &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; babynames &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;group_by&lt;/span&gt;(year) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;do&lt;/span&gt;({&lt;/span&gt;
&lt;span id=&quot;cb7-2&quot;&gt;&lt;a href=&quot;#cb7-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  n &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;c&lt;/span&gt;(&lt;span class=&quot;dv&quot;&gt;20&lt;/span&gt;&lt;span class=&quot;dt&quot;&gt;L&lt;/span&gt;,&lt;span class=&quot;dv&quot;&gt;25&lt;/span&gt;&lt;span class=&quot;dt&quot;&gt;L&lt;/span&gt;,&lt;span class=&quot;dv&quot;&gt;30&lt;/span&gt;&lt;span class=&quot;dt&quot;&gt;L&lt;/span&gt;)&lt;/span&gt;
&lt;span id=&quot;cb7-3&quot;&gt;&lt;a href=&quot;#cb7-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  p &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;sapply&lt;/span&gt;(n, &lt;span class=&quot;cf&quot;&gt;function&lt;/span&gt;(n) &lt;span class=&quot;fu&quot;&gt;pbirthday_up&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;n=&lt;/span&gt;n, .&lt;span class=&quot;sc&quot;&gt;$&lt;/span&gt;p ,&lt;span class=&quot;at&quot;&gt;method=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;mase1992&amp;quot;&lt;/span&gt;)&lt;span class=&quot;sc&quot;&gt;$&lt;/span&gt;prob)&lt;/span&gt;
&lt;span id=&quot;cb7-4&quot;&gt;&lt;a href=&quot;#cb7-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;data.frame&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;n=&lt;/span&gt;n, &lt;span class=&quot;at&quot;&gt;p=&lt;/span&gt;p)&lt;/span&gt;
&lt;span id=&quot;cb7-5&quot;&gt;&lt;a href=&quot;#cb7-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;})&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;img src=&quot;http://staff.math.su.se/hoehle/blog/figure/source/2017-03-01-morebabynames/COLLIDEPROBTS-1.png&quot; style=&quot;display: block; margin: auto;&quot; /&gt;&lt;/p&gt;
&lt;p&gt;It looks like the name distribution has become more diverse over
time, since the collision probability reduces over time. However, some
bias is to be expected due to the removal of names with frequencies
below 5 in a given year.&lt;/p&gt;
</description>
        <pubDate>Wed, 01 Mar 2017 00:00:00 +0100</pubDate>
        <link>https://mhoehle.github.io/blog/2017/03/01/morebabynames.html</link>
        <guid isPermaLink="true">https://mhoehle.github.io/blog/2017/03/01/morebabynames.html</guid>
        
        <category>rstats</category>
        
        <category>stats</category>
        
        <category>data journalism</category>
        
        <category>onomastics</category>
        
        
      </item>
    
      <item>
        <title>Happy pbirthday class of 2016</title>
        <description>&lt;h2 id=&quot;abstract&quot;&gt;Abstract&lt;/h2&gt;
&lt;p&gt;Continuing the analysis of first names given to newborns in Berlin
2016, we solve the following problem: what is the probability, that in a
school class of size &lt;span class=&quot;math inline&quot;&gt;\(n\)&lt;/span&gt; of these
kids there will be at least two kids having the same first name? The
answer to the problem for classes of size 26 is 34% and can be solved as
an instance of the birthday problem with unequal probabilities. R code
is provided for solving the problem exactly for moderate &lt;span
class=&quot;math inline&quot;&gt;\(n\)&lt;/span&gt; and approximately for larger &lt;span
class=&quot;math inline&quot;&gt;\(n\)&lt;/span&gt;. For the case that all probabilities
are equal, our results are compared to the output of R’s lovely
&lt;code&gt;pbirthday&lt;/code&gt; function.&lt;/p&gt;
&lt;center&gt;
&lt;img src=&quot;/blog/figure/source/2017-02-13-bday/APPROXVSEXACT-1.png&quot; /&gt;
&lt;/center&gt;
&lt;p&gt;&lt;br&gt;
&lt;a rel=&quot;license&quot; href=&quot;http://creativecommons.org/licenses/by-sa/4.0/&quot;&gt;&lt;img alt=&quot;Creative Commons License&quot; style=&quot;border-width:0&quot; src=&quot;https://i.creativecommons.org/l/by-sa/4.0/88x31.png&quot;/&gt;&lt;/a&gt;
This work is licensed under a &lt;a rel=&quot;license&quot;
href=&quot;http://creativecommons.org/licenses/by-sa/4.0/&quot;&gt;Creative Commons
Attribution-ShareAlike 4.0 International License&lt;/a&gt;. The
markdown+Rknitr source code of this blog is available under a &lt;a
href=&quot;https://www.gnu.org/licenses/gpl-3.0.html&quot;&gt;GNU General Public
License (GPL v3)&lt;/a&gt; license from github.&lt;/p&gt;
&lt;h2 id=&quot;introduction&quot;&gt;Introduction&lt;/h2&gt;
&lt;p&gt;The previous post &lt;a
href=&quot;http://staff.math.su.se/hoehle/blog/2017/02/06/onomastics.html&quot;&gt;Naming
Uncertainty by the Bootstrap&lt;/a&gt; contained an analysis of first names
given to newborns in Berlin 2016 &lt;span class=&quot;citation&quot;
data-cites=&quot;opendataberlinNames2016&quot;&gt;(Landesamt für Bürger- und
Ordnungsangelegenheiten Berlin 2017)&lt;/span&gt;. For instance, Marie and
Alexander were the top names among girls and boys, respectively. In a
comment &lt;a href=&quot;http://www.masalmon.eu/&quot;&gt;Maëlle&lt;/a&gt; asked &lt;em&gt;what’s
the resulting probability that there will be kids with the same first
name in a school class&lt;/em&gt;? We implement equations by &lt;span
class=&quot;citation&quot; data-cites=&quot;klotz1979&quot;&gt;Klotz (1979)&lt;/span&gt; and &lt;span
class=&quot;citation&quot; data-cites=&quot;mase1992&quot;&gt;Mase (1992)&lt;/span&gt; in R in order
to answer this important question.&lt;/p&gt;
&lt;h2 id=&quot;the-birthday-problem&quot;&gt;The Birthday Problem&lt;/h2&gt;
&lt;p&gt;The above posed question is a variation of the &lt;a
href=&quot;https://en.wikipedia.org/wiki/Birthday_problem&quot;&gt;&lt;strong&gt;birthday
problem&lt;/strong&gt;&lt;/a&gt;, which every statistician has solved at least once
in an introductory probability class: &lt;em&gt;in a class of &lt;span
class=&quot;math inline&quot;&gt;\(n\)&lt;/span&gt; randomly chosen persons, what is the
probability that some pair of them will have the same birthday&lt;/em&gt;?
Assuming that there are &lt;span class=&quot;math inline&quot;&gt;\(N=365\)&lt;/span&gt;
possible birthdays and all birthdays are equally probable the answer can
be calculated as:&lt;/p&gt;
&lt;p&gt;&lt;span class=&quot;math display&quot;&gt;\[
P(\text{at least two people in the class have the same birthday}) =
1-\frac{(N)_{n}}{N^n},
\]&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;where &lt;span class=&quot;math inline&quot;&gt;\((x)_n = x! / (x-n)!\)&lt;/span&gt; is the
so called &lt;strong&gt;factorial polynomial&lt;/strong&gt;. Say we are interested
in &lt;span class=&quot;math inline&quot;&gt;\(n=26\)&lt;/span&gt;, which is the &lt;a
href=&quot;https://www.berlin.de/imperia/md/content/sen-bildung/rechtsvorschriften/grundschulverordnung.pdf&quot;&gt;maximal
allowed class size&lt;/a&gt; in Berlin’s elementary schools (§4, Sect. 8 in
the regulation). We can perform the necessary calculations either
directly or by R’s &lt;code&gt;pbirthday&lt;/code&gt;function.&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb1&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb1-1&quot;&gt;&lt;a href=&quot;#cb1-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;n &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;dv&quot;&gt;26&lt;/span&gt; ; N &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;dv&quot;&gt;365&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-2&quot;&gt;&lt;a href=&quot;#cb1-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;c&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;manual=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;sc&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;exp&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;lfactorial&lt;/span&gt;(N)&lt;span class=&quot;sc&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;lfactorial&lt;/span&gt;(N&lt;span class=&quot;sc&quot;&gt;-&lt;/span&gt;n) &lt;span class=&quot;sc&quot;&gt;-&lt;/span&gt; n&lt;span class=&quot;sc&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;log&lt;/span&gt;(N)),&lt;/span&gt;
&lt;span id=&quot;cb1-3&quot;&gt;&lt;a href=&quot;#cb1-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;at&quot;&gt;pbirthday=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;pbirthday&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;n=&lt;/span&gt;n,&lt;span class=&quot;at&quot;&gt;classes=&lt;/span&gt;N))&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;##    manual pbirthday
## 0.5982408 0.5982408&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Finding the &lt;code&gt;pbirthday&lt;/code&gt; function as part of base R was a
bit surprising, but just underlines that R really has its roots in
&lt;strong&gt;statistics&lt;/strong&gt;!&lt;/p&gt;
&lt;h3 id=&quot;birthday-problem-with-unequal-probabilities&quot;&gt;Birthday Problem
with Unequal Probabilities&lt;/h3&gt;
&lt;p&gt;In our problem &lt;span class=&quot;math inline&quot;&gt;\(N\)&lt;/span&gt; corresponds to
all possible names of newborns in 2016. For the analysis we only group
by first name and thus do not distinguish between instances of the same
name used for both girls and boys.&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb3&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb3-1&quot;&gt;&lt;a href=&quot;#cb3-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;newborn &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; distrNames &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;group_by&lt;/span&gt;(firstname) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb3-2&quot;&gt;&lt;a href=&quot;#cb3-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;summarise&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;count=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;sum&lt;/span&gt;(count)) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;ungroup&lt;/span&gt;() &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb3-3&quot;&gt;&lt;a href=&quot;#cb3-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;mutate&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;p=&lt;/span&gt;count&lt;span class=&quot;sc&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;sum&lt;/span&gt;(count)) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb3-4&quot;&gt;&lt;a href=&quot;#cb3-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;arrange&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;desc&lt;/span&gt;(count))&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;## # A tibble: 13,245 × 3
##   firstname count           p
##       &amp;lt;chr&amp;gt; &amp;lt;int&amp;gt;       &amp;lt;dbl&amp;gt;
## 1     Marie   695 0.009996404
## 2    Sophie   649 0.009334772
## 3 Charlotte   495 0.007119741
## 4 Alexander   468 0.006731392
## # ... with 1.324e+04 more rows&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;In total there are &lt;span class=&quot;math inline&quot;&gt;\(N=13245\)&lt;/span&gt;
possible names. From the &lt;span class=&quot;math inline&quot;&gt;\(p\)&lt;/span&gt; column
it also becomes obvious that not all names are equally likely. Had they
been, the quick solution to Maëlle’s question would have been:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb5&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb5-1&quot;&gt;&lt;a href=&quot;#cb5-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;pbirthday&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;n=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;26&lt;/span&gt;, &lt;span class=&quot;at&quot;&gt;classes=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;nrow&lt;/span&gt;(newborn))&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;## [1] 0.02425434&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Less than 3%! However, we expect this probability to be much higher,
if we start to take the unequal occurrence probabilities into account.
So let’s do it!&lt;/p&gt;
&lt;p&gt;It’s easy to see that the probability of no collision, i.e. no kids
having the same name in the class, can be calculated as: &lt;span
class=&quot;math display&quot;&gt;\[
P(\overline{C}_n) = n!
\underset{1\leq i_1 &amp;lt; i_2 &amp;lt; \cdots &amp;lt;i_n \leq N}{\sum \sum
\cdots \sum} \&amp;gt;
p_{i_1} p_{i_2} \cdots p_{i_n}.
\]&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;However, this is a formidable number of terms to sum. In the case of
&lt;span class=&quot;math inline&quot;&gt;\(N=13245\)&lt;/span&gt; and &lt;span
class=&quot;math inline&quot;&gt;\(n=26\)&lt;/span&gt; the number is:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb7&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb7-1&quot;&gt;&lt;a href=&quot;#cb7-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;Rmpfr&lt;span class=&quot;sc&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;chooseMpfr&lt;/span&gt;(N,n)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;## 1 &amp;#39;mpfr&amp;#39; number of precision  294   bits
## [1] 360635627424461042343649241991659010127226742008898829465568350273963478046740130&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;That’s an 81 digit number! This is not &lt;em&gt;ever&lt;/em&gt; going to happen.
Instead &lt;span class=&quot;citation&quot; data-cites=&quot;klotz1979&quot;&gt;Klotz
(1979)&lt;/span&gt;, based on generating functions, showed that the above
equation corresponds to&lt;/p&gt;
&lt;p&gt;&lt;span class=&quot;math display&quot;&gt;\[
P(\overline{C}_n) = n!
\underset{\underset{\sum_{j=1}^n j \cdot t_j = n}{0\leq
t_1,t_2,\ldots,t_n \leq n}}{\sum \sum \cdots \sum}
(-1)^{n + \sum_j t_j}
\left(
\prod_{j=1}^n \frac{ (P_j/j)^{t_j}}{t_j!}
\right),
\]&lt;/span&gt; where &lt;span class=&quot;math inline&quot;&gt;\(P_j = \sum_{i=1}^N
p_i^j\)&lt;/span&gt;. Let the vector &lt;span
class=&quot;math inline&quot;&gt;\(\mathbf{t}=(t_1,\ldots,t_n)\)&lt;/span&gt; count the
number of singletons (&lt;span class=&quot;math inline&quot;&gt;\(t_1\)&lt;/span&gt;),
doubletons (&lt;span class=&quot;math inline&quot;&gt;\(t_2\)&lt;/span&gt;), triplets (&lt;span
class=&quot;math inline&quot;&gt;\(t_3\)&lt;/span&gt;), …, up to the number of names
occurring &lt;span class=&quot;math inline&quot;&gt;\(n\)&lt;/span&gt; times (&lt;span
class=&quot;math inline&quot;&gt;\(t_n\)&lt;/span&gt;). The above sum means that we have to
sum over all &lt;span class=&quot;math inline&quot;&gt;\(\mathbf{t}\)&lt;/span&gt; such that
&lt;span class=&quot;math inline&quot;&gt;\(\sum_{j=1}^n j \cdot t_j = n\)&lt;/span&gt;. The
number of such terms to sum is much lower than in the previous
expression, e.g., for &lt;span class=&quot;math inline&quot;&gt;\(N=13245\)&lt;/span&gt; and
&lt;span class=&quot;math inline&quot;&gt;\(n=26\)&lt;/span&gt; the number of terms is
2436.&lt;/p&gt;
&lt;p&gt;The above computations have been made available in the R package &lt;a
href=&quot;(https://github.com/hoehleatsu/birthdayproblem)&quot;&gt;&lt;code&gt;birthdayproblem&lt;/code&gt;&lt;/a&gt;
available from github:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb9&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb9-1&quot;&gt;&lt;a href=&quot;#cb9-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;devtools&lt;span class=&quot;sc&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;install_github&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;quot;hoehleatsu/birthdayproblem&amp;quot;&lt;/span&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;As an example, for &lt;span class=&quot;math inline&quot;&gt;\(n=4\)&lt;/span&gt; all the
necessary terms to sum can be found somewhat brute-force’ish by running
through the following four nested for loops:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;## compute_tList &amp;lt;- function() {
## n &amp;lt;- 4
## tList &amp;lt;- NULL
## for (t4 in 0:floor(n/4)) {
##  for (t3 in 0:floor(n/3)) {
##   for (t2 in 0:floor(n/2)) {
##    for (t1 in 0:floor(n/1)) {
##     t &amp;lt;- c(t1,t2,t3,t4)
##     if (sum( (1:n)*t) == n) tList &amp;lt;- rbind(tList, t)
##     if (sum( (n:(n-4+1)*t[n:(n-4+1)])) &amp;gt; n) break;
##    }
##    if (sum( (n:(n-3+1)*t[n:(n-3+1)])) &amp;gt; n) break;
##   }
##   if (sum( (n:(n-2+1)*t[n:(n-2+1)])) &amp;gt; n) break;
##  }
##  if (sum( (n:(n-1+1)*t[n:(n-1+1)])) &amp;gt; n) break;
## }
## return(tList)
## }&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;This function would then return the necessary sets for the &lt;span
class=&quot;math inline&quot;&gt;\(n=4\)&lt;/span&gt; case:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;##   [,1] [,2] [,3] [,4]
## t    4    0    0    0
## t    2    1    0    0
## t    0    2    0    0
## t    1    0    1    0
## t    0    0    0    1&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;which can be processed further as in the &lt;span class=&quot;citation&quot;
data-cites=&quot;klotz1979&quot;&gt;Klotz (1979)&lt;/span&gt; equation stated above in
order to compute the probability of interest.&lt;/p&gt;
&lt;p&gt;In the accompanying &lt;a
href=&quot;https://github.com/hoehleatsu/hoehleatsu.github.io/blob/master/_source/2017-02-13-bday.Rmd&quot;&gt;R
code of this blog post&lt;/a&gt; the above &lt;span
class=&quot;math inline&quot;&gt;\(n\)&lt;/span&gt; nested loops are constructed by the
function &lt;code&gt;birthdayproblem:::make_tListFunc_syntax&lt;/code&gt;, which
given &lt;span class=&quot;math inline&quot;&gt;\(n\)&lt;/span&gt; generates the syntax of the
necessary function nested loop function. Calling &lt;code&gt;source&lt;/code&gt; on
this syntax string then provides a proper R function to evaluate. A
similar function
&lt;code&gt;birthdayproblem:::make_tListFunc_syntax_cpp&lt;/code&gt; is provided to
generate an equivalent C++ function, which then using Rcpp’s
&lt;code&gt;sourceCpp&lt;/code&gt; function can be turned into an R function. As a
&lt;strong&gt;side note&lt;/strong&gt;: The nested for loops for increasing &lt;span
class=&quot;math inline&quot;&gt;\(n\)&lt;/span&gt; quickly look foul, which earned it the
predicate &lt;em&gt;possibly the best nested loop ever&lt;/em&gt; in a comment of a
&lt;a
href=&quot;http://stackoverflow.com/questions/42130954/compiling-many-nested-loops-using-the-rcppcppfunction&quot;&gt;stackoverflow
post&lt;/a&gt; concerned with the many nested loops breaking the
&lt;code&gt;clang&lt;/code&gt; compiler on MacOS.&lt;/p&gt;
&lt;p&gt;The above described syntax generation, evaluation and post-processing
steps necessary to compute the desired probability &lt;span
class=&quot;math inline&quot;&gt;\(1-P(\overline{C}_n)\)&lt;/span&gt; are all implemented
in the function &lt;code&gt;birthdayproblem::pbirthday_up&lt;/code&gt; (postfix:
&lt;code&gt;up&lt;/code&gt; for &lt;em&gt;u&lt;/em&gt;nequal &lt;em&gt;p&lt;/em&gt;ropabilities) in honour
of R’s &lt;code&gt;pbirthday&lt;/code&gt; function. A &lt;code&gt;method&lt;/code&gt; argument
allows the user to choose if the nested-loops should be computed using
&lt;code&gt;&quot;R&quot;&lt;/code&gt;, &lt;code&gt;&quot;Rcpp&quot;&lt;/code&gt;. As an alternative to the this
exact solution by &lt;span class=&quot;citation&quot; data-cites=&quot;klotz1979&quot;&gt;Klotz
(1979)&lt;/span&gt; one can also compute an approximate solution described in
&lt;span class=&quot;citation&quot; data-cites=&quot;mase1992&quot;&gt;Mase (1992)&lt;/span&gt;, which
is of the impressive order &lt;span class=&quot;math inline&quot;&gt;\(O(1)\)&lt;/span&gt;
while being extremely accurate (use &lt;code&gt;method=&quot;mase1992&quot;&lt;/code&gt;). The
R method works in acceptable time for &lt;span
class=&quot;math inline&quot;&gt;\(n\)&lt;/span&gt;’s up to around 35, the Rcpp runs &lt;span
class=&quot;math inline&quot;&gt;\(n=60\)&lt;/span&gt; in less than three minutes; for
larger &lt;span class=&quot;math inline&quot;&gt;\(n\)&lt;/span&gt; the approximation is to be
recommended if you don’t like waiting.&lt;/p&gt;
&lt;p&gt;With all code in place we finally can provide Maëlle with the correct
answer to her question:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb12&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb12-1&quot;&gt;&lt;a href=&quot;#cb12-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;n &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;dv&quot;&gt;26&lt;/span&gt;&lt;span class=&quot;dt&quot;&gt;L&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb12-2&quot;&gt;&lt;a href=&quot;#cb12-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;(p_theAnswer &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; birthdayproblem&lt;span class=&quot;sc&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;pbirthday_up&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;n=&lt;/span&gt;n, &lt;span class=&quot;at&quot;&gt;prob=&lt;/span&gt;newborn &lt;span class=&quot;sc&quot;&gt;%$%&lt;/span&gt; p)&lt;span class=&quot;sc&quot;&gt;$&lt;/span&gt;prob)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;## [1] 0.3399286&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;In other words, the probability of having a name collision in a class
of &lt;span class=&quot;math inline&quot;&gt;\(n=26\)&lt;/span&gt; is 34.0%. If local politics
would decide to increase the maximum class size by one, the resulting
probability for &lt;span class=&quot;math inline&quot;&gt;\(n=27\)&lt;/span&gt; would be:
36.1%. One more reason against increasing &lt;a
href=&quot;http://www.nzherald.co.nz/nz/news/article.cfm?c_id=1&amp;amp;objectid=11288618&quot;&gt;school
class size&lt;/a&gt;?&lt;/p&gt;
&lt;h3 id=&quot;numerical-comparisons&quot;&gt;Numerical Comparisons&lt;/h3&gt;
&lt;p&gt;We first test the &lt;code&gt;birthdayproblem&lt;/code&gt; package’s
&lt;code&gt;pbirthday_up&lt;/code&gt; function on the classical birthday problem
with equal probabilities:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb14&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb14-1&quot;&gt;&lt;a href=&quot;#cb14-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;c&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;pbirthday=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;pbirthday&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;n=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;26&lt;/span&gt;&lt;span class=&quot;dt&quot;&gt;L&lt;/span&gt;, &lt;span class=&quot;dv&quot;&gt;365&lt;/span&gt;),&lt;/span&gt;
&lt;span id=&quot;cb14-2&quot;&gt;&lt;a href=&quot;#cb14-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;at&quot;&gt;klotz1979_R=&lt;/span&gt;birthdayproblem&lt;span class=&quot;sc&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;pbirthday_up&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;n=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;26&lt;/span&gt;&lt;span class=&quot;dt&quot;&gt;L&lt;/span&gt;, &lt;span class=&quot;fu&quot;&gt;rep&lt;/span&gt;(&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;365&lt;/span&gt;, &lt;span class=&quot;dv&quot;&gt;365&lt;/span&gt;), &lt;span class=&quot;at&quot;&gt;method=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;R&amp;quot;&lt;/span&gt;)&lt;span class=&quot;sc&quot;&gt;$&lt;/span&gt;prob,&lt;/span&gt;
&lt;span id=&quot;cb14-3&quot;&gt;&lt;a href=&quot;#cb14-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;at&quot;&gt;klotz1979_Rcpp=&lt;/span&gt;birthdayproblem&lt;span class=&quot;sc&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;pbirthday_up&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;n=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;26&lt;/span&gt;&lt;span class=&quot;dt&quot;&gt;L&lt;/span&gt;, &lt;span class=&quot;fu&quot;&gt;rep&lt;/span&gt;(&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;365&lt;/span&gt;, &lt;span class=&quot;dv&quot;&gt;365&lt;/span&gt;), &lt;span class=&quot;at&quot;&gt;method=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;Rcpp&amp;quot;&lt;/span&gt;)&lt;span class=&quot;sc&quot;&gt;$&lt;/span&gt;prob,&lt;/span&gt;
&lt;span id=&quot;cb14-4&quot;&gt;&lt;a href=&quot;#cb14-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;at&quot;&gt;mase1992=&lt;/span&gt;birthdayproblem&lt;span class=&quot;sc&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;pbirthday_up&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;n=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;26&lt;/span&gt;&lt;span class=&quot;dt&quot;&gt;L&lt;/span&gt;, &lt;span class=&quot;fu&quot;&gt;rep&lt;/span&gt;(&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;365&lt;/span&gt;, &lt;span class=&quot;dv&quot;&gt;365&lt;/span&gt;), &lt;span class=&quot;at&quot;&gt;method=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;mase1992&amp;quot;&lt;/span&gt;)&lt;span class=&quot;sc&quot;&gt;$&lt;/span&gt;prob)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;##      pbirthday    klotz1979_R klotz1979_Rcpp       mase1992
##      0.5982408      0.5982408      0.5982408      0.5981971&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;works like a &lt;strong&gt;dream&lt;/strong&gt;!&lt;/p&gt;
&lt;p&gt;Speed-wise, the R looping approach takes 385s to compute the result
for &lt;span class=&quot;math inline&quot;&gt;\(n=40\)&lt;/span&gt;. The Rcpp approach on the
other hand works in just 61s. The approximation by &lt;span
class=&quot;citation&quot; data-cites=&quot;mase1992&quot;&gt;Mase (1992)&lt;/span&gt; only takes
0.021 s. To assess the quality of the approximation we consider a range
of different &lt;span class=&quot;math inline&quot;&gt;\(n\)&lt;/span&gt;:&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;http://staff.math.su.se/hoehle/blog/figure/source/2017-02-13-bday/APPROXVSEXACT-1.png&quot; style=&quot;display: block; margin: auto;&quot; /&gt;&lt;/p&gt;
&lt;p&gt;It’s hardly possible to see the difference between the approximation
and the exact solution. For better comparison, we also show the absolute
error between the approximate solution and the exact solution:&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;http://staff.math.su.se/hoehle/blog/figure/source/2017-02-13-bday/ABSERROR-1.png&quot; style=&quot;display: block; margin: auto;&quot; /&gt;&lt;/p&gt;
&lt;p&gt;It’s amazing to see how small the error really is.&lt;/p&gt;
&lt;h2 id=&quot;discussion&quot;&gt;Discussion&lt;/h2&gt;
&lt;p&gt;We calculated that the probability of a name-collision in a class of
&lt;span class=&quot;math inline&quot;&gt;\(n=26\)&lt;/span&gt; kids born in Berlin 2016 is
34%. Furthermore, we showed that clever mathematical approximations are
better than brute-force computations, that stack-exchange rules and that
Rcpp can speed up your R program considerably. Furthermore, you have
been shown the best nested for loop ever! Finally, in honour of &lt;a
href=&quot;https://www.secfac.wisc.edu/senate/2007/0305/1976(mem_res).pdf&quot;&gt;Jerome
Klotz&lt;/a&gt; a screenshot of the Acknowledgements section of the &lt;span
class=&quot;citation&quot; data-cites=&quot;klotz1979&quot;&gt;Klotz (1979)&lt;/span&gt; technical
report:&lt;/p&gt;
&lt;center&gt;
&lt;img src=&quot;/blog/figure/source/2017-02-13-bday/klotz1979.png&quot; /&gt;
&lt;/center&gt;
&lt;p&gt;
&lt;p&gt;
&lt;h2 class=&quot;unnumbered&quot; id=&quot;literature&quot;&gt;Literature&lt;/h2&gt;
&lt;div id=&quot;refs&quot; class=&quot;references csl-bib-body hanging-indent&quot;
data-entry-spacing=&quot;0&quot; role=&quot;list&quot;&gt;
&lt;div id=&quot;ref-klotz1979&quot; class=&quot;csl-entry&quot; role=&quot;listitem&quot;&gt;
Klotz, J. 1979. &lt;span&gt;“The Birthday Problem with Unequal
Probabilities.”&lt;/span&gt; 591. Department of Statistics, University of
Wisconsin, Madison. &lt;a
href=&quot;https://www.stat.wisc.edu/techreports/tr591.pdf&quot;&gt;https://www.stat.wisc.edu/techreports/tr591.pdf&lt;/a&gt;.
&lt;/div&gt;
&lt;div id=&quot;ref-opendataberlinNames2016&quot; class=&quot;csl-entry&quot; role=&quot;listitem&quot;&gt;
Landesamt für Bürger- und Ordnungsangelegenheiten Berlin. 2017.
&lt;span&gt;“Liste Der Häufigen Vornamen 2016.”&lt;/span&gt; &lt;a
href=&quot;https://daten.berlin.de/datensaetze/liste-der-häufigen-vornamen-2016&quot;
class=&quot;uri&quot;&gt;https://daten.berlin.de/datensaetze/liste-der-häufigen-vornamen-2016&lt;/a&gt;.
Data published under a CC-BY license.
&lt;/div&gt;
&lt;div id=&quot;ref-mase1992&quot; class=&quot;csl-entry&quot; role=&quot;listitem&quot;&gt;
Mase, S. 1992. &lt;span&gt;“Approximations to the Birthday Problem with
Unequal Occurrence Probabilities and Their Application to the Surname
Problem in &lt;span&gt;J&lt;/span&gt;apan.”&lt;/span&gt; &lt;em&gt;Ann. Inst. Stat. Math.&lt;/em&gt;
44 (3): 479–99.
&lt;/div&gt;
&lt;/div&gt;
</description>
        <pubDate>Mon, 13 Feb 2017 00:00:00 +0100</pubDate>
        <link>https://mhoehle.github.io/blog/2017/02/13/bday.html</link>
        <guid isPermaLink="true">https://mhoehle.github.io/blog/2017/02/13/bday.html</guid>
        
        <category>rstats</category>
        
        <category>stats</category>
        
        <category>data journalism</category>
        
        <category>onomastics</category>
        
        
      </item>
    
      <item>
        <title>Naming Uncertainty by the Bootstrap</title>
        <description>&lt;h2 id=&quot;abstract&quot;&gt;Abstract&lt;/h2&gt;
&lt;p&gt;Data on the names of all newborn babies in Berlin 2016 are used to
illustrate how a scientific treatment of chance could enhance rank
statements in, e.g., &lt;strong&gt;onomastics&lt;/strong&gt; investigations. For
this purpose, we first identify different stages of the naming-your-baby
process, which are influenced by chance. Second, we compute confidence
intervals for the ranks based on a bootstrap procedure reflecting the
above chance elements. This leads to an alternative league table based
on what we will call &lt;strong&gt;uncertainty corrected ranks&lt;/strong&gt;. From
an R perspective we use the problem as a practice session for wrangling
data &lt;code&gt;dplyr&lt;/code&gt;-style (code available by clicking on the github
logo in the license below).&lt;/p&gt;
&lt;center&gt;
&lt;img
src=&quot;/blog/figure/source/2017-02-06-onomastics/WORDMAPCLOUD-1.png&quot; /&gt;
&lt;/center&gt;
&lt;p&gt;&lt;br&gt;
&lt;a rel=&quot;license&quot; href=&quot;http://creativecommons.org/licenses/by-sa/4.0/&quot;&gt;&lt;img alt=&quot;Creative Commons License&quot; style=&quot;border-width:0&quot; src=&quot;https://i.creativecommons.org/l/by-sa/4.0/88x31.png&quot;/&gt;&lt;/a&gt;
This work is licensed under a &lt;a rel=&quot;license&quot;
href=&quot;http://creativecommons.org/licenses/by-sa/4.0/&quot;&gt;Creative Commons
Attribution-ShareAlike 4.0 International License&lt;/a&gt;. The
markdown+Rknitr source code of this blog is available under a &lt;a
href=&quot;https://www.gnu.org/licenses/gpl-3.0.html&quot;&gt;GNU General Public
License (GPL v3)&lt;/a&gt; license from github.&lt;/p&gt;
&lt;h2 id=&quot;introduction&quot;&gt;Introduction&lt;/h2&gt;
&lt;p&gt;What’s the most popular first name given to newborn boys and girls?
This question seems to fascinate at different levels of temporal and
spatial aggregation, because the choice of names and its dynamics
reflects cultural and social behavior. The branch of science related to
the study of names is entitled &lt;a
href=&quot;https://en.wikipedia.org/wiki/Onomastics&quot;&gt;&lt;strong&gt;onomastics&lt;/strong&gt;&lt;/a&gt;.
Mathematical modelling is used in onomastics to study name dynamics by
evolutionary models and models for contagious phenomena &lt;span
class=&quot;citation&quot; data-cites=&quot;kahn_bentley2003 kessler_etal2012&quot;&gt;(Hahn
and Bentley 2003; Kessler et al. 2012)&lt;/span&gt;. But even the task of &lt;a
href=&quot;(http://waitbutwhy.com/2013/12/how-to-name-baby.html)&quot;&gt;naming your
baby&lt;/a&gt; has almost onomastics optimizing flavour requiring data science
skills. However, once the Official Social Security Administration has
released the numbers for all names of newborns in a given year, finding
the most popular baby name appears a simple counting and ranking job:
for example the &lt;a
href=&quot;http://www.babynamewizard.com/the-top-1000-baby-names-of-2015-united-states-of-america&quot;&gt;most
popular US baby names in 2015 were Emma (girls) and Noah (boys)&lt;/a&gt;.&lt;/p&gt;
&lt;center&gt;
&lt;img
src=&quot;/blog/figure/source/2017-02-06-onomastics/Hello-My-Name-Is.png&quot; /&gt;
&lt;br&gt;
&lt;!-- Modified based on the following source: https://openclipart.org/image/300px/svg_to_png/250091/ --&gt;
&lt;/center&gt;
&lt;p&gt;
&lt;p&gt;
&lt;p&gt;&lt;strong&gt;Statistics&lt;/strong&gt; is the scientific study of chance. One
fundamental concept is the inference of a &lt;strong&gt;population&lt;/strong&gt;
quantity from observing the quantity in a &lt;strong&gt;sample&lt;/strong&gt;
(=subset) of this population. To make this specific for the baby names:
In Germany there is no official first name statistics, as a consequence,
the site &lt;a
href=&quot;http://www.beliebte-vornamen.de&quot;&gt;www.beliebte-vornamen.de&lt;/a&gt; uses
information from a sample of 196,158 kids (corresponding to 26% of all
newborns in Germany 2016) originating from a selection of registrar’s
offices and birth clinics to determine the most popular first name in
Germany 2016. However, the aspect of uncertainty in the resulting
ranking, due to only measuring a sample of the population, is ignored
when reporting the &lt;a
href=&quot;http://www.beliebte-vornamen.de/jahrgang/j2016&quot;&gt;2016 league
table&lt;/a&gt;. The aspect of uncertainty can, however, also be more subtle.
As an example, the city of Berlin recently released the official &lt;a
href=&quot;https://daten.berlin.de/datensaetze/liste-der-h%C3%A4ufigen-vornamen-2014&quot;&gt;2016
first name statistic&lt;/a&gt; of &lt;strong&gt;all newborns&lt;/strong&gt; in the city
&lt;span class=&quot;citation&quot; data-cites=&quot;opendataberlinNames2016&quot;&gt;(Landesamt
für Bürger- und Ordnungsangelegenheiten Berlin 2017)&lt;/span&gt;. The data
are available at &lt;a
href=&quot;https://en.wikipedia.org/wiki/Boroughs_and_neighborhoods_of_Berlin&quot;&gt;district
level&lt;/a&gt;, which is helpful, because there are notable socio-economic
and cultural differences between the districts. One could argue that
since the data cover the &lt;strong&gt;entire population of interest&lt;/strong&gt;
(i.e. newborns in Berlin 2016) the use of &lt;strong&gt;inferential
statistics&lt;/strong&gt; is superfluous. But is it that simple?&lt;/p&gt;
&lt;p&gt;In what follows we use the Berlin newborn names to illustrate how a
scientific treatment of &lt;strong&gt;chance&lt;/strong&gt; could enhance rank
statements in general and in name rank tables in particular.&lt;/p&gt;
&lt;h2 id=&quot;descriptive-data-analysis&quot;&gt;Descriptive Data Analysis&lt;/h2&gt;
&lt;p&gt;Altogether, the &lt;code&gt;distrNames&lt;/code&gt; variable contains the
information about the frequency of 13245 unique first names. Below is
shown the first 10 lines of the data.&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;http://staff.math.su.se/hoehle/blog/figure/source/2017-02-06-onomastics/unnamed-chunk-5-1.png&quot; style=&quot;display: block; margin: auto;&quot; /&gt;&lt;/p&gt;
&lt;p&gt;By summing the &lt;code&gt;count&lt;/code&gt; column it becomes clear that in
total, 69525 names were registered in Berlin 2016 (35620 boys and 33905)
girls. The proportion of boy names is 51.2%. One caveat with the Berlin
name statistic is that, if a child is given several first names, each
name is counted once in the statistic. Hence, the above total sum is
actually higher than the number of kids born 2016 (38,030 in 2015,
official 2016 number not available yet). Despite of the potential
problems with multiple names per kids, the empirical boy fraction in the
data is close to reported ratios of the number of born boys vs. girls of
1.05 &lt;span class=&quot;citation&quot; data-cites=&quot;jacobsen1999&quot;&gt;(Jacobsen, Møller,
and Mouritsen 1999)&lt;/span&gt;, which means that the expected fraction of
boys among the newborns should be approximately 51.2%.&lt;/p&gt;
&lt;p&gt;Strangely enough, 15 babies seem to have an empty first name (but the
sex is known). We decided to keep these &lt;code&gt;NA&lt;/code&gt; names in the
analysis, because at the time of writing it was unclear, if this is a
data recording problem (e.g. a delay of the December 2016 kids) or
actually allowed. An email inquiry with the data providing agency
revealed that an empty name is the result of the naming authority &lt;a
href=&quot;https://translate.google.com/translate?sl=auto&amp;amp;tl=en&amp;amp;js=y&amp;amp;prev=_t&amp;amp;hl=en&amp;amp;ie=UTF-8&amp;amp;u=http%3A%2F%2Fwww.berliner-zeitung.de%2Feltern-wollen-seit-einem-jahr-ihre-tochter-jona-nennen--doch-das-standesamt-lehnt-den-namen-ab-baby-namenlos-16740670&amp;amp;edit-text=&quot;&gt;declining
a chosen first name&lt;/a&gt; in the interest of the kid. In this case the
baby remains nameless on the birth certificate until the dispute is
resolved before court.&lt;/p&gt;
&lt;p&gt;We can now look at the top-5-names in Berlin for each gender:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb1&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb1-1&quot;&gt;&lt;a href=&quot;#cb1-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##Aggregate data over district and sort according to rank within gender&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-2&quot;&gt;&lt;a href=&quot;#cb1-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;newborn &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; distrNames &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;group_by&lt;/span&gt;(firstname, sex) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-3&quot;&gt;&lt;a href=&quot;#cb1-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;summarise&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;count=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;sum&lt;/span&gt;(count)) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-4&quot;&gt;&lt;a href=&quot;#cb1-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;arrange&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;desc&lt;/span&gt;(count)) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;group_by&lt;/span&gt;(sex) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-5&quot;&gt;&lt;a href=&quot;#cb1-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;mutate&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;rank=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;rank&lt;/span&gt;(&lt;span class=&quot;sc&quot;&gt;-&lt;/span&gt;count,&lt;span class=&quot;at&quot;&gt;ties=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;min&amp;quot;&lt;/span&gt;))&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;## Source: local data frame [10 x 4]
## Groups: sex [2]
## 
##     firstname    sex count  rank
##         &amp;lt;chr&amp;gt; &amp;lt;fctr&amp;gt; &amp;lt;int&amp;gt; &amp;lt;int&amp;gt;
## 1       Marie      f   695     1
## 2      Sophie      f   649     2
## 3   Charlotte      f   495     3
## 4       Maria      f   403     4
## 5      Emilia      f   382     5
## 6   Alexander      m   467     1
## 7        Paul      m   383     2
## 8       Elias      m   371     3
## 9  Maximilian      m   344     4
## 10       Emil      m   295     5&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;The top-1 names per gender and district from &lt;code&gt;distrNames&lt;/code&gt;
can easily be computed in similar fashion using &lt;code&gt;group_by&lt;/code&gt;
and &lt;code&gt;summarise&lt;/code&gt; operations. To spice up the visualization we
use a custom made &lt;strong&gt;wordmapcloud&lt;/strong&gt;, which overlays the
top-1 names over an alpha-channeled wordcloud of the district’s name
with font size proportional to frequency. In the resulting plot we see
little geographical variation in the top-1 names over the districts -
particularly for girls.&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;http://staff.math.su.se/hoehle/blog/figure/source/2017-02-06-onomastics/WORDMAPCLOUD-1.png&quot; style=&quot;display: block; margin: auto;&quot; /&gt;&lt;/p&gt;
&lt;p&gt;The &lt;a href=&quot;https://en.wikipedia.org/wiki/Gini_coefficient&quot;&gt;Gini
index&lt;/a&gt; for the name frequency is calculated using the
&lt;code&gt;ineq&lt;/code&gt; package and is 0.728 and 0.743 for girls and boys,
respectively. This means that the occurrence of names in boys is
dominated by fewer names for boys than for girls. Furthermore, both
gender’s name distribution tend to be dominated by few names. This
feature can also be visualized by a Lorenz curve - here shown separately
for each sex:&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;http://staff.math.su.se/hoehle/blog/figure/source/2017-02-06-onomastics/LORENZCURVE-1.png&quot; style=&quot;display: block; margin: auto;&quot; /&gt;&lt;/p&gt;
&lt;p&gt;From the curve one can for example deduce that the frequency of the
top-50 girl names (top 0.7% out of the 6957 girl names), cover 29.0% of
all 33905 girl namings.&lt;/p&gt;
&lt;h2 id=&quot;analysing-stochasticity-in-the-name-selection&quot;&gt;Analysing
Stochasticity in the Name Selection&lt;/h2&gt;
&lt;p&gt;At which places is stochasticity a useful concept for abstracting
unobservable factors influencing the name selection? We shall focus on 5
stages:&lt;/p&gt;
&lt;ol type=&quot;1&quot;&gt;
&lt;li&gt;&lt;p&gt;the number of babies born in Berlin in 2016&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;the gender of a given born baby; as mentioned above the odds for
the kid being a boy is roughly 1.05:1.&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;the number of names given to a baby of a specific sex&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;the selection of the name(s) given that the gender of the baby is
known&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;reporting problems leading to the wrong name(s) being
recorded&lt;/p&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;We will ignore uncertainty from stages 1, 3 and 5 and, hence, only
focus on uncertainty arising from stages 2 and 4. One may ask in stage
4, if the naming is not deterministic, once the parents know the sex of
their baby? In this post we take the position that &lt;em&gt;even&lt;/em&gt; given
sex the naming is the outcome of a stochastic process. The selection
probabilities are likely to vary from couple to couple based on complex
interactions between, e.g., social status, existing names in the family
as well as past exposure and associations with names. Since data are
never going to be available on these individual factors, we will, as a
proxy, assume that the drawing probabilities are district specific. As a
result, the selected name can be considered as one realization of the
multinomial distribution with the underlying true popularity of all
possible names in the district acting as selection probabilities.&lt;/p&gt;
&lt;h3 id=&quot;uncertainty-assessment-using-the-bootstrap&quot;&gt;Uncertainty
Assessment using the Bootstrap&lt;/h3&gt;
&lt;p&gt;When combining the above stages 3 and 4, the name selection process
can be mimicked by a &lt;strong&gt;simple bootstrap&lt;/strong&gt; procedure
&lt;strong&gt;stratified by district&lt;/strong&gt; &lt;span class=&quot;citation&quot;
data-cites=&quot;davison_hinkley1997&quot;&gt;(Davison and Hinkley 1997)&lt;/span&gt;. In
spirit, this approach corresponds to the bootstrap approach to ranks
used in Sect. 5.3 of &lt;span class=&quot;citation&quot;
data-cites=&quot;goldstein_spiegelhalter1996&quot;&gt;Goldstein and Spiegelhalter
(1996)&lt;/span&gt;. We operationalise this in R using the &lt;code&gt;boot&lt;/code&gt;
package, the work-horse will be the function &lt;code&gt;name_ranks&lt;/code&gt;
shown below.&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb3&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb3-1&quot;&gt;&lt;a href=&quot;#cb3-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;######################################################################&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb3-2&quot;&gt;&lt;a href=&quot;#cb3-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;## Compute rank of name within female and male population,&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb3-3&quot;&gt;&lt;a href=&quot;#cb3-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;## respectively for a draw of all kids (one kid per row) with&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb3-4&quot;&gt;&lt;a href=&quot;#cb3-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;## replacement.&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb3-5&quot;&gt;&lt;a href=&quot;#cb3-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb3-6&quot;&gt;&lt;a href=&quot;#cb3-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;## Parameters:&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb3-7&quot;&gt;&lt;a href=&quot;#cb3-7&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##  x - the full data, one row per kid&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb3-8&quot;&gt;&lt;a href=&quot;#cb3-8&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##  idx - vector of length nrow(x) containing a possible permutation&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb3-9&quot;&gt;&lt;a href=&quot;#cb3-9&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##        (with replacement)&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb3-10&quot;&gt;&lt;a href=&quot;#cb3-10&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##  returns - which column to return, &amp;quot;rank&amp;quot; or &amp;quot;count&amp;quot; (for use in boot).&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb3-11&quot;&gt;&lt;a href=&quot;#cb3-11&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##            If returns==&amp;quot;dplyr::everything()&amp;quot;, then entire frame is returned (useful for&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb3-12&quot;&gt;&lt;a href=&quot;#cb3-12&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##            use with broom)&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb3-13&quot;&gt;&lt;a href=&quot;#cb3-13&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb3-14&quot;&gt;&lt;a href=&quot;#cb3-14&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;## Returns:&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb3-15&quot;&gt;&lt;a href=&quot;#cb3-15&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##  vector or data.frame with stratified ranks (arranged by (firstname, sex))&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb3-16&quot;&gt;&lt;a href=&quot;#cb3-16&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;######################################################################&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb3-17&quot;&gt;&lt;a href=&quot;#cb3-17&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb3-18&quot;&gt;&lt;a href=&quot;#cb3-18&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;name_ranks &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;cf&quot;&gt;function&lt;/span&gt;(x,  &lt;span class=&quot;at&quot;&gt;idx=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;seq_len&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;nrow&lt;/span&gt;(x)), &lt;span class=&quot;at&quot;&gt;returns=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;c&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;quot;rank&amp;quot;&lt;/span&gt;,&lt;span class=&quot;st&quot;&gt;&amp;quot;count&amp;quot;&lt;/span&gt;,&lt;span class=&quot;st&quot;&gt;&amp;quot;dplyr::everything()&amp;quot;&lt;/span&gt;)) {&lt;/span&gt;
&lt;span id=&quot;cb3-19&quot;&gt;&lt;a href=&quot;#cb3-19&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;do&quot;&gt;##Make resampled data and append all_strata to ensure each firstname-sex combination occurs&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb3-20&quot;&gt;&lt;a href=&quot;#cb3-20&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  x_boot &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; x &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;slice&lt;/span&gt;(idx) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;bind_rows&lt;/span&gt;(all_strata)&lt;/span&gt;
&lt;span id=&quot;cb3-21&quot;&gt;&lt;a href=&quot;#cb3-21&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb3-22&quot;&gt;&lt;a href=&quot;#cb3-22&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;do&quot;&gt;##Summarise the number of occurrences for each firstname-sex strata and compute the ranks.&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb3-23&quot;&gt;&lt;a href=&quot;#cb3-23&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  aggrx_wranks &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; x_boot &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt;  &lt;span class=&quot;fu&quot;&gt;group_by&lt;/span&gt;(firstname,sex) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb3-24&quot;&gt;&lt;a href=&quot;#cb3-24&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;fu&quot;&gt;summarise&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;count =&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;sum&lt;/span&gt;(count)) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb3-25&quot;&gt;&lt;a href=&quot;#cb3-25&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;fu&quot;&gt;group_by&lt;/span&gt;(sex) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb3-26&quot;&gt;&lt;a href=&quot;#cb3-26&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;fu&quot;&gt;mutate&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;rank=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;rank&lt;/span&gt;(&lt;span class=&quot;sc&quot;&gt;-&lt;/span&gt;count, &lt;span class=&quot;at&quot;&gt;ties.method=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;min&amp;quot;&lt;/span&gt;)) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb3-27&quot;&gt;&lt;a href=&quot;#cb3-27&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;fu&quot;&gt;arrange&lt;/span&gt;(firstname, sex) &lt;span class=&quot;co&quot;&gt;#important to ensure order.&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb3-28&quot;&gt;&lt;a href=&quot;#cb3-28&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb3-29&quot;&gt;&lt;a href=&quot;#cb3-29&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;do&quot;&gt;##Select relevant columns&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb3-30&quot;&gt;&lt;a href=&quot;#cb3-30&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  res &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; aggrx_wranks &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;ungroup&lt;/span&gt;() &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;select_&lt;/span&gt;(returns)&lt;/span&gt;
&lt;span id=&quot;cb3-31&quot;&gt;&lt;a href=&quot;#cb3-31&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb3-32&quot;&gt;&lt;a href=&quot;#cb3-32&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;do&quot;&gt;##Return as vector (needed for boot pkg) or data.frame (needed from broom)&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb3-33&quot;&gt;&lt;a href=&quot;#cb3-33&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;cf&quot;&gt;if&lt;/span&gt; (returns[&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;] &lt;span class=&quot;sc&quot;&gt;%in%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;c&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;quot;rank&amp;quot;&lt;/span&gt;,&lt;span class=&quot;st&quot;&gt;&amp;quot;count&amp;quot;&lt;/span&gt;)) &lt;span class=&quot;fu&quot;&gt;return&lt;/span&gt;(res &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; .[[&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;]]) &lt;span class=&quot;cf&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;return&lt;/span&gt;(res)&lt;/span&gt;
&lt;span id=&quot;cb3-34&quot;&gt;&lt;a href=&quot;#cb3-34&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;In the above, &lt;code&gt;all_strata&lt;/code&gt; is a &lt;code&gt;data.frame&lt;/code&gt;
containing all possible strata of gender and firstname. This is done in
order to ensure that we later get a zero count for names, even if they
do not appear in the bootstrap re-sample.&lt;/p&gt;
&lt;p&gt;We then convert the aggregated data to long format where each kid is
represented by one row. This is the most didactic way to explain what is
going on in the bootstrap, but an aggregated multinomial approach would
probably be faster in terms of execution time.&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb4&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb4-1&quot;&gt;&lt;a href=&quot;#cb4-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;kids &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; distrNames &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;slice&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;rep&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;seq_len&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;nrow&lt;/span&gt;(distrNames)), &lt;span class=&quot;at&quot;&gt;times=&lt;/span&gt;distrNames &lt;span class=&quot;sc&quot;&gt;%$%&lt;/span&gt; count)) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;mutate&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;count=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Ready to perform the bootstrap stratified within districts? Yes, its
conveniently done using the &lt;code&gt;boot&lt;/code&gt; package (which is easily
paralleled too).&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb5&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb5-1&quot;&gt;&lt;a href=&quot;#cb5-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;set.seed&lt;/span&gt;(&lt;span class=&quot;dv&quot;&gt;123&lt;/span&gt;) &lt;span class=&quot;do&quot;&gt;##fix seed for reproducibility&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb5-2&quot;&gt;&lt;a href=&quot;#cb5-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;b &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; boot&lt;span class=&quot;sc&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;boot&lt;/span&gt;(kids, &lt;span class=&quot;at&quot;&gt;statistic=&lt;/span&gt;name_ranks, &lt;span class=&quot;at&quot;&gt;R=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;999&lt;/span&gt;, &lt;span class=&quot;at&quot;&gt;strata=&lt;/span&gt;kids&lt;span class=&quot;sc&quot;&gt;$&lt;/span&gt;district, &lt;span class=&quot;at&quot;&gt;parallel=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;multicore&amp;quot;&lt;/span&gt;,&lt;span class=&quot;at&quot;&gt;ncpus=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;3&lt;/span&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;We use the percentile method on the 999 + 1 bootstrap rank-vectors as
a method for computing a 90% confidence interval for the rank of each
name for boys and girls, respectively.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Update 2017-02-07&lt;/strong&gt;: &lt;a
href=&quot;http://www.masalmon.eu/&quot;&gt;Maëlle&lt;/a&gt; made me &lt;a
href=&quot;https://twitter.com/ma_salmon/status/828505021666967552&quot;&gt;aware&lt;/a&gt;
of some newer ways to perform the bootstrap, e.g., using the
&lt;code&gt;broom&lt;/code&gt; package. It’s especially useful for the parametric
bootstrap, but by joining with the previously calculated observed ranks,
the code for making a simple bootstrap stratified bootstrap actually
looks quite nice (although not parallized and hence slower):&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb6&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb6-1&quot;&gt;&lt;a href=&quot;#cb6-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;require&lt;/span&gt;(broom)&lt;/span&gt;
&lt;span id=&quot;cb6-2&quot;&gt;&lt;a href=&quot;#cb6-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;b_broom &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; kids &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;group_by&lt;/span&gt;(district) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;bootstrap&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;m=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;999&lt;/span&gt;, &lt;span class=&quot;at&quot;&gt;by_group=&lt;/span&gt;&lt;span class=&quot;cn&quot;&gt;TRUE&lt;/span&gt;) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb6-3&quot;&gt;&lt;a href=&quot;#cb6-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;do&lt;/span&gt;({ &lt;span class=&quot;fu&quot;&gt;name_ranks&lt;/span&gt;(.,&lt;span class=&quot;at&quot;&gt;returns=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;dplyr::everything()&amp;quot;&lt;/span&gt;) }) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb6-4&quot;&gt;&lt;a href=&quot;#cb6-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;group_by&lt;/span&gt;(sex,firstname) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb6-5&quot;&gt;&lt;a href=&quot;#cb6-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;summarise&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;quot;rankci.5.&amp;quot;&lt;/span&gt;&lt;span class=&quot;ot&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;quantile&lt;/span&gt;(rank, &lt;span class=&quot;fl&quot;&gt;0.05&lt;/span&gt;,&lt;span class=&quot;at&quot;&gt;type=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;3&lt;/span&gt;),&lt;span class=&quot;st&quot;&gt;&amp;quot;rankci.95.&amp;quot;&lt;/span&gt;&lt;span class=&quot;ot&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;quantile&lt;/span&gt;(rank, &lt;span class=&quot;fl&quot;&gt;0.95&lt;/span&gt;,&lt;span class=&quot;at&quot;&gt;type=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;3&lt;/span&gt;))&lt;/span&gt;
&lt;span id=&quot;cb6-6&quot;&gt;&lt;a href=&quot;#cb6-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb6-7&quot;&gt;&lt;a href=&quot;#cb6-7&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;newborn_ranks &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; newborn &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;inner_join&lt;/span&gt;(b_broom,&lt;span class=&quot;at&quot;&gt;by=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;c&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;quot;firstname&amp;quot;&lt;/span&gt;,&lt;span class=&quot;st&quot;&gt;&amp;quot;sex&amp;quot;&lt;/span&gt;)) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;arrange&lt;/span&gt;(rank,sex)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;## Source: local data frame [10 x 6]
## Groups: sex [2]
## 
##     firstname    sex count  rank rankci.5. rankci.95.
##         &amp;lt;chr&amp;gt; &amp;lt;fctr&amp;gt; &amp;lt;int&amp;gt; &amp;lt;int&amp;gt;     &amp;lt;int&amp;gt;      &amp;lt;int&amp;gt;
## 1       Marie      f   695     1         1          2
## 2   Alexander      m   467     1         1          1
## 3      Sophie      f   649     2         1          2
## 4        Paul      m   383     2         2          3
## 5   Charlotte      f   495     3         3          3
## 6       Elias      m   371     3         2          4
## 7       Maria      f   403     4         4          5
## 8  Maximilian      m   344     4         3          4
## 9      Emilia      f   382     5         4          5
## 10       Emil      m   295     5         5          9&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Using the lower limit of the 90% CI to group the names, we define the
concept of a &lt;strong&gt;uncertainty corrected&lt;/strong&gt; rank (ucrank). This
is just the lowest rank which we, given the modelled stochasticity,
cannot be ruled out (at the 5% lvl. of significance). Listing the top-5
of these corrected ranks leads to the following tables for girls and
boys, respectively:&lt;/p&gt;
&lt;center&gt;
&lt;!-- html table generated in R 3.3.3 by xtable 1.8-2 package --&gt;
&lt;!-- Wed Mar 15 22:45:53 2017 --&gt;
&lt;table border=&quot;5,&quot; padding=&quot;10,&quot; style=&quot;width=100%&quot;&gt;
&lt;tr&gt;
&lt;th&gt;
ucrank (among girls)
&lt;/th&gt;
&lt;th&gt;
first names (girls)
&lt;/th&gt;
&lt;th&gt;
ucrank (among boys)
&lt;/th&gt;
&lt;th&gt;
first names (boys)
&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align=&quot;center&quot;&gt;
1
&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;
Marie, Sophie
&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;
1
&lt;/td&gt;
&lt;td&gt;
Alexander
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align=&quot;center&quot;&gt;
3
&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;
Charlotte
&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;
2
&lt;/td&gt;
&lt;td&gt;
Paul, Elias
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align=&quot;center&quot;&gt;
4
&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;
Maria, Emilia
&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;
3
&lt;/td&gt;
&lt;td&gt;
Maximilian
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align=&quot;center&quot;&gt;
6
&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;
Anna, Emma, Mia, Sophia
&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;
5
&lt;/td&gt;
&lt;td&gt;
Emil, Noah, Anton, Felix
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align=&quot;center&quot;&gt;
8
&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;
Johanna, Luise
&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;
6
&lt;/td&gt;
&lt;td&gt;
Oskar
&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/center&gt;
&lt;p&gt;
&lt;p&gt;Instead of using the uncertainty corrected ranks, we could instead
have visualized the 90% rank confidence intervals instead (dots denote
the observed ranks):&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;http://staff.math.su.se/hoehle/blog/figure/source/2017-02-06-onomastics/RANKCIPLOT-1.png&quot; style=&quot;display: block; margin: auto;&quot; /&gt;&lt;/p&gt;
&lt;h2 id=&quot;discussion&quot;&gt;Discussion&lt;/h2&gt;
&lt;p&gt;In this post we have used the bootstrap method as a way to assess
uncertainty in ranks. This approach is very general and can be extended
to areas beyond onomastics. No matter the area of application the
approach requires a careful identification of the elements of chance you
want to take into account. In the particular application we decided to
ignore specific uncertainty aspects (e.g. number of babies born) to not
impose further hard-to-verify assumptions. However, as soon as there is
uncertainty, ranks are known to be subject to large variation. Hence, a
different reporting or visualization of the ranks than the point
estimator from the sample is necessary. The use of &lt;em&gt;uncertainty
corrected&lt;/em&gt; ranks is not revolutionary, but it underlines the
importance of uncertainty in the construction of league tables. A more
uncertainty enhancing presentation of ranks in, e.g., data journalism,
is therefore needed.&lt;/p&gt;
&lt;center&gt;
&lt;img
src=&quot;https://openclipart.org/image/300px/svg_to_png/221003/Name-Numer-T-Shirt.png&amp;amp;disposition=attachment&quot; /&gt;
&lt;/enter&gt;
&lt;p&gt;
&lt;/center&gt;
&lt;h2 class=&quot;unnumbered&quot; id=&quot;references&quot;&gt;References&lt;/h2&gt;
&lt;div id=&quot;refs&quot; class=&quot;references csl-bib-body hanging-indent&quot;
data-entry-spacing=&quot;0&quot; role=&quot;list&quot;&gt;
&lt;div id=&quot;ref-davison_hinkley1997&quot; class=&quot;csl-entry&quot; role=&quot;listitem&quot;&gt;
Davison, A. C., and D. V. Hinkley. 1997. &lt;em&gt;Bootstrap Methods and Their
Applications&lt;/em&gt;. Cambridge University Press.
&lt;/div&gt;
&lt;div id=&quot;ref-goldstein_spiegelhalter1996&quot; class=&quot;csl-entry&quot;
role=&quot;listitem&quot;&gt;
Goldstein, H., and D. J. Spiegelhalter. 1996. &lt;span&gt;“League Tables and
Their Limitations: Statistical Issues in Comparisons of Institutional
Performance.”&lt;/span&gt; &lt;em&gt;Journal of the Royal Statistical Society.
Series A (Statistics in Society)&lt;/em&gt; 159 (3): 385–443.
&lt;/div&gt;
&lt;div id=&quot;ref-kahn_bentley2003&quot; class=&quot;csl-entry&quot; role=&quot;listitem&quot;&gt;
Hahn, Matthew W, and Alexander R Bentley. 2003. &lt;span&gt;“Drift as a
Mechanism for Cultural Change: An Example from Baby Names.”&lt;/span&gt;
&lt;em&gt;Proceedings of the Royal Society B: Biological Sciences&lt;/em&gt; 270
(Suppl 1): S120–23. &lt;a
href=&quot;https://doi.org/10.1098/rsbl.2003.0045&quot;&gt;https://doi.org/10.1098/rsbl.2003.0045&lt;/a&gt;.
&lt;/div&gt;
&lt;div id=&quot;ref-jacobsen1999&quot; class=&quot;csl-entry&quot; role=&quot;listitem&quot;&gt;
Jacobsen, R., H. Møller, and A. Mouritsen. 1999. &lt;span&gt;“Natural
Variation in the Human Sex Ratio.”&lt;/span&gt; &lt;em&gt;Human Reproduction&lt;/em&gt; 14
(12): 3120. &lt;a
href=&quot;https://doi.org/10.1093/humrep/14.12.3120&quot;&gt;https://doi.org/10.1093/humrep/14.12.3120&lt;/a&gt;.
&lt;/div&gt;
&lt;div id=&quot;ref-kessler_etal2012&quot; class=&quot;csl-entry&quot; role=&quot;listitem&quot;&gt;
Kessler, David A, Yosi E Maruvka, Jøergen Ouren, and Nadav M Shnerb.
2012. &lt;span&gt;“You Name It –How Memory and Delay Govern First Name
Dynamics.”&lt;/span&gt; Edited by Eshel Ben-Jacob. &lt;em&gt;PLoS ONE&lt;/em&gt; 7 (6):
e38790. &lt;a
href=&quot;https://doi.org/10.1371/journal.pone.0038790&quot;&gt;https://doi.org/10.1371/journal.pone.0038790&lt;/a&gt;.
&lt;/div&gt;
&lt;div id=&quot;ref-opendataberlinNames2016&quot; class=&quot;csl-entry&quot; role=&quot;listitem&quot;&gt;
Landesamt für Bürger- und Ordnungsangelegenheiten Berlin. 2017.
&lt;span&gt;“Liste Der Häufigen Vornamen 2016.”&lt;/span&gt; &lt;a
href=&quot;https://daten.berlin.de/datensaetze/liste-der-häufigen-vornamen-2016&quot;
class=&quot;uri&quot;&gt;https://daten.berlin.de/datensaetze/liste-der-häufigen-vornamen-2016&lt;/a&gt;.
Data published under a CC-BY license.
&lt;/div&gt;
&lt;/div&gt;
</description>
        <pubDate>Mon, 06 Feb 2017 00:00:00 +0100</pubDate>
        <link>https://mhoehle.github.io/blog/2017/02/06/onomastics.html</link>
        <guid isPermaLink="true">https://mhoehle.github.io/blog/2017/02/06/onomastics.html</guid>
        
        <category>rstats</category>
        
        <category>stats</category>
        
        <category>ranks</category>
        
        <category>league table</category>
        
        <category>data journalism</category>
        
        <category>onomastics</category>
        
        
      </item>
    
      <item>
        <title>suRprise! - Classifying Kinder Eggs by Boosting</title>
        <description>&lt;h2 id=&quot;abstract&quot;&gt;Abstract&lt;/h2&gt;
&lt;p&gt;Carrying the Danish tradition of Juleforsøg to the realm of
statistics, we use R to classify the figure content of Kinder Eggs using
boosted classification trees for the egg’s weight and possible rattling
noises.&lt;/p&gt;
&lt;center&gt;
&lt;img src=&quot;/blog/figure/source/2016-12-23-surprise/pics/figures.jpg&quot; /&gt;
&lt;/center&gt;
&lt;p&gt;&lt;br&gt;
&lt;a rel=&quot;license&quot; href=&quot;http://creativecommons.org/licenses/by-sa/4.0/&quot;&gt;&lt;img alt=&quot;Creative Commons License&quot; style=&quot;border-width:0&quot; src=&quot;https://i.creativecommons.org/l/by-sa/4.0/88x31.png&quot;/&gt;&lt;/a&gt;
This work is licensed under a &lt;a rel=&quot;license&quot;
href=&quot;http://creativecommons.org/licenses/by-sa/4.0/&quot;&gt;Creative Commons
Attribution-ShareAlike 4.0 International License&lt;/a&gt;. The
markdown+Rknitr source code of this blog is available under a &lt;a
href=&quot;https://www.gnu.org/licenses/gpl-3.0.html&quot;&gt;GNU General Public
License (GPL v3)&lt;/a&gt; license from github.&lt;/p&gt;
&lt;h2 id=&quot;introduction&quot;&gt;Introduction&lt;/h2&gt;
&lt;p&gt;A &lt;strong&gt;juleforsøg&lt;/strong&gt; is the kind of &lt;a
href=&quot;https://www.youtube.com/watch?v=sinQ06YzbJI8&quot;&gt;exploding
experiment&lt;/a&gt; happening in the last physics or chemistry class before
the Christmas vacation. Not seldomly the teacher, with a look of
secrecy, initializes the class by locking the door mumbling something
like “the headmaster better not see this…”. With Christmas approaching
fast, here is an attempt to create a statistical juleforsøg concluding
the &lt;em&gt;Theory meets practice&lt;/em&gt; 2016 posting season:&lt;/p&gt;
&lt;p&gt;The advertisement campaign of the &lt;a
href=&quot;https://en.wikipedia.org/wiki/Kinder_Surprise&quot;&gt;Kinder Surprise
Eggs&lt;/a&gt; aka. &lt;a href=&quot;https://en.wikipedia.org/wiki/Kinder_Joy&quot;&gt;Kinder
Joy&lt;/a&gt; claims that the content of every 7th egg is a figure (see &lt;a
href=&quot;https://blog.kalaydo.de/blog/wp-content/uploads/2016/05/Biene-Maja.jpg&quot;&gt;example&lt;/a&gt;)
- otherwise they contain toys or puzzles, which positively can be
described as junk. Figures, in particular completed series, on the other
hand, can achieve high &lt;a
href=&quot;https://translate.google.com/translate?sl=de&amp;amp;tl=en&amp;amp;js=y&amp;amp;prev=_t&amp;amp;hl=en&amp;amp;ie=UTF-8&amp;amp;u=https%3A%2F%2Fwww.kalaydo.de%2Fblog%2Fwertvolle-ue-ei-figuren%2F&amp;amp;edit-text=&amp;amp;act=url&quot;&gt;trading
values&lt;/a&gt;. The clear goal is thus to optimize your egg hunting strategy
in order to maximize figure content.&lt;/p&gt;
&lt;h2 id=&quot;the-problem&quot;&gt;The problem&lt;/h2&gt;
&lt;p&gt;Your budget is limited, so the question is which egg to select when
standing in the supermarket?&lt;/p&gt;
&lt;center&gt;
&lt;img
src=&quot;/blog/figure/source/2016-12-23-surprise/pics/inshopwithprice.jpg&quot; /&gt;
&lt;/center&gt;
&lt;p&gt;
&lt;p&gt;Photo: Price in SEK per egg in a Swedish supermarket. The red ellipse
shows the price per kg.&lt;/p&gt;
&lt;h3 id=&quot;various-egg-selection-strategies&quot;&gt;Various egg selection
strategies&lt;/h3&gt;
&lt;p&gt;It goes without saying that brute force purchasing strategies would
be insane. Hence, a number of egg selection strategies can be observed
in real life:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p&gt;The no clue egg enthusiast: Selects an egg at random. With a
certain probability (determined by the producer and the cleverness of
the previous supermarked visitors) the egg contains a figure&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;The egg junkie: knows a good &lt;a
href=&quot;https://www.radiologycafe.com/blog/easter-egg-xray&quot;&gt;radiologist&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;The egg nerd: using &lt;a
href=&quot;https://translate.google.com/translate?sl=de&amp;amp;tl=en&amp;amp;js=y&amp;amp;prev=_t&amp;amp;hl=en&amp;amp;ie=UTF-8&amp;amp;u=http%3A%2F%2Fwww.eierwiki.de%2Findex.php%3Ftitle%3DTipps_%2526_Tricks_beim_Eierkauf&amp;amp;edit-text=&amp;amp;act=url&quot;&gt;scale,
rattling noises and the barcode&lt;/a&gt; he/she quickly determines whether
there is a figure in the egg&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;We shall in this post be interested in &lt;strong&gt;the statistician’s egg
selection approach&lt;/strong&gt;: Egg classification based on weight and
rattling noise using ‘top-notch’ machine learning algorithms - in our
case based on boosted classification trees.&lt;/p&gt;
&lt;h2 id=&quot;data-collection&quot;&gt;Data Collection&lt;/h2&gt;
&lt;p&gt;We collected n=79 eggs of which NA% were figures - the data are
available under a GPL v3.0 license from &lt;a
href=&quot;https://github.com/hoehleatsu/hoehleatsu.github.io/blob/master/figure/source/2016-12-23-surprise/surprise.txt&quot;&gt;github&lt;/a&gt;.
For each egg, we determined its &lt;strong&gt;weight&lt;/strong&gt; as well as the
sound it produced when being shaken. If the sounds could be
characterized as &lt;strong&gt;rattling&lt;/strong&gt; (aka. clattering) this was
indicative of the content consisting of many parts and, hence, unlikely
to be a figure.&lt;/p&gt;
&lt;center&gt;
&lt;img
src=&quot;/blog/figure/source/2016-12-23-surprise/pics/weightandrattle.jpg&quot; /&gt;
&lt;/center&gt;
&lt;p&gt;
&lt;p&gt;Altogether, the first couple of rows of the dataset look as
follows.&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb1&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb1-1&quot;&gt;&lt;a href=&quot;#cb1-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;head&lt;/span&gt;(surprise, &lt;span class=&quot;at&quot;&gt;n=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;5&lt;/span&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;##   weight rattles_fac figure_fac
## 1     32          no         no
## 2     34         yes        yes
## 3     34          no        yes
## 4     30          no         no
## 5     34          no        yes&lt;/code&gt;&lt;/pre&gt;
&lt;h3 id=&quot;descriptive-data-analysis&quot;&gt;Descriptive Data Analysis&lt;/h3&gt;
&lt;p&gt;The fraction of figures in the dataset was 34/79, which is way higher
than the proclaimed 1/7; possibly, because professionals egg collectors
were at work…&lt;/p&gt;
&lt;p&gt;Of the 79 analysed eggs, 54 were categorized as non-rattling. The
probability of such a non-rattling egg really containing a figure was
51.9%. This proportion is not impressive, but could be due to the data
collector’s having a different understanding of exactly how the variable
&lt;em&gt;rattling&lt;/em&gt; was to be interpreted: Does it &lt;em&gt;rattle&lt;/em&gt;, or
does it &lt;em&gt;rattle like a figure&lt;/em&gt;? In hindsight, a clearer
definition and communication of this variable would have prevented
ambiguity in the collection.&lt;/p&gt;
&lt;p&gt;A descriptive plot of the weight distribution of eggs with and
without figure content shows, that eggs with figures tend to be slightly
heavier:&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/blog/figure/source/2016-12-23-surprise/WEIGHTPLOT-1.png&quot; style=&quot;display: block; margin: auto;&quot; /&gt;
Note: The first approximately 50% of the eggs were weighted on a
standard supermarket scales, which showed the resulting weight in even
steps of 2g only.&lt;/p&gt;
&lt;p&gt;Below the proportion (in %) of eggs with figure content per observed
weight:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;##           weight
## figure_fac    26    28    29    30    31    32    33    34    35    36    40
##        no  100.0  50.0  66.7  53.3  71.4  72.7  75.0  25.0 100.0  33.3   0.0
##        yes   0.0  50.0  33.3  46.7  28.6  27.3  25.0  75.0   0.0  66.7 100.0&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;A simple selection rule based on weight would be to weigh eggs until
you hit a 40g egg. A slightly less certain stopping rule would be to
pick 34g eggs. However, modern statistics is more than counting and
analysing proportions!&lt;/p&gt;
&lt;h2 id=&quot;machine-learning-the-egg-content&quot;&gt;Machine Learning the Egg
Content&lt;/h2&gt;
&lt;p&gt;We use machine learning algorithms to solve the binary classification
problem at hand. In particular, we use the &lt;code&gt;caret&lt;/code&gt; package
&lt;span class=&quot;citation&quot; data-cites=&quot;caret&quot;&gt;(Kuhn 2016)&lt;/span&gt; and
classify figure content using boosted classification trees as
implemented in the &lt;a
href=&quot;https://en.wikipedia.org/wiki/Xgboost&quot;&gt;&lt;code&gt;xgboost&lt;/code&gt;&lt;/a&gt;
package &lt;span class=&quot;citation&quot; data-cites=&quot;xgboost&quot;&gt;(Chen et al.
2016)&lt;/span&gt;. Details on how to use the &lt;code&gt;caret&lt;/code&gt; package can,
e.g., be found in the following &lt;a
href=&quot;https://topepo.github.io/caret/index.html&quot;&gt;tutorial&lt;/a&gt;.&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb4&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb4-1&quot;&gt;&lt;a href=&quot;#cb4-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;library&lt;/span&gt;(caret)&lt;/span&gt;
&lt;span id=&quot;cb4-2&quot;&gt;&lt;a href=&quot;#cb4-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-3&quot;&gt;&lt;a href=&quot;#cb4-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##Grid with xgboost hyperparameters&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-4&quot;&gt;&lt;a href=&quot;#cb4-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;xgb_hyperparam_grid &lt;span class=&quot;ot&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;expand.grid&lt;/span&gt;(&lt;/span&gt;
&lt;span id=&quot;cb4-5&quot;&gt;&lt;a href=&quot;#cb4-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;at&quot;&gt;nrounds =&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;c&lt;/span&gt;(&lt;span class=&quot;dv&quot;&gt;25&lt;/span&gt;, &lt;span class=&quot;dv&quot;&gt;50&lt;/span&gt;, &lt;span class=&quot;dv&quot;&gt;100&lt;/span&gt;, &lt;span class=&quot;dv&quot;&gt;250&lt;/span&gt;, &lt;span class=&quot;dv&quot;&gt;1000&lt;/span&gt;),&lt;/span&gt;
&lt;span id=&quot;cb4-6&quot;&gt;&lt;a href=&quot;#cb4-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;at&quot;&gt;eta =&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;c&lt;/span&gt;(&lt;span class=&quot;fl&quot;&gt;0.01&lt;/span&gt;, &lt;span class=&quot;fl&quot;&gt;0.001&lt;/span&gt;, &lt;span class=&quot;fl&quot;&gt;0.0001&lt;/span&gt;),&lt;/span&gt;
&lt;span id=&quot;cb4-7&quot;&gt;&lt;a href=&quot;#cb4-7&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;at&quot;&gt;max_depth =&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;seq&lt;/span&gt;(&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;,&lt;span class=&quot;dv&quot;&gt;16&lt;/span&gt;,&lt;span class=&quot;at&quot;&gt;by=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;),&lt;/span&gt;
&lt;span id=&quot;cb4-8&quot;&gt;&lt;a href=&quot;#cb4-8&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;at&quot;&gt;subsample =&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;c&lt;/span&gt;(&lt;span class=&quot;fl&quot;&gt;0.4&lt;/span&gt;,&lt;span class=&quot;fl&quot;&gt;0.5&lt;/span&gt;,&lt;span class=&quot;fl&quot;&gt;0.6&lt;/span&gt;),&lt;/span&gt;
&lt;span id=&quot;cb4-9&quot;&gt;&lt;a href=&quot;#cb4-9&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;at&quot;&gt;gamma =&lt;/span&gt; &lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;, &lt;span class=&quot;at&quot;&gt;colsample_bytree =&lt;/span&gt; &lt;span class=&quot;fl&quot;&gt;0.8&lt;/span&gt;, &lt;span class=&quot;at&quot;&gt;min_child_weight =&lt;/span&gt; &lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-10&quot;&gt;&lt;a href=&quot;#cb4-10&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;)&lt;/span&gt;
&lt;span id=&quot;cb4-11&quot;&gt;&lt;a href=&quot;#cb4-11&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##caret training control object&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-12&quot;&gt;&lt;a href=&quot;#cb4-12&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;control &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;trainControl&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;method=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;repeatedcv&amp;quot;&lt;/span&gt;, &lt;span class=&quot;at&quot;&gt;number=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;8&lt;/span&gt;, &lt;span class=&quot;at&quot;&gt;repeats=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;8&lt;/span&gt;, &lt;span class=&quot;at&quot;&gt;classProbs=&lt;/span&gt;&lt;span class=&quot;cn&quot;&gt;TRUE&lt;/span&gt;,&lt;/span&gt;
&lt;span id=&quot;cb4-13&quot;&gt;&lt;a href=&quot;#cb4-13&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;                        &lt;span class=&quot;at&quot;&gt;summaryFunction =&lt;/span&gt; twoClassSummary, &lt;span class=&quot;at&quot;&gt;allowParallel=&lt;/span&gt;&lt;span class=&quot;cn&quot;&gt;TRUE&lt;/span&gt;)&lt;/span&gt;
&lt;span id=&quot;cb4-14&quot;&gt;&lt;a href=&quot;#cb4-14&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##train away and do it parallelized on 3 cores...&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-15&quot;&gt;&lt;a href=&quot;#cb4-15&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;library&lt;/span&gt;(doMC)&lt;/span&gt;
&lt;span id=&quot;cb4-16&quot;&gt;&lt;a href=&quot;#cb4-16&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;registerDoMC&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;cores =&lt;/span&gt; &lt;span class=&quot;dv&quot;&gt;3&lt;/span&gt;)&lt;/span&gt;
&lt;span id=&quot;cb4-17&quot;&gt;&lt;a href=&quot;#cb4-17&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;m_xgb &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;train&lt;/span&gt;( figure_fac &lt;span class=&quot;sc&quot;&gt;~&lt;/span&gt; weight &lt;span class=&quot;sc&quot;&gt;*&lt;/span&gt; rattles_fac, &lt;span class=&quot;at&quot;&gt;data=&lt;/span&gt;surprise, &lt;span class=&quot;at&quot;&gt;method=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;xgbTree&amp;quot;&lt;/span&gt;,&lt;/span&gt;
&lt;span id=&quot;cb4-18&quot;&gt;&lt;a href=&quot;#cb4-18&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;               &lt;span class=&quot;at&quot;&gt;trControl=&lt;/span&gt;control, &lt;span class=&quot;at&quot;&gt;verbose=&lt;/span&gt;&lt;span class=&quot;cn&quot;&gt;FALSE&lt;/span&gt;, &lt;span class=&quot;at&quot;&gt;metric=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;ROC&amp;quot;&lt;/span&gt;, &lt;span class=&quot;at&quot;&gt;tuneGrid=&lt;/span&gt;xgb_hyperparam_grid)&lt;/span&gt;
&lt;span id=&quot;cb4-19&quot;&gt;&lt;a href=&quot;#cb4-19&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##look at the result&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-20&quot;&gt;&lt;a href=&quot;#cb4-20&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;m_xgb&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;## eXtreme Gradient Boosting  
##   
##  79 samples 
##   2 predictor 
##   2 classes: &amp;#39;no&amp;#39;, &amp;#39;yes&amp;#39;  
##   
##  No pre-processing 
##  Resampling: Cross-Validated (8 fold, repeated 8 times)  
##  Summary of sample sizes: 69, 69, 69, 69, 70, 69, ...  
##  Resampling results across tuning parameters: 
##   
##    eta    max_depth  subsample  nrounds  ROC        Sens       Spec      
##    1e-04   2         0.4          25     0.6696875  0.8739583  0.3539062 
##    1e-04   2         0.4          50     0.6863021  0.8776042  0.3609375 
##    1e-04   2         0.4         100     0.6693229  0.8687500  0.3687500 
##    ...  ...        ... 
##    1e-02  16         0.6         250     0.6807552  0.8557292  0.3695312 
##    1e-02  16         0.6        1000     0.6678255  0.7859375  0.3976562 
##   
##  Tuning parameter &amp;#39;gamma&amp;#39; was held constant at a value of 1 
##  Tuning 
##   parameter &amp;#39;colsample_bytree&amp;#39; was held constant at a value of 0.8 
##  Tuning 
##   parameter &amp;#39;min_child_weight&amp;#39; was held constant at a value of 1 
##  ROC was used to select the optimal model using the largest value. 
##  The final values used for the model were nrounds = 50, max_depth = 2, eta = 0.01, gamma 
##   = 1, colsample_bytree = 0.8, min_child_weight = 1 and subsample = 0.5.&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;The average AUC for the 64 resamples is 0.69. Average sensitivity and
specificity are 86.4% and 39.6%, respectively. This shows that
predicting figure content with the available data is better than simply
picking an egg at random, but no figure-guaranteeing strategy appears
possible on a per-egg basis.&lt;/p&gt;
&lt;h3 id=&quot;predicting-the-content-of-a-particular-egg&quot;&gt;Predicting the
Content of a Particular Egg&lt;/h3&gt;
&lt;p&gt;Suppose the egg you look at weighs 36g and, when shaken, sounds like
a lot of small parts being moved. In other words:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb6&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb6-1&quot;&gt;&lt;a href=&quot;#cb6-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;predict&lt;/span&gt;(m_xgb, &lt;span class=&quot;at&quot;&gt;newdata =&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;data.frame&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;weight=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;36&lt;/span&gt;, &lt;span class=&quot;at&quot;&gt;rattles_fac=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;yes&amp;quot;&lt;/span&gt;),&lt;span class=&quot;at&quot;&gt;type=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;prob&amp;quot;&lt;/span&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;##          no       yes
## 1 0.4998078 0.5001922&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Despite the rattling noises, the classifier thinks that it’s slightly
more likely that the content is a figure. However, when we opened this
particular egg:&lt;/p&gt;
&lt;center&gt;
&lt;img src=&quot;/blog/figure/source/2016-12-23-surprise/pics/car.jpg&quot; /&gt;
&lt;/center&gt;
&lt;p&gt;
&lt;p&gt;…a car. Definitely not a figure! The proof of concept disappointment
was, however, quickly counteracted by the surrounding chocolate…&lt;/p&gt;
&lt;p&gt;As a standard operating procedure for your optimized future
supermarket hunt, below are shown the classifier’s predicted
probabilities for figure content as a function of egg weight and the
&lt;code&gt;rattles_fac&lt;/code&gt; variable.&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/blog/figure/source/2016-12-23-surprise/CLASSIFIEROUTPUT-1.png&quot; style=&quot;display: block; margin: auto;&quot; /&gt;&lt;/p&gt;
&lt;h2 id=&quot;discussion&quot;&gt;Discussion&lt;/h2&gt;
&lt;p&gt;The present post only discusses the optimal selection on a per-egg
basis. One could weight &amp;amp; shake several eggs and then select the one
with the highest predicted probability for containing a figure. Future
research is needed to solve this sequential decision making problem in
an &lt;a
href=&quot;http://staff.math.su.se/hoehle/blog/2016/06/12/optimalChoice.html&quot;&gt;optimal
way&lt;/a&gt;.&lt;/p&gt;
&lt;h3 id=&quot;outlook&quot;&gt;Outlook&lt;/h3&gt;
&lt;p&gt;We have retained a validation sample of 10 eggs and are willing to
send an unconsumed 11th element of the sample to whoever obtains the
best score on this validation sample. Anyone who knows how to upload
this to &lt;a href=&quot;https://www.kaggle.com&quot;&gt;kaggle&lt;/a&gt;?&lt;/p&gt;
&lt;center&gt;
We wish all readers &lt;em&gt;God jul&lt;/em&gt; and a happy new year!
&lt;/center&gt;
&lt;p&gt;
&lt;h2 id=&quot;acknowledgments&quot;&gt;Acknowledgments&lt;/h2&gt;
&lt;p&gt;Thanks to former colleagues at the Department of Statistics,
University of Munich, as well as numerous statistics students in Munich
and Stockholm, for contributing to the data collection. In particular we
thank Alexander Jerak for his idea of optimizing figure hunting in a
data driven way more than 10 years ago.&lt;/p&gt;
&lt;h2 class=&quot;unnumbered&quot; id=&quot;literature&quot;&gt;Literature&lt;/h2&gt;
&lt;div id=&quot;refs&quot; class=&quot;references csl-bib-body hanging-indent&quot;
data-entry-spacing=&quot;0&quot; role=&quot;list&quot;&gt;
&lt;div id=&quot;ref-xgboost&quot; class=&quot;csl-entry&quot; role=&quot;listitem&quot;&gt;
Chen, Tianqi, Tong He, Michael Benesty, Vadim Khotilovich, and Yuan
Tang. 2016. &lt;em&gt;Xgboost: Extreme Gradient Boosting&lt;/em&gt;. &lt;a
href=&quot;https://CRAN.R-project.org/package=xgboost&quot;&gt;https://CRAN.R-project.org/package=xgboost&lt;/a&gt;.
&lt;/div&gt;
&lt;div id=&quot;ref-caret&quot; class=&quot;csl-entry&quot; role=&quot;listitem&quot;&gt;
Kuhn, Max. 2016. &lt;em&gt;Caret: Classification and Regression Training&lt;/em&gt;.
&lt;a
href=&quot;https://CRAN.R-project.org/package=caret&quot;&gt;https://CRAN.R-project.org/package=caret&lt;/a&gt;.
&lt;/div&gt;
&lt;/div&gt;
</description>
        <pubDate>Fri, 23 Dec 2016 00:00:00 +0100</pubDate>
        <link>https://mhoehle.github.io/blog/2016/12/23/surprise.html</link>
        <guid isPermaLink="true">https://mhoehle.github.io/blog/2016/12/23/surprise.html</guid>
        
        <category>rstats</category>
        
        <category>stats</category>
        
        <category>programming</category>
        
        <category>juleforsøg</category>
        
        <category>classification</category>
        
        
      </item>
    
      <item>
        <title>4x3 R-Hackathoning - The Finisher&apos;s Guide</title>
        <description>&lt;h2 id=&quot;abstract&quot;&gt;Abstract&lt;/h2&gt;
&lt;p&gt;We present experiences from organizing a small R hackathon aimed at
advancing knowledge and documentation of the R package surveillance. The
hackathon was piggybacked on the ESCAIDE2016 conference visited by
current and potential package users in the area of infectious disease
epidemiology. The output of the hackathon is available at &lt;a
href=&quot;https://surveillancer.github.io/tutorials/&quot;&gt;https://surveillancer.github.io/tutorials/&lt;/a&gt;.&lt;/p&gt;
&lt;center&gt;
&lt;img src=&quot;/blog/figure/source/2016-12-12-hackinthedark/ears-1.png&quot; /&gt;
&lt;/center&gt;
&lt;p&gt;&lt;br&gt;
&lt;a rel=&quot;license&quot; href=&quot;http://creativecommons.org/licenses/by-sa/4.0/&quot;&gt;&lt;img alt=&quot;Creative Commons License&quot; style=&quot;border-width:0&quot; src=&quot;https://i.creativecommons.org/l/by-sa/4.0/88x31.png&quot;/&gt;&lt;/a&gt;
This work is licensed under a &lt;a rel=&quot;license&quot;
href=&quot;http://creativecommons.org/licenses/by-sa/4.0/&quot;&gt;Creative Commons
Attribution-ShareAlike 4.0 International License&lt;/a&gt;. The
markdown+Rknitr source code of this blog is available under a &lt;a
href=&quot;https://www.gnu.org/licenses/gpl-3.0.html&quot;&gt;GNU General Public
License (GPL v3)&lt;/a&gt; license from github.&lt;/p&gt;
&lt;h2 id=&quot;introduction&quot;&gt;Introduction&lt;/h2&gt;
&lt;p&gt;A &lt;strong&gt;&lt;a
href=&quot;https://en.wikipedia.org/wiki/Hackathon&quot;&gt;hackathon&lt;/a&gt;&lt;/strong&gt; is
a extreme-programming sprint-like event where people involved in
software development (and beyond) meet for a short period of time with
the purpose of collaborative programming, typically in the context of
&lt;strong&gt;&lt;a
href=&quot;https://en.wikipedia.org/wiki/Open-source_software&quot;&gt;open-source
software&lt;/a&gt;&lt;/strong&gt;. The word hackathon is a merger of
&lt;strong&gt;hack&lt;/strong&gt; and &lt;strong&gt;marathon&lt;/strong&gt;, where &lt;a
href=&quot;http://www.dictionary.com/browse/hack&quot;&gt;&lt;em&gt;hacking&lt;/em&gt;&lt;/a&gt; is to
be understood as the skillful modification of computer programs (and not
the malicious circumvention of security measures). Lots of good guides
have been written on &lt;a href=&quot;https://hackathon.guide/&quot;&gt;how to run a
successful Hackathon&lt;/a&gt;. In the area of &lt;strong&gt;infectious disease
epidemiology&lt;/strong&gt;, which has been the main area of motivation for
our statistical developments and implementations, very successful events
(&lt;a href=&quot;https://sites.google.com/site/hackoutwiki/home&quot;&gt;hackout&lt;/a&gt;,
&lt;a href=&quot;https://sites.google.com/site/hackout2/&quot;&gt;hackout2&lt;/a&gt;, &lt;a
href=&quot;http://hackout3.ropensci.org/&quot;&gt;hackout3&lt;/a&gt;) have previously been
organized. At a much smaller scale we wanted to ignite the energy and
enthusiasm such an event spawns.&lt;/p&gt;
&lt;p&gt;As a consequence, this blog post gathers our experiences from
organising a small &lt;strong&gt;4x3 hackathon&lt;/strong&gt; (4 people, 3 days) for
the surveillance R-package in connection with the &lt;a
href=&quot;http://ecdc.europa.eu/en/escaide/Pages/ESCAIDE.aspx&quot;&gt;ESCAIDE2016&lt;/a&gt;
conference in November 2016. Our hope is that these experiences might be
useful for others - even if working in very different contexts.&lt;/p&gt;
&lt;h2 id=&quot;organizing-and-running-the-hackathon&quot;&gt;Organizing and Running the
Hackathon&lt;/h2&gt;
&lt;p&gt;We report on a number of practical “?” and “!” below.&lt;/p&gt;
&lt;h3 id=&quot;why&quot;&gt;Why?&lt;/h3&gt;
&lt;p&gt;Over the last several years we worked on a package for the
visualization, modelling and monitoring of surveillance time series. As
most of us are busy with other tasks now, it felt like a good idea to
all meet in person to work a little on the package and network with
potential users in order to increase awareness of the package. The 10’th
European Scientific Conference on Applied Infectious Disease
Epidemiology (&lt;a
href=&quot;http://ecdc.europa.eu/en/escaide/Pages/ESCAIDE.aspx&quot;&gt;ESCAIDE2016&lt;/a&gt;)
organized by the &lt;a href=&quot;http://ecdc.europa.eu&quot;&gt;European Centre for
Disease Prevention and Control&lt;/a&gt; (ECDC) in Stockholm, Sweden, 28-30
Nov 2016, with its about 600 participants, felt like the right place to
be.&lt;/p&gt;
&lt;h3 id=&quot;a-cool-name&quot;&gt;A Cool Name?&lt;/h3&gt;
&lt;p&gt;Stockholm is placed on the 59th parallel north, hence, during end of
November daylight is limited to approximately &lt;a
href=&quot;http://www.timeanddate.com/sun/sweden/stockholm&quot;&gt;6:30 hours&lt;/a&gt;.
In other words: Perfect hacking conditions. In order to honour this,
&lt;strong&gt;Hack in the Dark&lt;/strong&gt; became our internal handle for the
hackathon.&lt;/p&gt;
&lt;h3 id=&quot;who&quot;&gt;Who?&lt;/h3&gt;
&lt;p&gt;Hackathons come in all sizes. We decided on a mini four person
hackathon of experienced R users, who all knew the package well: two
former Ph.D. students who had used the package as the implementational
repository for their methodological developments (one of them now being
the package maintainer), a former power-user of the package and the
package creator. Alternatively, we could have involved new persons in
order to expand awareness of the package and increase diversity of the
hackathonians, but we decided to go for the small team in order to
maximize efficiency.&lt;/p&gt;
&lt;h3 id=&quot;venue&quot;&gt;Venue?&lt;/h3&gt;
&lt;p&gt;Piggybacking on an existing conference held in a large conference
centre meant we did not have to worry about WLAN, food and seating.
Especially when only being 4 persons.&lt;/p&gt;
&lt;h3 id=&quot;what-to-do&quot;&gt;What to do?&lt;/h3&gt;
&lt;p&gt;We started about 8 weeks before the hackathon to brainstorm using &lt;a
href=&quot;https://slack.com/&quot;&gt;slack&lt;/a&gt; as a messaging system. We then
created a priority matrix in &lt;a href=&quot;http://docs.google.com&quot;&gt;google
docs&lt;/a&gt; allowing each of the participants to prioritize the ideas. This
gave us an initial idea of what we wanted to do. Unfortunately, most of
us then got pretty busy with other activities so we never managed to
revisit the matrix until a couple of days before the start of the
hackathon. Instead, we recapitulated matters in an “indian buffet
process” meeting in Stockholm at the night before the hackathon:&lt;/p&gt;
&lt;ol type=&quot;1&quot;&gt;
&lt;li&gt;Write i/o tutorials explaining how to get data into the package and
then use package functions for cool visualizations of the data&lt;/li&gt;
&lt;li&gt;Use open European data for the tutorials - the theme of ESCAIDE2016
was after all: &lt;strong&gt;Data for action&lt;/strong&gt;&lt;/li&gt;
&lt;li&gt;Make a &lt;a href=&quot;https://shiny.rstudio.com/&quot;&gt;shiny app&lt;/a&gt; to
visualize the effect of various parameters choices for the surveillance
algorithms implemented in the package. The best choice of configuration
has been a recurrent user question throughout the years.&lt;/li&gt;
&lt;li&gt;Demo twitter surveillance by monitoring the conference hashtag
&lt;code&gt;#ESCAIDE2016&lt;/code&gt;.&lt;/li&gt;
&lt;/ol&gt;
&lt;h3 id=&quot;source-code-management&quot;&gt;Source Code Management?&lt;/h3&gt;
&lt;p&gt;We chose to create an organization &lt;strong&gt;surveillancer&lt;/strong&gt; on
&lt;a href=&quot;http://www.github.com&quot;&gt;github&lt;/a&gt;, which we then all joined
with our individual github accounts. All new projects were then
conducted by initiating new repositories. The &lt;code&gt;surveillance&lt;/code&gt;
package itself is still developed on &lt;a
href=&quot;http://www.r-forge.r-project.org&quot;&gt;R-Forge&lt;/a&gt; using
&lt;code&gt;svn&lt;/code&gt;, but since we knew most of our work would be
&lt;em&gt;using&lt;/em&gt; the surveillance package rather than &lt;em&gt;developing&lt;/em&gt;
the package, we decided to keep the existing infrastructure for the
package and instead develop the planned tutorials and visualizations in
a new github project. This worked ok, but switching between
&lt;code&gt;svn&lt;/code&gt; and &lt;code&gt;git&lt;/code&gt; for commits on different projects
was not always helpful: &lt;code&gt;git commit -a&lt;/code&gt; is a useful friend if
you don’t know the &lt;a href=&quot;https://githowto.com/staging_changes&quot;&gt;git
staging area&lt;/a&gt;…&lt;/p&gt;
&lt;h3 id=&quot;project-output-format&quot;&gt;Project Output Format?&lt;/h3&gt;
&lt;p&gt;We decided to create an R package and then use Hadley Wickham’s new
&lt;a href=&quot;https://hadley.github.io/pkgdown/&quot;&gt;pkgdown&lt;/a&gt; package to
create a website containing all hackathon output. The above specified
tutorials were then created as vignettes. An immediate advantage of this
approach was that all hackathon output was bundled and that vignette
code was directly available for the interested user.&lt;/p&gt;
&lt;h3 id=&quot;demo-demo-demo&quot;&gt;Demo, demo, demo!&lt;/h3&gt;
&lt;p&gt;Inspired by the extreme programming paradigm, and because we wanted
to interact with the conference, we decided to demo at least once a day
by posting hackathon output on twitter. Besides the outgoing publicity
we also frequently demo’ed internally in order to get input and
suggestions. This worked pretty well - there is nothing as motivating
and interactive as getting constructive input and suggestions from your
table neighbour!&lt;/p&gt;
&lt;p&gt;Interaction with the other conference participants, on the other
hand, was moderate. We showed parts and pieces to interested people, but
in hindsight we should have aimed for a poster presentation or a related
activity in order to generate more real-life awareness of the hackathon
outside the virtual world of twitter.&lt;/p&gt;
&lt;h2 id=&quot;summing-up&quot;&gt;Summing Up&lt;/h2&gt;
&lt;p&gt;The three days of hackathon passed quickly, but we managed to get the
four formulated outputs done.&lt;/p&gt;
&lt;p&gt;Intense software sprints are hard work, thus, it was natural that
towards the end of the hackathon the concentration decreased slightly.
However, phases of intense coding are perfectly supplemented by
listening to scientific talks, talking to former colleagues visting the
conference or sharing the passion of R with others working in the field.
In particular it was nice to exchange ideas with &lt;a
href=&quot;http://www.imperial.ac.uk/people/t.jombart&quot;&gt;Thibaut Jombart&lt;/a&gt;,
whose &lt;a href=&quot;http://www.repidemicsconsortium.org/&quot;&gt;R Epidemics
Consortium (RECON)&lt;/a&gt; project hopefully is able to bundle the R
initiatives in infectious disease epidemiology a little. Besides the
availability of software, the training aspect of new users (e.g. trainee
epidemiologists) is also crucial. Finally, the
&lt;strong&gt;aftermath&lt;/strong&gt; of the hackathon is as important as the
pre-event planning: dedicated coordinators have to ensure that loose
ends are wrapped up. Here, the participants’ enthusiasm declines quickly
as other activities become higher priorities. Again, it’s essential to
have a clear goal of what needs to be done (e.g. a blog entry…).&lt;/p&gt;
&lt;p&gt;Altogether, code sessions such as a &lt;a
href=&quot;http://staff.math.su.se/hoehle/blog/2016/08/04/outbreakEnd.html&quot;&gt;reproducibility
session&lt;/a&gt; or a &lt;strong&gt;toolbox session&lt;/strong&gt; could be components
for spicing up scientific conferences. For example the toolbox event
could consist of a set of interested people, who on conference day 1
decide to implement a particular method useful in practice, and then
demo it on the last day. Obviously, all these suggestions take time away
from other conference content and certainly are more stressful than
dozing of in the plenary sessions…&lt;/p&gt;
&lt;p&gt;No matter what, focus of a hackathon should also be on social
aspects. It also proves wise not to ignore fresh air &amp;amp; sunlight
completely. To our surprise, the 6:30 hours of daylight were at times
actually quite sunny in Stockholm!&lt;/p&gt;
&lt;h3 id=&quot;visit-the-hack-in-the-dark-output&quot;&gt;Visit the Hack in the Dark
Output&lt;/h3&gt;
&lt;p&gt;The output of the hackathon can be found here:&lt;/p&gt;
&lt;center&gt;
&lt;a
href=&quot;https://surveillancer.github.io/tutorials/&quot;&gt;https://surveillancer.github.io/tutorials/&lt;/a&gt;
&lt;/center&gt;
&lt;p&gt;
&lt;p&gt;In order to run the accompanying code (available from github by
clicking on the “fork me on github” icons), version 1.13.0 of the
&lt;code&gt;surveillance&lt;/code&gt; package is needed (available from CRAN). As an
appetizer to check out the hackathon &lt;a
href=&quot;https://surveillancer.github.io/tutorials/&quot;&gt;site&lt;/a&gt; or the &lt;a
href=&quot;https://github.com/surveillancer/tutorials&quot;&gt;code&lt;/a&gt;, here are two
of our tweets demoing output during the event:&lt;/p&gt;
&lt;blockquote class=&quot;twitter-tweet&quot; data-lang=&quot;en&quot;&gt;
&lt;p lang=&quot;en&quot; dir=&quot;ltr&quot;&gt;
First draft output of the
&lt;a href=&quot;https://twitter.com/hashtag/ESCAIDE2016?src=hash&quot;&gt;#ESCAIDE2016&lt;/a&gt;
surveillance
&lt;a href=&quot;https://twitter.com/hashtag/rstats?src=hash&quot;&gt;#rstats&lt;/a&gt;
hackathon: Visualizing
&lt;a href=&quot;https://twitter.com/hashtag/opendata?src=hash&quot;&gt;#opendata&lt;/a&gt; by
&lt;a href=&quot;https://twitter.com/ECDC_EU&quot;&gt;&lt;span class=&quot;citation&quot;
data-cites=&quot;ECDC_EU&quot;&gt;(&lt;strong&gt;ECDC_EU?&lt;/strong&gt;)&lt;/span&gt;&lt;/a&gt; on
Salmonella Agona.
&lt;a href=&quot;https://twitter.com/hashtag/data4action?src=hash&quot;&gt;#data4action&lt;/a&gt;
&lt;a href=&quot;https://t.co/8ApaDNF07L&quot;&gt;pic.twitter.com/8ApaDNF07L&lt;/a&gt;
&lt;/p&gt;
— Michael Höhle (@m_hoehle)
&lt;a href=&quot;https://twitter.com/m_hoehle/status/803270577150631937&quot;&gt;November
28, 2016&lt;/a&gt;
&lt;/blockquote&gt;
&lt;script async src=&quot;//platform.twitter.com/widgets.js&quot; charset=&quot;utf-8&quot;&gt;&lt;/script&gt;
&lt;blockquote class=&quot;twitter-tweet&quot; data-lang=&quot;en&quot;&gt;
&lt;p lang=&quot;en&quot; dir=&quot;ltr&quot;&gt;
Interactive illustration of monitoring algorithms for infectious disease
surveillance
&lt;a href=&quot;https://twitter.com/hashtag/escaide2016?src=hash&quot;&gt;#escaide2016&lt;/a&gt;
&lt;a href=&quot;https://twitter.com/hashtag/rstats?src=hash&quot;&gt;#rstats&lt;/a&gt;
&lt;a href=&quot;https://t.co/qizcqqMbEJ&quot;&gt;https://t.co/qizcqqMbEJ&lt;/a&gt;
&lt;a href=&quot;https://t.co/LyZujDLsF2&quot;&gt;pic.twitter.com/LyZujDLsF2&lt;/a&gt;
&lt;/p&gt;
— Dirk Schumacher (@dirk_sch)
&lt;a href=&quot;https://twitter.com/dirk_sch/status/803573405660286976&quot;&gt;November
29, 2016&lt;/a&gt;
&lt;/blockquote&gt;
&lt;script async src=&quot;//platform.twitter.com/widgets.js&quot; charset=&quot;utf-8&quot;&gt;&lt;/script&gt;
&lt;h3 id=&quot;the-future&quot;&gt;The Future&lt;/h3&gt;
&lt;p&gt;We wish you all the best for your own hackathon event. Put software
on the scientific agenda!&lt;/p&gt;
&lt;h2 id=&quot;acknowledgments&quot;&gt;Acknowledgments&lt;/h2&gt;
&lt;p&gt;Thanks to &lt;a href=&quot;http://www.masalmon.eu/&quot;&gt;Maëlle Salmon&lt;/a&gt;, &lt;a
href=&quot;https://www.dirk-schumacher.net/&quot;&gt;Dirk Schumacher&lt;/a&gt; and &lt;a
href=&quot;http://www.imbe.med.uni-erlangen.de/cms/sebastian_meyer.html&quot;&gt;Sebastian
Meyer&lt;/a&gt; for all their great work and the creative atmosphere during
the hackathon! The event was implicitly supported by the Swedish
Research Council as part of the project Statistical Modelling,
Monitoring and Predictive Analytics against Infectious Disease Outbreaks
(grant number 2015-05182_VR).&lt;/p&gt;
</description>
        <pubDate>Mon, 12 Dec 2016 00:00:00 +0100</pubDate>
        <link>https://mhoehle.github.io/blog/2016/12/12/hackinthedark.html</link>
        <guid isPermaLink="true">https://mhoehle.github.io/blog/2016/12/12/hackinthedark.html</guid>
        
        <category>rstats</category>
        
        <category>stats</category>
        
        <category>programming</category>
        
        
      </item>
    
      <item>
        <title>Better Confidence Intervals for Quantiles</title>
        <description>&lt;p&gt;&lt;span class=&quot;math display&quot;&gt;\[
\newcommand{\bm}[1]{\boldsymbol{\mathbf{#1}}}
\DeclareMathOperator*{\argmin}{arg\,min}
\DeclareMathOperator*{\argmax}{arg\,max}
\]&lt;/span&gt;&lt;/p&gt;
&lt;h2 id=&quot;abstract&quot;&gt;Abstract&lt;/h2&gt;
&lt;p&gt;We discuss the computation of confidence intervals for the median or
any other quantile in R. In particular we are interested in the
interpolated order statistic approach suggested by &lt;span
class=&quot;citation&quot; data-cites=&quot;hettmansperger_sheather1986&quot;&gt;Hettmansperger
and Sheather (1986)&lt;/span&gt; and &lt;span class=&quot;citation&quot;
data-cites=&quot;nyblom1992&quot;&gt;Nyblom (1992)&lt;/span&gt;. In order to make the
methods available to a greater audience we provide an implementation of
these methods in the R package &lt;code&gt;quantileCI&lt;/code&gt; and a small
simulation study is conducted to show that these intervals indeed have a
very good coverage. The study also shows that these intervals perform
better than the currently available approaches in R. We therefore
propose that these intervals should be used more in the future!&lt;/p&gt;
&lt;center&gt;
&lt;img
src=&quot;/blog/figure/source/2016-10-23-quantileCI/FIRSTPICTURE-1.png&quot; /&gt;
&lt;/center&gt;
&lt;p&gt;&lt;br&gt;
&lt;a rel=&quot;license&quot; href=&quot;http://creativecommons.org/licenses/by-sa/4.0/&quot;&gt;&lt;img alt=&quot;Creative Commons License&quot; style=&quot;border-width:0&quot; src=&quot;https://i.creativecommons.org/l/by-sa/4.0/88x31.png&quot;/&gt;&lt;/a&gt;
This work is licensed under a &lt;a rel=&quot;license&quot;
href=&quot;http://creativecommons.org/licenses/by-sa/4.0/&quot;&gt;Creative Commons
Attribution-ShareAlike 4.0 International License&lt;/a&gt;. The
markdown+Rknitr source code of this blog is available under a &lt;a
href=&quot;https://www.gnu.org/licenses/gpl-3.0.html&quot;&gt;GNU General Public
License (GPL v3)&lt;/a&gt; license from github.&lt;/p&gt;
&lt;h2 id=&quot;introduction&quot;&gt;Introduction&lt;/h2&gt;
&lt;p&gt;Statistics 101 teaches that for a distribution, possibly contaminated
with outliers, a robust measure of the central tendency is the median.
Not knowing this fact can make your analysis worthy to report in the &lt;a
href=&quot;http://www.sueddeutsche.de/wirtschaft/heilbronn-dieser-mann-ist-so-reich-dass-statistiken-seines-wohnorts-wertlos-sind-1.2705044&quot;&gt;newspaper&lt;/a&gt;
(&lt;a
href=&quot;https://translate.google.com/translate?sl=de&amp;amp;tl=en&amp;amp;js=y&amp;amp;prev=_t&amp;amp;hl=en&amp;amp;ie=UTF-8&amp;amp;u=http%3A%2F%2Fwww.sueddeutsche.de%2Fwirtschaft%2Fheilbronn-dieser-mann-ist-so-reich-dass-statistiken-seines-wohnorts-wertlos-sind-1.2705044&amp;amp;edit-text=&quot;&gt;Google
translate&lt;/a&gt;).&lt;/p&gt;
&lt;p&gt;Higher quantiles of a distribution also have a long history as
threshold for when to declare an observation an outlier. For example,
growth curves for children illustrate how the quantiles of, e.g., &lt;a
href=&quot;http://www.cdc.gov/growthcharts/data/set1clinical/cj41l024.pdf&quot;&gt;the
BMI distribution develop by age&lt;/a&gt;. &lt;strong&gt;Obesity&lt;/strong&gt; is then
for children defined as exceedance of the &lt;a
href=&quot;http://www.who.int/growthref/bmifa_girls_z_5_19_labels.pdf?ua=1&quot;&gt;97.7%
quantile&lt;/a&gt; of the distribution at a particular age. Quantile
regression is a non-parametric method to compute such curves and the
statistical community has been quite busy lately investigating new ways
to compute such quantile regressions models.&lt;/p&gt;
&lt;p&gt;The focus of this blog post is nevertheless the simplest setting:
Given an iid. sample &lt;span class=&quot;math inline&quot;&gt;\(\bm{x}\)&lt;/span&gt; of size
&lt;span class=&quot;math inline&quot;&gt;\(n\)&lt;/span&gt; from a univariate and absolutely
continuous distribution &lt;span class=&quot;math inline&quot;&gt;\(F\)&lt;/span&gt;, how does
one compute an estimate for the &lt;span
class=&quot;math inline&quot;&gt;\(p\)&lt;/span&gt;-Quantile of &lt;span
class=&quot;math inline&quot;&gt;\(F\)&lt;/span&gt; together with a corresponding two-sided
&lt;span class=&quot;math inline&quot;&gt;\((1-\alpha)\cdot 100\%\)&lt;/span&gt; confidence
interval for it?&lt;/p&gt;
&lt;h3 id=&quot;the-point-estimate&quot;&gt;The Point Estimate&lt;/h3&gt;
&lt;p&gt;Computing the quantile in a sample with statistical software is
discussed in the excellent survey of &lt;span class=&quot;citation&quot;
data-cites=&quot;hyndman_fan1996&quot;&gt;Hyndman and Fan (1996)&lt;/span&gt;. The simplest
estimator is based on the &lt;a
href=&quot;https://en.wikipedia.org/wiki/Order_statistic&quot;&gt;order statistic&lt;/a&gt;
of the sample, i.e. &lt;span class=&quot;math inline&quot;&gt;\(x_{(1)} &amp;lt; x_{(2)}
&amp;lt; \cdots &amp;lt; x_{(n)}\)&lt;/span&gt;. &lt;span class=&quot;math display&quot;&gt;\[
\hat{x}_p = \min_{k} \left\{\hat{F}(x_{(k)}) \geq p\right\} = x_{(\lceil
n \cdot p\rceil)},
\]&lt;/span&gt; where &lt;span class=&quot;math inline&quot;&gt;\(\hat{F}\)&lt;/span&gt; is the &lt;a
href=&quot;https://en.wikipedia.org/wiki/Empirical_distribution_function&quot;&gt;empirical
cumulative distribution&lt;/a&gt; function of the sample. Since &lt;span
class=&quot;math inline&quot;&gt;\(\hat{F}\)&lt;/span&gt; has jumps of size &lt;span
class=&quot;math inline&quot;&gt;\(1/n\)&lt;/span&gt; the actual value of &lt;span
class=&quot;math inline&quot;&gt;\(\hat{F}(\hat{x}_{p})\)&lt;/span&gt; can end up being
somewhat larger than the desired &lt;span class=&quot;math inline&quot;&gt;\(p\)&lt;/span&gt;.
Therefore, &lt;span class=&quot;citation&quot; data-cites=&quot;hyndman_fan1996&quot;&gt;Hyndman
and Fan (1996)&lt;/span&gt; prefer estimators interpolating between the two
values of the order statistic with &lt;span
class=&quot;math inline&quot;&gt;\(\hat{F}\)&lt;/span&gt; just below and just above &lt;span
class=&quot;math inline&quot;&gt;\(p\)&lt;/span&gt;. It is interesting that even &lt;a
href=&quot;http://robjhyndman.com/hyndsight/sample-quantiles-20-years-later/&quot;&gt;20
years after&lt;/a&gt;, there still is no universally accepted way to do this
in different statistical software and the &lt;code&gt;type&lt;/code&gt; argument of
the &lt;code&gt;quantile&lt;/code&gt; function in R has been a close friend when
comparing results with SPSS or Stata users. In what follows we will,
however, stick with the simple &lt;span class=&quot;math inline&quot;&gt;\(x_{(\lceil n
\cdot p\rceil)}\)&lt;/span&gt; estimator stated above.&lt;/p&gt;
&lt;p&gt;Below is illustrated how one would use R to compute the, say, the 80%
quantile of a sample using the above estimator. We can compute this
either manually or using the &lt;code&gt;quantile&lt;/code&gt; function with
&lt;code&gt;type=1&lt;/code&gt;:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb1&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb1-1&quot;&gt;&lt;a href=&quot;#cb1-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##Make a tiny artificial dataset, say, the BMI z-score of 25 children&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-2&quot;&gt;&lt;a href=&quot;#cb1-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;sort&lt;/span&gt;(x &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;rnorm&lt;/span&gt;(&lt;span class=&quot;dv&quot;&gt;25&lt;/span&gt;))&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;##  [1] -1.44090165 -1.40318433 -1.21953433 -0.95029549 -0.90398754 -0.66095890 -0.47801787
##  [8] -0.43976149 -0.36174823 -0.34116984 -0.33047704 -0.31576897 -0.28904542 -0.03789851
## [15] -0.03764990 -0.03377687  0.22121130  0.30331291  0.43716773  0.47435054  0.60897987
## [22]  0.64611097  1.20086374  1.52483138  2.67862782&lt;/code&gt;&lt;/pre&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb3&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb3-1&quot;&gt;&lt;a href=&quot;#cb3-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##Define the quantile we want to consider&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb3-2&quot;&gt;&lt;a href=&quot;#cb3-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;p &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fl&quot;&gt;0.8&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb3-3&quot;&gt;&lt;a href=&quot;#cb3-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##Since we know the true distribution we can easily find the true quantile&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb3-4&quot;&gt;&lt;a href=&quot;#cb3-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;(x_p &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;qnorm&lt;/span&gt;(p))&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;## [1] 0.8416212&lt;/code&gt;&lt;/pre&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb5&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb5-1&quot;&gt;&lt;a href=&quot;#cb5-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##Compute the estimates using the quantile function and manually&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb5-2&quot;&gt;&lt;a href=&quot;#cb5-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;c&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;quantile=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;quantile&lt;/span&gt;(x, &lt;span class=&quot;at&quot;&gt;type=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;, &lt;span class=&quot;at&quot;&gt;prob=&lt;/span&gt;p), &lt;span class=&quot;at&quot;&gt;manual=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;sort&lt;/span&gt;(x)[&lt;span class=&quot;fu&quot;&gt;ceiling&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;length&lt;/span&gt;(x)&lt;span class=&quot;sc&quot;&gt;*&lt;/span&gt;p)])&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;## quantile.80%       manual 
##    0.4743505    0.4743505&lt;/code&gt;&lt;/pre&gt;
&lt;h3 id=&quot;confidence-interval-for-the-quantile&quot;&gt;Confidence interval for
the quantile&lt;/h3&gt;
&lt;p&gt;Besides the point estimate &lt;span
class=&quot;math inline&quot;&gt;\(\hat{x}_p\)&lt;/span&gt; we also would like to report a
two-sided &lt;span class=&quot;math inline&quot;&gt;\((1-\alpha)\cdot 100\%\)&lt;/span&gt;
confidence interval &lt;span class=&quot;math inline&quot;&gt;\((x_p^{\text{l}},
x_p^{\text{u}})\)&lt;/span&gt; for the desired population quantile. The
interval &lt;span class=&quot;math inline&quot;&gt;\((x_p^{\text{l}},
x_p^{\text{u}})\)&lt;/span&gt; should, hence, fulfill the following condition:
&lt;span class=&quot;math display&quot;&gt;\[
P( (x_p^{\text{l}}, x_p^{\text{u}}) \ni x_p) = 1 - \alpha,
\]&lt;/span&gt; where we have used the “backwards” &lt;span
class=&quot;math inline&quot;&gt;\(\in\)&lt;/span&gt; to stress the fact that &lt;a
href=&quot;https://staff.math.su.se/hoehle/blog/2017/06/22/interpretcis.html&quot;&gt;it’s
the interval which is random&lt;/a&gt;. Restricting the limits of this
confidence intervals to be &lt;strong&gt;one of the realisations from the
order statistics&lt;/strong&gt; implies that we need to find indices &lt;span
class=&quot;math inline&quot;&gt;\(d\)&lt;/span&gt; and &lt;span
class=&quot;math inline&quot;&gt;\(e\)&lt;/span&gt; with &lt;span
class=&quot;math inline&quot;&gt;\(d&amp;lt;e\)&lt;/span&gt; s.t. &lt;span class=&quot;math display&quot;&gt;\[
P( x_{(d)} \leq x_p \leq x_{(e)}) \geq 1 - \alpha.
\]&lt;/span&gt; Note that it may not be possible to achieve the desired
coverage exactly in this case. For now we prefer the conservative choice
of having to attain &lt;strong&gt;at least&lt;/strong&gt; the desired coverage. Note
that for &lt;span class=&quot;math inline&quot;&gt;\(1\leq r \leq n\)&lt;/span&gt; we have
&lt;span class=&quot;math display&quot;&gt;\[
\begin{align*}
P( x_{(r)} \leq x_p) &amp;amp;= P(\text{at least $r$ observations are
smaller than or equal to $x_p$}) \\
      &amp;amp;= \sum_{k=r}^{n} P(\text{exactly $k$ observations are smaller
than or equal to $x_p$}) \\
      &amp;amp;= \sum_{k=r}^{n} {n \choose k} P(X \leq x_p)^k (1-P(X \leq
x_p))^{n-k} \\
      &amp;amp;= \sum_{k=r}^{n} {n \choose k} p^k (1-p)^{n-k} \\
      &amp;amp;= 1 - \sum_{k=0}^{r-1} {n \choose k} p^k (1-p)^{n-k}
\end{align*}
\]&lt;/span&gt; In principle, we could now try out all possible &lt;span
class=&quot;math inline&quot;&gt;\((d,e)\)&lt;/span&gt; combinations and for each interval
investigate, whether it has the desired &lt;span class=&quot;math inline&quot;&gt;\(\geq
1-\alpha\)&lt;/span&gt; property. If several combinations achieve this
criterion we would, e.g., take the interval having minimal length. This
is what the &lt;code&gt;MKmisc::quantileCI&lt;/code&gt; function does. However, the
number of pairs to investigate is of order &lt;span
class=&quot;math inline&quot;&gt;\(O(n^2)\)&lt;/span&gt;, which for large &lt;span
class=&quot;math inline&quot;&gt;\(n\)&lt;/span&gt; quickly becomes lengthy to compute.
Instead, we compute an &lt;strong&gt;equi-tailed confidence interval&lt;/strong&gt;
by finding two one-sided &lt;span class=&quot;math inline&quot;&gt;\(1-\alpha/2\)&lt;/span&gt;
intervals, i.e. we find &lt;span class=&quot;math inline&quot;&gt;\(d\)&lt;/span&gt; and &lt;span
class=&quot;math inline&quot;&gt;\(e\)&lt;/span&gt; s.t. &lt;span
class=&quot;math inline&quot;&gt;\(P(x_{(d)} \leq x_p) = 1-\alpha/2\)&lt;/span&gt; and
&lt;span class=&quot;math inline&quot;&gt;\(P(x_p \geq x_{(e)}) = 1-\alpha/2\)&lt;/span&gt;.
In other words,&lt;/p&gt;
&lt;p&gt;&lt;span class=&quot;math display&quot;&gt;\[
\begin{align*}
d &amp;amp;= \argmax P(x_{(r)} \leq x_p) \geq 1 - \frac{\alpha}{2} \\
  &amp;amp;= \texttt{qbinom(alpha/2, size=n, prob=p)} \\
e &amp;amp;= \argmin P(x_p \geq x_{(r)}) \geq 1 - \frac{\alpha}{2} \\
  &amp;amp;= \texttt{qbinom(1-alpha/2, size=n, prob=p) + 1}
\end{align*}
\]&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;Note that the problem can arise, that the above solutions are zero or
&lt;span class=&quot;math inline&quot;&gt;\(n+1\)&lt;/span&gt;, respectively. In this case one
has to decide how to proceed. For an illustration of the above in case
of the median see the &lt;a
href=&quot;http://freakonometrics.hypotheses.org/4199&quot;&gt;post&lt;/a&gt; by &lt;a
href=&quot;https://twitter.com/freakonometrics&quot;&gt;@freakonometrics&lt;/a&gt;. Also
note that the &lt;code&gt;qbinom&lt;/code&gt; function uses the &lt;a
href=&quot;https://en.wikipedia.org/wiki/Cornish%E2%80%93Fisher_expansion&quot;&gt;Cornish-Fisher
Expansion&lt;/a&gt; to come up with an initial guess for the quantile, which
is then refined by a numerical search. In other words, the function is
of order &lt;span class=&quot;math inline&quot;&gt;\(O(1)\)&lt;/span&gt; and will, hence, be
fast even for large &lt;span class=&quot;math inline&quot;&gt;\(n\)&lt;/span&gt;.&lt;/p&gt;
&lt;p&gt;When it comes to confidence intervals for quantiles the set of
alternative implementations in R is extensive. &lt;a
href=&quot;http://finzi.psych.upenn.edu/cgi-bin/namazu.cgi?query=confidence+interval+for+quantiles&amp;amp;max=100&amp;amp;result=normal&amp;amp;sort=score&amp;amp;idxname=functions&amp;amp;idxname=vignettes&amp;amp;idxname=views&quot;&gt;Searching
for this on CRAN&lt;/a&gt;, we found the following functionality:&lt;/p&gt;
&lt;table&gt;
&lt;colgroup&gt;
&lt;col style=&quot;width: 24%&quot; /&gt;
&lt;col style=&quot;width: 11%&quot; /&gt;
&lt;col style=&quot;width: 64%&quot; /&gt;
&lt;/colgroup&gt;
&lt;thead&gt;
&lt;tr class=&quot;header&quot;&gt;
&lt;th&gt;Package::Function&lt;/th&gt;
&lt;th style=&quot;text-align: center;&quot;&gt;Version&lt;/th&gt;
&lt;th&gt;Description&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr class=&quot;odd&quot;&gt;
&lt;td&gt;&lt;a
href=&quot;http://finzi.psych.upenn.edu/R/library/MKmisc/html/quantileCI.html&quot;&gt;&lt;code&gt;MKmisc::quantileCI&lt;/code&gt;&lt;/a&gt;&lt;/td&gt;
&lt;td style=&quot;text-align: center;&quot;&gt;&lt;/td&gt;
&lt;td&gt;Implements an exact but very slow &lt;span
class=&quot;math inline&quot;&gt;\(O(n^2)\)&lt;/span&gt; search as well as an asymptotic
method approximating the exact procedure. Due to the method being slow
it is not investigated further, but looking at it an &lt;code&gt;Rcpp&lt;/code&gt;
implementation of the nested loop might be able to speed up the
performance substantially. Note: New versions of &lt;code&gt;MKmisc&lt;/code&gt; do
not install, because the depency pkg &lt;code&gt;limma&lt;/code&gt; is not on CRAN
anymore.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&quot;even&quot;&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td style=&quot;text-align: center;&quot;&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&quot;odd&quot;&gt;
&lt;td&gt;&lt;a
href=&quot;http://finzi.psych.upenn.edu/R/library/jmuOutlier/html/quantileCI.html&quot;&gt;&lt;code&gt;jmuOutlier::quantileCI&lt;/code&gt;&lt;/a&gt;&lt;/td&gt;
&lt;td style=&quot;text-align: center;&quot;&gt;2.2&lt;/td&gt;
&lt;td&gt;Implements the exact method.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&quot;even&quot;&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td style=&quot;text-align: center;&quot;&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&quot;odd&quot;&gt;
&lt;td&gt;&lt;a
href=&quot;http://finzi.psych.upenn.edu/R/library/EnvStats/html/eqnpar.html&quot;&gt;&lt;code&gt;envStats::eqnpar&lt;/code&gt;&lt;/a&gt;&lt;/td&gt;
&lt;td style=&quot;text-align: center;&quot;&gt;2.1.1&lt;/td&gt;
&lt;td&gt;implements both an exact and an asymptotic interval&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&quot;even&quot;&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td style=&quot;text-align: center;&quot;&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&quot;odd&quot;&gt;
&lt;td&gt;&lt;a
href=&quot;http://finzi.psych.upenn.edu/R/library/asht/html/quantileTest.html&quot;&gt;&lt;code&gt;asht::quantileTest&lt;/code&gt;&lt;/a&gt;&lt;/td&gt;
&lt;td style=&quot;text-align: center;&quot;&gt;0.9.6&lt;/td&gt;
&lt;td&gt;also implements an exact method&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&quot;even&quot;&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td style=&quot;text-align: center;&quot;&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&quot;odd&quot;&gt;
&lt;td&gt;&lt;a
href=&quot;http://finzi.psych.upenn.edu/R/library/Qtools/html/confint.midquantile.html&quot;&gt;&lt;code&gt;Qtools::confint.midquantile&lt;/code&gt;&lt;/a&gt;&lt;/td&gt;
&lt;td style=&quot;text-align: center;&quot;&gt;&lt;/td&gt;
&lt;td&gt;operates on the mid-quantile (whatever that is). The method is not
investigated further.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&quot;even&quot;&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td style=&quot;text-align: center;&quot;&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;
&lt;p&gt;There might even be more, but for now we are satisfied comparing just
the above mentioned procedures:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb7&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb7-1&quot;&gt;&lt;a href=&quot;#cb7-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;as.numeric&lt;/span&gt;(jmuOutlier&lt;span class=&quot;sc&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;quantileCI&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;x=&lt;/span&gt;x, &lt;span class=&quot;at&quot;&gt;probs=&lt;/span&gt;p, &lt;span class=&quot;at&quot;&gt;conf.level=&lt;/span&gt;&lt;span class=&quot;fl&quot;&gt;0.95&lt;/span&gt;)[&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;,&lt;span class=&quot;fu&quot;&gt;c&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;quot;lower&amp;quot;&lt;/span&gt;,&lt;span class=&quot;st&quot;&gt;&amp;quot;upper&amp;quot;&lt;/span&gt;)])&lt;/span&gt;
&lt;span id=&quot;cb7-2&quot;&gt;&lt;a href=&quot;#cb7-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;as.numeric&lt;/span&gt;(EnvStats&lt;span class=&quot;sc&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;eqnpar&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;x=&lt;/span&gt;x, &lt;span class=&quot;at&quot;&gt;p=&lt;/span&gt;p, &lt;span class=&quot;at&quot;&gt;ci=&lt;/span&gt;&lt;span class=&quot;cn&quot;&gt;TRUE&lt;/span&gt;, &lt;span class=&quot;at&quot;&gt;ci.method=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;exact&amp;quot;&lt;/span&gt;,&lt;span class=&quot;at&quot;&gt;approx.conf.level=&lt;/span&gt;&lt;span class=&quot;fl&quot;&gt;0.95&lt;/span&gt;)&lt;span class=&quot;sc&quot;&gt;$&lt;/span&gt;interval&lt;span class=&quot;sc&quot;&gt;$&lt;/span&gt;limits)&lt;/span&gt;
&lt;span id=&quot;cb7-3&quot;&gt;&lt;a href=&quot;#cb7-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;as.numeric&lt;/span&gt;(EnvStats&lt;span class=&quot;sc&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;eqnpar&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;x=&lt;/span&gt;x, &lt;span class=&quot;at&quot;&gt;p=&lt;/span&gt;p, &lt;span class=&quot;at&quot;&gt;ci=&lt;/span&gt;&lt;span class=&quot;cn&quot;&gt;TRUE&lt;/span&gt;, &lt;span class=&quot;at&quot;&gt;ci.method=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;normal.approx&amp;quot;&lt;/span&gt;,&lt;span class=&quot;at&quot;&gt;approx.conf.level=&lt;/span&gt;&lt;span class=&quot;fl&quot;&gt;0.95&lt;/span&gt;)&lt;span class=&quot;sc&quot;&gt;$&lt;/span&gt;interval&lt;span class=&quot;sc&quot;&gt;$&lt;/span&gt;limits)&lt;/span&gt;
&lt;span id=&quot;cb7-4&quot;&gt;&lt;a href=&quot;#cb7-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;as.numeric&lt;/span&gt;(asht&lt;span class=&quot;sc&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;quantileTest&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;x=&lt;/span&gt;x,&lt;span class=&quot;at&quot;&gt;p=&lt;/span&gt;p,&lt;span class=&quot;at&quot;&gt;conf.level=&lt;/span&gt;&lt;span class=&quot;fl&quot;&gt;0.95&lt;/span&gt;)&lt;span class=&quot;sc&quot;&gt;$&lt;/span&gt;conf.int)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;## [1] -0.03377687  1.52483138
## [1] 0.2212113 2.6786278
## [1] -0.03377687  1.52483138
## [1] -0.03377687  2.67862782&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;An impressive number of similar, but yet, different results! To add
to the confusion here is our take at this as developed in the
&lt;code&gt;quantileCI&lt;/code&gt; package available from github:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb9&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb9-1&quot;&gt;&lt;a href=&quot;#cb9-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;devtools&lt;span class=&quot;sc&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;install_github&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;quot;hoehleatsu/quantileCI&amp;quot;&lt;/span&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;The package provides three methods for computing confidence intervals
for quantiles:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb10&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb10-1&quot;&gt;&lt;a href=&quot;#cb10-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;quantileCI&lt;span class=&quot;sc&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;quantile_confint_nyblom&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;x=&lt;/span&gt;x, &lt;span class=&quot;at&quot;&gt;p=&lt;/span&gt;p, &lt;span class=&quot;at&quot;&gt;conf.level=&lt;/span&gt;&lt;span class=&quot;fl&quot;&gt;0.95&lt;/span&gt;,&lt;span class=&quot;at&quot;&gt;interpolate=&lt;/span&gt;&lt;span class=&quot;cn&quot;&gt;FALSE&lt;/span&gt;)&lt;/span&gt;
&lt;span id=&quot;cb10-2&quot;&gt;&lt;a href=&quot;#cb10-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;quantileCI&lt;span class=&quot;sc&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;quantile_confint_nyblom&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;x=&lt;/span&gt;x, &lt;span class=&quot;at&quot;&gt;p=&lt;/span&gt;p, &lt;span class=&quot;at&quot;&gt;conf.level=&lt;/span&gt;&lt;span class=&quot;fl&quot;&gt;0.95&lt;/span&gt;,&lt;span class=&quot;at&quot;&gt;interpolate=&lt;/span&gt;&lt;span class=&quot;cn&quot;&gt;TRUE&lt;/span&gt;)&lt;/span&gt;
&lt;span id=&quot;cb10-3&quot;&gt;&lt;a href=&quot;#cb10-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;quantileCI&lt;span class=&quot;sc&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;quantile_confint_boot&lt;/span&gt;(x, &lt;span class=&quot;at&quot;&gt;p=&lt;/span&gt;p, &lt;span class=&quot;at&quot;&gt;conf.level=&lt;/span&gt;&lt;span class=&quot;fl&quot;&gt;0.95&lt;/span&gt;,&lt;span class=&quot;at&quot;&gt;R=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;999&lt;/span&gt;, &lt;span class=&quot;at&quot;&gt;type=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;## [1] -0.03377687  2.67862782
## [1] 0.07894831 1.54608644
## [1] -0.03377687  1.20086374&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;The first procedure with &lt;code&gt;interpolate=FALSE&lt;/code&gt; implements
the previously explained exact approach, which is also implemented in
some of the other packages. However, when the &lt;code&gt;interpolate&lt;/code&gt;
argument is set to &lt;code&gt;TRUE&lt;/code&gt; (the default), an additional
interpolation step between the two neighbouring order statistics is
performed as suggested in the work of &lt;span class=&quot;citation&quot;
data-cites=&quot;nyblom1992&quot;&gt;Nyblom (1992)&lt;/span&gt;, which extends work for the
median by &lt;span class=&quot;citation&quot;
data-cites=&quot;hettmansperger_sheather1986&quot;&gt;Hettmansperger and Sheather
(1986)&lt;/span&gt; to arbitrary quantiles. It generates intervals of the
form:&lt;/p&gt;
&lt;p&gt;&lt;span class=&quot;math display&quot;&gt;\[
\left( (1-\lambda_1) x_{(d)} + \lambda_1 x_{(d+1)}, (1-\lambda_2)
x_{(e-1)} + \lambda_1 x_{(e)} \right)
\]&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;with &lt;span class=&quot;math inline&quot;&gt;\(0 \leq \lambda_1, \lambda_2 \leq
1\)&lt;/span&gt; chosen appropriately to get as close to the desired coverage
as possible without knowing the exact underlying distribution - see the
paper for details.&lt;/p&gt;
&lt;p&gt;The last call in the above is to a basic bootstrap procedure, which
resamples the data with replacement, computes the quantile using
&lt;code&gt;type=1&lt;/code&gt; and then reports the 2.5% and 97.5% percentiles of
this bootstrapped distribution. Such percentiles of the basic bootstrap
are a popular way to get confidence intervals for the quantile, e.g.,
this is what we have used in &lt;span class=&quot;citation&quot;
data-cites=&quot;hoehle_hoehle2009&quot;&gt;Höhle and Höhle (2009)&lt;/span&gt; for
reporting the 95% quantile of the absolute difference in height at so
called &lt;strong&gt;check points&lt;/strong&gt; in the assessment of accuracy for a
digital elevation model (DEM) in photogrammetry. However, the coverage
of the percentile bootstrap procedure is not without problems, because
the convergence rate as a function of the number of replicates &lt;span
class=&quot;math inline&quot;&gt;\(r\)&lt;/span&gt; is only of order &lt;span
class=&quot;math inline&quot;&gt;\(O(r^{-\frac{1}{2}})\)&lt;/span&gt; for quantiles (&lt;span
class=&quot;citation&quot; data-cites=&quot;falk_kaufmann1991&quot;&gt;Falk and Kaufmann
(1991)&lt;/span&gt;). As a trade-off between accuracy and speed we use &lt;span
class=&quot;math inline&quot;&gt;\(R=999\)&lt;/span&gt; throughout this post.&lt;/p&gt;
&lt;h2 id=&quot;simulation-study-to-determine-coverage&quot;&gt;Simulation Study to
Determine Coverage&lt;/h2&gt;
&lt;p&gt;We write a function, which for a given sample &lt;code&gt;x&lt;/code&gt; computes
two-sided confidence intervals for the p-Quantile using a selection of
the above described procedures:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb12&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb12-1&quot;&gt;&lt;a href=&quot;#cb12-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;quantile_confints&lt;/span&gt;(x, &lt;span class=&quot;at&quot;&gt;p=&lt;/span&gt;p, &lt;span class=&quot;at&quot;&gt;conf.level=&lt;/span&gt;&lt;span class=&quot;fl&quot;&gt;0.95&lt;/span&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;##   jmuOutlier_exact EnvStats_exact EnvStats_asymp asht_quantTest nyblom_exact
## 1      -0.03377687      0.2212113    -0.03377687    -0.03377687  -0.03377687
## 2       1.52483138      2.6786278     1.52483138     2.67862782   2.67862782
##   nyblom_interp        boot
## 1    0.07894831 -0.03377687
## 2    1.54608644  1.49641655&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;In order to evaluate the various methods and implementations we
conduct a Monte Carlo simulation study to assess each methods’ coverage.
For this purpose we write a small wrapper function to conduct the
simulation study using &lt;a
href=&quot;http://gforge.se/2015/02/how-to-go-parallel-in-r-basics-tips/&quot;&gt;parallel
computation&lt;/a&gt;. The function wraps the
&lt;code&gt;quantileCI::qci_coverage_one_sim&lt;/code&gt; function, which lets the
user define a simulation scenario (true underlying distribution, size of
the sample, etc.), then applies all confidence interval methods gathered
in the above &lt;code&gt;quantile_confints&lt;/code&gt; and finally assesses whether
each confidence interval covers the true value or not.&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb14&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb14-1&quot;&gt;&lt;a href=&quot;#cb14-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;simulate.coverage_qci &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;cf&quot;&gt;function&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;n=&lt;/span&gt;n,&lt;span class=&quot;at&quot;&gt;p=&lt;/span&gt;p,&lt;span class=&quot;at&quot;&gt;conf.level=&lt;/span&gt;&lt;span class=&quot;fl&quot;&gt;0.9&lt;/span&gt;, &lt;span class=&quot;at&quot;&gt;nSim=&lt;/span&gt;&lt;span class=&quot;fl&quot;&gt;10e3&lt;/span&gt;, ...) {&lt;/span&gt;
&lt;span id=&quot;cb14-2&quot;&gt;&lt;a href=&quot;#cb14-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;do&quot;&gt;##Windows users: change to below lapply function or use snow.&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb14-3&quot;&gt;&lt;a href=&quot;#cb14-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;do&quot;&gt;##lapplyFun &amp;lt;- function(x, mc.cores=NA, ...) pblapply(x, ...)&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb14-4&quot;&gt;&lt;a href=&quot;#cb14-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  lapplyFun &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; parallel&lt;span class=&quot;sc&quot;&gt;::&lt;/span&gt;mclapply&lt;/span&gt;
&lt;span id=&quot;cb14-5&quot;&gt;&lt;a href=&quot;#cb14-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb14-6&quot;&gt;&lt;a href=&quot;#cb14-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  sims &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; dplyr&lt;span class=&quot;sc&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;bind_rows&lt;/span&gt;(&lt;/span&gt;
&lt;span id=&quot;cb14-7&quot;&gt;&lt;a href=&quot;#cb14-7&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;fu&quot;&gt;lapplyFun&lt;/span&gt;(&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;dt&quot;&gt;L&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;:&lt;/span&gt;nSim, &lt;span class=&quot;cf&quot;&gt;function&lt;/span&gt;(i) {&lt;/span&gt;
&lt;span id=&quot;cb14-8&quot;&gt;&lt;a href=&quot;#cb14-8&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;      quantileCI&lt;span class=&quot;sc&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;qci_coverage_one_sim&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;qci_fun=&lt;/span&gt;quantile_confints, &lt;span class=&quot;at&quot;&gt;n=&lt;/span&gt;n,&lt;span class=&quot;at&quot;&gt;p=&lt;/span&gt;p,&lt;span class=&quot;at&quot;&gt;conf.level=&lt;/span&gt;conf.level,...)&lt;/span&gt;
&lt;span id=&quot;cb14-9&quot;&gt;&lt;a href=&quot;#cb14-9&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    }, &lt;span class=&quot;at&quot;&gt;mc.cores =&lt;/span&gt; parallel&lt;span class=&quot;sc&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;detectCores&lt;/span&gt;() &lt;span class=&quot;sc&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;)&lt;/span&gt;
&lt;span id=&quot;cb14-10&quot;&gt;&lt;a href=&quot;#cb14-10&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  ) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;summarise&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;across&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;everything&lt;/span&gt;(), mean))&lt;/span&gt;
&lt;span id=&quot;cb14-11&quot;&gt;&lt;a href=&quot;#cb14-11&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;return&lt;/span&gt;(sims)&lt;/span&gt;
&lt;span id=&quot;cb14-12&quot;&gt;&lt;a href=&quot;#cb14-12&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h4 id=&quot;simulation-1&quot;&gt;Simulation 1&lt;/h4&gt;
&lt;p&gt;We can now compare the coverage of the different implementation for
the particular &lt;code&gt;n&lt;/code&gt;=25 and &lt;code&gt;p&lt;/code&gt;=0.8 setting:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb15&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb15-1&quot;&gt;&lt;a href=&quot;#cb15-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;simulate.coverage_qci&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;n=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;25&lt;/span&gt;, &lt;span class=&quot;at&quot;&gt;p=&lt;/span&gt;&lt;span class=&quot;fl&quot;&gt;0.8&lt;/span&gt;, &lt;span class=&quot;at&quot;&gt;conf.level=&lt;/span&gt;&lt;span class=&quot;fl&quot;&gt;0.95&lt;/span&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;##   jmuOutlier_exact EnvStats_exact EnvStats_asymp asht_quantTest nyblom_exact
## 1           0.9552         0.9461         0.9552         0.9786       0.9786
##   nyblom_interp   boot
## 1        0.9495 0.9198&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Note that the &lt;code&gt;nyblom_interp&lt;/code&gt; procedure is closer to the
nominal coverage than it’s exact cousin &lt;code&gt;nyblom_exact&lt;/code&gt; and
the worst results are obtained by the bootstrap percentile method. We
also note that the results of the &lt;code&gt;jmuOutlier_exact&lt;/code&gt; method
appear to deviate from &lt;code&gt;asht_quantTest&lt;/code&gt; as well as
&lt;code&gt;nyblom_exact&lt;/code&gt;, which is surprising, because they should
implement the same approach.&lt;/p&gt;
&lt;h4 id=&quot;simulation-2&quot;&gt;Simulation 2&lt;/h4&gt;
&lt;p&gt;As a further test-case we consider the situation for the median in a
smaller sample:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb17&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb17-1&quot;&gt;&lt;a href=&quot;#cb17-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;simulate.coverage_qci&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;n=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;11&lt;/span&gt;, &lt;span class=&quot;at&quot;&gt;p=&lt;/span&gt;&lt;span class=&quot;fl&quot;&gt;0.5&lt;/span&gt;, &lt;span class=&quot;at&quot;&gt;conf.level=&lt;/span&gt;&lt;span class=&quot;fl&quot;&gt;0.95&lt;/span&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;##   jmuOutlier_exact EnvStats_exact EnvStats_asymp asht_quantTest nyblom_exact
## 1           0.9873         0.9332         0.9583         0.9873       0.9873
##   nyblom_interp   boot hs_interp
## 1        0.9463 0.9332    0.9463&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;We note that the &lt;code&gt;EnvStats_exact&lt;/code&gt; procedure again has a
lower coverage than the nominal required level, it must therefore
implement a slightly different procedure than expected. That coverage is
less than the nominal for an &lt;em&gt;exact&lt;/em&gt; method is, however, still
somewhat &lt;em&gt;surprising&lt;/em&gt;.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Edit 2019-05-14&lt;/strong&gt;: I pointed the package maintainer to
this problem after looking at the code. Versions larger than 2.1.1 of
the &lt;code&gt;EnvStats&lt;/code&gt; pkg now contain an updated version of this
function and also the &lt;a
href=&quot;http://finzi.psych.upenn.edu/R/library/EnvStats/html/eqnpar.html&quot;&gt;Nyblom
function&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;In this study for the median, the original &lt;span class=&quot;citation&quot;
data-cites=&quot;hettmansperger_sheather1986&quot;&gt;Hettmansperger and Sheather
(1986)&lt;/span&gt; procedure implemented in &lt;code&gt;quantileCI&lt;/code&gt; as
function &lt;code&gt;median_confint_hs&lt;/code&gt; is also included in the
comparison (&lt;code&gt;hs_interp&lt;/code&gt;). Note that the &lt;span
class=&quot;citation&quot; data-cites=&quot;nyblom1992&quot;&gt;Nyblom (1992)&lt;/span&gt; procedure
for &lt;span class=&quot;math inline&quot;&gt;\(p=\frac{1}{2}\)&lt;/span&gt; just boils down
to this approach. Since the neighbouring order statistics are combined
using a weighted mean, the actual level is just close to the nominal
level. It can, as observed for the above setting, be slightly lower than
the nominal level. The bootstrap method again doesn’t look too
impressive.&lt;/p&gt;
&lt;h4 id=&quot;simulation-3&quot;&gt;Simulation 3&lt;/h4&gt;
&lt;p&gt;We finally also add one of the scenarios from Table 1 of the &lt;span
class=&quot;citation&quot; data-cites=&quot;nyblom1992&quot;&gt;Nyblom (1992)&lt;/span&gt; paper,
which allows us to check our implementation against the numerical
integration performed in the paper to assess coverage.&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb19&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb19-1&quot;&gt;&lt;a href=&quot;#cb19-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;simulate.coverage_qci&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;n=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;11&lt;/span&gt;, &lt;span class=&quot;at&quot;&gt;p=&lt;/span&gt;&lt;span class=&quot;fl&quot;&gt;0.25&lt;/span&gt;, &lt;span class=&quot;at&quot;&gt;conf.level=&lt;/span&gt;&lt;span class=&quot;fl&quot;&gt;0.90&lt;/span&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;##   jmuOutlier_exact EnvStats_exact EnvStats_asymp asht_quantTest nyblom_exact
## 1           0.9219         0.7633          0.841         0.9219       0.9219
##   nyblom_interp   boot
## 1        0.9014 0.8816&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;In particular the results of &lt;code&gt;EnvStats_exact&lt;/code&gt; look
disturbing. The coverage of the interpolated order statistic approach
again looks convincing.&lt;/p&gt;
&lt;h4 id=&quot;simulation-4&quot;&gt;Simulation 4&lt;/h4&gt;
&lt;p&gt;Finally, a setup with a large sample, but now with the t-distribution
with one degree of freedom:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb21&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb21-1&quot;&gt;&lt;a href=&quot;#cb21-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;simulate.coverage_qci&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;n=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;101&lt;/span&gt;, &lt;span class=&quot;at&quot;&gt;p=&lt;/span&gt;&lt;span class=&quot;fl&quot;&gt;0.9&lt;/span&gt;, &lt;span class=&quot;at&quot;&gt;rfunc=&lt;/span&gt;rt, &lt;span class=&quot;at&quot;&gt;qfunc=&lt;/span&gt;qt, &lt;span class=&quot;at&quot;&gt;conf.level=&lt;/span&gt;&lt;span class=&quot;fl&quot;&gt;0.95&lt;/span&gt;, &lt;span class=&quot;at&quot;&gt;df=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;##   jmuOutlier_exact EnvStats_exact EnvStats_asymp asht_quantTest nyblom_exact
## 1           0.9547         0.9352         0.9547         0.9547       0.9547
##   nyblom_interp   boot
## 1        0.9495 0.9362&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Again the interpolation method provides the most convincing results.
The bootstrap on the other hand again has the worst coverage, a larger
&lt;span class=&quot;math inline&quot;&gt;\(R\)&lt;/span&gt; might have helped here, but would
have made the simulation study even more time consuming.&lt;/p&gt;
&lt;h1 id=&quot;conclusion-and-future-work&quot;&gt;Conclusion and Future Work&lt;/h1&gt;
&lt;p&gt;Can we based on the above recommend one procedure to use in practice?
Well, even though the simulation study is small, the exact
&lt;code&gt;EnvStats::eqnpar&lt;/code&gt; approach appears to yield below nominal
coverage intervals, sometimes even substantially, and hence is not
recommended in versions below or equal to 2.1.1 &lt;a href=&quot;#fn1&quot;
class=&quot;footnote-ref&quot; id=&quot;fnref1&quot; role=&quot;doc-noteref&quot;&gt;&lt;sup&gt;1&lt;/sup&gt;&lt;/a&gt;. On
the other hand, &lt;code&gt;jmuOutlier_exact&lt;/code&gt;,
&lt;code&gt;asht_quantTest&lt;/code&gt;, and &lt;code&gt;nyblom_exact&lt;/code&gt; in all four
cases provide above nominal level coverage, i.e. the intervals are
conservative in as much as they are too wide. Also slightly disturbing
is that the results of the exact confidence interval methods varied
somewhat between the different R implementations. Part of the
differences arise from handling the discreteness of the procedure as
well as the edge cases differently. The basic percentile bootstrap
method is a simple approach, providing acceptable, but not optimal
coverage and also depends in part on &lt;span
class=&quot;math inline&quot;&gt;\(R\)&lt;/span&gt;. In particular for very large &lt;span
class=&quot;math inline&quot;&gt;\(n\)&lt;/span&gt; or for a large number of replication in
the simulation study, the method with a large &lt;span
class=&quot;math inline&quot;&gt;\(R\)&lt;/span&gt; can be slow. Suggestions exist in the
literature on how to improve the speed of coverage convergence by
smoothing (see, e.g., &lt;span class=&quot;citation&quot;
data-cites=&quot;deangelis_etal1993&quot;&gt;De Angelis, Hall, and Young
(1993)&lt;/span&gt;), but such work is beyond the scope of this post.&lt;/p&gt;
&lt;p&gt;The &lt;span class=&quot;citation&quot;
data-cites=&quot;hettmansperger_sheather1986&quot;&gt;Hettmansperger and Sheather
(1986)&lt;/span&gt; and &lt;span class=&quot;citation&quot; data-cites=&quot;nyblom1992&quot;&gt;Nyblom
(1992)&lt;/span&gt; method, respectively, provide very good coverage close to
the nominal level. The method is fast to compute, available through the
&lt;code&gt;quantileCI&lt;/code&gt; R package and would be our recommendation to use
in practice.&lt;/p&gt;
&lt;p&gt;Altogether, we summarise our findings as follows: &lt;strong&gt;More
confidence in confidence intervals for quantiles!&lt;/strong&gt; and let the
following picture illustrating 90% confidence intervals for the 80%
quantile of the standard normal distribution based on the above sample
of size &lt;span class=&quot;math inline&quot;&gt;\(n\)&lt;/span&gt;=25 say this in less than
1000 words.&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/blog/figure/source/2016-10-23-quantileCI/FIRSTPICTURE-1.png&quot; style=&quot;display: block; margin: auto;&quot; /&gt;&lt;/p&gt;
&lt;h1 id=&quot;appendix&quot;&gt;Appendix&lt;/h1&gt;
&lt;p&gt;Given PDF &lt;span class=&quot;math inline&quot;&gt;\(f\)&lt;/span&gt; and CDF &lt;span
class=&quot;math inline&quot;&gt;\(F\)&lt;/span&gt; of the underlying distribution, the
coverage probability of the one sided Nyblom &lt;span
class=&quot;math inline&quot;&gt;\((1-\alpha/2)\cdot 100\%\)&lt;/span&gt; confidence
interval &lt;span class=&quot;math inline&quot;&gt;\((1-\lambda) x_{(r)} + \lambda
x_{(r+1)}\)&lt;/span&gt; for &lt;span class=&quot;math inline&quot;&gt;\(x_p\)&lt;/span&gt; can be
found as follows: Let &lt;span class=&quot;math inline&quot;&gt;\(z = (1-\lambda)
x_{(r)} + \lambda
x_{(r+1)}\)&lt;/span&gt;. If the considered interval is a lower-confidence
interval, we are interested in finding &lt;span class=&quot;math inline&quot;&gt;\(P( z
\leq x_p)=\int_{-\infty}^{x_p}
f_z(z) dz\)&lt;/span&gt;. Here, the PDF of &lt;span
class=&quot;math inline&quot;&gt;\(z\)&lt;/span&gt; is found as&lt;/p&gt;
&lt;p&gt;&lt;span class=&quot;math display&quot;&gt;\[
f_z(z) = \int_{-\infty}^{z} f_{x_{(r)},x_{(r+1)}}( x_{(r)},
x_{(r+1)}^*) dx_{(r)}, \quad\text{where}\quad x_{(r+1)}^* =
\frac{z-(1-\lambda)x_{(r)}}{\lambda}.
\]&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;The &lt;a
href=&quot;https://en.wikipedia.org/wiki/Order_statistic#The_joint_distribution_of_the_order_statistics_of_an_absolutely_continuous_distribution&quot;&gt;joint
distribution of the order statistic&lt;/a&gt; is here&lt;/p&gt;
&lt;p&gt;&lt;span class=&quot;math display&quot;&gt;\[
f_{x_{(r)},x_{(r+1)}}( x_{(r)},
x_{(r+1)}) = \frac{n!}{(r-1)!(n-r-1)!} F(x_{(r)})^{r-1}
\left( 1- F(x_{(r+1)})\right)^{n-r-1} f(x_{(r+1)}) f(x_{(r)}).
\]&lt;/span&gt; The two nested integrals can be solved by numerical
integration using, e.g., the &lt;code&gt;integral&lt;/code&gt; function.&lt;/p&gt;
&lt;h1 class=&quot;unnumbered&quot; id=&quot;references&quot;&gt;References&lt;/h1&gt;
&lt;div id=&quot;refs&quot; class=&quot;references csl-bib-body hanging-indent&quot;
data-entry-spacing=&quot;0&quot; role=&quot;list&quot;&gt;
&lt;div id=&quot;ref-deangelis_etal1993&quot; class=&quot;csl-entry&quot; role=&quot;listitem&quot;&gt;
De Angelis, D., P. Hall, and G. A. Young. 1993. &lt;span&gt;“A Note on
Coverage Error of Bootstrap Confidence Intervals for Quantiles.”&lt;/span&gt;
&lt;em&gt;Mathematical Proceedings of the Cambridge Philosophical Society&lt;/em&gt;
114: 517–31. &lt;a
href=&quot;http://sci-prew.inf.ua/v114/3/S0305004100071802.pdf&quot;&gt;http://sci-prew.inf.ua/v114/3/S0305004100071802.pdf&lt;/a&gt;.
&lt;/div&gt;
&lt;div id=&quot;ref-falk_kaufmann1991&quot; class=&quot;csl-entry&quot; role=&quot;listitem&quot;&gt;
Falk, Michael, and Edgar Kaufmann. 1991. &lt;span&gt;“Coverage Probabilities
of Bootstrap-Confidence Intervals for Quantiles.”&lt;/span&gt; &lt;em&gt;Ann.
Statist.&lt;/em&gt; 19 (1): 485–95. &lt;a
href=&quot;https://doi.org/10.1214/aos/1176347995&quot;&gt;https://doi.org/10.1214/aos/1176347995&lt;/a&gt;.
&lt;/div&gt;
&lt;div id=&quot;ref-hettmansperger_sheather1986&quot; class=&quot;csl-entry&quot;
role=&quot;listitem&quot;&gt;
Hettmansperger, T. P., and S. J Sheather. 1986. &lt;span&gt;“Confidence
Intervals Based on Interpolated Order Statistics.”&lt;/span&gt; &lt;em&gt;Statistics
and Probability Letters&lt;/em&gt; 4: 75–79. &lt;a
href=&quot;https://doi.org/10.1016/0167-7152(86)90021-0&quot;&gt;https://doi.org/10.1016/0167-7152(86)90021-0&lt;/a&gt;.
&lt;/div&gt;
&lt;div id=&quot;ref-hoehle_hoehle2009&quot; class=&quot;csl-entry&quot; role=&quot;listitem&quot;&gt;
Höhle, J., and M. Höhle. 2009. &lt;span&gt;“Accuracy Assessment of Digital
Elevation Models by Means of Robust Statistical Methods.”&lt;/span&gt;
&lt;em&gt;ISPRS Journal of Photogrammetry and Remote Sensing&lt;/em&gt; 64 (4):
398–406. &lt;a
href=&quot;https://doi.org/10.1016/j.isprsjprs.2009.02.003&quot;&gt;https://doi.org/10.1016/j.isprsjprs.2009.02.003&lt;/a&gt;.
&lt;/div&gt;
&lt;div id=&quot;ref-hyndman_fan1996&quot; class=&quot;csl-entry&quot; role=&quot;listitem&quot;&gt;
Hyndman, R. J., and Y. Fan. 1996. &lt;span&gt;“Sample Quantiles in Statistical
Packages.”&lt;/span&gt; &lt;em&gt;American Statistician&lt;/em&gt; 50 (4): 361–65. &lt;a
href=&quot;https://doi.org/10.2307/2684934&quot;&gt;https://doi.org/10.2307/2684934&lt;/a&gt;.
&lt;/div&gt;
&lt;div id=&quot;ref-nyblom1992&quot; class=&quot;csl-entry&quot; role=&quot;listitem&quot;&gt;
Nyblom, J. 1992. &lt;span&gt;“Note on Interpolated Order Statistics.”&lt;/span&gt;
&lt;em&gt;Statistics and Probability Letters&lt;/em&gt; 14: 129–31. &lt;a
href=&quot;https://doi.org/10.1016/0167-7152(92)90076-H&quot;&gt;https://doi.org/10.1016/0167-7152(92)90076-H&lt;/a&gt;.
&lt;/div&gt;
&lt;/div&gt;
&lt;section id=&quot;footnotes&quot; class=&quot;footnotes footnotes-end-of-document&quot;
role=&quot;doc-endnotes&quot;&gt;
&lt;hr /&gt;
&lt;ol&gt;
&lt;li id=&quot;fn1&quot;&gt;&lt;p&gt;Versions &amp;gt; 2.1.1 of the package contain a bug-fix as
described in the author information of the &lt;a
href=&quot;(http://finzi.psych.upenn.edu/R/library/EnvStats/html/eqnpar.html)&quot;&gt;help
page&lt;/a&gt; as well as the Nyblom method.&lt;a href=&quot;#fnref1&quot;
class=&quot;footnote-back&quot; role=&quot;doc-backlink&quot;&gt;↩︎&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;/section&gt;
</description>
        <pubDate>Sun, 23 Oct 2016 00:00:00 +0200</pubDate>
        <link>https://mhoehle.github.io/blog/2016/10/23/quantileCI.html</link>
        <guid isPermaLink="true">https://mhoehle.github.io/blog/2016/10/23/quantileCI.html</guid>
        
        <category>rstats</category>
        
        <category>stats</category>
        
        <category>nonparametrics</category>
        
        
      </item>
    
      <item>
        <title>Cartograms with R</title>
        <description>&lt;h2 id=&quot;abstract&quot;&gt;Abstract&lt;/h2&gt;
&lt;p&gt;We show how to create &lt;a
href=&quot;https://en.wikipedia.org/wiki/Cartogram&quot;&gt;cartograms&lt;/a&gt; with R by
illustrating the population and age-distribution of the planning regions
of Berlin by static plots and animations.&lt;/p&gt;
&lt;p&gt;&lt;img
src=&quot;/blog/figure/source/2016-10-10-cartograms/CARTOGRAM-1.png&quot; /&gt;&lt;/p&gt;
&lt;p&gt;&lt;br&gt;
&lt;a rel=&quot;license&quot; href=&quot;http://creativecommons.org/licenses/by-sa/4.0/&quot;&gt;&lt;img alt=&quot;Creative Commons License&quot; style=&quot;border-width:0&quot; src=&quot;https://i.creativecommons.org/l/by-sa/4.0/88x31.png&quot;/&gt;&lt;/a&gt;
This work is licensed under a &lt;a rel=&quot;license&quot;
href=&quot;http://creativecommons.org/licenses/by-sa/4.0/&quot;&gt;Creative Commons
Attribution-ShareAlike 4.0 International License&lt;/a&gt;. The
markdown+Rknitr source code of this blog is available under a &lt;a
href=&quot;https://www.gnu.org/licenses/gpl-3.0.html&quot;&gt;GNU General Public
License (GPL v3)&lt;/a&gt; license from github.&lt;/p&gt;
&lt;h2 id=&quot;introduction&quot;&gt;Introduction&lt;/h2&gt;
&lt;p&gt;Every good lecture on sophisticated statistical modelling starts with
underlining the importance of &lt;strong&gt;data visualization&lt;/strong&gt; as the
first step of an analysis. &lt;a
href=&quot;https://en.wikipedia.org/wiki/Choropleth_map&quot;&gt;Choropleth maps&lt;/a&gt;
are a common choice for visualizing the spatial distribution of a
feature recorded in administrative regions, e.g., population density or
the incidence rate of a disease. Here, each region is shaded with a
color selected in accordance with the feature variable, e.g., higher hue
if the feature value is higher. Choosing the right palette for such
visualizations is a science of its own, see e.g. &lt;span class=&quot;citation&quot;
data-cites=&quot;zeileis_etal2009&quot;&gt;Zeileis, Hornik, and Murrell (2009)&lt;/span&gt;
or the &lt;a href=&quot;http://colorbrewer2.org/&quot;&gt;ColorBrewer&lt;/a&gt; project, which
is available in R through the &lt;a
href=&quot;https://cran.r-project.org/web/packages/RColorBrewer/index.html&quot;&gt;&lt;code&gt;RColorBrewer&lt;/code&gt;&lt;/a&gt;
package. A nice way to further spice up your spatial visualizations are
&lt;strong&gt;area cartograms&lt;/strong&gt;, where the boundary shape of each
region is warped such that its area becomes proportional to the value of
the feature variable you want to illustrate. The difficult part here is
to preserve the arrangement of the regions, see for example &lt;span
class=&quot;citation&quot; data-cites=&quot;gastner_newman2004&quot;&gt;Gastner and Newman
(2004)&lt;/span&gt; for the methodological challenges of this task.&lt;/p&gt;
&lt;p&gt;In this post we show how such area cartograms can easily be created
with R using the packages &lt;code&gt;Rcartogram&lt;/code&gt; and
&lt;code&gt;getcartr&lt;/code&gt; together with the powerful packages
&lt;code&gt;sp&lt;/code&gt;, &lt;code&gt;rgeos&lt;/code&gt; and &lt;code&gt;rgdal&lt;/code&gt; for the
spatial data wrangling. Both &lt;code&gt;Rcartogram&lt;/code&gt; and
&lt;code&gt;getcartr&lt;/code&gt; are only available from github, because the
license of the underlying &lt;a
href=&quot;http://www-personal.umich.edu/~mejn/cart/&quot;&gt;&lt;code&gt;Cart&lt;/code&gt;&lt;/a&gt; C
fragment implementing the method of &lt;span class=&quot;citation&quot;
data-cites=&quot;gastner_newman2004&quot;&gt;Gastner and Newman (2004)&lt;/span&gt; does
not appear to be GPL (or the like) compatible.&lt;/p&gt;
&lt;h1 id=&quot;the-data&quot;&gt;The Data&lt;/h1&gt;
&lt;p&gt;We use population numbers for the 447 planning regions of Berlin
(Lebensweltlich orientierte Räume (LOR)). The boundaries of these
regions are available as ESRI Shapefile through the &lt;a
href=&quot;http://daten.berlin.de/datensaetze/rbs-lor-lebensweltlich-orientierte-r%C3%A4ume-dezember-2015&quot;&gt;open
data portal of Berlin&lt;/a&gt; under the CC BY license. The 2015 population
data of the LORs are available as CSV file through the same &lt;a
href=&quot;http://daten.berlin.de/datensaetze/einwohnerinnen-und-einwohner-berlin-lor-planungsr%C3%A4umen-am-31122015&quot;&gt;data
portal&lt;/a&gt;.&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb1&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb1-1&quot;&gt;&lt;a href=&quot;#cb1-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;tmpfile &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;paste0&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;tempfile&lt;/span&gt;(),&lt;span class=&quot;st&quot;&gt;&amp;quot;.zip&amp;quot;&lt;/span&gt;)&lt;/span&gt;
&lt;span id=&quot;cb1-2&quot;&gt;&lt;a href=&quot;#cb1-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;download.file&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;quot;https://www.statistik-berlin-brandenburg.de/opendata/RBS_OD_LOR_2015_12.zip&amp;quot;&lt;/span&gt;,&lt;span class=&quot;at&quot;&gt;destfile=&lt;/span&gt;tmpfile)&lt;/span&gt;
&lt;span id=&quot;cb1-3&quot;&gt;&lt;a href=&quot;#cb1-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;unzip&lt;/span&gt;(tmpfile,&lt;span class=&quot;at&quot;&gt;exdir=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;file.path&lt;/span&gt;(filePath,&lt;span class=&quot;st&quot;&gt;&amp;quot;RBS_OD_LOR_2015_12&amp;quot;&lt;/span&gt;))&lt;/span&gt;
&lt;span id=&quot;cb1-4&quot;&gt;&lt;a href=&quot;#cb1-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;download.file&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;quot;https://www.statistik-berlin-brandenburg.de/opendata/EWR201512E_Matrix.csv&amp;quot;&lt;/span&gt;,&lt;span class=&quot;at&quot;&gt;destfile=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;file.path&lt;/span&gt;(filePath,&lt;span class=&quot;st&quot;&gt;&amp;quot;EWR201512E_Matrix.csv&amp;quot;&lt;/span&gt;))&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;With the help of the &lt;code&gt;rgdal&lt;/code&gt;, &lt;code&gt;sp&lt;/code&gt; and the
&lt;code&gt;rgeos&lt;/code&gt; CRAN packages, R can be used as a &lt;a
href=&quot;https://en.wikipedia.org/wiki/Geographic_information_system&quot;&gt;geographic
information system (GIS)&lt;/a&gt;. This allows for easy merging of these two
data sources together with a spatial aggregation to the
&lt;strong&gt;Prognoseräume&lt;/strong&gt; level, which is a slightly higher level
of aggregation than the LORs (60 regions instead of 447). The output of
these data wrangling steps will be a SpatialPolygonsDataFrame object
&lt;code&gt;pgrs&lt;/code&gt; - see GitHub code for details.&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb2&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb2-1&quot;&gt;&lt;a href=&quot;#cb2-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;library&lt;/span&gt;(rgdal)&lt;/span&gt;
&lt;span id=&quot;cb2-2&quot;&gt;&lt;a href=&quot;#cb2-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;library&lt;/span&gt;(sp)&lt;/span&gt;
&lt;span id=&quot;cb2-3&quot;&gt;&lt;a href=&quot;#cb2-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;library&lt;/span&gt;(rgeos)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb3&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb3-1&quot;&gt;&lt;a href=&quot;#cb3-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##Read shapefile&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb3-2&quot;&gt;&lt;a href=&quot;#cb3-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;lor &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;readOGR&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;dsn=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;file.path&lt;/span&gt;(filePath,&lt;span class=&quot;st&quot;&gt;&amp;quot;RBS_OD_LOR_2015_12&amp;quot;&lt;/span&gt;),&lt;span class=&quot;at&quot;&gt;layer=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;RBS_OD_LOR_2015_12&amp;quot;&lt;/span&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;## OGR data source with driver: ESRI Shapefile 
## Source: &amp;quot;/Users/hoehle/Sandbox/Blog/figure/source/2016-10-10-cartograms//RBS_OD_LOR_2015_12&amp;quot;, layer: &amp;quot;RBS_OD_LOR_2015_12&amp;quot;
## with 447 features
## It has 8 fields&lt;/code&gt;&lt;/pre&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb5&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb5-1&quot;&gt;&lt;a href=&quot;#cb5-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;proj4string&lt;/span&gt;(lor)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;## [1] &amp;quot;+proj=utm +zone=33 +ellps=GRS80 +units=m +no_defs&amp;quot;&lt;/code&gt;&lt;/pre&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb7&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb7-1&quot;&gt;&lt;a href=&quot;#cb7-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##Compute area of each LOR in km^2 area (unit: meters -&amp;gt; convert to square km)&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb7-2&quot;&gt;&lt;a href=&quot;#cb7-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;lor&lt;span class=&quot;sc&quot;&gt;$&lt;/span&gt;area &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;gArea&lt;/span&gt;(lor, &lt;span class=&quot;at&quot;&gt;byid=&lt;/span&gt;&lt;span class=&quot;cn&quot;&gt;TRUE&lt;/span&gt;) &lt;span class=&quot;sc&quot;&gt;/&lt;/span&gt; (&lt;span class=&quot;fl&quot;&gt;1e6&lt;/span&gt;)&lt;/span&gt;
&lt;span id=&quot;cb7-3&quot;&gt;&lt;a href=&quot;#cb7-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb7-4&quot;&gt;&lt;a href=&quot;#cb7-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##Read population&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb7-5&quot;&gt;&lt;a href=&quot;#cb7-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;pop &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; readr&lt;span class=&quot;sc&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;read_csv2&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;file=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;file.path&lt;/span&gt;(filePath, &lt;span class=&quot;st&quot;&gt;&amp;quot;EWR201512E_Matrix.csv&amp;quot;&lt;/span&gt;))&lt;/span&gt;
&lt;span id=&quot;cb7-6&quot;&gt;&lt;a href=&quot;#cb7-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb7-7&quot;&gt;&lt;a href=&quot;#cb7-7&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##Merge SpatialPolygonsDataFrame with population information&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb7-8&quot;&gt;&lt;a href=&quot;#cb7-8&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;lor_pop &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;merge&lt;/span&gt;(lor, pop, &lt;span class=&quot;at&quot;&gt;by.x=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;PLR&amp;quot;&lt;/span&gt;,&lt;span class=&quot;at&quot;&gt;by.y=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;RAUMID&amp;quot;&lt;/span&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Plotting the result of the &lt;code&gt;pgrs&lt;/code&gt; object as an instance of
&lt;code&gt;SpatialPolygonsDataFrame&lt;/code&gt; can be done using the standard
&lt;code&gt;Spatial*&lt;/code&gt; plotting routines documented extensively in, e.g,
&lt;span class=&quot;citation&quot; data-cites=&quot;bivand_etal2008&quot;&gt;Bivand, Pebesma, and
Gómez-Rubio (2008)&lt;/span&gt; and its comprehensive &lt;a
href=&quot;http://www.asdar-book.org/&quot;&gt;webpage&lt;/a&gt;.&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb8&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb8-1&quot;&gt;&lt;a href=&quot;#cb8-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;######################################################################&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb8-2&quot;&gt;&lt;a href=&quot;#cb8-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;## Plotting the result, see nice tutorial by&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb8-3&quot;&gt;&lt;a href=&quot;#cb8-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;## http://www.nickeubank.com/wp-content/uploads/2015/10/RGIS3_MakingMaps_part1_mappingVectorData.html&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb8-4&quot;&gt;&lt;a href=&quot;#cb8-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;## or the Bivand et al. (2008) book - a must read!&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb8-5&quot;&gt;&lt;a href=&quot;#cb8-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;## Note: there is a 2nd edition available nowadays.&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb8-6&quot;&gt;&lt;a href=&quot;#cb8-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;######################################################################&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb8-7&quot;&gt;&lt;a href=&quot;#cb8-7&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb8-8&quot;&gt;&lt;a href=&quot;#cb8-8&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;library&lt;/span&gt;(RColorBrewer)&lt;/span&gt;
&lt;span id=&quot;cb8-9&quot;&gt;&lt;a href=&quot;#cb8-9&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;my.palette &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;brewer.pal&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;n =&lt;/span&gt; &lt;span class=&quot;dv&quot;&gt;6&lt;/span&gt;, &lt;span class=&quot;at&quot;&gt;name =&lt;/span&gt; &lt;span class=&quot;st&quot;&gt;&amp;quot;Purples&amp;quot;&lt;/span&gt;)&lt;/span&gt;
&lt;span id=&quot;cb8-10&quot;&gt;&lt;a href=&quot;#cb8-10&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##Helper function for making labels for each entry&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb8-11&quot;&gt;&lt;a href=&quot;#cb8-11&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;sp.label &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;cf&quot;&gt;function&lt;/span&gt;(x, label) {&lt;span class=&quot;fu&quot;&gt;list&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;quot;sp.text&amp;quot;&lt;/span&gt;, &lt;span class=&quot;fu&quot;&gt;coordinates&lt;/span&gt;(x), label,&lt;span class=&quot;at&quot;&gt;cex=&lt;/span&gt;&lt;span class=&quot;fl&quot;&gt;0.5&lt;/span&gt;)}&lt;/span&gt;
&lt;span id=&quot;cb8-12&quot;&gt;&lt;a href=&quot;#cb8-12&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;borderCol &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;st&quot;&gt;&amp;quot;white&amp;quot;&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb8-13&quot;&gt;&lt;a href=&quot;#cb8-13&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb8-14&quot;&gt;&lt;a href=&quot;#cb8-14&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;#Plot choropleth map&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb8-15&quot;&gt;&lt;a href=&quot;#cb8-15&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;spplot&lt;/span&gt;(pgrs, &lt;span class=&quot;st&quot;&gt;&amp;quot;density&amp;quot;&lt;/span&gt;, &lt;span class=&quot;at&quot;&gt;col.regions =&lt;/span&gt; my.palette, &lt;span class=&quot;at&quot;&gt;cuts =&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;length&lt;/span&gt;(my.palette)&lt;span class=&quot;sc&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;, &lt;span class=&quot;at&quot;&gt;col =&lt;/span&gt; borderCol,&lt;span class=&quot;at&quot;&gt;main=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;Choropleth map of Population Density&amp;quot;&lt;/span&gt;,&lt;span class=&quot;at&quot;&gt;sp.layout=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;sp.label&lt;/span&gt;(pgrs, pgrs&lt;span class=&quot;sc&quot;&gt;$&lt;/span&gt;EXTPGRNAME))&lt;/span&gt;
&lt;span id=&quot;cb8-16&quot;&gt;&lt;a href=&quot;#cb8-16&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;require&lt;/span&gt;(grid)&lt;/span&gt;
&lt;span id=&quot;cb8-17&quot;&gt;&lt;a href=&quot;#cb8-17&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;grid.text&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;expression&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;quot;Population density (Persons / &amp;quot;&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;~&lt;/span&gt;km&lt;span class=&quot;sc&quot;&gt;^&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;~&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;)&amp;quot;&lt;/span&gt;), &lt;span class=&quot;at&quot;&gt;x=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;unit&lt;/span&gt;(&lt;span class=&quot;fl&quot;&gt;0.95&lt;/span&gt;, &lt;span class=&quot;st&quot;&gt;&amp;quot;npc&amp;quot;&lt;/span&gt;), &lt;span class=&quot;at&quot;&gt;y=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;unit&lt;/span&gt;(&lt;span class=&quot;fl&quot;&gt;0.50&lt;/span&gt;, &lt;span class=&quot;st&quot;&gt;&amp;quot;npc&amp;quot;&lt;/span&gt;), &lt;span class=&quot;at&quot;&gt;rot=&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;90&lt;/span&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;img
src=&quot;http://staff.math.su.se/hoehle/blog/figure/source/2016-10-10-cartograms/CHOROPLETH-1.png&quot; /&gt;&lt;/p&gt;
&lt;h2 id=&quot;installing-the-cartogram-r-packages&quot;&gt;Installing the Cartogram R
packages&lt;/h2&gt;
&lt;p&gt;Two packages &lt;code&gt;Rcartogram&lt;/code&gt; and &lt;code&gt;getcartr&lt;/code&gt; make
the functionality of the &lt;span class=&quot;citation&quot;
data-cites=&quot;gastner_newman2004&quot;&gt;Gastner and Newman (2004)&lt;/span&gt;
procedure available for working with objects of class
&lt;code&gt;Spatial*&lt;/code&gt;. Installing &lt;code&gt;Rcartogram&lt;/code&gt; requires the
&lt;a href=&quot;http://www.fftw.org/&quot;&gt;&lt;code&gt;fftw&lt;/code&gt; library&lt;/a&gt; to be
installed. How to best do that depends on your system, for Mac OS X the
&lt;a href=&quot;http://brew.sh/&quot;&gt;homebrew package system&lt;/a&gt; makes this
installation easy.&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb9&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb9-1&quot;&gt;&lt;a href=&quot;#cb9-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##On command line in OS/X with homebrew. Wrapped in FALSE statement to not run system() unintentionally&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb9-2&quot;&gt;&lt;a href=&quot;#cb9-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;cf&quot;&gt;if&lt;/span&gt; (&lt;span class=&quot;cn&quot;&gt;FALSE&lt;/span&gt;) {&lt;/span&gt;
&lt;span id=&quot;cb9-3&quot;&gt;&lt;a href=&quot;#cb9-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;system&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;quot;brew install fftw&amp;quot;&lt;/span&gt;)&lt;/span&gt;
&lt;span id=&quot;cb9-4&quot;&gt;&lt;a href=&quot;#cb9-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;}&lt;/span&gt;
&lt;span id=&quot;cb9-5&quot;&gt;&lt;a href=&quot;#cb9-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##Install the R implementation of Cart by Gastner and Newman (2004)&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb9-6&quot;&gt;&lt;a href=&quot;#cb9-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;devtools&lt;span class=&quot;sc&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;install_github&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;quot;omegahat/Rcartogram&amp;quot;&lt;/span&gt;)&lt;/span&gt;
&lt;span id=&quot;cb9-7&quot;&gt;&lt;a href=&quot;#cb9-7&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;devtools&lt;span class=&quot;sc&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;install_github&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;#39;chrisbrunsdon/getcartr&amp;#39;&lt;/span&gt;,&lt;span class=&quot;at&quot;&gt;subdir=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;#39;getcartr&amp;#39;&lt;/span&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;We are now ready to compute our first cartogram using the
&lt;code&gt;getcartr::quick.carto&lt;/code&gt; function.&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb10&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb10-1&quot;&gt;&lt;a href=&quot;#cb10-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;library&lt;/span&gt;(Rcartogram)&lt;/span&gt;
&lt;span id=&quot;cb10-2&quot;&gt;&lt;a href=&quot;#cb10-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;library&lt;/span&gt;(getcartr)&lt;/span&gt;
&lt;span id=&quot;cb10-3&quot;&gt;&lt;a href=&quot;#cb10-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb10-4&quot;&gt;&lt;a href=&quot;#cb10-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##Make a cartogram&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb10-5&quot;&gt;&lt;a href=&quot;#cb10-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;pgrs_carto &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;quick.carto&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;spdf=&lt;/span&gt;pgrs,&lt;span class=&quot;at&quot;&gt;v=&lt;/span&gt;pgrs&lt;span class=&quot;sc&quot;&gt;$&lt;/span&gt;E_E,&lt;span class=&quot;at&quot;&gt;res=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;256&lt;/span&gt;)&lt;/span&gt;
&lt;span id=&quot;cb10-6&quot;&gt;&lt;a href=&quot;#cb10-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb10-7&quot;&gt;&lt;a href=&quot;#cb10-7&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##Display it using sp functionality&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb10-8&quot;&gt;&lt;a href=&quot;#cb10-8&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;spplot&lt;/span&gt;(pgrs_carto, &lt;span class=&quot;st&quot;&gt;&amp;quot;area&amp;quot;&lt;/span&gt;, &lt;span class=&quot;at&quot;&gt;col.regions =&lt;/span&gt; my.palette, &lt;span class=&quot;at&quot;&gt;cuts =&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;length&lt;/span&gt;(my.palette)&lt;span class=&quot;sc&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;, &lt;span class=&quot;at&quot;&gt;col =&lt;/span&gt; borderCol,&lt;span class=&quot;at&quot;&gt;main=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;Population Cartogram as Choropleth of Area&amp;quot;&lt;/span&gt;,&lt;span class=&quot;at&quot;&gt;sp.layout=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;sp.label&lt;/span&gt;(pgrs_carto, &lt;span class=&quot;at&quot;&gt;label=&lt;/span&gt;pgrs_carto&lt;span class=&quot;sc&quot;&gt;$&lt;/span&gt;EXTPGRNAME))&lt;/span&gt;
&lt;span id=&quot;cb10-9&quot;&gt;&lt;a href=&quot;#cb10-9&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;grid&lt;span class=&quot;sc&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;grid.text&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;expression&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;quot;Area (km&amp;quot;&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;^&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;)&amp;quot;&lt;/span&gt;), &lt;span class=&quot;at&quot;&gt;x=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;unit&lt;/span&gt;(&lt;span class=&quot;fl&quot;&gt;0.95&lt;/span&gt;, &lt;span class=&quot;st&quot;&gt;&amp;quot;npc&amp;quot;&lt;/span&gt;), &lt;span class=&quot;at&quot;&gt;y=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;unit&lt;/span&gt;(&lt;span class=&quot;fl&quot;&gt;0.50&lt;/span&gt;, &lt;span class=&quot;st&quot;&gt;&amp;quot;npc&amp;quot;&lt;/span&gt;), &lt;span class=&quot;at&quot;&gt;rot=&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;90&lt;/span&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;img
src=&quot;http://staff.math.su.se/hoehle/blog/figure/source/2016-10-10-cartograms/CARTOGRAM-1.png&quot; /&gt;&lt;/p&gt;
&lt;p&gt;With the cartogram functionality now being directly available through
R allows one to embedd cartogram making in a full R pipeline. We
illustrate this by generating a sequence of cartograms into an animated
GIF file using the &lt;code&gt;animation&lt;/code&gt; package. The animation below
shows a cartogram for the population size for each of the 32 age groups
in the Berlin data set. One observes that the 25-45 year old tend to
live in the city centre, while the 95-110 year old seem to concentrate
in the wealthy regions in the south west.&lt;/p&gt;
&lt;p&gt;&lt;img
src=&quot;/blog/figure/source/2016-10-10-cartograms/pop-cartograms.gif&quot; /&gt;&lt;/p&gt;
&lt;h1 id=&quot;outlook&quot;&gt;Outlook&lt;/h1&gt;
&lt;p&gt;While writing this posts some other useRs have posted on how to
create &lt;a
href=&quot;https://twitter.com/Victpir/status/785852075129315333&quot;&gt;interactive
cartograms&lt;/a&gt;.&lt;/p&gt;
&lt;h1 class=&quot;unnumbered&quot; id=&quot;references&quot;&gt;References&lt;/h1&gt;
&lt;div id=&quot;refs&quot; class=&quot;references csl-bib-body hanging-indent&quot;
data-entry-spacing=&quot;0&quot; role=&quot;list&quot;&gt;
&lt;div id=&quot;ref-bivand_etal2008&quot; class=&quot;csl-entry&quot; role=&quot;listitem&quot;&gt;
Bivand, R. S., E. J. Pebesma, and V. Gómez-Rubio. 2008. &lt;em&gt;Applied
Spatial Data Analysis with r&lt;/em&gt;. Springer-Verlag.
&lt;/div&gt;
&lt;div id=&quot;ref-gastner_newman2004&quot; class=&quot;csl-entry&quot; role=&quot;listitem&quot;&gt;
Gastner, Michael T., and M. E. J. Newman. 2004. &lt;span&gt;“Diffusion-Based
Method for Producing Density-Equalizing Maps.”&lt;/span&gt; &lt;em&gt;Proceedings of
the National Academy of Sciences of the United States of America&lt;/em&gt;
101 (20): 7499–7504. &lt;a
href=&quot;https://doi.org/10.1073/pnas.0400280101&quot;&gt;https://doi.org/10.1073/pnas.0400280101&lt;/a&gt;.
&lt;/div&gt;
&lt;div id=&quot;ref-zeileis_etal2009&quot; class=&quot;csl-entry&quot; role=&quot;listitem&quot;&gt;
Zeileis, Achim, Kurt Hornik, and Paul Murrell. 2009. &lt;span&gt;“Escaping
&lt;span&gt;RGBland&lt;/span&gt;: Selecting Colors for Statistical Graphics.”&lt;/span&gt;
&lt;em&gt;Computational Statistics &amp;amp; Data Analysis&lt;/em&gt; 53 (9): 3259–70.
https://doi.org/&lt;a
href=&quot;http://dx.doi.org/10.1016/j.csda.2008.11.033&quot;&gt;http://dx.doi.org/10.1016/j.csda.2008.11.033&lt;/a&gt;.
&lt;/div&gt;
&lt;/div&gt;
</description>
        <pubDate>Mon, 10 Oct 2016 00:00:00 +0200</pubDate>
        <link>https://mhoehle.github.io/blog/2016/10/10/cartograms.html</link>
        <guid isPermaLink="true">https://mhoehle.github.io/blog/2016/10/10/cartograms.html</guid>
        
        <category>dataviz</category>
        
        <category>rstats</category>
        
        <category>spatial</category>
        
        <category>GIS</category>
        
        
      </item>
    
      <item>
        <title>Surveillance Out of the Box - The #Zombie Experiment</title>
        <description>&lt;h2 id=&quot;abstract&quot;&gt;Abstract&lt;/h2&gt;
&lt;p&gt;We perform a social experiment to investigate, if zombie related
twitter posts can be used as a reliable indicator for an early warning
system. We show how such a system can be set up almost out-of-the-box
using R - a free software environment for statistical computing and
graphics. &lt;strong&gt;Warning&lt;/strong&gt;: This blog entry contains toxic doses
of Danish irony and sarcasm as well as disturbing graphs.
&lt;strong&gt;Update&lt;/strong&gt;: The blog post was extended with additional
data, graphs and text at 2016-11-03 00:08:27. Scroll to the end of the
post for details.&lt;/p&gt;
&lt;p&gt;&lt;br&gt;
&lt;a rel=&quot;license&quot; href=&quot;http://creativecommons.org/licenses/by-sa/4.0/&quot;&gt;&lt;img alt=&quot;Creative Commons License&quot; style=&quot;border-width:0&quot; src=&quot;https://i.creativecommons.org/l/by-sa/4.0/88x31.png&quot;/&gt;&lt;/a&gt;
This work is licensed under a &lt;a rel=&quot;license&quot;
href=&quot;http://creativecommons.org/licenses/by-sa/4.0/&quot;&gt;Creative Commons
Attribution-ShareAlike 4.0 International License&lt;/a&gt;. The
markdown+Rknitr source code of this blog is available under a &lt;a
href=&quot;https://www.gnu.org/licenses/gpl-3.0.html&quot;&gt;GNU General Public
License (GPL v3)&lt;/a&gt; license from github.&lt;/p&gt;
&lt;h2 id=&quot;introduction&quot;&gt;Introduction&lt;/h2&gt;
&lt;p&gt;Proposing statistical methods is only mediocre fun if nobody applies
them. As an act of desperation the prudent statistician has been forced
to provide R packages supplemented with a CRAN, github, useR! or
word-of-mouth advertising strategy. To underpin efforts, a
reproducibility-crisis has been announced in order to scare decent
comma-separated scientists &lt;a
href=&quot;https://www.washingtonpost.com/news/wonk/wp/2016/08/26/an-alarming-number-of-scientific-papers-contain-excel-errors/&quot;&gt;from
using Excel&lt;/a&gt;. Social media marketing strategies of your R package
include hashtag &lt;code&gt;#rstats&lt;/code&gt; twitter announcements, possibly
enhanced by a picture or animation showing your package at its best:&lt;/p&gt;
&lt;center&gt;
&lt;blockquote class=&quot;twitter-tweet&quot; data-lang=&quot;en&quot;&gt;
&lt;p lang=&quot;en&quot; dir=&quot;ltr&quot;&gt;
Introducing gganimate:
&lt;a href=&quot;https://twitter.com/hashtag/rstats?src=hash&quot;&gt;#rstats&lt;/a&gt;
package for adding animation to any ggplot2 figure
&lt;a href=&quot;https://t.co/UBWKHmIc0e&quot;&gt;https://t.co/UBWKHmIc0e&lt;/a&gt;
&lt;a href=&quot;https://t.co/oQhQaYBqOj&quot;&gt;pic.twitter.com/oQhQaYBqOj&lt;/a&gt;
&lt;/p&gt;
— David Robinson (@drob)
&lt;a href=&quot;https://twitter.com/drob/status/694274942813102080&quot;&gt;February 1,
2016&lt;/a&gt;
&lt;/blockquote&gt;
&lt;script async src=&quot;//platform.twitter.com/widgets.js&quot; charset=&quot;utf-8&quot;&gt;&lt;/script&gt;
&lt;/center&gt;
&lt;p&gt;
&lt;p&gt;Unfortunately, little experience with the interactive aspect of this
statistical software marketing strategy appears to be available. In
order to fill this scientific advertising gap, this blog post
constitutes an advertisement for the
&lt;strong&gt;out-of-the-box-functionality&lt;/strong&gt; of the
&lt;code&gt;surveillance&lt;/code&gt; package hidden as social experiment. It shows
shows what you can do with R when combining a couple of packages,
wrangle the data, cleverly visualize the results and then team up with
the fantastic R community.&lt;/p&gt;
&lt;h2 id=&quot;the-setup-detecting-a-zombie-attack&quot;&gt;The Setup: Detecting a
Zombie Attack&lt;/h2&gt;
&lt;p&gt;As previously explained in an &lt;a
href=&quot;http://user2015.math.aau.dk/lightning_talks&quot;&gt;useR! 2015 lightning
talk&lt;/a&gt;, Max Brooks’ &lt;a
href=&quot;https://en.wikipedia.org/wiki/The_Zombie_Survival_Guide&quot;&gt;Zombie
Survival Guide&lt;/a&gt; is very concerned about the &lt;strong&gt;early
warning&lt;/strong&gt; of Zombie outbreaks.&lt;/p&gt;
&lt;center&gt;
&lt;a
href=&quot;http://staff.math.su.se/hoehle/software/surveillance/hoehle-userR2015-web.pdf&quot;&gt;&lt;img src=&quot;/blog/figure/source/2016-09-25-sootb/zombiepreparedness.png&quot;&gt;&lt;/a&gt;
&lt;/center&gt;
&lt;p&gt;&lt;br&gt;&lt;/p&gt;
&lt;p&gt;However, despite of extensive research and recommendations, no
reliable service appears available for the early detection of such
upcoming events. Twitter, on the other hand, has become the media
darling to stay informed about news as they unfold. Hence, continuous
monitoring of hashtags like &lt;code&gt;#zombie&lt;/code&gt; or
&lt;code&gt;#zombieattack&lt;/code&gt; appears an essential component of your zombie
survival strategy.&lt;/p&gt;
&lt;h1 id=&quot;tight-clothes-short-hair-and-r&quot;&gt;Tight Clothes, Short Hair and
R&lt;/h1&gt;
&lt;p&gt;Extending the recommendations of the Zombie Survival guide we provide
an out-of-the-box (OOTB) monitoring system by using the
&lt;code&gt;rtweet&lt;/code&gt; R package to obtain all individual tweets containing
the hashtags &lt;code&gt;#zombie&lt;/code&gt; or &lt;code&gt;#zombieattack&lt;/code&gt;.&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb1&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb1-1&quot;&gt;&lt;a href=&quot;#cb1-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;the_query &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;st&quot;&gt;&amp;quot;#zombieattack OR #zombie&amp;quot;&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-2&quot;&gt;&lt;a href=&quot;#cb1-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;geocode &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;st&quot;&gt;&amp;quot;&amp;quot;&lt;/span&gt;  &lt;span class=&quot;co&quot;&gt;#To limit the seach to berlin &amp;amp; surroundings: geocode &amp;lt;- &amp;quot;52.520583,13.402765,25km&amp;quot;&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-3&quot;&gt;&lt;a href=&quot;#cb1-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;#Converted query string which works for storing as file&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-4&quot;&gt;&lt;a href=&quot;#cb1-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;safe_query &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; stringr&lt;span class=&quot;sc&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;str_replace_all&lt;/span&gt;(the_query, &lt;span class=&quot;st&quot;&gt;&amp;quot;[^[:alnum:]]&amp;quot;&lt;/span&gt;, &lt;span class=&quot;st&quot;&gt;&amp;quot;X&amp;quot;&lt;/span&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;In particular, the &lt;a
href=&quot;https://github.com/mkearney/rtweet&quot;&gt;README&lt;/a&gt; of the
&lt;code&gt;rtweet&lt;/code&gt; package provides helpful information on how to
create a twitter app to automatically search tweets using the twitter
API. One annoyance of the twitter REST API is that only the tweets of
the past 7 days are kept in the index. Hence, your time series are going
to be short unless you accumulate data over several queries spread over
a time period. Instead of using a fancy database setup for this data
collection, we provide a simple R solution based on &lt;code&gt;dplyr&lt;/code&gt;
and &lt;code&gt;saveRDS&lt;/code&gt; - see the underlying R code of this post by
clicking on the github logo in the license statement of this post.
Basically,&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;all tweets fulfilling the above hashtag search queries are
extracted&lt;/li&gt;
&lt;li&gt;each tweet is extended with a time stamp of the query-time&lt;/li&gt;
&lt;li&gt;the entire result of each query us stored into a separate RDS-files
using &lt;code&gt;saveRDS&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;In a next step, all stored queries are loaded from the RDS files and
put together. Subsequently, only the newest time stamped entry about
each tweet is kept - this ensures that the re-tweeted counts are
up-to-date and no post is counted twice. All these data wrangling
operations are easily conducted using &lt;code&gt;dplyr&lt;/code&gt;. Of course a
full database solution would have been more elegant, but R does the job
just as well as long it’s not millions of queries. Actually, in the
example we are going to use the results of a single query. No matter the
data backend, at the end of this pipeline we have a database of
tweets.&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb2&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb2-1&quot;&gt;&lt;a href=&quot;#cb2-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;#Read the tweet database&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb2-2&quot;&gt;&lt;a href=&quot;#cb2-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;tw &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;readRDS&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;file=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;paste0&lt;/span&gt;(filePath,&lt;span class=&quot;st&quot;&gt;&amp;quot;Tweets-Database-&amp;quot;&lt;/span&gt;,safe_query,&lt;span class=&quot;st&quot;&gt;&amp;quot;-&amp;quot;&lt;/span&gt;,&lt;span class=&quot;st&quot;&gt;&amp;quot;2016-09-25&amp;quot;&lt;/span&gt;,&lt;span class=&quot;st&quot;&gt;&amp;quot;.RDS&amp;quot;&lt;/span&gt;))&lt;/span&gt;
&lt;span id=&quot;cb2-3&quot;&gt;&lt;a href=&quot;#cb2-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;options&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;width=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;300&lt;/span&gt;,&lt;span class=&quot;at&quot;&gt;tibble.width =&lt;/span&gt; &lt;span class=&quot;cn&quot;&gt;Inf&lt;/span&gt;)&lt;/span&gt;
&lt;span id=&quot;cb2-4&quot;&gt;&lt;a href=&quot;#cb2-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;tw &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;select&lt;/span&gt;(created_at, retweet_count,screen_name,text,hashtags,query_at)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;## # A tibble: 10,974 × 6
##             created_at retweet_count    screen_name                                                                                                                                          text  hashtags            query_at
##                 &amp;lt;dttm&amp;gt;         &amp;lt;int&amp;gt;          &amp;lt;chr&amp;gt;                                                                                                                                         &amp;lt;chr&amp;gt;    &amp;lt;list&amp;gt;              &amp;lt;dttm&amp;gt;
## 1  2016-09-25 10:26:28             0       Lovebian                                               The latest #Zombie Nation! https://t.co/8ZkOFSZH2v Thanks to @NJTVNews @MaxfireXSA @Xtopgun901X &amp;lt;chr [1]&amp;gt; 2016-09-25 10:30:44
## 2  2016-09-25 10:25:49             2  MilesssAwaaay RT @Shaaooun: I&amp;#39;m gonna turn to a zombie soon! xdxdxdxd #AlmostSurvived #204Days #ITried #Zombie #StuckInMyRoom #Haha\n\n#MediaDoomsDay #Kame &amp;lt;chr [7]&amp;gt; 2016-09-25 10:30:44
## 3  2016-09-25 10:21:10             6 catZzinthecity          RT @ZombieEventsUK: 7 reasons #TheGirlWithAllTheGifts is the best #zombie movie in years https://t.co/MB82ssxss2 via @MetroUK #Metro &amp;lt;chr [3]&amp;gt; 2016-09-25 10:30:44
## 4  2016-09-25 10:19:41             0  CoolStuff2Get                             Think Geek Zombie Plush Slippers https://t.co/0em920WCMh #Zombie #Slippers #MyFeetAreCold https://t.co/iCEkPBykCa &amp;lt;chr [3]&amp;gt; 2016-09-25 10:30:44
## 5  2016-09-25 10:19:41             4  TwitchersNews    RT @zOOkerx: Nur der frhe Vogel fngt den #zombie also schaut gemtlich rein bei @booty_pax! Now live #dayz on #twitch \n\nhttps://t.co/OIk6 &amp;lt;chr [3]&amp;gt; 2016-09-25 10:30:44
## 6  2016-09-25 10:17:45             0 ZombieExaminer     Washington mall shooting suspect Arcan Cetin was &amp;#39;#Zombie-like&amp;#39; during arrest - USA TODAY https://t.co/itoDXG3L8T https://t.co/q2mURi24DB &amp;lt;chr [1]&amp;gt; 2016-09-25 10:30:44
## 7  2016-09-25 10:17:44             4       SpawnRTs    RT @zOOkerx: Nur der frhe Vogel fngt den #zombie also schaut gemtlich rein bei @booty_pax! Now live #dayz on #twitch \n\nhttps://t.co/OIk6 &amp;lt;chr [3]&amp;gt; 2016-09-25 10:30:44
## 8  2016-09-25 10:17:23             0   BennyPrabowo                   bad miku - bad oni-chan... no mercy\n.\n.\n.\n.\n#left4dead #games #hatsunemiku #fps #zombie #witch https://t.co/YP0nRDFFj7 &amp;lt;chr [6]&amp;gt; 2016-09-25 10:30:44
## 9  2016-09-25 10:12:53            62   Nblackthorne  RT @PennilessScribe: He would end her pain, but he could no longer live in a world that demanded such sacrifice. #zombie #apocalypse\nhttps: &amp;lt;chr [2]&amp;gt; 2016-09-25 10:30:44
## 10 2016-09-25 10:06:46             0   mthvillaalva                                                             Pak ganern!!! Kakatapos ko lang kumain ng dugo! \n#Zombie https://t.co/Zyd0btVJH4 &amp;lt;chr [1]&amp;gt; 2016-09-25 10:30:44
## # ... with 10,964 more rows&lt;/code&gt;&lt;/pre&gt;
&lt;h3 id=&quot;ootb-zombie-surveillance&quot;&gt;OOTB Zombie Surveillance&lt;/h3&gt;
&lt;p&gt;We are now ready to prospectively detect changes using the
&lt;code&gt;surveillance&lt;/code&gt; R package &lt;span class=&quot;citation&quot;
data-cites=&quot;salmon_etal2016a&quot;&gt;(Salmon, Schumacher, and Höhle
2016)&lt;/span&gt;.&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb4&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb4-1&quot;&gt;&lt;a href=&quot;#cb4-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;library&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;quot;surveillance&amp;quot;&lt;/span&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;We shall initially focus on the &lt;code&gt;#zombie&lt;/code&gt; series as it
contains more counts. The first step is to convert the
&lt;code&gt;data.frame&lt;/code&gt; of individual tweets into a time series of daily
counts.&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb5&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb5-1&quot;&gt;&lt;a href=&quot;#cb5-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;#&amp;#39; Function to convert data.frame to queries. For convenience we store the time series&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb5-2&quot;&gt;&lt;a href=&quot;#cb5-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;#&amp;#39; and the data.frame jointly as a list. This allows for easy manipulations later on&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb5-3&quot;&gt;&lt;a href=&quot;#cb5-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;#&amp;#39; as we see data.frame and time series to be a joint package.&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb5-4&quot;&gt;&lt;a href=&quot;#cb5-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;#&amp;#39;&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb5-5&quot;&gt;&lt;a href=&quot;#cb5-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;#&amp;#39; @param tw data.frame containing the linelist of tweets.&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb5-6&quot;&gt;&lt;a href=&quot;#cb5-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;#&amp;#39; @param the_query_subset String containing a regexp to restrict the hashtags&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb5-7&quot;&gt;&lt;a href=&quot;#cb5-7&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;#&amp;#39; @param delete_first_day (boolean) Delete first day of the series due to it being incomplete&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb5-8&quot;&gt;&lt;a href=&quot;#cb5-8&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;#&amp;#39; @return List containing sts object as well as the original data frame.&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb5-9&quot;&gt;&lt;a href=&quot;#cb5-9&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;#&amp;#39;&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb5-10&quot;&gt;&lt;a href=&quot;#cb5-10&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;df_2_timeseries &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;cf&quot;&gt;function&lt;/span&gt;(tw, the_query_subset, &lt;span class=&quot;at&quot;&gt;delete_first_day=&lt;/span&gt;&lt;span class=&quot;cn&quot;&gt;TRUE&lt;/span&gt;) {&lt;/span&gt;
&lt;span id=&quot;cb5-11&quot;&gt;&lt;a href=&quot;#cb5-11&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  tw_subset &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; tw &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;filter&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;grepl&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;gsub&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;quot;#&amp;quot;&lt;/span&gt;,&lt;span class=&quot;st&quot;&gt;&amp;quot;&amp;quot;&lt;/span&gt;,the_query_subset),hashtags))&lt;/span&gt;
&lt;span id=&quot;cb5-12&quot;&gt;&lt;a href=&quot;#cb5-12&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb5-13&quot;&gt;&lt;a href=&quot;#cb5-13&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;co&quot;&gt;#Aggregate data per day and convert times series to sts object&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb5-14&quot;&gt;&lt;a href=&quot;#cb5-14&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  ts &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; surveillance&lt;span class=&quot;sc&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;linelist2sts&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;as.data.frame&lt;/span&gt;(tw_subset), &lt;span class=&quot;at&quot;&gt;dateCol=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;created_at_Date&amp;quot;&lt;/span&gt;, &lt;span class=&quot;at&quot;&gt;aggregate.by=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;1 day&amp;quot;&lt;/span&gt;)&lt;/span&gt;
&lt;span id=&quot;cb5-15&quot;&gt;&lt;a href=&quot;#cb5-15&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;co&quot;&gt;#Drop first day with observations, due to the moving window of the twitter index, this count is incomplete&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb5-16&quot;&gt;&lt;a href=&quot;#cb5-16&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;cf&quot;&gt;if&lt;/span&gt; (delete_first_day) ts &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; ts[&lt;span class=&quot;sc&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;,]&lt;/span&gt;
&lt;span id=&quot;cb5-17&quot;&gt;&lt;a href=&quot;#cb5-17&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb5-18&quot;&gt;&lt;a href=&quot;#cb5-18&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;return&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;list&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;tw=&lt;/span&gt;tw_subset,&lt;span class=&quot;at&quot;&gt;ts=&lt;/span&gt;ts, &lt;span class=&quot;at&quot;&gt;the_query_subset=&lt;/span&gt;the_query_subset))&lt;/span&gt;
&lt;span id=&quot;cb5-19&quot;&gt;&lt;a href=&quot;#cb5-19&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;}&lt;/span&gt;
&lt;span id=&quot;cb5-20&quot;&gt;&lt;a href=&quot;#cb5-20&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb5-21&quot;&gt;&lt;a href=&quot;#cb5-21&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;zombie &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;df_2_timeseries&lt;/span&gt;(tw, &lt;span class=&quot;at&quot;&gt;the_query_subset =&lt;/span&gt; &lt;span class=&quot;st&quot;&gt;&amp;quot;#zombie&amp;quot;&lt;/span&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;It’s easy to visualize the resulting time series using the plotting
functionality of the surveillance package.&lt;/p&gt;
&lt;p&gt;&lt;img
src=&quot;http://staff.math.su.se/hoehle/blog/figure/source/2016-09-25-sootb/unnamed-chunk-9-1.png&quot; /&gt;&lt;/p&gt;
&lt;p&gt;We see that the counts on the last day are incomplete. This is
because the query was performed at 10:30 CEST and not at midnight. We
therefore adjust counts on the last day based on simple inverse
probability weighting. This just means that we scale up the counts by
the inverse of the fraction the query-hour (10:30 CEST) makes up of 24h
(see github code for details). The usefulness of this adjustment relies
on the assumption that queries are evenly distributed over the day.&lt;/p&gt;
&lt;p&gt;We are now ready to apply a surveillance algorithm to the
pre-processed time series. We shall pick the so called C1 version of the
EARS algorithm documented in &lt;span class=&quot;citation&quot;
data-cites=&quot;hutwagner_etal2003&quot;&gt;Hutwagner et al. (2003)&lt;/span&gt; or &lt;span
class=&quot;citation&quot; data-cites=&quot;fricker_etal2008&quot;&gt;Fricker, Hegler, and
Dunfee (2008)&lt;/span&gt;. For a monitored time point &lt;span
class=&quot;math inline&quot;&gt;\(s\)&lt;/span&gt; (here: a particular day, say,
2016-09-23), this simple algorithm takes the previous seven observations
before &lt;span class=&quot;math inline&quot;&gt;\(s\)&lt;/span&gt; in order to compute the
mean and standard deviation, i.e. &lt;span class=&quot;math display&quot;&gt;\[
\begin{align*}
\bar{y}_s             &amp;amp;= \frac{1}{7} \sum_{t=s-8}^{s-1} y_t, \\
\operatorname{sd}_s^2   &amp;amp;= \frac{1}{7-1} \sum_{t=s-8}^{s-1} (y_t -
\bar{y}_s)^2.
\end{align*}
\]&lt;/span&gt; The algorithm then computes the z-statistic &lt;span
class=&quot;math inline&quot;&gt;\(\operatorname{C1}_s = (y_s -
\bar{y}_s)/\operatorname{sd}_s\)&lt;/span&gt; for each time point to monitor.
Once the value of this statistic is above 3 an alarm is flagged. This
means that we assume that the previous 7 observations are what is to be
expected when no unusual activity is going on. One can interpret the
statistic as a transformation to (standard) normality: once the current
observation is too extreme under this model an alarm is sounded. Such
normal-approximations are justified given the large number of daily
counts in the zombie series we consider, but does not take secular
trends or day of the week effects into account. Note also that the
calculations can also be reversed in order to determine how large the
number of observations needs to be in order to generate an alarm (shown
as a red line in the graph).&lt;/p&gt;
&lt;p&gt;We now apply the EARS C1 monitoring procedure to the zombie time
series starting at the 8th day of the time series. It is important to
realize that the result of monitoring a time point in the graphic is
obtained by only &lt;strong&gt;looking into the past&lt;/strong&gt;. Hence, the
relevant time point to consider today is if an alarm would have occurred
2016-09-25. We also show the other time points to see, if we could have
detected potential alarms earlier.&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb6&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb6-1&quot;&gt;&lt;a href=&quot;#cb6-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;zombie[[&lt;span class=&quot;st&quot;&gt;&amp;quot;sts&amp;quot;&lt;/span&gt;]] &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;earsC&lt;/span&gt;(zombie&lt;span class=&quot;sc&quot;&gt;$&lt;/span&gt;ts, &lt;span class=&quot;at&quot;&gt;control=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;list&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;range =&lt;/span&gt; &lt;span class=&quot;dv&quot;&gt;8&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;nrow&lt;/span&gt;(zombie&lt;span class=&quot;sc&quot;&gt;$&lt;/span&gt;ts),&lt;/span&gt;
&lt;span id=&quot;cb6-2&quot;&gt;&lt;a href=&quot;#cb6-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;                         &lt;span class=&quot;at&quot;&gt;method =&lt;/span&gt; &lt;span class=&quot;st&quot;&gt;&amp;quot;C1&amp;quot;&lt;/span&gt;, &lt;span class=&quot;at&quot;&gt;alpha =&lt;/span&gt; &lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;pnorm&lt;/span&gt;(&lt;span class=&quot;dv&quot;&gt;3&lt;/span&gt;)))&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;img
src=&quot;http://staff.math.su.se/hoehle/blog/figure/source/2016-09-25-sootb/ZOMBIE-TS-1.png&quot; /&gt;&lt;/p&gt;
&lt;p&gt;What a relief! No suspicious zombie activity appears to be ongoing.
Actually, it would have taken 511 additional tweets before we would have
raised an alarm on 2016-09-25. This is quite a number.&lt;/p&gt;
&lt;p&gt;As an additional sensitivity analysis we redo the analyses for the
&lt;code&gt;#zombieattack&lt;/code&gt; hashtag. Here the use of the normal
approximation in the computation of the alerts is more questionable.
Still, we can get a time series of counts together with the alarm
limits.&lt;/p&gt;
&lt;p&gt;&lt;img
src=&quot;http://staff.math.su.se/hoehle/blog/figure/source/2016-09-25-sootb/ZOMBIEATTACK-TS-1.png&quot; /&gt;&lt;/p&gt;
&lt;p&gt;Also no indication of zombie activity. The number of additional
tweets needed before alarm in this case is: 21. Altogether, it looks
safe out there…&lt;/p&gt;
&lt;h2 id=&quot;summary&quot;&gt;Summary&lt;/h2&gt;
&lt;p&gt;R provides ideal functionality to quickly extract and monitor twitter
time series. Combining with statistical process control methods allows
you to prospectively monitor the use of hashtags. Twitter has released a
dedicated package for this purpose, however, in case of low count time
series it is better to use count-time series monitoring devices as
implemented in the &lt;code&gt;surveillance&lt;/code&gt; package. &lt;span
class=&quot;citation&quot; data-cites=&quot;salmon_etal2016a&quot;&gt;Salmon, Schumacher, and
Höhle (2016)&lt;/span&gt; contains further details on how to proceed in this
case.&lt;/p&gt;
&lt;p&gt;The important question although remains: Does this really work in
practice? Can you sleep tight, while your R zombie monitor scans
twitter? Here is where the &lt;strong&gt;social experiment&lt;/strong&gt; starts:
Please help by retweeting the post below to create a drill alarm
situation. More than 511 (!) and 21 additional tweets, respectively, are
needed before an alarm will sound.&lt;/p&gt;
&lt;center&gt;
&lt;blockquote class=&quot;twitter-tweet&quot; data-lang=&quot;de&quot;&gt;
&lt;p lang=&quot;en&quot; dir=&quot;ltr&quot;&gt;
New blog entry: Please RT to help me evaluate my
&lt;a href=&quot;https://twitter.com/hashtag/zombie?src=hash&quot;&gt;#zombie&lt;/a&gt;
monitoring system -
&lt;a href=&quot;https://t.co/b0gNfpJ0RM&quot;&gt;https://t.co/b0gNfpJ0RM&lt;/a&gt;
&lt;a href=&quot;https://twitter.com/hashtag/zombieattack?src=hash&quot;&gt;#zombieattack&lt;/a&gt;
&lt;a href=&quot;https://twitter.com/hashtag/biosurveillance?src=hash&quot;&gt;#biosurveillance&lt;/a&gt;
&lt;a href=&quot;https://twitter.com/hashtag/rstats?src=hash&quot;&gt;#rstats&lt;/a&gt;
&lt;a href=&quot;https://t.co/N3PTZBnaw4&quot;&gt;pic.twitter.com/N3PTZBnaw4&lt;/a&gt;
&lt;/p&gt;
— Michael Höhle (@m_hoehle)
&lt;a href=&quot;https://twitter.com/m_hoehle/status/780037067183157248&quot;&gt;25.
September 2016&lt;/a&gt;
&lt;/blockquote&gt;
&lt;script async src=&quot;//platform.twitter.com/widgets.js&quot; charset=&quot;utf-8&quot;&gt;&lt;/script&gt;
&lt;/center&gt;
&lt;p&gt;I will continuously update the graphs in this post to see how our
efforts are reflected in the time series of tweets containing the
&lt;code&gt;#zombieattack&lt;/code&gt; and &lt;code&gt;#zombie&lt;/code&gt; hashtags. Thanks for
your help!&lt;/p&gt;
&lt;p&gt;
&lt;center&gt;
&lt;img src=&quot;/blog/figure/source/2016-09-25-sootb/zombie.png&quot;
title=&quot;Source: https://openclipart.org/detail/201838/zombie-head&quot; /&gt;
&lt;img src=&quot;/blog/figure/source/2016-09-25-sootb/zombie.png&quot;
title=&quot;Source: https://openclipart.org/detail/201838/zombie-head&quot; /&gt;
&lt;img src=&quot;/blog/figure/source/2016-09-25-sootb/zombie.png&quot;
title=&quot;Source: https://openclipart.org/detail/201838/zombie-head&quot; /&gt;
&lt;/center&gt;
&lt;p&gt;
&lt;p&gt;
&lt;h3 id=&quot;update-at-2016-11-03-000831&quot;&gt;Update at 2016-11-03 00:08:31&lt;/h3&gt;
&lt;p&gt;Below we show how the &lt;code&gt;#zombieattack&lt;/code&gt; series developed
after the post was made public:&lt;/p&gt;
&lt;p&gt;&lt;img
src=&quot;http://staff.math.su.se/hoehle/blog/figure/source/2016-09-25-sootb/ZOMBIEATTACK_UPDATED-1.png&quot; /&gt;&lt;/p&gt;
&lt;p&gt;The orange part of the bars indicates the fake outbreak tweet (1) as
well as its retweets (10). It is obvious that despite the increased
activity due to the fake outbreak tweets, no alarm was generated because
of them. In parts this is explained by the high activity during 20-21
Sep. A previous outbreak? No, advertisements of &lt;a
href=&quot;https://www.etsy.com/listing/480088383/zombie-pin-up-badges-zombie-themed-gifts?ref=shop_home_feat_4&quot;&gt;zombie
pinup badges on etsy&lt;/a&gt;. Since the EARS algorithm sequentially
estimates the variance of the baseline counts, the peak on 20-21 Sep
inflates the mean and variance and thus results in a high upperbound as
long as it enters the baseline. Despite some extra activity 25-27 Sep
due to the fake outbreak tweets, none of the days are above this bound.
However, once the 20-21 Sep peak is out of the previous 7 days baseline,
the alarm threshold decreases noticeably. We thus get an alarm for the
peak on 30 September, even though it’s not higher than the previous peak
on 20-21 Sep and it appears to be caused by other phenomena not related
to our fake outbreak. A more careful analysis of the tweets reveals that
they are caused by a &lt;a
href=&quot;http://charityfunrun2016.tumblr.com/post/149930159797/charity-fun-run-2016&quot;&gt;charity
fun run&lt;/a&gt; near Kuala Lumpur with a &lt;a
href=&quot;https://www.instagram.com/p/BK-_l8oDD38/&quot;&gt;zombie attack
theme&lt;/a&gt;!&lt;/p&gt;
&lt;p&gt;
&lt;blockquote class=&quot;twitter-tweet&quot; data-lang=&quot;en&quot;&gt;
&lt;p lang=&quot;en&quot; dir=&quot;ltr&quot;&gt;
SPAM FAM 😋
&lt;a href=&quot;https://twitter.com/hashtag/zombieattack?src=hash&quot;&gt;#zombieattack&lt;/a&gt;
&lt;a href=&quot;https://twitter.com/hashtag/charityfunrun2016?src=hash&quot;&gt;#charityfunrun2016&lt;/a&gt;
&lt;a href=&quot;https://t.co/YJW8Mjpd0L&quot;&gt;pic.twitter.com/YJW8Mjpd0L&lt;/a&gt;
&lt;/p&gt;
— PAAN (@noorfarhan_)
&lt;a href=&quot;https://twitter.com/noorfarhan_/status/781887252519460864&quot;&gt;September
30, 2016&lt;/a&gt;
&lt;/blockquote&gt;
&lt;script async src=&quot;//platform.twitter.com/widgets.js&quot; charset=&quot;utf-8&quot;&gt;&lt;/script&gt;
&lt;p&gt;
&lt;p&gt;For further comparison, we also use a negative binomial CUSUM, which
keeps the baseline steady, but allows the detection of sustained
increases.&lt;/p&gt;
&lt;p&gt;&lt;img
src=&quot;http://staff.math.su.se/hoehle/blog/figure/source/2016-09-25-sootb/ZOMBIEUPDATE-NBINOM-CUSUM-PLOT-1.png&quot; /&gt;&lt;/p&gt;
&lt;p&gt;The gray line shows the estimated mean from the eight base-line
counts, the orange line shows the corresponding upper 99% quantile of
this estimated distribution. The red line shows the alarm limit of a
CUSUM method where the potential shift in the mean is estimated by
maximum likelihood at each monitoring instance. The threshold is tuned
such that it initially roughly coincides with the 99% quantile of the
estimated distribution. Here, no signal is detected. Of course this
depends on the quantile used for the detection and the 20-21 September
peak being included fully in the baseline. Still, according to this
metric occasional fake zombie runs are part of the routine.&lt;/p&gt;
&lt;p&gt;Altogether, the “failed”” test proves several points:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;its hard to distinguish between previous outbreaks and irregular
tweeting behaviour&lt;/li&gt;
&lt;li&gt;robust estimation of the baseline parameters might be needed&lt;/li&gt;
&lt;li&gt;the results are sensitive to the choice of which values to include
in the baseline and the underlying probability model&lt;/li&gt;
&lt;li&gt;is twitter monitoring really sensitive enough to detect weak signals
early enough?&lt;/li&gt;
&lt;/ul&gt;
&lt;h4 id=&quot;the-take-home-message-of-this-update&quot;&gt;The take home message of
this update&lt;/h4&gt;
&lt;p&gt;To enhance statistical competence and preserve sleep: stick with the
negative binomial CUSUM!&lt;/p&gt;
&lt;h1 class=&quot;unnumbered&quot; id=&quot;references&quot;&gt;References&lt;/h1&gt;
&lt;div id=&quot;refs&quot; class=&quot;references csl-bib-body hanging-indent&quot;
data-entry-spacing=&quot;0&quot; role=&quot;list&quot;&gt;
&lt;div id=&quot;ref-fricker_etal2008&quot; class=&quot;csl-entry&quot; role=&quot;listitem&quot;&gt;
Fricker, R. D., B. L. Hegler, and D. A. Dunfee. 2008. &lt;span&gt;“&lt;span
class=&quot;nocase&quot;&gt;&lt;span&gt;C&lt;/span&gt;omparing syndromic surveillance detection
methods: &lt;span&gt;E&lt;/span&gt;&lt;span&gt;A&lt;/span&gt;&lt;span&gt;R&lt;/span&gt;&lt;span&gt;S&lt;/span&gt;’
versus a
&lt;span&gt;C&lt;/span&gt;&lt;span&gt;U&lt;/span&gt;&lt;span&gt;S&lt;/span&gt;&lt;span&gt;U&lt;/span&gt;&lt;span&gt;M&lt;/span&gt;-based
methodology&lt;/span&gt;.”&lt;/span&gt; &lt;em&gt;Stat Med&lt;/em&gt; 27 (17): 3407–29.
&lt;/div&gt;
&lt;div id=&quot;ref-hutwagner_etal2003&quot; class=&quot;csl-entry&quot; role=&quot;listitem&quot;&gt;
Hutwagner, L., W. Thompson, G. M. Seeman, and T. Treadwell. 2003.
&lt;span&gt;“&lt;span class=&quot;nocase&quot;&gt;&lt;span&gt;T&lt;/span&gt;he bioterrorism preparedness
and response &lt;span&gt;E&lt;/span&gt;arly &lt;span&gt;A&lt;/span&gt;berration
&lt;span&gt;R&lt;/span&gt;eporting &lt;span&gt;S&lt;/span&gt;ystem
(&lt;span&gt;E&lt;/span&gt;&lt;span&gt;A&lt;/span&gt;&lt;span&gt;R&lt;/span&gt;&lt;span&gt;S&lt;/span&gt;)&lt;/span&gt;.”&lt;/span&gt;
&lt;em&gt;J Urban Health&lt;/em&gt; 80 (2 Suppl 1): 89–96.
&lt;/div&gt;
&lt;div id=&quot;ref-salmon_etal2016a&quot; class=&quot;csl-entry&quot; role=&quot;listitem&quot;&gt;
Salmon, M., D. Schumacher, and M. Höhle. 2016. &lt;span&gt;“Monitoring Count
Time Series in &lt;span&gt;R&lt;/span&gt;: Aberration Detection in Public Health
Surveillance.”&lt;/span&gt; &lt;em&gt;Journal of Statistical Software&lt;/em&gt; 70 (10).
&lt;a
href=&quot;https://doi.org/10.18637/jss.v070.i10&quot;&gt;https://doi.org/10.18637/jss.v070.i10&lt;/a&gt;.
&lt;/div&gt;
&lt;/div&gt;
</description>
        <pubDate>Sun, 25 Sep 2016 00:00:00 +0200</pubDate>
        <link>https://mhoehle.github.io/blog/2016/09/25/sootb.html</link>
        <guid isPermaLink="true">https://mhoehle.github.io/blog/2016/09/25/sootb.html</guid>
        
        <category>datascience</category>
        
        <category>rstats</category>
        
        <category>statistical process control</category>
        
        <category>biosurveillance</category>
        
        
      </item>
    
      <item>
        <title>The Olympic Medal Table Visualized Gapminder Style</title>
        <description>&lt;h2 id=&quot;abstract&quot;&gt;Abstract&lt;/h2&gt;
&lt;p&gt;Following Hans Rosling’s Gapminder animation style we visualize the
total number of medals a country wins during each olympic summer games
in relation to the country’s &lt;a
href=&quot;https://en.wikipedia.org/wiki/Gross_domestic_product&quot;&gt;gross
domestic product&lt;/a&gt; (GDP) per capita. We illustrate how R’s data
wrangling capabilities provide a useful toolbox to make such an analysis
happen.&lt;/p&gt;
&lt;p&gt;&lt;br&gt;
&lt;a rel=&quot;license&quot; href=&quot;http://creativecommons.org/licenses/by-sa/4.0/&quot;&gt;&lt;img alt=&quot;Creative Commons License&quot; style=&quot;border-width:0&quot; src=&quot;https://i.creativecommons.org/l/by-sa/4.0/88x31.png&quot;/&gt;&lt;/a&gt;
This work is licensed under a &lt;a rel=&quot;license&quot;
href=&quot;http://creativecommons.org/licenses/by-sa/4.0/&quot;&gt;Creative Commons
Attribution-ShareAlike 4.0 International License&lt;/a&gt;. The
markdown+Rknitr source code of this blog is available under a &lt;a
href=&quot;https://www.gnu.org/licenses/gpl-3.0.html&quot;&gt;GNU General Public
License (GPL v3)&lt;/a&gt; license from github.&lt;/p&gt;
&lt;h1 id=&quot;introduction&quot;&gt;Introduction&lt;/h1&gt;
&lt;p&gt;Long Swedish winter nights are best spent watching &lt;a
href=&quot;https://en.wikipedia.org/wiki/Hans_Rosling&quot;&gt;Hans Rosling&lt;/a&gt;’s
inspiring &lt;a href=&quot;https://www.youtube.com/watch?v=hVimVzgtD6w&quot;&gt;TED
talks&lt;/a&gt;. Such visualizations help the statistician make points about
temporal trends in a x-axis to y-axis relationship, which otherwise
might drown in modelling details. Recently, I stumbled over a &lt;a
href=&quot;https://rpubs.com/sjackman/gapminder-gganimate&quot;&gt;blog post&lt;/a&gt; on
how to use the &lt;a
href=&quot;https://github.com/dgrtwo/gganimate&quot;&gt;&lt;code&gt;gganimate&lt;/code&gt;&lt;/a&gt; R
package to animate the Gapminder data available from the
&lt;code&gt;gapminder&lt;/code&gt; package. In order to perform a similar
&lt;em&gt;Rosling style&lt;/em&gt; animation consider the following: Today, the
Olympic Summer Games in Rio de Janeiro end. As usual this spawns a
debate, whether the nation’s participation has been successful. For this
purpose the &lt;a
href=&quot;https://en.wikipedia.org/wiki/Olympic_medal_table&quot;&gt;olympic medal
table&lt;/a&gt; is often taken as basis for comparisons, e.g., to mock your &lt;a
href=&quot;http://politiken.dk/sport/ol/ECE3349634/danmark-og-sverige-kaemper-til-det-sidste---men-hvor-daelen-er-norge-henne/&quot;&gt;neighbouring
countries&lt;/a&gt;. Recent analyses and visualization have been interested in
how to correct these tables for, e.g., population size or, more
interesting, analyse the influence of GDP. For example:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Google provides &lt;a
href=&quot;https://landing.google.com/altmedaltable/&quot;&gt;alternative Olympics
medal tables&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;Time Magazine discusses whether it is fair &lt;a
href=&quot;http://time.com/4452128/olympics-medals-per-capita-rankings/&quot;&gt;to
rank countries by medals achieved alone&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;The aim of the present blog note is to visualize how countries
perform in the medal table in relation to their GDP per capita. From a
technical viewpoint we experiment with using R to scrape the olympic
medal tables from Wikipedia and animate the results Gapminder style.
&lt;strong&gt;Disclaimer&lt;/strong&gt;: We only show the potential of such an
analysis and, hence, worry less about the scientific validity of the
analysis.&lt;/p&gt;
&lt;h1 id=&quot;data&quot;&gt;Data&lt;/h1&gt;
&lt;p&gt;We use the data of &lt;a href=&quot;https://www.gapminder.org/&quot;&gt;Gapminder&lt;/a&gt;
in order to obtain country specific population and GDP per capita data
for each of the years in the period of 1960-2016. The olympic medal
tables are ‘harvested’ from Wikipedia.&lt;/p&gt;
&lt;h2 id=&quot;olympic-medal-tables&quot;&gt;Olympic medal tables&lt;/h2&gt;
&lt;p&gt;Olympic medal tables were extracted using the &lt;code&gt;rvest&lt;/code&gt;
package from the corresponding Wikipedia pages by using
table-extracting-code described in the post by &lt;a
href=&quot;http://blog.corynissen.com/2015/01/using-rvest-to-scrape-html-table.html&quot;&gt;Cory
Nissen&lt;/a&gt;. The Wikipedia tables contain the current state of the medal
table and hence take changes in the medal distribution, e.g. deprivation
due to doping, into account. For details on such a table, see for
example the &lt;a
href=&quot;https://en.wikipedia.org/wiki/2012_Summer_Olympics_medal_table&quot;&gt;medal
table of the 2012 summer games&lt;/a&gt; in London. In order to stay focused
we hide the scraping functionality in the function
&lt;code&gt;scrape_medaltab&lt;/code&gt; - see the code on GitHub for more
details.&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb1&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb1-1&quot;&gt;&lt;a href=&quot;#cb1-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;#Years which had olympic games&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-2&quot;&gt;&lt;a href=&quot;#cb1-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;olympic_years &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;seq&lt;/span&gt;(&lt;span class=&quot;dv&quot;&gt;1960&lt;/span&gt;, &lt;span class=&quot;dv&quot;&gt;2016&lt;/span&gt;, &lt;span class=&quot;at&quot;&gt;by=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;4&lt;/span&gt;)&lt;/span&gt;
&lt;span id=&quot;cb1-3&quot;&gt;&lt;a href=&quot;#cb1-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-4&quot;&gt;&lt;a href=&quot;#cb1-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;# Extract olympic medal table from all olympic years since 1960&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-5&quot;&gt;&lt;a href=&quot;#cb1-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;medals &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;bind_rows&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;lapply&lt;/span&gt;(olympic_years, scrape_medaltab))&lt;/span&gt;
&lt;span id=&quot;cb1-6&quot;&gt;&lt;a href=&quot;#cb1-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-7&quot;&gt;&lt;a href=&quot;#cb1-7&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;# Show result&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-8&quot;&gt;&lt;a href=&quot;#cb1-8&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;DT&lt;span class=&quot;sc&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;datatable&lt;/span&gt;(medals)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;img
src=&quot;/blog/figure/source/2016-08-21-gapMedal/unnamed-chunk-2-1.png&quot; /&gt;&lt;/p&gt;
&lt;h2 id=&quot;gapminder-data&quot;&gt;Gapminder data&lt;/h2&gt;
&lt;p&gt;We obtain GDP per capita and population data from &lt;a
href=&quot;https://www.gapminder.org/data/&quot;&gt;Gapminder&lt;/a&gt;. Unfortunately,
these need to be fetched and merged manually. A more convenient way
would have been to take these directly from the package &lt;a
href=&quot;https://cran.r-project.org/web/packages/gapminder/index.html&quot;&gt;&lt;code&gt;gapminder&lt;/code&gt;&lt;/a&gt;,
but newer &lt;a
href=&quot;https://www.gapminder.org/data/documentation/gd001/&quot;&gt;GDP data&lt;/a&gt;
are now available. Again, we hide the details of the data wrangling
activities and refer to GitHub code.&lt;/p&gt;
&lt;p&gt;For convenience, we also extract the corresponding continent each
country belongs to. This can be done conveniently by comparing with the
&lt;code&gt;gapminder&lt;/code&gt; dataset (see code for details).&lt;/p&gt;
&lt;h2 id=&quot;joining-the-two-data-sources&quot;&gt;Joining the two data sources&lt;/h2&gt;
&lt;p&gt;In principle, all that is left to do is to join the two data sources
using the country name of the gapminder dataset and the nation names of
the olympic medal tables. However, a challenge of the present country
based analysis is how to incorporate the many political changes which
happened during the analysis period. As an example, East Germany
participated as independent national olympic committee during 1968-1988,
but the gapminder data only contain GDP data for Germany as a total. We
therefore aggregate the results of the two countries for the analysis. A
further important change is the split of the former Soviet Union into
several independent states. As a consequence, in 1992 a subset of the
former Soviet republics participated as &lt;a
href=&quot;https://en.wikipedia.org/wiki/Unified_Team_at_the_1992_Summer_Olympics&quot;&gt;Unified
Team&lt;/a&gt;. The GDP values for the Soviet Union thus have to be computed
from the Gapminder data by manually summing the individual Soviet
republic GDP values. Again we skip further data munging details and
simply refer to the GitHub code for a &lt;strong&gt;transparent &amp;amp;
reproducible&lt;/strong&gt; account. Warning: Only few of the entries in the
list of &lt;a
href=&quot;https://en.wikipedia.org/wiki/All-time_Olympic_Games_medal_table#Notes&quot;&gt;obsolete
nations &amp;amp; name changes&lt;/a&gt; are taken into account.&lt;/p&gt;
&lt;p&gt;Conditioned on the success of the previous wrangling step, we can now
join the two data sources:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb2&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb2-1&quot;&gt;&lt;a href=&quot;#cb2-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;medals_gm &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;left_join&lt;/span&gt;(medals_mod, gapminder_manual, &lt;span class=&quot;at&quot;&gt;by=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;c&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;quot;Nation&amp;quot;&lt;/span&gt;,&lt;span class=&quot;st&quot;&gt;&amp;quot;Year&amp;quot;&lt;/span&gt;))&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h1 id=&quot;results&quot;&gt;Results&lt;/h1&gt;
&lt;p&gt;First we analyse the &lt;a
href=&quot;https://en.wikipedia.org/wiki/All-time_Olympic_Games_medal_table&quot;&gt;all-time
summer olympic medal table&lt;/a&gt; for the period 1960-2016.&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb3&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb3-1&quot;&gt;&lt;a href=&quot;#cb3-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;medals_alltime &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; medals_gm &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb3-2&quot;&gt;&lt;a href=&quot;#cb3-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;group_by&lt;/span&gt;(Nation) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb3-3&quot;&gt;&lt;a href=&quot;#cb3-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;summarise&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;Total =&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;sum&lt;/span&gt;(Total)) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb3-4&quot;&gt;&lt;a href=&quot;#cb3-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;arrange&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;desc&lt;/span&gt;(Total))&lt;/span&gt;
&lt;span id=&quot;cb3-5&quot;&gt;&lt;a href=&quot;#cb3-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;DT&lt;span class=&quot;sc&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;datatable&lt;/span&gt;(medals_alltime)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;img
src=&quot;/blog/figure/source/2016-08-21-gapMedal/unnamed-chunk-7-1.png&quot; /&gt;&lt;/p&gt;
&lt;p&gt;We now plot of the total number of medals awarded for each summer
games in the period of 1960-2016.&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb4&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb4-1&quot;&gt;&lt;a href=&quot;#cb4-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;nTotal &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; medals_gm &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-2&quot;&gt;&lt;a href=&quot;#cb4-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;group_by&lt;/span&gt;(Year) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-3&quot;&gt;&lt;a href=&quot;#cb4-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;summarise&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;TotalOfGames =&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;sum&lt;/span&gt;(Total))&lt;/span&gt;
&lt;span id=&quot;cb4-4&quot;&gt;&lt;a href=&quot;#cb4-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;ggplot&lt;/span&gt;(nTotal, &lt;span class=&quot;fu&quot;&gt;aes&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;x =&lt;/span&gt; Year, &lt;span class=&quot;at&quot;&gt;y =&lt;/span&gt; TotalOfGames)) &lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;geom_line&lt;/span&gt;() &lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;ylab&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;quot;Total number of medals per Summer Games&amp;quot;&lt;/span&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;img
src=&quot;/blog/figure/source/2016-08-21-gapMedal/TOTALMEDALSPERGAME-1.png&quot; /&gt;&lt;/p&gt;
&lt;p&gt;A distinct increasing trend is observed in the above figure. Hence,
in order to make between-country comparisons over time based on the
number of medals won, we normalize the medals by the total number of
medals awarded during the corresponding games. The result is stored in
the column &lt;code&gt;Frac&lt;/code&gt;.&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb5&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb5-1&quot;&gt;&lt;a href=&quot;#cb5-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;medals_gm &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; medals_gm &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb5-2&quot;&gt;&lt;a href=&quot;#cb5-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;left_join&lt;/span&gt;(nTotal, &lt;span class=&quot;at&quot;&gt;by =&lt;/span&gt; &lt;span class=&quot;st&quot;&gt;&amp;quot;Year&amp;quot;&lt;/span&gt;) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb5-3&quot;&gt;&lt;a href=&quot;#cb5-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;mutate&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;Frac =&lt;/span&gt; Total &lt;span class=&quot;sc&quot;&gt;/&lt;/span&gt; TotalOfGames)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;After all these pre-processing steps, we can now compare country
results for all summer games in the period 2000-2016.&lt;/p&gt;
&lt;p&gt;&lt;img
src=&quot;/blog/figure/source/2016-08-21-gapMedal/FACET2000ANDBEYOND-1.png&quot; /&gt;&lt;/p&gt;
&lt;p&gt;Note that for better visualization of the many countries with a small
number of medals, an &lt;span
class=&quot;math inline&quot;&gt;\(\sqrt{}\)&lt;/span&gt;-transform of the y-axis is
used.&lt;/p&gt;
&lt;p&gt;Finally, we can use the &lt;code&gt;gganimate&lt;/code&gt; package to visualize
the dependence of the total number of medals won in the summer games
1960-2016 as a function of GDP per capita.&lt;/p&gt;
&lt;p&gt;&lt;img
src=&quot;/blog/figure/source/2016-08-21-gapMedal/olympicMedals-gapminder-style.gif&quot; /&gt;&lt;/p&gt;
&lt;p&gt;As before a &lt;span class=&quot;math inline&quot;&gt;\(\sqrt{}\)&lt;/span&gt;-transform of
the y-axis is used for better visualization. One interesting observation
we see from the animation is that the home-country of the Olympics
always appears to do well in the following Olympics. Also note that the
&lt;a
href=&quot;https://en.wikipedia.org/wiki/1980_Summer_Olympics_boycott&quot;&gt;1980&lt;/a&gt;
and &lt;a
href=&quot;https://en.wikipedia.org/wiki/1984_Summer_Olympics_boycott&quot;&gt;1984&lt;/a&gt;
were special due to boycotts. With respect to the top-5 nations it is
also worth noticing that China, due to protests against the
participation of Taiwan, did not participate in the Olympics 1956-1980.
Furthermore, up to 1988 the team denoted “Germany” in the animation
consists of the combined number of medals of “East Germany” and “West
Germany”.&lt;/p&gt;
&lt;h3 id=&quot;fun-with-flags&quot;&gt;Fun with Flags&lt;/h3&gt;
&lt;p&gt;Update: After being made aware of the concurrent &lt;a
href=&quot;http://pmassicotte.github.io/2016-08-25-olympics2016&quot;&gt;blog
entry&lt;/a&gt; by &lt;a
href=&quot;https://www.researchgate.net/profile/Philippe_Massicotte&quot;&gt;Philippe
Massicotte&lt;/a&gt; on how to visualize the Rio medal table using the
&lt;code&gt;ggflags&lt;/code&gt; package, the above gapminder visualization can
easily be extended to use flags instead of nation names. As the
&lt;code&gt;ggflags&lt;/code&gt; package only contains the flags of currently
existing countries we start the visualization in 1990. For better
visability we also add the trajectory of each nation.&lt;/p&gt;
&lt;p&gt;&lt;img
src=&quot;/blog/figure/source/2016-08-21-gapMedal/olympicMedals-flags.gif&quot; /&gt;&lt;/p&gt;
&lt;h3 id=&quot;number-of-medals-per-population&quot;&gt;Number of Medals per
Population&lt;/h3&gt;
&lt;p&gt;To see the medal tables in a different light, we instead visualize a
quantity relative to the number of medals per population. To enable
cross-year comparisons we therefore compute the following index for each
country and olympic summer games: &lt;span class=&quot;math display&quot;&gt;\[
\frac{\text{Fraction of All Medals the Country got in that
Year}}{\text{Population in the Country that Year}} \times 10^6.
\]&lt;/span&gt; We shall call this index a country’s fraction of all medals
per million population. A similar animation as above, now with
logarithmic y-axis, illustrates the dynamics. To provide
&lt;strong&gt;evidence supported neighbour mocking&lt;/strong&gt;, we highlight the
position of the three Nordic countries (Denmark, Sweden and Norway).&lt;/p&gt;
&lt;p&gt;&lt;img
src=&quot;/blog/figure/source/2016-08-21-gapMedal/olympicMedals-perpop-gapminder-style.gif&quot; /&gt;&lt;/p&gt;
&lt;p&gt;Jamaica, Bahamas and Grenada appear to do reasonably well lately
compared to their population size. However, more more important - did
you noticed the position of Denmark at the 2016 games in Rio?&lt;/p&gt;
</description>
        <pubDate>Sun, 21 Aug 2016 00:00:00 +0200</pubDate>
        <link>https://mhoehle.github.io/blog/2016/08/21/gapMedal.html</link>
        <guid isPermaLink="true">https://mhoehle.github.io/blog/2016/08/21/gapMedal.html</guid>
        
        <category>datascience</category>
        
        <category>rstats</category>
        
        <category>olympic games</category>
        
        
      </item>
    
      <item>
        <title>No Sleep During the Reproducibility Session</title>
        <description>&lt;h2 id=&quot;abstract&quot;&gt;Abstract&lt;/h2&gt;
&lt;p&gt;R code is provided for implementing a statistical method by &lt;span
class=&quot;citation&quot; data-cites=&quot;nishiura_etal2016&quot;&gt;Nishiura, Miyamatsu, and
Mizumoto (2016)&lt;/span&gt; to assess when to declare the end of an outbreak
of a person-to-person transmitted disease. The motivating example is the
MERS-CoV outbreak in Korea, 2015. From a greater perspective, the blog
entry is an attempt to advocate for spicing up statistical conferences
by a &lt;strong&gt;reproducibility session&lt;/strong&gt;.&lt;/p&gt;
&lt;p&gt;&lt;br&gt;
&lt;a rel=&quot;license&quot; href=&quot;http://creativecommons.org/licenses/by-sa/4.0/&quot;&gt;&lt;img alt=&quot;Creative Commons License&quot; style=&quot;border-width:0&quot; src=&quot;https://i.creativecommons.org/l/by-sa/4.0/88x31.png&quot;/&gt;&lt;/a&gt;
This work is licensed under a &lt;a rel=&quot;license&quot;
href=&quot;http://creativecommons.org/licenses/by-sa/4.0/&quot;&gt;Creative Commons
Attribution-ShareAlike 4.0 International License&lt;/a&gt;. The
markdown+Rknitr source code of this blog is available under a &lt;a
href=&quot;https://www.gnu.org/licenses/gpl-3.0.html&quot;&gt;GNU General Public
License (GPL v3)&lt;/a&gt; license from github.&lt;/p&gt;
&lt;h1 id=&quot;introduction&quot;&gt;Introduction&lt;/h1&gt;
&lt;p&gt;A few weeks ago I went to the &lt;a
href=&quot;https://biometricconference.org/&quot;&gt;International Biometric
Conference (IBC)&lt;/a&gt; in Victoria. Conferences are good for meeting
people, but with respect to scientific content, there is typically no
more than 2-3 talks in a week, which you really remember. Partly, this
is due to the format of statistics conferences not developing much in
recent decades: it is plenary talks, invited sessions, contributed
sessions, showcase sessions and poster sessions all over. However, some
developments have occurred, e.g. &lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;the German joint statistical meeting introduced the concept of a &lt;a
href=&quot;http://www.uni-goettingen.de/de/501387.html&quot;&gt;stats bazaar&lt;/a&gt;
talk.&lt;/li&gt;
&lt;li&gt;the &lt;a href=&quot;http://user2016.org/&quot;&gt;R User Conference&lt;/a&gt; has added
some interesting additional formats, e.g. lightning talks, in order to
make life at a conference more interesting. Thomas Leeper has written an
inspiring &lt;a
href=&quot;http://thomasleeper.com/2015/07/user2015-lessons/&quot;&gt;blog post&lt;/a&gt;
about this issue.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Not all science is ‘fun’, but when balancing between adding
yet-another-table-from-a-simulation-study against 95% of the audience
dozing off, I urge you to aim for an awake audience.&lt;/p&gt;
&lt;p&gt;So here is an additional session format in the spirit of
&lt;strong&gt;reproducible science&lt;/strong&gt;, which might help make statistics
conference more alive again: Take the contents of a talk, find the
corresponding paper/technical report/slides, download the data (of
course these are available) and start implementing. After all, hacking a
statistical method is the best way to understand it and reproducing the
results of an analysis is a form of peer-review we should do much more
as statisticians. The important &lt;a
href=&quot;The%20Importance%20of%20Reproducible%20Research%20in%20High-Throughput%20Biology:%20Case%20Studies%20in%20Forensic%20Bioinformatics&quot;&gt;talk&lt;/a&gt;
by &lt;a href=&quot;http://odin.mdacc.tmc.edu/~kabaggerly/&quot;&gt;Keith A.
Baggerly&lt;/a&gt; about reproducibility in bioinformatics more than
underlines this.&lt;/p&gt;
&lt;p&gt;As a consequence, this blog entry is my attempt of a
&lt;strong&gt;repro-session&lt;/strong&gt; in connection with the IBC: The talk
entitled &lt;em&gt;&lt;a
href=&quot;https://biometricconference.org/contributed-sessions/oral/detail/?sessionID=CS.15&quot;&gt;Determining
the end of an epidemic with human-to-human transmission&lt;/a&gt;&lt;/em&gt; by &lt;a
href=&quot;http://plaza.umin.ac.jp/~infepi/hnishiura.htm&quot;&gt;Hiroshi
Nishiura&lt;/a&gt; was both interesting, from a field I’m interested in
(infectious disease epidemiology) and the method looked like it could be
re-implemented in finite time. The question the method tries to answer
is the following: at which time point can one declare an outbreak of a
person-to-person transmitted disease as having ended? Answering this
question can be important in order to calm the population, attract
tourists again, export goods or reduce alertness status. The current WHO
method for answering the question requires that a period of two times
the longest possible incubation time needs to have passed since the last
cases before an outbreak can be declared as being over. However, as
stated in their paper (&lt;span class=&quot;citation&quot;
data-cites=&quot;nishiura_etal2016&quot;&gt;Nishiura, Miyamatsu, and Mizumoto
(2016)&lt;/span&gt;), the criterion clearly lacks a statistical motivation. As
an improvement Nishiura and co-workers formulate a statistical criterion
based on the serial interval distribution and the offspring
distribution.&lt;/p&gt;
&lt;p&gt;In what follows we shall quickly describe their method and apply it
to their motivating example, which was the 2015 MERS-CoV outbreak in
Korea. As a small outlook, we shall implement some own thoughts on how
to answer the posed questions using a hierarchical model.&lt;/p&gt;
&lt;h1 id=&quot;method&quot;&gt;Method&lt;/h1&gt;
&lt;p&gt;Let &lt;span class=&quot;math inline&quot;&gt;\(Y_t\)&lt;/span&gt; be a count variable
representing the number of symptom onset in cases we observe on a given
day &lt;span class=&quot;math inline&quot;&gt;\(t\)&lt;/span&gt; during the outbreak. The
sequence of the &lt;span class=&quot;math inline&quot;&gt;\(Y_t\)&lt;/span&gt; is also called
the &lt;a
href=&quot;http://www.cdc.gov/foodsafety/outbreaks/investigating-outbreaks/epi-curves.html&quot;&gt;&lt;strong&gt;epidemic
cuve&lt;/strong&gt;&lt;/a&gt; of the outbreak. Furthermore, let &lt;span
class=&quot;math inline&quot;&gt;\(D=\{t_i; i=1,\ldots,n\}\)&lt;/span&gt;, be the currently
available outbreak data containing the time of symptom onset in in each
of the &lt;span class=&quot;math inline&quot;&gt;\(n\)&lt;/span&gt; cases of the outbreak. In
what follows we will be interested in what happens with &lt;span
class=&quot;math inline&quot;&gt;\(Y_t\)&lt;/span&gt; for future time points, i.e. time
points after the last currently observed onset time. In particular we
will be interested in, whether we will observe zero cases or more than
zero cases.&lt;/p&gt;
&lt;p&gt;The important result of &lt;span class=&quot;citation&quot;
data-cites=&quot;nishiura_etal2016&quot;&gt;Nishiura, Miyamatsu, and Mizumoto
(2016)&lt;/span&gt; is that the probability &lt;span class=&quot;math inline&quot;&gt;\(\pi_t
= P(Y_t &amp;gt; 0\&amp;gt;|\&amp;gt;D)\)&lt;/span&gt; can be computed as follows: &lt;span
class=&quot;math display&quot;&gt;\[
\begin{align*}
\pi_t = 1 - \prod_{i=1}^n \sum_{o=0}^{\infty} f_{\text{offspring}}(o;
R_0, k) \cdot \left[ F_{\text{serial}}(t-t_i) \right]^{o},
\end{align*}
\]&lt;/span&gt; where &lt;span
class=&quot;math inline&quot;&gt;\(f_{\text{offspring}}\)&lt;/span&gt; denotes the PMF for
the number of secondary cases one primary case induces. It is assumed
that this distribution is negative binomial with expectation &lt;span
class=&quot;math inline&quot;&gt;\(R_0&amp;gt;0\)&lt;/span&gt; and clumping parameter &lt;span
class=&quot;math inline&quot;&gt;\(k&amp;gt;0\)&lt;/span&gt;. In other words, &lt;span
class=&quot;math inline&quot;&gt;\(\operatorname{E}(O)=R_0\)&lt;/span&gt; and &lt;span
class=&quot;math inline&quot;&gt;\(\operatorname{Var}(O)=R_0 + R_0^2/k\)&lt;/span&gt;.
Furthermore, &lt;span class=&quot;math inline&quot;&gt;\(F_{\text{serial}}\)&lt;/span&gt;
denotes the CDF of the serial interval distribution of the disease of
interest. The serial interval is the time period between the onset of
symptoms in the primary and onset of symptoms in the secondary case, see
&lt;span class=&quot;citation&quot; data-cites=&quot;svensson2007&quot;&gt;Svensson
(2007)&lt;/span&gt;.&lt;/p&gt;
&lt;p&gt;Once &lt;span class=&quot;math inline&quot;&gt;\(\pi_t\)&lt;/span&gt; is below some
pre-defined threshold &lt;span class=&quot;math inline&quot;&gt;\(c\)&lt;/span&gt;, say &lt;span
class=&quot;math inline&quot;&gt;\(c=0.05\)&lt;/span&gt;, one would declare the outbreak to
be over, if no new cases have been observed by time &lt;span
class=&quot;math inline&quot;&gt;\(t\)&lt;/span&gt;. In other words: &lt;span
class=&quot;math display&quot;&gt;\[
T_{\text{end}} = \min_{t&amp;gt;t^*} \{ \pi_t &amp;lt; c \}.
\]&lt;/span&gt; where &lt;span class=&quot;math inline&quot;&gt;\(t^* = \max_{i=1,\ldots,n}
t_i\)&lt;/span&gt;, i.e. the onset time in the last observed case.&lt;/p&gt;
&lt;p&gt;Note that the formulated approach is conservative, because every
available case is treated as having the potential to generate new
secondary cases according to the entire offspring distribution. In
practice, however, observed cases towards the end will be secondary
cases of some of the earlier cases. Hence, these primary cases will be
attributed as having the ability to generate more secondary cases than
they actually have in practice. Another important assumption of the
method is that all cases are observed: no asymptomatic cases nor
under-reporting is taken into account.&lt;/p&gt;
&lt;h2 id=&quot;data-from-the-mers-cov-oubtreak-in-korea-2015&quot;&gt;Data from the
MERS-Cov Oubtreak in Korea, 2015&lt;/h2&gt;
&lt;p&gt;The data basis for our analysis is the WHO data set on the &lt;a
href=&quot;http://www.who.int/csr/don/21-july-2015-mers-korea/en/&quot;&gt;MERS-Cov
outbreak in Korea&lt;/a&gt;, which occurred during May-July 2015. It contains
the information about 185 cases of the MERS-CoV outbreak in Korea, 2015.
These were already analysed in a previous &lt;a
href=&quot;./2016-07-19-nowCast.Rmd&quot;&gt;blog entry&lt;/a&gt; for the purpose of
nowcasting. However, we shall now be interested in answering the
following question: Given the observations of symptoms on the last
(known) case on 2015-07-02. How many days without new infections would
have to pass, before we would declare the outbreak as having
&lt;strong&gt;ended&lt;/strong&gt;?&lt;/p&gt;
&lt;h2 id=&quot;results&quot;&gt;Results&lt;/h2&gt;
&lt;p&gt;In what follows we shall distinguish results between model parameters
to be estimated from data and the computation of the probability &lt;span
class=&quot;math inline&quot;&gt;\(\pi_t\)&lt;/span&gt;. Focus of this blog entry is on the
later part. Details on the first part is available in the code.&lt;/p&gt;
&lt;h2 id=&quot;parameter-estimation&quot;&gt;Parameter Estimation&lt;/h2&gt;
&lt;p&gt;The parameters to estimate are the following:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;parameters of the parametric distributional family governing the
serial interval distribution (in &lt;span class=&quot;citation&quot;
data-cites=&quot;nishiura_etal2016&quot;&gt;Nishiura, Miyamatsu, and Mizumoto
(2016)&lt;/span&gt; this is assumed to be a gamma distribution)&lt;/li&gt;
&lt;li&gt;parameters of the offspring distribution, which here is assumed to
be negative binomial with mean &lt;span class=&quot;math inline&quot;&gt;\(R_0\)&lt;/span&gt;
and clumping parameter &lt;span class=&quot;math inline&quot;&gt;\(k\)&lt;/span&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;The first step is easily accomplished in &lt;span class=&quot;citation&quot;
data-cites=&quot;nishiura_etal2015&quot;&gt;Nishiura et al. (2015)&lt;/span&gt; by solving
for given mean and standard deviation for the serial interval
distribution observed in secondary data - see the paper for details. The
solution can be found analytically given the values.&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb1&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb1-1&quot;&gt;&lt;a href=&quot;#cb1-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;E &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fl&quot;&gt;12.6&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-2&quot;&gt;&lt;a href=&quot;#cb1-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;SD &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fl&quot;&gt;2.8&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-3&quot;&gt;&lt;a href=&quot;#cb1-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;(theta_serial &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;c&lt;/span&gt;(E&lt;span class=&quot;sc&quot;&gt;^&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;/&lt;/span&gt;SD&lt;span class=&quot;sc&quot;&gt;^&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;,E&lt;span class=&quot;sc&quot;&gt;/&lt;/span&gt;SD&lt;span class=&quot;sc&quot;&gt;^&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;))&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;## [1] 20.25  1.61&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;The second part is addressed in &lt;span class=&quot;citation&quot;
data-cites=&quot;nishiura_etal2015&quot;&gt;Nishiura et al. (2015)&lt;/span&gt; by
analysing final-size and generation data using a maximum likelihood
approach. We will here only implement the methods using the data
presented in Figure 1 and Table 1 of the paper. Unfortunately, one
cluster size is not immediately reconstructable from the data in the
paper, but guesstimating from the table on p.4 of the &lt;a
href=&quot;http://ecdc.europa.eu/en/publications/Publications/RRA-Middle-East-respiratory-syndrome-coronavirus-Korea.pdf&quot;&gt;ECDC
Rapid Risk Assessment&lt;/a&gt; it appears to be the outbreak in Jordan with a
size of 19. The likelihood is then maximized for &lt;span
class=&quot;math inline&quot;&gt;\(\mathbf{\theta}=(\log(R_0),\log(k))&amp;#39;\)&lt;/span&gt;
using &lt;code&gt;optim&lt;/code&gt;. Based on the Hessian, a numeric approximation
of the variance-covariance matrix of &lt;span
class=&quot;math inline&quot;&gt;\(\hat{\mathbf{\theta}}\)&lt;/span&gt; can be
obtained.&lt;/p&gt;
&lt;p&gt;Altogether, we maximize the combined likelihood consisting of 36 as
well as the corresponding number of generations by:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb3&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb3-1&quot;&gt;&lt;a href=&quot;#cb3-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;theta_mle &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;optim&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;c&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;log&lt;/span&gt;(&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;),&lt;span class=&quot;fu&quot;&gt;log&lt;/span&gt;(&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;)),ll_combine, &lt;span class=&quot;at&quot;&gt;outbreaks=&lt;/span&gt;outbreaks, &lt;span class=&quot;at&quot;&gt;control=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;list&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;fnscale=&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;),&lt;span class=&quot;at&quot;&gt;hessian=&lt;/span&gt;&lt;span class=&quot;cn&quot;&gt;TRUE&lt;/span&gt;)&lt;/span&gt;
&lt;span id=&quot;cb3-2&quot;&gt;&lt;a href=&quot;#cb3-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;exp&lt;/span&gt;(theta_mle&lt;span class=&quot;sc&quot;&gt;$&lt;/span&gt;par)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;## [1] 0.826 0.128&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;These numbers deviate slightly from the values of &lt;span
class=&quot;math inline&quot;&gt;\(\hat{R}_0=0.75\)&lt;/span&gt; and &lt;span
class=&quot;math inline&quot;&gt;\(\hat{k}=0.14\)&lt;/span&gt; reported by &lt;span
class=&quot;citation&quot; data-cites=&quot;nishiura_etal2015&quot;&gt;Nishiura et al.
(2015)&lt;/span&gt;. One explanation might be the unclear cluster size of the
Jordan outbreak, here it would have been helpful to have had all data
directly available in electronic form.&lt;/p&gt;
&lt;h2 id=&quot;outbreak-end&quot;&gt;Outbreak End&lt;/h2&gt;
&lt;p&gt;The above &lt;span class=&quot;math inline&quot;&gt;\(\pi_t\)&lt;/span&gt; equation is
implemented below as function &lt;code&gt;p_oneormore&lt;/code&gt;. It requires the
use of the PMF of the offspring distribution (&lt;code&gt;doffspring&lt;/code&gt;),
which here is the negative binomial offspring distribution.&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb5&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb5-1&quot;&gt;&lt;a href=&quot;#cb5-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##Offspring distribution, this is just the negative binomial PMF.&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb5-2&quot;&gt;&lt;a href=&quot;#cb5-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;doffspring &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;cf&quot;&gt;function&lt;/span&gt;(y, R_0, k, &lt;span class=&quot;at&quot;&gt;log=&lt;/span&gt;&lt;span class=&quot;cn&quot;&gt;FALSE&lt;/span&gt;) {&lt;/span&gt;
&lt;span id=&quot;cb5-3&quot;&gt;&lt;a href=&quot;#cb5-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;dnbinom&lt;/span&gt;(y, &lt;span class=&quot;at&quot;&gt;mu=&lt;/span&gt;R_0, &lt;span class=&quot;at&quot;&gt;size=&lt;/span&gt;k, &lt;span class=&quot;at&quot;&gt;log=&lt;/span&gt;log)&lt;/span&gt;
&lt;span id=&quot;cb5-4&quot;&gt;&lt;a href=&quot;#cb5-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;}&lt;/span&gt;
&lt;span id=&quot;cb5-5&quot;&gt;&lt;a href=&quot;#cb5-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb5-6&quot;&gt;&lt;a href=&quot;#cb5-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##Probability for one or more cases at time t.&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb5-7&quot;&gt;&lt;a href=&quot;#cb5-7&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;p_oneormore &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;Vectorize&lt;/span&gt;(&lt;span class=&quot;cf&quot;&gt;function&lt;/span&gt;(t,R_0,k,theta_serial,&lt;span class=&quot;at&quot;&gt;yMax=&lt;/span&gt;&lt;span class=&quot;fl&quot;&gt;1e4&lt;/span&gt;,&lt;span class=&quot;at&quot;&gt;verbose=&lt;/span&gt;&lt;span class=&quot;cn&quot;&gt;FALSE&lt;/span&gt;) {&lt;/span&gt;
&lt;span id=&quot;cb5-8&quot;&gt;&lt;a href=&quot;#cb5-8&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;cf&quot;&gt;if&lt;/span&gt; (verbose) &lt;span class=&quot;fu&quot;&gt;cat&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;paste0&lt;/span&gt;(t,&lt;span class=&quot;st&quot;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;\n&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;&lt;/span&gt;))&lt;/span&gt;
&lt;span id=&quot;cb5-9&quot;&gt;&lt;a href=&quot;#cb5-9&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  res &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb5-10&quot;&gt;&lt;a href=&quot;#cb5-10&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb5-11&quot;&gt;&lt;a href=&quot;#cb5-11&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;do&quot;&gt;##Loop over all cases as in eqn (1) of the suppl. of Nishiura (2016).&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb5-12&quot;&gt;&lt;a href=&quot;#cb5-12&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;do&quot;&gt;##Setup process bar for this action.&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb5-13&quot;&gt;&lt;a href=&quot;#cb5-13&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;cf&quot;&gt;if&lt;/span&gt; (verbose) {&lt;/span&gt;
&lt;span id=&quot;cb5-14&quot;&gt;&lt;a href=&quot;#cb5-14&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    pb &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;startpb&lt;/span&gt;(&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;, &lt;span class=&quot;fu&quot;&gt;nrow&lt;/span&gt;(linelist))&lt;/span&gt;
&lt;span id=&quot;cb5-15&quot;&gt;&lt;a href=&quot;#cb5-15&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;fu&quot;&gt;on.exit&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;closepb&lt;/span&gt;(pb))&lt;/span&gt;
&lt;span id=&quot;cb5-16&quot;&gt;&lt;a href=&quot;#cb5-16&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  }&lt;/span&gt;
&lt;span id=&quot;cb5-17&quot;&gt;&lt;a href=&quot;#cb5-17&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb5-18&quot;&gt;&lt;a href=&quot;#cb5-18&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;cf&quot;&gt;for&lt;/span&gt; (i &lt;span class=&quot;cf&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;seq_len&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;nrow&lt;/span&gt;(linelist))) {&lt;/span&gt;
&lt;span id=&quot;cb5-19&quot;&gt;&lt;a href=&quot;#cb5-19&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;cf&quot;&gt;if&lt;/span&gt; (verbose) { &lt;span class=&quot;fu&quot;&gt;setpb&lt;/span&gt;(pb, i) }&lt;/span&gt;
&lt;span id=&quot;cb5-20&quot;&gt;&lt;a href=&quot;#cb5-20&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    serial_time &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;as.numeric&lt;/span&gt;(t &lt;span class=&quot;sc&quot;&gt;-&lt;/span&gt; linelist&lt;span class=&quot;sc&quot;&gt;$&lt;/span&gt;Date.of.symptoms.onset[i])&lt;/span&gt;
&lt;span id=&quot;cb5-21&quot;&gt;&lt;a href=&quot;#cb5-21&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    cdf &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;pgamma&lt;/span&gt;(serial_time, theta_serial[&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;], theta_serial[&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;])&lt;/span&gt;
&lt;span id=&quot;cb5-22&quot;&gt;&lt;a href=&quot;#cb5-22&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    y &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;dv&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;dt&quot;&gt;L&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;:&lt;/span&gt;yMax&lt;/span&gt;
&lt;span id=&quot;cb5-23&quot;&gt;&lt;a href=&quot;#cb5-23&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    ysum &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;sum&lt;/span&gt;( &lt;span class=&quot;fu&quot;&gt;doffspring&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;y=&lt;/span&gt;y,&lt;span class=&quot;at&quot;&gt;R_0=&lt;/span&gt;R_0,&lt;span class=&quot;at&quot;&gt;k=&lt;/span&gt;k)&lt;span class=&quot;sc&quot;&gt;*&lt;/span&gt;cdf&lt;span class=&quot;sc&quot;&gt;^&lt;/span&gt;y)&lt;/span&gt;
&lt;span id=&quot;cb5-24&quot;&gt;&lt;a href=&quot;#cb5-24&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    res &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; res &lt;span class=&quot;sc&quot;&gt;*&lt;/span&gt; ysum&lt;/span&gt;
&lt;span id=&quot;cb5-25&quot;&gt;&lt;a href=&quot;#cb5-25&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  }&lt;/span&gt;
&lt;span id=&quot;cb5-26&quot;&gt;&lt;a href=&quot;#cb5-26&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;return&lt;/span&gt;(&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;-&lt;/span&gt;res)&lt;/span&gt;
&lt;span id=&quot;cb5-27&quot;&gt;&lt;a href=&quot;#cb5-27&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;},&lt;span class=&quot;at&quot;&gt;vectorize.args=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;c&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;quot;t&amp;quot;&lt;/span&gt;,&lt;span class=&quot;st&quot;&gt;&amp;quot;R_0&amp;quot;&lt;/span&gt;,&lt;span class=&quot;st&quot;&gt;&amp;quot;k&amp;quot;&lt;/span&gt;))&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;The function allows us to re-calculate the results of &lt;span
class=&quot;citation&quot; data-cites=&quot;nishiura_etal2016&quot;&gt;Nishiura, Miyamatsu, and
Mizumoto (2016)&lt;/span&gt;:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb6&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb6-1&quot;&gt;&lt;a href=&quot;#cb6-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##Results from the Nishiura et al. (2015) paper&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb6-2&quot;&gt;&lt;a href=&quot;#cb6-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##R_0_hat &amp;lt;- 0.75 ; k_hat &amp;lt;- 0.14&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb6-3&quot;&gt;&lt;a href=&quot;#cb6-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##Use MLE found with the data we were able to extract.&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb6-4&quot;&gt;&lt;a href=&quot;#cb6-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;R_0_hat &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;exp&lt;/span&gt;(theta_mle&lt;span class=&quot;sc&quot;&gt;$&lt;/span&gt;par[&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;])&lt;/span&gt;
&lt;span id=&quot;cb6-5&quot;&gt;&lt;a href=&quot;#cb6-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;k_hat   &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;exp&lt;/span&gt;(theta_mle&lt;span class=&quot;sc&quot;&gt;$&lt;/span&gt;par[&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;])&lt;/span&gt;
&lt;span id=&quot;cb6-6&quot;&gt;&lt;a href=&quot;#cb6-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb6-7&quot;&gt;&lt;a href=&quot;#cb6-7&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;## Compute prob for one or more cases on a grid of dates&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb6-8&quot;&gt;&lt;a href=&quot;#cb6-8&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;df &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;data_frame&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;t=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;seq&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;as.Date&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;quot;2015-07-15&amp;quot;&lt;/span&gt;),&lt;span class=&quot;fu&quot;&gt;as.Date&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;quot;2015-08-05&amp;quot;&lt;/span&gt;),&lt;span class=&quot;at&quot;&gt;by=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;1 day&amp;quot;&lt;/span&gt;))&lt;/span&gt;
&lt;span id=&quot;cb6-9&quot;&gt;&lt;a href=&quot;#cb6-9&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;df &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; df &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;mutate&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;pi =&lt;/span&gt;  &lt;span class=&quot;fu&quot;&gt;p_oneormore&lt;/span&gt;(t,&lt;span class=&quot;at&quot;&gt;R_0=&lt;/span&gt;R_0_hat, &lt;span class=&quot;at&quot;&gt;k=&lt;/span&gt;k_hat, &lt;span class=&quot;at&quot;&gt;theta_serial=&lt;/span&gt;theta_serial, &lt;span class=&quot;at&quot;&gt;yMax=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;250&lt;/span&gt;,&lt;span class=&quot;at&quot;&gt;verbose=&lt;/span&gt;&lt;span class=&quot;cn&quot;&gt;FALSE&lt;/span&gt;))&lt;/span&gt;
&lt;span id=&quot;cb6-10&quot;&gt;&lt;a href=&quot;#cb6-10&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;head&lt;/span&gt;(df, &lt;span class=&quot;at&quot;&gt;n=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;3&lt;/span&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;## Source: local data frame [3 x 2]
## 
##            t    pi
##       (date) (dbl)
## 1 2015-07-15 0.366
## 2 2015-07-16 0.297
## 3 2015-07-17 0.226&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;We can embed estimation uncertainty originating from the estimation
of &lt;span class=&quot;math inline&quot;&gt;\(R_0\)&lt;/span&gt; and &lt;span
class=&quot;math inline&quot;&gt;\(k\)&lt;/span&gt; by adding an additional bootstrap step
with values of &lt;span class=&quot;math inline&quot;&gt;\((\log R_0, \log
k)&amp;#39;\)&lt;/span&gt; sampled from the asymptotic normal distribution. This
distribution has expectation equal to the MLE and variance-covariance
matrix equal to the observed Fisher information. Pointwise
percentile-based 95% confidence intervals are then easily computed. The
figure below shows this 95% CI (shaded area) together with the &lt;span
class=&quot;math inline&quot;&gt;\(\pi_t\)&lt;/span&gt; curve.&lt;/p&gt;
&lt;p&gt;&lt;img
src=&quot;/blog/figure/source/2016-08-04-outbreakEnd/unnamed-chunk-8-1.png&quot; /&gt;&lt;/p&gt;
&lt;p&gt;Altogether, the date where we would declare the outbreak to be over
is found as:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb8&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb8-1&quot;&gt;&lt;a href=&quot;#cb8-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;c_threshold &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fl&quot;&gt;0.05&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb8-2&quot;&gt;&lt;a href=&quot;#cb8-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;(tEnd &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; df2 &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;filter&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;at&quot;&gt;quantile.97.5%&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;`&lt;/span&gt; &lt;span class=&quot;sc&quot;&gt;&amp;lt;&lt;/span&gt; c_threshold) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;slice&lt;/span&gt;(&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;dt&quot;&gt;L&lt;/span&gt;))&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;## # A tibble: 1 x 4
##   t              pi `quantile.2.5%` `quantile.97.5%`
##   &amp;lt;date&amp;gt;      &amp;lt;dbl&amp;gt;           &amp;lt;dbl&amp;gt;            &amp;lt;dbl&amp;gt;
## 1 2015-07-21 0.0345          0.0253           0.0454&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;In other words, given the assumptions of the model and the chosen
threshold, we would declare the outbreak to be over, if no new cases are
observed by 2015-07-21. The adequate choice of &lt;span
class=&quot;math inline&quot;&gt;\(c\)&lt;/span&gt; as cut-off in the procedure in general
depends on what is at stake. Hence, choosing &lt;span
class=&quot;math inline&quot;&gt;\(c=0.05\)&lt;/span&gt; without additional thought is more
than arbitrary, but a more careful discussion is beyond the scope of
this blog note.&lt;/p&gt;
&lt;h2 id=&quot;hierarchical-model&quot;&gt;Hierarchical model&lt;/h2&gt;
&lt;p&gt;Commenting on the derivations done in &lt;span class=&quot;citation&quot;
data-cites=&quot;nishiura_etal2016&quot;&gt;Nishiura, Miyamatsu, and Mizumoto
(2016)&lt;/span&gt; from a Bayesian viewpoint, it appears more natural to
formulate the model directly in hierarchical terms:&lt;/p&gt;
&lt;p&gt;&lt;span class=&quot;math display&quot;&gt;\[
\begin{align*}
N_i                  &amp;amp;\sim
\operatorname{NegBin}(R_0,k),                    &amp;amp;
i&amp;amp;=1,\ldots,n,\\
\mathbf{O}_i\&amp;gt;|\&amp;gt;N_i &amp;amp;\sim
\operatorname{M}(N_i,\mathbf{p}_{\text{serial}}),&amp;amp;
i&amp;amp;=1,\ldots,n,\\
Y_t\&amp;gt;|\&amp;gt; \mathbf{O}  &amp;amp;= \sum_{i=1}^n O_{i,t_i-t}, &amp;amp;
t&amp;amp;=t^*+1,t^*+2,\ldots,\\
\end{align*}
\]&lt;/span&gt; where &lt;span
class=&quot;math inline&quot;&gt;\(\mathbf{p}_{\text{serial}}\)&lt;/span&gt; is the PMF of
the discretized serial interval distribution for exampling obtained by
computing &lt;span class=&quot;math inline&quot;&gt;\(p_{y} = F_{\text{serial}}(y) -
F_{\text{serial}}(y-1)\)&lt;/span&gt; for &lt;span
class=&quot;math inline&quot;&gt;\(0&amp;lt;y\leq S\)&lt;/span&gt;, where &lt;span
class=&quot;math inline&quot;&gt;\(S\)&lt;/span&gt; is the largest possible/relevant serial
interval to consider, and letting &lt;span class=&quot;math inline&quot;&gt;\(p_{0} =
0\)&lt;/span&gt;. Furthermore, &lt;span
class=&quot;math inline&quot;&gt;\(O_{i,t_i-t}=0\)&lt;/span&gt; if &lt;span
class=&quot;math inline&quot;&gt;\(t_i-t&amp;lt;0\)&lt;/span&gt; or &lt;span
class=&quot;math inline&quot;&gt;\(t_i-t&amp;gt;S\)&lt;/span&gt; and corresponds to the value
obtained from &lt;span
class=&quot;math inline&quot;&gt;\(M(N_i,\mathbf{p}_{\text{serial}})\)&lt;/span&gt;
otherwise. Finally, &lt;span
class=&quot;math inline&quot;&gt;\(\mathbf{O}=(\mathbf{O}_1,\ldots,\mathbf{O}_n)\)&lt;/span&gt;.&lt;/p&gt;
&lt;p&gt;Given &lt;span class=&quot;math inline&quot;&gt;\(R_0\)&lt;/span&gt; and &lt;span
class=&quot;math inline&quot;&gt;\(k\)&lt;/span&gt; it is easy to use Monte Carlo
simulation to obtain instances of &lt;span
class=&quot;math inline&quot;&gt;\(Y_t\)&lt;/span&gt; for a selected time-range from the
above model. The code for this function &lt;code&gt;simulation&lt;/code&gt; is
available as part of this R-markdown document (again, see the underlying
source on the github repository for details). Similarly to the previous
model the hierarchical model is also slightly conservative, because it
does not take existing secondary cases in the data into account and
samples &lt;span class=&quot;math inline&quot;&gt;\(N_i\)&lt;/span&gt; new secondary cases for
each observed case.&lt;/p&gt;
&lt;p&gt;Since we for this model will be using simulations it is easy to
modify the criterion for fade-out slightly to the more natural
probability &lt;span class=&quot;math inline&quot;&gt;\(\pi_t^*\)&lt;/span&gt; that no case at
&lt;span class=&quot;math inline&quot;&gt;\(t\)&lt;/span&gt; &lt;em&gt;nor beyond &lt;span
class=&quot;math inline&quot;&gt;\(t\)&lt;/span&gt;&lt;/em&gt; will occur, i.e. &lt;span
class=&quot;math display&quot;&gt;\[
\pi_t^* = P\left( \bigwedge_{i=t}^\infty \{Y_t = 0\} \right).
\]&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;We perform a study with 10000 different simulations each evaluated on
a grid from 2015-07-03 to 2015-07-27. The resulting values are stored in
the &lt;span class=&quot;math inline&quot;&gt;\(25 \times 10000\)&lt;/span&gt; matrix
&lt;code&gt;Y&lt;/code&gt; from which we can compute:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb10&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb10-1&quot;&gt;&lt;a href=&quot;#cb10-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;pi &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;apply&lt;/span&gt;(Y,&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;,mean)&lt;/span&gt;
&lt;span id=&quot;cb10-2&quot;&gt;&lt;a href=&quot;#cb10-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;pi[pi &lt;span class=&quot;sc&quot;&gt;&amp;lt;&lt;/span&gt; c_threshold]&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;## 2015-07-21 2015-07-22 2015-07-23 2015-07-24 2015-07-25 2015-07-26 2015-07-27 
##     0.0341     0.0197     0.0095     0.0037     0.0021     0.0013     0.0004&lt;/code&gt;&lt;/pre&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb12&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb12-1&quot;&gt;&lt;a href=&quot;#cb12-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##Better way to calc extinction prob.&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb12-2&quot;&gt;&lt;a href=&quot;#cb12-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;pi_star &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;rev&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;apply&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;apply&lt;/span&gt;(Y,&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;,&lt;span class=&quot;cf&quot;&gt;function&lt;/span&gt;(x) &lt;span class=&quot;fu&quot;&gt;cumsum&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;rev&lt;/span&gt;(x))&lt;span class=&quot;sc&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;0&lt;/span&gt;),&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;,mean))&lt;/span&gt;
&lt;span id=&quot;cb12-3&quot;&gt;&lt;a href=&quot;#cb12-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;pi_star[pi_star &lt;span class=&quot;sc&quot;&gt;&amp;lt;&lt;/span&gt; c_threshold]&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;## 2015-07-22 2015-07-23 2015-07-24 2015-07-25 2015-07-26 2015-07-27 
##     0.0343     0.0168     0.0075     0.0038     0.0017     0.0004&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;We note that the result, when using &lt;span
class=&quot;math inline&quot;&gt;\(\pi_t^*\)&lt;/span&gt; instead of &lt;span
class=&quot;math inline&quot;&gt;\(\pi_t\)&lt;/span&gt;, leads to the outbreak being
declared over one day later. Additional uncertainty handling is
performed as before by obtaining bootstrap samples for &lt;span
class=&quot;math inline&quot;&gt;\((\log R_0, \log k)&amp;#39;\)&lt;/span&gt; from the
asymptotic normal distribution. For each such sample the above Monte
Carlo procedure is executed allowing us to determine point-wise
confidence intervals for the probability by the percentile method.&lt;/p&gt;
&lt;p&gt;&lt;img
src=&quot;http://staff.math.su.se/hoehle/blog/figure/source/2016-08-04-outbreakEnd/Y_UNCERTAINTY-1.png&quot; /&gt;&lt;/p&gt;
&lt;h1 id=&quot;discussion&quot;&gt;Discussion&lt;/h1&gt;
&lt;p&gt;The present note introduced the statistical model based approach of
&lt;span class=&quot;citation&quot; data-cites=&quot;nishiura_etal2016&quot;&gt;Nishiura,
Miyamatsu, and Mizumoto (2016)&lt;/span&gt; for declaring the end of a
person-to-person transmitted disease outbreak such as MERS-Cov, Ebola,
etc. If the considered outbreak has a different mode of transmission,
e.g. foodborne or originates from a point-source, then different
formulas apply, see e.g. &lt;span class=&quot;citation&quot;
data-cites=&quot;brookmeyer_you2006&quot;&gt;Brookmeyer and You (2006)&lt;/span&gt;.
Interestingly enough, there appears to be some methodological overlap
between declaring the end of an outbreak and declaring a software
product to be free of errors.&lt;/p&gt;
&lt;p&gt;To summarise: The results of the &lt;span class=&quot;citation&quot;
data-cites=&quot;nishiura_etal2016&quot;&gt;Nishiura, Miyamatsu, and Mizumoto
(2016)&lt;/span&gt; paper could - with some fiddling to guesstimate the data -
be approximately reproduced. A hierarchical model with simulation based
inference was able to produce similar results. Availability of the full
data in electronic form would have been helpful. Altoghether, it was fun
to implement the method and hope is that the avaibility of the present
analysis and R code might be helpful to someone at some point. You are
certainly invited to &lt;strong&gt;reprofy&lt;/strong&gt; the present analysis.&lt;/p&gt;
&lt;center&gt;
&lt;img
src=&quot;https://openclipart.org/image/300px/svg_to_png/169987/copy.png&amp;amp;disposition=attachment&quot; /&gt;
&lt;/center&gt;
&lt;p&gt;
&lt;h3 id=&quot;acknowledgements&quot;&gt;Acknowledgements&lt;/h3&gt;
&lt;p&gt;I thank Hiroshi Nishiura for answering questions about their
paper.&lt;/p&gt;
&lt;h1 class=&quot;unnumbered&quot; id=&quot;references&quot;&gt;References&lt;/h1&gt;
&lt;div id=&quot;refs&quot; class=&quot;references csl-bib-body hanging-indent&quot;
data-entry-spacing=&quot;0&quot; role=&quot;list&quot;&gt;
&lt;div id=&quot;ref-brookmeyer_you2006&quot; class=&quot;csl-entry&quot; role=&quot;listitem&quot;&gt;
Brookmeyer, R., and X. You. 2006. &lt;span&gt;“&lt;span
class=&quot;nocase&quot;&gt;&lt;span&gt;A&lt;/span&gt; hypothesis test for the end of a common
source outbreak&lt;/span&gt;.”&lt;/span&gt; &lt;em&gt;Biometrics&lt;/em&gt; 62 (1): 61–65. &lt;a
href=&quot;https://doi.org/10.1111/j.1541-0420.2005.00421.x&quot;&gt;https://doi.org/10.1111/j.1541-0420.2005.00421.x&lt;/a&gt;.
&lt;/div&gt;
&lt;div id=&quot;ref-nishiura_etal2015&quot; class=&quot;csl-entry&quot; role=&quot;listitem&quot;&gt;
Nishiura, H., Y. Miyamatsu, G. Chowell, and M. Saitoh. 2015.
&lt;span&gt;“&lt;span class=&quot;nocase&quot;&gt;&lt;span&gt;A&lt;/span&gt;ssessing the risk of observing
multiple generations of &lt;span&gt;M&lt;/span&gt;iddle &lt;span&gt;E&lt;/span&gt;ast
respiratory syndrome
(&lt;span&gt;M&lt;/span&gt;&lt;span&gt;E&lt;/span&gt;&lt;span&gt;R&lt;/span&gt;&lt;span&gt;S&lt;/span&gt;) cases given
an imported case&lt;/span&gt;.”&lt;/span&gt; &lt;em&gt;Euro Surveill.&lt;/em&gt; 20 (27). &lt;a
href=&quot;https://doi.org/10.2807/1560-7917.ES2015.20.27.21181 &quot;&gt;https://doi.org/10.2807/1560-7917.ES2015.20.27.21181
&lt;/a&gt;.
&lt;/div&gt;
&lt;div id=&quot;ref-nishiura_etal2016&quot; class=&quot;csl-entry&quot; role=&quot;listitem&quot;&gt;
Nishiura, H., Y. Miyamatsu, and K. Mizumoto. 2016. &lt;span&gt;“&lt;span
class=&quot;nocase&quot;&gt;&lt;span&gt;O&lt;/span&gt;bjective &lt;span&gt;D&lt;/span&gt;etermination of
&lt;span&gt;E&lt;/span&gt;nd of
&lt;span&gt;M&lt;/span&gt;&lt;span&gt;E&lt;/span&gt;&lt;span&gt;R&lt;/span&gt;&lt;span&gt;S&lt;/span&gt;
&lt;span&gt;O&lt;/span&gt;utbreak, &lt;span&gt;S&lt;/span&gt;outh &lt;span&gt;K&lt;/span&gt;orea,
2015&lt;/span&gt;.”&lt;/span&gt; &lt;em&gt;Emerging Infect. Dis.&lt;/em&gt; 22 (1): 146–48. &lt;a
href=&quot;https://doi.org/10.3201/eid2201.151383&quot;&gt;https://doi.org/10.3201/eid2201.151383&lt;/a&gt;.
&lt;/div&gt;
&lt;div id=&quot;ref-svensson2007&quot; class=&quot;csl-entry&quot; role=&quot;listitem&quot;&gt;
Svensson, Å. 2007. &lt;span&gt;“&lt;span class=&quot;nocase&quot;&gt;&lt;span&gt;A&lt;/span&gt; note on
generation times in epidemic models&lt;/span&gt;.”&lt;/span&gt; &lt;em&gt;Math Biosci&lt;/em&gt;
208 (1): 300–311. &lt;a
href=&quot;https://doi.org/10.1016/j.mbs.2006.10.010&quot;&gt;https://doi.org/10.1016/j.mbs.2006.10.010&lt;/a&gt;.
&lt;/div&gt;
&lt;/div&gt;
</description>
        <pubDate>Thu, 04 Aug 2016 00:00:00 +0200</pubDate>
        <link>https://mhoehle.github.io/blog/2016/08/04/outbreakEnd.html</link>
        <guid isPermaLink="true">https://mhoehle.github.io/blog/2016/08/04/outbreakEnd.html</guid>
        
        <category>rstats</category>
        
        <category>infectious disease epidemiology</category>
        
        <category>open data</category>
        
        <category>MERS</category>
        
        
      </item>
    
      <item>
        <title>Casting Call for MERS-CoV in Korea, 2015</title>
        <description>&lt;h2 id=&quot;abstract&quot;&gt;Abstract&lt;/h2&gt;
&lt;p&gt;We perform an adjustment for observed-but-not-yet-reported cases
(aka. nowcasting) for the epidemic curve of the Middle East respiratory
syndrome coronavirus (MERS-CoV) outbreak in Korea, 2015. The analysis is
based on the publically available WHO data and aims at illustrating how
one could do real-time public health surveillance during critical
outbreaks.&lt;/p&gt;
&lt;p&gt;&lt;br&gt;
&lt;a rel=&quot;license&quot; href=&quot;http://creativecommons.org/licenses/by-sa/4.0/&quot;&gt;&lt;img alt=&quot;Creative Commons License&quot; style=&quot;border-width:0&quot; src=&quot;https://i.creativecommons.org/l/by-sa/4.0/88x31.png&quot;/&gt;&lt;/a&gt;
This work is licensed under a &lt;a rel=&quot;license&quot;
href=&quot;http://creativecommons.org/licenses/by-sa/4.0/&quot;&gt;Creative Commons
Attribution-ShareAlike 4.0 International License&lt;/a&gt;. The
markdown+Rknitr source code of this blog is available under a &lt;a
href=&quot;https://www.gnu.org/licenses/gpl-3.0.html&quot;&gt;GNU General Public
License (GPL v3)&lt;/a&gt; license from github.&lt;/p&gt;
&lt;h1 id=&quot;introduction&quot;&gt;Introduction&lt;/h1&gt;
&lt;p&gt;Short-range (0-6h) forecasts in the world of meteorology are also
called &lt;strong&gt;nowcasts&lt;/strong&gt;. The term has also found its way into
real-time infectious disease monitoring where one of its uses has been
to adjust the currently available epidemic curve during an outbreak for
structural and reporting delays.&lt;/p&gt;
&lt;p&gt;Whereas the original work in &lt;span class=&quot;citation&quot;
data-cites=&quot;hoehle_anderheiden2014&quot;&gt;Höhle and an der Heiden
(2014)&lt;/span&gt; was motivated by the large STEC O104:H4 outbreak in
Germany 2011, one of our secondary motivations was to develop a tool the
quantitative epidemiologist could use during similar high-profiled
outbreaks (instead of having to re-invent the wheel during times of
maximal stress). After my talk at the &lt;a
href=&quot;https://biometricconference.org/showcases/biometrics-showcase/&quot;&gt;IBC2016
conference&lt;/a&gt; (&lt;a
href=&quot;http://staff.math.su.se/hoehle/talks/IBC2016-Hoehle.pdf&quot;&gt;slides of
the talk&lt;/a&gt; - our received the &lt;em&gt;Best Paper in Biometrics by an IBS
Member in 2014&lt;/em&gt; award), one of the questions from the audience was
how much impact the work had in terms of being useful for other
outbreaks. Besides an analysis of an Adenovirus outbreak and a recent
analysis of an O157 outbreak, I was a little short on a convincing
answer. In addition, when trying to make a quick analysis for the O157
outbreak with the currently available code in the
&lt;code&gt;surveillance&lt;/code&gt; package it became obvious that the nowcasting
functionality in the package currently is a little rough and certainly
in need of a user-friendliness polishing.&lt;/p&gt;
&lt;p&gt;So this little blog-note serves three purposes:&lt;/p&gt;
&lt;ol type=&quot;1&quot;&gt;
&lt;li&gt;Illustrate how you can nowcasts with R, if you ever have to.&lt;/li&gt;
&lt;li&gt;Act as literate programming document for facilitating some code
improvements of the &lt;code&gt;nowcast&lt;/code&gt; function while providing a
vignette supported story.&lt;/li&gt;
&lt;li&gt;Perform an analysis of the WHO open-data on the MERS-CoV outbreak in
Korea in 2015.&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;The structure of this blog entry is as follows. We first discuss and
visualize the WHO data on the MERS-CoV outbreak. The findings from the
descriptive data analysis are then used to set up nowcasts adjusting the
observed epidemic curve during the outbreak for reporting delays between
onset of symptoms in cases and the date the case report arrived at the
WHO. Finally, we illustrate how to visualize a sequence of nowcasts
during an outbreak using an animation.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Update 2020-04-21&lt;/strong&gt;: Regarding the lack of convincing
use-case mentioned above. Four years after writing this blog post I can
now add: The nowcast functionality of the package is now in use by the
public health authorities in several German federal states as part of
their Covid-19 outbreak response, see for example &lt;a
href=&quot;https://corona.stat.uni-muenchen.de/nowcast/&quot;&gt;Bavaria&lt;/a&gt;.&lt;/p&gt;
&lt;h1 id=&quot;data&quot;&gt;Data&lt;/h1&gt;
&lt;p&gt;The data basis for our analysis is the WHO data on the &lt;a
href=&quot;http://www.who.int/csr/don/21-july-2015-mers-korea/en/&quot;&gt;MERS-Cov
outbreak in Korea&lt;/a&gt;, which occured during May-July 2015. Of interest
will be the delay (here measured in days) between the time point on
which a case has the onset of its MERS symptoms and the day the WHO
learns about this case. In other words we put ourself in the role of an
epidemiologist working at the WHO and who during the outbreak has to
report on how the outbreak is evolving in Korea.&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb1&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb1-1&quot;&gt;&lt;a href=&quot;#cb1-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##Load library to read excel files&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-2&quot;&gt;&lt;a href=&quot;#cb1-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;library&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;quot;openxlsx&amp;quot;&lt;/span&gt;)&lt;/span&gt;
&lt;span id=&quot;cb1-3&quot;&gt;&lt;a href=&quot;#cb1-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-4&quot;&gt;&lt;a href=&quot;#cb1-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##Obtain file from link found at (if it doesn&amp;#39;t already exist)&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-5&quot;&gt;&lt;a href=&quot;#cb1-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##http://www.who.int/csr/don/21-july-2015-mers-korea/en/&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-6&quot;&gt;&lt;a href=&quot;#cb1-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;cf&quot;&gt;if&lt;/span&gt; (&lt;span class=&quot;sc&quot;&gt;!&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;file.exists&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;quot;../downloads/MERS-CoV-cases-rok-21Jul15.xlsx&amp;quot;&lt;/span&gt;)) {&lt;/span&gt;
&lt;span id=&quot;cb1-7&quot;&gt;&lt;a href=&quot;#cb1-7&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;download.file&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;url=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;http://www.who.int/entity/csr/disease/coronavirus_infections/MERS-CoV-cases-rok-21Jul15.xlsx?ua=1&amp;quot;&lt;/span&gt;,&lt;span class=&quot;at&quot;&gt;destfile=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;../downloads/MERS-CoV-cases-rok-21Jul15.xlsx&amp;quot;&lt;/span&gt;)&lt;/span&gt;
&lt;span id=&quot;cb1-8&quot;&gt;&lt;a href=&quot;#cb1-8&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;}&lt;/span&gt;
&lt;span id=&quot;cb1-9&quot;&gt;&lt;a href=&quot;#cb1-9&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-10&quot;&gt;&lt;a href=&quot;#cb1-10&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##Read data&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-11&quot;&gt;&lt;a href=&quot;#cb1-11&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;linelist &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;read.xlsx&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;quot;../downloads/MERS-CoV-cases-rok-21Jul15.xlsx&amp;quot;&lt;/span&gt;,&lt;span class=&quot;at&quot;&gt;startRow=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;4&lt;/span&gt;,&lt;span class=&quot;at&quot;&gt;detectDates=&lt;/span&gt;&lt;span class=&quot;cn&quot;&gt;TRUE&lt;/span&gt;)&lt;/span&gt;
&lt;span id=&quot;cb1-12&quot;&gt;&lt;a href=&quot;#cb1-12&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-13&quot;&gt;&lt;a href=&quot;#cb1-13&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##Base R style - IMHO easier to understand than the dplyr way to do the same&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-14&quot;&gt;&lt;a href=&quot;#cb1-14&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;cf&quot;&gt;for&lt;/span&gt; (dateCol &lt;span class=&quot;cf&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;c&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;quot;Date.of.notification.to.WHO&amp;quot;&lt;/span&gt;,&lt;span class=&quot;st&quot;&gt;&amp;quot;Date.of.symptoms.onset&amp;quot;&lt;/span&gt;,&lt;span class=&quot;st&quot;&gt;&amp;quot;Date.of.first.hospitalization&amp;quot;&lt;/span&gt;,&lt;span class=&quot;st&quot;&gt;&amp;quot;Date.of.laboratory.confirmation&amp;quot;&lt;/span&gt;,&lt;span class=&quot;st&quot;&gt;&amp;quot;Date.of.outcome&amp;quot;&lt;/span&gt;)) {&lt;/span&gt;
&lt;span id=&quot;cb1-15&quot;&gt;&lt;a href=&quot;#cb1-15&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  linelist[,dateCol] &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;as.Date&lt;/span&gt;(linelist[,dateCol],&lt;span class=&quot;at&quot;&gt;format=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;%d/%m/%Y&amp;quot;&lt;/span&gt;)&lt;/span&gt;
&lt;span id=&quot;cb1-16&quot;&gt;&lt;a href=&quot;#cb1-16&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;}&lt;/span&gt;
&lt;span id=&quot;cb1-17&quot;&gt;&lt;a href=&quot;#cb1-17&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-18&quot;&gt;&lt;a href=&quot;#cb1-18&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##Make a delay column&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-19&quot;&gt;&lt;a href=&quot;#cb1-19&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;linelist&lt;span class=&quot;sc&quot;&gt;$&lt;/span&gt;delay &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;with&lt;/span&gt;(linelist,Date.of.notification.to.WHO &lt;span class=&quot;sc&quot;&gt;-&lt;/span&gt; Date.of.symptoms.onset)&lt;/span&gt;
&lt;span id=&quot;cb1-20&quot;&gt;&lt;a href=&quot;#cb1-20&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-21&quot;&gt;&lt;a href=&quot;#cb1-21&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;head&lt;/span&gt;(linelist,&lt;span class=&quot;at&quot;&gt;n=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;3&lt;/span&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;##   Case.no. Date.of.notification.to.WHO Age Sex Health.care.worker Comorbidities
## 1        1                  2015-05-20  68   M                 No          &amp;lt;NA&amp;gt;
## 2        2                  2015-05-22  63   F                 No          &amp;lt;NA&amp;gt;
## 3        3                  2015-05-22  76   M                 No          &amp;lt;NA&amp;gt;
##   Date.of.symptoms.onset Date.of.first.hospitalization Date.of.laboratory.confirmation
## 1             2015-05-11                    2015-05-15                      2015-05-20
## 2             2015-05-19                          &amp;lt;NA&amp;gt;                      2015-05-20
## 3             2015-05-20                          &amp;lt;NA&amp;gt;                      2015-05-20
##     Status Date.of.outcome  delay
## 1    Alive            &amp;lt;NA&amp;gt; 9 days
## 2    Alive            &amp;lt;NA&amp;gt; 3 days
## 3 Deceased      2015-06-04 2 days&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;As the outbreak is already over, it is easy to visualize the epidemic
curve in retrospect. We do so for the date of symptom onset.&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb3&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb3-1&quot;&gt;&lt;a href=&quot;#cb3-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##Show the epidemic curve as it occurs at the end of the outbreak&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb3-2&quot;&gt;&lt;a href=&quot;#cb3-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##using simple call to ggplot&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb3-3&quot;&gt;&lt;a href=&quot;#cb3-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;ggplot2&lt;span class=&quot;sc&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;ggplot&lt;/span&gt;( linelist, &lt;span class=&quot;fu&quot;&gt;aes&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;x=&lt;/span&gt;Date.of.symptoms.onset)) &lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;geom_histogram&lt;/span&gt;() &lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;xlab&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;quot;Date of onset of symptoms&amp;quot;&lt;/span&gt;) &lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;ylab&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;quot;Number of cases&amp;quot;&lt;/span&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;img
src=&quot;/blog/figure/source/2016-07-19-nowCast/EPICURVE-1.png&quot; /&gt;&lt;/p&gt;
&lt;p&gt;Furthermore, we can look at the delay distribution as it looks at the
end of the outbreak. We shall later look in more detail at this
distribution, but for now the plot gives an idea about the range of the
delay: in most cases the delay is between 1-14 days, actually 97.1% of
the observations have a lag smaller or equal to &lt;span
class=&quot;math inline&quot;&gt;\(D=14\)&lt;/span&gt;. As a consequence, we shall use
&lt;span class=&quot;math inline&quot;&gt;\(D=14\)&lt;/span&gt; as the maximum relevant lag to
adjust for.&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb4&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb4-1&quot;&gt;&lt;a href=&quot;#cb4-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;ggplot&lt;/span&gt;( linelist, &lt;span class=&quot;fu&quot;&gt;aes&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;x=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;as.integer&lt;/span&gt;(delay),&lt;span class=&quot;at&quot;&gt;y=&lt;/span&gt;..prop..)) &lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-2&quot;&gt;&lt;a href=&quot;#cb4-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt; &lt;span class=&quot;fu&quot;&gt;stat_count&lt;/span&gt;() &lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;scale_y_continuous&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;labels =&lt;/span&gt; scales&lt;span class=&quot;sc&quot;&gt;::&lt;/span&gt;percent) &lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;xlab&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;quot;Delay (days)&amp;quot;&lt;/span&gt;) &lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;ylab&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;quot;&amp;quot;&lt;/span&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;img
src=&quot;/blog/figure/source/2016-07-19-nowCast/unnamed-chunk-3-1.png&quot; /&gt;&lt;/p&gt;
&lt;p&gt;Instead of using &lt;code&gt;ggplot&lt;/code&gt; to show the epidemic curve, this
can also be done directly from the surveillance package using the
function &lt;code&gt;linelist2sts&lt;/code&gt;. This function takes a
&lt;code&gt;data.frame&lt;/code&gt; representing a linelist and converts this into
an object of class &lt;code&gt;sts&lt;/code&gt; (surveillance time series) used by
the package. This then allows the use of all the plotting functionality
of such objects as described in &lt;span class=&quot;citation&quot;
data-cites=&quot;salmon_etal2016a&quot;&gt;Salmon, Schumacher, and Höhle
(2016)&lt;/span&gt;. Note: For the nowcasting code of this blog entry to work,
the newest development version of the package, i.e. version 1.12.2
available from Rforge using&lt;/p&gt;
&lt;p&gt;
&lt;center&gt;
&lt;code&gt;install.packages(&quot;surveillance&quot;,repos=&quot;http://r-forge.r-project.org&quot;)&lt;/code&gt;
&lt;/center&gt;
&lt;p&gt;
&lt;p&gt;is needed. The code then looks as follows:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb5&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb5-1&quot;&gt;&lt;a href=&quot;#cb5-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##Load surveillance pkg.&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb5-2&quot;&gt;&lt;a href=&quot;#cb5-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;library&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;quot;surveillance&amp;quot;&lt;/span&gt;)&lt;/span&gt;
&lt;span id=&quot;cb5-3&quot;&gt;&lt;a href=&quot;#cb5-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb5-4&quot;&gt;&lt;a href=&quot;#cb5-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##Range of the symptom onset date variable&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb5-5&quot;&gt;&lt;a href=&quot;#cb5-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;so_range &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;range&lt;/span&gt;(linelist&lt;span class=&quot;sc&quot;&gt;$&lt;/span&gt;Date.of.symptoms.onset, &lt;span class=&quot;at&quot;&gt;na.rm=&lt;/span&gt;&lt;span class=&quot;cn&quot;&gt;TRUE&lt;/span&gt;)&lt;/span&gt;
&lt;span id=&quot;cb5-6&quot;&gt;&lt;a href=&quot;#cb5-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb5-7&quot;&gt;&lt;a href=&quot;#cb5-7&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##Create an sts time series from the linelist, which contains daily counts.&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb5-8&quot;&gt;&lt;a href=&quot;#cb5-8&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;sts &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;linelist2sts&lt;/span&gt;(linelist, &lt;span class=&quot;at&quot;&gt;dateCol=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;Date.of.symptoms.onset&amp;quot;&lt;/span&gt;, &lt;span class=&quot;at&quot;&gt;aggregate.by=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;1 day&amp;quot;&lt;/span&gt;, &lt;span class=&quot;at&quot;&gt;dRange=&lt;/span&gt;so_range)&lt;/span&gt;
&lt;span id=&quot;cb5-9&quot;&gt;&lt;a href=&quot;#cb5-9&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb5-10&quot;&gt;&lt;a href=&quot;#cb5-10&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##Show the resulting time series using the plot functionality for sts objects.&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb5-11&quot;&gt;&lt;a href=&quot;#cb5-11&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;plot&lt;/span&gt;(sts,&lt;span class=&quot;at&quot;&gt;legend.opts=&lt;/span&gt;&lt;span class=&quot;cn&quot;&gt;NULL&lt;/span&gt;,&lt;/span&gt;
&lt;span id=&quot;cb5-12&quot;&gt;&lt;a href=&quot;#cb5-12&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;     &lt;span class=&quot;at&quot;&gt;xaxis.tickFreq=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;list&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;quot;%d&amp;quot;&lt;/span&gt;&lt;span class=&quot;ot&quot;&gt;=&lt;/span&gt;atChange,&lt;span class=&quot;st&quot;&gt;&amp;quot;%m&amp;quot;&lt;/span&gt;&lt;span class=&quot;ot&quot;&gt;=&lt;/span&gt;atChange),&lt;/span&gt;
&lt;span id=&quot;cb5-13&quot;&gt;&lt;a href=&quot;#cb5-13&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;     &lt;span class=&quot;at&quot;&gt;xaxis.labelFreq=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;list&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;quot;%d&amp;quot;&lt;/span&gt;&lt;span class=&quot;ot&quot;&gt;=&lt;/span&gt;at2ndChange),&lt;span class=&quot;at&quot;&gt;xaxis.labelFormat=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;%d-%b&amp;quot;&lt;/span&gt;,&lt;/span&gt;
&lt;span id=&quot;cb5-14&quot;&gt;&lt;a href=&quot;#cb5-14&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;     &lt;span class=&quot;at&quot;&gt;xlab=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;Time (days)&amp;quot;&lt;/span&gt;,&lt;span class=&quot;at&quot;&gt;lty=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;c&lt;/span&gt;(&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;,&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;,&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;,&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;),&lt;span class=&quot;at&quot;&gt;lwd=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;c&lt;/span&gt;(&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;,&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;,&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;),&lt;/span&gt;
&lt;span id=&quot;cb5-15&quot;&gt;&lt;a href=&quot;#cb5-15&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;     &lt;span class=&quot;at&quot;&gt;ylab=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;No. symptom onsets&amp;quot;&lt;/span&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;img
src=&quot;/blog/figure/source/2016-07-19-nowCast/EPICURVE-SURVEILLANCE-1.png&quot; /&gt;&lt;/p&gt;
&lt;h2 id=&quot;nowcasting&quot;&gt;Nowcasting&lt;/h2&gt;
&lt;p&gt;We now move on to the nowcasts.&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb6&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb6-1&quot;&gt;&lt;a href=&quot;#cb6-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##State which date to nowcast&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb6-2&quot;&gt;&lt;a href=&quot;#cb6-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;now &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;as.Date&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;quot;2015-06-12&amp;quot;&lt;/span&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Say (in a mathematical sense) we move back time to 2015-06-12. In the
notation of &lt;span class=&quot;citation&quot;
data-cites=&quot;hoehle_anderheiden2014&quot;&gt;Höhle and an der Heiden
(2014)&lt;/span&gt; this means &lt;span
class=&quot;math inline&quot;&gt;\(T=2015-06-12\)&lt;/span&gt;. We want to illustrate what
the WHO could see at this point and, on the basis on the available
reports at time &lt;span class=&quot;math inline&quot;&gt;\(T\)&lt;/span&gt;, estimate the
delay distribution and adjust the observed cases accordingly. We shall
here only use the right-truncation delay adjusted procedure operating on
the generalized Dirichlet distribution. Since the nowcasts for the time
points very close to now are very volatile (i.e. have very large
credibility regions), it’s opportune to not display these casts as they
can be very hard to communicate. Also note that the selected date for
&lt;code&gt;now&lt;/code&gt; is selected such that enough cases are available to
give a sufficiently reliable estimate for the delay distribution.&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb7&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb7-1&quot;&gt;&lt;a href=&quot;#cb7-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##Nowcasts are displayed up to time (now - safePredictLag)&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb7-2&quot;&gt;&lt;a href=&quot;#cb7-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;safePredictLag &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;dv&quot;&gt;3&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb7-3&quot;&gt;&lt;a href=&quot;#cb7-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;nowcastDates &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;seq&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;from =&lt;/span&gt; so_range[&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;], &lt;span class=&quot;at&quot;&gt;to =&lt;/span&gt; now &lt;span class=&quot;sc&quot;&gt;-&lt;/span&gt; safePredictLag, &lt;span class=&quot;at&quot;&gt;by =&lt;/span&gt; &lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;We now perform right-truncation adjusted Bayesian nowcasting using
the generalized Dirichlet distribution. An important choice is here the
prior for the expected number of cases per day, i.e. &lt;span
class=&quot;math inline&quot;&gt;\(\lambda_t\)&lt;/span&gt; in the notation of &lt;span
class=&quot;citation&quot; data-cites=&quot;hoehle_anderheiden2014&quot;&gt;Höhle and an der
Heiden (2014)&lt;/span&gt;. In the conjugate case this is specified by
assuming an iid. Gamma-distribution for &lt;span
class=&quot;math inline&quot;&gt;\(\lambda_t\)&lt;/span&gt;, which is specified through
prior mean and prior variance of the Gamma distribution. We here select
here an empirical Bayes inspired approach and estimate these parameters
from the currently available data. However, note: These data are by
definition of the problem incomplete. As a dirty fix we therefore just
inflate the prior variance by a factor - as future work this needs to be
improved upon by following a proper marginal likelihood approach.&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb8&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb8-1&quot;&gt;&lt;a href=&quot;#cb8-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;nc.control &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;list&lt;/span&gt;(&lt;/span&gt;
&lt;span id=&quot;cb8-2&quot;&gt;&lt;a href=&quot;#cb8-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;at&quot;&gt;N.tInf.prior =&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;structure&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;quot;poisgamma&amp;quot;&lt;/span&gt;,&lt;/span&gt;
&lt;span id=&quot;cb8-3&quot;&gt;&lt;a href=&quot;#cb8-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;                           &lt;span class=&quot;at&quot;&gt;mean.lambda =&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;mean&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;observed&lt;/span&gt;(sts)),&lt;/span&gt;
&lt;span id=&quot;cb8-4&quot;&gt;&lt;a href=&quot;#cb8-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;                           &lt;span class=&quot;at&quot;&gt;var.lambda =&lt;/span&gt; &lt;span class=&quot;dv&quot;&gt;5&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;var&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;observed&lt;/span&gt;(sts))&lt;/span&gt;
&lt;span id=&quot;cb8-5&quot;&gt;&lt;a href=&quot;#cb8-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;                           ),&lt;/span&gt;
&lt;span id=&quot;cb8-6&quot;&gt;&lt;a href=&quot;#cb8-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;do&quot;&gt;##compute predictive distribution as wel, which is needed for some of the&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb8-7&quot;&gt;&lt;a href=&quot;#cb8-7&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;do&quot;&gt;##animations.&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb8-8&quot;&gt;&lt;a href=&quot;#cb8-8&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;at&quot;&gt;predPMF =&lt;/span&gt; &lt;span class=&quot;cn&quot;&gt;TRUE&lt;/span&gt;,&lt;/span&gt;
&lt;span id=&quot;cb8-9&quot;&gt;&lt;a href=&quot;#cb8-9&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;at&quot;&gt;dRange =&lt;/span&gt; so_range)&lt;/span&gt;
&lt;span id=&quot;cb8-10&quot;&gt;&lt;a href=&quot;#cb8-10&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb8-11&quot;&gt;&lt;a href=&quot;#cb8-11&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;## Now run the nowcast (NA dates are removed from the dataset).&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb8-12&quot;&gt;&lt;a href=&quot;#cb8-12&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;nc &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;nowcast&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;now =&lt;/span&gt; now, &lt;span class=&quot;at&quot;&gt;when =&lt;/span&gt; nowcastDates, &lt;span class=&quot;at&quot;&gt;data =&lt;/span&gt; linelist,&lt;/span&gt;
&lt;span id=&quot;cb8-13&quot;&gt;&lt;a href=&quot;#cb8-13&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;              &lt;span class=&quot;at&quot;&gt;dEventCol =&lt;/span&gt; &lt;span class=&quot;st&quot;&gt;&amp;quot;Date.of.symptoms.onset&amp;quot;&lt;/span&gt;,&lt;/span&gt;
&lt;span id=&quot;cb8-14&quot;&gt;&lt;a href=&quot;#cb8-14&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;              &lt;span class=&quot;at&quot;&gt;dReportCol =&lt;/span&gt; &lt;span class=&quot;st&quot;&gt;&amp;quot;Date.of.notification.to.WHO&amp;quot;&lt;/span&gt;,&lt;/span&gt;
&lt;span id=&quot;cb8-15&quot;&gt;&lt;a href=&quot;#cb8-15&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;              &lt;span class=&quot;at&quot;&gt;method =&lt;/span&gt; &lt;span class=&quot;st&quot;&gt;&amp;quot;bayes.trunc&amp;quot;&lt;/span&gt;, &lt;span class=&quot;co&quot;&gt;#use the conjugate generalized dirichlet&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb8-16&quot;&gt;&lt;a href=&quot;#cb8-16&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;              &lt;span class=&quot;at&quot;&gt;aggregate.by =&lt;/span&gt; &lt;span class=&quot;st&quot;&gt;&amp;quot;1 day&amp;quot;&lt;/span&gt;,&lt;/span&gt;
&lt;span id=&quot;cb8-17&quot;&gt;&lt;a href=&quot;#cb8-17&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;              &lt;span class=&quot;at&quot;&gt;D =&lt;/span&gt; &lt;span class=&quot;dv&quot;&gt;14&lt;/span&gt;, &lt;span class=&quot;co&quot;&gt;#adjust cases up to 2 weeks back.&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb8-18&quot;&gt;&lt;a href=&quot;#cb8-18&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;              &lt;span class=&quot;at&quot;&gt;control =&lt;/span&gt; nc.control)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;## Removed 13 records due to NA dates.&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;The resulting object is of class &lt;code&gt;stsNC&lt;/code&gt;, which is just a
class inheriting from the &lt;code&gt;sts&lt;/code&gt; class. Hence, all the usual
plotting functions apply to it. In addition, a plot of an
&lt;code&gt;stsNC&lt;/code&gt; object as shown below, contains the median of the
pointwise predictive distribution (thick blue line) as well as
equi-tailed 95% credibility regions (dashed orange lines).&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb10&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb10-1&quot;&gt;&lt;a href=&quot;#cb10-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;plot&lt;/span&gt;(nc, &lt;span class=&quot;at&quot;&gt;legend.opts=&lt;/span&gt;&lt;span class=&quot;cn&quot;&gt;NULL&lt;/span&gt;,&lt;/span&gt;
&lt;span id=&quot;cb10-2&quot;&gt;&lt;a href=&quot;#cb10-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;     &lt;span class=&quot;at&quot;&gt;xaxis.tickFreq=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;list&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;quot;%d&amp;quot;&lt;/span&gt;&lt;span class=&quot;ot&quot;&gt;=&lt;/span&gt;atChange,&lt;span class=&quot;st&quot;&gt;&amp;quot;%m&amp;quot;&lt;/span&gt;&lt;span class=&quot;ot&quot;&gt;=&lt;/span&gt;atChange),&lt;/span&gt;
&lt;span id=&quot;cb10-3&quot;&gt;&lt;a href=&quot;#cb10-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;     &lt;span class=&quot;at&quot;&gt;xaxis.labelFreq=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;list&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;quot;%d&amp;quot;&lt;/span&gt;&lt;span class=&quot;ot&quot;&gt;=&lt;/span&gt;at2ndChange),&lt;span class=&quot;at&quot;&gt;xaxis.labelFormat=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;%d-%b&amp;quot;&lt;/span&gt;,&lt;/span&gt;
&lt;span id=&quot;cb10-4&quot;&gt;&lt;a href=&quot;#cb10-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;     &lt;span class=&quot;at&quot;&gt;xlab=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;Time (days)&amp;quot;&lt;/span&gt;,&lt;span class=&quot;at&quot;&gt;lty=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;c&lt;/span&gt;(&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;,&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;,&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;,&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;),&lt;span class=&quot;at&quot;&gt;lwd=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;c&lt;/span&gt;(&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;,&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;,&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;),&lt;/span&gt;
&lt;span id=&quot;cb10-5&quot;&gt;&lt;a href=&quot;#cb10-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;     &lt;span class=&quot;at&quot;&gt;ylab=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;No. symptom onsets&amp;quot;&lt;/span&gt;,&lt;span class=&quot;at&quot;&gt;ylim=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;c&lt;/span&gt;(&lt;span class=&quot;dv&quot;&gt;0&lt;/span&gt;,&lt;span class=&quot;fu&quot;&gt;max&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;observed&lt;/span&gt;(nc),&lt;span class=&quot;fu&quot;&gt;upperbound&lt;/span&gt;(nc),&lt;span class=&quot;fu&quot;&gt;predint&lt;/span&gt;(nc),&lt;span class=&quot;at&quot;&gt;na.rm=&lt;/span&gt;&lt;span class=&quot;cn&quot;&gt;TRUE&lt;/span&gt;)))&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;img
src=&quot;/blog/figure/source/2016-07-19-nowCast/NOWCASTPLOT-1.png&quot; /&gt;&lt;/p&gt;
&lt;p&gt;Finally, we can for &lt;code&gt;stsNC&lt;/code&gt; objects show a simple
non-parametric estimate of the delay distribution as a function of time
using a window-smoothed approach with window width &lt;span
class=&quot;math inline&quot;&gt;\(2w+1\)&lt;/span&gt;, see &lt;span class=&quot;citation&quot;
data-cites=&quot;hoehle_anderheiden2014&quot;&gt;Höhle and an der Heiden
(2014)&lt;/span&gt; for details.&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb11&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb11-1&quot;&gt;&lt;a href=&quot;#cb11-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;plot&lt;/span&gt;(nc, &lt;span class=&quot;at&quot;&gt;type=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;delay&amp;quot;&lt;/span&gt;, &lt;span class=&quot;at&quot;&gt;dates=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;seq&lt;/span&gt;(so_range[&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;],now,&lt;span class=&quot;at&quot;&gt;by=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;1 day&amp;quot;&lt;/span&gt;),&lt;span class=&quot;at&quot;&gt;w=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;img
src=&quot;/blog/figure/source/2016-07-19-nowCast/NOWCASTDELAY-1.png&quot; /&gt;&lt;/p&gt;
&lt;p&gt;The figure shows for each time point &lt;span
class=&quot;math inline&quot;&gt;\(t\)&lt;/span&gt; the median as well as the 10% and 90%
quantile of the empirical distribution of delays within the window of
&lt;span class=&quot;math inline&quot;&gt;\(t-w,\ldots,t+w\)&lt;/span&gt;. Note: This simple
estimate ignores the right- truncation, hence, within the period of
&lt;code&gt;(now-D):now&lt;/code&gt; there will be a bias of these estimates towards
shorter delays. This biased period is illustrated in the figure by the
light-gray shaded area. Furthermore, the median of the model based
estimate for the delay distribution is shown for the period of
&lt;code&gt;(now-m:now)&lt;/code&gt;. From the figure one has the suspicion that the
delay decreased a bit over time, but the decrease totally at the end
could also be due to right-truncation. However, assuming a
&lt;strong&gt;time-invariant delay distribution&lt;/strong&gt; for the entire
outbreak would probably give unsatisfactory results. Hence, we shall for
each time point use only a moving window consisting of all observations
occuring within the period &lt;code&gt;(now-m):now&lt;/code&gt;. We select &lt;span
class=&quot;math inline&quot;&gt;\(m=14\)&lt;/span&gt; for estimating the delay
distribution.&lt;/p&gt;
&lt;p&gt;This means that only the &lt;span class=&quot;math inline&quot;&gt;\(m+1\)&lt;/span&gt;=15
most recent days of the reporting triangle are considered at each
instance of “now” when estimating the delay distribution, i.e. there
will be 15 observations on number of reports with a delay of 0 days,
there will be 14 observationson on number of reports with a delay of 1
day, …, there will be 1 observation on number of reports with a delay 14
days. Based on the right-truncation adjusted estimation procedure these
observations then lead to an estimate of the PMF of the delay. Due to
the sliding window this estimate will be more uncertain (especially for
the long delays), but if the delay reduces over time, this is more
appropriately reflected, because old cases do not contribute to the
delay estimation anymore.&lt;/p&gt;
&lt;h2 id=&quot;showing-a-sequence-of-nowcasts&quot;&gt;Showing a sequence of
nowcasts&lt;/h2&gt;
&lt;p&gt;Once a couple of nowcasts have been performed it can also be helpful
to visualize the sequence of nowcasts using an animation. This is easily
done by first generating a list of nowcast results followed by a call to
&lt;code&gt;surveillance::animate_nowcasts&lt;/code&gt;.&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb12&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb12-1&quot;&gt;&lt;a href=&quot;#cb12-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##Nowcast all time points (except for the first three weeks). This might take a while.&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb12-2&quot;&gt;&lt;a href=&quot;#cb12-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;nowcasts &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;list&lt;/span&gt;()&lt;/span&gt;
&lt;span id=&quot;cb12-3&quot;&gt;&lt;a href=&quot;#cb12-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;animRange &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;seq&lt;/span&gt;(so_range[&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;]&lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;21&lt;/span&gt;,so_range[&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;],&lt;span class=&quot;at&quot;&gt;by=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;1 day&amp;quot;&lt;/span&gt;)&lt;/span&gt;
&lt;span id=&quot;cb12-4&quot;&gt;&lt;a href=&quot;#cb12-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb12-5&quot;&gt;&lt;a href=&quot;#cb12-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##Do nowcasts for the rage of dates&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb12-6&quot;&gt;&lt;a href=&quot;#cb12-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;cf&quot;&gt;for&lt;/span&gt; (i &lt;span class=&quot;cf&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;seq_len&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;length&lt;/span&gt;(animRange))) {&lt;/span&gt;
&lt;span id=&quot;cb12-7&quot;&gt;&lt;a href=&quot;#cb12-7&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  today &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; animRange[i]&lt;/span&gt;
&lt;span id=&quot;cb12-8&quot;&gt;&lt;a href=&quot;#cb12-8&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;print&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;as.character&lt;/span&gt;(today))&lt;/span&gt;
&lt;span id=&quot;cb12-9&quot;&gt;&lt;a href=&quot;#cb12-9&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb12-10&quot;&gt;&lt;a href=&quot;#cb12-10&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  new_nowcastDates &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;seq&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;from =&lt;/span&gt; so_range[&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;], &lt;span class=&quot;at&quot;&gt;to =&lt;/span&gt; today &lt;span class=&quot;sc&quot;&gt;-&lt;/span&gt; safePredictLag, &lt;span class=&quot;at&quot;&gt;by =&lt;/span&gt; &lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;)&lt;/span&gt;
&lt;span id=&quot;cb12-11&quot;&gt;&lt;a href=&quot;#cb12-11&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb12-12&quot;&gt;&lt;a href=&quot;#cb12-12&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  nowcasts[[&lt;span class=&quot;fu&quot;&gt;as.character&lt;/span&gt;(today)]] &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;nowcast&lt;/span&gt;(&lt;/span&gt;
&lt;span id=&quot;cb12-13&quot;&gt;&lt;a href=&quot;#cb12-13&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;at&quot;&gt;now =&lt;/span&gt; today, &lt;span class=&quot;at&quot;&gt;when =&lt;/span&gt; new_nowcastDates, &lt;span class=&quot;at&quot;&gt;data =&lt;/span&gt; linelist,&lt;/span&gt;
&lt;span id=&quot;cb12-14&quot;&gt;&lt;a href=&quot;#cb12-14&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;at&quot;&gt;dEventCol =&lt;/span&gt; &lt;span class=&quot;st&quot;&gt;&amp;quot;Date.of.symptoms.onset&amp;quot;&lt;/span&gt;,&lt;/span&gt;
&lt;span id=&quot;cb12-15&quot;&gt;&lt;a href=&quot;#cb12-15&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;at&quot;&gt;dReportCol =&lt;/span&gt; &lt;span class=&quot;st&quot;&gt;&amp;quot;Date.of.notification.to.WHO&amp;quot;&lt;/span&gt;,&lt;/span&gt;
&lt;span id=&quot;cb12-16&quot;&gt;&lt;a href=&quot;#cb12-16&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;at&quot;&gt;method =&lt;/span&gt; &lt;span class=&quot;st&quot;&gt;&amp;quot;bayes.trunc&amp;quot;&lt;/span&gt;,&lt;/span&gt;
&lt;span id=&quot;cb12-17&quot;&gt;&lt;a href=&quot;#cb12-17&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;at&quot;&gt;aggregate.by =&lt;/span&gt; &lt;span class=&quot;st&quot;&gt;&amp;quot;1 day&amp;quot;&lt;/span&gt;,&lt;/span&gt;
&lt;span id=&quot;cb12-18&quot;&gt;&lt;a href=&quot;#cb12-18&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;at&quot;&gt;D =&lt;/span&gt; &lt;span class=&quot;dv&quot;&gt;14&lt;/span&gt;,&lt;/span&gt;
&lt;span id=&quot;cb12-19&quot;&gt;&lt;a href=&quot;#cb12-19&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;at&quot;&gt;m =&lt;/span&gt; &lt;span class=&quot;dv&quot;&gt;14&lt;/span&gt;, &lt;span class=&quot;do&quot;&gt;##moving window of 14+1 days for estimation&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb12-20&quot;&gt;&lt;a href=&quot;#cb12-20&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;at&quot;&gt;control =&lt;/span&gt; nc.control)&lt;/span&gt;
&lt;span id=&quot;cb12-21&quot;&gt;&lt;a href=&quot;#cb12-21&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;We will use the &lt;code&gt;animation&lt;/code&gt; package to wrap the call to
&lt;code&gt;animate_nowcasts&lt;/code&gt; in order to generate an animated GIF.
Better control over the obtained animation can be obtained using the
&lt;code&gt;animation::saveHTML&lt;/code&gt; function. If one wants to include the
animation into a Power-Point presentation, I recommend the use of Flash
animations (&lt;code&gt;animation::saveSWF&lt;/code&gt;). Note that the animation
package requires &lt;a
href=&quot;http://www.imagemagick.org/script/index.php&quot;&gt;ImageMagick&lt;/a&gt; to be
installed on your system.&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb13&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb13-1&quot;&gt;&lt;a href=&quot;#cb13-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;animation&lt;span class=&quot;sc&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;saveGIF&lt;/span&gt;( {&lt;/span&gt;
&lt;span id=&quot;cb13-2&quot;&gt;&lt;a href=&quot;#cb13-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;par&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;mar=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;c&lt;/span&gt;(&lt;span class=&quot;fl&quot;&gt;5.5&lt;/span&gt;, &lt;span class=&quot;dv&quot;&gt;4&lt;/span&gt;, &lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;, &lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;) &lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;fl&quot;&gt;0.1&lt;/span&gt;) ; &lt;span class=&quot;do&quot;&gt;##add extra space at the bottom and remove at top&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb13-3&quot;&gt;&lt;a href=&quot;#cb13-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;animate_nowcasts&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;nowcasts =&lt;/span&gt; nowcasts,&lt;/span&gt;
&lt;span id=&quot;cb13-4&quot;&gt;&lt;a href=&quot;#cb13-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;                   &lt;span class=&quot;at&quot;&gt;linelist_truth =&lt;/span&gt; linelist,&lt;/span&gt;
&lt;span id=&quot;cb13-5&quot;&gt;&lt;a href=&quot;#cb13-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;                   &lt;span class=&quot;at&quot;&gt;method =&lt;/span&gt; &lt;span class=&quot;st&quot;&gt;&amp;quot;bayes.trunc&amp;quot;&lt;/span&gt;, &lt;span class=&quot;co&quot;&gt;#nowcast method to use (has to be in the casts)&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb13-6&quot;&gt;&lt;a href=&quot;#cb13-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;                   &lt;span class=&quot;at&quot;&gt;control =&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;list&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;sys.sleep=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;0&lt;/span&gt;,&lt;span class=&quot;at&quot;&gt;dRange=&lt;/span&gt;nc.control&lt;span class=&quot;sc&quot;&gt;$&lt;/span&gt;dRange,&lt;span class=&quot;at&quot;&gt;anim.dRange=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;range&lt;/span&gt;(animRange),&lt;span class=&quot;at&quot;&gt;ylim=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;c&lt;/span&gt;(&lt;span class=&quot;dv&quot;&gt;0&lt;/span&gt;,&lt;span class=&quot;dv&quot;&gt;40&lt;/span&gt;))) },&lt;/span&gt;
&lt;span id=&quot;cb13-7&quot;&gt;&lt;a href=&quot;#cb13-7&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;at&quot;&gt;movie.name=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;animate-nowcasts.gif&amp;quot;&lt;/span&gt;, &lt;span class=&quot;at&quot;&gt;ani.width=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;800&lt;/span&gt;, &lt;span class=&quot;at&quot;&gt;ani.height=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;500&lt;/span&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;img
src=&quot;/blog/figure/source/2016-07-19-nowCast/animate-nowcasts.gif&quot; /&gt;&lt;/p&gt;
&lt;p&gt;As a final comparison we can also obtain an animation of how the
delay distribution changes with time. From the animation we notice that
the delay appears to steadily decrease, which is a typical behavior for
high-profiled outbreaks. However, this also questions the assumption of
a &lt;strong&gt;time-invariant delay distribution&lt;/strong&gt;. Instead, one could
use a window-limited estimation approach or one could try to model the
delay distribution using a discrete time survival model as done in &lt;span
class=&quot;citation&quot; data-cites=&quot;hoehle_anderheiden2014&quot;&gt;Höhle and an der
Heiden (2014)&lt;/span&gt;. The animation below uses the above mentioned
sliding-window approach, which is noticed by the estimate of &lt;span
class=&quot;math inline&quot;&gt;\(q_{0.5}^{\text{bayes.trunc(T)}}\)&lt;/span&gt; changing
for each &lt;span class=&quot;math inline&quot;&gt;\(T\)&lt;/span&gt;.&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb14&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb14-1&quot;&gt;&lt;a href=&quot;#cb14-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;animation&lt;span class=&quot;sc&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;saveGIF&lt;/span&gt;(&lt;/span&gt;
&lt;span id=&quot;cb14-2&quot;&gt;&lt;a href=&quot;#cb14-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;cf&quot;&gt;for&lt;/span&gt; (i &lt;span class=&quot;cf&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;seq_len&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;length&lt;/span&gt;(nowcasts))) {&lt;/span&gt;
&lt;span id=&quot;cb14-3&quot;&gt;&lt;a href=&quot;#cb14-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;fu&quot;&gt;plot&lt;/span&gt;(nowcasts[[i]], &lt;span class=&quot;at&quot;&gt;w=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;3&lt;/span&gt;, &lt;span class=&quot;at&quot;&gt;type=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;delay&amp;quot;&lt;/span&gt;)&lt;/span&gt;
&lt;span id=&quot;cb14-4&quot;&gt;&lt;a href=&quot;#cb14-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  },&lt;/span&gt;
&lt;span id=&quot;cb14-5&quot;&gt;&lt;a href=&quot;#cb14-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;at&quot;&gt;movie.name=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;animate-delays.gif&amp;quot;&lt;/span&gt;, &lt;span class=&quot;at&quot;&gt;ani.width=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;800&lt;/span&gt;, &lt;span class=&quot;at&quot;&gt;ani.height=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;500&lt;/span&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;img
src=&quot;/blog/figure/source/2016-07-19-nowCast/animate-delays.gif&quot; /&gt;&lt;/p&gt;
&lt;h1 id=&quot;discussion&quot;&gt;Discussion&lt;/h1&gt;
&lt;p&gt;The adjustment of occurred-but-not-yet-reported-events applies to
many other application areas besides &lt;strong&gt;real-time public health
monitoring&lt;/strong&gt;. For example, direct links to claims reserve
modelling in actuarial sciences exist, but many other areas of
application, where delays play a role, appear of interest. For the
methodological details of the nowcasting procedures see &lt;span
class=&quot;citation&quot; data-cites=&quot;hoehle_anderheiden2014&quot;&gt;Höhle and an der
Heiden (2014)&lt;/span&gt;, which is available as open access document. The
present blog entry focused on getting methods operational using R - the
R code of this blog post is available from &lt;a
href=&quot;https://raw.githubusercontent.com/hoehleatsu/hoehleatsu.github.io/master/_source/2016-07-19-nowCast.Rmd&quot;&gt;github&lt;/a&gt;.&lt;/p&gt;
&lt;h1 id=&quot;acknowledgements&quot;&gt;Acknowledgements&lt;/h1&gt;
&lt;p&gt;Work on the surveillance package was supported by the Swedish
Research Council (2015_05182_VR).&lt;/p&gt;
&lt;h1 class=&quot;unnumbered&quot; id=&quot;references&quot;&gt;References&lt;/h1&gt;
&lt;div id=&quot;refs&quot; class=&quot;references csl-bib-body hanging-indent&quot;
data-entry-spacing=&quot;0&quot; role=&quot;list&quot;&gt;
&lt;div id=&quot;ref-hoehle_anderheiden2014&quot; class=&quot;csl-entry&quot; role=&quot;listitem&quot;&gt;
Höhle, M., and M. an der Heiden. 2014. &lt;span&gt;“Bayesian Nowcasting During
the &lt;span&gt;STEC O104:H4&lt;/span&gt; Outbreak in &lt;span&gt;Germany&lt;/span&gt;,
2011.”&lt;/span&gt; &lt;em&gt;Biometrics&lt;/em&gt; 70 (4): 993–1002. &lt;a
href=&quot;https://doi.org/10.1111/biom.12194&quot;&gt;https://doi.org/10.1111/biom.12194&lt;/a&gt;.
&lt;/div&gt;
&lt;div id=&quot;ref-salmon_etal2016a&quot; class=&quot;csl-entry&quot; role=&quot;listitem&quot;&gt;
Salmon, M., D. Schumacher, and M. Höhle. 2016. &lt;span&gt;“Monitoring Count
Time Series in &lt;span&gt;R&lt;/span&gt;: Aberration Detection in Public Health
Surveillance.”&lt;/span&gt; &lt;em&gt;Journal of Statistical Software&lt;/em&gt; 70 (10).
&lt;a
href=&quot;https://doi.org/10.18637/jss.v070.i10&quot;&gt;https://doi.org/10.18637/jss.v070.i10&lt;/a&gt;.
&lt;/div&gt;
&lt;/div&gt;
</description>
        <pubDate>Tue, 19 Jul 2016 00:00:00 +0200</pubDate>
        <link>https://mhoehle.github.io/blog/2016/07/19/nowCast.html</link>
        <guid isPermaLink="true">https://mhoehle.github.io/blog/2016/07/19/nowCast.html</guid>
        
        <category>math</category>
        
        <category>rstats</category>
        
        <category>surveillance</category>
        
        <category>open data</category>
        
        <category>MERS</category>
        
        
      </item>
    
      <item>
        <title>Princes Disguised in Uniforms</title>
        <description>&lt;h2 id=&quot;abstract&quot;&gt;Abstract&lt;/h2&gt;
&lt;p&gt;We revisit the &lt;strong&gt;secretary problem&lt;/strong&gt; as a mathematical
fairy tale: Princes wooing a princess sequentially arrive each having a
qualification score originating from a known parametric distribution
with all parameters known, e.g., the standard uniform distribution or
the normal distribution with known mean and variance. For this so called
&lt;strong&gt;full information game&lt;/strong&gt; the question of interest is: How
does the optimal strategy look, which maximizes the expected score of
the selected candidate? As a further twist: How does the strategy
change, if we sequentially have to estimate the parameters of the
distribution alongside? The later variant is called the &lt;strong&gt;partial
information game&lt;/strong&gt; and is nicely addressed using sequential
Bayesian updating.&lt;/p&gt;
&lt;p&gt;&lt;br&gt;
&lt;a rel=&quot;license&quot; href=&quot;http://creativecommons.org/licenses/by-sa/4.0/&quot;&gt;&lt;img alt=&quot;Creative Commons License&quot; style=&quot;border-width:0&quot; src=&quot;https://i.creativecommons.org/l/by-sa/4.0/88x31.png&quot;/&gt;&lt;/a&gt;
This work is licensed under a &lt;a rel=&quot;license&quot;
href=&quot;http://creativecommons.org/licenses/by-sa/4.0/&quot;&gt;Creative Commons
Attribution-ShareAlike 4.0 International License&lt;/a&gt;. The
markdown+Rknitr source code of this blog is available under a &lt;a
href=&quot;https://www.gnu.org/licenses/gpl-3.0.html&quot;&gt;GNU General Public
License (GPL v3)&lt;/a&gt; license from github.&lt;/p&gt;
&lt;h1 id=&quot;introduction&quot;&gt;Introduction&lt;/h1&gt;
&lt;p&gt;In the last blog post &lt;a href=&quot;../12/optimalChoice.html&quot;&gt;&lt;em&gt;Optimal
Choice - Mathematical Advice for Real Life&lt;/em&gt;&lt;/a&gt; our interest was in
determining a strategy to select the overall best candidate from a
sequence of &lt;span class=&quot;math inline&quot;&gt;\(n\)&lt;/span&gt; candidates
(e.g. princes, job candidates, houses, bids or tinder profiles) arriving
sequentially. It was shown that the optimal strategy is to screen a
number of candidates &lt;span class=&quot;math inline&quot;&gt;\(r-1\)&lt;/span&gt; in order
to form a baseline and then, starting from the &lt;span
class=&quot;math inline&quot;&gt;\(r\)&lt;/span&gt;’th candidate, select the first
candidate better than the baseline. If no candidate was chosen before
the &lt;span class=&quot;math inline&quot;&gt;\(n\)&lt;/span&gt;’th candidate this last
candidate has to be selected no matter what. The natural phenomena of
getting &lt;em&gt;desperate towards the end&lt;/em&gt; was observed, if the
objective of finding &lt;em&gt;the&lt;/em&gt; best is changed to maximizing the
expected rank of the selected candidate.&lt;/p&gt;
&lt;p&gt;In this blog post we study the situation, where additional
information about the absolute score of the candidates (instead of just
their relative ranks) is available. In particular we assume that the
candidate scores are known to originate from a known &lt;strong&gt;underlying
distribution&lt;/strong&gt;, e.g. the uniform or the standard normal. This
means that not only the underlying parametric family of the scores are
known, but also the parameters of the distribution. In what follows we
use the work of &lt;span class=&quot;citation&quot; data-cites=&quot;guttman1960&quot;&gt;Guttman
(1960)&lt;/span&gt; to describe the problem in mathematical notation and
discuss solution strategies. Then we move on to the work of &lt;span
class=&quot;citation&quot; data-cites=&quot;stewart1978&quot;&gt;Stewart (1978)&lt;/span&gt; in order
to investigate how the strategy changes, if we also have to
simultaneously estimate the parameters of the distribution alongside. &lt;a
href=&quot;https://www.r-project.org/&quot;&gt;&lt;strong&gt;R code&lt;/strong&gt;&lt;/a&gt;
implementing the optimal strategies is provided for both situations in
order to enable prudent decision support for real-life problems.&lt;/p&gt;
&lt;h1 id=&quot;methods&quot;&gt;Methods&lt;/h1&gt;
&lt;p&gt;Let the &lt;strong&gt;score&lt;/strong&gt; of a candidate be represented by a
random variable &lt;span class=&quot;math inline&quot;&gt;\(X\)&lt;/span&gt; with continuous
probability density function &lt;span class=&quot;math inline&quot;&gt;\(f\)&lt;/span&gt;
having support on &lt;span class=&quot;math inline&quot;&gt;\((a,b)\)&lt;/span&gt;, where
&lt;span class=&quot;math inline&quot;&gt;\(a&amp;lt;b\)&lt;/span&gt;. Note that &lt;span
class=&quot;math inline&quot;&gt;\(a\)&lt;/span&gt; and &lt;span
class=&quot;math inline&quot;&gt;\(b\)&lt;/span&gt; are allowed to be &lt;span
class=&quot;math inline&quot;&gt;\(\pm \infty\)&lt;/span&gt;, respectively. Let &lt;span
class=&quot;math inline&quot;&gt;\(F\)&lt;/span&gt; be the corresponding cumulative
distribution of the score. Furthermore, let &lt;span
class=&quot;math inline&quot;&gt;\(\mu=E(X)=\int_{a}^b x \cdot f(x) dx\)&lt;/span&gt; be
the expectation of &lt;span class=&quot;math inline&quot;&gt;\(X\)&lt;/span&gt;. In what
follows we will assume that the distribution is such that the
expectation exists. Assuming a total of &lt;span
class=&quot;math inline&quot;&gt;\(n\)&lt;/span&gt; candidates, we ascertain that their
abilities/scores are independently and identically sampled from this
distribution, i.e.&lt;/p&gt;
&lt;p&gt;&lt;span class=&quot;math display&quot;&gt;\[
X_1,\ldots,X_n \stackrel{\text{iid}}{\sim} F.
\]&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;The &lt;span class=&quot;math inline&quot;&gt;\(n\)&lt;/span&gt; candidates arrive
sequentially and for each candidate one has to decide whether to select
this candidate or to keep looking at further candidates. Once a
candidate is rejected there is no opportunity to regret this choice
later.&lt;/p&gt;
&lt;p&gt;Now we denote by &lt;span class=&quot;math inline&quot;&gt;\(E_{n}\)&lt;/span&gt; the
expected score of the chosen candidate when one has to choose among
&lt;span class=&quot;math inline&quot;&gt;\(n\)&lt;/span&gt; candidates according to some
pre-described strategy. It is immediately obvious that &lt;span
class=&quot;math inline&quot;&gt;\(E_1=\mu\)&lt;/span&gt;. If there are &lt;span
class=&quot;math inline&quot;&gt;\(n\)&lt;/span&gt; candidates we would like to find the
optimal stopping rule maximizing &lt;span
class=&quot;math inline&quot;&gt;\(E_n\)&lt;/span&gt;. The standard stopping rule based on
the expectation implies that we would already stop at the first
candidate, if the observed value &lt;span class=&quot;math inline&quot;&gt;\(x\)&lt;/span&gt;
is such that &lt;span class=&quot;math inline&quot;&gt;\(x &amp;gt;
E_{n-1}\)&lt;/span&gt;. As a consequence,&lt;/p&gt;
&lt;p&gt;&lt;span class=&quot;math display&quot;&gt;\[
\begin{align*}
E_{n+1} &amp;amp;= P(X &amp;gt; E_n) \cdot E(X\&amp;gt;|\&amp;gt;X \geq E_n)  +
P(X \leq E_n) \cdot E_n \\
%&amp;amp;= \int_{E_n}^b x \cdot f(x) dx + E_n \int_{a}^{E_n} f(x) dx \\
&amp;amp;= \int_{E_n}^b x \cdot f(x) dx + E_n \cdot (1-F(E_n)).
\end{align*}
\]&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;A function to perform these computations in R handling either general
densities using numeric integration or analytic derivations would
be:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb1&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb1-1&quot;&gt;&lt;a href=&quot;#cb1-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;######################################################################&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-2&quot;&gt;&lt;a href=&quot;#cb1-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##Compute E vector using either numerical integration, a function for&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-3&quot;&gt;&lt;a href=&quot;#cb1-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##the computation of E[n+1] or using the analytic solution of&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-4&quot;&gt;&lt;a href=&quot;#cb1-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##\int_{E_n}^b x df(x) dx.&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-5&quot;&gt;&lt;a href=&quot;#cb1-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-6&quot;&gt;&lt;a href=&quot;#cb1-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;## Parameters:&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-7&quot;&gt;&lt;a href=&quot;#cb1-7&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##  n - number of candidates&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-8&quot;&gt;&lt;a href=&quot;#cb1-8&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##  df - density function of the score distribution (i.e. f)&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-9&quot;&gt;&lt;a href=&quot;#cb1-9&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##  pf - cumulative density function of the score distribution (i.e. F)&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-10&quot;&gt;&lt;a href=&quot;#cb1-10&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##  intE_fun - function g(E_n) = \int_{E_n}^b x*f(x)dx (if available)&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-11&quot;&gt;&lt;a href=&quot;#cb1-11&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##  Enp1_fun - function h(n,E_n) directly computing E_{n+1} from E_{n}&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-12&quot;&gt;&lt;a href=&quot;#cb1-12&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-13&quot;&gt;&lt;a href=&quot;#cb1-13&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;## Returns a vector of length (n+1) containing (E_0,...,E_n)&amp;#39;.&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-14&quot;&gt;&lt;a href=&quot;#cb1-14&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;######################################################################&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-15&quot;&gt;&lt;a href=&quot;#cb1-15&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;compute_E &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;cf&quot;&gt;function&lt;/span&gt;(n,df,pf,&lt;span class=&quot;at&quot;&gt;intE_fun=&lt;/span&gt;&lt;span class=&quot;cn&quot;&gt;NULL&lt;/span&gt;,&lt;span class=&quot;at&quot;&gt;Enp1_fun=&lt;/span&gt;&lt;span class=&quot;cn&quot;&gt;NULL&lt;/span&gt;,...) {&lt;/span&gt;
&lt;span id=&quot;cb1-16&quot;&gt;&lt;a href=&quot;#cb1-16&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  E &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;rep&lt;/span&gt;(&lt;span class=&quot;cn&quot;&gt;NA&lt;/span&gt;,n&lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;)&lt;/span&gt;
&lt;span id=&quot;cb1-17&quot;&gt;&lt;a href=&quot;#cb1-17&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  E[&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;] &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;dv&quot;&gt;0&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-18&quot;&gt;&lt;a href=&quot;#cb1-18&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  target &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;cf&quot;&gt;function&lt;/span&gt;(x) x&lt;span class=&quot;sc&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;df&lt;/span&gt;(x,...)&lt;/span&gt;
&lt;span id=&quot;cb1-19&quot;&gt;&lt;a href=&quot;#cb1-19&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-20&quot;&gt;&lt;a href=&quot;#cb1-20&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;cf&quot;&gt;for&lt;/span&gt; (n &lt;span class=&quot;cf&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;seq_len&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;length&lt;/span&gt;(E)&lt;span class=&quot;sc&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;)) {&lt;/span&gt;
&lt;span id=&quot;cb1-21&quot;&gt;&lt;a href=&quot;#cb1-21&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;cf&quot;&gt;if&lt;/span&gt; (&lt;span class=&quot;fu&quot;&gt;is.null&lt;/span&gt;(Enp1_fun)) {&lt;/span&gt;
&lt;span id=&quot;cb1-22&quot;&gt;&lt;a href=&quot;#cb1-22&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;      &lt;span class=&quot;cf&quot;&gt;if&lt;/span&gt; (&lt;span class=&quot;fu&quot;&gt;is.null&lt;/span&gt;(intE_fun)) {&lt;/span&gt;
&lt;span id=&quot;cb1-23&quot;&gt;&lt;a href=&quot;#cb1-23&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;        E[n&lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;] &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;integrate&lt;/span&gt;(target,E[n],&lt;span class=&quot;cn&quot;&gt;Inf&lt;/span&gt;)&lt;span class=&quot;sc&quot;&gt;$&lt;/span&gt;value &lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt; E[n] &lt;span class=&quot;sc&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;pf&lt;/span&gt;(E[n],...)&lt;/span&gt;
&lt;span id=&quot;cb1-24&quot;&gt;&lt;a href=&quot;#cb1-24&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;      } &lt;span class=&quot;cf&quot;&gt;else&lt;/span&gt; {&lt;/span&gt;
&lt;span id=&quot;cb1-25&quot;&gt;&lt;a href=&quot;#cb1-25&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;        E[n&lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;] &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;intE_fun&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;En=&lt;/span&gt;E[n]) &lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt; E[n] &lt;span class=&quot;sc&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;pf&lt;/span&gt;(E[n],...)&lt;/span&gt;
&lt;span id=&quot;cb1-26&quot;&gt;&lt;a href=&quot;#cb1-26&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;      }&lt;/span&gt;
&lt;span id=&quot;cb1-27&quot;&gt;&lt;a href=&quot;#cb1-27&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    } &lt;span class=&quot;cf&quot;&gt;else&lt;/span&gt; {&lt;/span&gt;
&lt;span id=&quot;cb1-28&quot;&gt;&lt;a href=&quot;#cb1-28&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;      E[n&lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;] &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;Enp1_fun&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;n=&lt;/span&gt;n,&lt;span class=&quot;at&quot;&gt;En=&lt;/span&gt;E[n],...)&lt;/span&gt;
&lt;span id=&quot;cb1-29&quot;&gt;&lt;a href=&quot;#cb1-29&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    }&lt;/span&gt;
&lt;span id=&quot;cb1-30&quot;&gt;&lt;a href=&quot;#cb1-30&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  }&lt;/span&gt;
&lt;span id=&quot;cb1-31&quot;&gt;&lt;a href=&quot;#cb1-31&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;return&lt;/span&gt;(E)&lt;/span&gt;
&lt;span id=&quot;cb1-32&quot;&gt;&lt;a href=&quot;#cb1-32&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Altogether, the optimal stopping time is thus&lt;/p&gt;
&lt;p&gt;&lt;span class=&quot;math display&quot;&gt;\[
T_{\text{stop}} = \min_{1\leq i \leq n} \left\{x_i &amp;gt; E_{n-i}\right\}.
\]&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;The sequential comparisons can be given in the same strategy vector
format as for the &lt;a href=&quot;../12/optimalChoice.html&quot;&gt;secretary problem
post&lt;/a&gt;, i.e. one selects the candidate &lt;span
class=&quot;math inline&quot;&gt;\(i\)&lt;/span&gt; if &lt;span
class=&quot;math inline&quot;&gt;\(x_i&amp;gt;s_i\)&lt;/span&gt;.&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb2&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb2-1&quot;&gt;&lt;a href=&quot;#cb2-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;######################################################################&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb2-2&quot;&gt;&lt;a href=&quot;#cb2-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;## Strategy of full information variant of the secretary problem&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb2-3&quot;&gt;&lt;a href=&quot;#cb2-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb2-4&quot;&gt;&lt;a href=&quot;#cb2-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;## Parameters:&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb2-5&quot;&gt;&lt;a href=&quot;#cb2-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##  n - number of candidates&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb2-6&quot;&gt;&lt;a href=&quot;#cb2-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;######################################################################&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb2-7&quot;&gt;&lt;a href=&quot;#cb2-7&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb2-8&quot;&gt;&lt;a href=&quot;#cb2-8&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;strategy_fip &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;cf&quot;&gt;function&lt;/span&gt;(n,df,pf,&lt;span class=&quot;at&quot;&gt;intE_fun=&lt;/span&gt;&lt;span class=&quot;cn&quot;&gt;NULL&lt;/span&gt;,&lt;span class=&quot;at&quot;&gt;Enp1_fun=&lt;/span&gt;&lt;span class=&quot;cn&quot;&gt;NULL&lt;/span&gt;,...) {&lt;/span&gt;
&lt;span id=&quot;cb2-9&quot;&gt;&lt;a href=&quot;#cb2-9&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  E &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;compute_E&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;n=&lt;/span&gt;n,&lt;span class=&quot;at&quot;&gt;df=&lt;/span&gt;df,&lt;span class=&quot;at&quot;&gt;pf=&lt;/span&gt;pf,&lt;span class=&quot;at&quot;&gt;intE_fun=&lt;/span&gt;intE_fun,&lt;span class=&quot;at&quot;&gt;Enp1_fun=&lt;/span&gt;Enp1_fun,...)&lt;/span&gt;
&lt;span id=&quot;cb2-10&quot;&gt;&lt;a href=&quot;#cb2-10&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  s &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; E[(n&lt;span class=&quot;dv&quot;&gt;-1&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;:&lt;/span&gt;n)&lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;]&lt;/span&gt;
&lt;span id=&quot;cb2-11&quot;&gt;&lt;a href=&quot;#cb2-11&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;return&lt;/span&gt;(s)&lt;/span&gt;
&lt;span id=&quot;cb2-12&quot;&gt;&lt;a href=&quot;#cb2-12&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h4 id=&quot;example-u01&quot;&gt;Example: U(0,1)&lt;/h4&gt;
&lt;p&gt;Example: In the case of &lt;span class=&quot;math inline&quot;&gt;\(X\sim
U(0,1)\)&lt;/span&gt; we can analytically compute &lt;span
class=&quot;math display&quot;&gt;\[
E_{n+1}=\frac{1}{2}(1-E_n^2) + E_n^2 =\frac{1}{2}(1+E_n^2).
\]&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;Given this setup, an R implementation of the strategy with, say,
&lt;span class=&quot;math inline&quot;&gt;\(n=11\)&lt;/span&gt; looks as follows.&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb3&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb3-1&quot;&gt;&lt;a href=&quot;#cb3-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;strategy_unif &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;cf&quot;&gt;function&lt;/span&gt;(n) {&lt;/span&gt;
&lt;span id=&quot;cb3-2&quot;&gt;&lt;a href=&quot;#cb3-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;strategy_fip&lt;/span&gt;(n,&lt;span class=&quot;at&quot;&gt;Enp1_fun=&lt;/span&gt;&lt;span class=&quot;cf&quot;&gt;function&lt;/span&gt;(n,En) {&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;*&lt;/span&gt;(&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt;En&lt;span class=&quot;sc&quot;&gt;^&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;)})&lt;/span&gt;
&lt;span id=&quot;cb3-3&quot;&gt;&lt;a href=&quot;#cb3-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;}&lt;/span&gt;
&lt;span id=&quot;cb3-4&quot;&gt;&lt;a href=&quot;#cb3-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;(s_unif &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;strategy_unif&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;n=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;11&lt;/span&gt;))&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;##  [1] 0.861 0.850 0.836 0.820 0.800 0.775 0.742 0.695 0.625 0.500 0.000&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;We can thus compare the computed expectations by simulation:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb5&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb5-1&quot;&gt;&lt;a href=&quot;#cb5-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;## Simulate selection from n candidates if following the strategy s.&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb5-2&quot;&gt;&lt;a href=&quot;#cb5-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;simulate &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;cf&quot;&gt;function&lt;/span&gt;(n,s) {&lt;/span&gt;
&lt;span id=&quot;cb5-3&quot;&gt;&lt;a href=&quot;#cb5-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  x &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;runif&lt;/span&gt;(n)&lt;/span&gt;
&lt;span id=&quot;cb5-4&quot;&gt;&lt;a href=&quot;#cb5-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  select_idx &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;which.max&lt;/span&gt;(x &lt;span class=&quot;sc&quot;&gt;&amp;gt;&lt;/span&gt; s)&lt;/span&gt;
&lt;span id=&quot;cb5-5&quot;&gt;&lt;a href=&quot;#cb5-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;c&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;score=&lt;/span&gt;x[select_idx],&lt;span class=&quot;at&quot;&gt;select_idx=&lt;/span&gt;select_idx,&lt;span class=&quot;at&quot;&gt;isOverallBest=&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;rank&lt;/span&gt;(x)[select_idx] &lt;span class=&quot;sc&quot;&gt;==&lt;/span&gt; n))&lt;/span&gt;
&lt;span id=&quot;cb5-6&quot;&gt;&lt;a href=&quot;#cb5-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;}&lt;/span&gt;
&lt;span id=&quot;cb5-7&quot;&gt;&lt;a href=&quot;#cb5-7&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb5-8&quot;&gt;&lt;a href=&quot;#cb5-8&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;## Small simulation study to get expected score of the selected candidate&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb5-9&quot;&gt;&lt;a href=&quot;#cb5-9&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;res &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;replicate&lt;/span&gt;(&lt;span class=&quot;fl&quot;&gt;1e5&lt;/span&gt;,&lt;span class=&quot;fu&quot;&gt;simulate&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;n=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;length&lt;/span&gt;(s_unif),&lt;span class=&quot;at&quot;&gt;s=&lt;/span&gt;s_unif))&lt;/span&gt;
&lt;span id=&quot;cb5-10&quot;&gt;&lt;a href=&quot;#cb5-10&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;apply&lt;/span&gt;(res,&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;,mean)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;##         score    select_idx isOverallBest 
##         0.871         4.953         0.530&lt;/code&gt;&lt;/pre&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb7&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb7-1&quot;&gt;&lt;a href=&quot;#cb7-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;tail&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;compute_E&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;n=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;11&lt;/span&gt;,&lt;span class=&quot;at&quot;&gt;Enp1_fun=&lt;/span&gt;&lt;span class=&quot;cf&quot;&gt;function&lt;/span&gt;(n,En) {&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;*&lt;/span&gt;(&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt;En&lt;span class=&quot;sc&quot;&gt;^&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;)}),&lt;span class=&quot;at&quot;&gt;n=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;## [1] 0.871&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;As always, an animation says more than 1000 words and a few
equations:&lt;/p&gt;
&lt;p&gt;&lt;img
src=&quot;/blog/figure/source/2016-06-19-princesAsUniforms/animation.gif&quot; /&gt;&lt;/p&gt;
&lt;p&gt;Finally, we can see how the expected score develops with increasing
&lt;span class=&quot;math inline&quot;&gt;\(n\)&lt;/span&gt;.&lt;/p&gt;
&lt;center&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr class=&quot;header&quot;&gt;
&lt;th style=&quot;text-align: left;&quot;&gt;&lt;/th&gt;
&lt;th style=&quot;text-align: right;&quot;&gt;10&lt;/th&gt;
&lt;th style=&quot;text-align: right;&quot;&gt;100&lt;/th&gt;
&lt;th style=&quot;text-align: right;&quot;&gt;1000&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr class=&quot;odd&quot;&gt;
&lt;td style=&quot;text-align: left;&quot;&gt;score&lt;/td&gt;
&lt;td style=&quot;text-align: right;&quot;&gt;0.862&lt;/td&gt;
&lt;td style=&quot;text-align: right;&quot;&gt;0.981&lt;/td&gt;
&lt;td style=&quot;text-align: right;&quot;&gt;0.998&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&quot;even&quot;&gt;
&lt;td style=&quot;text-align: left;&quot;&gt;select_idx&lt;/td&gt;
&lt;td style=&quot;text-align: right;&quot;&gt;4.589&lt;/td&gt;
&lt;td style=&quot;text-align: right;&quot;&gt;34.943&lt;/td&gt;
&lt;td style=&quot;text-align: right;&quot;&gt;333.724&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&quot;odd&quot;&gt;
&lt;td style=&quot;text-align: left;&quot;&gt;isOverallBest&lt;/td&gt;
&lt;td style=&quot;text-align: right;&quot;&gt;0.544&lt;/td&gt;
&lt;td style=&quot;text-align: right;&quot;&gt;0.426&lt;/td&gt;
&lt;td style=&quot;text-align: right;&quot;&gt;0.409&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;/center&gt;
&lt;p&gt;&lt;span class=&quot;citation&quot; data-cites=&quot;gilbert_mosteller1966&quot;&gt;Gilbert and
Mosteller (1966)&lt;/span&gt; provide an approximation for the
expectation:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb9&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb9-1&quot;&gt;&lt;a href=&quot;#cb9-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;E_optE &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;cf&quot;&gt;function&lt;/span&gt;(n) { &lt;span class=&quot;dv&quot;&gt;1-2&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;/&lt;/span&gt;(n&lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;log&lt;/span&gt;(n&lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;)&lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;fl&quot;&gt;1.767&lt;/span&gt;) }&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;which we can compare the &lt;code&gt;score&lt;/code&gt;column of the above
simulation results:&lt;/p&gt;
&lt;center&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr class=&quot;header&quot;&gt;
&lt;th style=&quot;text-align: right;&quot;&gt;10&lt;/th&gt;
&lt;th style=&quot;text-align: right;&quot;&gt;100&lt;/th&gt;
&lt;th style=&quot;text-align: right;&quot;&gt;1000&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr class=&quot;odd&quot;&gt;
&lt;td style=&quot;text-align: right;&quot;&gt;0.859&lt;/td&gt;
&lt;td style=&quot;text-align: right;&quot;&gt;0.981&lt;/td&gt;
&lt;td style=&quot;text-align: right;&quot;&gt;0.998&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;/center&gt;
&lt;p&gt;Altogether, this shows a pretty good agreement between the
approximation and simulation results.&lt;/p&gt;
&lt;h4 id=&quot;example-n01&quot;&gt;Example N(0,1)&lt;/h4&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb10&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb10-1&quot;&gt;&lt;a href=&quot;#cb10-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;## Compare results for the normal distribution (with and without&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb10-2&quot;&gt;&lt;a href=&quot;#cb10-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;## analytic solution for 1st integral of the E[n+1] formula&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb10-3&quot;&gt;&lt;a href=&quot;#cb10-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;strategy_fip&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;n=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;11&lt;/span&gt;,&lt;span class=&quot;at&quot;&gt;df=&lt;/span&gt;dnorm,&lt;span class=&quot;at&quot;&gt;pf=&lt;/span&gt;pnorm)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;##  [1] 1.324 1.276 1.223 1.162 1.092 1.011 0.913 0.790 0.630 0.399 0.000&lt;/code&gt;&lt;/pre&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb12&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb12-1&quot;&gt;&lt;a href=&quot;#cb12-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;(s_norm &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;strategy_fip&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;n=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;11&lt;/span&gt;,&lt;span class=&quot;at&quot;&gt;df=&lt;/span&gt;dnorm,&lt;span class=&quot;at&quot;&gt;pf=&lt;/span&gt;pnorm,&lt;span class=&quot;at&quot;&gt;intE_fun=&lt;/span&gt;&lt;span class=&quot;cf&quot;&gt;function&lt;/span&gt;(En,...) {&lt;/span&gt;
&lt;span id=&quot;cb12-2&quot;&gt;&lt;a href=&quot;#cb12-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;sqrt&lt;/span&gt;(&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;)&lt;span class=&quot;sc&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;exp&lt;/span&gt;(&lt;span class=&quot;sc&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;*&lt;/span&gt;En&lt;span class=&quot;sc&quot;&gt;^&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;)&lt;span class=&quot;sc&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;sqrt&lt;/span&gt;(pi)&lt;/span&gt;
&lt;span id=&quot;cb12-3&quot;&gt;&lt;a href=&quot;#cb12-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;}))&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;##  [1] 1.324 1.276 1.223 1.162 1.092 1.011 0.913 0.790 0.630 0.399 0.000&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Note that by transforming the observations by the CDF &lt;span
class=&quot;math inline&quot;&gt;\(F\)&lt;/span&gt;, i.e. &lt;span
class=&quot;math inline&quot;&gt;\(Y_i=F(X_i)\)&lt;/span&gt; we for any continuous
distribution obtain &lt;span class=&quot;math inline&quot;&gt;\(Y_i
\stackrel{\text{iid}}{\sim} U(0,1)\)&lt;/span&gt;. Hence, the result of
comparing the &lt;span class=&quot;math inline&quot;&gt;\(X_i\)&lt;/span&gt; against
&lt;code&gt;s_norm&lt;/code&gt; is the same as comparing &lt;span
class=&quot;math inline&quot;&gt;\(F(X_i)\)&lt;/span&gt; against &lt;code&gt;s_unif&lt;/code&gt;.&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb14&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb14-1&quot;&gt;&lt;a href=&quot;#cb14-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;set.seed&lt;/span&gt;(&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;)&lt;/span&gt;
&lt;span id=&quot;cb14-2&quot;&gt;&lt;a href=&quot;#cb14-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;x &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;rnorm&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;n=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;11&lt;/span&gt;) ; y &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;pnorm&lt;/span&gt;(x)&lt;/span&gt;
&lt;span id=&quot;cb14-3&quot;&gt;&lt;a href=&quot;#cb14-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;c&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;which.max&lt;/span&gt;(x &lt;span class=&quot;sc&quot;&gt;&amp;gt;&lt;/span&gt; s_norm), &lt;span class=&quot;fu&quot;&gt;which.max&lt;/span&gt;(y &lt;span class=&quot;sc&quot;&gt;&amp;gt;&lt;/span&gt; s_unif))&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;## [1] 4 4&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;It is thus not necessary to derive the optimal strategy for each
possible continuous distribution. Instead one can transform the score to
the uniform score as illustrated above and then use the corresponding
strategy for the uniform to determine the stopping time.&lt;/p&gt;
&lt;h1 id=&quot;the-partial-information-game&quot;&gt;The Partial Information Game&lt;/h1&gt;
&lt;p&gt;To summarise the previous section’s findings: knowing the candidate’s
score distribution means that no training sample is needed to form a
baseline. Hence, in the full information game, one immediately is
&lt;em&gt;ready for action&lt;/em&gt;: if a candidate with an excellent score is met
early you do not hesitate! However, in a real word applications the
parameters of the parametric distribution are likely to be unknown. This
is known as the &lt;strong&gt;partial information game&lt;/strong&gt; and here
statistical inference actually for the first time plays a role, because
one needs to learn about the parameters of the distribution while
candidates arrive and while simultaneously deciding to select the
current candidate or keep looking.&lt;/p&gt;
&lt;p&gt;&lt;span class=&quot;citation&quot; data-cites=&quot;stewart1978&quot;&gt;Stewart (1978)&lt;/span&gt;
discusses a Bayesian approach to sequential learning the upper and lower
limits of the underlying but unknown &lt;span
class=&quot;math inline&quot;&gt;\(U(\alpha,\beta)\)&lt;/span&gt; distribution. Inspired by
&lt;span class=&quot;citation&quot; data-cites=&quot;degroot1970&quot;&gt;DeGroot (1970)&lt;/span&gt;, a
conjugate bilateral bivariate Pareto distribution on &lt;span
class=&quot;math inline&quot;&gt;\((\alpha,\beta)\)&lt;/span&gt; is used. In what follows
we describe this approach and the resulting selection strategy.&lt;/p&gt;
&lt;p&gt;We will assume a bilateral bivariate Pareto distribution as joint
prior distribution for &lt;span class=&quot;math inline&quot;&gt;\(\alpha\)&lt;/span&gt; and
&lt;span class=&quot;math inline&quot;&gt;\(\beta\)&lt;/span&gt;, i.e. the hierarchical
Bayesian model is&lt;/p&gt;
&lt;p&gt;&lt;span class=&quot;math display&quot;&gt;\[
\begin{align*}
(\alpha,\beta)                                &amp;amp; \sim
\text{bPar}(k,l,u) \\
X_i \&amp;gt;|\&amp;gt; \alpha,\beta &amp;amp;
\stackrel{\text{iid}}{\sim}   U(\alpha,\beta), &amp;amp; i=1,\ldots,n,
\end{align*}
\]&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;where the density of the &lt;span
class=&quot;math inline&quot;&gt;\(\text{bPar}(k,l,u)\)&lt;/span&gt; distribution is &lt;span
class=&quot;math display&quot;&gt;\[
f(\alpha,\beta) = \frac{k(k+1)(u-l)^k}{(\beta-\alpha)^{k+2}} \cdot
I(\alpha&amp;lt;l \text{ and } \beta &amp;gt; u).
\]&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;Here, &lt;span class=&quot;math inline&quot;&gt;\(k&amp;gt;0\)&lt;/span&gt; is a shape
parameter and &lt;span class=&quot;math inline&quot;&gt;\(I(\&amp;gt;)\)&lt;/span&gt; denotes the
indicator function. In other words, the parameter &lt;span
class=&quot;math inline&quot;&gt;\(l\)&lt;/span&gt; is an upper bound for the lower limit
of the uniform (i.e. &lt;span class=&quot;math inline&quot;&gt;\(\alpha\)&lt;/span&gt;), and
the parameter &lt;span class=&quot;math inline&quot;&gt;\(u\)&lt;/span&gt; is a lower limit
for the upper limit of the uniform (i.e. &lt;span
class=&quot;math inline&quot;&gt;\(\beta\)&lt;/span&gt;). We can think of &lt;span
class=&quot;math inline&quot;&gt;\((-\infty,l)\)&lt;/span&gt; as our prior interval for the
worst possible candidate applying and &lt;span
class=&quot;math inline&quot;&gt;\((u,\infty)\)&lt;/span&gt; as our prior interval for the
best possible candidate. The shape parameter &lt;span
class=&quot;math inline&quot;&gt;\(k\)&lt;/span&gt; denotes how concentrated the prior
density is near the limits &lt;span class=&quot;math inline&quot;&gt;\(l\)&lt;/span&gt; and
&lt;span class=&quot;math inline&quot;&gt;\(u\)&lt;/span&gt;, respectively.&lt;/p&gt;
&lt;p&gt;In the example: the princess may think entitlements and the cool
future title (king) ensures that the worst possible prince up for wooing
her would at least be a five. Similarly, the lower bound on the upper
limit means that the princess initially thinks that due to her stingy
dad (the current king) the best overall applicant might, in worst case,
just be about a seven. Finally, the parameter &lt;span
class=&quot;math inline&quot;&gt;\(k\)&lt;/span&gt; quantifies the strength in her prior
belief - the higher &lt;span class=&quot;math inline&quot;&gt;\(k\)&lt;/span&gt; the closer
the true limits are to the values of &lt;span
class=&quot;math inline&quot;&gt;\(l\)&lt;/span&gt; and &lt;span
class=&quot;math inline&quot;&gt;\(u\)&lt;/span&gt;. Since the princess is unsure how well
her prior is suited, she assumes a low value of &lt;span
class=&quot;math inline&quot;&gt;\(k\)&lt;/span&gt;, say, &lt;span
class=&quot;math inline&quot;&gt;\(k=0.1\)&lt;/span&gt;.&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb16&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb16-1&quot;&gt;&lt;a href=&quot;#cb16-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;#################################################&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb16-2&quot;&gt;&lt;a href=&quot;#cb16-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;# Joint bilateral Pareto prior&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb16-3&quot;&gt;&lt;a href=&quot;#cb16-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;#&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb16-4&quot;&gt;&lt;a href=&quot;#cb16-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;# Parameters:&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb16-5&quot;&gt;&lt;a href=&quot;#cb16-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;#  theta - vector length two containing (alpha,beta)&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb16-6&quot;&gt;&lt;a href=&quot;#cb16-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;#  k     - parameter&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb16-7&quot;&gt;&lt;a href=&quot;#cb16-7&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;#  l     - upper bound for alpha (i.e. an upper bound for the true lower bound)&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb16-8&quot;&gt;&lt;a href=&quot;#cb16-8&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;#  u     - lower for beta (i.e. a lower bound for the true upper bound)&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb16-9&quot;&gt;&lt;a href=&quot;#cb16-9&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;################################################&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb16-10&quot;&gt;&lt;a href=&quot;#cb16-10&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb16-11&quot;&gt;&lt;a href=&quot;#cb16-11&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;f_pareto &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;cf&quot;&gt;function&lt;/span&gt;(theta,k,l,u) {&lt;/span&gt;
&lt;span id=&quot;cb16-12&quot;&gt;&lt;a href=&quot;#cb16-12&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;cf&quot;&gt;if&lt;/span&gt; (&lt;span class=&quot;fu&quot;&gt;is.matrix&lt;/span&gt;(theta)) {&lt;/span&gt;
&lt;span id=&quot;cb16-13&quot;&gt;&lt;a href=&quot;#cb16-13&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    alpha &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; theta[,&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;] ; beta &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; theta[,&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;]&lt;/span&gt;
&lt;span id=&quot;cb16-14&quot;&gt;&lt;a href=&quot;#cb16-14&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  } &lt;span class=&quot;cf&quot;&gt;else&lt;/span&gt; {&lt;/span&gt;
&lt;span id=&quot;cb16-15&quot;&gt;&lt;a href=&quot;#cb16-15&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    alpha &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; theta[&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;]  ; beta &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; theta[&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;]&lt;/span&gt;
&lt;span id=&quot;cb16-16&quot;&gt;&lt;a href=&quot;#cb16-16&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  }&lt;/span&gt;
&lt;span id=&quot;cb16-17&quot;&gt;&lt;a href=&quot;#cb16-17&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb16-18&quot;&gt;&lt;a href=&quot;#cb16-18&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;co&quot;&gt;#Compute PDF&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb16-19&quot;&gt;&lt;a href=&quot;#cb16-19&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt; &lt;span class=&quot;fu&quot;&gt;ifelse&lt;/span&gt;(alpha &lt;span class=&quot;sc&quot;&gt;&amp;lt;&lt;/span&gt; l &lt;span class=&quot;sc&quot;&gt;&amp;amp;&lt;/span&gt; beta &lt;span class=&quot;sc&quot;&gt;&amp;gt;&lt;/span&gt; u,&lt;/span&gt;
&lt;span id=&quot;cb16-20&quot;&gt;&lt;a href=&quot;#cb16-20&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;        k&lt;span class=&quot;sc&quot;&gt;*&lt;/span&gt;(k&lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;)&lt;span class=&quot;sc&quot;&gt;*&lt;/span&gt;(u &lt;span class=&quot;sc&quot;&gt;-&lt;/span&gt; l)&lt;span class=&quot;sc&quot;&gt;^&lt;/span&gt;k &lt;span class=&quot;sc&quot;&gt;/&lt;/span&gt; (beta&lt;span class=&quot;sc&quot;&gt;-&lt;/span&gt;alpha)&lt;span class=&quot;sc&quot;&gt;^&lt;/span&gt;(k&lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;), &lt;span class=&quot;dv&quot;&gt;0&lt;/span&gt;)&lt;/span&gt;
&lt;span id=&quot;cb16-21&quot;&gt;&lt;a href=&quot;#cb16-21&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;We illustrate the prior setting consisting of &lt;span
class=&quot;math inline&quot;&gt;\(l=5\)&lt;/span&gt; and &lt;span
class=&quot;math inline&quot;&gt;\(u=7\)&lt;/span&gt; and the two values &lt;span
class=&quot;math inline&quot;&gt;\(k=0.1\)&lt;/span&gt; and &lt;span
class=&quot;math inline&quot;&gt;\(k=1\)&lt;/span&gt;:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;## Warning: stat_contour(): Zero contours were generated&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## Warning in min(x): no non-missing arguments to min; returning Inf&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## Warning in max(x): no non-missing arguments to max; returning -Inf&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;img
src=&quot;/blog/figure/source/2016-06-19-princesAsUniforms/PARETO_PDF-1.png&quot; /&gt;&lt;/p&gt;
&lt;p&gt;And the marginal density for two slices of the above joint density
is:&lt;/p&gt;
&lt;p&gt;&lt;img
src=&quot;/blog/figure/source/2016-06-19-princesAsUniforms/PDF_PARETO_MARGINAL-1.png&quot; /&gt;&lt;/p&gt;
&lt;p&gt;An important feature of this bivariate Pareto prior is that it is the
conjugate prior to uniform sampling &lt;span class=&quot;citation&quot;
data-cites=&quot;degroot1970&quot;&gt;(DeGroot 1970)&lt;/span&gt;. In other words, if &lt;span
class=&quot;math inline&quot;&gt;\((\alpha,\beta) \sim
\text{bPar}(k,l_0,u_0)\)&lt;/span&gt; and observations &lt;span
class=&quot;math inline&quot;&gt;\(X_1,\ldots,X_i \stackrel{\text{iid}}{\sim}
U(\alpha,\beta)\)&lt;/span&gt; become available, then the posterior
distribution of interest is&lt;/p&gt;
&lt;p&gt;&lt;span class=&quot;math display&quot;&gt;\[
(\alpha,\beta)&amp;#39; \&amp;gt;|\&amp;gt; X_1,\ldots,X_i \sim
\text{bPar}(k+i,l_i,u_i),
\]&lt;/span&gt; where &lt;span class=&quot;math display&quot;&gt;\[
\begin{align*}
l_i &amp;amp;= \min(l_0,x_1,\ldots,x_i), \\
u_i &amp;amp;= \max(u_0,x_1,\ldots,x_i).
\end{align*}
\]&lt;/span&gt; In other words, the posterior depends only on &lt;span
class=&quot;math inline&quot;&gt;\(l_i\)&lt;/span&gt; and &lt;span
class=&quot;math inline&quot;&gt;\(u_i\)&lt;/span&gt; and not the individual &lt;span
class=&quot;math inline&quot;&gt;\(x_i\)&lt;/span&gt;’s. Let &lt;span
class=&quot;math inline&quot;&gt;\(\gamma_i\)&lt;/span&gt; be the obtained score, if we at
stage &lt;span class=&quot;math inline&quot;&gt;\(i\)&lt;/span&gt; select the &lt;span
class=&quot;math inline&quot;&gt;\(i\)&lt;/span&gt;’th candidate. Furthermore, using the
same expectation definition as in the previous section, let &lt;span
class=&quot;math inline&quot;&gt;\(E_i\)&lt;/span&gt; be the expected score obtained by
following a particular strategy from the &lt;span
class=&quot;math inline&quot;&gt;\(i\)&lt;/span&gt;’th candidate to the &lt;span
class=&quot;math inline&quot;&gt;\(n\)&lt;/span&gt;’th candidate.&lt;/p&gt;
&lt;p&gt;&lt;span class=&quot;math display&quot;&gt;\[
\begin{align*}
\gamma_n &amp;amp;= x_n \\
E_i      &amp;amp;= E(\gamma_i | x_1,\ldots, x_{i-1}), &amp;amp; i \leq n, \\
\gamma_i &amp;amp;= \max(x_i, E_{i+1}),                  &amp;amp; i &amp;lt; n.
\end{align*}
\]&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span class=&quot;citation&quot; data-cites=&quot;stewart1978&quot;&gt;Stewart (1978)&lt;/span&gt;
then shows that the optimal strategy is found by the following approach,
which we here for simplicity shall program directly in R:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb20&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb20-1&quot;&gt;&lt;a href=&quot;#cb20-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;## Small helper function to convert between index 0 and R&amp;#39;s index 1 storing&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb20-2&quot;&gt;&lt;a href=&quot;#cb20-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;idx &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;cf&quot;&gt;function&lt;/span&gt;(i) i&lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb20-3&quot;&gt;&lt;a href=&quot;#cb20-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb20-4&quot;&gt;&lt;a href=&quot;#cb20-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;## Compute delta vector, which is a helper-vector in the solution of Stewart (1978)&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb20-5&quot;&gt;&lt;a href=&quot;#cb20-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;compute_delta &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;cf&quot;&gt;function&lt;/span&gt;(n, k) {&lt;/span&gt;
&lt;span id=&quot;cb20-6&quot;&gt;&lt;a href=&quot;#cb20-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;co&quot;&gt;#Define delta&amp;#39;s&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb20-7&quot;&gt;&lt;a href=&quot;#cb20-7&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  delta &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;rep&lt;/span&gt;(&lt;span class=&quot;cn&quot;&gt;NA&lt;/span&gt;,n&lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;)&lt;/span&gt;
&lt;span id=&quot;cb20-8&quot;&gt;&lt;a href=&quot;#cb20-8&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  delta[&lt;span class=&quot;fu&quot;&gt;idx&lt;/span&gt;(n&lt;span class=&quot;dv&quot;&gt;-1&lt;/span&gt;)] &lt;span class=&quot;ot&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb20-9&quot;&gt;&lt;a href=&quot;#cb20-9&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb20-10&quot;&gt;&lt;a href=&quot;#cb20-10&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;cf&quot;&gt;for&lt;/span&gt; (i &lt;span class=&quot;cf&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;rev&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;seq_len&lt;/span&gt;(n&lt;span class=&quot;dv&quot;&gt;-1&lt;/span&gt;))) {&lt;/span&gt;
&lt;span id=&quot;cb20-11&quot;&gt;&lt;a href=&quot;#cb20-11&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;cf&quot;&gt;if&lt;/span&gt; (delta[&lt;span class=&quot;fu&quot;&gt;idx&lt;/span&gt;(i)]&lt;span class=&quot;sc&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;) {&lt;/span&gt;
&lt;span id=&quot;cb20-12&quot;&gt;&lt;a href=&quot;#cb20-12&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;      delta[&lt;span class=&quot;fu&quot;&gt;idx&lt;/span&gt;(i&lt;span class=&quot;dv&quot;&gt;-1&lt;/span&gt;)] &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; delta[&lt;span class=&quot;fu&quot;&gt;idx&lt;/span&gt;(i)]&lt;/span&gt;
&lt;span id=&quot;cb20-13&quot;&gt;&lt;a href=&quot;#cb20-13&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    } &lt;span class=&quot;cf&quot;&gt;else&lt;/span&gt; {&lt;/span&gt;
&lt;span id=&quot;cb20-14&quot;&gt;&lt;a href=&quot;#cb20-14&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;      delta[&lt;span class=&quot;fu&quot;&gt;idx&lt;/span&gt;(i&lt;span class=&quot;dv&quot;&gt;-1&lt;/span&gt;)] &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;*&lt;/span&gt;(&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt;(k&lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt;i&lt;span class=&quot;dv&quot;&gt;-1&lt;/span&gt;)&lt;span class=&quot;sc&quot;&gt;/&lt;/span&gt;(k&lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt;i&lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;)&lt;span class=&quot;sc&quot;&gt;*&lt;/span&gt;delta[&lt;span class=&quot;fu&quot;&gt;idx&lt;/span&gt;(i)]&lt;span class=&quot;sc&quot;&gt;^&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;) &lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt; (k&lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt;i&lt;span class=&quot;dv&quot;&gt;-1&lt;/span&gt;)&lt;span class=&quot;sc&quot;&gt;*&lt;/span&gt;delta[&lt;span class=&quot;fu&quot;&gt;idx&lt;/span&gt;(i)]&lt;span class=&quot;sc&quot;&gt;/&lt;/span&gt;(k&lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt;i&lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;)&lt;span class=&quot;sc&quot;&gt;/&lt;/span&gt;(k&lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt;i&lt;span class=&quot;dv&quot;&gt;-2&lt;/span&gt;)&lt;/span&gt;
&lt;span id=&quot;cb20-15&quot;&gt;&lt;a href=&quot;#cb20-15&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    }&lt;/span&gt;
&lt;span id=&quot;cb20-16&quot;&gt;&lt;a href=&quot;#cb20-16&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  }&lt;/span&gt;
&lt;span id=&quot;cb20-17&quot;&gt;&lt;a href=&quot;#cb20-17&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb20-18&quot;&gt;&lt;a href=&quot;#cb20-18&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;return&lt;/span&gt;(delta)&lt;/span&gt;
&lt;span id=&quot;cb20-19&quot;&gt;&lt;a href=&quot;#cb20-19&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;}&lt;/span&gt;
&lt;span id=&quot;cb20-20&quot;&gt;&lt;a href=&quot;#cb20-20&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb20-21&quot;&gt;&lt;a href=&quot;#cb20-21&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;###############################################################&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb20-22&quot;&gt;&lt;a href=&quot;#cb20-22&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;## Bayesian sequential learning for a sequence of scores using the&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb20-23&quot;&gt;&lt;a href=&quot;#cb20-23&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;## procedure described in Stewart (1978)&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb20-24&quot;&gt;&lt;a href=&quot;#cb20-24&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb20-25&quot;&gt;&lt;a href=&quot;#cb20-25&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;## Parameters:&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb20-26&quot;&gt;&lt;a href=&quot;#cb20-26&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##  x - vector of candidate scores (scores are only revealed sequentially)&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb20-27&quot;&gt;&lt;a href=&quot;#cb20-27&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##  prior - list containing prior values for k, l and u&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb20-28&quot;&gt;&lt;a href=&quot;#cb20-28&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;###############################################################&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb20-29&quot;&gt;&lt;a href=&quot;#cb20-29&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb20-30&quot;&gt;&lt;a href=&quot;#cb20-30&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;strategy_pig &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;cf&quot;&gt;function&lt;/span&gt;(x, prior) {&lt;/span&gt;
&lt;span id=&quot;cb20-31&quot;&gt;&lt;a href=&quot;#cb20-31&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;co&quot;&gt;#Extract and precompute&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb20-32&quot;&gt;&lt;a href=&quot;#cb20-32&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  n &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;length&lt;/span&gt;(x)&lt;/span&gt;
&lt;span id=&quot;cb20-33&quot;&gt;&lt;a href=&quot;#cb20-33&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  delta &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;compute_delta&lt;/span&gt;(n,&lt;span class=&quot;at&quot;&gt;k=&lt;/span&gt;prior&lt;span class=&quot;sc&quot;&gt;$&lt;/span&gt;k)&lt;/span&gt;
&lt;span id=&quot;cb20-34&quot;&gt;&lt;a href=&quot;#cb20-34&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb20-35&quot;&gt;&lt;a href=&quot;#cb20-35&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;co&quot;&gt;#Generate data_frame to work on&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb20-36&quot;&gt;&lt;a href=&quot;#cb20-36&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  seq &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;data_frame&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;i=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;c&lt;/span&gt;(&lt;span class=&quot;dv&quot;&gt;0&lt;/span&gt;,&lt;span class=&quot;fu&quot;&gt;seq_len&lt;/span&gt;(n&lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;)),&lt;span class=&quot;at&quot;&gt;x=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;c&lt;/span&gt;(&lt;span class=&quot;cn&quot;&gt;NA&lt;/span&gt;,x,&lt;span class=&quot;cn&quot;&gt;NA&lt;/span&gt;), &lt;span class=&quot;at&quot;&gt;delta=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;c&lt;/span&gt;(delta,&lt;span class=&quot;cn&quot;&gt;NA&lt;/span&gt;))&lt;/span&gt;
&lt;span id=&quot;cb20-37&quot;&gt;&lt;a href=&quot;#cb20-37&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb20-38&quot;&gt;&lt;a href=&quot;#cb20-38&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;co&quot;&gt;#Sequential updating of l and u from the data&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb20-39&quot;&gt;&lt;a href=&quot;#cb20-39&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  l &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;cummin&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;c&lt;/span&gt;(prior&lt;span class=&quot;sc&quot;&gt;$&lt;/span&gt;l,x))&lt;/span&gt;
&lt;span id=&quot;cb20-40&quot;&gt;&lt;a href=&quot;#cb20-40&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  u &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;cummax&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;c&lt;/span&gt;(prior&lt;span class=&quot;sc&quot;&gt;$&lt;/span&gt;u,x))&lt;/span&gt;
&lt;span id=&quot;cb20-41&quot;&gt;&lt;a href=&quot;#cb20-41&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  seq &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; seq &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;mutate&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;l=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;c&lt;/span&gt;(l,l[n]),&lt;span class=&quot;at&quot;&gt;u=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;c&lt;/span&gt;(u,u[n]),&lt;span class=&quot;at&quot;&gt;im1div2=&lt;/span&gt;i&lt;span class=&quot;fl&quot;&gt;-0.5&lt;/span&gt;)&lt;/span&gt;
&lt;span id=&quot;cb20-42&quot;&gt;&lt;a href=&quot;#cb20-42&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb20-43&quot;&gt;&lt;a href=&quot;#cb20-43&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;do&quot;&gt;##Compute expectation&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb20-44&quot;&gt;&lt;a href=&quot;#cb20-44&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  seq &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; seq &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;mutate&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;E=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;lag&lt;/span&gt;(delta)&lt;span class=&quot;sc&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;lag&lt;/span&gt;(u) &lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt; (&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;lag&lt;/span&gt;(delta))&lt;span class=&quot;sc&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;lag&lt;/span&gt;(l))&lt;/span&gt;
&lt;span id=&quot;cb20-45&quot;&gt;&lt;a href=&quot;#cb20-45&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;do&quot;&gt;##Decision boundary&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb20-46&quot;&gt;&lt;a href=&quot;#cb20-46&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  seq &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; seq &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;mutate&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;threshold=&lt;/span&gt;delta&lt;span class=&quot;sc&quot;&gt;*&lt;/span&gt;u &lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt; (&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;-&lt;/span&gt;delta)&lt;span class=&quot;sc&quot;&gt;*&lt;/span&gt;l, &lt;span class=&quot;at&quot;&gt;rank=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;rank&lt;/span&gt;(x),&lt;span class=&quot;at&quot;&gt;isOverallBest=&lt;/span&gt;(rank &lt;span class=&quot;sc&quot;&gt;==&lt;/span&gt; n))&lt;/span&gt;
&lt;span id=&quot;cb20-47&quot;&gt;&lt;a href=&quot;#cb20-47&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb20-48&quot;&gt;&lt;a href=&quot;#cb20-48&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;co&quot;&gt;#Ensure that last candidate is always taken&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb20-49&quot;&gt;&lt;a href=&quot;#cb20-49&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  seq[n&lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;,&lt;span class=&quot;st&quot;&gt;&amp;quot;threshold&amp;quot;&lt;/span&gt;] &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;min&lt;/span&gt;(x)&lt;/span&gt;
&lt;span id=&quot;cb20-50&quot;&gt;&lt;a href=&quot;#cb20-50&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb20-51&quot;&gt;&lt;a href=&quot;#cb20-51&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;do&quot;&gt;##Find r_1 and return there characteristics&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb20-52&quot;&gt;&lt;a href=&quot;#cb20-52&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  r1 &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; seq &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;filter&lt;/span&gt;(delta &lt;span class=&quot;sc&quot;&gt;&amp;lt;=&lt;/span&gt; &lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;sc&quot;&gt;&amp;amp;&lt;/span&gt; i &lt;span class=&quot;sc&quot;&gt;&amp;lt;&lt;/span&gt; n &lt;span class=&quot;sc&quot;&gt;&amp;amp;&lt;/span&gt; i &lt;span class=&quot;sc&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;max&lt;/span&gt;(&lt;span class=&quot;dv&quot;&gt;0&lt;/span&gt;,&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;-&lt;/span&gt;prior&lt;span class=&quot;sc&quot;&gt;$&lt;/span&gt;k)) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;slice&lt;/span&gt;(&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;select&lt;/span&gt;(i) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; as.numeric&lt;/span&gt;
&lt;span id=&quot;cb20-53&quot;&gt;&lt;a href=&quot;#cb20-53&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  select &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; seq &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;filter&lt;/span&gt;(i &lt;span class=&quot;sc&quot;&gt;&amp;gt;=&lt;/span&gt; r1) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;filter&lt;/span&gt;(x &lt;span class=&quot;sc&quot;&gt;&amp;gt;=&lt;/span&gt; threshold) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;slice&lt;/span&gt;(&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;)&lt;/span&gt;
&lt;span id=&quot;cb20-54&quot;&gt;&lt;a href=&quot;#cb20-54&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;/span&gt;
&lt;span id=&quot;cb20-55&quot;&gt;&lt;a href=&quot;#cb20-55&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;return&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;list&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;seq=&lt;/span&gt;seq,&lt;span class=&quot;at&quot;&gt;select=&lt;/span&gt;select))&lt;/span&gt;
&lt;span id=&quot;cb20-56&quot;&gt;&lt;a href=&quot;#cb20-56&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;We now simulate a particular scenario consisting of 11 princes wooing
a princess and apply the optimal selection strategy applying the
princess’ prior:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb21&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb21-1&quot;&gt;&lt;a href=&quot;#cb21-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##Prior info&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb21-2&quot;&gt;&lt;a href=&quot;#cb21-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;prior &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;list&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;k=&lt;/span&gt;&lt;span class=&quot;fl&quot;&gt;0.1&lt;/span&gt;,&lt;span class=&quot;at&quot;&gt;l=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;5&lt;/span&gt;,&lt;span class=&quot;at&quot;&gt;u=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;7&lt;/span&gt;)&lt;/span&gt;
&lt;span id=&quot;cb21-3&quot;&gt;&lt;a href=&quot;#cb21-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb21-4&quot;&gt;&lt;a href=&quot;#cb21-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##Reverse engineering a happy end! :-)&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb21-5&quot;&gt;&lt;a href=&quot;#cb21-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;# which(sapply(1:100, function(i) {&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb21-6&quot;&gt;&lt;a href=&quot;#cb21-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;#   set.seed(i); x &amp;lt;- runif(n=11,0,10)&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb21-7&quot;&gt;&lt;a href=&quot;#cb21-7&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;#   s &amp;lt;- strategy_pig(x, prior=prior)&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb21-8&quot;&gt;&lt;a href=&quot;#cb21-8&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;#   as.numeric(s$select[,&amp;quot;isOverallBest&amp;quot;])&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb21-9&quot;&gt;&lt;a href=&quot;#cb21-9&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;# })==1)&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb21-10&quot;&gt;&lt;a href=&quot;#cb21-10&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb21-11&quot;&gt;&lt;a href=&quot;#cb21-11&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##Sample princes from an uniform with unknown limits -- here X_i \sim U(0,10)&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb21-12&quot;&gt;&lt;a href=&quot;#cb21-12&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;set.seed&lt;/span&gt;(&lt;span class=&quot;dv&quot;&gt;8&lt;/span&gt;)&lt;/span&gt;
&lt;span id=&quot;cb21-13&quot;&gt;&lt;a href=&quot;#cb21-13&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;x &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;runif&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;n=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;11&lt;/span&gt;,&lt;span class=&quot;dv&quot;&gt;0&lt;/span&gt;,&lt;span class=&quot;dv&quot;&gt;10&lt;/span&gt;)&lt;/span&gt;
&lt;span id=&quot;cb21-14&quot;&gt;&lt;a href=&quot;#cb21-14&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;s &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;strategy_pig&lt;/span&gt;(x, &lt;span class=&quot;at&quot;&gt;prior=&lt;/span&gt;prior)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;## Warning: `data_frame()` was deprecated in tibble 1.1.0.
## Please use `tibble()` instead.
## This warning is displayed once every 8 hours.
## Call `lifecycle::last_lifecycle_warnings()` to see where this warning was generated.&lt;/code&gt;&lt;/pre&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb23&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb23-1&quot;&gt;&lt;a href=&quot;#cb23-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;s&lt;span class=&quot;sc&quot;&gt;$&lt;/span&gt;select&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;## # A tibble: 1 × 10
##       i     x delta     l     u im1div2     E threshold  rank isOverallBest
##   &amp;lt;dbl&amp;gt; &amp;lt;dbl&amp;gt; &amp;lt;dbl&amp;gt; &amp;lt;dbl&amp;gt; &amp;lt;dbl&amp;gt;   &amp;lt;dbl&amp;gt; &amp;lt;dbl&amp;gt;     &amp;lt;dbl&amp;gt; &amp;lt;dbl&amp;gt; &amp;lt;lgl&amp;gt;        
## 1     8  9.32 0.745  2.08  9.32     7.5  6.88      7.47    11 TRUE&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;img
src=&quot;/blog/figure/source/2016-06-19-princesAsUniforms/animation-pig.gif&quot; /&gt;&lt;/p&gt;
&lt;p&gt;The animation provides interesting insights: Firstly, the upper bound
on the lower limit is updated along the way, because some seriously
unfit candidates dare to woo. Secondly, the decision boundary is
initially slightly above our lower bound on the upper limit. However,
the first candidate (candidate no. 3) above this prior bound is not
accepted, since it is still early in the sequence and thus little is
known about the support of the uniform, i.e. the range of candidates
applying. Hence, the princess hopes to get an even better candidate.
However, as time passes by and no such candidate appears, the limit is
slowly adjusted downwards. Luckily, the 8’th candidate not only brings a
score better than imagined (and is thus selected), he also (seen through
the omnipotent eyes of somebody knowing all the candidates) actually is
the best prince among &lt;strong&gt;all&lt;/strong&gt; the candidates,
i.e. &lt;code&gt;isOverallBest=TRUE&lt;/code&gt;. In other words: our mathematical
fairy tale even has a happy end!&lt;/p&gt;
&lt;center&gt;
&lt;img
src=&quot;/blog/figure/source/2016-06-19-princesAsUniforms/Fairytale-Fantasy-Castle-Landscape-300px.png&quot;
title=&quot;Source: https://openclipart.org/detail/231006/fairytale-fantasy-castle-landscape&quot; /&gt;
&lt;/center&gt;
&lt;h1 id=&quot;discussion&quot;&gt;Discussion&lt;/h1&gt;
&lt;p&gt;The full information game provides a good baseline to see the
difference between having no information but the rank of candidates and
knowing the distribution of the candidate’s score. More references and
variants of the secretary problem can be found in &lt;span class=&quot;citation&quot;
data-cites=&quot;freeman1983&quot;&gt;Freeman (1983)&lt;/span&gt;.&lt;/p&gt;
&lt;h1 class=&quot;unnumbered&quot; id=&quot;references&quot;&gt;References&lt;/h1&gt;
&lt;div id=&quot;refs&quot; class=&quot;references csl-bib-body hanging-indent&quot;
data-entry-spacing=&quot;0&quot; role=&quot;list&quot;&gt;
&lt;div id=&quot;ref-degroot1970&quot; class=&quot;csl-entry&quot; role=&quot;listitem&quot;&gt;
DeGroot, Morris. 1970. &lt;em&gt;Optimal Statistical Decisions&lt;/em&gt;.
McGraw-Hill. New York.
&lt;/div&gt;
&lt;div id=&quot;ref-freeman1983&quot; class=&quot;csl-entry&quot; role=&quot;listitem&quot;&gt;
Freeman, P. R. 1983. &lt;span&gt;“The Secretary Problem and Its Extensions: A
Review.”&lt;/span&gt; &lt;em&gt;International Statistical Review / Revue
Internationale de Statistique&lt;/em&gt; 51 (2): 189–206. &lt;a
href=&quot;http://www.jstor.org/stable/1402748&quot;&gt;http://www.jstor.org/stable/1402748&lt;/a&gt;.
&lt;/div&gt;
&lt;div id=&quot;ref-gilbert_mosteller1966&quot; class=&quot;csl-entry&quot; role=&quot;listitem&quot;&gt;
Gilbert, J. P., and F. Mosteller. 1966. &lt;span&gt;“Recognizing the Maximum
of a Sequence.”&lt;/span&gt; &lt;em&gt;Journal of the American Statistical
Association&lt;/em&gt; 61 (313): 35–73. &lt;a
href=&quot;http://www.jstor.org/stable/2283044&quot;&gt;http://www.jstor.org/stable/2283044&lt;/a&gt;.
&lt;/div&gt;
&lt;div id=&quot;ref-guttman1960&quot; class=&quot;csl-entry&quot; role=&quot;listitem&quot;&gt;
Guttman, I. 1960. &lt;span&gt;“On a Problem of l. Moser.”&lt;/span&gt; &lt;em&gt;Canadian
Mathematical Bulletin&lt;/em&gt; 3: 35–39.
&lt;/div&gt;
&lt;div id=&quot;ref-stewart1978&quot; class=&quot;csl-entry&quot; role=&quot;listitem&quot;&gt;
Stewart, T. J. 1978. &lt;span&gt;“Optimal Selection from a Random Sequence
with Learning of the Underlying Distribution.”&lt;/span&gt; &lt;em&gt;Journal of the
American Statistical Association&lt;/em&gt; 73 (364): 775–80. &lt;a
href=&quot;http://www.jstor.org/stable/2286279&quot;&gt;http://www.jstor.org/stable/2286279&lt;/a&gt;.
&lt;/div&gt;
&lt;/div&gt;
</description>
        <pubDate>Sun, 19 Jun 2016 00:00:00 +0200</pubDate>
        <link>https://mhoehle.github.io/blog/2016/06/19/princesAsUniforms.html</link>
        <guid isPermaLink="true">https://mhoehle.github.io/blog/2016/06/19/princesAsUniforms.html</guid>
        
        <category>math</category>
        
        <category>rstats</category>
        
        <category>secretary problem</category>
        
        <category>stopping rule</category>
        
        
      </item>
    
      <item>
        <title>Optimal Choice - Mathematical Advice for Real Life</title>
        <description>&lt;h2 id=&quot;abstract&quot;&gt;Abstract&lt;/h2&gt;
&lt;p&gt;We discuss how to choose the optimal candidate from a rankable
sequence of candidates arriving one by one. The candidates could for
example be job applicants, princes, tinder profiles or flats. This
&lt;strong&gt;choice problem&lt;/strong&gt; is casted into the context of sequential
decision making and is solved using optimal stopping theory. Two R
functions are provided to compute optimal selection strategies in two
specific instances of the problem. Altogether, the mathematical inclined
decision maker is given valuable open-source tools to support prudent
real life decision making.&lt;/p&gt;
&lt;p&gt;&lt;br&gt;
&lt;a rel=&quot;license&quot; href=&quot;http://creativecommons.org/licenses/by-sa/4.0/&quot;&gt;&lt;img alt=&quot;Creative Commons License&quot; style=&quot;border-width:0&quot; src=&quot;https://i.creativecommons.org/l/by-sa/4.0/88x31.png&quot;/&gt;&lt;/a&gt;
This work is licensed under a &lt;a rel=&quot;license&quot;
href=&quot;http://creativecommons.org/licenses/by-sa/4.0/&quot;&gt;Creative Commons
Attribution-ShareAlike 4.0 International License&lt;/a&gt;. The
markdown+Rknitr source code of this blog is available under a &lt;a
href=&quot;https://www.gnu.org/licenses/gpl-3.0.html&quot;&gt;GNU General Public
License (GPL v3)&lt;/a&gt; license from github.&lt;/p&gt;
&lt;h1 id=&quot;introduction&quot;&gt;Introduction&lt;/h1&gt;
&lt;p&gt;Life is full of choices. The prudent &lt;a
href=&quot;https://en.wikipedia.org/wiki/Decision-making&quot;&gt;decision maker&lt;/a&gt;
likes to rationally balance alternatives, assess uncertain outcomes,
gather additional information and - when ready - pick the best action. A
mathematical approach to such decision making under uncertainty is based
on maximizing an adequate utility function subject to the identified
stochasticity, e.g., by maximizing expected utility. The ultimate
statistical guides to such &lt;a
href=&quot;https://en.wikipedia.org/wiki/Optimal_decision&quot;&gt;optimal decision
making&lt;/a&gt; are the books by &lt;span class=&quot;citation&quot;
data-cites=&quot;degroot1970&quot;&gt;DeGroot (1970)&lt;/span&gt; and &lt;span
class=&quot;citation&quot; data-cites=&quot;berger1985&quot;&gt;Berger (1985)&lt;/span&gt;. &lt;a
href=&quot;https://en.wikipedia.org/wiki/Influence_diagram&quot;&gt;Influence
diagrams&lt;/a&gt; are compact representations of decision problems embedded
within the graphical modelling toolset of Bayesian networks, see e.g.
&lt;span class=&quot;citation&quot; data-cites=&quot;jensen_nielsen2007&quot;&gt;Jensen and
Nielsen (2007)&lt;/span&gt;.&lt;/p&gt;
&lt;center&gt;
&lt;img
src=&quot;/blog/figure/source/2016-06-12-optimalChoice/indecisive-silhouette-300px-scaled.png&quot;
title=&quot;Source: https://openclipart.org/detail/171299/indecisive-silhouettesvg&quot; /&gt;
&lt;/center&gt;
&lt;p&gt;&lt;br&gt;&lt;/p&gt;
&lt;p&gt;In this note we consider the very simple – but entertaining –
sequential decision problem known as the optimal choice, secretary,
marriage, dowry or game of googol problem &lt;span class=&quot;citation&quot;
data-cites=&quot;ferguson1989&quot;&gt;(Ferguson 1989)&lt;/span&gt;. Scientific publishing
about the &lt;a
href=&quot;https://en.wikipedia.org/wiki/Secretary_problem&quot;&gt;&lt;strong&gt;optimal
choice problem&lt;/strong&gt;&lt;/a&gt; dates back to the 1950’s and 1960’s, but
accounts of variations of the problem date back as far as &lt;a
href=&quot;https://en.wikipedia.org/wiki/Johannes_Kepler#Second_marriage&quot;&gt;1613&lt;/a&gt;.
To illustrate the problem we use the process of finding a real estate
property in an overheated housing market as example. Of course, the
human resource manager, wooed princess, &lt;a
href=&quot;http://www.npr.org/sections/krulwich/2014/05/15/312537965/how-to-marry-the-right-girl-a-mathematical-solution&quot;&gt;Johannes
Kepler&lt;/a&gt;, tinder hustler as well as the mathematical enthusiast
(subsets might overlap) should easily be able to adapt terminology to
their needs.&lt;/p&gt;
&lt;h2 id=&quot;the-optimal-choice-problem&quot;&gt;The optimal choice problem&lt;/h2&gt;
&lt;p&gt;The rules of the game are as follows:&lt;/p&gt;
&lt;ol type=&quot;1&quot;&gt;
&lt;li&gt;You want to choose exactly one property (say, buy a
&lt;strong&gt;flat&lt;/strong&gt;) within a given period of time&lt;/li&gt;
&lt;li&gt;The number of candidate flats available on the market and
inspectable in the given time period is assumed to be known. We shall
denote this number by &lt;span class=&quot;math inline&quot;&gt;\(n\)&lt;/span&gt;.&lt;/li&gt;
&lt;li&gt;The flats are assumed to be rankable from best (rank 1) to worst
(rank &lt;span class=&quot;math inline&quot;&gt;\(n\)&lt;/span&gt;) without ties.&lt;/li&gt;
&lt;li&gt;The flats can only be inspected sequentially and in some random
order.&lt;/li&gt;
&lt;li&gt;After seeing a flat one has to decide whether to pick this flat or
not.&lt;/li&gt;
&lt;li&gt;Once a flat is rejected, this choice is permanent and cannot be
re-called.&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;Your objective is to find the &lt;em&gt;best candidate&lt;/em&gt; among the &lt;span
class=&quot;math inline&quot;&gt;\(n\)&lt;/span&gt; flats. Less will not work for you,
i.e. you have no interest in the 2nd best candidate or any other worse
candidate. Furthermore, the decision you have to make at each decision
time is to either select the current candidate flat or reject it and
inspect futher candidate flats. Which flat to pick thus at each time
point is based only on the flat’s relative rank within the set of flats
seen up to now. Our goal is to find a strategy s.t. we end up with the
best flat, i.e. rank 1, among all of the &lt;span
class=&quot;math inline&quot;&gt;\(n\)&lt;/span&gt; flats. Note that simply looking at all
candidates and then picking the best one will not work due to rules 5
and 6.&lt;/p&gt;
&lt;h2 id=&quot;mathematical-notation&quot;&gt;Mathematical notation&lt;/h2&gt;
&lt;p&gt;Following &lt;span class=&quot;citation&quot; data-cites=&quot;chow_etal1964&quot;&gt;Chow et
al. (1964)&lt;/span&gt; we introduce the following mathematical notation: Let
&lt;span class=&quot;math inline&quot;&gt;\(x_1,\ldots, x_n\)&lt;/span&gt; be a permutation of
the integers between 1 and &lt;span class=&quot;math inline&quot;&gt;\(n\)&lt;/span&gt;. At
the time we are considering the &lt;span
class=&quot;math inline&quot;&gt;\(i\)&lt;/span&gt;’th candidate in our ordered sequence we
have seen the candidates &lt;span
class=&quot;math inline&quot;&gt;\(1,\ldots,i\)&lt;/span&gt;. Let &lt;span
class=&quot;math inline&quot;&gt;\(y_i\)&lt;/span&gt;, &lt;span class=&quot;math inline&quot;&gt;\(y_i \in
\{1,\ldots,i\}\)&lt;/span&gt;, denote the rank of the &lt;span
class=&quot;math inline&quot;&gt;\(i\)&lt;/span&gt;’th candidate among these &lt;span
class=&quot;math inline&quot;&gt;\(i\)&lt;/span&gt; candidates. We call this the
&lt;strong&gt;relative rank&lt;/strong&gt; at time &lt;span
class=&quot;math inline&quot;&gt;\(i\)&lt;/span&gt; of the &lt;span
class=&quot;math inline&quot;&gt;\(i\)&lt;/span&gt;’th candidate. Note that the relative
rank can be 1 even though a candidates’ &lt;strong&gt;overall rank&lt;/strong&gt; is
not 1. This is a consequence of the overall rank being only partially
revealed by knowing more of the candidates.&lt;/p&gt;
&lt;p&gt;A code example illustrates the concept:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb1&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb1-1&quot;&gt;&lt;a href=&quot;#cb1-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;#Generate a sequence of ranks between 1 and n&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-2&quot;&gt;&lt;a href=&quot;#cb1-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;set.seed&lt;/span&gt;(&lt;span class=&quot;dv&quot;&gt;123&lt;/span&gt;)&lt;/span&gt;
&lt;span id=&quot;cb1-3&quot;&gt;&lt;a href=&quot;#cb1-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;n &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;dv&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;dt&quot;&gt;L&lt;/span&gt; ; x &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;sample&lt;/span&gt;(&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;:&lt;/span&gt;n,&lt;span class=&quot;at&quot;&gt;replace=&lt;/span&gt;&lt;span class=&quot;cn&quot;&gt;FALSE&lt;/span&gt;)&lt;/span&gt;
&lt;span id=&quot;cb1-4&quot;&gt;&lt;a href=&quot;#cb1-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-5&quot;&gt;&lt;a href=&quot;#cb1-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;#Function to compute sequential relative ranks, where smallest is best&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-6&quot;&gt;&lt;a href=&quot;#cb1-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;#Now programmed with Rcpp, which is faster than plain R. Github code&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-7&quot;&gt;&lt;a href=&quot;#cb1-7&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;#contains an even faster version relrank_rcpp_novec. Note index start at 0&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-8&quot;&gt;&lt;a href=&quot;#cb1-8&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;#in Rcpp.&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-9&quot;&gt;&lt;a href=&quot;#cb1-9&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;Rcpp&lt;span class=&quot;sc&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;cppFunction&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;#39;NumericVector relrank(NumericVector x) {&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-10&quot;&gt;&lt;a href=&quot;#cb1-10&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;st&quot;&gt;  int n = x.size();&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-11&quot;&gt;&lt;a href=&quot;#cb1-11&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;st&quot;&gt;  NumericVector output(n);&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-12&quot;&gt;&lt;a href=&quot;#cb1-12&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;st&quot;&gt;  for (int i = 0; i &amp;lt; n; ++i) {&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-13&quot;&gt;&lt;a href=&quot;#cb1-13&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;st&quot;&gt;     output[i] = sum(x[Range(0,i)] &amp;lt;= x[i]);&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-14&quot;&gt;&lt;a href=&quot;#cb1-14&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;st&quot;&gt;  }&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-15&quot;&gt;&lt;a href=&quot;#cb1-15&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;st&quot;&gt;  return output;&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-16&quot;&gt;&lt;a href=&quot;#cb1-16&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;st&quot;&gt;}&amp;#39;&lt;/span&gt;)&lt;/span&gt;
&lt;span id=&quot;cb1-17&quot;&gt;&lt;a href=&quot;#cb1-17&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-18&quot;&gt;&lt;a href=&quot;#cb1-18&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;rbind&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;x=&lt;/span&gt;x, &lt;span class=&quot;at&quot;&gt;y=&lt;/span&gt;y&lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;relrank&lt;/span&gt;(x))&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;##   [,1] [,2] [,3] [,4] [,5] [,6] [,7] [,8] [,9] [,10]
## x    3    8    4    7    6    1   10    9    2     5
## y    1    2    2    3    3    1    7    7    2     5&lt;/code&gt;&lt;/pre&gt;
&lt;h2 id=&quot;finding-the-best&quot;&gt;Finding the best&lt;/h2&gt;
&lt;p&gt;It is possible to show &lt;span class=&quot;citation&quot;
data-cites=&quot;gilbert_mosteller1966&quot;&gt;(Gilbert and Mosteller 1966)&lt;/span&gt;
that the optimal selection policy is to follow the rather intuitive
procedure:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Consider the first &lt;span class=&quot;math inline&quot;&gt;\(r-1\)&lt;/span&gt;
candidates without picking any of them (=“training sample”).&lt;/li&gt;
&lt;li&gt;Then select the first candidate, which is better than the best among
the training sample.&lt;/li&gt;
&lt;li&gt;If no candidate has been selected by the time &lt;span
class=&quot;math inline&quot;&gt;\(n\)&lt;/span&gt; and, hence, the last candidate is
reached, one is forced to select this candidate.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Mathematically expressed the optimal stopping time is thus&lt;/p&gt;
&lt;p&gt;&lt;span class=&quot;math display&quot;&gt;\[
\min_{i \in \{r,\ldots,n\}}\{y_i = 1 \text{ or } i = n\}.
\]&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;The question is what &lt;span class=&quot;math inline&quot;&gt;\(r\)&lt;/span&gt; to
choose? &lt;span class=&quot;citation&quot; data-cites=&quot;ferguson1989&quot;&gt;Ferguson
(1989)&lt;/span&gt; in equation 2.1 shows that the probability &lt;span
class=&quot;math inline&quot;&gt;\(\phi_n(r)\)&lt;/span&gt; of finding the overall best
rank using a value of &lt;span class=&quot;math inline&quot;&gt;\(r\)&lt;/span&gt; in the
above strategy is&lt;/p&gt;
&lt;p&gt;&lt;span class=&quot;math display&quot;&gt;\[
\phi_n(r) = \frac{r-1}{n} \sum_{j=r}^n \frac{1}{j-1}.
\]&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;It is obvious that &lt;span
class=&quot;math inline&quot;&gt;\(\phi_n(1)=1/n\)&lt;/span&gt;. The remaining
probabilities can easily be computed with R:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb3&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb3-1&quot;&gt;&lt;a href=&quot;#cb3-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;#Compute probability of finding max after screening the r-1 first out of n and then&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb3-2&quot;&gt;&lt;a href=&quot;#cb3-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;#picking the first, which is better than the best in the training sample.&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb3-3&quot;&gt;&lt;a href=&quot;#cb3-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;phi &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;cf&quot;&gt;function&lt;/span&gt;(r,n) {&lt;/span&gt;
&lt;span id=&quot;cb3-4&quot;&gt;&lt;a href=&quot;#cb3-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;cf&quot;&gt;if&lt;/span&gt; (r&lt;span class=&quot;sc&quot;&gt;==&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;) &lt;span class=&quot;fu&quot;&gt;return&lt;/span&gt;(&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;/&lt;/span&gt;n)&lt;/span&gt;
&lt;span id=&quot;cb3-5&quot;&gt;&lt;a href=&quot;#cb3-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  j &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; r&lt;span class=&quot;sc&quot;&gt;:&lt;/span&gt;n&lt;/span&gt;
&lt;span id=&quot;cb3-6&quot;&gt;&lt;a href=&quot;#cb3-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;return&lt;/span&gt;((&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;/&lt;/span&gt;n)&lt;span class=&quot;sc&quot;&gt;*&lt;/span&gt;(r&lt;span class=&quot;dv&quot;&gt;-1&lt;/span&gt;)&lt;span class=&quot;sc&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;sum&lt;/span&gt;(&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;/&lt;/span&gt;(j&lt;span class=&quot;dv&quot;&gt;-1&lt;/span&gt;)))&lt;/span&gt;
&lt;span id=&quot;cb3-7&quot;&gt;&lt;a href=&quot;#cb3-7&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;}&lt;/span&gt;
&lt;span id=&quot;cb3-8&quot;&gt;&lt;a href=&quot;#cb3-8&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb3-9&quot;&gt;&lt;a href=&quot;#cb3-9&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;#Compute probabilities for all i in {1,...,n}&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb3-10&quot;&gt;&lt;a href=&quot;#cb3-10&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;df &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;data.frame&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;i=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;:&lt;/span&gt;n)&lt;/span&gt;
&lt;span id=&quot;cb3-11&quot;&gt;&lt;a href=&quot;#cb3-11&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;df &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; df &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;rowwise&lt;/span&gt;() &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;mutate&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;phi=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;phi&lt;/span&gt;(i,n)) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;ungroup&lt;/span&gt;()&lt;/span&gt;
&lt;span id=&quot;cb3-12&quot;&gt;&lt;a href=&quot;#cb3-12&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;r &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; df &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;filter&lt;/span&gt;(phi&lt;span class=&quot;sc&quot;&gt;==&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;max&lt;/span&gt;(phi))  &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;select&lt;/span&gt;(i)  &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;unlist&lt;/span&gt;() &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;as.numeric&lt;/span&gt;()&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;We can illustrate &lt;span class=&quot;math inline&quot;&gt;\(\phi_n(r)\)&lt;/span&gt; as a
function of &lt;span class=&quot;math inline&quot;&gt;\(r\)&lt;/span&gt;:&lt;/p&gt;
&lt;p&gt;&lt;img
src=&quot;http://staff.math.su.se/hoehle/blog/figure/source/2016-06-12-optimalChoice/PHIPLOT-1.png&quot; /&gt;&lt;/p&gt;
&lt;p&gt;We thus select the &lt;span class=&quot;math inline&quot;&gt;\(r\)&lt;/span&gt;, which
gives the highest value of &lt;span
class=&quot;math inline&quot;&gt;\(\phi_n(r)\)&lt;/span&gt;. In the example with &lt;span
class=&quot;math inline&quot;&gt;\(n=10\)&lt;/span&gt; the best choice is &lt;span
class=&quot;math inline&quot;&gt;\(r=
4\)&lt;/span&gt;. We wrap these two steps into a function &lt;a
href=&quot;https://raw.githubusercontent.com/hoehleatsu/hoehleatsu.github.io/master/_source/2016-06-12-optimalChoice.Rmd&quot;&gt;&lt;code&gt;find_r(n)&lt;/code&gt;&lt;/a&gt;,
which given &lt;code&gt;n&lt;/code&gt; returns the best choice &lt;code&gt;r&lt;/code&gt;. In
the example we therefore look at &lt;span
class=&quot;math inline&quot;&gt;\(r-1=\)&lt;/span&gt;&lt;code&gt;find_r(10)-1&lt;/code&gt;&lt;span
class=&quot;math inline&quot;&gt;\(=3\)&lt;/span&gt; candidates in order to get a
&lt;em&gt;baseline&lt;/em&gt; and then take the first candidate, which is better
than this baseline. In code this corresponds to:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb4&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb4-1&quot;&gt;&lt;a href=&quot;#cb4-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;(pickIdx &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;which.max&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;relrank&lt;/span&gt;(x)[r&lt;span class=&quot;sc&quot;&gt;:&lt;/span&gt;n] &lt;span class=&quot;sc&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;sc&quot;&gt;|&lt;/span&gt; (r&lt;span class=&quot;sc&quot;&gt;:&lt;/span&gt;n &lt;span class=&quot;sc&quot;&gt;==&lt;/span&gt; n)))&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;## [1] 3&lt;/code&gt;&lt;/pre&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb6&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb6-1&quot;&gt;&lt;a href=&quot;#cb6-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;x[pickIdx &lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt; (r&lt;span class=&quot;dv&quot;&gt;-1&lt;/span&gt;)]&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;## [1] 1&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;In the example we thus actually manage to select the best candidate!
However, this is not always guaranteed: for example, if the best overall
candidate is among the training sample (4/10 chance for this to happen)
we would end up with the last candidate flat no matter how good or bad
it is. As stated above: the probability that the above decision strategy
will pick the best candidate is &lt;span
class=&quot;math inline&quot;&gt;\(\phi_{10}(4)=0.40\)&lt;/span&gt;.&lt;/p&gt;
&lt;p&gt;In order to compare the decision strategy with later formulations we
denote by &lt;span
class=&quot;math inline&quot;&gt;\(\mathbf{s}=(s_1,\ldots,s_n)\)&lt;/span&gt; a strategy
which at time &lt;span class=&quot;math inline&quot;&gt;\(i\)&lt;/span&gt; selects candidate
&lt;span class=&quot;math inline&quot;&gt;\(i\)&lt;/span&gt;, if &lt;span
class=&quot;math inline&quot;&gt;\(y_i \leq s_i\)&lt;/span&gt;. In other words, the above
strategy for &lt;span class=&quot;math inline&quot;&gt;\(n=10\)&lt;/span&gt; is:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb8&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb8-1&quot;&gt;&lt;a href=&quot;#cb8-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;s &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;c&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;rep&lt;/span&gt;(&lt;span class=&quot;dv&quot;&gt;0&lt;/span&gt;,r&lt;span class=&quot;dv&quot;&gt;-1&lt;/span&gt;),&lt;span class=&quot;fu&quot;&gt;rep&lt;/span&gt;(&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;,n&lt;span class=&quot;sc&quot;&gt;-&lt;/span&gt;(r&lt;span class=&quot;dv&quot;&gt;-1&lt;/span&gt;)&lt;span class=&quot;sc&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;),n)&lt;/span&gt;
&lt;span id=&quot;cb8-2&quot;&gt;&lt;a href=&quot;#cb8-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;s&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;##  [1]  0  0  0  1  1  1  1  1  1 10&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;And the selected candidate can easily found as&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb10&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb10-1&quot;&gt;&lt;a href=&quot;#cb10-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;which.max&lt;/span&gt;(y &lt;span class=&quot;sc&quot;&gt;&amp;lt;=&lt;/span&gt; s)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;## [1] 6&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;For small &lt;span class=&quot;math inline&quot;&gt;\(n\)&lt;/span&gt; the optimal &lt;span
class=&quot;math inline&quot;&gt;\(r\)&lt;/span&gt; and corresponding probability of
success can easily be computed numerically. However, for large &lt;span
class=&quot;math inline&quot;&gt;\(n\)&lt;/span&gt; the numerical precision as well as the
computations become more tedious and hence interest is in finding a
general asymptotic approximation as &lt;span
class=&quot;math inline&quot;&gt;\(n\)&lt;/span&gt; grows large: One can show that as &lt;span
class=&quot;math inline&quot;&gt;\(n\)&lt;/span&gt; gets large the optimal procedure is
always to screen the first &lt;span class=&quot;math inline&quot;&gt;\(1/e\)&lt;/span&gt; =
37% and then select the first candidate better than the training sample
&lt;span class=&quot;citation&quot; data-cites=&quot;gilbert_mosteller1966&quot;&gt;(Gilbert and
Mosteller 1966)&lt;/span&gt;. The asymptotic probability of success,
i.e. finding the overall best candidate, when following the such a
procedure is also about &lt;span class=&quot;math inline&quot;&gt;\(1/e\)&lt;/span&gt;=37%
&lt;span class=&quot;citation&quot; data-cites=&quot;gilbert_mosteller1966&quot;&gt;(Gilbert and
Mosteller 1966)&lt;/span&gt;. Below we show a small table illustrating the
precision of the asymptotic approximation.&lt;/p&gt;
&lt;center&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr class=&quot;header&quot;&gt;
&lt;th style=&quot;text-align: right;&quot;&gt;&lt;span
class=&quot;math inline&quot;&gt;\(n\)&lt;/span&gt;&lt;/th&gt;
&lt;th style=&quot;text-align: right;&quot;&gt;&lt;span
class=&quot;math inline&quot;&gt;\(r-1\)&lt;/span&gt;&lt;/th&gt;
&lt;th style=&quot;text-align: right;&quot;&gt;&lt;span
class=&quot;math inline&quot;&gt;\((r-1)/n\)&lt;/span&gt; (%)&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr class=&quot;odd&quot;&gt;
&lt;td style=&quot;text-align: right;&quot;&gt;10&lt;/td&gt;
&lt;td style=&quot;text-align: right;&quot;&gt;4&lt;/td&gt;
&lt;td style=&quot;text-align: right;&quot;&gt;40.0&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&quot;even&quot;&gt;
&lt;td style=&quot;text-align: right;&quot;&gt;100&lt;/td&gt;
&lt;td style=&quot;text-align: right;&quot;&gt;38&lt;/td&gt;
&lt;td style=&quot;text-align: right;&quot;&gt;38.0&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&quot;odd&quot;&gt;
&lt;td style=&quot;text-align: right;&quot;&gt;1000&lt;/td&gt;
&lt;td style=&quot;text-align: right;&quot;&gt;369&lt;/td&gt;
&lt;td style=&quot;text-align: right;&quot;&gt;36.9&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&quot;even&quot;&gt;
&lt;td style=&quot;text-align: right;&quot;&gt;10000&lt;/td&gt;
&lt;td style=&quot;text-align: right;&quot;&gt;3680&lt;/td&gt;
&lt;td style=&quot;text-align: right;&quot;&gt;36.8&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;/center&gt;
&lt;p&gt;We summarise our above findings for how to find the best candidate in
the following function:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb12&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb12-1&quot;&gt;&lt;a href=&quot;#cb12-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;strategy_best &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;cf&quot;&gt;function&lt;/span&gt;(n) {&lt;/span&gt;
&lt;span id=&quot;cb12-2&quot;&gt;&lt;a href=&quot;#cb12-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  r &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;find_r&lt;/span&gt;(n)&lt;/span&gt;
&lt;span id=&quot;cb12-3&quot;&gt;&lt;a href=&quot;#cb12-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  s &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;c&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;rep&lt;/span&gt;(&lt;span class=&quot;dv&quot;&gt;0&lt;/span&gt;,r&lt;span class=&quot;dv&quot;&gt;-1&lt;/span&gt;),&lt;span class=&quot;fu&quot;&gt;rep&lt;/span&gt;(&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;,n&lt;span class=&quot;sc&quot;&gt;-&lt;/span&gt;(r&lt;span class=&quot;dv&quot;&gt;-1&lt;/span&gt;)&lt;span class=&quot;sc&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;),n)&lt;/span&gt;
&lt;span id=&quot;cb12-4&quot;&gt;&lt;a href=&quot;#cb12-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;return&lt;/span&gt;(s)&lt;/span&gt;
&lt;span id=&quot;cb12-5&quot;&gt;&lt;a href=&quot;#cb12-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;}&lt;/span&gt;
&lt;span id=&quot;cb12-6&quot;&gt;&lt;a href=&quot;#cb12-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb12-7&quot;&gt;&lt;a href=&quot;#cb12-7&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;(s &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;strategy_best&lt;/span&gt;(n))&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;##  [1]  0  0  0  1  1  1  1  1  1 10&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;…and sometimes one animation says more than a lot of text and
equations:&lt;/p&gt;
&lt;p&gt;&lt;img
src=&quot;/blog/figure/source/2016-06-12-optimalChoice/animation-select.gif&quot; /&gt;&lt;/p&gt;
&lt;h2 id=&quot;maximizing-the-expected-rank&quot;&gt;Maximizing the expected rank&lt;/h2&gt;
&lt;p&gt;As attractive as it may sound, finding the overall best candidate
appears a pedant’s criterion. In reality, you would typically settle
with a lesser rank, as long as you know the candidate is good and it’s
yours to keep. Hence, finding a &lt;a
href=&quot;https://en.wikipedia.org/wiki/Satisficing&quot;&gt;satisficing&lt;/a&gt;
strategy to minimize, e.g., the expected rank appears a more prudent
objective for the risk adverse decision maker. This problem was
addressed by &lt;span class=&quot;citation&quot; data-cites=&quot;chow_etal1964&quot;&gt;Chow et
al. (1964)&lt;/span&gt;, we shall follow their treatment in what follows.&lt;/p&gt;
&lt;p&gt;In their paper they show that the relative ranks &lt;span
class=&quot;math inline&quot;&gt;\(y_1,\ldots,y_n\)&lt;/span&gt; are independent and the
probability mass function of the &lt;span
class=&quot;math inline&quot;&gt;\(i\)&lt;/span&gt;’s relative rank is &lt;span
class=&quot;math inline&quot;&gt;\(P(y_i=j)=1/i\)&lt;/span&gt;, &lt;span
class=&quot;math inline&quot;&gt;\(j=1,\ldots,i\)&lt;/span&gt;. Furthermore, the sequence
of relative ranks has the Markov property and, hence,&lt;/p&gt;
&lt;p&gt;&lt;span class=&quot;math display&quot;&gt;\[
P(x_i=k|y_1=j_1,\ldots,y_{i-1}=j_{i-1},y_i=j) = P(x_i=k|y_i=j) =
\frac{\binom{k-1}{j-1} \binom{n-k}{i-j}}{\binom{n}{i}}.
\]&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;From this one computes&lt;/p&gt;
&lt;p&gt;&lt;span class=&quot;math display&quot;&gt;\[
E(x_i|y_i=j) = \sum_{k=1}^n k\cdot P(x_i=k|y_i=j) = \frac{n+1}{i+1} j.
\]&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;Define &lt;span class=&quot;math inline&quot;&gt;\(c_i=c_i(n)\)&lt;/span&gt; to be the
minimal possible expected overall rank selected if we limit us to
strategies of the following type: use the first &lt;span
class=&quot;math inline&quot;&gt;\(i\)&lt;/span&gt; candidates to generate a baseline and
then, starting from &lt;span class=&quot;math inline&quot;&gt;\(i+1\)&lt;/span&gt;, select the
first candidate better than the baseline. &lt;span class=&quot;citation&quot;
data-cites=&quot;chow_etal1964&quot;&gt;Chow et al. (1964)&lt;/span&gt; shows that &lt;span
class=&quot;math inline&quot;&gt;\(c_i\)&lt;/span&gt; can be computed by backwards
recursion: Beginning with&lt;/p&gt;
&lt;p&gt;&lt;span class=&quot;math display&quot;&gt;\[
c_{n-1} = E\left(\frac{n+1}{n+1}y_n\right) = \frac{1}{n} \sum_{j=1}^n
j = \frac{n+1}{2},
\]&lt;/span&gt; and then for &lt;span
class=&quot;math inline&quot;&gt;\(i=n-1,n-2,\ldots,1\)&lt;/span&gt; letting &lt;span
class=&quot;math display&quot;&gt;\[
s_i     = \left[ \frac{i+1}{n+1} c_i\right] \\
c_{i-1} = \frac{1}{i} \left[ \frac{n+1}{i+1} \cdot \frac{s_i(s_i+1)}{2}+
(i-s_i)c_i \right],
\]&lt;/span&gt; where &lt;span class=&quot;math inline&quot;&gt;\([x]\)&lt;/span&gt; denotes the
largest integer smaller or equal to &lt;span
class=&quot;math inline&quot;&gt;\(x\)&lt;/span&gt;, i.e. &lt;code&gt;floor(x)&lt;/code&gt;. Because at
each decision time &lt;span class=&quot;math inline&quot;&gt;\(i\)&lt;/span&gt; we choose
between either picking the current candidate or proceeding to the next
candidate, we can evaluate the two options according to their expected
payoff:&lt;/p&gt;
&lt;ol type=&quot;1&quot;&gt;
&lt;li&gt;if we decide to wait deciding for at least another round the
expected payoff is &lt;span class=&quot;math inline&quot;&gt;\(c_i\)&lt;/span&gt;&lt;/li&gt;
&lt;li&gt;If we selected the current candidate, which has relative rank &lt;span
class=&quot;math inline&quot;&gt;\(y_i=j\)&lt;/span&gt; our expected payoff is &lt;span
class=&quot;math inline&quot;&gt;\(E(x_i|y_i=j)\)&lt;/span&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;Our optimal stopping time is thus&lt;/p&gt;
&lt;p&gt;&lt;span class=&quot;math display&quot;&gt;\[
\min_{i\in \{1,\ldots,n\}} \{ E(x_i|y_i=j) \geq c_{i} \&amp;gt; \text{or}
\&amp;gt; i=n \}.
\]&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;Implicitly, the above computed sequence of &lt;span
class=&quot;math inline&quot;&gt;\(s_i\)&lt;/span&gt;’s actually contains the resulting
decision strategy &lt;span class=&quot;citation&quot;
data-cites=&quot;chow_etal1964&quot;&gt;(Chow et al. 1964)&lt;/span&gt;. We transfer the
procedure into R code as follows:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb14&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb14-1&quot;&gt;&lt;a href=&quot;#cb14-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;# Function to find a strategy minimizing expected rank as done by Chow et al. (1964).&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb14-2&quot;&gt;&lt;a href=&quot;#cb14-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;strategy_erank &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;cf&quot;&gt;function&lt;/span&gt;(n) {&lt;/span&gt;
&lt;span id=&quot;cb14-3&quot;&gt;&lt;a href=&quot;#cb14-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  c &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; s &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;rep&lt;/span&gt;(&lt;span class=&quot;cn&quot;&gt;NA&lt;/span&gt;,n)&lt;/span&gt;
&lt;span id=&quot;cb14-4&quot;&gt;&lt;a href=&quot;#cb14-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  idx &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;cf&quot;&gt;function&lt;/span&gt;(i) {i&lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;}&lt;/span&gt;
&lt;span id=&quot;cb14-5&quot;&gt;&lt;a href=&quot;#cb14-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  c[&lt;span class=&quot;fu&quot;&gt;idx&lt;/span&gt;(n&lt;span class=&quot;dv&quot;&gt;-1&lt;/span&gt;)] &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; (n&lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;)&lt;span class=&quot;sc&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb14-6&quot;&gt;&lt;a href=&quot;#cb14-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  s[&lt;span class=&quot;fu&quot;&gt;idx&lt;/span&gt;(n)] &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; n&lt;/span&gt;
&lt;span id=&quot;cb14-7&quot;&gt;&lt;a href=&quot;#cb14-7&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb14-8&quot;&gt;&lt;a href=&quot;#cb14-8&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;cf&quot;&gt;for&lt;/span&gt; (i &lt;span class=&quot;cf&quot;&gt;in&lt;/span&gt; (n&lt;span class=&quot;dv&quot;&gt;-1&lt;/span&gt;)&lt;span class=&quot;sc&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;) {&lt;/span&gt;
&lt;span id=&quot;cb14-9&quot;&gt;&lt;a href=&quot;#cb14-9&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    s[&lt;span class=&quot;fu&quot;&gt;idx&lt;/span&gt;(i)]   &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;floor&lt;/span&gt;( (i&lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;)&lt;span class=&quot;sc&quot;&gt;/&lt;/span&gt;(n&lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;)&lt;span class=&quot;sc&quot;&gt;*&lt;/span&gt;c[&lt;span class=&quot;fu&quot;&gt;idx&lt;/span&gt;(i)])&lt;/span&gt;
&lt;span id=&quot;cb14-10&quot;&gt;&lt;a href=&quot;#cb14-10&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    c[&lt;span class=&quot;fu&quot;&gt;idx&lt;/span&gt;(i)&lt;span class=&quot;sc&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;] &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;/&lt;/span&gt;i &lt;span class=&quot;sc&quot;&gt;*&lt;/span&gt; ( (n&lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;)&lt;span class=&quot;sc&quot;&gt;/&lt;/span&gt;(i&lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;)&lt;span class=&quot;sc&quot;&gt;*&lt;/span&gt;s[&lt;span class=&quot;fu&quot;&gt;idx&lt;/span&gt;(i)]&lt;span class=&quot;sc&quot;&gt;*&lt;/span&gt;(s[&lt;span class=&quot;fu&quot;&gt;idx&lt;/span&gt;(i)]&lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;)&lt;span class=&quot;sc&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt; &lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt; (i&lt;span class=&quot;sc&quot;&gt;-&lt;/span&gt;s[&lt;span class=&quot;fu&quot;&gt;idx&lt;/span&gt;(i)])&lt;span class=&quot;sc&quot;&gt;*&lt;/span&gt;c[&lt;span class=&quot;fu&quot;&gt;idx&lt;/span&gt;(i)])&lt;/span&gt;
&lt;span id=&quot;cb14-11&quot;&gt;&lt;a href=&quot;#cb14-11&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  }&lt;/span&gt;
&lt;span id=&quot;cb14-12&quot;&gt;&lt;a href=&quot;#cb14-12&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb14-13&quot;&gt;&lt;a href=&quot;#cb14-13&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;return&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;list&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;s=&lt;/span&gt;s,&lt;span class=&quot;at&quot;&gt;c=&lt;/span&gt;c))&lt;/span&gt;
&lt;span id=&quot;cb14-14&quot;&gt;&lt;a href=&quot;#cb14-14&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;}&lt;/span&gt;
&lt;span id=&quot;cb14-15&quot;&gt;&lt;a href=&quot;#cb14-15&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb14-16&quot;&gt;&lt;a href=&quot;#cb14-16&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;print&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;strategy_erank&lt;/span&gt;(n),&lt;span class=&quot;at&quot;&gt;digits=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;4&lt;/span&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;## $s
##  [1] NA  0  0  0  1  1  2  2  3  5 10
## 
## $c
##  [1] 2.558 2.558 2.558 2.558 2.677 2.888 3.154 3.590 4.278 5.500&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Note that in the above, the first element of the vectors
&lt;code&gt;s&lt;/code&gt; and &lt;code&gt;c&lt;/code&gt; is the element 0. Hence, &lt;span
class=&quot;math inline&quot;&gt;\(s_1\)&lt;/span&gt; is located at position two of the
vector. It is interesting to observe that for the example one forms a
baseline for the same amount of time, but after a while becomes more
&lt;strong&gt;desperate&lt;/strong&gt; and accepts candidates who are not
optimal.&lt;/p&gt;
&lt;p&gt;Finally, it is interesting to compare the two strategies for any
&lt;span class=&quot;math inline&quot;&gt;\(n\)&lt;/span&gt; we like, e.g. &lt;span
class=&quot;math inline&quot;&gt;\(n=15\)&lt;/span&gt;:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb16&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb16-1&quot;&gt;&lt;a href=&quot;#cb16-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;(two_s &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;rbind&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;best=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;strategy_best&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;n=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;15&lt;/span&gt;), &lt;span class=&quot;at&quot;&gt;erank=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;strategy_erank&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;n=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;15&lt;/span&gt;)&lt;span class=&quot;sc&quot;&gt;$&lt;/span&gt;s[&lt;span class=&quot;sc&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;]))&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;##       [,1] [,2] [,3] [,4] [,5] [,6] [,7] [,8] [,9] [,10] [,11] [,12] [,13] [,14] [,15]
## best     0    0    0    0    0    1    1    1    1     1     1     1     1     1    15
## erank    0    0    0    0    1    1    1    1    2     2     3     4     5     7    15&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Again, for the expected minimizing rank strategy our training sample
is slightly smaller than for the selecting the best strategy.
Furthermore, we again adapt our relative-rank criterion as one becomes
more desperate towards the end. Finally, we illustrate the two
strategies on the &lt;span class=&quot;math inline&quot;&gt;\(n=15\)&lt;/span&gt; sequence
with ranks &lt;span class=&quot;math inline&quot;&gt;\(x\)&lt;/span&gt; (and resulting
relative ranks &lt;span class=&quot;math inline&quot;&gt;\(y\)&lt;/span&gt;):&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;##   [,1] [,2] [,3] [,4] [,5] [,6] [,7] [,8] [,9] [,10] [,11] [,12] [,13] [,14] [,15]
## x    8    5    6    9    1    3   10   12   14    15     4    13    11     2     7
## y    1    1    2    4    1    2    7    8    9    10     3    10     9     2     7&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;img
src=&quot;/blog/figure/source/2016-06-12-optimalChoice/animation-select2.gif&quot; /&gt;&lt;/p&gt;
&lt;h1 id=&quot;monte-carlo-simulation&quot;&gt;Monte Carlo simulation&lt;/h1&gt;
&lt;p&gt;Using Monte Carlo integration we can for a given &lt;span
class=&quot;math inline&quot;&gt;\(n\)&lt;/span&gt; compute the expected rank obtained by
each of the strategies.&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb19&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb19-1&quot;&gt;&lt;a href=&quot;#cb19-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;simulate &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;cf&quot;&gt;function&lt;/span&gt;(s,n) {&lt;/span&gt;
&lt;span id=&quot;cb19-2&quot;&gt;&lt;a href=&quot;#cb19-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  x &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;sample&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;seq_len&lt;/span&gt;(n),&lt;span class=&quot;at&quot;&gt;size=&lt;/span&gt;n,&lt;span class=&quot;at&quot;&gt;replace=&lt;/span&gt;&lt;span class=&quot;cn&quot;&gt;FALSE&lt;/span&gt;)&lt;/span&gt;
&lt;span id=&quot;cb19-3&quot;&gt;&lt;a href=&quot;#cb19-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  y &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;relrank&lt;/span&gt;(x)&lt;/span&gt;
&lt;span id=&quot;cb19-4&quot;&gt;&lt;a href=&quot;#cb19-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  idxSelect &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;which.max&lt;/span&gt;(y &lt;span class=&quot;sc&quot;&gt;&amp;lt;=&lt;/span&gt; s)&lt;/span&gt;
&lt;span id=&quot;cb19-5&quot;&gt;&lt;a href=&quot;#cb19-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;return&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;c&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;rank=&lt;/span&gt;x[idxSelect],&lt;span class=&quot;at&quot;&gt;idx=&lt;/span&gt;idxSelect,&lt;span class=&quot;at&quot;&gt;isBest=&lt;/span&gt;(x[idxSelect]&lt;span class=&quot;sc&quot;&gt;==&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;)))&lt;/span&gt;
&lt;span id=&quot;cb19-6&quot;&gt;&lt;a href=&quot;#cb19-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;}&lt;/span&gt;
&lt;span id=&quot;cb19-7&quot;&gt;&lt;a href=&quot;#cb19-7&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb19-8&quot;&gt;&lt;a href=&quot;#cb19-8&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;strategies &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;list&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;s_best=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;strategy_best&lt;/span&gt;(n), &lt;span class=&quot;at&quot;&gt;s_erank=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;strategy_erank&lt;/span&gt;(n)&lt;span class=&quot;sc&quot;&gt;$&lt;/span&gt;s[&lt;span class=&quot;sc&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;])&lt;/span&gt;
&lt;span id=&quot;cb19-9&quot;&gt;&lt;a href=&quot;#cb19-9&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;res &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;lapply&lt;/span&gt;(strategies, &lt;span class=&quot;cf&quot;&gt;function&lt;/span&gt;(s) &lt;span class=&quot;fu&quot;&gt;replicate&lt;/span&gt;(&lt;span class=&quot;fl&quot;&gt;1e5&lt;/span&gt;, &lt;span class=&quot;fu&quot;&gt;simulate&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;s=&lt;/span&gt;s,&lt;span class=&quot;at&quot;&gt;n=&lt;/span&gt;n)))&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb20&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb20-1&quot;&gt;&lt;a href=&quot;#cb20-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;(sim &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;rbind&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;best=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;apply&lt;/span&gt;(res[[&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;]], &lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;,mean), &lt;span class=&quot;at&quot;&gt;erank=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;apply&lt;/span&gt;(res[[&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;]],&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;,mean)))&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;##          rank     idx  isBest
## best  3.02481 6.98755 0.39855
## erank 2.55563 6.27949 0.33177&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;From the results it becomes clear that the expected rank optimizing
strategy on average takes a little less time before selecting a
candidate. Furthermore, the obtained expected rank is somewhat better
than for the overall best decision strategy. We can also compare the
Monte Carlo estimate &lt;code&gt;sim[&quot;erank&quot;,&quot;rank&quot;]&lt;/code&gt;=2.556 against the
theoretical value of &lt;span class=&quot;math inline&quot;&gt;\(c_0\)&lt;/span&gt;=2.558.&lt;/p&gt;
&lt;h1 id=&quot;discussion&quot;&gt;Discussion&lt;/h1&gt;
&lt;p&gt;Is the blog title &lt;em&gt;Mathematical advice for real life&lt;/em&gt; an
&lt;strong&gt;oxymoron&lt;/strong&gt;? Certainly not! Assumptions 1-6 clearly state
the abstraction. You may not agree with these assumptions, but given
that framework, the two functions &lt;code&gt;strategy_best&lt;/code&gt;and
&lt;code&gt;strategy_erank&lt;/code&gt; give practical advice for a certain class of
decisions. The methods are also clearly superior to &lt;a
href=&quot;https://www.youtube.com/watch?v=BVIjqd8DBGw&quot;&gt;Sheldon Cooper’s dice
strategy&lt;/a&gt;. Furthermore, assumptions 1-6 have been improved upon in a
multitude of ways &lt;span class=&quot;citation&quot;
data-cites=&quot;freeman1983&quot;&gt;(Freeman 1983)&lt;/span&gt;. For example:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;unknown &lt;span class=&quot;math inline&quot;&gt;\(n\)&lt;/span&gt; or random &lt;span
class=&quot;math inline&quot;&gt;\(n\sim\operatorname{Po}(\lambda)\)&lt;/span&gt;&lt;/li&gt;
&lt;li&gt;the opportunity to return to previous candidates, but with a
probability &lt;span class=&quot;math inline&quot;&gt;\(p\)&lt;/span&gt; of being
rejected&lt;/li&gt;
&lt;li&gt;Candidate score originating from a known underlying distribution,
e.g. the uniform or the normal&lt;/li&gt;
&lt;li&gt;Candidate score originating from an &lt;span
class=&quot;math inline&quot;&gt;\(U(a,b)\)&lt;/span&gt; uniform with unknown &lt;span
class=&quot;math inline&quot;&gt;\(a&amp;lt;b\)&lt;/span&gt;, but with a conjugate and
sequentially updated bivariate Pareto prior on &lt;span
class=&quot;math inline&quot;&gt;\((a,b)\)&lt;/span&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Altogether, such methods provide decision support: One can evaluate a
potential decision and compare results with other ways of reaching the
decision. &lt;span class=&quot;citation&quot; data-cites=&quot;frey_eichenberger1996&quot;&gt;Frey
and Eichenberger (1996)&lt;/span&gt; discuss that for marriage decisions
investigations show that individuals decide rather quickly marrying the
first reasonably serious partner. Where does this misalignment between
theory and practice originate from? Some of it appears to be
consequences of additional effects not addressed by the model, e.g.,
little marginal gain of searching longer, &lt;em&gt;lemon effects&lt;/em&gt;,
satisficing, endowment effects, etc… &lt;strong&gt;Life is
complicated&lt;/strong&gt;. Finding a satisficing complexity representation is
non-trivial - even for mathematicians. :-)&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;http://staff.math.su.se/hoehle/blog/figure/source/2016-06-12-optimalChoice/unnamed-chunk-17-1.png&quot; style=&quot;display: block; margin: auto;&quot; /&gt;&lt;/p&gt;
&lt;h1 class=&quot;unnumbered&quot; id=&quot;references&quot;&gt;References&lt;/h1&gt;
&lt;div id=&quot;refs&quot; class=&quot;references csl-bib-body hanging-indent&quot;
data-entry-spacing=&quot;0&quot; role=&quot;list&quot;&gt;
&lt;div id=&quot;ref-berger1985&quot; class=&quot;csl-entry&quot; role=&quot;listitem&quot;&gt;
Berger, J. O. 1985. &lt;em&gt;Statistical Decision Theory and
&lt;span&gt;B&lt;/span&gt;ayesian Analysis&lt;/em&gt;. 2nd ed. Springer Series in
Statistics. New York, Berlin, Heidelberg: Springer.
&lt;/div&gt;
&lt;div id=&quot;ref-chow_etal1964&quot; class=&quot;csl-entry&quot; role=&quot;listitem&quot;&gt;
Chow, Y. S., S. Moriguti, H. Robbins, and S. M. Samuels. 1964.
&lt;span&gt;“Optimal Selection Based on Relative Rank (the &lt;span&gt;‘Secretary
Problem’&lt;/span&gt;).”&lt;/span&gt; &lt;em&gt;Israel Journal of Mathematics&lt;/em&gt; 2 (2):
81–90. &lt;a
href=&quot;https://doi.org/10.1007/BF02759948&quot;&gt;https://doi.org/10.1007/BF02759948&lt;/a&gt;.
&lt;/div&gt;
&lt;div id=&quot;ref-degroot1970&quot; class=&quot;csl-entry&quot; role=&quot;listitem&quot;&gt;
DeGroot, Morris. 1970. &lt;em&gt;Optimal Statistical Decisions&lt;/em&gt;.
McGraw-Hill. New York.
&lt;/div&gt;
&lt;div id=&quot;ref-ferguson1989&quot; class=&quot;csl-entry&quot; role=&quot;listitem&quot;&gt;
Ferguson, T. S. 1989. &lt;span&gt;“Who Solved the Secretary Problem?”&lt;/span&gt;
&lt;em&gt;Statist. Sci.&lt;/em&gt; 4 (3): 282–89. &lt;a
href=&quot;https://doi.org/10.1214/ss/1177012493&quot;&gt;https://doi.org/10.1214/ss/1177012493&lt;/a&gt;.
&lt;/div&gt;
&lt;div id=&quot;ref-freeman1983&quot; class=&quot;csl-entry&quot; role=&quot;listitem&quot;&gt;
Freeman, P. R. 1983. &lt;span&gt;“The Secretary Problem and Its Extensions: A
Review.”&lt;/span&gt; &lt;em&gt;International Statistical Review / Revue
Internationale de Statistique&lt;/em&gt; 51 (2): 189–206. &lt;a
href=&quot;http://www.jstor.org/stable/1402748&quot;&gt;http://www.jstor.org/stable/1402748&lt;/a&gt;.
&lt;/div&gt;
&lt;div id=&quot;ref-frey_eichenberger1996&quot; class=&quot;csl-entry&quot; role=&quot;listitem&quot;&gt;
Frey, B. S., and R. Eichenberger. 1996. &lt;span&gt;“Marriage
Paradoxes.”&lt;/span&gt; &lt;em&gt;Rationality and Society&lt;/em&gt; 8 (2): 187–206.
&lt;/div&gt;
&lt;div id=&quot;ref-gilbert_mosteller1966&quot; class=&quot;csl-entry&quot; role=&quot;listitem&quot;&gt;
Gilbert, J. P., and F. Mosteller. 1966. &lt;span&gt;“Recognizing the Maximum
of a Sequence.”&lt;/span&gt; &lt;em&gt;Journal of the American Statistical
Association&lt;/em&gt; 61 (313): 35–73. &lt;a
href=&quot;http://www.jstor.org/stable/2283044&quot;&gt;http://www.jstor.org/stable/2283044&lt;/a&gt;.
&lt;/div&gt;
&lt;div id=&quot;ref-jensen_nielsen2007&quot; class=&quot;csl-entry&quot; role=&quot;listitem&quot;&gt;
Jensen, F. V., and T. D. Nielsen. 2007. &lt;em&gt;Bayesian Networks and
Decision Graphs&lt;/em&gt;. 2nd ed. Springer Verlag.
&lt;/div&gt;
&lt;/div&gt;
</description>
        <pubDate>Sun, 12 Jun 2016 00:00:00 +0200</pubDate>
        <link>https://mhoehle.github.io/blog/2016/06/12/optimalChoice.html</link>
        <guid isPermaLink="true">https://mhoehle.github.io/blog/2016/06/12/optimalChoice.html</guid>
        
        <category>datascience</category>
        
        <category>rstats</category>
        
        <category>debugging</category>
        
        
      </item>
    
      <item>
        <title>Right or Wrong? - Validate Numbers Like a Boss</title>
        <description>&lt;h2 id=&quot;abstract&quot;&gt;Abstract&lt;/h2&gt;
&lt;p&gt;How does a statistician ensure that an analysis that comprises of
outputting &lt;span class=&quot;math inline&quot;&gt;\(N\)&lt;/span&gt; results is correct?
Can this be done without manually checking each of the results? Some
statistical approaches for this task of
&lt;strong&gt;proof-calculation&lt;/strong&gt; are described -
e.g. capture-recapture estimation and sequential decision making.&lt;/p&gt;
&lt;p&gt;&lt;br&gt;
&lt;a rel=&quot;license&quot; href=&quot;http://creativecommons.org/licenses/by-sa/4.0/&quot;&gt;&lt;img alt=&quot;Creative Commons License&quot; style=&quot;border-width:0&quot; src=&quot;https://i.creativecommons.org/l/by-sa/4.0/88x31.png&quot;/&gt;&lt;/a&gt;
This work is licensed under a &lt;a rel=&quot;license&quot;
href=&quot;http://creativecommons.org/licenses/by-sa/4.0/&quot;&gt;Creative Commons
Attribution-ShareAlike 4.0 International License&lt;/a&gt;. The
markdown+Rknitr source code of this blog is available under a &lt;a
href=&quot;https://www.gnu.org/licenses/gpl-3.0.html&quot;&gt;GNU General Public
License (GPL v3)&lt;/a&gt; license from github.&lt;/p&gt;
&lt;h1 id=&quot;introduction&quot;&gt;Introduction&lt;/h1&gt;
&lt;p&gt;One activity the public associates with &lt;strong&gt;statistics&lt;/strong&gt;
is the generation of large tables containing a multitude of numbers on a
phenomena of interest. Below an example containing the summary of &lt;a
href=&quot;https://www.ons.gov.uk/employmentandlabourmarket/peopleinwork/employmentandemployeetypes/bulletins/uklabourmarket/april2016&quot;&gt;UK
labour market statistics&lt;/a&gt; for the 3 months to February 2016 from the
Office for National Statistics:&lt;/p&gt;
&lt;p&gt;&lt;img
src=&quot;/blog/figure/source/2016-05-22-proofCalculation/unemployment-apr2016.png&quot;
title=&quot;Source: https://www.ons.gov.uk/employmentandlabourmarket/peopleinwork/employmentandemployeetypes/bulletins/uklabourmarket/april2016&quot; /&gt;&lt;/p&gt;
&lt;p&gt;Another example is The German Federal Government’s &lt;a
href=&quot;http://www.bmas.de/DE/Service/Medien/Publikationen/a334-4-armuts-reichtumsbericht-2013.html&quot;&gt;4th
Report on Poverty and Wealth&lt;/a&gt;. The report consists of a total of 549
pages with the pure table appendix fun starting on p. 518 including,
e.g., age-adjusted ORs obtained from logistic regression modelling
(p.523).&lt;/p&gt;
&lt;p&gt;Even though dynamic &amp;amp; web-based reporting coupled with graphical
&amp;amp; interactive visualizations have developed to a point making such
tables obsolete, this does not change the fact that the results still
need to be &lt;strong&gt;correct&lt;/strong&gt;. As a consequence, the results need
to be validated to ensure their correctness, occasionally even beyond
any doubt! In what follow we will use the term &lt;strong&gt;result&lt;/strong&gt;
to describe an output element of the statistical analysis. In most cases
results are numbers, but we shall use the term number and result
interchangeably. However, results could also denote higher level output
elements, e.g., complete tables, a specific line in a graph or the
complete output of a particular query.&lt;/p&gt;
&lt;p&gt;Surprisingly, statistics students are taught very little about
addressing such a task using what we do best: statistics. We teach about
the median, censoring &amp;amp; truncation, complex modelling and computer
intensive inference methods. Maybe we even tell them about
&lt;code&gt;knitr&lt;/code&gt; as way to get the same results twice (a minimum
requirement to ensure correctness). However, spraying out numbers (even
from the most beautiful model) is &lt;strong&gt;not cool&lt;/strong&gt; if the
initial data-munging went wrong or if your quotient is obtained by
dividing with the wrong denominator.&lt;/p&gt;
&lt;p&gt;The on-going discussion of &lt;strong&gt;reproducible research&lt;/strong&gt;
aims at the core of this problem: How to ensure that your analysis
re-producible and correct? As modern statistics becomes more and more
programming oriented it appears natural to seek inspiration from the
discipline of &lt;strong&gt;software testing&lt;/strong&gt;. Another entertaining
source of inspiration is the concept of optimal
&lt;strong&gt;proofreading&lt;/strong&gt;. This dates back to the 1970-1980s, where
the problem is formulated as the search for an optimal stopping rules
for the process of checking a text consisting of &lt;span
class=&quot;math inline&quot;&gt;\(M\)&lt;/span&gt; words - see for example Yang et
al. (1982). Periodically, the software development community re-visits
these works - see for example Hayes (2010). Singpurwalla and Wilson
(1999) give a thorough exposition of treating uncertainty in the context
of software engineering by interfacing between statistics and software
engineering.&lt;/p&gt;
&lt;h1 id=&quot;proofcalculation&quot;&gt;Proofcalculation&lt;/h1&gt;
&lt;p&gt;The scientific method of choice to address validity is &lt;strong&gt;peer
review&lt;/strong&gt;. This can go as far as having the reviewer implement the
analysis as a completely separate and independent process in order to
check that results agree. Reporting the results of clinical trials have
such independent implementations as part of the protocol. Such a
co-pilot approach fits nicely to the fact that real-life statistical
analysis rarely is a one-person activity anymore. In practice, there
might neither be a need nor the resources to rebuild entire analyses,
but critical parts need to be &lt;strong&gt;double-checked&lt;/strong&gt;. Pair
programming is one technique from the agile programming world to
accomodate this. However, single programmers coding independently and
then compare results appears a better way to quality-control critical
code &amp;amp; analysis segments.&lt;/p&gt;
&lt;p&gt;Formalizing the validation task into mathematical notation, let’s
assume the report of interest consists of a total of &lt;span
class=&quot;math inline&quot;&gt;\(N\)&lt;/span&gt; numbers. These numbers have a
hierarchical structure, e.g., they relate to various parts of the
analysis or are part of individual tables. Error search is performed
along this hierarchical structure. Good proofcalculation strategies
follow the principles of software testing - for example it may be
worthwhile to remember &lt;strong&gt;Pareto’s law&lt;/strong&gt;: 80 percent of the
error are found in 20 percent of the modules to test. In other words:
keep looking for errors at places where you already found some. Further
hints on a well structured debugging process can be found in Zeller
(2009) where the quote on Pareto’s law is also from.&lt;/p&gt;
&lt;p&gt;One crucial question is what exactly we mean by an
&lt;strong&gt;error&lt;/strong&gt;? A result can be wrong, because of a bug in the
code line computing it. Strictly speaking &lt;strong&gt;wrong&lt;/strong&gt; is just
the (mathematical) black-and-white version of the complex phenomena
describing a misalignment between what is perceived and what is desired
by somebody. A more in-depth debate of what’s &lt;em&gt;wrong&lt;/em&gt; is beyond
the scope of this note, but certainly there are situations when a result
is agreeably wrong, e.g., due to erroneous counting of the number of
distinct elements in the denominator set. More complicated cases could
be the use of a wrong regression model compared to what was described in
the methodology section, e.g., use of an extra unintended covariate.
Even worse are problems in the data-prepossessing step resulting in a
wrong data foundation and, hence, invalidating a large part of the
results. Altogether, a result be wrong in more than one way and one
error can invalidate several results: the &lt;span
class=&quot;math inline&quot;&gt;\(M\)&lt;/span&gt; results are just the final output -
what matters is what happens along your &lt;strong&gt;analysis
pipeline&lt;/strong&gt;. Detecting a wrong result is thus merely a symptom of
a flawed pipeline. This also means that fixing the bug causing a number
to be wrong does not necessarily ensure that the number is correct
afterwards.&lt;/p&gt;
&lt;p&gt;We summarise the above discussion by making the following simplifying
abstractions:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p&gt;The number of results which is wrong is a function of the number
of errors &lt;span class=&quot;math inline&quot;&gt;\(M\)&lt;/span&gt;. One error invalidates
at least one result, but it can invalidate several jointly and errors
can overlap thus invalidating the same number.&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;We deliberately keep the definition of an error vague, but mean a
mechanism which causes a result to be wrong. The simplest form of a
result is a number. The simplest error is a number which is
wrong.&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;The hierarchical structure of the numbers and the intertwined
code generating them is ignored. Instead, we simply assume there are
&lt;span class=&quot;math inline&quot;&gt;\(M\)&lt;/span&gt; errors and assume that these
errors are independent of each other.&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;We shall now describe an estimation approach a decision theoretic
approach for the problem.&lt;/p&gt;
&lt;h1 id=&quot;team-based-validation&quot;&gt;Team Based Validation&lt;/h1&gt;
&lt;p&gt;Consider the situation where a team of two statisticians together
validate the same report. Say the team use a fixed amount of time
(e.g. one day) trying to find as many errors in the numbers as possible.
During the test period no errors are fixed - this happens only after the
end of the period. Let’s assume that during the test period the two
statistician found &lt;span class=&quot;math inline&quot;&gt;\(n_1\)&lt;/span&gt; and &lt;span
class=&quot;math inline&quot;&gt;\(n_2\)&lt;/span&gt; wrong numbers, respectively. Let
&lt;span class=&quot;math inline&quot;&gt;\(0 \leq n_{12} \leq \min(n_1,n_2)\)&lt;/span&gt; be
the number of wrong numbers which were found by both statisticians.&lt;/p&gt;
&lt;p&gt;The data in alternative representation: Denote by &lt;span
class=&quot;math inline&quot;&gt;\(f_i, i=1,2\)&lt;/span&gt; the number of wrong numbers
found by &lt;span class=&quot;math inline&quot;&gt;\(i\)&lt;/span&gt; of the testers, i.e.&lt;/p&gt;
&lt;p&gt;&lt;span class=&quot;math display&quot;&gt;\[
\begin{aligned}
f_1 &amp;amp;=(n_1-n_{12})+(n_2-n_{12})\\
f_2 &amp;amp;= n_{12}.
\end{aligned}
\]&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;These are the wrong numbers found by only one of the testers and by
both testers, respectively. Let &lt;span
class=&quot;math inline&quot;&gt;\(S=f_1+f_2=n_1+n_2-n_{12}\)&lt;/span&gt; be the total
number of erroneous numbers found in the test phase. Assuming that we in
the subsequent debugging phase are able to remove all these &lt;span
class=&quot;math inline&quot;&gt;\(S\)&lt;/span&gt; errors, we are interested in estimating
the number of remaining errors, i.e. &lt;span
class=&quot;math inline&quot;&gt;\(f_0\)&lt;/span&gt; or, alternatively, the total number
of errors &lt;span class=&quot;math inline&quot;&gt;\(M=S+f_0\)&lt;/span&gt;.&lt;/p&gt;
&lt;p&gt;Assume that after the first day of proofcalculation the two
statisticians obtain the following results:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb1&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb1-1&quot;&gt;&lt;a href=&quot;#cb1-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;testP &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;data.frame&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;t&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;c&lt;/span&gt;(&lt;span class=&quot;dv&quot;&gt;9&lt;/span&gt;,&lt;span class=&quot;dv&quot;&gt;12&lt;/span&gt;,&lt;span class=&quot;dv&quot;&gt;6&lt;/span&gt;)))&lt;/span&gt;
&lt;span id=&quot;cb1-2&quot;&gt;&lt;a href=&quot;#cb1-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;colnames&lt;/span&gt;(testP) &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;c&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;quot;01&amp;quot;&lt;/span&gt;,&lt;span class=&quot;st&quot;&gt;&amp;quot;10&amp;quot;&lt;/span&gt;,&lt;span class=&quot;st&quot;&gt;&amp;quot;11&amp;quot;&lt;/span&gt;)&lt;/span&gt;
&lt;span id=&quot;cb1-3&quot;&gt;&lt;a href=&quot;#cb1-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;testP&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;##   01 10 11
## 1  9 12  6&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;i.e. &lt;span class=&quot;math inline&quot;&gt;\(n_1=9\)&lt;/span&gt;, &lt;span
class=&quot;math inline&quot;&gt;\(n_2=12\)&lt;/span&gt; and &lt;span
class=&quot;math inline&quot;&gt;\(n_{12}=6\)&lt;/span&gt;. The total number of errors
found so far is &lt;span class=&quot;math inline&quot;&gt;\(S=27\)&lt;/span&gt;. In the above
code we use index &lt;code&gt;01&lt;/code&gt;, &lt;code&gt;10&lt;/code&gt; and &lt;code&gt;11&lt;/code&gt;
specifying the results in two binary variable bit-notation - this is
necessary for the &lt;code&gt;CARE1&lt;/code&gt; package used in the next
section.&lt;/p&gt;
&lt;h2 id=&quot;estimating-the-total-number-of-wrong-numbers&quot;&gt;Estimating the
total number of wrong numbers&lt;/h2&gt;
&lt;p&gt;Estimating the total number of errors from the above data is a
capture-recapture problem with two time points (=sampling
occasions).&lt;/p&gt;
&lt;h3 id=&quot;lincoln-petersen-estimator&quot;&gt;Lincoln-Petersen estimator&lt;/h3&gt;
&lt;p&gt;Under the simple assumption that the two statisticians are equally
good at finding errors and that the possible errors have the same
probability to be found (unrealistic?) a simple capture-recapture
estimate for the total number of errors is the so called &lt;a
href=&quot;https://en.wikipedia.org/wiki/Mark_and_recapture#Lincoln.E2.80.93Petersen_estimator&quot;&gt;Lincoln-Petersen
estimator&lt;/a&gt;):&lt;/p&gt;
&lt;p&gt;&lt;span class=&quot;math display&quot;&gt;\[
\hat{M} = \frac{n_1 \cdot n_2}{n_{12}}.
\]&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;Note that this estimator puts no upper-bound on &lt;span
class=&quot;math inline&quot;&gt;\(N\)&lt;/span&gt;. The estimator can be computed using,
e.g., the &lt;a
href=&quot;https://cran.r-project.org/web/packages/CARE1/index.html&quot;&gt;&lt;code&gt;CARE1&lt;/code&gt;&lt;/a&gt;
package:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb3&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb3-1&quot;&gt;&lt;a href=&quot;#cb3-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;(M.hat &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; CARE1&lt;span class=&quot;sc&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;estN.pair&lt;/span&gt;(testP))&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;##  Petersen   Chapman        se       cil       ciu 
## 45.000000 42.428571  9.151781 32.259669 72.257758&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;In other words, the estimated total number of errors is 45. A 95%
confidence interval (CI) for &lt;span class=&quot;math inline&quot;&gt;\(M\)&lt;/span&gt; is
32-72 - see the package documentation for details on the method for
computing the (CI). To verify the computations one could alternatively
compute the Lincoln-Petersen estimator manually:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb5&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb5-1&quot;&gt;&lt;a href=&quot;#cb5-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;(Nhat &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; (testP[&lt;span class=&quot;st&quot;&gt;&amp;quot;01&amp;quot;&lt;/span&gt;]&lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt;testP[&lt;span class=&quot;st&quot;&gt;&amp;quot;11&amp;quot;&lt;/span&gt;]) &lt;span class=&quot;sc&quot;&gt;*&lt;/span&gt; (testP[&lt;span class=&quot;st&quot;&gt;&amp;quot;10&amp;quot;&lt;/span&gt;]&lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt;testP[&lt;span class=&quot;st&quot;&gt;&amp;quot;11&amp;quot;&lt;/span&gt;]) &lt;span class=&quot;sc&quot;&gt;/&lt;/span&gt; testP[&lt;span class=&quot;st&quot;&gt;&amp;quot;11&amp;quot;&lt;/span&gt;])&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;##   01
## 1 45&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Finally, an estimate on the number of errors left to find is &lt;span
class=&quot;math inline&quot;&gt;\(\hat{M}-S=18.0\)&lt;/span&gt;.&lt;/p&gt;
&lt;h2 id=&quot;heterogeneous-sampling-probabilities&quot;&gt;Heterogeneous Sampling
Probabilities&lt;/h2&gt;
&lt;p&gt;If one does not want to assume the equal catch-probabilities of the
errors, a range of alternatives exists. One of them is the procedure by
Chao (1984, 1987). Here, a non-parametric estimate of the total number
of errors is given as:&lt;/p&gt;
&lt;p&gt;&lt;span class=&quot;math display&quot;&gt;\[
\hat{M} = S + \frac{f_1^2}{2 f_2}.
\]&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;The above estimator is based on the assumption that the two
statisticians are equally good at spotting errors, but unlike for the
Petersen-Lincoln estimator, errors can have heterogeneous detection
probabilities. No specific parametric model for the detection is
although required. An R implementation of the estimator is readily
available as part of the &lt;a
href=&quot;https://cran.r-project.org/web/packages/SPECIES/index.html&quot;&gt;&lt;code&gt;SPECIES&lt;/code&gt;&lt;/a&gt;
package. For this, data first need to be stored as a
&lt;code&gt;data.frame&lt;/code&gt; containing &lt;span class=&quot;math inline&quot;&gt;\(f_1,
f_2\)&lt;/span&gt;:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb7&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb7-1&quot;&gt;&lt;a href=&quot;#cb7-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;testPaggr &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;data.frame&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;j=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;,&lt;span class=&quot;at&quot;&gt;f_j=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;as.numeric&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;c&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;sum&lt;/span&gt;(testP[&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;]),testP[&lt;span class=&quot;dv&quot;&gt;3&lt;/span&gt;])))&lt;/span&gt;
&lt;span id=&quot;cb7-2&quot;&gt;&lt;a href=&quot;#cb7-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;testPaggr&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;##   j f_j
## 1 1  21
## 2 2   6&lt;/code&gt;&lt;/pre&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb9&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb9-1&quot;&gt;&lt;a href=&quot;#cb9-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;(M_est &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; SPECIES&lt;span class=&quot;sc&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;chao1984&lt;/span&gt;(testPaggr, &lt;span class=&quot;at&quot;&gt;conf=&lt;/span&gt;&lt;span class=&quot;fl&quot;&gt;0.95&lt;/span&gt;))&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;## $Nhat
## [1] 64
## 
## $SE
## [1] 22.78363
## 
## $CI
##      lb  ub
## [1,] 39 139&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;In this case the estimator for the total number of errors is &lt;span
class=&quot;math inline&quot;&gt;\(\hat{M}\)&lt;/span&gt;=64 (95% CI: 39-139). Again see
the package documentation for methodological details.&lt;/p&gt;
&lt;!-- ### Manual computation --&gt;
&lt;!-- Again, if the computation can of course also be done manually: --&gt;
&lt;!-- ```{r} --&gt;
&lt;!-- f &lt;- testPaggr$n_j --&gt;
&lt;!-- S &lt;- sum(f) --&gt;
&lt;!-- ceiling(S + f[1]^2/(2*f[2])) --&gt;
&lt;!-- ``` --&gt;
&lt;h1 id=&quot;knowing-when-to-stop&quot;&gt;Knowing when to Stop&lt;/h1&gt;
&lt;p&gt;Whereas the above estimates are nice to know, they give little
guidance on how, after the first day of testing, to decide between the
following two alternatives: continue validating numbers for another day
or stop the testing process and ship the report. We address this
sequential decision making problem by casting it into a decision
theoretic framework. Following the work of Ferguson and Hardwick (1989):
let’s assume that each futher round of proofcalculation costs an amount
of &lt;span class=&quot;math inline&quot;&gt;\(C_p&amp;gt;0\)&lt;/span&gt; units and that each
error undetected after additional &lt;span class=&quot;math inline&quot;&gt;\(n\)&lt;/span&gt;
rounds of proofcalculation costs &lt;span
class=&quot;math inline&quot;&gt;\(c_n&amp;gt;0\)&lt;/span&gt; units. Treating the total number
of wrong results &lt;span class=&quot;math inline&quot;&gt;\(M\)&lt;/span&gt; as a random
variable and letting &lt;span
class=&quot;math inline&quot;&gt;\(X_1,\ldots,X_n\)&lt;/span&gt;, be the number of wrong
results found in each of the additional proofcalculation rounds &lt;span
class=&quot;math inline&quot;&gt;\(1,\ldots,n\)&lt;/span&gt;, we know that &lt;span
class=&quot;math inline&quot;&gt;\(X_i\in \mathbb{N}_0\)&lt;/span&gt; and &lt;span
class=&quot;math inline&quot;&gt;\(\sum_{j=1}^n X_j \leq N\)&lt;/span&gt;. One then
formulates the conditional expected loss after &lt;span
class=&quot;math inline&quot;&gt;\(n, n=0, 1, 2, \ldots,\)&lt;/span&gt; additional rounds
of proofcalculation:&lt;/p&gt;
&lt;p&gt;&lt;span class=&quot;math display&quot;&gt;\[
Y_n = n C_p + c_n E(M_n|X_1,\ldots,X_n),
\]&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;where &lt;span class=&quot;math inline&quot;&gt;\(M_n = M -(\sum_{j=1}^n
X_j)\)&lt;/span&gt;. If we further assume that in the &lt;span
class=&quot;math inline&quot;&gt;\((n+1)\)&lt;/span&gt;’th proofcalculation round errors
are detected independently of each other with probability &lt;span
class=&quot;math inline&quot;&gt;\(p_n, 0 \leq p_n \leq 1\)&lt;/span&gt; and &lt;span
class=&quot;math inline&quot;&gt;\(p_n\)&lt;/span&gt; being a known number we obtain
that&lt;/p&gt;
&lt;p&gt;&lt;span class=&quot;math display&quot;&gt;\[
X_{n+1} \&amp;gt;|\&amp;gt; M, X_1,\ldots,X_n \sim \text{Bin}(M_n, p_n), \quad
n=0,1,2,\ldots.
\]&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;Under the further assumption that &lt;span class=&quot;math inline&quot;&gt;\(M\sim
\text{Po}(\lambda)\)&lt;/span&gt; with &lt;span
class=&quot;math inline&quot;&gt;\(\lambda&amp;gt;0\)&lt;/span&gt; being known, one can show
that the loss function is independent of the observations (Ferguson and
Hardwick, 1989), i.e.&lt;/p&gt;
&lt;p&gt;&lt;span class=&quot;math display&quot;&gt;\[
Y_n = n C_p + c_n \lambda \prod_{j=0}^{n-1} (1-p_j), \quad
n=0,1,2,\ldots.
\]&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;The above Poisson assumption seems to be an acceptable approximation
if the total number of results &lt;span class=&quot;math inline&quot;&gt;\(M\)&lt;/span&gt; is
large and the probability of a result being wrong is low. In this case
the optimal stopping rule is given by:&lt;/p&gt;
&lt;p&gt;&lt;span class=&quot;math display&quot;&gt;\[
n_{\text{stop}} = \min_{n\geq 0} Y_n.
\]&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;One limitation of the above approach is that we have used a
&lt;strong&gt;guesstimate&lt;/strong&gt; on how the detection probability &lt;span
class=&quot;math inline&quot;&gt;\(p_n\)&lt;/span&gt; evolves over time. An extension would
be to sequentially estimate this parameter from the obtained results.
This goes along the lines of Dalal and Mallows (1988) which discuss when
to stop testing your software - see the following &lt;a
href=&quot;/blog/2016/05/06/when2stop.html&quot;&gt;blog entry&lt;/a&gt; for a short
statistical treatment of their approach.&lt;/p&gt;
&lt;h3 id=&quot;numerical-example&quot;&gt;Numerical example&lt;/h3&gt;
&lt;p&gt;We consider a setup where the costly errors have substantial
ramifications and thus are easy to detect early on. As time passes on
the errors become more difficult to detect. This is reflected by the
subsequent choices of &lt;span class=&quot;math inline&quot;&gt;\(p_n\)&lt;/span&gt; and &lt;span
class=&quot;math inline&quot;&gt;\(c_n\)&lt;/span&gt; - see below. Furthermore, the
expected number of bugs is taken to be the non-homogeneous
capture-recapture estimate of the remaining errors. This coupling of the
two procedures is somewhat pragmatic: it does not include the first
round of proofcalculation in the decision making as this is used to
estimate &lt;span class=&quot;math inline&quot;&gt;\(\lambda\)&lt;/span&gt;. Furthermore, no
estimation uncertainty in &lt;span class=&quot;math inline&quot;&gt;\(\lambda\)&lt;/span&gt;
from this stage is transferred to the subsequent stages.&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb11&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb11-1&quot;&gt;&lt;a href=&quot;#cb11-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;#Cost of one round of proofcalculation (say in number of working days)&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb11-2&quot;&gt;&lt;a href=&quot;#cb11-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;Cp &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb11-3&quot;&gt;&lt;a href=&quot;#cb11-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;#Cost of finding errors after n round of proofcalculation&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb11-4&quot;&gt;&lt;a href=&quot;#cb11-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;cn &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;cf&quot;&gt;function&lt;/span&gt;(n) &lt;span class=&quot;dv&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;fl&quot;&gt;0.9&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;^&lt;/span&gt;(&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;*&lt;/span&gt;(n&lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;))&lt;/span&gt;
&lt;span id=&quot;cb11-5&quot;&gt;&lt;a href=&quot;#cb11-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;#Expected number of errors&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb11-6&quot;&gt;&lt;a href=&quot;#cb11-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;(lambda &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; M_est&lt;span class=&quot;sc&quot;&gt;$&lt;/span&gt;Nhat &lt;span class=&quot;sc&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;sum&lt;/span&gt;(testP))&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;## [1] 37&lt;/code&gt;&lt;/pre&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb13&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb13-1&quot;&gt;&lt;a href=&quot;#cb13-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;#Probabilty of detecting an error in round j+1&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb13-2&quot;&gt;&lt;a href=&quot;#cb13-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;pj &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;cf&quot;&gt;function&lt;/span&gt;(j) {&lt;/span&gt;
&lt;span id=&quot;cb13-3&quot;&gt;&lt;a href=&quot;#cb13-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fl&quot;&gt;0.8&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;^&lt;/span&gt;(j&lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;)&lt;/span&gt;
&lt;span id=&quot;cb13-4&quot;&gt;&lt;a href=&quot;#cb13-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;}&lt;/span&gt;
&lt;span id=&quot;cb13-5&quot;&gt;&lt;a href=&quot;#cb13-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;#Expected conditional loss as defined above&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb13-6&quot;&gt;&lt;a href=&quot;#cb13-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;Yn &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;Vectorize&lt;/span&gt;(&lt;span class=&quot;cf&quot;&gt;function&lt;/span&gt;(n) {&lt;/span&gt;
&lt;span id=&quot;cb13-7&quot;&gt;&lt;a href=&quot;#cb13-7&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  n&lt;span class=&quot;sc&quot;&gt;*&lt;/span&gt;Cp &lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;cn&lt;/span&gt;(n) &lt;span class=&quot;sc&quot;&gt;*&lt;/span&gt; lambda &lt;span class=&quot;sc&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;prod&lt;/span&gt;(&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;pj&lt;/span&gt;(&lt;span class=&quot;dv&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;:&lt;/span&gt;(n&lt;span class=&quot;dv&quot;&gt;-1&lt;/span&gt;)))&lt;/span&gt;
&lt;span id=&quot;cb13-8&quot;&gt;&lt;a href=&quot;#cb13-8&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;})&lt;/span&gt;
&lt;span id=&quot;cb13-9&quot;&gt;&lt;a href=&quot;#cb13-9&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb13-10&quot;&gt;&lt;a href=&quot;#cb13-10&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;#Make a data.frame with the results.&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb13-11&quot;&gt;&lt;a href=&quot;#cb13-11&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;df &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;data.frame&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;n=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;20&lt;/span&gt;) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;mutate&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;Yn=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;Yn&lt;/span&gt;(n),&lt;span class=&quot;at&quot;&gt;cn=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;cn&lt;/span&gt;(n),&lt;span class=&quot;at&quot;&gt;pn=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;pj&lt;/span&gt;(n&lt;span class=&quot;dv&quot;&gt;-1&lt;/span&gt;))&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;The above choice of parameters leads to the following functional
forms:&lt;/p&gt;
&lt;p&gt;&lt;img
src=&quot;http://staff.math.su.se/hoehle/blog/figure/source/2016-05-22-proofCalculation/unnamed-chunk-7-1.png&quot; /&gt;&lt;/p&gt;
&lt;p&gt;The optimal strategy is thus found as:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb14&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb14-1&quot;&gt;&lt;a href=&quot;#cb14-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;df &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;filter&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;rank&lt;/span&gt;(Yn) &lt;span class=&quot;sc&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;) &lt;span class=&quot;sc&quot;&gt;%&amp;gt;%&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;select&lt;/span&gt;(n,Yn)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;##   n       Yn
## 1 5 6.457426&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;In other words, one should test after &lt;span
class=&quot;math inline&quot;&gt;\(n_{\text{stop}}=5\)&lt;/span&gt; additional rounds.&lt;/p&gt;
&lt;h1 id=&quot;discussion&quot;&gt;Discussion&lt;/h1&gt;
&lt;p&gt;Is any of the above &lt;strong&gt;useful&lt;/strong&gt;? Well, I have not heard
about such approaches being used seriously in software engineering. The
presented methods narrow down a complex problem down using assumptions
in order to make the problem mathematically tractable. You may not agree
with the assumptions as, e.g., Bolton (2010) - yet, such assumptions are
a good way to get started. The point is that statisticians appear to be
very good at enlightening others about the &lt;strong&gt;virtues of
statistics&lt;/strong&gt; (repeat your measurements, have a sampling plan,
pantomimic acts visualizing the horror of p-values). However, when it
comes to our own analyses, we are surprisingly statistics-illiterate at
times.&lt;/p&gt;
&lt;p&gt;&lt;img
src=&quot;/blog/figure/source/2016-05-22-proofCalculation/look_for_the_pattern-300px.png&quot;
title=&quot;Source: https://openclipart.org/detail/248382/dropping-numbers&quot; /&gt;&lt;/p&gt;
&lt;h1 id=&quot;literature&quot;&gt;Literature&lt;/h1&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p&gt;Bolton, M (2010). &lt;a
href=&quot;http://www.developsense.com/blog/2010/07/another-silly-quantitative-model/&quot;&gt;Another
Silly Quantitative Model&lt;/a&gt;, Blog post, July 2010.&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;Cook, JD (2010). &lt;a
href=&quot;http://www.johndcook.com/blog/2010/07/13/lincoln-index/&quot;&gt;How many
errors are left to find?&lt;/a&gt;, Blog post, July 2010.&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;Dalal, S. R. and C. L. Mallows. “&lt;a
href=&quot;http://www.jstor.org/stable/2289319&quot;&gt;When Should One Stop Testing
Software?&lt;/a&gt;”. Journal of the American Statistical Association (1988),
83(403):872–879.&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;Ferguson, TS and Hardwick JP (1989). &lt;a
href=&quot;http://www.jstor.org/stable/3214037&quot;&gt;Stopping Rules For
Proofreading&lt;/a&gt;, J. Appl. Prob. 26:304-313.&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;Hayes, B (2010). &lt;a
href=&quot;http://bit-player.org/2010/the-thrill-of-the-chase&quot;&gt;The thrill of
the chase&lt;/a&gt;, Blog post, July 2010.&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;Singpurwalla ND, Wilson SP (1999). &lt;a
href=&quot;http://www.springer.com/us/book/9780387988238&quot;&gt;Statistical Methods
in Software Engineering&lt;/a&gt;, Springer.&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;Yang MCK, Wackerly DD, Rosalsky A (1982). &lt;a
href=&quot;http://www.jstor.org/stable/3213535&quot;&gt;Optimal Stopping Rules in
Proofreading&lt;/a&gt;, Journal of Applied Probability 19(3),
pp. 723-729&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;Zeller, A (2009). &lt;a href=&quot;http://www.whyprogramsfail.com/&quot;&gt;Why
programs fail&lt;/a&gt;, Elsevier, 2009, 423 pages.&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
</description>
        <pubDate>Sun, 22 May 2016 00:00:00 +0200</pubDate>
        <link>https://mhoehle.github.io/blog/2016/05/22/proofCalculation.html</link>
        <guid isPermaLink="true">https://mhoehle.github.io/blog/2016/05/22/proofCalculation.html</guid>
        
        <category>datascience</category>
        
        <category>rstats</category>
        
        <category>debugging</category>
        
        
      </item>
    
      <item>
        <title>When Should One Stop Testing Software?</title>
        <description>&lt;h1 id=&quot;abstract&quot;&gt;Abstract&lt;/h1&gt;
&lt;p&gt;This is a small note rediscovering a gem published by S. R. Dalal and
C. L. Mallows on treating the test of software in a statistical context
(Dalal and Mallows, 1988). In their paper they answer the question on
how long to continue testing your software before shipping. The problem
is translated into a sequential decision problem, where an optimal
stopping rule has to be found minimizing expected loss. We sketch the
main result of their paper and apply their stopping rule to an example
using R code.&lt;/p&gt;
&lt;p&gt;&lt;br&gt;
&lt;a rel=&quot;license&quot; href=&quot;http://creativecommons.org/licenses/by-sa/4.0/&quot;&gt;&lt;img alt=&quot;Creative Commons License&quot; style=&quot;border-width:0&quot; src=&quot;https://i.creativecommons.org/l/by-sa/4.0/88x31.png&quot;/&gt;&lt;/a&gt;
This work is licensed under a &lt;a rel=&quot;license&quot;
href=&quot;http://creativecommons.org/licenses/by-sa/4.0/&quot;&gt;Creative Commons
Attribution-ShareAlike 4.0 International License&lt;/a&gt;. The
markdown+Rknitr source code of this blog is available under a &lt;a
href=&quot;https://www.gnu.org/licenses/gpl-3.0.html&quot;&gt;GNU General Public
License (GPL v3)&lt;/a&gt; license from github.&lt;/p&gt;
&lt;h1 id=&quot;introduction&quot;&gt;Introduction&lt;/h1&gt;
&lt;p&gt;Imagine that a team of developers of a new R package needs to
structure a test plan before the release of the package to CRAN. Let
&lt;span class=&quot;math inline&quot;&gt;\(N\)&lt;/span&gt; be the (unknown) number of bugs
in the package. The team starts their testing at time zero and
subsequently find an increasing number of bugs as the test period passes
by. The figure below shows such a testing process mimicking the example
of Dalal and Mallows (1988) from the testing of a large software system
at a telecommunications research company.&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;http://staff.math.su.se/hoehle/blog/figure/source/2016-05-06-when2stop/unnamed-chunk-1-1.png&quot; style=&quot;display: block; margin: auto;&quot; /&gt;&lt;/p&gt;
&lt;p&gt;We see that the number of bugs appears to level off. The question is
now &lt;em&gt;how long should we continue testing before releasing&lt;/em&gt;? Dalal
and Mallows (1988) give an intriguing statistical answer to this
problem.&lt;/p&gt;
&lt;h1 id=&quot;methodology&quot;&gt;Methodology&lt;/h1&gt;
&lt;p&gt;In order to answer the above question the following notation and
assumptions are introduced:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p&gt;The total number of bugs is assumed to be Poisson distributed
&lt;span class=&quot;math display&quot;&gt;\[N \sim \text{Po}(\lambda).\]&lt;/span&gt;
However, practice shows that the number of bugs in different modules has
more variation that given by the Poisson distribution. Hence, let &lt;span
class=&quot;math inline&quot;&gt;\(\lambda \sim \text{Ga}(\alpha,\beta)\)&lt;/span&gt; and
thus the marginal distribution of &lt;span class=&quot;math inline&quot;&gt;\(N\)&lt;/span&gt;
is negative binomial.&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;The amount of time until discovery of each bug during the testing
period is distributed according to the known distribution &lt;span
class=&quot;math inline&quot;&gt;\(G\)&lt;/span&gt; with density &lt;span
class=&quot;math inline&quot;&gt;\(g\)&lt;/span&gt;. Furthermore, it can be assumed that
the discoveries times are independent of each other. Example : The
simplest example is to assume that the discovery distribution is
exponential, i.e. &lt;span class=&quot;math inline&quot;&gt;\(g(t)=\mu\exp(-\mu
t)\)&lt;/span&gt;, where we measure time in number of person-days spent on the
testing. Thus, &lt;span class=&quot;math inline&quot;&gt;\(1/\mu\)&lt;/span&gt; is the
expected time until discovery of a bug.&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;Let &lt;span class=&quot;math inline&quot;&gt;\(K(t)\)&lt;/span&gt; be the total number
of bugs found up to time &lt;span class=&quot;math inline&quot;&gt;\(t\)&lt;/span&gt;. In
other words, if &lt;span class=&quot;math inline&quot;&gt;\(t_1,\ldots,t_N\)&lt;/span&gt;
denote the discovery times of the &lt;span class=&quot;math inline&quot;&gt;\(N\)&lt;/span&gt;
bugs then&lt;/p&gt;
&lt;p&gt;&lt;span class=&quot;math display&quot;&gt;\[K(t)=\sum_{i=1}^N I(t_i \leq
t),\]&lt;/span&gt;&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;where &lt;span class=&quot;math inline&quot;&gt;\(I(\cdot)\)&lt;/span&gt; is the indicator
function. However, note that at time point &lt;span
class=&quot;math inline&quot;&gt;\(t\)&lt;/span&gt;, only bugs with a discovery time
smaller or equal to &lt;span class=&quot;math inline&quot;&gt;\(t\)&lt;/span&gt; would already
have been observed and, hence, would be known to exist
(right-truncation). Thus, even though &lt;span
class=&quot;math inline&quot;&gt;\(K(t)\)&lt;/span&gt; is proportional to the empirical
cumulative distribution function of the discovery distribution &lt;span
class=&quot;math inline&quot;&gt;\(\hat{G}(t)\)&lt;/span&gt;, the factor of proportionality
is &lt;span class=&quot;math inline&quot;&gt;\(N\)&lt;/span&gt;, which is unknown at the time
&lt;span class=&quot;math inline&quot;&gt;\(t\)&lt;/span&gt;.&lt;/p&gt;
&lt;p&gt;Note: The paper actually showns that the Poisson-Gamma distribution
assumption for &lt;span class=&quot;math inline&quot;&gt;\(N\)&lt;/span&gt; is not crucial. An
asymptotic argument is given that as long as the process does not
terminate quickly (i.e. the number of bugs is relatively large) the
results hold for more general distributions of &lt;span
class=&quot;math inline&quot;&gt;\(N\)&lt;/span&gt;. Hence, in the analysis that follows,
the parameter &lt;span class=&quot;math inline&quot;&gt;\(\lambda\)&lt;/span&gt; is not needed
as we only proceed with the asymptotic approach of the paper.&lt;/p&gt;
&lt;h3 id=&quot;loss-function&quot;&gt;Loss function&lt;/h3&gt;
&lt;p&gt;In order to make a decision about when to stop testing based on
expected loss/gain we need two further assumptions:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p&gt;Let &lt;span class=&quot;math inline&quot;&gt;\(c\)&lt;/span&gt; be the net cost of
fixing a bug &lt;em&gt;after&lt;/em&gt; release of the software instead of
&lt;em&gt;before&lt;/em&gt; the release. Hence, &lt;span
class=&quot;math inline&quot;&gt;\(c\)&lt;/span&gt; is the price of fixing a bug after
release minus the price of fixing a bug before release. The practice of
software development tells us that &lt;span
class=&quot;math inline&quot;&gt;\(c&amp;gt;0\)&lt;/span&gt;.&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;Let &lt;span class=&quot;math inline&quot;&gt;\(f(t)\)&lt;/span&gt; be a known
non-negative and monotone increasing function reflecting the cost of
testing plus the opportunity cost of not releasing the software up to
time &lt;span class=&quot;math inline&quot;&gt;\(t\)&lt;/span&gt;. Note that the cost of
testing does not contain the costs of fixing bugs, once they are found.
A simple example for &lt;span class=&quot;math inline&quot;&gt;\(f\)&lt;/span&gt; is the
linear loss function, i.e. &lt;span class=&quot;math inline&quot;&gt;\(f(t) = f \cdot
t\)&lt;/span&gt;, where &lt;span class=&quot;math inline&quot;&gt;\(f&amp;gt;0\)&lt;/span&gt; is a known
constant.&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;The above assumptions in summary imply the analysis of the following
loss function:&lt;/p&gt;
&lt;p&gt;&lt;span class=&quot;math display&quot;&gt;\[L(t,K(t),N) = f(t) - c K(t) + b\cdot
N.\]&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;As time passes, one obtains information about the number of bugs
found through &lt;span class=&quot;math inline&quot;&gt;\(K(t)\)&lt;/span&gt;. At each time
point the following decision has to be made: stop testing &amp;amp; ship the
package or continue to test. Seen in a statistical context this can be
rephrased into formulating a stopping rule such that the above loss
function is minimized.&lt;/p&gt;
&lt;h3 id=&quot;optimal-stopping-time&quot;&gt;Optimal Stopping Time&lt;/h3&gt;
&lt;p&gt;In the simple model with exponential discovery times having rate
&lt;span class=&quot;math inline&quot;&gt;\(\mu\)&lt;/span&gt;, the stopping rule stated as
equation (4.6) of Dalal and Mallows (1988) is to stop as soon as the
number, &lt;span class=&quot;math inline&quot;&gt;\(k\)&lt;/span&gt;, of bugs found at time
&lt;span class=&quot;math inline&quot;&gt;\(t\)&lt;/span&gt;, i.e. &lt;span
class=&quot;math inline&quot;&gt;\(K(t)=k\)&lt;/span&gt;, is such that:&lt;/p&gt;
&lt;p&gt;&lt;span class=&quot;math display&quot;&gt;\[
\frac{f}{c}\cdot \frac{\exp(\mu t) -1}{\mu} \geq k.
\]&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;At this time point, the estimated number of bugs left is Poisson with
mean &lt;span class=&quot;math inline&quot;&gt;\(f/(c\mu)\)&lt;/span&gt;.&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb1&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb1-1&quot;&gt;&lt;a href=&quot;#cb1-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##########################################################################&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-2&quot;&gt;&lt;a href=&quot;#cb1-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;# Function describing the LHS of (4.6) in the Delal and Mallows article&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-3&quot;&gt;&lt;a href=&quot;#cb1-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;#&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-4&quot;&gt;&lt;a href=&quot;#cb1-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;# Parameters:&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-5&quot;&gt;&lt;a href=&quot;#cb1-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;#  fdivc - the quotient f/c&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-6&quot;&gt;&lt;a href=&quot;#cb1-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;#  mu    - the value of mu, this typically needs to be estimated from data&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-7&quot;&gt;&lt;a href=&quot;#cb1-7&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;#  testProcess - a data_frame containing the decision time points and the&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-8&quot;&gt;&lt;a href=&quot;#cb1-8&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;#               observed number of events&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-9&quot;&gt;&lt;a href=&quot;#cb1-9&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;##########################################################################&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-10&quot;&gt;&lt;a href=&quot;#cb1-10&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;lhs &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;cf&quot;&gt;function&lt;/span&gt;(fdivc,mu,testProcess) {&lt;/span&gt;
&lt;span id=&quot;cb1-11&quot;&gt;&lt;a href=&quot;#cb1-11&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  fdivc&lt;span class=&quot;sc&quot;&gt;*&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;exp&lt;/span&gt;(mu&lt;span class=&quot;sc&quot;&gt;*&lt;/span&gt;testProcess&lt;span class=&quot;sc&quot;&gt;$&lt;/span&gt;t)&lt;span class=&quot;sc&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;)&lt;span class=&quot;sc&quot;&gt;/&lt;/span&gt;mu&lt;/span&gt;
&lt;span id=&quot;cb1-12&quot;&gt;&lt;a href=&quot;#cb1-12&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;In the above, the quantity &lt;span class=&quot;math inline&quot;&gt;\(c/f\)&lt;/span&gt;
measures the amount saved by finding a bug (and hence fixing it before
release) measured in units of testing days. As an example: if &lt;span
class=&quot;math inline&quot;&gt;\(c/f=0.2 \Leftrightarrow f/c=5\)&lt;/span&gt; then the
gain in detecting a bug before release corresponds to 0.2 testing days.
Throughout the subsequent example we shall work with both &lt;span
class=&quot;math inline&quot;&gt;\(c/f=0.2\)&lt;/span&gt; (ship early and fix later is
acceptable) and &lt;span class=&quot;math inline&quot;&gt;\(c/f=1\)&lt;/span&gt; (high costs
of fixing bugs afte r the release).&lt;/p&gt;
&lt;h1 id=&quot;example&quot;&gt;Example&lt;/h1&gt;
&lt;p&gt;Taking the testing data from the above figure, the first step
consists of estimating &lt;span class=&quot;math inline&quot;&gt;\(\mu\)&lt;/span&gt; from the
available data. It is important to realize that the available data are a
right-truncated sample, because only errors with a discovery time
smaller than the current observation time are observed. Furthermore, if
only data on the daily number of bug discoveries are available, then the
data are also interval censored. We set up the loglikelihood function
accordingly.&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb2&quot;&gt;&lt;pre class=&quot;sourceCode r&quot;&gt;&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span id=&quot;cb2-1&quot;&gt;&lt;a href=&quot;#cb2-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;#######################################################&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb2-2&quot;&gt;&lt;a href=&quot;#cb2-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;#Log-likelihood function to maximize, which handles the&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb2-3&quot;&gt;&lt;a href=&quot;#cb2-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;#right truncation and interval censoring.&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb2-4&quot;&gt;&lt;a href=&quot;#cb2-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;# Paramers:&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb2-5&quot;&gt;&lt;a href=&quot;#cb2-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;#  theta - \log(\mu).&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb2-6&quot;&gt;&lt;a href=&quot;#cb2-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;#  testProcess - data_frame containing the observed data&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb2-7&quot;&gt;&lt;a href=&quot;#cb2-7&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;#  tC - the right-censoring time.&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb2-8&quot;&gt;&lt;a href=&quot;#cb2-8&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;do&quot;&gt;########################################################&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb2-9&quot;&gt;&lt;a href=&quot;#cb2-9&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;ll &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;cf&quot;&gt;function&lt;/span&gt;(theta, testProcess, &lt;span class=&quot;at&quot;&gt;tC=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;max&lt;/span&gt;(testProcess&lt;span class=&quot;sc&quot;&gt;$&lt;/span&gt;t)) {&lt;/span&gt;
&lt;span id=&quot;cb2-10&quot;&gt;&lt;a href=&quot;#cb2-10&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  mu &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;exp&lt;/span&gt;(theta)&lt;/span&gt;
&lt;span id=&quot;cb2-11&quot;&gt;&lt;a href=&quot;#cb2-11&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;co&quot;&gt;#Daily number of *new* bug discoveries. .&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb2-12&quot;&gt;&lt;a href=&quot;#cb2-12&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  DeltaK &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;c&lt;/span&gt;(&lt;span class=&quot;dv&quot;&gt;0&lt;/span&gt;,&lt;span class=&quot;fu&quot;&gt;diff&lt;/span&gt;(testProcess&lt;span class=&quot;sc&quot;&gt;$&lt;/span&gt;K))&lt;/span&gt;
&lt;span id=&quot;cb2-13&quot;&gt;&lt;a href=&quot;#cb2-13&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;co&quot;&gt;#CDF function taking the right-truncation into account&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb2-14&quot;&gt;&lt;a href=&quot;#cb2-14&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  CDF &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;cf&quot;&gt;function&lt;/span&gt;(x) &lt;span class=&quot;fu&quot;&gt;pexp&lt;/span&gt;(x,&lt;span class=&quot;at&quot;&gt;rate=&lt;/span&gt;mu)&lt;span class=&quot;sc&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;pexp&lt;/span&gt;(tC,&lt;span class=&quot;at&quot;&gt;rate=&lt;/span&gt;mu)&lt;/span&gt;
&lt;span id=&quot;cb2-15&quot;&gt;&lt;a href=&quot;#cb2-15&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;co&quot;&gt;#Log-likelihood is equivalent to multinomial sampling with p being a func of mu.&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb2-16&quot;&gt;&lt;a href=&quot;#cb2-16&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  p &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;CDF&lt;/span&gt;(&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;:&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;max&lt;/span&gt;(testProcess&lt;span class=&quot;sc&quot;&gt;$&lt;/span&gt;t)&lt;span class=&quot;sc&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;)) &lt;span class=&quot;sc&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;CDF&lt;/span&gt;(testProcess&lt;span class=&quot;sc&quot;&gt;$&lt;/span&gt;t)&lt;/span&gt;
&lt;span id=&quot;cb2-17&quot;&gt;&lt;a href=&quot;#cb2-17&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;return&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;sum&lt;/span&gt;(DeltaK &lt;span class=&quot;sc&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;log&lt;/span&gt;(p)))&lt;/span&gt;
&lt;span id=&quot;cb2-18&quot;&gt;&lt;a href=&quot;#cb2-18&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;}&lt;/span&gt;
&lt;span id=&quot;cb2-19&quot;&gt;&lt;a href=&quot;#cb2-19&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;#Find MLE&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb2-20&quot;&gt;&lt;a href=&quot;#cb2-20&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;mle &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;optim&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;log&lt;/span&gt;(&lt;span class=&quot;fl&quot;&gt;0.01&lt;/span&gt;),ll, &lt;span class=&quot;at&quot;&gt;testProcess=&lt;/span&gt;testProcess, &lt;span class=&quot;at&quot;&gt;control=&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;list&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;fnscale=&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;),&lt;span class=&quot;at&quot;&gt;method=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;BFGS&amp;quot;&lt;/span&gt;)&lt;/span&gt;
&lt;span id=&quot;cb2-21&quot;&gt;&lt;a href=&quot;#cb2-21&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;mu.hat &lt;span class=&quot;ot&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;exp&lt;/span&gt;(mle&lt;span class=&quot;sc&quot;&gt;$&lt;/span&gt;par)&lt;/span&gt;
&lt;span id=&quot;cb2-22&quot;&gt;&lt;a href=&quot;#cb2-22&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;c&lt;/span&gt;(&lt;span class=&quot;at&quot;&gt;mu=&lt;/span&gt;mu, &lt;span class=&quot;at&quot;&gt;mu.hat=&lt;/span&gt;mu.hat)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;pre&gt;&lt;code&gt;##         mu     mu.hat 
## 0.02000000 0.01916257&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Note that we in the above used all data obtained over the entire
testing period. In practice, one would instead sequentially update the
&lt;span class=&quot;math inline&quot;&gt;\(\mu\)&lt;/span&gt; estimate each day as the
information arrives – see the animated sequential procedure in the next
section.&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;http://staff.math.su.se/hoehle/blog/figure/source/2016-05-06-when2stop/unnamed-chunk-4-1.png&quot; style=&quot;display: block; margin: auto;&quot; /&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;## Source: local data frame [1 x 5]
## 
##       t     K K_estimate     sol5     sol1
##   (int) (dbl)      (dbl)    (dbl)    (dbl)
## 1    82   989   990.8676 994.9211 198.9842&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;The optimal stopping time in the example, in the case of &lt;span
class=&quot;math inline&quot;&gt;\(f/c=5\)&lt;/span&gt;, is to stop the testing after 82
testing days. An estimate of the expected number of remaining bugs at
this stopping time would be 260.9, which appears to agree quite well
with the empirical data – actually, they were simulated with &lt;span
class=&quot;math inline&quot;&gt;\(N=1250\)&lt;/span&gt;.&lt;/p&gt;
&lt;h1 id=&quot;animation&quot;&gt;Animation&lt;/h1&gt;
&lt;p&gt;The animation belows shows the above computations in sequential
fashion:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;At a given time &lt;span class=&quot;math inline&quot;&gt;\(t\)&lt;/span&gt; of the
testing process, &lt;span class=&quot;math inline&quot;&gt;\(\hat{\mu}\)&lt;/span&gt; is
determined from the curve of cumulative bugs found up to time &lt;span
class=&quot;math inline&quot;&gt;\(t\)&lt;/span&gt;.&lt;/li&gt;
&lt;li&gt;This &lt;span class=&quot;math inline&quot;&gt;\(\hat{\mu}\)&lt;/span&gt; estimate is then
use to determine the intersecting curves as described above.&lt;/li&gt;
&lt;li&gt;Once the &lt;span class=&quot;math inline&quot;&gt;\(K(t)\)&lt;/span&gt; curve and the
curve for a given &lt;span class=&quot;math inline&quot;&gt;\(f/c\)&lt;/span&gt; ratio
intersect, we would stop the testing.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;img src=&quot;/blog/downloads/animation.gif&quot; /&gt;&lt;/p&gt;
&lt;h1 id=&quot;discussion&quot;&gt;Discussion&lt;/h1&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p&gt;Assuming that the time periods until discovery of the bugs are
independently distributed appears convenient, butnot so realistic. The
paper has a section about analysing the situation in case of different
classes of bugs. However, fixing a bug often spawns new bugs. Hence, the
bug-process could instead be more realistically modelled by a
self-exiciting process such as the Hawkes’ process (Hawkes,
1971).&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;For Open Source Software and in particular R packages, which
nobody might ever use, is &lt;span class=&quot;math inline&quot;&gt;\(c\)&lt;/span&gt; really
bigger than zero? Ship and fix might be a good way to test, if a package
actually addresses any kind of need?&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;How to extract the daily number of bugs found from your bug
tracking ticket system?&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h1 id=&quot;literature&quot;&gt;Literature&lt;/h1&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p&gt;Dalal, S. R. and C. L. Mallows. “&lt;a
href=&quot;http://www.jstor.org/stable/2289319&quot;&gt;When Should One Stop Testing
Software?&lt;/a&gt;”. Journal of the American Statistical Association (1988),
83(403):872–879.&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;Hawkes, A. G. “&lt;a
href=&quot;http://biomet.oxfordjournals.org/content/58/1/83.abstract&quot;&gt;Spectra
of some self-exciting and mutually exciting point processes&lt;/a&gt;”.
Biometrika (1971), 58(1):83-90.&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
</description>
        <pubDate>Fri, 06 May 2016 00:00:00 +0200</pubDate>
        <link>https://mhoehle.github.io/blog/2016/05/06/when2stop.html</link>
        <guid isPermaLink="true">https://mhoehle.github.io/blog/2016/05/06/when2stop.html</guid>
        
        <category>datascience</category>
        
        <category>rstats</category>
        
        <category>debugging</category>
        
        
      </item>
    
  </channel>
</rss>
